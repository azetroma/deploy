
<div layout="column" flex>
    <md-content flex class="content role-container" layout="row">
        <style>
            .role-container select {
                border:none;
                border-bottom:1px solid #efefef;
                background:none;
            }

        </style>
        <div flex="20" hide-sm hide-xs></div>
        <div flex="60" flex-xs="100" flex-sm="100">

            <md-card>
                <md-card-title>
                    <md-card-title-text>
                        <span class="md-headline" ng-hide="isEdit">{{'new_role' | translate}}</span>
                        <span class="md-headline" ng-show="isEdit">{{'edit_role' | translate}}</span>
                    </md-card-title-text>
                </md-card-title>

                <md-content layout-padding>
                    <div>
                        <form name="roleForm">

                            <div layout-gt-sm="row">

                                <md-input-container flex="50">
                                    <label>{{'name' | translate}}</label>
                                    <input required name="name" ng-model="model.RoleName">
                                    <div ng-messages="roleForm.name.$error">
                                        <div ng-message="required">{{'form_name_required' | translate}}</div>
                                    </div>
                                </md-input-container>
                                <md-input-container flex="50">
                                    <label>{{'role_default_menu' | translate}}</label>
                                    <md-select required name="defaultPage" ng-model="model.FirstMenuId" style="margin-bottom:0" ng-click="renderSelect = true">
                                        <md-optgroup ng-repeat="(gk, gv) in menus" label="{{jsonParse(gk).name}}" xng-if="renderSelect">
                                            <md-option ng-repeat="menu in gv" value="{{menu.id + ''}}">{{menu.name}}</md-option>
                                        </md-optgroup>
                                    </md-select>
                                    <div class="errors" ng-messages="roleForm.defaultPage.$error">
                                        <div ng-message="required">{{'default_page_required' | translate}}</div>
                                    </div> 

                                </md-input-container> 
                            </div>
                            


                            <style>
                                .role-edit h3{
                                    margin: 20px 0 0 0 ;
                                }
                                .role-edit md-checkbox {
                                    margin:5px 0;
                                }
                            </style>

                            <div class="prop-section role-edit">

                                <menu-container>

                                    <menu-item>
                                        <menu-header ng-click="renderMenu = true">{{'menus' | translate}}</menu-header>
                                        <menu-body>
                                            <div style="margin:0 20px" ng-if="renderMenu">
                                                <collapse ng-repeat="(k,v) in menus">
                                                    <div layout="row">
                                                        <collapse-header>
                                                            {{jsonParse(k).name}}
                                                        </collapse-header>
                                                        <span flex></span>
                                                        <md-select style="margin:0" aria-label="{{'permission' | translate}}" ng-model="menuCategoriesAction[jsonParse(k).id]">
                                                            <md-option value="0">{{'permission_not' | translate}}</md-option>
                                                            <md-option value="1">{{'permission_view' | translate}}</md-option>
                                                            <md-option value="2">{{'permission_view_edit' | translate}}</md-option>
                                                            <md-option value="4">{{'permission_view_edit_delete' | translate}}</md-option>
                                                        </md-select>
                                                    </div>
                                                    <collapse-body>
                                                        <div style="margin:0 20px">
                                                            <div ng-repeat="r in v" layout="row" layout-align="start center">
                                                                <md-checkbox ng-model="r.check" ng-change="setViewPermission(k, v)">{{r.name}}</md-checkbox>
                                                                <span flex></span>
                                                                <md-select style="margin:0" class="" ng-model="r.action" ng-show="r.check" aria-label="{{'permission' | translate}}">
                                                                    <md-option value="1">{{'permission_view' | translate}}</md-option>
                                                                    <md-option value="2">{{'permission_view_edit' | translate}}</md-option>
                                                                    <md-option value="4">{{'permission_view_edit_delete' | translate}}</md-option>
                                                                </md-select>

                                                            </div>
                                                        </div>
                                                    </collapse-body>
                                                </collapse>


                                            </div>
                                        </menu-body>
                                    </menu-item>

                                    <menu-item>
                                        <menu-header ng-click="renderUsers = true">{{'users' | translate}}</menu-header>
                                        <menu-body>
                                            <div style="margin:0 20px" ng-if="renderUsers">
                                                <div ng-repeat="r in users" layout="row" layout-align="start center">
                                                    <label ><input type="checkbox" ng-model="r.check"/> {{r.username}} - {{r.name}}</label>
                                                    <a href="{{app.hashUrlPrefix + '#/users/edit/' + r.id}}" style="margin:0 14px;" class="material-icons small small-size pointer">open_in_new</a>
                                                </div>
                                            </div>
                                        </menu-body>
                                    </menu-item>

                                    <menu-item>
                                        <menu-header ng-click="renderDatasource = true">{{'datasources' | translate}}</menu-header>
                                        <menu-body>
                                            <div style="margin:0 20px" ng-if="renderDatasource">
                                                <div layout="row" layout-align="start center">
                                                    <span class="form-divider" flex></span>
                                                    <md-button class="" ng-click="$event.stopPropagation(); addDatasource($event)" layout="row" layout-align="start center">
                                                        {{'add' | translate}}
                                                        <span class="material-icons">add</span>
                                                        <md-tooltip>{{'add' | translate}}</md-tooltip>
                                                    </md-button>

                                                    <md-button class="" ng-click="$event.stopPropagation(); clearDatasources()" layout="row" layout-align="start center">
                                                        {{'remove_all' | translate}}
                                                        <span class="material-icons">delete</span>
                                                        <md-tooltip>{{'remove_all' | translate}}</md-tooltip>
                                                    </md-button>
                                                    <md-select style="margin:0" class="" ng-model="datasourceActionAll" ng-change="actionAll('datasource', datasourceActionAll)" aria-label="{{'permission' | translate}}">
                                                        <md-option value="1">{{'permission_view' | translate}}</md-option>
                                                        <md-option value="2">{{'permission_view_edit' | translate}}</md-option>
                                                        <md-option value="4">{{'permission_view_edit_delete' | translate}}</md-option>
                                                    </md-select>
                                                    <span class="form-divider" flex></span>
                                                </div>

                                                <div ng-repeat="r in datasources" layout="row" layout-align="start center">
                                                    <md-button class="md-icon-button" ng-click="datasources.splice($index, 1)" layout="row" layout-align="start center">
                                                        <span class="material-icons">clear</span>
                                                        <md-tooltip>{{'remove' | translate}}</md-tooltip>
                                                    </md-button>

                                                    <span>{{r.name}}</span>
                                                    <span flex></span>
                                                    <!--<md-select style="margin:0" class="" ng-model="r.action" aria-label="{{'permission' | translate}}">
                                                        <md-option value="1">{{'permission_view' | translate}}</md-option>
                                                        <md-option value="2">{{'permission_view_edit' | translate}}</md-option>
                                                        <md-option value="4">{{'permission_view_edit_delete' | translate}}</md-option>
                                                    </md-select>-->

                                                    <select ng-options="item.v as item.c disable when (item.v == 1 && !r.permissions.ViewPermission)||
                                                            (item.v == 2 && !r.permissions.EditPermission)||
                                                            (item.v == 4 && !r.permissions.DeletePermission) for item in actionsKey" ng-model="r.action"></select>

                                                </div>
                                            </div>
                                        </menu-body>
                                    </menu-item>

                                    <menu-item>
                                        <menu-header ng-click="renderCharts = true">{{'charts' | translate}}</menu-header>
                                        <menu-body>
                                            <div style="margin:0 20px" ng-if="renderCharts">
                                                <div layout="row" layout-align="start center">
                                                    <span class="form-divider" flex></span>
                                                    <md-button class="" ng-click="$event.stopPropagation(); addChart($event)" layout="row" layout-align="start center">
                                                        {{'add' | translate}}
                                                        <span class="material-icons">add</span>
                                                        <md-tooltip>{{'add' | translate}}</md-tooltip>
                                                    </md-button>

                                                    <md-button class="" ng-click="$event.stopPropagation(); clearCharts()" layout="row" layout-align="start center">
                                                        {{'remove_all' | translate}}
                                                        <span class="material-icons">delete</span>
                                                        <md-tooltip>{{'remove_all' | translate}}</md-tooltip>
                                                    </md-button>
                                                    <select style="margin:0" class="" ng-model="chartActionAll" ng-change="actionAll('chart', chartActionAll)" aria-label="{{'permission' | translate}}">
                                                        <option value="1">{{'permission_view' | translate}}</option>
                                                        <option value="2">{{'permission_view_edit' | translate}}</option>
                                                        <option value="4">{{'permission_view_edit_delete' | translate}}</option>
                                                    </select>


                                                    <span class="form-divider" flex></span>
                                                </div>
                                                <div ng-repeat="r in charts" layout="row" layout-align="start center">
                                                    <md-button class="md-icon-button" ng-click="charts.splice($index, 1)" layout="row" layout-align="start center">
                                                        <span class="material-icons">clear</span>
                                                        <md-tooltip>{{'remove' | translate}}</md-tooltip>
                                                    </md-button>

                                                    <span>{{r.name}}</span>
                                                    <span flex></span>
                                                    <select ng-options="item.v as item.c disable when (item.v == 1 && !r.permissions.ViewPermission)||
                                                            (item.v == 2 && !r.permissions.EditPermission)||
                                                            (item.v == 4 && !r.permissions.DeletePermission) for item in actionsKey" ng-model="r.action"></select>
                                                    <!--<select style="margin:0" class="" ng-model="r.action" aria-label="{{'permission' | translate}}">
                                                        <option value="1" ng-disabled="!r.permissions.ViewPermission ">  {{'permission_view' | translate}}</option>
                                                        <option value="2" ng-disabled="!r.permissions.EditPermission ">  {{'permission_view_edit' | translate}}</option>
                                                        <option value="4" ng-disabled="!r.permissions.DeletePermission ">{{'permission_view_edit_delete' | translate}}</option>
                                                    </select>-->
                                                </div>
                                            </div>
                                        </menu-body>
                                    </menu-item>

                                    <menu-item>
                                        <menu-header ng-click="renderForms = true">{{'Forms' | translate}}</menu-header>
                                        <menu-body>
                                            <div style="margin:0 20px" ng-click="renderForms">
                                                <div layout="row" layout-align="start center">
                                                    <span class="form-divider" flex></span>
                                                    <!--<md-button class="" ng-click="$event.stopPropagation(); addDatasource($event)" layout="row" layout-align="start center">
                                                        {{'add' | translate}}
                                                        <span class="material-icons">add</span>
                                                        <md-tooltip>{{'add' | translate}}</md-tooltip>
                                                    </md-button>

                                                    <md-button class="" ng-click="$event.stopPropagation(); clearDatasources()" layout="row" layout-align="start center">
                                                        {{'remove_all' | translate}}
                                                        <span class="material-icons">delete</span>
                                                        <md-tooltip>{{'remove_all' | translate}}</md-tooltip>
                                                    </md-button>
                                                    <md-select style="margin:0" class="" ng-model="datasourceActionAll" ng-change="actionAll('datasource', datasourceActionAll)" aria-label="{{'permission' | translate}}">
                                                        <md-option value="1">{{'permission_view' | translate}}</md-option>
                                                        <md-option value="2">{{'permission_view_edit' | translate}}</md-option>
                                                        <md-option value="4">{{'permission_view_edit_delete' | translate}}</md-option>
                                                    </md-select>-->
                                                    <md-button class="" ng-click="$event.stopPropagation(); addFormSettings.visible=true" layout="row" layout-align="start center">
                                                        {{'add' | translate}}
                                                        <span class="material-icons" title="{{'add' | translate}}">add</span>
                                                    </md-button>

                                                    <select-form on-select="onFormSelect(forms,settings)" settings="addFormSettings"></select-form>

                                                    <span class="form-divider" flex></span>
                                                </div>

                                                <div ng-repeat="r in forms" layout="row" layout-align="start center">
                                                    <md-button class="md-icon-button" ng-click="forms.splice($index, 1)" layout="row" layout-align="start center" title="{{'remove' | translate}}">
                                                        <span class="material-icons">clear</span>
                                                    </md-button>

                                                    <span>{{r.name}}</span>
                                                    <span flex></span>
                                                    <form-premission style="margin:0 10px;" ng-model="r.recordPermission"></form-premission>
                                                    <md-select style="margin:0" class="" ng-model="r.action" aria-label="{{'permission' | translate}}">
                                                        <md-option value="1">{{'permission_view' | translate}}</md-option>
                                                        <md-option value="2">{{'permission_view_edit' | translate}}</md-option>
                                                        <md-option value="4">{{'permission_view_edit_delete' | translate}}</md-option>
                                                    </md-select>
                                                </div>
                                            </div>
                                        </menu-body>
                                    </menu-item>

                                    <menu-item>
                                        <menu-header>
                                            {{'انتخاب مجوزهای عملیاتی' | translate}}
                                        </menu-header>
                                        <menu-body>
                                            <div style="margin:0 20px">
                                                <div ng-repeat="r in actions">
                                                    <h3>
                                                        <md-checkbox ng-model="r.checkAll" ng-change="checkAll(r)">{{r.title}}</md-checkbox>
                                                    </h3>
                                                    <div ng-repeat="i in r.childes">
                                                        <md-checkbox ng-model="i.check" ng-disabled="i.disable">{{i.name}}</md-checkbox>
                                                    </div>

                                                </div>
                                            </div>
                                        </menu-body>
                                    </menu-item>

                                </menu-container>
                            </div>


                        </form>


                    </div>

                    <div style="margin:60px 0 100px 0" >
                        <div class="ui form" style="margin-bottom:50px;">
                            <div class="field">
                                <label>نقش پدر
                                    <i class="icon ui mini trash pointer" ng-show="isAdmin" ng-click="parent=0" ></i>
                                </label>
                                <select ng-options="item.id as item.name for item in roles" ng-model="parent" ng-change="changeParent()">
                                </select>
                                </div>
                                <div class="field">
                                    <label>مدیران نقش</label>
                                    <sm-dropdown class="selection search multiple fluid" items="users" model="model.Admins" label="item.username" value="item.id"></sm-dropdown>
                                    <small class="gray">مدیر نقش می‌تواند نقش‌های زیر مجموعه برای این نقش تعریف کند و زیر مجموعه‌ای از دسترسی‌های این نقش را به زیر مجموعه اعطا کند</small>
                                </div>
                            </div>
                         
                        <div ng-if="isEdit">

                        <h3 class="">نقش‌های زیر مجموعه
                            <a class="ui button icon mini right floated" href="{{app.hashUrlPrefix + '#/roles/edit/0/' + id}}">
                                اضافه کردن
                                <i class="ui icon add" title="add Role"></i>
                            </a>
                        </h3>
                        <div>
                           <small ng-hide="childs && childs.length">هنوز نقشی تعریف نشده است</small>
                            <table class="ui table" ng-show="childs && childs.length">
                                <tr><th>#</th><th>نام</th></tr>
                            <tr ng-repeat="c in childs">
                                <td> {{$index+1}}</td>
                                <td>

                                <a href="{{app.hashUrlPrefix + '#/roles/edit/' + c.id}}">{{c.name}}</a>
                                </td>
                            </tr>
                            </table>
                        </div>
                        </div>
                    </div>

                </md-content>

                <md-card-actions layout="row">
                    <span flex></span>

                    <md-button ng-click="save(false)" ng-disabled="saveProgress">
                        {{saveProgress == false || saveProgressState != 'stay' ? ('ذخیره' | translate) : ('در حال ذخیره‌سازی...' | translate)}}
                    </md-button>
                    <md-button ng-click="save(true)" ng-disabled="saveProgress">
                        {{saveProgress == false || saveProgressState != 'exit'? ('ذخیره و بازگشت' | translate) : ('در حال ذخیره‌سازی...' | translate)}}
                    </md-button>

                </md-card-actions>
                 

            </md-card>

            <md-card ng-show="testResult" flex>
                <md-content style="max-height:200px;" id="card-resize" layout="column" flex>
                    <div ng-bind-html="testResult" flex></div>
                </md-content>
            </md-card>

            <md-card ng-show="error" layout="row" flex>
                <md-content style="background-color:#f2dede" layout="column" flex layout-padding>
                    <div ng-bind-html="error" flex></div>
                </md-content>
            </md-card>

        </div>
        <div flex="20" hide-sm hide-xs></div>

    </md-content>
</div>
