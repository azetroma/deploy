// داشبورد مدیریتی صدف info@sadafdashboard.ir 

var manageApp=angular.module("services",["ngMaterial","ngAnimate","ui.sortable","uibCollapseCat"]),ngApp=angular.module("services");ngApp.service("datasources",["$http","$mdMedia","$mdDialog","$compile","$rootScope","$q","$timeout",function(a,b,c,d,e,f,g){function h(){return l||(l=a.get(app.urlPrefix+"api/menus/get")),l}function i(){o={name:"همه",open:!0},p={name:"همه",open:!0}}function j(a,b){var c={type:["charts"],search:["content"],selectableDir:!1,justDir:!1,multipleChart:!0,multipleDatasource:!1};b=angular.extend({},c,b);var h=f.defer();b.deferred=h;var i=$("#asset-picker");if(!i.length){m=e.$new(),m.options=b;var j=d('<select-asset-dialog ng-model="options" ></select-asset-dialog>')(m);angular.element("div[ng-app]").append(j)}return g(function(){i=$("#asset-picker"),m.options=b,m.options.setLastSelect=function(a){n.charts=a.charts},i.modal("show")},1),h.promise}function k(b){var c=app.urlPrefix+"api/OlapChartDesign/CubeInformation?DataSourceId="+b;return a.get(c).then(function(a){return a.data})}var l,m,n={},o={name:"همه",open:!0},p={name:"همه",open:!0};return{get:h,select:j,lastSelected:n,reset:i,getColumns:k}}]),ngApp.directive("selectAssetDialog",[function(){return{scope:{ngModel:"="},controller:["$scope","$mdDialog","$timeout","$http",function(a,b,c,d){function e(b){function e(c){return console.log("search ",c),c?(a.showCharts&&(a.searchProgressChart=!0,d.get(app.urlPrefix+"api/charts/getlist?q="+c+"&parentRole="+b.parentRole).then(function(b){a.searchProgressChart=!1,l&&m?a.searchResultChart=b.data.list:l?a.searchResultChart=_.filter(b.data.list,{type:2}):a.searchResultChart=_.filter(b.data.list,{type:1})})),void(a.showDatasources&&(a.searchProgressDatasource=!0,d.get(app.urlPrefix+"api/datasources/get?q="+c).then(function(b){a.searchProgressDatasource=!1,l&&m?a.searchResultDatasource=b.data.list:l?a.searchResultDatasource=_.filter(b.data.list,{type:2}):searchResultDatasource=_.filter(b.data.list,{type:1})})))):(a.searchResultDatasource=null,void(a.searchResultChart=null))}function f(a,b){b(a),a.nodes&&(_.forEach(a.nodes,function(a){f(a,b)}),_.forEach(a.contents,function(a){f(a,b)}))}var g={name:"همه",open:!0},h={name:"همه",open:!0};a.query=null,a.searchResultDatasource=null,a.searchResultChart=null,a.showCharts=b.type.indexOf("charts")!=-1,a.showDatasources=b.type.indexOf("datasources")!=-1,a.selectedIndex=a.showDatasources?0:1;var i;a.search=function(b,d){c.cancel(i),i=c(function(){e(a.query)},400)},a.cancel=function(){$("#asset-picker").modal("hide")},a.select=function(){var c,d;a.showCharts&&a.showDatasources?(c=0==a.selectedIndex?a.datasources:a.charts,d=0==a.selectedIndex?"datasources":"charts"):a.showDatasources?(c=a.datasources,d="datasources"):(c=a.charts,d="charts");var e=[];a.searchResultDatasource||a.searchResultChart?(e=_.filter("charts"==d?a.searchResultChart:a.searchResultDatasource,{check:!0}),b.setLastSelect({charts:e})):f(c,function(a){a.active&&e.push(a)}),b.deferred.resolve({selected:e,type:d}),$("#asset-picker").modal("hide")};var j=function(a){if(!a.nodes){var c=app.urlPrefix+"api/charts/getlist?packageId="+(a.id||0)+"&parentRole="+(b.parentRole||0);d.get(c).then(function(b){a.loaded=!0,a.nodes=_.filter(b.data.list,{type:1}),a.contents=_.filter(b.data.list,{type:2})})}},k=function(a){if(!a.nodes){var c=app.urlPrefix+"api/datasources/get?packageId="+a.id+"&parentRole="+b.parentRole+"&showSubForms="+b.showSubForms;d.get(c).then(function(b){a.loaded=!0,a.nodes=_.filter(b.data.list,{type:1}),a.contents=_.filter(b.data.list,{type:2})})}};a.optDatasource={urlPrefix:app.urlPrefix+"api/datasources/get?packageId=",multiple:b.multipleDatasource,selectableDir:b.selectableDir,url:k,justDir:b.justDir},a.optChart={urlPrefix:app.urlPrefix+"api/charts/getlist?packageId=",multiple:b.multipleChart,selectableDir:b.selectableDir,url:j,justDir:b.justDir},a.datasources=g,a.charts=h,f(a.datasources,function(a){a.active=!1}),f(a.charts,function(a){a.active=!1}),a.showCharts&&j(a.charts),a.showDatasources&&k(a.datasources);var l=b.search.indexOf("content")!=-1,m=b.search.indexOf("dir")!=-1}a.$watch("ngModel",function(a,b){e(a)})}],template:'<div class="ui modal" id="asset-picker" aria-label="{{\'choose\' | translate}}" >                                                                                                                                 <div class="header">                                                                                                                                                                              <div class="ui form" >                <div class="field icon ui input fluid">                    <input type="text" ng-model="query" ng-change="search()" placeholder="{{\'جستجو\' | translate}}" />                    <i class="icon" title="{{\'clear\' | translate}}" ng-class="{remove: query.length, search: !query}" ng-click="query = null;search();" style="cursor:pointer !important; pointer-events:all !important"></i>                </div>            </div>        </div>                                                                                                                                                                         <div class="content scrolling">                                                                                                                                                                       <div class ="" >                                                                                                                                                    <div class="ui menu secondary pointing" ng-show="showDatasources&&showCharts">                    <div class="pointer item" ng-class="{active: selectedIndex==0}" ng-click="selectedIndex = 0">{{ \'datasources\' | translate }}</div>                    <div class="pointer item" ng-class="{active: selectedIndex==1}" ng-click="selectedIndex=1">{{ \'charts\' | translate }}</div>                </div>                <div >                    <div ng-if="showDatasources" ng-show="selectedIndex==0" >                                                                                                                                         <div class="ui active dimmer inverted" style="position:inherit;" ng-show="searchProgressDatasource">                            <div class="ui active centered inline text loader">                                                                       {{\'searching\' | translate}}                                                                                                                                                       </div>                                                                                                                                                                                </div>                                                                                                                                                                                <div ng-show="searchResultDatasource && !searchResultDatasource.length && !searchProgressDatasource">{{\'search_no_result\' | translate}}</div>                                 <tree ng-show="!searchResultDatasource" ng-model="datasources" option="optDatasource" class ="block"></tree>                                                                          <div ng-show="searchResultDatasource" layout-margin >                                                                                                                                     <div ng-repeat="i in searchResultDatasource">                                                                                                                                             <label><input type="checkbox" ng-model="i.check"/> {{i.name}}</label>                                                                                                                          </div>                                                                                                                                                                            </div>                                                                                                                                                                            </div>                                                                                                                                                                                                                                                                                                                                                                   <div  ng-if="showCharts" ng-show="selectedIndex==1">                                                                                                                                                <div class="ui active dimmer inverted" style="position:inherit;" ng-show="searchProgressChart">                            <div class="ui active centered inline text loader">                                  {{\'searching\' | translate}}                                                                                                                                                       </div>                                                                                                                                                                                </div>                                                                                                                                                                                <div class ="md-caption" layout-padding ng-show="searchResultChart && !searchResultChart.length && !searchProgressChart">{{\'search_no_result\' | translate}}</div>                                           <tree ng-show="!searchResultChart" ng-model="charts" option="optChart" class ="block"></tree>                                                                                         <div ng-show="searchResultChart" layout-margin >                                                                                                                                          <div ng-repeat="i in searchResultChart">                                                                                                                                                  <label><input type="checkbox" ng-model="i.check"/> {{i.name}}</label>                                                                                                                          </div>                                                                                                                                                                            </div>                                                                                                                                                                            </div>                                                                                                                                                                         </div>                                                                                                                                                                        </div>                                                                                                                                                                            </div>                                                                                                                                                                  <div class="actions">                                                                                                                                                          <div class="ui button green" ng-click="select()"> {{\'choose\' | translate}} </div>            <div class="ui button" ng-click="cancel()"> {{\'cancel\' | translate}} </div>        </div>                                                                                                                                                          </div>'}}]),ngApp.directive("collapse",function(){return{restrict:"E",transclude:!0,scope:{title:"@",hideIcon:"@",onTitleClick:"&",model:"=?ngModel",selectableDir:"=?"},controller:["$scope",function(a){var b,c;a.model=a.model||{},this.addHeader=function(d){b=d,b.show=a.model.open,b.click=function(){c&&(a.model.open=!c.show,c.show=!c.show),a.onTitleClick()}},this.addBody=function(b){c=b,c.show=a.model.open},"true"==a.hideIcon&&b&&(b.hideIcon=!0),a.$watch("hideIcon",function(c){"true"==a.hideIcon&&b&&(b.hideIcon=!0)})}],template:"<div ng-transclude><div>"}}).directive("collapseHeader",function(){return{restrict:"E",transclude:!0,require:"^^collapse",scope:{className:"@?"},link:function(a,b,c,d){d.addHeader(a)},template:'<div ng-click="show = !show; click()" class="pointer title {{className}}">                        <i style="width:30px;" class="ui icon angle left icon-animate" ng-class ="{\'rotate-90\' : show}" ng-style="{\'visibility\': !hideIcon ? \'visible\' : \'hidden\'}" xng-hide="hideIcon"></i>                        <div ng-transclude style="width: calc(100% - 40px); display:inline-block;" ><div>                 </div>'}}).directive("collapseBody",function(){return{restrict:"E",transclude:!0,require:"^^collapse",scope:{className:"@?"},link:function(a,b,c,d){d.addBody(a),a.ready=!1,a.$watch("show",function(b){b&&(a.ready=!0)})},template:'<div class="body {{className}}" uib-collapse="!show" ng-if="show || ready" style="min-height:unset;" ng-transclude></div>'}}).directive("tree",function(){return{restrict:"E",transclude:!0,scope:{root:"=ngModel",option:"=",url:"&"},controller:["$scope","$http","$translate",function(a,b,c){function d(a,b){b(a),a.nodes&&(_.forEach(a.nodes,function(a){d(a,b)}),_.forEach(a.contents,function(a){d(a,b)}))}a.root=a.root||{name:"root",open:!0},a.active=function(b){var c=b.active;a.option.multiple||d(a.root,function(a){a.active=!1}),b.active=c},a.selectAll=function(a,b){_.each(a.contents,function(a){a.active=b})}}],template:'<div class ="sadaf-tree">    <div style="list-style:none" class ="tree-element ul">        <div ng-repeat="data in [root]" class ="tree-element li" ng-include="\'tree_item_renderer.html\'"></div>    </div></div><script type="text/ng-template" id="tree_item_renderer.html">    <collapse class ="block" selectable-dir="option.selectableDir" ng-model="data"        hide-icon="{{(!data.nodes || !data.nodes.length ) && ( option.justDir || ( !data.contents || !data.contents.length) ) && data.loaded }}">        <collapse-header class ="block" ng-click="$event.stopPropagation(); option.url(data)">            <label ng-show="option.selectableDir" style="margin:0">                 <input type="checkbox" ng-model="data.active"ng-change="active(data)" ng-click="$event.stopPropagation()"/> {{data.name}}</label>            <span ng-show="!option.selectableDir">{{data.name}}</span>        </collapse-header>        <collapse-body class ="block">            <div class ="tree-element ul" style="list-style:none" >                <div class="ui active dimmer inverted" style="position:inherit; display:inline" ng-show="!data.loaded">                     <div class="ui active mini inline text loader">                    </div>                </div>                <div ng-show="data.loaded" class ="tree-element li">                    <label ng-show="option.multiple && data.contents.length" >                         <input type="checkbox" ng-click="$event.stopPropagation()" ng-model="data.selectAll" ng-change="selectAll(data, data.selectAll)"/> <small> {{"select_all" | translate}} </small></label></div>                <div ng-repeat="data in data.nodes" class ="tree-element li" ng-include="\'tree_item_renderer.html\'"></div>                <div ng-repeat="u in data.contents" class ="tree-element li" ng-class ="{active : u.active}" ng-hide="option.justDir">                    <label  style="margin-bottom:0"> <input ng-model="u.active" ng-change="active(u)"type="checkbox" /> {{u.name}}</label>                </div>            </div>        </collapse-body>    </collapse></script>'}}),ngApp.service("chartComments",["$http",function(a){function b(b,c){return a.post(app.urlPrefix+"api/ChartComments/save/"+b,c).then(function(a){return a.data})}return{save:b}}]);var sApp=angular.module("services");sApp.service("menus",["$http",function(a){function b(b){return f||(f=a.get(app.urlPrefix+"api/menus/get"+(b?"?JustEdit=true":""))),f}function c(b){return a.get(app.urlPrefix+"api/menus/getMenu/"+b)}function d(b){return a.post(app.urlPrefix+"api/menus/save/",b)}function e(c){return c?a.get(app.urlPrefix+"api/menus/get?ParentId="+c):b()}var f;return{get:b,save:d,getMenu:c,getParentMenu:e,getEditable:function(){return b(!0)}}}]),sApp.service("mainmenus",["$http",function(a){function b(b){_.isNaN(+b)&&(b=0);var c=a.get(app.urlPrefix+"api/mainmenus/get/"+b);return c}function c(b){return a.post(app.urlPrefix+"api/mainmenus/save",b)}function d(b){return a.post(app.urlPrefix+"api/mainmenus/delete/"+b)}function e(b){return a.get(app.urlPrefix+"api/mainmenus/search/"+b)}function f(b,c){return a.post(app.urlPrefix+"api/mainmenus/savePermissions/"+b,c)}return{get:b,save:c,remove:d,search:e,savePermissions:f}}]),sApp.service("menuCategories",["$http",function(a){function b(){return f||(f=a.get(app.urlPrefix+"api/menuCategories/get")),f}function c(b){return a.post(app.urlPrefix+"api/mainmenus/save",b)}function d(b){return a.post(app.urlPrefix+"api/mainmenus/delete/"+b)}function e(b){return a.get(app.urlPrefix+"api/mainmenus/search/"+b)}var f;return{get:b,save:c,remove:d,search:e}}]),sApp.service("mostRecentMenus",["$http",function(a){function b(){var b=a.get(app.urlPrefix+"api/mostRecentMenus/get");return b}function c(b){return a.post(app.urlPrefix+"api/mainmenus/delete/"+b)}return{get:b,remove:c}}]),sApp.service("favoriteMenus",["$http",function(a){function b(){var b=a.get(app.urlPrefix+"api/favoriteMenus/get");return b}function c(b){return a.post(app.urlPrefix+"api/mainmenus/delete/"+b)}return{get:b,remove:c}}]);var ngApp=angular.module("services");ngApp.service("roles",["$http",function(a){function b(){return e||(e=a.get(app.urlPrefix+"api/roles/get")),e}function c(){e=null}function d(a){function b(a,c){if(a.id==c.id)return a;if(_.isArray(a.nodes))for(var d=0;d<a.nodes.length;d++){var e=b(a.nodes[d],c);if(null!=e)return e}return null}var c=performance.now(),d={name:"root",nodes:[],contents:[]};_.each(a,function(b){var c=_.find(a,{id:b.parent});c||(b.parent=0)});var e=[].concat(a);_.each(e,function(a){a.nodes=[]});for(var f=0,g=e.length*e.length;e.length&&(f++,!(f>g));){var h=e.pop();if(h.parent){var i=b(d,{id:h.parent});i?(i.nodes=i.nodes||[],i.nodes.push(h)):e.unshift(h)}else d.nodes.push(h)}return console.log("time",performance.now()-c),d.open=!0,d}var e;return{get:b,reset:c,createTree:d}}]),ngApp.directive("selectRoles",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",settings:"=?"},controller:["$scope","$http","roles",function(a,b,c){a.model=a.model||[],a.settings=a.settings||{},c.get().then(function(b){a.roles=_.extend([],b.data.list)})}],template:'<div>                     <sm-dropdown class="selection search multiple fluid"  settings="{fullTextSearch: true}" model="model" items="roles" label="item.name" value="item.id" ></sm-dropdown>                   </div>',link:function(a,b,c){}}}),function(a){function b(a,c){a&&(a.check&&c.push({id:a.id,action:a.action}),_.each(a.nodes,function(a){b(a,c)}))}var c=angular.module("services");c.directive("datasourcePermission",["$timeout","$http","roles",function(a,c,d){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/datasource/datasourcePermission.html?v="+app.version,scope:{roles:"=ngModel",conf:"=?conf",id:"@",type:"@"},controller:["$scope","$http",function(a,c){function e(b,d){var e=app.urlPrefix+"api/permissions/getDatasourcePermissions?id="+b;switch(d){case"datasource":e=app.urlPrefix+"api/permissions/getDatasourcePermissions?id="+b;break;case"chart":e=app.urlPrefix+"api/permissions/getChartPermissions?id="+b;break;case"menu":e=app.urlPrefix+"api/permissions/getMenuPermissions?id="+b;break;case"mainmenu":e=app.urlPrefix+"api/permissions/getMainmenuPermissions?id="+b}a.getPermissionProgress=!0,c.get(e).then(function(b){a.getPermissionProgress=!1,a.permissions=b.data.list,f()})["catch"](function(){a.getPermissionProgress=!1})}function f(){a.permissions&&a.roles&&_.forEach(a.roles,function(b){b.check=!1;var c=_.find(a.permissions,{roleId:b.id});c&&(b.action=1==c.actionSum?1:3==c.actionSum?2:4,b.check=!0,_.isArray(c.extra)&&(b.extra=c.extra.slice()))})}var g=a.type&&"datasource"!==a.type?"chart"===a.type?"chart":"mainmenu"===a.type?"mainmenu":"menu":"datasource";a.roles&&a.roles.length||(d.get().then(function(b){a.roles=angular.merge({},b.data.list),_.forEach(a.roles,function(a){a.action=1,a.check=!1}),f();var c=_.filter(a.roles,null);a.root=d.createTree(c)}),a.$watch("root",function(c){var d=[];b(a.root,d),_.each(a.roles,function(a){var b=_.find(d,{id:a.id});a.check=null!=b,a.check&&(a.action=b.action)})},!0)),+a.id&&e(+a.id,g),a.$watch("conf.id",function(a,b){a&&e(a,g)})}]}}])}(jQuery);