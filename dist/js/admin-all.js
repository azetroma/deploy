/* داشبورد مدیریت صدف 
 sadafdashboard.ir 


*/
// داشبورد مدیریتی صدف info@sadafdashboard.ir 

var manageApp = angular.module("services", [ "ngMaterial", "ngAnimate", "ui.sortable", "uibCollapseCat" ]);

var ngApp = angular.module("services");

ngApp.service("datasources", [ "$http", "$mdMedia", "$mdDialog", "$compile", "$rootScope", "$q", "$timeout", function($http, $mdMedia, $mdDialog, $compile, $rootScope, $q, $timeout) {
    var promise;
    function get() {
        if (!promise) promise = $http.get(app.urlPrefix + "api/menus/get");
        return promise;
    }
    var lastSelected = {};
    var datasources = {
        name: "همه",
        open: true
    };
    var charts = {
        name: "همه",
        open: true
    };
    function reset() {
        datasources = {
            name: "همه",
            open: true
        };
        charts = {
            name: "همه",
            open: true
        };
    }
    var $pickerScope;
    function select(ev, options) {
        var defaults = {
            type: [ "charts" ],
            search: [ "content" ],
            selectableDir: false,
            justDir: false,
            multipleChart: true,
            multipleDatasource: false
        };
        options = angular.extend({}, defaults, options);
        var deferred = $q.defer();
        options.deferred = deferred;
        var picker = $("#asset-picker");
        if (!picker.length) {
            $pickerScope = $rootScope.$new();
            $pickerScope.options = options;
            var el = $compile('<select-asset-dialog ng-model="options" ></select-asset-dialog>')($pickerScope);
            angular.element("div[ng-app]").append(el);
        }
        $timeout(function() {
            picker = $("#asset-picker");
            $pickerScope.options = options;
            $pickerScope.options.setLastSelect = function(d) {
                lastSelected.charts = d.charts;
            };
            picker.modal("show");
        }, 1);
        return deferred.promise;
    }
    function getColumns(id) {
        var link = app.urlPrefix + "Moderation/OlapChartDesign/CubeInformation?DataSourceId=" + id;
        return $http.get(link).then(function(res) {
            return res.data;
        });
    }
    return {
        get: get,
        select: select,
        lastSelected: lastSelected,
        reset: reset,
        getColumns: getColumns
    };
} ]);

ngApp.directive("selectAssetDialog", [ function() {
    return {
        scope: {
            ngModel: "="
        },
        controller: [ "$scope", "$mdDialog", "$timeout", "$http", function(sp, $mdDialog, $timeout, $http) {
            sp.$watch("ngModel", function(n, d) {
                init(n);
            });
            function init(options) {
                var lastSelected = {};
                var datasources = {
                    name: "همه",
                    open: true
                };
                var charts = {
                    name: "همه",
                    open: true
                };
                function reset() {
                    datasources = {
                        name: "همه",
                        open: true
                    };
                    charts = {
                        name: "همه",
                        open: true
                    };
                }
                sp.query = null;
                sp.searchResultDatasource = null;
                sp.searchResultChart = null;
                sp.showCharts = options.type.indexOf("charts") != -1;
                sp.showDatasources = options.type.indexOf("datasources") != -1;
                sp.selectedIndex = sp.showDatasources ? 0 : 1;
                var timer;
                sp.search = function(n, o) {
                    $timeout.cancel(timer);
                    timer = $timeout(function() {
                        search(sp.query);
                    }, 400);
                };
                sp.cancel = function() {
                    $("#asset-picker").modal("hide");
                };
                sp.select = function() {
                    var obj;
                    var type;
                    if (sp.showCharts && sp.showDatasources) {
                        obj = sp.selectedIndex == 0 ? sp.datasources : sp.charts;
                        type = sp.selectedIndex == 0 ? "datasources" : "charts";
                    } else if (sp.showDatasources) {
                        obj = sp.datasources;
                        type = "datasources";
                    } else {
                        obj = sp.charts;
                        type = "charts";
                    }
                    var selected = [];
                    if (!sp.searchResultDatasource && !sp.searchResultChart) {
                        doRecursive(obj, function(item) {
                            if (item.active) selected.push(item);
                        });
                    } else {
                        selected = _.filter(type == "charts" ? sp.searchResultChart : sp.searchResultDatasource, {
                            check: true
                        });
                        options.setLastSelect({
                            charts: selected
                        });
                    }
                    options.deferred.resolve({
                        selected: selected,
                        type: type
                    });
                    $("#asset-picker").modal("hide");
                };
                var urlChart = function(d) {
                    if (!d.nodes) {
                        var urlPrefix = app.urlPrefix + "api/charts/getlist?packageId=" + d.id + "&parentRole=" + options.parentRole;
                        $http.get(urlPrefix).then(function(res) {
                            d.loaded = true;
                            d.nodes = _.filter(res.data.list, {
                                type: 1
                            });
                            d.contents = _.filter(res.data.list, {
                                type: 2
                            });
                        });
                    }
                };
                var urlDatasource = function(d) {
                    if (!d.nodes) {
                        var urlPrefix = app.urlPrefix + "api/datasources/get?packageId=" + d.id + "&parentRole=" + options.parentRole;
                        $http.get(urlPrefix).then(function(res) {
                            d.loaded = true;
                            d.nodes = _.filter(res.data.list, {
                                type: 1
                            });
                            d.contents = _.filter(res.data.list, {
                                type: 2
                            });
                        });
                    }
                };
                sp.optDatasource = {
                    urlPrefix: app.urlPrefix + "api/datasources/get?packageId=",
                    multiple: options.multipleDatasource,
                    selectableDir: options.selectableDir,
                    url: urlDatasource,
                    justDir: options.justDir
                };
                sp.optChart = {
                    urlPrefix: app.urlPrefix + "api/charts/getlist?packageId=",
                    multiple: options.multipleChart,
                    selectableDir: options.selectableDir,
                    url: urlChart,
                    justDir: options.justDir
                };
                sp.datasources = datasources;
                sp.charts = charts;
                doRecursive(sp.datasources, function(item) {
                    item.active = false;
                });
                doRecursive(sp.charts, function(item) {
                    item.active = false;
                });
                if (sp.showCharts) urlChart(sp.charts);
                if (sp.showDatasources) urlDatasource(sp.datasources);
                var showResultContent = options.search.indexOf("content") != -1;
                var showResultDir = options.search.indexOf("dir") != -1;
                function search(q) {
                    console.log("search ", q);
                    if (!q) {
                        sp.searchResultDatasource = null;
                        sp.searchResultChart = null;
                        return;
                    }
                    if (sp.showCharts) {
                        sp.searchProgressChart = true;
                        $http.get(app.urlPrefix + "api/charts/getlist?q=" + q + "&parentRole=" + options.parentRole).then(function(res) {
                            sp.searchProgressChart = false;
                            if (showResultContent && showResultDir) {
                                sp.searchResultChart = res.data.list;
                            } else if (showResultContent) {
                                sp.searchResultChart = _.filter(res.data.list, {
                                    type: 2
                                });
                            } else {
                                sp.searchResultChart = _.filter(res.data.list, {
                                    type: 1
                                });
                            }
                        });
                    }
                    if (sp.showDatasources) {
                        sp.searchProgressDatasource = true;
                        $http.get(app.urlPrefix + "api/datasources/get?q=" + q).then(function(res) {
                            sp.searchProgressDatasource = false;
                            if (showResultContent && showResultDir) {
                                sp.searchResultDatasource = res.data.list;
                            } else if (showResultContent) {
                                sp.searchResultDatasource = _.filter(res.data.list, {
                                    type: 2
                                });
                            } else {
                                searchResultDatasource = _.filter(res.data.list, {
                                    type: 1
                                });
                            }
                        });
                    }
                }
                function doRecursive(e, callback) {
                    callback(e);
                    if (e.nodes) {
                        _.forEach(e.nodes, function(item) {
                            doRecursive(item, callback);
                        });
                        _.forEach(e.contents, function(item) {
                            doRecursive(item, callback);
                        });
                    }
                }
            }
        } ],
        template: '<div class="ui modal" id="asset-picker" aria-label="{{\'choose\' | translate}}" >                                                                                                                                 <div class="header">                                                                                                                                                                              <div class="ui form" >                <div class="field icon ui input fluid">                    <input type="text" ng-model="query" ng-change="search()" placeholder="{{\'جستجو\' | translate}}" />                    <i class="icon" title="{{\'clear\' | translate}}" ng-class="{remove: query.length, search: !query}" ng-click="query = null;search();" style="cursor:pointer !important; pointer-events:all !important"></i>                </div>            </div>        </div>                                                                                                                                                                         <div class="content scrolling">                                                                                                                                                                       <div class ="" >                                                                                                                                                    <div class="ui menu secondary pointing" ng-show="showDatasources&&showCharts">                    <div class="pointer item" ng-class="{active: selectedIndex==0}" ng-click="selectedIndex = 0">{{ \'datasources\' | translate }}</div>                    <div class="pointer item" ng-class="{active: selectedIndex==1}" ng-click="selectedIndex=1">{{ \'charts\' | translate }}</div>                </div>                <div >                    <div ng-if="showDatasources" ng-show="selectedIndex==0" >                                                                                                                                         <div class="ui active dimmer inverted" style="position:inherit;" ng-show="searchProgressDatasource">                            <div class="ui active centered inline text loader">                                                                       {{\'searching\' | translate}}                                                                                                                                                       </div>                                                                                                                                                                                </div>                                                                                                                                                                                <div ng-show="searchResultDatasource && !searchResultDatasource.length && !searchProgressDatasource">{{\'search_no_result\' | translate}}</div>                                 <tree ng-show="!searchResultDatasource" ng-model="datasources" option="optDatasource" class ="block"></tree>                                                                          <div ng-show="searchResultDatasource" layout-margin >                                                                                                                                     <div ng-repeat="i in searchResultDatasource">                                                                                                                                             <label><input type="checkbox" ng-model="i.check"/> {{i.name}}</label>                                                                                                                          </div>                                                                                                                                                                            </div>                                                                                                                                                                            </div>                                                                                                                                                                                                                                                                                                                                                                   <div  ng-if="showCharts" ng-show="selectedIndex==1">                                                                                                                                                <div class="ui active dimmer inverted" style="position:inherit;" ng-show="searchProgressChart">                            <div class="ui active centered inline text loader">                                  {{\'searching\' | translate}}                                                                                                                                                       </div>                                                                                                                                                                                </div>                                                                                                                                                                                <div class ="md-caption" layout-padding ng-show="searchResultChart && !searchResultChart.length && !searchProgressChart">{{\'search_no_result\' | translate}}</div>                                           <tree ng-show="!searchResultChart" ng-model="charts" option="optChart" class ="block"></tree>                                                                                         <div ng-show="searchResultChart" layout-margin >                                                                                                                                          <div ng-repeat="i in searchResultChart">                                                                                                                                                  <label><input type="checkbox" ng-model="i.check"/> {{i.name}}</label>                                                                                                                          </div>                                                                                                                                                                            </div>                                                                                                                                                                            </div>                                                                                                                                                                         </div>                                                                                                                                                                        </div>                                                                                                                                                                            </div>                                                                                                                                                                  <div class="actions">                                                                                                                                                          <div class="ui button green" ng-click="select()"> {{\'choose\' | translate}} </div>            <div class="ui button" ng-click="cancel()"> {{\'cancel\' | translate}} </div>        </div>                                                                                                                                                          </div>'
    };
} ]);

ngApp.directive("collapse", function() {
    return {
        restrict: "E",
        transclude: true,
        scope: {
            title: "@",
            hideIcon: "@",
            onTitleClick: "&",
            model: "=?ngModel",
            selectableDir: "=?"
        },
        controller: [ "$scope", function($scope) {
            var header;
            var body;
            $scope.model = $scope.model || {};
            this.addHeader = function(h) {
                header = h;
                header.show = $scope.model.open;
                header.click = function() {
                    if (body) {
                        $scope.model.open = !body.show;
                        body.show = !body.show;
                    }
                    $scope.onTitleClick();
                };
            };
            this.addBody = function(b) {
                body = b;
                body.show = $scope.model.open;
            };
            if ($scope.hideIcon == "true" && header) {
                header.hideIcon = true;
            }
            $scope.$watch("hideIcon", function(n) {
                if ($scope.hideIcon == "true" && header) {
                    header.hideIcon = true;
                }
            });
        } ],
        template: "<div ng-transclude><div>"
    };
}).directive("collapseHeader", function() {
    return {
        restrict: "E",
        transclude: true,
        require: "^^collapse",
        scope: {},
        link: function(scope, element, attrs, collapse) {
            collapse.addHeader(scope);
        },
        template: '<div ng-click="show = !show; click()" class="pointer title">                        <i style="width:30px;" class="ui icon angle left icon-animate" ng-class ="{\'rotate-90\' : show}" ng-style="{\'visibility\': !hideIcon ? \'visible\' : \'hidden\'}" xng-hide="hideIcon"></i>                        <div ng-transclude style="width: calc(100% - 40px); display:inline-block;" ><div>                 </div>'
    };
}).directive("collapseBody", function() {
    return {
        restrict: "E",
        transclude: true,
        require: "^^collapse",
        scope: {},
        link: function(scope, element, attrs, collapse) {
            collapse.addBody(scope);
        },
        template: '<div class="body" uib-collapse="!show" style="min-height:unset;" ng-transclude></div>'
    };
}).directive("tree", function() {
    return {
        restrict: "E",
        transclude: true,
        scope: {
            root: "=ngModel",
            option: "=",
            url: "&"
        },
        controller: [ "$scope", "$http", "$translate", function($scope, $http, $translate) {
            $scope.root = $scope.root || {
                name: "root",
                open: true
            };
            $scope.active = function(u) {
                var temp = u.active;
                if (!$scope.option.multiple) {
                    doRecursive($scope.root, function(item) {
                        item.active = false;
                    });
                }
                u.active = temp;
            };
            $scope.selectAll = function(data, s) {
                _.each(data.contents, function(d) {
                    d.active = s;
                });
            };
            function doRecursive(e, callback) {
                callback(e);
                if (e.nodes) {
                    _.forEach(e.nodes, function(item) {
                        doRecursive(item, callback);
                    });
                    _.forEach(e.contents, function(item) {
                        doRecursive(item, callback);
                    });
                }
            }
        } ],
        template: '<div class ="sadaf-tree">    <div style="list-style:none" class ="tree-element ul">        <div ng-repeat="data in [root]" class ="tree-element li" ng-include="\'tree_item_renderer.html\'"></div>    </div></div><script type="text/ng-template" id="tree_item_renderer.html">    <collapse class ="block" selectable-dir="option.selectableDir" ng-model="data"        hide-icon="{{(!data.nodes || !data.nodes.length ) && ( option.justDir || ( !data.contents || !data.contents.length) ) && data.loaded }}">        <collapse-header class ="block" ng-click="$event.stopPropagation(); option.url(data)">            <label ng-show="option.selectableDir" style="margin:0">                 <input type="checkbox" ng-model="data.active"ng-change="active(data)" ng-click="$event.stopPropagation()"/> {{data.name}}</label>            <span ng-show="!option.selectableDir">{{data.name}}</span>        </collapse-header>        <collapse-body class ="block">            <div class ="tree-element ul" style="list-style:none" >                <div class="ui active dimmer inverted" style="position:inherit; display:inline" ng-show="!data.loaded">                     <div class="ui active mini inline text loader">                    </div>                </div>                <div ng-show="data.loaded" class ="tree-element li">                    <label ng-show="option.multiple && data.contents.length" >                         <input type="checkbox" ng-click="$event.stopPropagation()" ng-model="data.selectAll" ng-change="selectAll(data, data.selectAll)"/> <small> {{"select_all" | translate}} </small></label></div>                <div ng-repeat="data in data.nodes" class ="tree-element li" ng-include="\'tree_item_renderer.html\'"></div>                <div ng-repeat="u in data.contents" class ="tree-element li" ng-class ="{active : u.active}" ng-hide="option.justDir">                    <label  style="margin-bottom:0"> <input ng-model="u.active" ng-change="active(u)"type="checkbox" /> {{u.name}}</label>                </div>            </div>        </collapse-body>    </collapse></script>'
    };
});

ngApp.service("chartComments", [ "$http", function($http) {
    function save(chartId, data) {
        return $http.post(app.urlPrefix + "api/ChartComments/save/" + chartId, data).then(function(res) {
            return res.data;
        });
    }
    return {
        save: save
    };
} ]);

var sApp = angular.module("services");

sApp.service("menus", [ "$http", function($http) {
    var promise;
    function get(justEdit) {
        if (!promise) promise = $http.get(app.urlPrefix + "api/menus/get" + (justEdit ? "?JustEdit=true" : ""));
        return promise;
    }
    function getMenu(id) {
        return $http.get(app.urlPrefix + "api/menus/getMenu/" + id);
    }
    function save(model) {
        return $http.post(app.urlPrefix + "api/menus/save/", model);
    }
    function getParentMenu(parent) {
        if (!parent) return get();
        return $http.get(app.urlPrefix + "api/menus/get?ParentId=" + parent);
    }
    return {
        get: get,
        save: save,
        getMenu: getMenu,
        getParentMenu: getParentMenu,
        getEditable: function() {
            return get(true);
        }
    };
} ]);

sApp.service("mainmenus", [ "$http", function($http) {
    function get(parent) {
        var promise = $http.get(app.urlPrefix + "api/mainmenus/get/" + parent);
        return promise;
    }
    function save(model) {
        return $http.post(app.urlPrefix + "api/mainmenus/save", model);
    }
    function remove(id) {
        return $http.get(app.urlPrefix + "api/mainmenus/delete/" + id);
    }
    function search(q) {
        return $http.get(app.urlPrefix + "api/mainmenus/search/" + q);
    }
    function savePermissions(id, roles) {
        return $http.post(app.urlPrefix + "api/mainmenus/savePermissions/" + id, roles);
    }
    return {
        get: get,
        save: save,
        remove: remove,
        search: search,
        savePermissions: savePermissions
    };
} ]);

sApp.service("menuCategories", [ "$http", function($http) {
    var promise;
    function get() {
        if (!promise) promise = $http.get(app.urlPrefix + "api/menuCategories/get");
        return promise;
    }
    function save(model) {
        return $http.post(app.urlPrefix + "api/mainmenus/save", model);
    }
    function remove(id) {
        return $http.get(app.urlPrefix + "api/mainmenus/delete/" + id);
    }
    function search(q) {
        return $http.get(app.urlPrefix + "api/mainmenus/search/" + q);
    }
    return {
        get: get,
        save: save,
        remove: remove,
        search: search
    };
} ]);

sApp.service("mostRecentMenus", [ "$http", function($http) {
    function get() {
        var promise = $http.get(app.urlPrefix + "api/mostRecentMenus/get");
        return promise;
    }
    function remove(id) {
        return $http.get(app.urlPrefix + "api/mainmenus/delete/" + id);
    }
    return {
        get: get,
        remove: remove
    };
} ]);

sApp.service("favoriteMenus", [ "$http", function($http) {
    function get() {
        var promise = $http.get(app.urlPrefix + "api/favoriteMenus/get");
        return promise;
    }
    function remove(id) {
        return $http.get(app.urlPrefix + "api/mainmenus/delete/" + id);
    }
    return {
        get: get,
        remove: remove
    };
} ]);

var ngApp = angular.module("services");

ngApp.service("roles", [ "$http", function($http) {
    var promise;
    function get() {
        if (!promise) promise = $http.get(app.urlPrefix + "api/roles/get");
        return promise;
    }
    function reset() {
        promise = null;
    }
    function createTree(data) {
        var root = {
            name: "root",
            nodes: [],
            contents: []
        };
        function findRec(tree, item) {
            if (tree.id == item.id) return tree;
            if (_.isArray(tree.nodes)) {
                for (var i = 0; i < tree.nodes.length; i++) {
                    var f = findRec(tree.nodes[i], item);
                    if (f != null) return f;
                }
            }
            return null;
        }
        _.each(data, function(item) {
            var exists = _.find(data, {
                id: item.parent
            });
            if (!exists) {
                item.parent = 0;
            }
        });
        var array = [].concat(data);
        _.each(array, function(d) {
            d.nodes = [];
        });
        var i = 0, max = array.length * array.length;
        var t = performance.now();
        while (array.length) {
            i++;
            if (i > max) break;
            var item = array.pop();
            if (!item.parent) {
                root.nodes.push(item);
                continue;
            }
            var parent = findRec(root, {
                id: item.parent
            });
            if (parent) {
                parent.nodes = parent.nodes || [];
                parent.nodes.push(item);
            } else {
                array.unshift(item);
            }
        }
        console.log("time", performance.now() - t);
        root.open = true;
        return root;
    }
    return {
        get: get,
        reset: reset,
        createTree: createTree
    };
} ]);

ngApp.directive("selectRoles", function() {
    return {
        restrict: "E",
        replace: true,
        transclude: true,
        scope: {
            model: "=ngModel",
            settings: "=?"
        },
        controller: [ "$scope", "$http", "roles", function(scope, $http, roles) {
            scope.model = scope.model || [];
            scope.settings = scope.settings || {};
            roles.get().then(function(data) {
                scope.roles = _.extend([], data.data.list);
            });
        } ],
        template: '<div>                     <sm-dropdown class="selection search multiple fluid"  settings="{fullTextSearch: true}" model="model" items="roles" label="item.name" value="item.id" ></sm-dropdown>                   </div>',
        link: function(scope, element, attributes) {}
    };
});

(function($) {
    var md = angular.module("services");
    function getCheckedRole(node, array) {
        if (!node) return;
        if (node.check) array.push({
            id: node.id,
            action: node.action
        });
        _.each(node.nodes, function(item) {
            getCheckedRole(item, array);
        });
    }
    md.directive("datasourcePermission", [ "$timeout", "$http", "roles", function($timeout, $http, roles) {
        return {
            restrict: "E",
            templateUrl: app.urlPrefix + "dist/partial/management/datasource/datasourcePermission.html?v=" + app.version,
            scope: {
                roles: "=ngModel",
                conf: "=?conf",
                id: "@",
                type: "@"
            },
            controller: [ "$scope", "$http", function($scope, $http) {
                var type = !$scope.type || $scope.type === "datasource" ? "datasource" : $scope.type === "chart" ? "chart" : $scope.type === "mainmenu" ? "mainmenu" : "menu";
                if (!$scope.roles || !$scope.roles.length) {
                    roles.get().then(function(res) {
                        $scope.roles = angular.merge({}, res.data.list);
                        _.forEach($scope.roles, function(item) {
                            item.action = 1;
                            item.check = false;
                        });
                        checkRoleActions();
                        var r = _.filter($scope.roles, null);
                        $scope.root = roles.createTree(r);
                    });
                    $scope.$watch("root", function(n) {
                        var checkedRoles = [];
                        getCheckedRole($scope.root, checkedRoles);
                        _.each($scope.roles, function(role) {
                            var checked = _.find(checkedRoles, {
                                id: role.id
                            });
                            role.check = checked != null;
                            if (role.check) {
                                role.action = checked.action;
                            }
                        });
                    }, true);
                }
                if (+$scope.id) {
                    getPermission(+$scope.id, type);
                }
                $scope.$watch("conf.id", function(n, o) {
                    if (n) getPermission(n, type);
                });
                function getPermission(id, type) {
                    var link = app.urlPrefix + "api/permissions/getDatasourcePermissions?id=" + id;
                    switch (type) {
                      case "datasource":
                        link = app.urlPrefix + "api/permissions/getDatasourcePermissions?id=" + id;
                        break;

                      case "chart":
                        link = app.urlPrefix + "api/permissions/getChartPermissions?id=" + id;
                        break;

                      case "menu":
                        link = app.urlPrefix + "api/permissions/getMenuPermissions?id=" + id;
                        break;

                      case "mainmenu":
                        link = app.urlPrefix + "api/permissions/getMainmenuPermissions?id=" + id;
                        break;

                      default:                    }
                    $scope.getPermissionProgress = true;
                    $http.get(link).then(function(res) {
                        $scope.getPermissionProgress = false;
                        $scope.permissions = res.data.list;
                        checkRoleActions();
                    }).catch(function() {
                        $scope.getPermissionProgress = false;
                    });
                }
                function checkRoleActions() {
                    if ($scope.permissions && $scope.roles) {
                        _.forEach($scope.roles, function(role) {
                            role.check = false;
                            var permission = _.find($scope.permissions, {
                                roleId: role.id
                            });
                            if (permission) {
                                role.action = permission.actionSum == 1 ? 1 : permission.actionSum == 3 ? 2 : 4;
                                role.check = true;
                                if (_.isArray(permission.extra)) {
                                    role.extra = permission.extra.slice();
                                }
                            }
                        });
                    }
                }
            } ]
        };
    } ]);
})(jQuery);
// داشبورد مدیریتی صدف info@sadafdashboard.ir 

var cal = angular.module("calendar", []);

var ngApp = angular.module("sadafForms", [ "iframeCommunicate", "ng-sortable", "services", "calendar", "semantic-ui", "ngRoute", "ui.sortable", "pascalprecht.translate", "ngSanitize", "uibCollapseCat", "ngFileUpload" ]);

ngApp.config([ "$translateProvider", function($translateProvider) {
    $translateProvider.useStaticFilesLoader({
        prefix: app.urlPrefix + "dist/locales/locale-",
        suffix: ".js"
    });
    $translateProvider.preferredLanguage("fa");
    $translateProvider.useSanitizeValueStrategy("sanitizeParameters");
} ]);

ngApp.config([ "$routeProvider", "$locationProvider", function($routeProvider, $locationProvider) {
    $routeProvider.when("/forms/list", {
        templateUrl: app.urlPrefix + "dist/partial/forms/editor/form-generator-list.html?v=" + app.version,
        controller: "fromsCtrl",
        controllerAs: "c"
    }).when("/forms/:id?", {
        templateUrl: app.urlPrefix + "dist/partial/forms/editor/form-generator-editor.html?v=" + app.version,
        controller: "fromGeneratorCtrl",
        controllerAs: "c"
    });
} ]);

var iframeCommunicate = angular.module("iframeCommunicate", []);

iframeCommunicate.service("iframeService", [ "$location", "$http", function($location, $http) {
    return {
        setPath: function(path) {
            window.location.href = app.urlPrefix + path;
            console.log("### [iframeService] window.location.href ", app.urlPrefix + path);
        },
        handleMessage: function(message) {
            console.log("handleMessage", message);
            $this = this;
            if (message.type === "route") {
                this.setPath(message.param);
            }
            if (message.type === "action-call") {
                $http.get(message.param);
            }
            if (message.type === "set-variable") {
                if (_.isArray(message.param.userVariables)) {
                    localStorage.setItem("userVariable", JSON.stringify(message.param.userVariables));
                }
                $this.setPath(message.param.url);
            }
        }
    };
} ]);

var ngApp = angular.module("sadafForms");

ngApp.directive("sadafForm", function() {
    return {
        scope: {
            id: "@",
            rowId: "@?",
            onCancel: "&?",
            onFinish: "&?",
            onSave: "&?",
            option: "=?",
            settings: "=?"
        },
        controller: [ "$scope", "$http", "$sce", "$routeParams", "$timeout", "$q", "formsService", "formsSubmitService", "$attrs", "taskExecutor", function($scope, $http, $sce, $routeParams, $timeout, $q, formsService, formsSubmitService, $attrs, taskExecutor) {
            var c = this;
            $scope.selector = "selector-" + Math.floor(Math.random() * 999999 + 1e6);
            $scope.option = $scope.option || {};
            $scope.onCancel = $scope.onCancel || function() {};
            var id = $scope.id;
            $scope.submittedStatus = 0;
            $scope.formLoading = true;
            $scope.activePage = 0;
            $scope.setActivePage = function(i) {
                $scope.activePage = i;
                if ($scope.settings.modal) {
                    $timeout(function() {
                        $("#" + $scope.selector).modal("refresh");
                    }, 0);
                }
            };
            $scope.isValid = function() {
                var isValid = false;
                if ($scope.data && $scope.data.pages) main: for (var i = 0; i < $scope.data.pages.length; i++) {
                    for (var j = 0; j < $scope.data.pages[i].controls.length; j++) {
                        var cnt = $scope.data.pages[i].controls[j];
                        if (cnt.type == 12 && !cnt.isValid) {
                            isValid = true;
                            break main;
                        }
                    }
                }
                return isValid;
            };
            function executeTask(type) {}
            $scope.submit = function() {
                if ($scope.loading === true) return;
                $scope.loading = true;
                $scope.clearAllErrors();
                formsSubmitService.submit($scope.id, $scope.data).then(function success(data) {
                    $scope.loading = false;
                    $scope.submittedStatus = 0;
                    if (!data.result && data.messages) {
                        $scope.pagesContainError = $scope.pagesContainError || [];
                        _.each($scope.data.pages, function(page) {
                            _.each(data.messages, function(error) {
                                var cnt = _.find(page.controls, {
                                    name: error.name
                                });
                                if (cnt) {
                                    cnt.error = error.error;
                                    if (_.findIndex($scope.pagesContainError, page) == -1) {
                                        $scope.pagesContainError.push(page);
                                    }
                                }
                            });
                        });
                    }
                    if (!data.result && data.pageMessages) {
                        _.each(data.pageMessages, function(error) {
                            var cnt = _.find($scope.data.pages, {
                                name: error.name
                            });
                            if (cnt) cnt.error = error.error;
                        });
                    }
                    if (data.result) {
                        var isNew = +$scope.rowId == 0;
                        var model = $scope.data;
                        _.each(autoIncMap, function(k, v) {
                            autoIncMap[v] = k + 1;
                        });
                        $timeout(function() {
                            $("#" + $scope.selector + " .close-btn").focus();
                        }, 0);
                        if ($scope.data.showSubmitedInfo) {
                            $scope.submittedStatus = 1;
                            runOnAllControll($scope.data, function(d) {
                                d.readonly = true;
                            });
                        } else {
                            $scope.submitNewInfo();
                        }
                        if ($scope.onSave) $scope.onSave({
                            data: data
                        });
                    }
                }, function error(res) {
                    if (res.data.title && res.data.desc) {
                        $scope.error = {
                            title: res.data.title,
                            desc: res.data.desc
                        };
                    } else {
                        $scope.error = null;
                    }
                    $scope.loading = false;
                    $scope.submittedStatus = 2;
                });
            };
            $scope.submitNewInfo = function() {
                $scope.submittedStatus = 0;
                runOnAllControll($scope.data, function(d) {
                    d.readonly = false;
                });
                if ($scope.onFinish) $scope.onFinish();
                $scope.clearForm();
                formsService.clearCache($scope.id);
                getFormEmptyData();
            };
            $scope.clearAllErrors = function() {
                $scope.pagesContainError = [];
                runOnAllControll($scope.data, function(cnt) {
                    cnt.error = null;
                }, function(page) {
                    page.error = null;
                });
            };
            var autoIncMap = {};
            $scope.clearForm = function() {
                $scope.submittedStatus = 0;
                $scope.activePage = 0;
                runOnAllControll($scope.data, function(nItem) {
                    if (nItem && nItem.type == 2 && nItem.validations && nItem.validations.autoIncrement) {
                        nItem.value = autoIncMap[nItem.name];
                        return;
                    }
                    nItem.value = null;
                    if (nItem.dropdown) nItem.dropdown.listValue = null;
                    nItem.value = null;
                    if (nItem.dropdown) nItem.dropdown.listValue = null;
                    if (nItem.type == 13) nItem.multiRowForm.rows.splice(0, nItem.multiRowForm.rows.length - 1);
                });
            };
            function changeDigitType(data) {
                _.each(data, function(page) {
                    rec(page.controls, function(cnt) {
                        if (cnt.type == 2 && cnt.value != null) {
                            cnt.value = +cnt.value;
                        }
                    });
                });
            }
            function rec(cnts, run) {
                _.each(cnts, function(cnt) {
                    run(cnt);
                    if (cnt.type == 13) {
                        _.each(cnt.multiRowForm.rows, function(row) {
                            rec(row, run);
                        });
                    }
                });
            }
            function getFormData() {
                $scope.clearForm();
                if (!$scope.rowId) return;
                if (+$scope.id == 0) return;
                $scope.formLoading = true;
                formsSubmitService.get($scope.id, $scope.rowId).then(function(data) {
                    changeDigitType(data.model.pages);
                    $scope.editPermission = data.editPermission;
                    $scope.addPermission = data.addPermission;
                    $scope.deletePermission = data.deletePermission;
                    $timeout(function() {
                        if ($scope.data && $scope.data.pages) {
                            $scope.data.pages = [];
                        }
                    }, 0);
                    $timeout(function() {
                        $scope.data = data.model;
                        $scope.data.id = data.id;
                        $scope.data.rowId = $scope.rowId;
                        $scope.modelId = data.id;
                        $scope.allControl = [];
                        runOnAllControll($scope.data, function(cnt) {
                            $scope.allControl.push(cnt);
                        });
                    }, 250);
                    $timeout(function() {
                        $scope.formLoading = false;
                        $timeout(function() {
                            $("#" + $scope.selector).modal("refresh");
                        }, 50);
                    }, 500);
                }, function() {
                    $scope.formLoading = false;
                });
            }
            function getFormEmptyData() {
                console.log("### [getFormEmptyData]");
                $scope.clearForm();
                $scope.formLoading = true;
                formsService.get($scope.id).then(function(data) {
                    $scope.formLoading = false;
                    $scope.data = data.model;
                    $scope.editPermission = data.editPermission;
                    $scope.deletePermission = data.deletePermission;
                    $scope.addPermission = data.addPermission;
                    changeDigitType(data.model.pages);
                    $scope.allControl = [];
                    runOnAllControll($scope.data, function(nItem) {
                        $scope.allControl.push(nItem);
                        if (nItem && nItem.type == 2 && nItem.validations && nItem.validations.autoIncrement) {
                            autoIncMap[nItem.name] = autoIncMap[nItem.name] || +nItem.value;
                        }
                    });
                }, function() {
                    $scope.formLoading = false;
                });
            }
            $scope.cancel = function() {
                $scope.submitNewInfo();
                $scope.onCancel();
            };
            $scope.remove = function() {
                var f = confirm("آیا برای حذف اطلاعات جاری فرم اطمینان دارید؟");
                if (f) formsSubmitService.remove($scope.id, $scope.rowId).then(function() {
                    executeTask(2);
                    $scope.onCancel();
                    $scope.submitNewInfo();
                }, function(res) {
                    if (res.data.title && res.data.desc) {
                        alert(res.data.desc);
                    }
                });
            };
            function clearIfFilterHasControl(name, cnt) {
                if (cnt.useFilter && cnt.filters && cnt.filters.length) {
                    var needClear = _.some(cnt.filters, {
                        control: name,
                        type: 2
                    });
                    if (needClear) {
                        cnt.value = null;
                    }
                }
            }
            $scope.$watch(angular.bind(this, function() {
                return this.allControl;
            }), function(n, d) {
                if (!n || !d) return;
                _.each(n, function(nv) {
                    var old = _.find(d, {
                        name: nv.name
                    });
                    if (nv.value != old.value && (nv.type == 12 || nv.type == 4)) {
                        debugger;
                        _.each($scope.allControl, function(cnt) {
                            if (nv.name != cnt.name) {
                                clearIfFilterHasControl(nv.name, cnt);
                            }
                        });
                    }
                });
            }, true);
            var lastRun = null;
            $scope.$watch("data", function(newVal, oldVal) {
                $timeout.cancel(lastRun);
                lastRun = $timeout(updateCalculated, 350);
            }, true);
            function findControl(name, data) {
                var n = null;
                runOnAllControll(data, function(d) {
                    if (d.name === name) {
                        n = d;
                        return false;
                    }
                });
                return n;
            }
            function runOnAllControll(data, run, pageRun) {
                if (!data) return;
                var pagesControls = [];
                _.each(data.pages, function(page) {
                    if (pageRun) pageRun(page);
                    if (page && _.isArray(page.controls)) {
                        pagesControls = pagesControls.concat(page.controls);
                    }
                });
                _.each(pagesControls, function(cnt) {
                    if (cnt.type == 13) {
                        _.each(cnt.multiRowForm.rows, function(row) {
                            _.each(row, function(i) {
                                var ret = run(i, row);
                                if (ret === false) return false;
                            });
                        });
                    }
                    var ret = run(cnt, pagesControls);
                    if (ret === false) return false;
                });
            }
            function GetMultiRowControlBaseOnChildName(name) {
                var row;
                runOnAllControll($scope.data, function(cnt) {
                    if (cnt.type == 13) {
                        var index = _.findIndex(cnt.multiRowForm.rows[0], {
                            name: name
                        });
                        if (index != -1) {
                            row = {
                                control: cnt,
                                index: index
                            };
                        }
                    }
                });
                return row;
            }
            function calcFlatFormula(f, rowControls) {
                var params = [];
                var r = f.replace(/\[(field-\d+)\]/gi, function(a, b, c) {
                    var cc = _.find(rowControls, {
                        name: b
                    });
                    if (cc.type == 8) {
                        var val = "00:00";
                        if (cc.value) val = cc.value.substring(0, 5);
                        params.push({
                            type: "millisecond",
                            value: moment.duration(val).asMilliseconds()
                        });
                    }
                    if (cc.type == 9) {
                        var val = "1300/0/01";
                        if (cc.value) val = cc.value;
                        params.push({
                            type: "millisecond",
                            value: moment(val, "jYYYY/jMM/jDD").utc().unix() * 1e3
                        });
                    }
                    if (cc.type == 14) {
                        var val = "1300/0/01 00:00:00";
                        if (cc.value) val = cc.value;
                        params.push({
                            type: "millisecond",
                            value: moment(val, "jYYYY/jMM/jDD HH:mm:ss").utc().unix() * 1e3
                        });
                    }
                    if (cc.type == 2 || cc.type == 5 && cc.calcType == "digit" || cc.type == 16 && cc.calcType == "digit") {
                        params.push({
                            type: "digit",
                            value: +cc.value || 0
                        });
                    }
                    if (cc.type == 5 && cc.calcType == "millisecond" || cc.type == 16 && cc.calcType == "millisecond") {
                        params.push({
                            type: "millisecond",
                            value: cc.calculate.calculatedValue
                        });
                    }
                    return "{" + (params.length - 1) + "}";
                });
                var newR = r.replace(/\{(\d+)\}/gi, function(a, b, c) {
                    return " " + params[+b].value + " ";
                });
                var haveDate = _.filter(params, function(d) {
                    return d.type == "millisecond" || d.type == "millisecond" || d.type == "millisecond";
                }).length > 0;
                var haveDigit = _.some(params, {
                    type: "digit"
                });
                if (haveDate) {
                    var v = moment.duration(+eval(newR)).format("d روز و h ساعت و m دقیقه");
                    return {
                        value: v,
                        calculatedValue: +eval(newR),
                        type: "millisecond"
                    };
                }
                var v = +eval(newR);
                return {
                    value: v,
                    calculatedValue: +eval(newR),
                    type: "digit"
                };
            }
            function updateCalculated(newVal, oldVal) {
                console.log("updateCalculated");
                runOnAllControll($scope.data, function(control, rowControls) {
                    if (control.type == 5) {
                        var o = calcFlatFormula(control.calculate.expression, rowControls);
                        control.value = o.value;
                        control.formula = o.formula;
                        control.calcType = o.type;
                        control.calculate.calculatedValue = o.calculatedValue;
                    }
                    if (control.type == 16) {
                        var regex = /\s*(sum|avg|var)\s*\(([^\)]+)\)\s*/gi;
                        var hasDurationFormat = false;
                        var r = control.calculate.expression.replace(regex, function(a, b, c) {
                            var array = [];
                            var firstField = c.replace(/.*\[(field-\d+)\].*/gi, "$1");
                            var rows = GetMultiRowControlBaseOnChildName(firstField);
                            if (!rows) {
                                return "از فیلدهای مربوط به فرم چند ردیفه باید استفاده شود";
                            }
                            _.each(rows.control.multiRowForm.rows, function(row) {
                                var o = calcFlatFormula(c, row);
                                if (o.type != "digit") {
                                    hasDurationFormat = true;
                                    array.push(o.calculatedValue || 0);
                                } else {
                                    array.push(o.value || 0);
                                }
                            });
                            var val = 0;
                            if (b === "sum") val = d3.sum(array);
                            if (b === "avg") val = d3.mean(array);
                            if (b === "var") val = d3.variance(array);
                            return " " + val + " ";
                        });
                        if (hasDurationFormat) {
                            var v = moment.duration(+eval(r)).format("d روز و h ساعت و m دقیقه");
                            control.value = v;
                            control.calculate.calculatedValue = +eval(r);
                            control.calcType = "millisecond";
                        } else {
                            try {
                                control.value = +eval(r).toFixed(5);
                                control.calculate.calculatedValue = +eval(r);
                            } catch (e) {
                                control.value = r;
                            }
                        }
                    }
                    if (control.type == 17) {
                        var forwatch = _.find(rowControls, {
                            name: control.tableLookup.controlName
                        });
                        if (!forwatch) {
                            model.value = null;
                            return;
                        }
                        var v = [];
                        if (forwatch.dropdown && forwatch.dropdown.listValue && forwatch.dropdown.listValue.length) v.concat(forwatch.dropdown.listValue); else if (forwatch.value) v.push(forwatch.value);
                        if (control.tableLookup.lastV && v.length == control.tableLookup.lastV.length && _.difference(v, control.tableLookup.lastV).length == 0) {
                            return;
                        }
                        control.tableLookup.lastV = v;
                        control.inProgress = true;
                        formsService.tableLookup(control.tableLookup, v).then(function(data) {
                            control.inProgress = false;
                            console.log("### data", data);
                            if (data && data.length) {
                                control.value = data[0].value;
                            }
                        });
                    }
                    if (control.useFilter && control.filters && control.filters.length) {
                        _.map(control.filters, function(filter) {
                            if (filter.type === 2) {
                                var cl = findControl(filter.control, $scope.data);
                                if (filter.controlValue !== cl.value) {
                                    filter.controlValue = cl.value;
                                }
                            }
                        });
                    }
                });
            }
            if (!$scope.rowId && $scope.id) {
                getFormEmptyData();
            }
            if ($scope.settings) {
                $scope.settings["notify"] = function(formId, rowId) {
                    $scope.rowId = rowId;
                    $scope.id = formId;
                    if (+$scope.id == 0) return;
                    $scope.allControl = null;
                    if (!$scope.rowId) getFormEmptyData(); else getFormData();
                };
            }
            $scope.colseBtn = function(e) {
                if (e.ctrlKey && e.keyCode == 13 || e.keyCode == 27) {
                    $scope.submitNewInfo();
                }
            };
        } ],
        restrict: "AE",
        templateUrl: app.urlPrefix + "dist/partial/forms/form-render.html?v=" + app.version
    };
});

ngApp.service("formsSubmitService", [ "$http", function($http) {
    var get = function(formId, rowId) {
        return $http.get(app.urlPrefix + "api/formsSubmit/getData/" + formId + "?rowId=" + rowId).then(function(res) {
            var data = res.data;
            return data;
        });
    };
    var control = {};
    control.CONTROL_TYPE_TEXT_SINGLE_LINE = 0;
    control.CONTROL_TYPE_TEXT_MULTI_LINE = 1;
    control.CONTROL_TYPE_NUMBER = 2;
    control.CONTROL_TYPE_TEXT_LABEL = 3;
    control.CONTROL_TYPE_DROP_DOWN = 4;
    control.CONTROL_TYPE_CALCULATE = 5;
    control.CONTROL_TYPE_CHECKBOX = 6;
    control.CONTROL_TYPE_MULTI_CHOISE = 7;
    control.CONTROL_TYPE_TIME = 8;
    control.CONTROL_TYPE_DATE = 9;
    control.CONTROL_TYPE_PHOTO = 10;
    control.CONTROL_TYPE_LINK = 11;
    control.CONTROL_TYPE_FORM_LOOKUP = 12;
    control.CONTROL_TYPE_MULTI_ROW = 13;
    control.CONTROL_TYPE_DATE_TIME = 14;
    control.CONTROL_TYPE_BUTTON = 15;
    control.CONTROL_TYPE_CALCULATE_SUM = 16;
    control.CONTROL_TYPE_FILE_ATTACHMENT = 19;
    function cleanObject(obj) {
        var valids = [ "canEdit", "canView", "columnClass", "label", "name", "type", "value", "listValue", "dropdown", "formLookup", "multiRowForm", "attachment", "button", "calculate", "filters" ];
        delete obj.tableLookup;
        if (obj.type != control.CONTROL_TYPE_DROP_DOWN) delete obj.dropdown;
        if (obj.type != control.CONTROL_TYPE_FORM_LOOKUP) delete obj.formLookup;
        if (obj.type != control.CONTROL_TYPE_MULTI_ROW) delete obj.multiRowForm;
        if (obj.type != control.CONTROL_TYPE_FILE_ATTACHMENT) delete obj.attachment;
        if (obj.type != control.CONTROL_TYPE_BUTTON) delete obj.button;
        if (obj.type != control.CONTROL_TYPE_CALCULATE && obj.type != control.CONTROL_TYPE_CALCULATE_SUM) delete obj.calculate;
        if (obj.type != control.CONTROL_TYPE_FORM_LOOKUP) delete obj.filters;
    }
    var submit = function(id, model) {
        return $http.post(app.urlPrefix + "api/formssubmit/submit/" + id, model).then(function(res) {
            app.moderation.dashboadpage.refreshRelatedDatasources(res.data.RefreshDatasource);
            return res.data;
        });
    };
    var remove = function(id, rowId) {
        return $http.post(app.urlPrefix + "api/formssubmit/delete/" + id, rowId).then(function(res) {
            app.moderation.dashboadpage.refreshRelatedDatasources(res.data.RefreshDatasource);
            return res.data;
        });
    };
    return {
        submit: submit,
        remove: remove,
        get: get
    };
} ]);

ngApp.directive("selectForm", function() {
    return {
        restrict: "E",
        replace: true,
        transclude: true,
        scope: {
            onSelect: "&",
            settings: "=?"
        },
        controller: [ "$scope", "$http", "formsService", function(scope, $http, formsService) {
            scope.model = scope.model || [];
            scope.settings = scope.settings || {};
            formsService.get().then(function(data) {
                scope.forms = data;
            });
            scope.opt = {
                closable: false,
                onApprove: function() {
                    if (!scope.model || !scope.model.length) {
                        alert("حداقل یک مورد باید انتخاب شود");
                        return false;
                    }
                    scope.onSelect({
                        forms: scope.model,
                        settings: scope.settings
                    });
                    return false;
                }
            };
        } ],
        template: '<div>                   <sm-modal visible="settings.visible" settings="opt">                        <div class="header">انتخاب فرم</div>                        <div class="content">                            <p>لطفا فرم‌های مورد نظر خود را انتخاب کنید</p>                            <div class="ui form">                                <div class="field">                                    <label>انتخاب فرم</label>                                    <sm-dropdown class="selection search multiple"  settings="{fullTextSearch: true}" model="model" items="forms" label="item.name" value="item" ></sm-dropdown>                                </div>                            </div>                        </div>                        <div class="actions">                            <div class="ui black deny button">لغو</div>                            <div class="ui positive button" ng-class="{loading: settings.loaging}" >اضافه کردن</div>                        </div>                    </sm-modal>                    </div>',
        link: function(scope, element, attributes) {}
    };
});

(function() {
    var ngApp = angular.module("sadafForms");
    ngApp.controller("fromGeneratorCtrl", [ "$scope", "$http", "$sce", "$timeout", "$mdToast", "$routeParams", "formsService", "controlPropertyService", "$translate", function($scope, $http, $sce, $timeout, $mdToast, $routeParams, formsService, controlPropertyService, $translate) {
        $scope.saveProgress = false;
        var c = this;
        c.id = $routeParams.id || 0;
        var isEdit = c.id > 0;
        c.app = app;
        c.items = [ {
            order: 1,
            columnClass: "four",
            key: "متن کوتاه",
            label: "نام",
            icon: "text cursor",
            type: 0,
            showUniqueProp: true,
            "default": true,
            require: true,
            regex: true,
            accessControlEdit: false,
            accessControlView: false,
            accessControlEditRoles: [],
            accessControlViewRoles: []
        }, {
            order: 2,
            columnClass: "four",
            key: "متن بلند",
            label: "متن بلند",
            icon: "text cursor",
            type: 1,
            showUniqueProp: true,
            "default": true,
            require: true,
            regex: true,
            accessControlEdit: false,
            accessControlView: false,
            accessControlEditRoles: [],
            accessControlViewRoles: []
        }, {
            order: 3,
            columnClass: "four",
            key: "عدد",
            label: "عدد",
            icon: "hashtag",
            type: 2,
            showUniqueProp: true,
            "default": true,
            require: true,
            regex: true,
            format: ",.0f",
            accessControlEdit: false,
            accessControlView: false,
            accessControlEditRoles: [],
            accessControlViewRoles: [],
            validations: {
                autoIncrementSeed: 1
            }
        }, {
            order: 4,
            columnClass: "four",
            key: "برچسب",
            label: "برچسب",
            icon: "font",
            type: 3,
            showUniqueProp: false,
            "default": false,
            require: false,
            accessControlEdit: false,
            accessControlView: false,
            accessControlEditRoles: [],
            accessControlViewRoles: []
        }, {
            order: 5,
            columnClass: "four",
            key: "چند گزینه",
            icon: "caret down",
            label: "چند گزینه",
            type: 4,
            showUniqueProp: true,
            "default": true,
            require: true,
            dropdown: {
                useRemoteData: false
            },
            accessControlEdit: false,
            accessControlView: false,
            accessControlEditRoles: [],
            accessControlViewRoles: []
        }, {
            order: 6,
            columnClass: "four",
            key: "چند گزینه ریموت",
            icon: "caret down",
            label: "چند گزینه ریموت",
            type: 4,
            showUniqueProp: true,
            "default": true,
            require: true,
            accessControlEdit: false,
            accessControlView: false,
            dropdown: {
                useRemoteData: true
            },
            accessControlEditRoles: [],
            accessControlViewRoles: []
        }, {
            columnClass: "four",
            key: "تایید",
            icon: "checkmark box",
            type: 6,
            label: "انتخاب مقدار",
            showUniqueProp: false,
            "default": true,
            require: false,
            accessControlEdit: false,
            accessControlView: false,
            accessControlEditRoles: [],
            accessControlViewRoles: [],
            order: 7
        }, {
            columnClass: "four",
            key: "زمان",
            icon: "wait",
            label: "زمان",
            type: 8,
            showUniqueProp: true,
            "default": true,
            require: true,
            accessControlEdit: false,
            accessControlView: false,
            accessControlEditRoles: [],
            accessControlViewRoles: [],
            order: 8
        }, {
            columnClass: "four",
            key: "تاریخ",
            label: "تاریخ",
            icon: "calendar",
            type: 9,
            showUniqueProp: true,
            "default": true,
            require: true,
            accessControlEdit: false,
            accessControlView: false,
            accessControlEditRoles: [],
            accessControlViewRoles: [],
            order: 9
        }, {
            columnClass: "eight",
            key: " زمان - تاریخ",
            label: " زمان - تاریخ",
            icon: "calendar",
            type: 14,
            showUniqueProp: true,
            "default": true,
            require: true,
            accessControlEdit: false,
            accessControlView: false,
            accessControlEditRoles: [],
            accessControlViewRoles: [],
            order: 9
        }, {
            columnClass: "four",
            key: "ارجاع به فرم",
            label: "ارجاع به فرم",
            icon: "pointing right",
            type: 12,
            formLookup: {
                form: -1,
                keyControls: [],
                showAddButton: true
            },
            showUniqueProp: true,
            "default": true,
            require: true,
            accessControlEdit: false,
            accessControlView: false,
            accessControlEditRoles: [],
            accessControlViewRoles: [],
            order: 10
        }, {
            columnClass: "twelve",
            key: "گروه تکرار شونده",
            label: "لیست",
            dontShowAccessControl: true,
            icon: "table",
            type: 13,
            showUniqueProp: false,
            "default": false,
            require: false,
            accessControlEdit: false,
            accessControlView: false,
            accessControlEditRoles: [],
            accessControlViewRoles: [],
            multiRowForm: {
                addKeyText: "ردیف جدید",
                rows: [ [] ],
                controlSize: "mini"
            },
            order: 11
        }, {
            columnClass: "four",
            key: "کلید",
            label: "کلید",
            icon: "square",
            type: 15,
            showUniqueProp: false,
            "default": false,
            require: false,
            button: {
                type: 1,
                openLinkType: 0,
                colorClass: "black",
                size: "tiny",
                tasks: [ {
                    type: 0,
                    openLinkType: 0
                } ]
            },
            accessControlEdit: false,
            accessControlView: false,
            accessControlEditRoles: [],
            accessControlViewRoles: [],
            order: 12
        }, {
            columnClass: "four",
            key: "محاسباتی",
            icon: "calculator",
            label: "فیلد محاسباتی",
            type: 5,
            showUniqueProp: false,
            "default": false,
            require: false,
            format: "#,#",
            calculate: {
                expression: ""
            },
            accessControlEdit: false,
            accessControlView: false,
            accessControlEditRoles: [],
            accessControlViewRoles: [],
            order: 13
        }, {
            columnClass: "four",
            key: "محاسباتی - جمع",
            label: "محاسباتی - جمع",
            icon: "calculator",
            type: 16,
            showUniqueProp: false,
            "default": false,
            require: false,
            format: "#,#",
            calculate: {
                expression: "",
                func: "sum"
            },
            accessControlEdit: false,
            accessControlView: false,
            accessControlEditRoles: [],
            accessControlViewRoles: [],
            order: 14
        }, {
            columnClass: "four",
            key: "اطلاعات اضافه ارجاع به فرم",
            label: "اطلاعات اضافه ارجاع به فرم",
            dontShowAccessControl: true,
            icon: "info",
            type: 17,
            showUniqueProp: false,
            "default": false,
            require: false,
            format: "#,#",
            accessControlEdit: false,
            accessControlView: false,
            accessControlEditRoles: [],
            accessControlViewRoles: [],
            tableLookup: {},
            order: 15
        }, {
            columnClass: "twelve",
            dontShowColumnSize: true,
            dontShowHide: true,
            dontShowAccessControl: true,
            key: "تیتر",
            label: "تیتر",
            icon: "heading",
            type: 18,
            showUniqueProp: false,
            "default": false,
            require: false,
            format: "#,#",
            accessControlEdit: false,
            accessControlView: false,
            accessControlEditRoles: [],
            accessControlViewRoles: [],
            order: 16
        }, {
            columnClass: "twelve",
            dontShowColumnSize: true,
            dontShowHide: true,
            dontShowAccessControl: true,
            key: "پیوست کردن فایل",
            label: "لیست فایل‌ها",
            icon: "file outline",
            type: 19,
            showUniqueProp: false,
            "default": false,
            require: true,
            format: "#,#",
            accessControlEdit: false,
            accessControlView: false,
            accessControlEditRoles: [],
            accessControlViewRoles: [],
            order: 17
        } ];
        $translate([ "short text", "long text", "number", "label", "combo", "remote combo", "checkbox", "time", "date", "date time", "refer to form", "iterator", "calculator", "calculator sum", "extra info", "header", "key", "file list" ]).then(function(msg) {
            function change(type, filter, key, label) {
                var item = _.find(c.items, filter == null ? {
                    type: type
                } : filter);
                item.key = key;
                item.label = label;
            }
            change(0, null, msg["short text"], msg["short text"]);
            change(1, null, msg["long text"], msg["long text"]);
            change(2, null, msg["number"], msg["number"]);
            change(3, null, msg["label"], msg["label"]);
            change(4, function(d) {
                return d.type == 4 && d.dropdown.useRemoteData == false;
            }, msg["combo"], msg["combo"]);
            change(4, function(d) {
                return d.type == 4 && d.dropdown.useRemoteData == true;
            }, msg["remote combo"], msg["remote combo"]);
            change(6, null, msg["checkbox"], msg["checkbox"]);
            change(8, null, msg["time"], msg["time"]);
            change(9, null, msg["date"], msg["date"]);
            change(14, null, msg["date time"], msg["date time"]);
            change(12, null, msg["refer to form"], msg["refer to form"]);
            change(13, null, msg["iterator"], msg["iterator"]);
            change(15, null, msg["key"], msg["key"]);
            change(5, null, msg["calculator"], msg["calculator"]);
            change(16, null, msg["calculator sum"], msg["calculator sum"]);
            change(17, null, msg["extra info"], msg["extra info"]);
            change(18, null, msg["header"], msg["header"]);
            change(19, null, msg["file list"], msg["file list"]);
        });
        c.publishFrom = function(publish) {
            c.publishProgress = true;
            formsService.publish(c.id, c.name, publish).then(function(data) {
                c.publishProgress = false;
                c.url = data.url;
                c.publish = data.publish;
            });
        };
        c.controlProperty = function(item) {
            if (!item) return {
                showUniqueProp: false,
                "default": false,
                require: false
            };
            return _.find(c.items, {
                type: item.type
            });
        };
        c.sortableOptions = {
            "ui-floating": true
        };
        c.compConf = {
            sort: false,
            group: {
                name: "form",
                pull: "clone",
                put: false
            },
            animation: 150,
            onEnd: function(ev) {
                ev.model.name = c.pages.naming.getName();
                ev.model.columnName = ev.model.name;
                ev.model.canView = true;
                ev.model.canEdit = true;
            }
        };
        c.checkColumnName = function(cntl, last) {
            var exist = false;
            runOnAllControll(c.pages.data, function(cl) {
                if (cl.name !== cntl.name && cl.columnName === cntl.columnName) {
                    exist = true;
                    return true;
                }
            });
            if (exist) {
                $translate("duplicate name").then(function(t) {
                    alert(t);
                });
                cntl.columnName = last;
                return;
            }
            if (currentTableColumns.indexOf(cntl.columnName) != -1) {
                cntl.columnName = last;
                $translate("duplicate name").then(function(t) {
                    alert(t);
                });
            }
        };
        c.drags = c.items.map(function(d) {
            return [ d ];
        });
        var dangerChangeOccured = false;
        c.draggableOptions = {
            connectWith: ".drop-target",
            placeholder: "form-control-highlight",
            helper: "clone",
            stop: function(e, ui) {
                if (ui.item.sortable.source.hasClass("draggable-element") && ui.item.sortable.droptarget && ui.item.sortable.droptarget != ui.item.sortable.source && ui.item.sortable.droptarget.hasClass("drop-target")) {
                    var item = ui.item.sortable.droptargetModel[ui.item.sortable.dropindex];
                    item = _.merge({}, item);
                    item.name = c.pages.naming.getName();
                    item.columnClass = item.columnClass || "twelve";
                    item.formLookup = _.extend({}, ui.item.sortable.model.formLookup);
                    item.dropdown = _.extend({}, ui.item.sortable.model.dropdown);
                    item.canView = true;
                    item.canEdit = true;
                    var ext = JSON.parse(JSON.stringify(ui.item.sortable.model));
                    ui.item.sortable.sourceModel.push(ext);
                }
            }
        };
        c.control = controlPropertyService.get();
        c.formLookupSourceFields = [];
        $scope.$watch("c.control.active.formLookup", function(fl) {
            if (!fl || !fl.form) return;
            getFormLookupFields(fl, formsService);
        });
        c.pages = {
            data: [],
            add: function(index) {
                var page = {
                    name: app.lang.translate("page") + " " + (c.pages.data.length + 1),
                    type: 0,
                    controls: [],
                    rowValidation: {
                        uniqueMultiField: false,
                        uniques: []
                    },
                    size: "tiny"
                };
                c.pages.data.push(page);
                c.pages.setActive(page);
            },
            removeControl: function(i, control) {
                var t = app.lang.translate("delete control message");
                var f = confirm(t);
                if (f) {
                    dangerChangeOccured = true;
                    c.pages.activePage.controls.splice(i, 1);
                }
            },
            copy: function(i, control) {
                dangerChangeOccured = true;
                var clone = _.extend({}, control);
                c.pages.activePage.controls.splice(i, 0, clone);
            },
            remove: function(index) {
                if (!c.pages) return;
                var f = true;
                if (c.pages.data[index].controls.length) f = confirm("delete page message");
                if (f) {
                    if (c.pages.data[index].controls.length) dangerChangeOccured = true;
                    var removed = c.pages.data.splice(index, 1);
                    if (removed[0] === c.pages.activePage) {
                        c.pages.setActive();
                    }
                }
            },
            setActive: function(page) {
                _.each(c.pages.data, function(p) {
                    p.active = false;
                });
                if (!page && c.pages.data.length) {
                    page = c.pages.data[0];
                }
                c.pages.activePage = page;
                c.pages.activePage.active = true;
                if (c.control.active) {
                    c.control.active.isActive = false;
                    c.control.active = null;
                }
            },
            getControlForRowValidation: function() {
                var cnts = c.pages.activePage.controls;
                return cnts;
            },
            naming: {
                getName: function() {
                    return "field-" + c.pages.naming.getMaxId();
                },
                exist: function(name) {
                    if (name == "_id") return true;
                    var flag = false;
                    _.each(c.pages.data, function(page) {
                        _.each(page.controls, function(cnt) {
                            var id = cnt.name || "";
                            if (id == name) {
                                flag = true;
                                return false;
                            }
                        });
                    });
                    return flag;
                },
                getMaxId: function() {
                    c.maxFieldNumber = +c.maxFieldNumber || 0;
                    c.maxFieldNumber++;
                    return c.maxFieldNumber;
                }
            }
        };
        c.controlList = [];
        $scope.$watch("c.pages", function() {
            c.controlList = [];
            runOnAllControll(c.pages.data, function(cnt) {
                if (cnt.type != 13) {
                    c.controlList.push(cnt);
                }
            });
        }, true);
        c.saveProgress = false;
        c.save = function() {
            var flag = false;
            if (dangerChangeOccured) {
                flag = confirm("edit form message‌");
            } else {
                flag = true;
            }
            if (flag) {
                dangerChangeOccured = false;
                c.saveProgress = true;
                formsService.save(c.id, {
                    pages: c.pages.data,
                    name: c.name,
                    maxFieldNumber: c.maxFieldNumber,
                    triggers: c.triggers,
                    showSubmitedInfo: c.showSubmitedInfo
                }).then(function onSave(id) {
                    c.saveProgress = false;
                    c.id = id;
                    location.replace(app.hashUrlPrefix + "#/forms/" + id);
                    setCurrentTableColumns();
                    var toast = $mdToast.simple().textContent(app.lang.translate("saving successfully"));
                    $mdToast.show(toast);
                }, function onError(res) {
                    c.saveProgress = false;
                    var msg = app.lang.translate("error in saving");
                    if (res.data.desc) {
                        msg = res.data.desc;
                    }
                    showErrorToast(msg, $mdToast);
                });
            }
        };
        if (!isEdit) {
            c.name = app.lang.translate("new form");
            c.showSubmitedInfo = true;
            c.pages.add();
        }
        var currentTableColumns = [];
        function setCurrentTableColumns() {
            currentTableColumns = [];
            runOnAllControll(c.pages.data, function(cl) {
                currentTableColumns.push(cl.columnName);
            });
        }
        if (isEdit) {
            formsService.get(c.id, true).then(function(data) {
                c.pages.data = data.model.pages;
                c.name = data.model.name;
                c.showSubmitedInfo = data.model.showSubmitedInfo;
                c.triggers = data.model.triggers;
                c.url = data.url;
                c.publish = data.publish;
                c.maxFieldNumber = data.model.maxFieldNumber;
                c.pages.setActive();
                setCurrentTableColumns();
                runOnAllControll(c.pages.data, function(cnt) {
                    if (cnt.dropdown && cnt.dropdown.items) {
                        cnt.dropdown.itemsTemp = cnt.dropdown.items.map(function(d) {
                            return d.label;
                        }).join("\n");
                    }
                });
            });
        }
        c.getSiblingControl = function(name) {
            var row = {};
            runOnAllControll(c.pages.data, function(cnt, parentRow) {
                if (name === cnt.name) {
                    row.row = parentRow;
                    row.index = _.findIndex(parentRow, {
                        name: name
                    });
                }
            });
            return row;
        };
        $scope.$watch("c.control.active", function(n) {
            if (n && n.name) {
                c.activeSibling = c.getSiblingControl(n.name);
                c.activeSibling.rootControls = [];
                _.each(c.pages.data, function(page) {
                    _.each(page.controls, function(cont) {
                        c.activeSibling.rootControls.push(cont);
                    });
                });
            }
        });
    } ]);
    ngApp.directive("formControl", [ "$compile", function($compile) {
        return {
            restrict: "E",
            replace: true,
            transclude: true,
            scope: {
                model: "=ngModel",
                settingsClick: "&?",
                remove: "&?",
                id: "@",
                edit: "@",
                settings: "=?",
                copy: "&?",
                sdSubmit: "&"
            },
            controller: [ "$scope", "$translate", "$timeout", "$http", "taskExecutor", function($scope, $translate, $timeout, $http, taskExecutor) {
                $scope._ = _;
                $scope.randomId = Math.floor(Math.random() * 1e5) + 1;
                $scope.model.randomId = $scope.randomId;
                $scope.$watch("model.value", function(n) {
                    if (n == null) {
                        $(".form-" + $scope.randomId + " .dropdown").dropdown("clear");
                    }
                });
                $scope.simpleDropdownsettings = {
                    message: {
                        noResults: app.lang.translate("No results found.")
                    },
                    fullTextSearch: true,
                    forceSelection: false
                };
                $scope.$watch("model.dropdown.listValue", function(n) {
                    if (n == null) {
                        $(".form-" + $scope.randomId + " .dropdown").dropdown("clear");
                    }
                });
                if ($scope.model.dropdown && $scope.model.dropdown.multiSelectDropdown && $scope.model.dropdown.useRemoteData) {
                    $scope.model.items = $scope.model.dropdown.listValue;
                }
                $scope.initDropdown = function($dropdown) {
                    if ($scope.model.dropdown && $scope.model.dropdown.multiSelectDropdown && $scope.model.dropdown.useRemoteData) {
                        $timeout(function() {
                            $($dropdown).dropdown("set selected", $scope.model.dropdown.listValue);
                        }, 100);
                    }
                };
                $scope.buttonClick = function() {
                    if ($scope.edit) return;
                    _.each($scope.model.button.tasks, function(t) {
                        taskExecutor.exec(t, $scope.$parent.$parent.$parent.data, $scope);
                    });
                };
                $scope.getFilteredDropdonItems = function(value, index, array) {
                    if (!$scope.model.useFilter || !$scope.model.filters) return false;
                    var flag = false;
                    _.each($scope.model.filters, function(filter) {
                        if (!filter || !filter.staticValue || !value || !value.value) return false;
                        if (filter.type == 1) {
                            flag = filter.staticValue.trim().indexOf(value.value.trim()) != -1 || value.value.trim().indexOf(filter.staticValue.trim()) != -1;
                            return false;
                        }
                    });
                    return flag;
                };
                if ($scope.model.type === 12) {
                    $scope.model.formDialogInfo = {
                        formInfo: {
                            form: $scope.model.formLookup.form
                        },
                        showModal: false
                    };
                    $scope.showFormInModal = function() {
                        $scope.model.formDialogInfo.showModalFunc();
                    };
                }
                $scope.keyup = function(e) {
                    if (!e) return;
                    if (e.ctrlKey && e.keyCode == 13) {
                        $scope.sdSubmit();
                    }
                };
            } ],
            templateUrl: app.urlPrefix + "dist/partial/forms/editor/form-generator-control.directive.html?v=" + app.version
        };
    } ]);
    ngApp.directive("multiRowForm", [ "$compile", function($compile) {
        return {
            restrict: "E",
            replace: true,
            transclude: true,
            scope: {
                model: "=ngModel",
                settings: "=?",
                id: "@",
                edit: "@"
            },
            controller: [ "$scope", "$http", "formsService", "controlPropertyService", "$timeout", function(scope, $http, formsService, controlPropertyService, $timeout) {
                scope.model = scope.model || {};
                scope.firstRow = scope.model.multiRowForm.rows[0];
                scope.$watch("firstRow", function() {
                    _.each(scope.firstRow, function(cnt) {
                        cnt.childOfMultiRow = true;
                    });
                }, true);
                scope.sortableOptions = {
                    placeholder: "form-control-highlight",
                    handle: ".drag-handle"
                };
                scope.control = controlPropertyService.get();
                scope.setProp = function(c) {
                    scope.control.setActive(c);
                };
                scope.remove = function(c, index) {
                    var f = confirm(app.lang.translate("delete control message"));
                    if (f) {
                        scope.model.multiRowForm.rows[0].splice(index, 1);
                    }
                };
                var autoIncMap = {};
                scope.addRow = function() {
                    if (scope.edit) return;
                    var a = [];
                    _.each(scope.model.multiRowForm.rows[0], function(item) {
                        var nItem = JSON.parse(JSON.stringify(item));
                        nItem.rowId = 0;
                        if (nItem && nItem.type == 2 && nItem.validations && nItem.validations.autoIncrement) {
                            autoIncMap[nItem.name] = (autoIncMap[nItem.name] || +nItem.value) + 1;
                            nItem.value = autoIncMap[nItem.name];
                            return;
                        }
                        nItem.value = null;
                        if (nItem.dropdown) nItem.dropdown.listValue = null;
                        a.push(nItem);
                    });
                    scope.model.multiRowForm.rows.push(a);
                };
                scope.removeRow = function(row, i) {
                    var r = row.splice(i, 1);
                    scope.model.multiRowForm.deletedIds = scope.model.multiRowForm.deletedIds || [];
                    scope.model.multiRowForm.deletedIds.push(r[0][0].rowId);
                };
            } ],
            template: '<div class="ui form field" ng-class="model.multiRowForm.controlSize">                            <div class="ui secondary pointing tiny menu">                                <div class="active item">{{model.label}} </div>                                <div class="ui right item" ng-hide="model.readonly">                                    <div class="pointer" ng-click="addRow()">{{model.multiRowForm.addKeyText}}<i class="icon plus square outline large"></i></div>                                </div>                            </div>                                <div ng-hide="model.multiRowForm.rows[0].length || !edit" class="gray center aligned twelve wide column"><small>{{\'drag control here\' | translate}}</small></div>                            <div class="ui grid content-form multi-row-container" >                            </div>                       </div>',
            link: function(scope, element, attributes) {
                function columnClass() {
                    scope.model.multiRowForm.columns = scope.model.multiRowForm.columns || 3;
                    var column = scope.model.multiRowForm.columns == 1 ? "one" : scope.model.multiRowForm.columns == 2 ? "two" : scope.model.multiRowForm.columns == 3 ? "three" : scope.model.multiRowForm.columns == 4 ? "four" : scope.model.multiRowForm.columns == 5 ? "five" : scope.model.multiRowForm.columns == 6 ? "six" : "eight";
                    return column;
                }
                scope.$watch("model.multiRowForm.columns", function(newValue, oldValue) {
                    refresh();
                });
                function refresh() {
                    var controls;
                    if (scope.edit) {
                        controls = angular.element('<div class="drop-target doubling ' + columnClass() + ' column row {{model.multiRowForm.separator? \'separator\':\'\'}}" xui-sortable="sortableOptions"  xng-model="model.multiRowForm.rows[0]"                                                         ng-sortable="{group: {name: \'form\', pull:true, put:true}, animation:150}" style="min-height:100px;">                                                                                                        <div class="column"                                                              ng-repeat="component in model.multiRowForm.rows[0] track by $index"                                                             ng-click="setProp(component);$event.stopPropagation();">                                                                <form-control ng-class="{active: component.isActive}" class="column" remove="remove(component, $index)" edit="true" ng-model="component" id="{{id}}" settings="{fromMultiRow:true}"></form-control>                                                    </div>                                                </div>');
                    } else {
                        controls = angular.element('<div ng-repeat="row in model.multiRowForm.rows" class="doubling ' + columnClass() + ' column row no-padding {{model.multiRowForm.separator? \'separator\':\'\'}}">                                                    <div class="column no-padding"                                                          ng-repeat="component in row track by $index">                                                            <div class="ui grid" ng-if="!edit && model.multiRowForm.rows.length > 1 && $last" style="margin:0;">                                                                <form-control class="ten wide column field" remove="remove(component, $index)" ng-model="component" id="{{id}}"  settings="{showLabel:$parent.$parent.$index == 0, fromMultiRow:true}"></form-control>                                                                <div class="two wide column field" ng-hide="model.readonly" >                                                                    <label ng-show="$parent.$parent.$index == 0">&nbsp;</label>                                                                    <div class="ui icon mini xbutton pointer gray" ng-click="removeRow(model.multiRowForm.rows, $parent.$parent.$index)"><i class="icon remove"></i></div>                                                                </div>                                                            </div>                                                            <form-control ng-if="edit || model.multiRowForm.rows.length == 1 || !$last" class="column" remove="remove(component, $index)" ng-model="component" id="{{id}}" settings="{showLabel:$parent.$parent.$index == 0, fromMultiRow:true}"></form-control>                                                    </div>                                                </div>');
                    }
                    $compile(controls)(scope);
                    angular.element(element[0].querySelector(".content-form")).html(controls);
                }
            }
        };
    } ]);
    ngApp.directive("newFormModal", [ "$compile", "$timeout", function($compile, $timeout) {
        return {
            restrict: "E",
            replace: true,
            transclude: true,
            scope: {
                model: "=ngModel",
                show: "=?"
            },
            template: '<div>                            <div class="xcontent" ></div>                       </div>',
            link: function(scope, element, attributes) {
                scope.hideModal = function(data) {
                    scope.model.showModal = false;
                    $(".id" + scope.id).modal("hide");
                };
                scope.saveFinish = function(data) {
                    debugger;
                };
                scope.option = {
                    showCancel: true,
                    allowMultiple: true,
                    autofocus: false
                };
                scope.formSettings = {
                    modal: true
                };
                function showModal() {
                    if (!scope.id) {
                        scope.id = Math.floor(Math.random() * 999999) + 1e6;
                        $($(element).find(".modal")[0]).addClass("id" + scope.id);
                    }
                    scope.modal = $(".id" + scope.id).modal(scope.option);
                    if ($(".ui.modal.active").length > 0) {
                        $(".id" + scope.id + ".modal").css("position", "fixed");
                        $(".id" + scope.id).modal("show");
                    } else {
                        $(".id" + scope.id + ".modal").css("position", "initial");
                        $(".id" + scope.id).modal("show");
                    }
                }
                scope.model.showModalFunc = showModal;
                function compile() {
                    var controls = angular.element('<div xng-if="openFormTask" sadaf-form id="{{model.formInfo.form}}" on-finish="hideModal()" on-save="saveFinish(data)" option="{showCancel:true}" settings="formSettings" on-cancel="hideModal()"></div>                                                    </div>');
                    $compile(controls)(scope);
                    angular.element(element[0].querySelector(".xcontent")).html(controls);
                }
                compile();
            }
        };
    } ]);
    ngApp.directive("formLookupProperty", function() {
        return {
            restrict: "E",
            replace: true,
            transclude: true,
            scope: {
                model: "=ngModel",
                settings: "=?"
            },
            controller: [ "$scope", "$http", "formsService", function(scope, $http, formsService) {
                scope.model = scope.model || {};
                scope.settings = angular.merge({
                    selectableColumns: true
                }, scope.settings || {});
                formsService.get().then(function(data) {
                    scope.forms = data;
                });
                scope.$watch("model.form", function(n) {
                    if (n == -1) {
                        scope.model.form = scope.forms[0].id;
                    }
                    if (!n) return;
                    formsService.get(n).then(function(data) {
                        scope.formControls = [];
                        _.each(data.model.pages, function(page) {
                            _.each(page.controls, function(cnt) {
                                scope.formControls.push(cnt);
                            });
                        });
                        if (scope.model.keyControls) {
                            var validKeys = _.map(scope.formControls, "columnName");
                            scope.model.keyControls = _.intersection(validKeys, scope.model.keyControls);
                        }
                    });
                });
            } ],
            template: ' <div class="field">                        <div class="field">                            <label>{{\'select form\' | translate}}</label>                            <sm-dropdown class="selection search fluid"  settings="{fullTextSearch: true, forceSelection: false}" model="model.form" items="forms" label="item.name" value="item.id" ></sm-dropdown>                        </div>                        <div class="field" ng-show=settings.selectableColumns>                            <label>{{\'key columns\' | translate}}</label>                            <sm-dropdown class="selection search multiple fluid" settings="{fullTextSearch: true, forceSelection: false}" model="model.keyControls" items="formControls" label="item.label" value="item.name" ></sm-dropdown>                        </div>                    </div>',
            link: function(scope, element, attributes) {}
        };
    });
    ngApp.directive("formLookupGetId", function() {
        return {
            restrict: "E",
            replace: true,
            transclude: true,
            scope: {
                model: "=ngModel",
                id: "@"
            },
            controller: [ "$scope", "$http", "formsService", "$timeout", function($scope, $http, formsService, $timeout) {
                $scope.model.formLookup = $scope.model.formLookup || {};
                var dropdownSettings = function(name) {
                    return {
                        apiSettings: {
                            url: app.urlPrefix + "api/forms/getFormColumnData",
                            cache: false,
                            method: "get",
                            dataType: "json",
                            beforeSend: function(s) {
                                s.data = {
                                    id: $scope.model.formLookup.form,
                                    name: name,
                                    query: s.urlData.query,
                                    others: $scope.keys.map(function(k) {
                                        return {
                                            label: k.name,
                                            value: k.value
                                        };
                                    }),
                                    filters: $scope.model.useFilter ? $scope.model.filters : []
                                };
                                return s;
                            },
                            onResponse: function(res) {
                                res.fields = res.fields.map(function(d) {
                                    return {
                                        value: d.value,
                                        label: d.label
                                    };
                                });
                                return res;
                            }
                        },
                        message: {
                            noResults: app.lang.translate("No results found.")
                        },
                        fields: {
                            remoteValues: "fields",
                            name: "label",
                            value: "value"
                        },
                        saveRemoteData: false,
                        fullTextSearch: true,
                        forceSelection: false
                    };
                };
                function calcKeys() {
                    $scope.model.formLookup.keyControls = $scope.model.formLookup.keyControls || [];
                    $scope.keys = $scope.model.formLookup.keyControls.map(function(d) {
                        var t = {
                            name: d,
                            dropdownSettings: dropdownSettings(d),
                            change: function(val) {
                                if (t.value === val) return;
                                t.value = val;
                                getIds();
                            },
                            defaultText: $scope.model.label
                        };
                        return t;
                    });
                }
                function bindValue() {
                    if ($scope.model.formLookup.keyControlsBindedValue && $scope.keys) {
                        for (var i = 0; i < $scope.model.formLookup.keyControlsBindedValue.length; i++) {
                            var v = $scope.model.formLookup.keyControlsBindedValue[i];
                            if ($scope.model.value != null) {
                                $scope.keys[i].defaultText = v;
                                $scope.keys[i].boldText = true;
                            }
                        }
                    }
                }
                function updateFilter() {
                    if ($scope.model.useFilter && $scope.model.filters.length) {
                        _.map($scope.model.filters, function(filter) {});
                    }
                }
                $scope.$watch("model.formLookup.keyControlsBindedValue", function(n) {
                    bindValue();
                }, true);
                $scope.$watch("model.filters", function(n) {
                    updateFilter();
                }, true);
                $scope.$watch("model.formLookup.keyControls", function(n) {
                    calcKeys();
                    bindValue();
                }, true);
                function clear() {
                    $(".form-" + $scope.model.randomId + " .dropdown").dropdown("clear");
                }
                var init = false;
                var needClear = false;
                $scope.$watch("model.value", function(v) {
                    var t = $scope.model;
                    if (v == null) {
                        needClear = true;
                        clear();
                    }
                });
                $scope.init = function(e) {
                    init = true;
                    if (needClear) {
                        clear();
                    }
                };
                $scope.model.isValid = true;
                function getIds() {
                    var vals = $scope.keys.map(function(k) {
                        return {
                            label: k.name,
                            value: k.value
                        };
                    });
                    $scope.model.formLookup.selected = _.map(vals, function(d) {
                        return d.value;
                    });
                    var someNull = _.some(vals, function(d) {
                        return _.isUndefined(d.value) || d.value == null;
                    });
                    if (someNull) return;
                    if ($scope.model.filters && $scope.model.filters.length) {
                        vals = vals || [];
                        var filter1 = $scope.model.filters.map(function(k) {
                            return {
                                label: k.sourceField,
                                value: k.type == 2 ? k.controlValue : k.staticValue
                            };
                        });
                        vals = vals.concat(filter1);
                    }
                    $scope.model.isValid = false;
                    $http.post(app.urlPrefix + "api/forms/getFormLookupIds/" + $scope.model.formLookup.form, vals).then(function(d) {
                        $scope.model.isValid = true;
                        if (_.isArray(d.data) && d.data.length) {
                            $scope.model.value = d.data[0];
                        }
                    });
                }
            } ],
            template: ' <div class="">                        <div class="xfield" ng-repeat="f in keys">                            <sm-dropdown settings="f.dropdownSettings" on-init="init"ng-class="{\'bold-text\':f.boldText}" class="selection search {{f.name}} fluid" label="item.label" on-change="f.change" value="item.value" default-text="f.defaultText" ></sm-dropdown>                        </div>                    </div>'
        };
    });
    ngApp.directive("selectMenu", function() {
        return {
            restrict: "E",
            replace: true,
            transclude: true,
            scope: {
                model: "=ngModel",
                multiple: "@?"
            },
            controller: [ "$scope", "$http", "$timeout", function($scope, $http, $timeout) {
                $http.get(app.urlPrefix + "api/menus/get").then(function(res) {
                    $scope.menus = res.data;
                });
            } ],
            template: '<div><sm-dropdown style="width:100%;"items="menus" model="model" class="selection search {{multiple}}" settings="{forceSelection: false}" label="item.name" value="item.id" ></sm-dropdown></div>'
        };
    });
    ngApp.directive("selectDatasourceColumns", function() {
        return {
            restrict: "E",
            replace: true,
            transclude: true,
            scope: {
                model: "=ngModel"
            },
            controller: [ "$scope", "$http", "datasources", function(scope, $http, datasources) {
                scope.select = function() {
                    datasources.select(null, {
                        type: [ "datasources" ]
                    }).then(function(res) {
                        if (res.selected && res.selected.length) {
                            scope.model.remoteDatasource = {
                                value: res.selected[0].id,
                                label: res.selected[0].name
                            };
                            getColumn();
                            scope.model.remoteColumnKey = null;
                            scope.model.remoteColumnLabel = null;
                        }
                    });
                };
                scope.model = scope.model || {};
                function getColumn() {
                    datasources.getColumns(scope.model.remoteDatasource.value).then(function(data) {
                        scope.model.datasourceColumns = data.CubeInfo.Dimensions[0].Hierarchies;
                        scope.model.userProperties = data.UsersProperty;
                    });
                }
                scope.$watch("model", function(n) {
                    if (n) {
                        getColumn();
                    }
                });
            } ],
            template: ' <div class="ui form">                        <div class="field">                            <label>{{\'انتخاب منبع داده\'| translate}}</label>                            <button class="ui tiny button" ng-click="select()">                                <span ng-show="!model.remoteDatasource">{{\'select\'| translate}}</span>                                <span ng-show="model.remoteDatasource">{{model.remoteDatasource.label}}</span>                            </button>                        </div>                        <div class="field" ng-show="model.datasourceColumns">                            <label>{{\'value column\'| translate}}</label>                            <sm-dropdown class="selection search fluid" settings="{fullTextSearch: true}" model="model.remoteColumnKey" items="model.datasourceColumns" label="item.Name" value="item.Name" ></sm-dropdown>                        </div>                        <div class="field" ng-show="model.datasourceColumns">                            <label>{{\'label column\'| translate}}</label>                            <sm-dropdown class="selection search fluid" settings="{fullTextSearch: true}" model="model.remoteColumnLabel" items="model.datasourceColumns" label="item.Name" value="item.Name" ></sm-dropdown>                        </div>                    </div>',
            link: function(scope, element, attributes) {}
        };
    });
    ngApp.controller("fromsCtrl", [ "$scope", "$http", "$sce", "$timeout", "$mdToast", "$routeParams", "formsService", "$mdDialog", "utils", "$translate", function($scope, $http, $sce, $timeout, $mdToast, $routeParams, formsService, $mdDialog, utils, $translate) {
        var c = this;
        c.progress = true;
        c.app = app;
        c.utils = utils;
        formsService.get().then(function(data) {
            c.progress = false;
            c.data = data;
            c.formsModule = formsService.getFormsModule();
            c.securityCertPatch = formsService.securityCertPatch();
        });
        c.delete = function(ev, row, i) {
            $translate([ "remove", "remove_form_desc", "cancel" ]).then(function(msg) {
                var confirm = $mdDialog.confirm().title(msg["remove"]).textContent(msg["remove_form_desc"] + " " + row.name).ariaLabel(msg["remove"]).targetEvent(ev).ok(msg["remove"]).cancel(msg["cancel"]);
                $mdDialog.show(confirm).then(function() {
                    formsService.remove(row.id).then(function(res) {
                        var d = c.data.splice(i, 1);
                        var toast = $mdToast.simple().textContent("فرم " + d[0].name + " با موفقیت حذف شد");
                        $mdToast.show(toast);
                    });
                });
            });
        };
    } ]);
    ngApp.directive("sadafDropdwon", [ "$compile", "$timeout", function($compile, $timeout) {
        return {
            restrict: "E",
            replace: true,
            transclude: true,
            scope: {
                model: "=ngModel",
                formId: "@",
                edit: "@?"
            },
            controller: [ "$scope", "$http", "formsService", "controlPropertyService", function(scope, $http, formsService, controlPropertyService) {} ],
            template: "<div></div>",
            link: function($scope, element, attributes) {
                var isMulti = $(element).hasClass("multiple");
                var opts = isMulti ? $scope.model.dropdown.listValue || [] : [ $scope.model.value || "" ];
                var select = '<select class="temporal ui fluid ' + (isMulti ? "multiple" : "") + ' search selection dropdown" ' + (isMulti ? "multiple" : "") + " >";
                for (var i = 0; i < opts.length; i++) select += '  <option value="' + opts[i] + '">' + opts[i] + "</option>";
                select += "</select>";
                select = $(select);
                var lastT;
                function updateValue() {
                    clearTimeout(lastT);
                    lastT = setTimeout(function() {
                        var value = $(".form-" + $scope.model.randomId + " .ui.dropdown").dropdown("get value");
                        var texts = _.map($(".form-" + $scope.model.randomId + " .ui.dropdown").dropdown("get item"), function(e) {
                            return $(e).text();
                        });
                        if (!_.isArray(value)) value = [ value ];
                        value = _.filter(value, null);
                        $timeout(function() {
                            $scope.model.dropdown.listValue = value;
                            $scope.model.dropdown.selected = texts;
                        }, 0);
                    }, 200);
                }
                var dropdownSettings = {
                    onChange: function(value, text, $selectedItem) {
                        if (!isMulti) {
                            $timeout(function() {
                                $scope.model.dropdown.selected = [ text ];
                                $scope.model.value = value;
                            }, 0);
                        }
                    },
                    onRemove: function(removedValue, removedText, $removedChoice) {
                        updateValue();
                    },
                    onAdd: function(addedValue, addedText, $addedChoice) {
                        updateValue();
                    },
                    apiSettings: {
                        url: app.urlPrefix + "api/forms/getdropdowndata",
                        cache: false,
                        method: "get",
                        dataType: "json",
                        beforeSend: function(s) {
                            s.data = {
                                id: $scope.formId,
                                name: $scope.model.name,
                                query: s.urlData.query,
                                filters: $scope.model.useFilter ? $scope.model.filters : []
                            };
                            if ($scope.edit) {
                                s.data = {
                                    datasourceId: $scope.model.dropdown.remoteDatasource.value,
                                    remoteColumnKey: $scope.model.dropdown.remoteColumnKey,
                                    remoteColumnLabel: $scope.model.dropdown.remoteColumnLabel,
                                    query: s.urlData.query
                                };
                            }
                            return s;
                        },
                        onResponse: function(res) {
                            res.fields = res.fields.map(function(d) {
                                return {
                                    value: d.value.entitize(),
                                    label: d.label.entitize()
                                };
                            });
                            return res;
                        }
                    },
                    message: {
                        noResults: app.lang.translate("No results found.")
                    },
                    fields: {
                        remoteValues: "fields",
                        name: "label",
                        value: "value"
                    },
                    saveRemoteData: false,
                    fullTextSearch: true,
                    forceSelection: false
                };
                $(element).append(select);
                $(select).dropdown(dropdownSettings);
                if ($scope.model.dropdown.listValue) {
                    var v = $scope.model.dropdown.multiSelectDropdown ? $scope.model.dropdown.listValue : $scope.model.value;
                    if (v != null) $(select).dropdown("set selected", v);
                }
            }
        };
    } ]);
    ngApp.directive("controlSize", [ "$compile", "$timeout", function($compile, $timeout) {
        return {
            restrict: "E",
            transclude: true,
            scope: {
                model: "=ngModel"
            },
            template: "<sm-dropdown items=\"[{label:('خیلی کوچک' | translate), value:'mini'}, {label:('کوچک' | translate), value:'tiny'}, {label:('normal' | translate), value:''}]\" model=\"model\" label=\"item.label\" value=\"item.value\"></sm-dropdown> "
        };
    } ]);
    ngApp.filter("formatNumber", function() {
        return function(s, format) {
            var f = format;
            if (isNaN(s)) return s;
            return f ? d3.format(f)(s) : s;
        };
    });
    ngApp.filter("persian", function() {
        return function(s) {
            if (app.lang && +app.lang.langType == 0) {
                return persian(s, true);
            }
            return s;
        };
    });
    ngApp.directive("sadafCheckbox", [ "$compile", "$timeout", function($compile, $timeout) {
        return {
            restrict: "E",
            transclude: true,
            replace: true,
            scope: {
                model: "=ngModel",
                change: "&?ngChange"
            },
            template: '<div class="ui checkbox"><input type="checkbox" ng-model="model" /><label ng-transclude></label></div>',
            link: function(scope, element, attr) {
                if (scope.model === true || scope.model && scope.model.match(/(true)/gi)) scope.model = true; else scope.model = false;
                $(element).checkbox({
                    onChange: function(d, u) {
                        $timeout(function() {
                            scope.model = $(element).find("input").is(":checked");
                            if (scope.change) scope.change();
                        });
                    }
                });
            }
        };
    } ]);
    ngApp.directive("filterProperty", [ "$compile", "$timeout", function($compile, $timeout) {
        return {
            restrict: "E",
            transclude: true,
            replace: true,
            scope: {
                model: "=ngModel",
                controls: "=",
                sourceFields: "=?",
                name: "=?",
                justValue: "@?"
            },
            controller: [ "$scope", function(scope) {
                scope.justValue = JSON.parse(scope.justValue || "false");
                var empty = {
                    type: 2
                };
                scope.add = function() {
                    scope.model.push(_.extend({}, empty));
                };
                scope.$watch("model", function(m) {
                    if (!m) {
                        scope.model = scope.model || [ empty ];
                    }
                });
                scope.$watch("sourceFields", function(m) {
                    if (m && scope.justValue) {
                        _.each(m, function(item) {
                            item.label = item.Name;
                            item.name = item.UniqueName;
                        });
                    }
                });
                scope.$watch("controls", function(m) {
                    if (!m) return;
                    scope.cnts = [];
                    scope.cnts = scope.cnts.concat(m.row);
                    scope.cnts = scope.cnts.concat(m.rootControls);
                    var filter = scope.justValue ? {
                        type: 4
                    } : {
                        type: 12
                    };
                    scope.cnts = _.filter(scope.cnts, filter);
                    scope.cnts = _.filter(scope.cnts, function(d) {
                        return d.name !== scope.name;
                    });
                    scope.cnts = _.uniqBy(scope.cnts, "name");
                });
            } ],
            template: '<div class="inner-section">                          <div class="field" ng-repeat="f in model track by $index">                            <div class="inline fields" >                                <label class="three wide field">{{\'type\' | translate}}</label>                                <div class="six wide field" >                                    <sm-dropdown model="f.type" class="" settings="{fullTextSearch: true, forceSelection: false}" items="[{type: 1, name:(\'fix value\' | translate)},{type: 2, name:(\'control value\' | translate)}]" label="item.name" value="item.type"></sm-dropdown>                                </div>                                <div class="three wide field">                                    <i class="gray pointer icon plus" ng-click="add()"></i>                                    <i class="gray pointer icon delete" ng-click="model.splice($index, 1)" ng-hide="model.length==1"></i>                                </div>                            </div>                            <div class="inline fields" ng-show="f.type == 1">                                <label class="three wide field">{{\'value\' | translate}}</label>                                <input ng-model="f.staticValue" />                            </div>                                                        <small ng-show="f.type == 2">{{\'control base filter desc\' | translate}}</small>                            <div class="field" >                                <div class="inline fields" ng-show="f.type == 2">                                    <label class="three wide field">{{\'control\' | translate}}</label>                                    <sm-dropdown model="f.control" class="selection fluid" settings="{fullTextSearch: true, forceSelection: false}" items="cnts" label="item.label" value="item.name"></sm-dropdown>                                </div>                            </div>                                                        <small ng-show="f.type == 2">{{\'control base filter desc 2\' | translate}}</small>                            <div class="inline fields" ng-show="sourceFields" ng-show="f.type == 2">                                <label class="three wide field">{{\'column\' | translate}}</label>                                <sm-dropdown model="f.sourceField" class="selection fluid" settings="{fullTextSearch: true, forceSelection: false}" items="sourceFields" label="item.label" value="item.name"></sm-dropdown>                            </div>                        </div>                   </div>',
            link: function(scope, element, attr) {}
        };
    } ]);
    ngApp.directive("tableLookup", [ "$compile", "$timeout", "formsService", function($compile, $timeout, formsService) {
        return {
            restrict: "E",
            transclude: true,
            replace: true,
            scope: {
                model: "=ngModel",
                controls: "="
            },
            controller: [ "$scope", function(scope) {
                scope.$watch("model", function(m) {
                    if (!m) {
                        scope.model = scope.model || {};
                    }
                });
                scope.$watch("controls", function(m) {
                    if (!m) return;
                    scope.cnts = [];
                    scope.cnts = scope.cnts.concat(m.row);
                    scope.cnts = scope.cnts.concat(m.rootControls);
                    scope.cnts = _.filter(scope.cnts, function(d) {
                        return d.type == 12;
                    });
                    scope.cnts = _.filter(scope.cnts, function(d) {
                        return d.name != scope.name;
                    });
                    scope.cnts = _.uniqBy(scope.cnts, "name");
                });
                scope.$watch("model.controlName", function(n, o) {
                    if (!n) return;
                    var f = _.find(scope.cnts, {
                        name: n
                    });
                    scope.model.lookupField = f.formLookup.keyControls[0];
                    scope.model.id = f.formLookup.form;
                    scope.model.type = "form";
                    getFormLookupFields(f.formLookup, formsService, function() {
                        scope.fields = f.formLookup.formLookupSourceFields;
                    });
                });
            } ],
            template: '<div class="">                          <div class="field">                            <small>{{\'extra info desc\' | translate}}</small>                            <div class="inline fields">                                <label class="three wide field">{{\'control\' | translate}}</label>                                <sm-dropdown model="model.controlName" class="selection fluid" settings="{fullTextSearch: true, forceSelection: false}" items="cnts" label="item.label" value="item.name"></sm-dropdown>                            </div>                            <div class="inline fields">                                <label class="three wide field">{{\'column\' | translate}}</label>                                <sm-dropdown model="model.resultField" class="selection fluid" settings="{fullTextSearch: true, forceSelection: false}" items="fields" label="item.label" value="item.name"></sm-dropdown>                            </div>                        </div>                   </div>',
            link: function(scope, element, attr) {}
        };
    } ]);
    ngApp.directive("sadafDraggable", [ "$timeout", function($timeout) {
        return function(scope, element, attr) {
            function setup() {
                $("[sadaf-draggable]").draggable({
                    connectToSortable: "[sadaf-sortable]",
                    helper: "clone",
                    revert: "invalid",
                    start: function(event, ui) {
                        $(ui.helper).css("width", $(ui.helper).width() + "px");
                    },
                    stop: function(event, ui) {
                        $(ui.helper).css("width", "100%");
                    }
                });
                $("[sadaf-draggable]").disableSelection();
            }
            if (scope.$last) {
                setup();
            }
        };
    } ]);
    ngApp.directive("sadafSortable", [ "$timeout", function($timeout) {
        return function(scope, element, attr) {
            function setup() {
                $("[sadaf-sortable]").sortable({
                    revert: true
                });
                $("[sadaf-sortable]").disableSelection();
            }
            if (true) {
                setup();
            }
        };
    } ]);
    ngApp.directive("sadafCalendar", function() {
        return {
            restrict: "E",
            replace: true,
            transclude: true,
            scope: {
                model: "=ngModel",
                change: "&?ngChange",
                sdKeyup: "&"
            },
            template: '<div  style="display:inline-block;width:100%;"><input type="text" id=""  class="form-control from" placeholder="{{\'date\' | translate}}" /><input id="from-value" type="hidden"/></div>',
            link: function(scope, element, attributes) {
                var input = element.find(" .from");
                input.datepicker({
                    changeMonth: true,
                    changeYear: true,
                    dateFormat: "yy/mm/dd",
                    altFormat: "yy/mm/dd",
                    yearRange: "-30:+30",
                    altField: element.find("#from-value"),
                    onClose: function(selectedDate) {
                        scope.model = selectedDate;
                        scope.$apply();
                        if (scope.change) scope.change();
                    }
                });
                input.keyup(function(e) {
                    scope.sdKeyup({
                        $event: e
                    });
                });
                scope.$watch("model", function(v) {
                    element.find(".from").datepicker("setDate", scope.model);
                });
                element.find(".from").datepicker("setDate", scope.model);
            }
        };
    });
    ngApp.directive("sadafCalendarRange", function() {
        return {
            restrict: "E",
            replace: true,
            transclude: true,
            scope: {
                model: "=ngModel",
                sdKeyup: "&"
            },
            template: '<div class="" style="display:flex; flex-direction:row;">                        <div class="" style="flex-grow:1;">                            <input id="" type="text" class="datepicker from" placeholder="تاریخ شروع" />                            <input id="from-value" type="hidden"/>                        </div>                        <div class="" style="padding: 8px;">تا</div>                        <div class="" style="flex-grow:1;">                            <input id="" type="text" class="datepicker to" placeholder="تاریخ پایان"/>                            <input id="to-value" type="hidden"/>                        </div>                      </div>',
            link: function(scope, element, attributes) {
                element.find(" .from").datepicker({
                    changeMonth: true,
                    changeYear: true,
                    dateFormat: "yy/mm/dd",
                    yearRange: "-30:+30",
                    altFormat: "yy/mm/dd",
                    altField: element.find("#from-value"),
                    onClose: function(selectedDate) {
                        scope.model = scope.model || {};
                        if (!selectedDate) {
                            scope.model.from = null;
                            return;
                        }
                        element.find(".to").datepicker("option", "minDate", selectedDate);
                        scope.model.from = selectedDate;
                        scope.$apply();
                    }
                });
                element.find(".to").datepicker({
                    defaultDate: "+1w",
                    changeYear: true,
                    changeMonth: true,
                    dateFormat: "yy/mm/dd",
                    altFormat: "yy/mm/dd",
                    yearRange: "-30:+30",
                    altField: element.find("#to-value"),
                    onClose: function(selectedDate) {
                        scope.model = scope.model || {};
                        if (!selectedDate) {
                            scope.model.to = null;
                            return;
                        }
                        element.find(".from").datepicker("option", "maxDate", selectedDate);
                        scope.model.to = selectedDate;
                        scope.$apply();
                    }
                });
                scope.$watch("model", function(v) {
                    if (!scope.model) {
                        return;
                    }
                    element.find(".from").datepicker("setDate", scope.model.from);
                    element.find(".to").datepicker("setDate", scope.model.to);
                });
            }
        };
    });
    ngApp.directive("sadafTime", [ "$compile", "$timeout", function($compile, $timeout) {
        return {
            restrict: "E",
            replace: true,
            scope: {
                model: "=ngModel",
                change: "&?ngChange"
            },
            template: '<div class="" >                        <input list="timeList" type="time" ng-model="timeValue" ng-change="change()"/>                        <datalist id="timeList">                            <option value="01:00">                            <option value="02:00">                            <option value="03:00">                            <option value="04:00">                            <option value="05:00">                            <option value="06:00">                            <option value="07:00">                            <option value="08:00">                            <option value="09:00">                            <option value="10:00">                            <option value="11:00">                            <option value="12:00">                            <option value="13:00">                            <option value="14:00">                            <option value="15:00">                            <option value="16:00">                            <option value="17:00">                            <option value="18:00">                            <option value="19:00">                            <option value="20:00">                            <option value="21:00">                            <option value="22:00">                            <option value="23:00">                            <option value="24:00">                        </datalist>                   </div>',
            link: function(scope, element, attr) {
                scope.silent = false;
                scope.timeValue;
                scope.$watch("timeValue", function(n, o) {
                    if (!n) {
                        return;
                    }
                    scope.silent = true;
                    scope.model = scope.timeValue.toTimeString().split(" ")[0].substring(0, 5);
                    $timeout(function() {
                        scope.silent = false;
                    });
                });
                scope.$watch("model", function(n, o) {
                    if (scope.silent) return;
                    if (!n) {
                        scope.timeValue = null;
                        return;
                    }
                    scope.timeValue = new Date("1969-12-31 " + scope.model + "");
                });
            }
        };
    } ]);
    ngApp.directive("sadafTimeRange", [ "$compile", "$timeout", function($compile, $timeout) {
        return {
            restrict: "E",
            replace: true,
            scope: {
                model: "=ngModel",
                change: "&?ngChange"
            },
            template: '<div class="" style="display:flex; flex-direction:row;">                        <div class="" style="flex-grow:1;">                        <input list="timeListFrom" type="time" ng-model="timeFrom" ng-change="change()"/>                        <datalist id="timeListFrom">                            <option value="01:00">                            <option value="02:00">                            <option value="03:00">                            <option value="04:00">                            <option value="05:00">                            <option value="06:00">                            <option value="07:00">                            <option value="08:00">                            <option value="09:00">                            <option value="10:00">                            <option value="11:00">                            <option value="12:00">                            <option value="13:00">                            <option value="14:00">                            <option value="15:00">                            <option value="16:00">                            <option value="17:00">                            <option value="18:00">                            <option value="19:00">                            <option value="20:00">                            <option value="21:00">                            <option value="22:00">                            <option value="23:00">                            <option value="24:00">                        </datalist>                        </div>                        <div class="" style="padding: 8px ;">تا</div>                        <div class="" style="flex-grow:1;">                        <input list="timeListTo" type="time" ng-model="timeTo" ng-change="change()" />                        <datalist id="timeListTo">                            <option value="01:00">                            <option value="02:00">                            <option value="03:00">                            <option value="04:00">                            <option value="05:00">                            <option value="06:00">                            <option value="07:00">                            <option value="08:00">                            <option value="09:00">                            <option value="10:00">                            <option value="11:00">                            <option value="12:00">                            <option value="13:00">                            <option value="14:00">                            <option value="15:00">                            <option value="16:00">                            <option value="17:00">                            <option value="18:00">                            <option value="19:00">                            <option value="20:00">                            <option value="21:00">                            <option value="22:00">                            <option value="23:00">                            <option value="24:00">                        </datalist>                        </div>                      </div>',
            link: function(scope, element, attr) {
                scope.silent = false;
                scope.timeFrom;
                scope.timeTo;
                scope.model = scope.model || {};
                scope.$watch("timeFrom", function(n, o) {
                    if (!n) {
                        return;
                    }
                    scope.silent = true;
                    scope.model = scope.model || {};
                    scope.model.from = scope.timeFrom.toTimeString().split(" ")[0].substring(0, 5);
                    if (scope.model.from == "Inval") {
                        scope.model.from = null;
                    }
                    $timeout(function() {
                        scope.silent = false;
                    });
                });
                scope.$watch("timeTo", function(n, o) {
                    if (!n) {
                        return;
                    }
                    scope.silent = true;
                    scope.model = scope.model || {};
                    scope.model.to = scope.timeTo.toTimeString().split(" ")[0].substring(0, 5);
                    if (scope.model.to == "Inval") {
                        scope.model.to = null;
                    }
                    $timeout(function() {
                        scope.silent = false;
                    });
                });
                scope.$watch("model", function(n, o) {
                    if (scope.silent) return;
                    if (!n) {
                        scope.timeFrom = {};
                        scope.timeTo = {};
                        return;
                    }
                    $timeout(function() {
                        scope.timeFrom = new Date("1969-12-31 " + scope.model.from + "");
                        scope.timeTo = new Date("1969-12-31 " + scope.model.to + "");
                    });
                });
                if (!scope.model) {
                    scope.timeFrom = new Date("1969-12-31 " + scope.model.from + "");
                    scope.timeTo = new Date("1969-12-31 " + scope.model.to + "");
                }
            }
        };
    } ]);
    ngApp.directive("sadafDateTime", [ "$compile", "$timeout", function($compile, $timeout) {
        return {
            restrict: "E",
            replace: true,
            scope: {
                model: "=ngModel",
                change: "&?ngChange"
            },
            template: '<div class="ui two columns grid"><div class="row" style="margin: 1rem 0;">                           <sadaf-calendar class="wide column" ng-model="innerModel.date"></sadaf-calendar>                           <sadaf-time class="wide column" ng-model="innerModel.time"></sadaf-time>                       </div></div>',
            link: function(scope, element, attr) {
                scope.innerModel = {};
                scope.silent = false;
                scope.$watch("innerModel", function(n, o) {
                    if (!n || !n.time && !n.date) return;
                    if (scope.silent) return;
                    var time = n.time || "00:00";
                    var date = n.date || "1397/01/01";
                    var dateArray = date.split(/\//).map(function(d) {
                        return +d;
                    });
                    var dateMiladiArray = jd_to_gregorian(persian_to_jd(dateArray[0], dateArray[1], dateArray[2]));
                    scope.silent = true;
                    scope.model = date + " " + time + ":00";
                    notifySilentTrue();
                }, true);
                function notifySilentTrue() {
                    $timeout(function() {
                        scope.silent = false;
                    }, 0);
                }
                scope.$watch("model", function(n, o) {
                    if (!n) return;
                    if (scope.silent) return;
                    var dateArray = n.split(/[\/: ]/).map(function(d) {
                        return +d;
                    });
                    var dateShamsiArray = jd_to_persian(gregorian_to_jd(dateArray[0], dateArray[1], dateArray[2]));
                    scope.silent = true;
                    scope.innerModel.date = dateArray[0] + "/" + format(dateArray[1]) + "/" + format(dateArray[2]);
                    scope.innerModel.time = format(dateArray[3]) + ":" + format(dateArray[4]);
                    notifySilentTrue();
                }, true);
                function format(i) {
                    return i < 10 ? "0" + i : i;
                }
            }
        };
    } ]);
    ngApp.directive("sadafFile", [ "$compile", "$timeout", function($compile, $timeout) {
        return {
            restrict: "E",
            transclude: true,
            replace: true,
            scope: {
                model: "=ngModel"
            },
            controller: [ "$scope", "Upload", function($scope, Upload) {
                $scope.files;
                $scope.progress = null;
                $scope.model.attachment = $scope.model.attachment || {};
                $scope.model.attachment.uploadList = $scope.model.attachment.uploadList || [];
                _.each($scope.model.attachment.uploadList, function(f) {
                    f.added = true;
                    f.name = f.fileName;
                    f.uploadFinish = true;
                    f.success = true;
                    setIcon(f);
                });
                $scope.upload = function($files, $event, $rejectedFiles) {
                    if (!$files || !$files.length) {
                        return;
                    }
                    _.each($files, function(f) {
                        $scope.model.attachment.uploadList.push(f);
                    });
                    refreshList();
                };
                $scope.getLink = function(file) {
                    if (file.serverDbId) {
                        return app.urlPrefix + "api/upload/get/" + file.serverDbId;
                    }
                    return app.urlPrefix + "api/upload/get?path=" + file.serverPath + "&name=" + encodeURI(file.name);
                };
                $scope.getSrc = function(file) {
                    return app.urlPrefix + "images/file_word.png";
                };
                function refreshList() {
                    _.each($scope.model.attachment.uploadList, function(item) {
                        if (!item.added) {
                            item.added = true;
                            uploadFile(item);
                        }
                    });
                }
                function setIcon(file) {
                    var iconMap = {
                        docx: "word",
                        doc: "word",
                        pptx: "powerpoint",
                        ppt: "powerpoint",
                        pdf: "pdf",
                        xlsx: "excel",
                        xls: "excel",
                        mp4: "video",
                        mp3: "audio",
                        wma: "audio"
                    };
                    var ext = file.name.split(".").pop().toLowerCase();
                    file.icon = iconMap[ext];
                }
                function uploadFile(file) {
                    setIcon(file);
                    Upload.upload({
                        url: app.urlPrefix + "api/Upload/PostFile",
                        data: {
                            file: file
                        }
                    }).then(function(resp) {
                        file.serverPath = resp.data[0].path;
                        file.fileName = resp.data[0].name;
                        file.success = true;
                    }, function(resp) {}, function(evt) {
                        var progressPercentage = parseInt(100 * evt.loaded / evt.total);
                        file.progress = progressPercentage;
                        if (evt.loaded == evt.total) {
                            file.uploadFinish = true;
                        }
                    });
                }
            } ],
            template: '<div class="file-uplaod ">                            <div class="ui secondary pointing tiny menu">                                <div class="active item">{{model.label}} <span ng-show="model.validations.isRequire" style="color:#db2828">&nbsp;*&nbsp;</span></div>                                <div class="ui right item" ng-hide="model.readonly">                                    <div class="pointer" ngf-select ngf-change="upload($files, $event, $rejectedFiles)" ngf-multiple="true"  ngf-allow-dir="false" ngf-accept="\'*\'">{{\'add file\' | translate}}<i class="icon plus square outline large"></i></div>                                </div>                            </div>                                                              <div ng-hide="model.attachment.uploadList.length" class="gray center aligned twelve wide column"><small>{{\'no file selected\' | translate}}</small></div>                            <div class="">                                <div ng-repeat="file in model.attachment.uploadList" class="file-item" >                                    <div class="">                                        <div class="">                                            <span class="ui img"><i class="icon file outline large" ng-class="file.icon"></i></span>                                            <span ng-hide="file.serverDbId || file.serverPath">{{file.name}} </span>                                            <a ng-show="file.serverDbId || file.serverPath"class="file-link" target="_blank" href="{{getLink(file)}}">{{file.name}} </a>                                            <span ng-show="file.uploadFinish && file.success && !model.readonly" class="pointer" ng-click="model.attachment.uploadList.splice($index,1)"><i class="icon remove small grey"></i></span>                                            <span ng-show="file.uploadFinish && !file.success" class="ui tiny"><span class="ui text tiny active inline center loader" ></span></span>                                            <sm-progress class="blue tiny" model="file.progress" ng-show="file.progress != null && !file.uploadFinish" style="margin-top:4px;"></sm-progress>                                        </div>                                    <div>                                </div>                             </div>                        </div>'
        };
    } ]);
    ngApp.service("controlPropertyService", function() {
        var c = {};
        c.control = {
            active: null,
            setActive: function(control) {
                if (!control) return;
                if (c.control.active) {
                    c.control.active.isActive = false;
                }
                c.control.active = control;
                c.control.active.isActive = true;
            },
            remove: function(i, control) {
                var f = confirm(app.lang.translate("delete control message"));
                if (f) {
                    dangerChangeOccured = true;
                    c.pages.activePage.controls.splice(i, 1);
                }
            },
            createItems: function(active) {
                if (!active.dropdown.itemsTemp) return;
                var lines = active.dropdown.itemsTemp.split(/[\r\n]/);
                active.dropdown.items = [];
                _.each(lines, function(line) {
                    var l = line.trim();
                    if (active) if (l != "") active.dropdown.items.push({
                        label: l,
                        value: l
                    });
                });
            },
            resetListValue: function() {
                if (c.control.active.dropdown) {
                    c.control.active.dropdown.listValue = [];
                }
            }
        };
        function get() {
            return c.control;
        }
        return {
            setActive: c.control.setActive,
            remove: c.control.remove,
            getActive: c.control.active,
            createItems: c.control.createItems,
            get: get
        };
    });
    ngApp.service("updateModel", [ "$http", function($http) {
        function updateValuesForGet(pages) {}
        function updateValuesForSave(pages) {}
        return {
            updateValuesForSave: updateValuesForSave,
            updateValuesForGet: updateValuesForGet
        };
    } ]);
    ngApp.service("formsService", [ "$http", "updateModel", function($http, updateModel) {
        var formsModule = 0;
        var securityCertPatch = false;
        var qGet = {};
        var clearCache = function(id) {
            if (id) qGet[id] = null;
        };
        var get = function(id, editor) {
            if (!id) id = "";
            var editParam = "";
            if (editor) editParam = "?fromEditor=true";
            if (!qGet[id || "all"]) {
                qGet[id || "all"] = $http.get(app.urlPrefix + "api/forms/get/" + id + editParam).then(function(res) {
                    if (id) {
                        updateModel.updateValuesForGet(res.data.model.pages);
                        return res.data;
                    }
                    formsModule = res.data.formsModule;
                    securityCertPatch = res.data.securityCertPatch;
                    return res.data.list;
                });
            }
            return qGet[id || "all"];
        };
        var save = function(id, model) {
            qGet = {};
            return $http.post(app.urlPrefix + "api/forms/save/" + id, model).then(function(res) {
                return res.data;
            });
        };
        var remove = function(id) {
            qGet = {};
            return $http.get(app.urlPrefix + "api/forms/delete/" + id).then(function(res) {
                return res.data;
            });
        };
        var addFormToDashboard = function(dashboard, forms) {
            qGet = {};
            return $http.post(app.urlPrefix + "api/forms/addFormToDashboard/" + dashboard, forms).then(function(res) {
                return res.data;
            });
        };
        var deleteFormFromDashboard = function(dashboard, forms) {
            return $http.post(app.urlPrefix + "api/forms/deleteFormFromDashboard/" + dashboard, forms).then(function(res) {
                return res.data;
            });
        };
        var tableLookup = function(model, value) {
            var data = {
                values: value,
                tableLookup: model
            };
            return $http.post(app.urlPrefix + "api/forms/getTableLookup", data).then(function(res) {
                return res.data;
            });
        };
        var publish = function(id, name, enable) {
            return $http.get(app.urlPrefix + "api/forms/publish", {
                params: {
                    name: name,
                    id: id,
                    publish: enable
                }
            }).then(function(d) {
                return d.data;
            });
        };
        return {
            save: save,
            get: get,
            remove: remove,
            addFormToDashboard: addFormToDashboard,
            deleteFormFromDashboard: deleteFormFromDashboard,
            getFormsModule: function() {
                return formsModule;
            },
            securityCertPatch: function() {
                return securityCertPatch;
            },
            clearCache: clearCache,
            tableLookup: tableLookup,
            publish: publish
        };
    } ]);
    ngApp.filter("d3format", function() {
        return function(input, format) {
            if (format == "#,#") format = ",.0f";
            if (typeof input == "undefined" || input == null) return input;
            return d3.format(format)(input);
        };
    });
    ngApp.directive("sadafTasks", [ "$compile", "$timeout", function($compile, $timeout) {
        return {
            restrict: "E",
            transclude: true,
            scope: {
                model: "=ngModel"
            },
            controller: [ "$scope", function($scope) {
                function uuidv4() {
                    return ([ 1e7 ] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, function(c) {
                        return (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16);
                    });
                }
                $scope.add = function() {
                    $scope.model = $scope.model || [];
                    $scope.model.push({
                        type: 0,
                        openLinkType: 0,
                        uuid: uuidv4()
                    });
                };
                $scope.addWebParam = function(task) {
                    task.webserviceParameters = task.webserviceParameters || [];
                    task.webserviceParameters.push({});
                };
            } ],
            template: "" + '<div class="" style="margin: 30px 0;">' + '<div class="ui mini icon button" ng-click="add()">{{\'add task\' | translate}} <i class="ui icon add"></i></div>' + '<div class="ui secondary black segment" style="margin-left: -12px;margin-right: -12px;border-radius: 0;" ng-repeat="task in model" ng-init="model = model || []">' + '        <button ng-click="model.splice($index, 1)" class="ui mini  basic icon button" style="box-shadow: none; position: absolute; top :0; left:0;" ><i class="ui icon close"></i></button>' + '        <div class="inline fields">' + "            <label class=\"four wide field\">{{'type' | translate}}</label>" + '            <div class="eight wide field"><sm-dropdown items="[{label:(\'goto dashboard\' | translate), value:0}' + "                         , {label:('sms' | translate), value:4}" + "                         , {label:('web service' | translate), value:2}" + "                         , {label:('javascript' | translate), value:3}]\"" + '                         style="width: 100%;"' + '                         model="task.type" label="item.label" value="item.value"></sm-dropdown></div>' + "        </div>" + "" + '        <div class="field" ng-show="task.type == 0">' + "                 <label class=\"\">{{'dashboard'|translate}}</label>" + '                 <select-menu class="" ng-model="task.dashboardId"></select-menu>' + "        </div>" + "" + '        <div class="inline fields" ng-show="task.type == 0">' + "            <label class=\"four wide field\">{{'open type'|translate}}</label>" + "            <div class=\"eight wide field\"><sm-dropdown items=\"[{label:('new page' | translate), value:0}, {label:('current page' | translate), value:1}]\"" + '                         style="width: 100%;"' + '                         model="task.openLinkType" label="item.label" value="item.value"></sm-dropdown></div>' + "        </div>" + "" + "" + '        <div class="field" ng-show="task.type == 1">' + '            <form-lookup-property ng-model="task.formInfo" settings="{selectableColumns:false}"></form-lookup-property>' + "        </div>" + "" + '        <div class="field" ng-show="task.type == 2">' + "            <label>{{'آدرس' | translate}}</label>" + '            <input style="direction: ltr;" ng-model="task.webserviceUrl" placeholder="{{\'آدرس\' | translate}}">' + "        </div>" + "" + '        <div class="field" ng-show="task.type == 4">' + "            <label>{{'sms body' | translate}}</label>" + '            <textarea ng-model="task.smsBody"></textarea>' + "        </div>" + '        <div class="field" ng-show="task.type == 4">' + "            <label>{{'roles' | translate}}</label>" + '            <select-roles ng-model="task.smsRoles"></select-roles>' + "        </div>" + '        <div class="inline fields" ng-show="task.type == 2">' + "            <label class=\"four wide field\">{{'method' | translate}}</label>" + '            <div class="eight wide field"><sm-dropdown items="[' + "                         {label:'GET' , value:0}" + "                         , {label:'POST', value:1}]\"" + '                         style="width: 100%;"' + '                         model="task.webserviceMethod" label="item.label" value="item.value"></sm-dropdown></div>' + "        </div>" + '        <div class="field" ng-show="task.type == 2">' + "            <label>{{'parameters' | translate}}</label>" + '            <div ng-repeat="p in task.webserviceParameters">' + '                <div style="padding-left: 20px;position: relative;">' + '                    <input ng-model="p.key" class="form-flat-input" type="text" placeholder="key">' + '                    <input ng-model="p.value" class="form-flat-input" type="text" placeholder="value">' + '                    <i style="position:absolute; left:0; top:0;" class="ui icon close pointer" ng-click="task.webserviceParameters.splice($index, 1)"></i>' + "                </div>" + "            </div>" + '            <span class="link-button" ng-click="addWebParam(task)">{{\'new row\' | translate}} <i class="ui icon add"></i></span>' + "        </div>" + '        <div class="field" ng-show="task.type == 3">' + "            <label>{{'javascript' | translate}}</label>" + '            <textarea ng-model="task.script" style="direction:ltr; font-family:monospace;"placeholder="{{\'javascript\' | translate}}"></textarea>' + "        </div>" + "    </div>" + "</div>"
        };
    } ]);
    ngApp.service("taskExecutor", [ "$http", function($http) {
        function exec(task, formModel, scope) {
            function replaceValue(val) {
                return val.replace(/@\((field-\d+)\)/gi, function(a, b) {
                    var c = findControl(b, formModel.pages);
                    if (c === null) return "";
                    if (c.type === 19) {
                        var serverPath = c.attachment.uploadList[0].serverPath;
                        var serverDbId = c.attachment.uploadList[0].serverDbId;
                        return serverPath;
                    }
                    return c.value;
                });
            }
            if (task.type === 0) {
                if (!+task.dashboardId) return;
                var name = +task.openLinkType === 0 ? "_blank" : "_self";
                window.open(app.urlPrefix + "#/dashboard/" + task.dashboardId, name);
            }
            if (task.type === 2) {
                if (_.isEmpty(task.webserviceUrl)) return;
                var url = replaceValue(task.webserviceUrl);
                scope.model.progress = true;
                $http.get(url).then(function() {
                    scope.model.progress = false;
                    alert(app.lang.translate("successfull run"));
                }).catch(function() {
                    scope.model.progress = false;
                    alert(app.lang.translate("unsuccessfull run"));
                });
            }
            if (task.type == 3) {
                if (_.isEmpty(replaceValue(task.script))) return;
                eval(task.script);
            }
        }
        return {
            exec: exec
        };
    } ]);
    function findControl(name, data) {
        var n = null;
        runOnAllControll(data, function(d) {
            if (d.name === name) {
                n = d;
                return false;
            }
        });
        return n;
    }
    function runOnAllControll(pages, run, pageRun) {
        var pagesControls = [];
        _.each(pages, function(page) {
            if (pageRun) pageRun(page);
            if (page && _.isArray(page.controls)) pagesControls = pagesControls.concat(page.controls);
        });
        _.each(pagesControls, function(cnt) {
            if (cnt.type == 13 && cnt.multiRowForm) {
                _.each(cnt.multiRowForm.rows, function(row) {
                    _.each(row, function(d) {
                        run(d, row);
                    });
                });
            }
            run(cnt, pagesControls);
        });
    }
    function showErrorToast(msg, $mdToast) {
        $mdToast.show({
            template: '<md-toast class="md-toast error"> <span class="md-toast-text" flex>' + msg + "</span></md-toast>",
            hideDelay: 3e3,
            position: "bottom left"
        });
    }
    function getFormLookupFields(fl, formsService, callback) {
        if (!fl || !fl.form) return;
        if (fl.formLookupSourceFields && fl.formLookupSourceFields.length) {
            if (callback) callback();
            return;
        }
        formsService.get(fl.form).then(function(data) {
            fl.formLookupSourceFields = [];
            _.each(data.model.pages, function(page) {
                _.each(page.controls, function(cnt) {
                    fl.formLookupSourceFields.push(cnt);
                });
            });
            fl.formLookupSourceFields.push({
                name: "_id",
                label: app.lang.translate("identity")
            });
            if (callback) callback();
        });
    }
})();
// داشبورد مدیریتی صدف info@sadafdashboard.ir 

var app = app || {};

app.contentSegment = $("#content_segment");

app.contentSegmentModal = $("#content_segmentModal");

if (!console) {
    console = {};
    console.log = function() {};
}

app.chartLoadDelay = 120;

app.absoluteUrl = "/";

app.setAboluteUrl = function(absoluteUrl) {
    app.absoluteUrl = absoluteUrl;
};

app.loadContent = function(link) {
    app.showLoadingProgress();
    $("#content_segment").load(app.urlPrefix + link, function() {
        app.hideLoadingProgress();
        app.lang.setLang();
    });
};

app.setContent = function(data) {
    $("#content_segment").html(data);
    app.hideLoadingProgress();
    app.lang.setLang();
};

app.setLocation = function(link) {
    app.router.navigate(link, {
        trigger: true
    });
};

app.urlPrefix = "/";

app.setUrlPrefix = function(link) {
    app.urlPrefix = link.replace(/Moderation.*/g, "");
};

app.showInfo = function(info) {
    $("#app-info-text").html(info);
    $("#app-info-text").fadeIn();
    $("#app-loading-text").hide();
    app.showInfoHolder.show();
    setTimeout(function() {
        app.showInfoHolder.hide();
        $("#app-info-text").fadeOut(400, function() {
            $("#app-loading-text").show();
        });
    }, 4e3);
};

app.showLoadingProgress = function() {
    app.showInfoHolder.show();
};

app.hideLoadingProgress = function() {
    app.showInfoHolder.hide();
};

app.showInfoHolder = {
    holderCount: 0,
    timeout: {},
    hide: function() {
        if (app.showInfoHolder.holderCount > 0) --app.showInfoHolder.holderCount;
        if (app.showInfoHolder.holderCount == 0) {
            var difTime = new Date().getTime() - app.showInfoHolder.ticks;
            clearTimeout(app.showInfoHolder.timeout);
            setTimeout(function() {
                $("#app-loading").parent("div").animate({
                    top: "0",
                    opacity: 0
                }, 400);
            }, difTime < 1e3 ? 1e3 : 0);
        }
    },
    show: function() {
        var el = $("#app-loading").parent("div");
        el.css("left", $(window).width() / 2 - el.outerWidth() / 2);
        ++app.showInfoHolder.holderCount;
        app.showInfoHolder.ticks = new Date().getTime();
        app.showInfoHolder.timeout = setTimeout(function() {
            $("#app-loading").parent("div").animate({
                top: "50",
                opacity: 1
            }, 400);
        }, 1e3);
    }
};

app.encodeHTML = function(s) {
    return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/"/g, "&quot;");
};

app.convertOldPropObject = function(old, chartType) {
    if (!old) return;
    if (old.chartProp && old.chartProp.info) {
        return old;
    }
    var result = {};
    result.chartProp = {};
    if (+chartType == chartTypes.TABLE) {
        result.chartProp.info = {
            chartSize: old.chartProp.chartSize,
            pivotTable: old.chartProp.pivotTable
        };
        result.chartProp.series = {};
        for (var prop in old.seriesProp) {
            if (old.seriesProp.hasOwnProperty(prop)) {
                result.chartProp.series["" + prop] = {
                    name: old.seriesProp["" + prop].table.headerName,
                    numberFactor: "1",
                    textAlign: old.seriesProp["" + prop].table.textAlign,
                    formatString: old.seriesProp["" + prop].table.formatString,
                    fontSize: old.seriesProp["" + prop].table.fontSize,
                    textBold: false,
                    textItalic: false,
                    color: old.seriesProp["" + prop].table.fontColor
                };
            }
            result.chartProp.series["default"] = {
                name: "",
                numberFactor: "1",
                textAlign: "right",
                formatString: "A",
                fontSize: "1m",
                textBold: false,
                textItalic: false,
                color: "#000000"
            };
        }
    }
    if (+chartType == chartTypes.BAR) {
        result.chartProp.info = {
            chartSize: old.chartProp.chartSize,
            horizontalLines: old.chartProp.horizontalLine,
            formatString: old.chartProp.formatString
        };
        result.chartProp.series = {};
        for (var prop in old.seriesProp) {
            if (old.seriesProp.hasOwnProperty(prop)) {
                result.chartProp.series["" + prop] = {
                    name: "",
                    numberFactor: old.seriesProp["" + prop].barlineChartProp.numberFactor,
                    seriesType: old.seriesProp["" + prop].barlineChartProp.barlineChartType,
                    seriesColor: old.seriesProp["" + prop].barlineChartProp.barlineChartColor,
                    lineType: old.seriesProp["" + prop].barlineChartProp.barlineChartTypeLineProp.lineChartStyle,
                    lineStyle: old.seriesProp["" + prop].barlineChartProp.barlineChartTypeLineProp.lineChartLineStyle,
                    lineWeight: old.seriesProp["" + prop].barlineChartProp.barlineChartTypeLineProp.lineChartLineWeight,
                    lineFace: old.seriesProp["" + prop].barlineChartProp.barlineChartTypeLineProp.lineChartLineDashes
                };
            }
        }
        result.chartProp.series["default"] = {
            name: "",
            numberFactor: "1",
            seriesType: "bar",
            seriesColor: "#1f77b4",
            lineType: "line-dot-area",
            lineStyle: "linear",
            lineWeight: "2",
            lineFace: "5,0"
        };
    }
    if (+chartType == chartTypes.PIE) {
        result.chartProp.info = {
            horizontalLines: old.chartProp.horizontalLine,
            chartSize: old.chartProp.chartSize,
            formatString: old.chartProp.formatString,
            pieStyle: old.chartProp.pieStyle,
            hole: "65"
        };
        result.chartProp.series = {};
        result.chartProp.series["default"] = {
            numberFactor: "1"
        };
    }
    if (+chartType == chartTypes.GAUGE) {
        result.chartProp.info = {
            chartSize: old.chartProp.chartSize,
            style: old.chartProp.gaugeStyle,
            height: "medium",
            color: "#333333",
            fontSize: "3em",
            formatString: ",.2f",
            status: "",
            target: "",
            textBold: true,
            textItalic: false,
            trend: "",
            value: "",
            segmentType: "singleSegment",
            min: "",
            yellow: "",
            green: "",
            max: ""
        };
        result.chartProp.series = {};
        result.chartProp.series["default"] = {
            numberFactor: "1",
            type: "value",
            typeMs: "value"
        };
    }
    result.dataUrl = old.chartProp.DataUrl;
    result.editMode = old.chartProp.editMode;
    return result;
};

app.autoPlayTimer = app.autoPlayTimer || {
    counter: 0
};

app.autoPlay = function(type, interval) {
    if (type && type == "start") {
        var links = $("#side-navigation2 .simple-link");
        interval = interval || 10;
        $(".sadaf-circular-preogress").progressbar(10, +interval * 1e3);
        app.autoPlayTimer.timer = setTimeout(function() {
            var selectedMenu = $(links[app.autoPlayTimer.counter++ % links.length]);
            document.location.href = selectedMenu.attr("href");
            selectedMenu.parents(".panel-collapse").collapse("show");
            $(".sadaf-circular-preogress").progressbar("stop");
            app.autoPlay("start", interval);
        }, +interval * 1e3);
    }
    if (type && type == "stop") {
        $(".sadaf-circular-preogress").progressbar("stop");
        clearTimeout(app.autoPlayTimer.timer);
    }
};

var resizeTimer;

app.lestenWindowResize = function(callback) {
    function ff() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function() {
            callback();
        }, 400);
    }
    var width = $(window).width();
    $(window).resize(function() {
        var nw = $(window).width();
        if ($(window).width() != width) {
            width = $(this).width();
            ff();
        }
    });
};

var designMenuTimer;

var printMenuTimer;

app.onMenusClick = function(show, showfullScreen) {
    if (show == "showPrintMenu" || show == "hidePrintMenu") {
        clearTimeout(printMenuTimer);
        printMenuTimer = setTimeout(function() {
            if (show == "showPrintMenu") {
                $(".navbar .print-toggle").fadeIn();
            } else if (show == "hidePrintMenu") {
                $(".navbar .print-toggle").fadeOut();
            }
        }, 800);
        return;
    }
    clearTimeout(designMenuTimer);
    designMenuTimer = setTimeout(function() {
        if (show == "showDesignMenu") {
            $(".navbar .design-toggle").fadeIn();
        } else if (show == "hideDesignMenu") {
            $(".navbar .design-toggle").fadeOut();
        }
        if (showfullScreen && showfullScreen == "showfullScreenMenu") $(".navbar .fullscreen-toggle").parents(".pull-right").fadeIn(); else $(".navbar .fullscreen-toggle").parents(".pull-right").fadeOut();
    }, 800);
    $("html,body").animate({
        scrollTop: 0
    }, "slow", function() {
        if ($(".side-menu").hasClass("open")) $("#side-menu-toggle").click();
    });
};

app.print = {
    printSingle: function(selector, title) {
        var html = this.getWidgetHtml(selector);
        app.print.print(html, title);
    },
    getWidgetHtml: function(selector) {
        var height = $(selector).height();
        var width = $(selector).width();
        var clone = $(selector).clone();
        clone.width(width);
        clone.height(height);
        var desc = clone.find(".title.over-show .desc").html();
        debugger;
        clone.find(" .header").remove();
        clone.find(" .title").remove();
        clone.find(" #sort_checkbox").remove();
        clone.find(" .comment").remove();
        var chartHtml = $("<div>").append(clone).html();
        var descDiv = $('<div style="margin-top:10px;">' + desc + "</div>").width(width);
        var div = $("<div>").html(chartHtml).append(descDiv);
        div.css({
            "page-break-inside": "avoid",
            margin: "0 50px 50px 50px"
        });
        div.addClass("pull-left");
        var html = $("<div>").append(div).html();
        return html;
    },
    printPage: function() {
        var html = "";
        $(".chart-widget").each(function() {
            var id = $(this).find(".chart-layout").attr("id");
            html += app.print.getWidgetHtml("#" + id);
        });
        var title = $(".dashboard-page.active > a").text();
        app.print.print(html, title);
    },
    print: function(html, title) {
        var css = '<link href="' + app.absoluteUrl + "dist/css/dash-all" + (app.lang.isRtl ? "-rtl" : "") + ".css?v=" + app.version + '" rel="stylesheet" />                   <style  type="text/css">@page {                                margin: 1.5cm;                                @top-center {                                        content: "sapam";                                    }                                }                    </style>';
        var w = window.open();
        w.document.write('<html><head><meta charset="utf-8"><title>' + title + "</title>" + css);
        w.document.write("</head><body>");
        w.document.write(html);
        w.document.write("</body></html>");
        w.document.close();
        w.focus();
        setTimeout(function() {
            w.print();
        }, 400);
    }
};

app.post = function(link, data, callback) {
    $.ajax({
        url: link,
        type: "POST",
        data: JSON.stringify(data),
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        traditional: true,
        success: callback
    });
};

app.lang = {
    langType: 0,
    setLangTyle: function(lang) {
        this.langType = +(lang || 0);
    },
    isRtl: function() {
        return app.lang.langType == 0;
    },
    translate: function(key) {
        if (app.lang.lang) return app.lang.lang[key] || key;
        return key;
    },
    q: [],
    translateAsync: function(key, callback) {
        if (app.lang.lang) {
            if (callback) callback(app.lang.lang[key] || key);
        } else {
            this.q.push({
                key: key,
                callback: callback
            });
        }
    },
    setLang: function(opt) {
        if (opt && opt.data) this.lang = opt.data;
        if (!this.lang && this.inProgress) {
            return;
        }
        if (!this.lang && !this.inProgress) {
            var langChar = app.lang.langType == 0 ? "fa" : "en";
            this.inProgress = true;
            $.getJSON(app.urlPrefix + "dist/locales/locale-" + langChar + ".js?v=" + app.version, null, function(d) {
                app.lang.setLang({
                    data: d
                });
            });
            while (this.q.length > 0) {
                var item = this.q.pop();
                if (item.callback) callback(app.lang.lang[item.key] || item.key);
            }
            return;
        }
        var $els;
        if (opt && opt.selector) {
            $els = $(opt.selector).find("*[data-trans-key]");
        } else {
            $els = $("*[data-trans-key]");
        }
        $els.each(function() {
            var $el = $(this);
            var isTranslated = $el.data("translated");
            if (!isTranslated) {
                var trans = app.lang.lang[$el.data("trans-key")];
                var attr = $el.data("trans-attr");
                if (attr) {
                    $el.attr(attr, trans);
                } else {
                    $el.text(trans);
                }
                $el.data("translated", true);
            }
        });
    }
};

var app = app || {};

app.dashboardLayoutVersion = 2;

var dashboard = {
    defuals: {
        maxCols: 12
    },
    charts: [],
    pageInfo: {},
    pageId: -1,
    arrangePer: false,
    minChartSize: {
        1: [ 500, 250 ],
        2: [ 350, 350 ],
        3: [ 300, 200 ],
        4: [ 300, 300 ],
        5: [ 500, 300 ],
        6: [ 300, 200 ],
        7: [ 350, 50 ],
        8: [ 300, 300 ],
        9: [ 300, 300 ]
    },
    padding: 10,
    maxCols: 12,
    baseDimantion: {
        y: 30
    },
    serialize: function() {
        var s = dashboard.gs.serialize();
    },
    drillDownResize: function(settings, barHeight) {},
    setMaxCols: function() {
        var layouts = dashboard.getPagePosition();
        dashboard.maxCols = layouts ? layouts.maxCol || 12 : 12;
        $("#dashboard-col").val(dashboard.maxCols);
    },
    setInfo: function(charts, pageInfo, pageId, arrangePer, forms) {
        this.arrangePer = arrangePer || false;
        this.charts = charts || [], this.pageInfo = pageInfo || {
            chartsOrder: [],
            layout: [],
            pageLayout: "30_30_30"
        };
        this.pageId = pageId || -1;
        this.forms = forms || [];
        this.charts = this.charts.concat(this.forms);
        this.setMaxCols();
    },
    disable: function() {
        dashboard.gs.disable();
        dashboard.gs.disable_resize();
    },
    enable: function() {
        dashboard.gs.enable();
        dashboard.gs.enable_resize();
    },
    saveSerialize: function() {
        dashboard.serializeData = dashboard.gs.serialize();
        var pos = dashboard.serializeData.map(function(d) {
            var id;
            if (d.type === "form") {
                id = d.id;
            } else {
                id = d.data.ChartInPageId;
            }
            return {
                type: d.type,
                chartIdPageId: id,
                col: d.wgd.col,
                row: d.wgd.row,
                size_x: d.wgd.size_x,
                size_y: d.wgd.size_y
            };
        });
        var data = {
            pageId: this.pageId,
            chartsPosition: pos,
            media: dashboard.media,
            maxCol: dashboard.maxCols
        };
        try {
            if (typeof dashboard.pageInfo.layout == "undefined") dashboard.pageInfo.layout = [];
            var positions = dashboard.pageInfo.layout.filter(function(p) {
                return p.media === dashboard.media;
            });
            if (positions.length > 0) positions[0].chartsPosition = pos; else dashboard.pageInfo.layout.push({
                media: dashboard.media,
                chartsPosition: pos,
                maxCol: dashboard.maxCols
            });
        } catch (e) {}
        $.ajax({
            type: "POST",
            url: app.urlPrefix + "Charts/DashboardPage/SetChartsOrder",
            dataType: "json",
            contentType: "application/json;charset=utf-8",
            traditional: true,
            data: JSON.stringify(data),
            success: function(data) {}
        });
    },
    add: function(el, size_x, size_y, col, row) {
        size_x = size_x > dashboard.maxCols ? dashboard.maxCols : size_x;
        col = col > dashboard.maxCols ? dashboard.maxCols : col;
        dashboard.gs.add_widget(el, size_x, size_y, col, row);
    },
    initGs: function(designPermission) {
        dashboard.baseDimantion = {
            x: $(".gridster").width() / dashboard.maxCols,
            y: 50
        };
        dashboard.gs = $(".gridster>div").gridster({
            widget_margins: [ 0, 0 ],
            widget_base_dimensions: [ dashboard.baseDimantion.x, dashboard.baseDimantion.y ],
            max_cols: dashboard.maxCols,
            min_cols: dashboard.maxCols,
            min_rows: 1e3,
            resize: {
                enabled: true,
                stop: function(event, ui, el) {
                    dashboard.saveSerialize();
                    var type = $(el).data("type");
                    if (type === "form") return;
                    var s = $(el).find(".chart-data").data("settings");
                    s.isDashboardResize = true;
                    $(el).find(".chart-data").charts(s.type, "refresh", s);
                    s.widgetSize.size_y = +$(el).attr("data-sizey");
                    s.widgetSize.size_x = +$(el).attr("data-sizex");
                }
            },
            serialize_params: function($w, wgd) {
                var type = $w.data("type");
                var id = $w.data("id");
                return {
                    type: type,
                    id: id,
                    data: $w.find(".chart-data").data("settings"),
                    wgd: wgd
                };
            },
            draggable: {
                handle: ".content > .move, content > .move b",
                cancel: ".desc",
                start: function(event, ui) {},
                drag: function(e, u) {},
                stop: function(e, ui) {
                    $(ui.$helper).removeClass("player-revert");
                    dashboard.saveSerialize();
                }
            }
        }).data("gridster");
        if (!designPermission) {
            dashboard.gs.disable();
            dashboard.gs.disable_resize();
        }
        return dashboard.gs;
    },
    deleteAll: function() {
        var data = $("#ID0").data("settings");
        dashboard.gs.remove_widget($("#ID0"));
    },
    deleteChartFromGs: function(id, callback) {
        var wg = $(id).parents(".chart-widget");
        dashboard.gs.remove_widget(wg);
        if (callback) callback();
    },
    getPagePosition: function() {
        var p = dashboard.pageInfo.layout.filter(function(p) {
            return p.media <= dashboard.media;
        }).sort(function(a, b) {
            return +b.media - +a.media;
        });
        if (p.length == 0) {
            var media = _.map(dashboard.pageInfo.layout, function(d) {
                return d.media;
            });
            var index = -1;
            var delta = 1e3;
            _.each(dashboard.pageInfo.layout, function(d, i) {
                var _del = Math.abs(d.media - dashboard.media);
                if (_del < delta) {
                    delta = _del;
                    index = i;
                }
            });
            if (index != -1) {
                p = [ dashboard.pageInfo.layout[index] ];
                p[0].media = media;
                p[0].maxCols = dashboard.maxCols;
            }
        }
        return p[0];
    },
    getChartPosition: function(item, type, chartInPageId) {
        var widgetType = null;
        var chartType = 1e3;
        var widgetId;
        if (item.type === "form") {
            widgetType = "form";
            widgetId = item.id;
        } else {
            widgetId = item.pageId;
            chartType = +item.type;
        }
        var ds = dashboard.minChartSize[+chartType] || [ 300, 300 ];
        var wgd = {
            col: 1,
            row: 1e3,
            size_x: Math.floor(ds[0] / dashboard.baseDimantion.x) + 1,
            size_y: Math.floor(ds[1] / dashboard.baseDimantion.y) + 1
        };
        var chartPos = [];
        try {
            var positions = dashboard.getPagePosition();
            chartPos = positions.chartsPosition.filter(function(p) {
                return p.chartIdPageId === widgetId && (!p.type || p.type === widgetType);
            });
        } catch (e) {}
        return chartPos[0] || wgd;
    },
    sortCharts: function() {
        try {
            this.charts.sort(function(a, b) {
                try {
                    var aId = dashboard.getChartPosition(a);
                    var bId = dashboard.getChartPosition(b);
                    var o = aId.row == bId.row ? aId.col > bId.col ? 1 : aId.col < bId.col ? -1 : 0 : aId.row > bId.row ? 1 : aId.row < bId.row ? -1 : 0;
                    return o;
                } catch (e) {
                    return -1e3;
                }
            });
        } catch (e) {
            Error(e);
        }
    },
    addTasks: [],
    drow: function(onFinish) {
        dashboard.initGs(this.arrangePer);
        dashboard.sortCharts();
        var i = 0;
        this.charts.forEach(function(d, ci) {
            if (+d.type != 7) i++;
            var j = i;
            var t = setTimeout(function() {
                dashboard.addChart(d, null, false, j * app.chartLoadDelay);
                if (ci == dashboard.charts.length - 1 && onFinish) {
                    onFinish();
                }
            }, ci * 50);
            dashboard.addTasks.push(t);
        });
    },
    resize: function() {
        this.setMaxCols();
        var chartOpts = $(".chart-data").map(function(i, d) {
            return $(d).data("settings");
        }).toArray();
        $(".gridster").remove();
        $("#dashboard-chart-panel").html('<div class="gridster"><div></div></div>');
        dashboard.initGs(this.arrangePer);
        chartOpts.forEach(function(d) {
            dashboard.addChart(null, d, true);
        });
        if (dashboard.forms) {
            _.each(dashboard.forms, function(form) {
                dashboard.addChart(form);
            });
        }
    },
    addChart: function(d, opt, refresh, delay, container) {
        var div;
        if (d && d.type === "form") {
            var wgd = dashboard.getChartPosition(d);
            var editLink = app.absoluteUrl + "sadaf/management/#/forms/" + d.id;
            var needFilterIcon = false;
            var removeLink = "javascript:dashboard.deleteForm(" + d.id + ")";
            var CanExportXlsx = false;
            var desc = "";
            div = $('<div data-type="form" data-id="' + d.id + '" class="chart-widget"></div>');
            var chartTemplate = dashboard.getFormTemplate(this.arrangePer, d.permissions.EditPermission, editLink, removeLink, needFilterIcon, d.name, id, d.lastRefresh, desc, CanExportXlsx);
            div.append(chartTemplate);
            div.find(".title-content").text(d.name);
            dashboard.add(div, wgd.size_x, wgd.size_y, wgd.col, wgd.row);
            $("body").trigger("form-widget-add", [ d.id ]);
            app.lang.setLang({
                selector: "div[data-type=form][data-id=" + d.id + "]"
            });
        } else {
            if (typeof delay == "undefined") delay = 0;
            if (opt) {
                d = {
                    id: opt.chartId,
                    pageId: opt.ChartInPageId,
                    title: typeof opt.title != "undefined" ? opt.title : opt.input.title,
                    type: opt.type.id,
                    isCustom: opt.type.isCustom,
                    permissions: opt.permissions,
                    lastRefresh: opt.lastRefresh,
                    desc: opt.desc
                };
            }
            var data = {
                chartId: d.id,
                ChartInPageId: d.pageId
            };
            var id = "ID" + d.pageId;
            div = $("<div class='chart-widget cid" + d.pageId + "'></div>");
            var decodedOptions = opt;
            if (!opt) {
                decodedOptions = JSON.parse(d.detail);
            }
            var config = app.customChart.getConfig({
                isCustom: d.isCustom,
                id: +d.type
            });
            var needData = config.needData !== false;
            var info = decodedOptions.chartProp.info || {};
            if (d.isCustom) {
                info = decodedOptions.chartProp.general.info || {};
            }
            if (info.dontShowTitle === true) {
                config.noTitle = true;
            }
            if (info.noPadding === true) {
                config.noPadding = true;
            }
            var CanExportXlsx = !needData || !d.isCustom && +d.type == 7 ? false : true;
            var needFilterIcon = !needData || !d.isCustom && +d.type == 7 ? false : true;
            var editLink = app.absoluteUrl + "sadaf/management/#/charts/edit/0/" + data.chartId;
            var removeLink = "javascript:dashboard.deleteChart(" + data.ChartInPageId + ", " + data.chartId + ", " + d.permissions.DeletePermission + ")";
            var desc = $("<p />");
            if (!_.isEmpty(d.desc)) {
                desc.html("<br/><b>" + app.lang.translate("desc") + ":</b> ");
                desc.append($("<span />").text(d.desc));
            }
            var isCobmo = decodedOptions.dataType == "combo-kpi";
            var chartTemplate = dashboard.getChartTemplate(this.arrangePer, d.permissions.EditPermission, editLink, removeLink, needFilterIcon, d.title, id, d.lastRefresh, desc, CanExportXlsx, isCobmo, config, info);
            div.append(chartTemplate);
            div.find(".title-content").text(d.title);
            div.find(".desc-content").append(desc);
            if (info.backgroundColor) {
                div.find(".ui.card ").css("background", info.backgroundColor);
            }
            if (info.titleFont) {
                div.find(".ui.card .title-content").css({
                    "font-size": info.titleFont.fontSize,
                    color: info.titleFont.color,
                    "font-family": info.titleFont.fontName,
                    "font-weight": info.titleFont.bold ? "bold" : "normal",
                    "font-style": info.titleFont.italic ? "italic" : "normal"
                });
                div.find(".ui.card .title").css({
                    "text-align": info.titleFont.align
                });
            }
            if (config.noPadding) {
                div.find(".ui.card .title + .description").addClass("chart-fit-to-container");
            }
            if (!d.permissions.Filter) {
                div.find(".icon.filter").remove();
            }
            if (!d.permissions.Description) {
                div.find(".icon.info").remove();
            }
            if (!d.permissions.Comment) {
                div.find(".icon.comments").remove();
            }
            if (!d.permissions.ExportExcel) {
                div.find(".item.export-excel").remove();
            }
            if (d.isCustom) {
                div.find(".export-png").remove();
            }
            var opt = opt || $.extend({
                permissions: d.permissions,
                parameters: data,
                chartId: data.chartId,
                editLink: editLink,
                removeLink: removeLink,
                RemoveFromPage: this.arrangePer,
                ChartInPageId: d.pageId,
                input: {
                    RefreshDatasource: d.RefreshDatasource
                },
                lastRefresh: d.lastRefresh,
                desc: d.desc,
                type: d.type,
                isCustom: d.isCustom
            }, decodedOptions);
            wgd = dashboard.getChartPosition(d);
            opt.widgetSize = wgd;
            if (container) {
                if (refresh) {
                    container.find(".chart-data").charts(opt.type, refresh, opt);
                } else {
                    container.append(div);
                    div.find(".menu-bar ").remove();
                    div.find(".chart-data").charts(opt.type, opt);
                }
                return;
            } else {
                dashboard.add(div, wgd.size_x, wgd.size_y, wgd.col, wgd.row);
            }
            if (refresh) {
                div.find(".bar-chart").data("settings", opt);
                div.find(".chart-data").charts({
                    id: d.type,
                    isCustom: d.isCustom
                }, "refresh", opt, true);
            } else {
                var t = setTimeout(function() {
                    div.find(".chart-data").charts({
                        id: d.type,
                        isCustom: d.isCustom
                    }, opt);
                }, !d.isCustom && +d.type === 7 ? 0 : delay);
                dashboard.addTasks.push(t);
            }
            app.lang.setLang({
                selector: ".chart-widget.cid" + d.pageId
            });
        }
        div.find(".show-extra-info").on("click", function() {
            div.find(".ui.card .ui.dimmer.overflow-auto").dimmer("show");
        });
        div.find(".dimmer-info").on("click", function() {
            div.find(".ui.card .ui.dimmer").dimmer("hide");
        });
        div.find(".refresh-chart").on("click", function() {
            div.find(".chart-data").charts({
                id: d.type,
                isCustom: d.isCustom
            }, "refreshWithData", opt, true);
            div.find(".bar-chart").data("settings").titlebar.showProgress(true);
        });
        div.find(".export-excel").on("click", function() {
            var s = div.find(".chart-data").data("settings");
            app.chartCommons.setFilterParameter(s);
            try {
                s.parameters.TableInfo.IsPageValid = true;
            } catch (e) {}
            $.ajax({
                type: "POST",
                url: app.urlPrefix + "Charts/BarChart/ExportToExcel",
                data: JSON.stringify({
                    ChartId: opt.chartId,
                    ChartInPageId: opt.ChartInPageId,
                    TableInfo: s.parameters.TableInfo,
                    IsPivot: +decodedOptions.chartProp.info.aggregation === 1,
                    drillDown: s.parameters.drillDown,
                    userControlFilter: s.parameters.userControlFilter,
                    userVariable: s.parameters.userVariable,
                    otherFilters: s.parameters.otherFilters,
                    filterHierarchy: app.chartCommons.getFilterHierarchy(opt.ChartInPageId)
                }),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function(data) {
                    window.location = app.urlPrefix + "Charts/BarChart/Download?name=" + data.id;
                }
            });
        });
        div.find(".export-png").on("click", function() {
            var root = div.get(0);
            html2canvas(root, {
                background: null,
                scale: 5,
                useCORS: true,
                onclone: function(dc) {
                    $(dc).find(".cid" + d.pageId + " .header").remove();
                    $(dc).find(".cid" + d.pageId + " .title").remove();
                    $(dc).find(".cid" + d.pageId + " #sort_checkbox").remove();
                    $(dc).find(".cid" + d.pageId + " .comment").remove();
                    $(dc).find(".cid" + d.pageId + " .ui.card").css("background", "none");
                    $(dc).find(".cid" + d.pageId + " rect.background").css("fill", "none");
                    $(dc).find(".cid" + d.pageId + " .line-chart .line").css("fill", "none");
                    $(dc).find(".cid" + d.pageId + " .line-chart circle").css("fill", "#fff");
                    $(dc).find(".cid" + d.pageId + " .pie-chart polyline").css("fill", "none");
                    $(dc).find(".cid" + d.pageId + " .pie-chart polyline").css("stroke-width", "1px");
                    $(dc).find(".cid" + d.pageId + " .pie-chart polyline").css("stroke", "#000");
                    $(dc).find(".cid" + d.pageId + " *").css("font-family", "IRANSans,Droid,Tahoma,Arial");
                    $(dc).find(".cid" + d.pageId + " .map-container  #state-borders").css("fill", "none");
                }
            }).then(function(canvas) {
                canvas.fillStyle = null;
                canvas.fillRect = null;
                canvas.toBlob(function(blob) {
                    saveAs(blob, d.title + ".png");
                });
            });
        });
        div.find(".export-print").on("click", function() {
            app.print.printSingle(".cid" + d.pageId, d.title);
        });
        div.find(".clone-chart").on("click", function() {
            app.post(app.urlPrefix + "Moderation/Charts/CloneChart", {
                Id: opt.chartId,
                PageId: dashboard.pageId
            }, function(data) {
                if (data.result && data.insertedId) {
                    var id = data.insertedId;
                    var link = app.urlPrefix + "api/dashboards/getSingleChartInfo?chartId=" + id + "&chartInPageId=" + data.chartInPageId;
                    $.get(link, function(data2) {
                        dashboard.charts.push(data2);
                        dashboard.addChart(data2, null, false);
                        $("html, body").animate({
                            scrollTop: $(document).height() - $(window).height()
                        }, 1e3);
                    });
                }
            });
        });
        div.find(".chart-dimentions").on("click", function() {
            div.find(".chart-dimentions-content").transition("fade up");
            div.find(".chart-dimentions").transition("fade");
        });
        div.find(".show-chart-dimensions").on("click", function() {
            var filter = div.find(".chart-dimentions-content");
            div.find(".chart-dimentions-content").transition("fade up");
            div.find(".chart-dimentions").transition("fade");
            if (filter.html() == "") {
                filter.html('<div class="ui text active loader">در حال بارگذاری</div>');
                $.ajax(app.urlPrefix + "api/chartdata/GetChart?Id=" + opt.chartId + "&ChartInPageId=" + opt.ChartInPageId).done(function(data) {
                    filter.data("data", data);
                    var hierarchyHtml = null, ProvisionHtml = null, SeriesLevelHtml = null;
                    function convertToUl(data, index) {
                        if (data != null) {
                            return "<ul class='sortable list-unstyled pointer' index='" + index + "'>" + data.map(function(item, i) {
                                if (!item.ShowFilter) {
                                    return '<li value="' + filterXSS(item.Uniquename) + '"> ' + filterXSS(item.Caption) + "</li>";
                                }
                                return '<li value="' + filterXSS(item.Uniquename) + '">  ' + filterXSS(item.Caption) + '<i class="icon filter filter-member-dialog" style="float:left; margin-right:5px;"></i></li>';
                            }).join("") + "</ul>";
                        }
                        return "";
                    }
                    hierarchyHtml = convertToUl(data.Hierarchies, "Hierarchies");
                    ProvisionHtml = convertToUl(data.Where, "Where");
                    SeriesLevelHtml = convertToUl(data.SeriesLevel, "SeriesLevel");
                    var table = '<table class="ui single line unstackable table chart-design" xstyle="display:none" xstyle="position:absolute;margin-bottom:0px; background-color:#fff;display:none; border-bottom:1px solid silver">                                           <thead><tr class="">                                             <th style="' + (SeriesLevelHtml == "" ? "display:none" : "") + '"><span data-trans-key="شاخص‌ها (ستون‌های عددی)" > </span> </th>                                             <th style="' + (hierarchyHtml == "" ? "display:none" : "") + '"><span data-trans-key="ابعاد (ستون‌های رشته‌ای)" > </span> </th>                                             <th style="' + (ProvisionHtml == "" ? "display:none" : "") + '"><span data-trans-key="شرط" > </span></th>                                         </tr></thead>                                         <tr>                                             <td  style="' + (SeriesLevelHtml == "" ? "display:none" : "") + '"id="div-x" class="myc">' + SeriesLevelHtml + '</td>                                             <td  style="' + (hierarchyHtml == "" ? "display:none" : "") + '"id="div-y" class="myc">' + hierarchyHtml + '</td>                                             <td  style="' + (ProvisionHtml == "" ? "display:none" : "") + '"id="div-where" class="myc">' + ProvisionHtml + "</td>                                         </tr>                                     </table>";
                    filter.html(table);
                    function onChange() {
                        function sortDataHierarchies(data, index) {
                            var array = data[index];
                            var newAr = [];
                            filter.find("ul[index=" + index + "] li").each(function(i, d) {
                                var Uniquename = $(this).attr("value");
                                var item = $.grep(array, function(d) {
                                    return d.Uniquename == Uniquename;
                                })[0];
                                item.Members = $(this).data("members");
                                newAr.push(item);
                            });
                            data[index] = newAr;
                        }
                        sortDataHierarchies(data, "Hierarchies");
                        sortDataHierarchies(data, "Where");
                        sortDataHierarchies(data, "SeriesLevel");
                        var onFilterChange = function(data) {
                            opt.parameters = {
                                filterHierarchy: app.chartCommons.getFilterHierarchy(opt.ChartInPageId),
                                chartId: opt.chartId,
                                ChartInPageId: opt.ChartInPageId
                            };
                            $("#ID" + opt.ChartInPageId).charts({
                                id: opt.type,
                                isCustom: opt.isCustom
                            }, "refreshWithData", opt, {
                                refreshRelatedDatasources: false
                            });
                        };
                        onFilterChange(data);
                    }
                    filter.find(".filter-member-dialog").on("click", function() {
                        var el = $(this).parent();
                        var Uniquename = $(this).parent().attr("value");
                        var array = data[$(this).closest("ul").attr("index")];
                        var element = $.grep(array, function(d, i) {
                            return d.Uniquename == Uniquename;
                        })[0];
                        var members = $(this).parent().data("members");
                        var link = app.urlPrefix + "api/chartdata/GetMemberOfFilterHierarchy?Uniquename=" + Uniquename + "&Id=" + opt.chartId + "&ChartInPageId=" + opt.ChartInPageId;
                        if (typeof members == "undefined") {
                            $.ajax(link).done(function(d) {
                                $(this).parent().data("members", d);
                                showDialog(d, link);
                            });
                        } else {
                            showDialog(members, link);
                        }
                        function showDialog(members, link) {
                            app.helper.filterMemberDialog(members, link, function(mem) {
                                el.data("members", mem);
                                onChange();
                            });
                        }
                    });
                    filter.find(".sortable").sortable({
                        start: function(e, ui) {
                            ui.placeholder.addClass("filter-placeholder");
                            ui.placeholder.height(ui.item.height());
                            ui.placeholder.width(ui.item.width());
                            ui.placeholder.parent().width(ui.item.width());
                            ui.placeholder.parent().parent().width(ui.item.width());
                        },
                        stop: function(e, ui) {
                            onChange();
                        }
                    });
                    app.lang.setLang({
                        selector: filter.selector
                    });
                });
            }
        });
        div.find(".dropdown").lazyDropdown({
            onShow: function(e, i) {
                div.find(".menu-bar").addClass("show-dropdown");
            },
            onHide: function(e, i) {
                div.find(".menu-bar").removeClass("show-dropdown");
            }
        });
        this.showEmptyMessageIfNeed();
    },
    showEmptyMessageIfNeed: function() {
        if (dashboard.charts.length == 0) {
            if ($("#chart-empty-message").hasClass("hidden")) $("#chart-empty-message").transition("scale in");
        } else {
            if (!$("#chart-empty-message").hasClass("hidden")) $("#chart-empty-message").transition("scale out");
        }
    },
    deleteChart: function(cId, chartId, deletePermission) {
        if (cId) {
            if (deletePermission) $("#deleteChart .checkbox").show(); else $("#deleteChart .checkbox").hide();
            $("#deleteChart").data("cId", cId);
            $("#deleteChart").data("chartId", chartId);
            $("#deleteChart").modal("show");
        } else {
            var cId = $("#deleteChart").data("cId");
            var chartId = $("#deleteChart").data("chartId");
            var removeChartLink = app.urlPrefix + "charts/dashboardPage/removeChartFromPage";
            $("#deleteChart .action-btn").addClass("loading");
            $.post(removeChartLink, {
                ChartInPageId: cId,
                pageId: dashboard.pageId
            }, function(data) {
                if (data == false) {
                    alert("شما مجوز پاک کردن این نمودار را ندارید");
                    return;
                }
                var id;
                for (var i = 0; i < dashboard.charts.length; i++) {
                    if (dashboard.charts[i].pageId == cId) {
                        id = dashboard.charts[i].pageId;
                        dashboard.charts.splice(i, 1);
                        var d = "df";
                    }
                }
                dashboard.deleteChartFromGs("#ID" + id, function() {
                    $(this).remove();
                    dashboard.showEmptyMessageIfNeed();
                });
                $("#deleteChart").modal("hide");
                $("#deleteChart .action-btn").removeClass("loading");
            });
            var deletePermanent = $("#delete-from-dash").prop("checked");
            if (deletePermanent) {
                $.post(app.urlPrefix + "Moderation/Charts/DeleteCharts", {
                    Ids: [ "ChartId-" + chartId ]
                }, function(data) {});
            }
        }
    },
    deleteForm: function(id) {
        $("body").trigger("delete-form", [ id, dashboard.pageId ]);
    },
    setReturnUrl: function(id) {
        localStorage.setItem("returnUrl", window.location.href);
        localStorage.setItem("lastEditedChartId", id);
    },
    getChartTemplate: function(arrangePer, EditPermission, editLink, removeLink, needFilterIcon, title, id, lastRefresh, desc, CanExportXlsx, isCobmo, config) {
        return '<div class="ui card">  <div class="content" style="">    <div class="header ' + (arrangePer ? "move" : "") + '" style="position:absolute; width:50%;z-index:2;">&nbsp;</div><div class="title' + (config.noTitle === true ? " no-title " : arrangePer ? " move" : "") + '">            <div class="menu-bar" style="zz-index:1;">                <i class="icon titlebar-icon" style="xbackground: #fff;width: 100%;position: absolute;display: block;top: 0;height: 100%;"></i>                ' + (!app.mobileMode ? '<div class="ui dropdown" >                        <i class="setting icon chart-setting-icon titlebar-icon"></i>                        <div class=" menu transition hidden" tabindex="-1">                          ' + (EditPermission ? ' <a class="item"  href="' + editLink + '" onclick="dashboard.setReturnUrl(\'' + id + '\')"><span data-trans-key="ویرایش" > </span> <i class="edit outline icon"></i></a>' : "") + "                          " + (EditPermission ? ' <a class="item clone-chart"><span data-trans-key="تکرار" > </span> <i class="clone outline icon"></i></a>' : "") + "                          " + (arrangePer ? '<a class="item" href="' + removeLink + '"><span data-trans-key="حذف نمودار از صفحه" > </span> <i class="trash alternate outline icon"></i></a>' : "") + "                          " + (CanExportXlsx ? '<a class="item export-excel"><span data-trans-key="خروجی اکسل" > </span> <i class="file excel outline icon"></i></a>' : "") + "                          " + (CanExportXlsx ? '<a class="item export-png"><span data-trans-key="export png"> </span> <i class="camera icon"></i></a>' : "") + "                          " + (needFilterIcon ? '<a class="item refresh-chart">' + app.lang.translate("data refresh") + ' <i class="refresh icon"></i></a>' : "") + "                          " + (CanExportXlsx ? '<a class="item export-print"><span data-trans-key="print" > </span> <i class="print icon"></i></a>' : "") + '                        </div>                </div>                <div class=" ">                    ' + (!needFilterIcon ? "" : '<i class="info icon chart-setting-icon show-extra-info pointer titlebar-icon"></i>') + "                    " + (!needFilterIcon || isCobmo ? "" : '<i class="filter icon chart-setting-icon show-chart-dimensions pointer titlebar-icon"></i>') + "                    " + (!needFilterIcon || !app.commentOnChart ? "" : '<i class="comments icon chart-setting-icon show-chart-comments pointer titlebar-icon"></i>') + "                </div>" : !needFilterIcon ? "" : '<i class="info icon chart-setting-icon show-extra-info pointer titlebar-icon"></i>') + "            </div>        " + (config.noTitle === true ? "" : '<span class="title-content"></span>') + '    </div>    <div class="description chart-data bar-chart" id="' + id + '">      <div class="ui active inverted dimmer ">        <div class="ui text loader mini">' + '</div>      </div>    </div>  </div>  <div class="progress-overall"></div>  <div class="chart-dimentions"></div>  <div class="chart-dimentions-content"></div>  <div class="ui dimmer overflow-auto" style="padding:10px;border-radius: ' + (app.mobileMode ? "0" : "4") + 'px !important;"><div class="content"><div class="center"><div class="dimmer-info"><b>' + app.lang.translate("lastUpdate") + ':</b> <span class="last-refresh"> ' + '</span><div class="desc-content">' + "</div></div></div></div></div></div>";
    },
    getFormTemplate: function(arrangePer, EditPermission, editLink, removeLink, needFilterIcon, title, id, lastRefresh, desc, CanExportXlsx) {
        return '<div class="ui card ">  <div class="content" style="">    <div class="header ' + (arrangePer ? "move" : "") + '">            <div class="menu-bar ">                ' + (!arrangePer && !EditPermission ? "" : '<div class="ui dropdown" >                        <i class="setting icon chart-setting-icon"></i>                        <div class=" menu transition hidden" tabindex="-1">                          ' + (EditPermission ? ' <a class="item"  href="' + editLink + '" onclick="dashboard.setReturnUrl(\'' + id + '\')"><span data-trans-key="ویرایش" > </span> <i class="edit icon"></i></a>' : "") + "                          " + (arrangePer ? '<a class="item" href="' + removeLink + '"><span data-trans-key="حذف" > </span> <i class="trash alternate outline icon"></i></a>' : "") + "                                                   </div>                </div>") + '                <div class="">                   <i xclass="info icon chart-setting-icon show-extra-info pointer"></i>                </div>            </div>        <span class="title-content"></span>    </div>    <div class="description form-content " id="' + id + '">      <div class="ui active inverted dimmer ">        <div class="ui text loader tiny">' + app.lang.translate("در حال بارگذاری") + '</div>      </div>    </div>  </div>  <div class="progress-overall"></div>  <div class="chart-dimentions"></div>  <div class="chart-dimentions-content"></div>  <div class="ui dimmer overflow-auto" style="padding:10px;border-radius: 4px !important;"><div class="content"><div class="center"><div class="dimmer-info desc-content"></div></div></div></div></div>';
    },
    setLastRefresh: function(chartInPageId, lastRefresh) {
        var e = $(".cid" + chartInPageId + " .last-refresh");
        e.html(app.chartCommons.lastRefreshDateFormat(lastRefresh));
    }
};

angular.module("uibCollapseCat", []).directive("uibCollapse", [ "$animate", "$q", "$parse", "$injector", function($animate, $q, $parse, $injector) {
    var $animateCss = $injector.has("$animateCss") ? $injector.get("$animateCss") : null;
    return {
        link: function(scope, element, attrs) {
            var expandingExpr = $parse(attrs.expanding), expandedExpr = $parse(attrs.expanded), collapsingExpr = $parse(attrs.collapsing), collapsedExpr = $parse(attrs.collapsed);
            if (!scope.$eval(attrs.uibCollapse)) {
                element.addClass("in").addClass("collapse").attr("aria-expanded", true).attr("aria-hidden", false).css({
                    height: "auto"
                });
            }
            function expand() {
                if (element.hasClass("collapse") && element.hasClass("in")) {
                    return;
                }
                $q.resolve(expandingExpr(scope)).then(function() {
                    element.removeClass("collapse").addClass("collapsing").attr("aria-expanded", true).attr("aria-hidden", false);
                    if ($animateCss) {
                        $animateCss(element, {
                            addClass: "in",
                            easing: "ease",
                            to: {
                                height: element[0].scrollHeight + "px"
                            }
                        }).start()["finally"](expandDone);
                    } else {
                        $animate.addClass(element, "in", {
                            to: {
                                height: element[0].scrollHeight + "px"
                            }
                        }).then(expandDone);
                    }
                });
            }
            function expandDone() {
                element.removeClass("collapsing").addClass("collapse").css({
                    height: "auto"
                });
                expandedExpr(scope);
            }
            function collapse() {
                if (!element.hasClass("collapse") && !element.hasClass("in")) {
                    return collapseDone();
                }
                $q.resolve(collapsingExpr(scope)).then(function() {
                    element.css({
                        height: element[0].scrollHeight + "px"
                    }).removeClass("collapse").addClass("collapsing").attr("aria-expanded", false).attr("aria-hidden", true);
                    if ($animateCss) {
                        $animateCss(element, {
                            removeClass: "in",
                            to: {
                                height: "0"
                            }
                        }).start()["finally"](collapseDone);
                    } else {
                        $animate.removeClass(element, "in", {
                            to: {
                                height: "0"
                            }
                        }).then(collapseDone);
                    }
                });
            }
            function collapseDone() {
                element.css({
                    height: "0"
                });
                element.removeClass("collapsing").addClass("collapse");
                collapsedExpr(scope);
            }
            scope.$watch(attrs.uibCollapse, function(shouldCollapse) {
                if (shouldCollapse) {
                    collapse();
                } else {
                    expand();
                }
            });
        }
    };
} ]);

var manageApp = angular.module("management", [ "sadafForms", "ngRoute", "ngMaterial", "ngAnimate", "ngMessages", "datasourceScheduleCat", "datasourcePartitionExpressionCat", "pascalprecht.translate", "ngSanitize", "mdColorPicker", "ui.ace", "ui.sortable", "uibCollapseCat", "textAngular", "ngQuill", "services" ]);

manageApp.config([ "$locationProvider", function($locationProvider) {
    $locationProvider.hashPrefix("");
} ]);

manageApp.config([ "ngQuillConfigProvider", function(ngQuillConfigProvider) {
    var Size = Quill.import("attributors/style/size");
    Size.whitelist = [ "12px", "14px", "16px", "18px", "20px", "24px", "28px", "32px", "38px", "48px", "72px" ];
    Quill.register(Size, true);
    ngQuillConfigProvider.set({
        modules: {
            toolbar: [ [ {
                header: [ 1, 2, false ]
            }, "bold", "italic", "underline", "strike", {
                size: [ "12px", "14px", "16px", "18px", "20px", "24px", "28px", "32px", "38px", "48px", "72px" ]
            }, {
                direction: "rtl"
            }, {
                align: []
            }, {
                color: []
            }, {
                background: []
            }, "clean" ] ]
        },
        placeholder: "Compose an epic...",
        theme: "snow"
    });
} ]);

manageApp.config([ "$provide", function($provide) {} ]);

manageApp.config([ "$mdThemingProvider", function($mdThemingProvider) {
    $mdThemingProvider.theme("default").primaryPalette("blue").accentPalette("indigo").warnPalette("red").backgroundPalette("grey");
    $mdThemingProvider.theme("t1").primaryPalette("grey").accentPalette("red").warnPalette("red").backgroundPalette("grey");
} ]);

manageApp.config([ "$translateProvider", function($translateProvider) {
    $translateProvider.useStaticFilesLoader({
        prefix: app.urlPrefix + "dist/locales/locale-",
        suffix: ".js?v=" + app.version
    });
    $translateProvider.preferredLanguage("fa");
    $translateProvider.useSanitizeValueStrategy("sanitizeParameters");
} ]);

manageApp.factory("httpResponseInterceptor", [ "$q", "$rootScope", "$location", function($q, $rootScope, $location) {
    return {
        responseError: function(rejection) {
            if (rejection.status === 401) {
                alert("مهلت اعتبار ارتباط شما با سایت پایان یافته، لطفا دوباره وارد شوید");
                document.location = "/account/login";
            }
            return $q.reject(rejection);
        }
    };
} ]);

manageApp.config([ "$httpProvider", function($httpProvider) {
    $httpProvider.interceptors.push("httpResponseInterceptor");
    var xsrf = $("input[name=__RequestVerificationToken]").val();
    $httpProvider.defaults.headers.post["__RequestVerificationToken"] = xsrf;
} ]);

manageApp.config([ "$provide", function($provide) {
    $provide.decorator("taOptions", [ "$delegate", function(taOptions) {
        taOptions.forceTextAngularSanitize = true;
        taOptions.toolbar = [ [ "h1", "h2", "h3", "h4", "h5", "h6", "p", "pre", "quote" ], [ "bold", "italics", "underline", "ul", "ol", "redo", "undo", "clear" ], [ "justifyLeft", "justifyCenter", "justifyRight", "justifyFull" ] ];
        taOptions.classes = {
            focussed: "focussed",
            toolbar: "btn-toolbar",
            toolbarGroup: "btn-group",
            toolbarButton: "btn btn-default",
            toolbarButtonActive: "active",
            disabled: "disabled",
            textEditor: "form-control",
            htmlEditor: "form-control"
        };
        return taOptions;
    } ]);
} ]);

var service = [ "$http", "$interval", function($http, $interval) {
    var looper;
    return {
        start: function() {},
        stop: function() {
            $interval.cancel(looper);
        }
    };
} ];

try {
    var sadaf = angular.module("sadaf");
    sadaf.factory("heartBeat", service);
    sadaf.run([ "heartBeat", function(heartBeat) {
        if (!app.mobileMode) heartBeat.start();
    } ]);
} catch (e) {}

try {
    var management = angular.module("management");
    management.factory("heartBeat", service);
    management.run([ "heartBeat", function(heartBeat) {
        if (!app.mobileMode) heartBeat.start();
    } ]);
} catch (e) {}

angular.module("ui.mask", []).value("uiMaskConfig", {
    maskDefinitions: {
        "2": /[0,1,2]/,
        "6": /[0,1,2,3,4,5,6]/,
        "9": /\d/,
        A: /[a-zA-Z]/,
        "*": /[a-zA-Z0-9]/
    },
    clearOnBlur: true
}).directive("uiMask", [ "uiMaskConfig", "$parse", function(maskConfig, $parse) {
    "use strict";
    return {
        priority: 100,
        require: "ngModel",
        restrict: "A",
        compile: function uiMaskCompilingFunction() {
            var options = maskConfig;
            return function uiMaskLinkingFunction(scope, iElement, iAttrs, controller) {
                var maskProcessed = false, eventsBound = false, maskCaretMap, maskPatterns, maskPlaceholder, maskComponents, minRequiredLength, value, valueMasked, isValid, originalPlaceholder = iAttrs.placeholder, originalMaxlength = iAttrs.maxlength, oldValue, oldValueUnmasked, oldCaretPosition, oldSelectionLength;
                function initialize(maskAttr) {
                    if (!angular.isDefined(maskAttr)) {
                        return uninitialize();
                    }
                    processRawMask(maskAttr);
                    if (!maskProcessed) {
                        return uninitialize();
                    }
                    initializeElement();
                    bindEventListeners();
                    return true;
                }
                function initPlaceholder(placeholderAttr) {
                    if (!angular.isDefined(placeholderAttr)) {
                        return;
                    }
                    maskPlaceholder = placeholderAttr;
                    if (maskProcessed) {
                        eventHandler();
                    }
                }
                function formatter(fromModelValue) {
                    if (!maskProcessed) {
                        return fromModelValue;
                    }
                    value = unmaskValue(fromModelValue || "");
                    isValid = validateValue(value);
                    controller.$setValidity("mask", isValid);
                    return isValid && value.length ? maskValue(value) : undefined;
                }
                function parser(fromViewValue) {
                    if (!maskProcessed) {
                        return fromViewValue;
                    }
                    value = unmaskValue(fromViewValue || "");
                    isValid = validateValue(value);
                    controller.$viewValue = value.length ? maskValue(value) : "";
                    controller.$setValidity("mask", isValid);
                    if (value === "" && iAttrs.required) {
                        controller.$setValidity("required", !controller.$error.required);
                    }
                    return isValid ? value : undefined;
                }
                var linkOptions = {};
                if (iAttrs.uiOptions) {
                    linkOptions = scope.$eval("[" + iAttrs.uiOptions + "]");
                    if (angular.isObject(linkOptions[0])) {
                        linkOptions = function(original, current) {
                            for (var i in original) {
                                if (Object.prototype.hasOwnProperty.call(original, i)) {
                                    if (current[i] === undefined) {
                                        current[i] = angular.copy(original[i]);
                                    } else {
                                        angular.extend(current[i], original[i]);
                                    }
                                }
                            }
                            return current;
                        }(options, linkOptions[0]);
                    }
                } else {
                    linkOptions = options;
                }
                iAttrs.$observe("uiMask", initialize);
                iAttrs.$observe("placeholder", initPlaceholder);
                var modelViewValue = false;
                iAttrs.$observe("modelViewValue", function(val) {
                    if (val === "true") {
                        modelViewValue = true;
                    }
                });
                scope.$watch(iAttrs.ngModel, function(val) {
                    if (modelViewValue && val) {
                        var model = $parse(iAttrs.ngModel);
                        model.assign(scope, controller.$viewValue);
                    }
                });
                controller.$formatters.push(formatter);
                controller.$parsers.push(parser);
                function uninitialize() {
                    maskProcessed = false;
                    unbindEventListeners();
                    if (angular.isDefined(originalPlaceholder)) {
                        iElement.attr("placeholder", originalPlaceholder);
                    } else {
                        iElement.removeAttr("placeholder");
                    }
                    if (angular.isDefined(originalMaxlength)) {
                        iElement.attr("maxlength", originalMaxlength);
                    } else {
                        iElement.removeAttr("maxlength");
                    }
                    iElement.val(controller.$modelValue);
                    controller.$viewValue = controller.$modelValue;
                    return false;
                }
                function initializeElement() {
                    value = oldValueUnmasked = unmaskValue(controller.$viewValue || "");
                    valueMasked = oldValue = maskValue(value);
                    isValid = validateValue(value);
                    var viewValue = isValid && value.length ? valueMasked : "";
                    if (iAttrs.maxlength) {
                        iElement.attr("maxlength", maskCaretMap[maskCaretMap.length - 1] * 2);
                    }
                    iElement.attr("placeholder", maskPlaceholder);
                    iElement.val(viewValue);
                    controller.$viewValue = viewValue;
                }
                function bindEventListeners() {
                    if (eventsBound) {
                        return;
                    }
                    iElement.bind("blur", blurHandler);
                    iElement.bind("mousedown mouseup", mouseDownUpHandler);
                    iElement.bind("input keyup click focus", eventHandler);
                    eventsBound = true;
                }
                function unbindEventListeners() {
                    if (!eventsBound) {
                        return;
                    }
                    iElement.unbind("blur", blurHandler);
                    iElement.unbind("mousedown", mouseDownUpHandler);
                    iElement.unbind("mouseup", mouseDownUpHandler);
                    iElement.unbind("input", eventHandler);
                    iElement.unbind("keyup", eventHandler);
                    iElement.unbind("click", eventHandler);
                    iElement.unbind("focus", eventHandler);
                    eventsBound = false;
                }
                function validateValue(value) {
                    return value.length ? value.length >= minRequiredLength : true;
                }
                function unmaskValue(value) {
                    var valueUnmasked = "", maskPatternsCopy = maskPatterns.slice();
                    value = value.toString();
                    angular.forEach(maskComponents, function(component) {
                        value = value.replace(component, "");
                    });
                    angular.forEach(value.split(""), function(chr) {
                        if (maskPatternsCopy.length && maskPatternsCopy[0].test(chr)) {
                            valueUnmasked += chr;
                            maskPatternsCopy.shift();
                        }
                    });
                    return valueUnmasked;
                }
                function maskValue(unmaskedValue) {
                    var valueMasked = "", maskCaretMapCopy = maskCaretMap.slice();
                    angular.forEach(maskPlaceholder.split(""), function(chr, i) {
                        if (unmaskedValue.length && i === maskCaretMapCopy[0]) {
                            valueMasked += unmaskedValue.charAt(0) || "_";
                            unmaskedValue = unmaskedValue.substr(1);
                            maskCaretMapCopy.shift();
                        } else {
                            valueMasked += chr;
                        }
                    });
                    return valueMasked;
                }
                function getPlaceholderChar(i) {
                    var placeholder = iAttrs.placeholder;
                    if (typeof placeholder !== "undefined" && placeholder[i]) {
                        return placeholder[i];
                    } else {
                        return "_";
                    }
                }
                function getMaskComponents() {
                    return maskPlaceholder.replace(/[_]+/g, "_").replace(/([^_]+)([a-zA-Z0-9])([^_])/g, "$1$2_$3").split("_");
                }
                function processRawMask(mask) {
                    var characterCount = 0;
                    maskCaretMap = [];
                    maskPatterns = [];
                    maskPlaceholder = "";
                    if (typeof mask === "string") {
                        minRequiredLength = 0;
                        var isOptional = false, numberOfOptionalCharacters = 0, splitMask = mask.split("");
                        angular.forEach(splitMask, function(chr, i) {
                            if (linkOptions.maskDefinitions[chr]) {
                                maskCaretMap.push(characterCount);
                                maskPlaceholder += getPlaceholderChar(i - numberOfOptionalCharacters);
                                maskPatterns.push(linkOptions.maskDefinitions[chr]);
                                characterCount++;
                                if (!isOptional) {
                                    minRequiredLength++;
                                }
                            } else if (chr === "?") {
                                isOptional = true;
                                numberOfOptionalCharacters++;
                            } else {
                                maskPlaceholder += chr;
                                characterCount++;
                            }
                        });
                    }
                    maskCaretMap.push(maskCaretMap.slice().pop() + 1);
                    maskComponents = getMaskComponents();
                    maskProcessed = maskCaretMap.length > 1 ? true : false;
                }
                function blurHandler() {
                    if (linkOptions.clearOnBlur) {
                        oldCaretPosition = 0;
                        oldSelectionLength = 0;
                        if (!isValid || value.length === 0) {
                            valueMasked = "";
                            iElement.val("");
                            scope.$apply(function() {
                                controller.$setViewValue("");
                            });
                        }
                    }
                }
                function mouseDownUpHandler(e) {
                    if (e.type === "mousedown") {
                        iElement.bind("mouseout", mouseoutHandler);
                    } else {
                        iElement.unbind("mouseout", mouseoutHandler);
                    }
                }
                iElement.bind("mousedown mouseup", mouseDownUpHandler);
                function mouseoutHandler() {
                    oldSelectionLength = getSelectionLength(this);
                    iElement.unbind("mouseout", mouseoutHandler);
                }
                function eventHandler(e) {
                    e = e || {};
                    var eventWhich = e.which, eventType = e.type;
                    if (eventWhich === 16 || eventWhich === 91) {
                        return;
                    }
                    var val = iElement.val(), valOld = oldValue, valMasked, valUnmasked = unmaskValue(val), valUnmaskedOld = oldValueUnmasked, valAltered = false, caretPos = getCaretPosition(this) || 0, caretPosOld = oldCaretPosition || 0, caretPosDelta = caretPos - caretPosOld, caretPosMin = maskCaretMap[0], caretPosMax = maskCaretMap[valUnmasked.length] || maskCaretMap.slice().shift(), selectionLenOld = oldSelectionLength || 0, isSelected = getSelectionLength(this) > 0, wasSelected = selectionLenOld > 0, isAddition = val.length > valOld.length || selectionLenOld && val.length > valOld.length - selectionLenOld, isDeletion = val.length < valOld.length || selectionLenOld && val.length === valOld.length - selectionLenOld, isSelection = eventWhich >= 37 && eventWhich <= 40 && e.shiftKey, isKeyLeftArrow = eventWhich === 37, isKeyBackspace = eventWhich === 8 || eventType !== "keyup" && isDeletion && caretPosDelta === -1, isKeyDelete = eventWhich === 46 || eventType !== "keyup" && isDeletion && caretPosDelta === 0 && !wasSelected, caretBumpBack = (isKeyLeftArrow || isKeyBackspace || eventType === "click") && caretPos > caretPosMin;
                    oldSelectionLength = getSelectionLength(this);
                    if (isSelection || isSelected && (eventType === "click" || eventType === "keyup")) {
                        return;
                    }
                    if (eventType === "input" && isDeletion && !wasSelected && valUnmasked === valUnmaskedOld) {
                        while (isKeyBackspace && caretPos > caretPosMin && !isValidCaretPosition(caretPos)) {
                            caretPos--;
                        }
                        while (isKeyDelete && caretPos < caretPosMax && maskCaretMap.indexOf(caretPos) === -1) {
                            caretPos++;
                        }
                        var charIndex = maskCaretMap.indexOf(caretPos);
                        valUnmasked = valUnmasked.substring(0, charIndex) + valUnmasked.substring(charIndex + 1);
                        valAltered = true;
                    }
                    valMasked = maskValue(valUnmasked);
                    oldValue = valMasked;
                    oldValueUnmasked = valUnmasked;
                    iElement.val(valMasked);
                    if (valAltered) {
                        scope.$apply(function() {
                            controller.$setViewValue(valUnmasked);
                        });
                    }
                    if (isAddition && caretPos <= caretPosMin) {
                        caretPos = caretPosMin + 1;
                    }
                    if (caretBumpBack) {
                        caretPos--;
                    }
                    caretPos = caretPos > caretPosMax ? caretPosMax : caretPos < caretPosMin ? caretPosMin : caretPos;
                    while (!isValidCaretPosition(caretPos) && caretPos > caretPosMin && caretPos < caretPosMax) {
                        caretPos += caretBumpBack ? -1 : 1;
                    }
                    if (caretBumpBack && caretPos < caretPosMax || isAddition && !isValidCaretPosition(caretPosOld)) {
                        caretPos++;
                    }
                    oldCaretPosition = caretPos;
                    setCaretPosition(this, caretPos);
                }
                function isValidCaretPosition(pos) {
                    return maskCaretMap.indexOf(pos) > -1;
                }
                function getCaretPosition(input) {
                    if (!input) return 0;
                    if (input.selectionStart !== undefined) {
                        return input.selectionStart;
                    } else if (document.selection) {
                        input.focus();
                        var selection = document.selection.createRange();
                        selection.moveStart("character", input.value ? -input.value.length : 0);
                        return selection.text.length;
                    }
                    return 0;
                }
                function setCaretPosition(input, pos) {
                    if (!input) return 0;
                    if (input.offsetWidth === 0 || input.offsetHeight === 0) {
                        return;
                    }
                    if (input.setSelectionRange) {
                        input.focus();
                        input.setSelectionRange(pos, pos);
                    } else if (input.createTextRange) {
                        var range = input.createTextRange();
                        range.collapse(true);
                        range.moveEnd("character", pos);
                        range.moveStart("character", pos);
                        range.select();
                    }
                }
                function getSelectionLength(input) {
                    if (!input) return 0;
                    if (input.selectionStart !== undefined) {
                        return input.selectionEnd - input.selectionStart;
                    }
                    if (document.selection) {
                        return document.selection.createRange().text.length;
                    }
                    return 0;
                }
                if (!Array.prototype.indexOf) {
                    Array.prototype.indexOf = function(searchElement) {
                        if (this === null) {
                            throw new TypeError();
                        }
                        var t = Object(this);
                        var len = t.length >>> 0;
                        if (len === 0) {
                            return -1;
                        }
                        var n = 0;
                        if (arguments.length > 1) {
                            n = Number(arguments[1]);
                            if (n !== n) {
                                n = 0;
                            } else if (n !== 0 && n !== Infinity && n !== -Infinity) {
                                n = (n > 0 || -1) * Math.floor(Math.abs(n));
                            }
                        }
                        if (n >= len) {
                            return -1;
                        }
                        var k = n >= 0 ? n : Math.max(len - Math.abs(n), 0);
                        for (;k < len; k++) {
                            if (k in t && t[k] === searchElement) {
                                return k;
                            }
                        }
                        return -1;
                    };
                }
            };
        }
    };
} ]);

var ngApp = angular.module("management");

ngApp.directive("menuContainer", function() {
    return {
        restrict: "E",
        transclude: true,
        scope: {
            openMenuName: "="
        },
        controller: [ "$scope", function($scope) {
            var menus = $scope.menus = [];
            if ($scope.openMenuName) $scope.openMenuName.set = function(name) {
                _.forEach(menus, function(m) {
                    if (m.name == name) {
                        m.header.click(true);
                    }
                });
            };
            $scope.select = function(menu) {
                angular.forEach(menus, function(menu) {
                    menu.selected = false;
                });
                menu.selected = true;
            };
            this.addMenu = function(menu) {
                menu.header.click = function(forceOpen) {
                    var t = menu.header.isOpen;
                    if (forceOpen) {
                        t = false;
                    }
                    _.forEach(menus, function(m) {
                        m.header.isOpen = false;
                        m.body.isOpen = false;
                    });
                    menu.header.isOpen = !t;
                    menu.body.isOpen = !t;
                };
                menus.push(menu);
            };
        } ],
        template: "<div ng-transclude ></div>"
    };
}).directive("menuItem", function() {
    return {
        require: "^^menuContainer",
        restrict: "E",
        transclude: true,
        scope: {
            name: "@"
        },
        link: function(scope, element, attrs, tabsCtrl) {
            tabsCtrl.addMenu(scope);
        },
        controller: [ "$scope", function($scope) {
            $scope.select = function() {};
            this.addHeader = function(h) {
                $scope.header = h;
            };
            this.addBody = function(b) {
                $scope.body = b;
            };
        } ],
        template: "<div ng-transclude></div><md-divider></md-divider>"
    };
}).directive("menuHeader", function() {
    return {
        require: "^^menuItem",
        restrict: "E",
        transclude: true,
        scope: {},
        link: function(scope, element, attrs, tabsCtrl) {
            tabsCtrl.addHeader(scope);
        },
        controller: [ "$scope", function($scope) {} ],
        template: '<md-list-item class="md-no-sticky pointer header" ng-click="click()" ng-class="{active: isOpen}">               <div layout="row" flex layout-align="start center">                                                                  <div ng-transclude style="display:inline-block"> </div>                                                          <span flex></span>                                                                                               <span class="material-icons icon-animate " ng-click="click()" ng-class="{rotate : isOpen}">keyboard_arrow_down</span>             </div>                                                                                                       </md-list-item>'
    };
}).directive("menuBody", function() {
    return {
        restrict: "E",
        require: "^^menuItem",
        transclude: true,
        scope: {},
        link: function(scope, element, attrs, menuItem) {
            menuItem.addBody(scope);
        },
        template: '<div uib-collapse="!isOpen"><div class="menu-body-container" ng-transclude></div></div>'
    };
}).directive("switchButton", function() {
    return {
        restrict: "E",
        transclude: true,
        scope: {
            ngModel: "="
        },
        template: '<div style="display:inline-block" class="switch-button" ng-click="ngModel = !ngModel" ng-class="{ active : ngModel}"><div ng-transclude style="display:inline-block"></div></div>'
    };
}).directive("sadafIndicator", function() {
    return {
        restrict: "E",
        transclude: true,
        scope: {
            model: "=ngModel",
            series: "=",
            onChange: "&ngChange",
            hideThen: "@"
        },
        controller: [ "$scope", "$translate", function($scope, $translate) {
            var model = $scope.model;
            var st = $scope.hideThen;
            model.ifRow = model.ifRow || [ {} ];
            model.thenRow = model.thenRow || [ {} ];
            _.each(model.thenRow, function(i) {
                i.iconModel = {
                    name: i.secondFieldIcon || "icon warning",
                    type: "icon"
                };
            });
            $scope.ops = [ {
                value: "1",
                name: "=="
            }, {
                value: "2",
                name: "!="
            }, {
                value: "3",
                name: "<"
            }, {
                value: "4",
                name: "<="
            }, {
                value: "5",
                name: ">"
            }, {
                value: "6",
                name: ">="
            }, {
                value: "7",
                name: "contain"
            }, {
                value: "8",
                name: "not_contain"
            } ];
            $scope.thenOps = [ {
                value: "1",
                name: "change_color"
            }, {
                value: "2",
                name: "add_icon"
            }, {
                value: "3",
                name: "change_back_color"
            }, {
                value: "4",
                name: "change_style"
            }, {
                value: "5",
                name: "replace"
            } ];
        } ],
        template: '<div>                                                                                                                                                         <div class="form-row layout-align-start-center layout-row" layout="row" layout-align="start center">                <label class= "col-sm-4" > نام شرط</label>                <span class="form-divider flex" flex=""></span>                <div class="col-sm-8">                    <input type="text" class="form-control ng-pristine ng-untouched ng-valid ng-not-empty" placeholder="نام شرط" ng-change="onChange()" ng-model-options="{ updateOn: \'blur\' }" ng-model="model.title" aria-invalid="false" style="">                </div></div>    <div ng-repeat="i in model.ifRow" class="form-row" xlayout="row" xlayout-align="start center">                                                                                                                      <select class="expression-select" ng-model="i.firstField" ng-options="s as s for s in series" ng-change="onChange()"></select>                                                                 <select class="expression-select" style="direction: ltr;" ng-model="i.operand" ng-options="s.value as (s.name | translate) for s in ops" ng-change="onChange()"></select>                                                ' + '<div ng-click="i.secondFieldIsText = !i.secondFieldIsText" ng-class="{\'active\' : i.secondFieldIsText}" class="ui mini icon basic compact button"><i class="ui icon terminal"></i></div>' + "        " + '        <select class="expression-select" ng-model="i.secondFieldSelect" ng-options="s as s for s in series" ng-show="!i.secondFieldIsText" ng-change="onChange()"></select>                           <input ng-model="i.secondFieldInput" type="text" ng-show="i.secondFieldIsText"  ng-change="onChange()"/>                                                             <span xclass="ui mini basic compact icon button" ng-click="model.ifRow.splice( $index+1, 0, {})"><i class="ui tiny icon pointer plus"></i></span>                                                                                                     <span xclass="ui mini basic compact icon button" ng-click="model.ifRow.splice($index, 1); onChange()" ng-show="model.ifRow.length > 1"><i class="ui tiny icon pointer minus"></i></span>                             </div>                                                                                                                                                               <div ng-repeat="i in model.thenRow" ng-hide="hideThen" class="form-row" layout="row" layout-align="start center">                                                                           <span ng-show="model.thenRow.length > 1 && !$first">{{ \'and\' | translate }}</span>                                                                                 <span>{{ \'then\' | translate }}</span>                                                                                                                              <select style="max-width:60px" ng-model="i.firstField" ng-options="s as s for s in series" ng-change="onChange()"></select>                                                                 <select style="xmax-width:60px" ng-model="i.operand" ng-options="s.value as (s.name | translate) for s in thenOps" ng-change="onChange()"></select>                                                                                                                                                                                                                 <span style="margin-left:3px;" md-color-picker ng-model="i.secondFieldColor" ng-show="i.operand == 1" md-color-default-tab="\'genericPalette\'"  on-change="onChange()"></span>               <span style="margin-left:3px;" md-color-picker ng-model="i.secondFieldBackColor" ng-show="i.operand == 3" md-color-default-tab="\'genericPalette\'" on-change="onChange()"></span>            <select ng-show="i.operand == 4" ng-model="i.secondFieldStyle" ng-change="onChange()" ng-options="i.name as  i.value for i in [                                    {name:\'1\', value: \'normal\'  },                                     {name:\'2\', value: \'bold\'  },                                      {name:\'3\', value: \'italic\'  },                                     {name:\'4\', value: \'bold_italic\'  },                                     {name:\'5\', value: \'underline\'  },                                 ]">                                                                               </select>                                                                                                                                                            <input ng-model="i.secondFieldReplace" type="text" ng-show="i.operand == 5" />                                                                                                                                                                                                                                                            <div ng-show="i.operand == 2">             <sadaf-icons ng-model="i.secondFieldIcon" ng-change="onChange()"></sadaf-icons>        </div>                      <span class="ui mini basic compact icon button" ng-click="model.thenRow.splice( $index+1, 0, {secondFieldIcon:{name:\'icon warning\', type:\'icon\'}})"><i class="icon plus"></i></span>                                                                                                     <span class="ui mini basic compact icon button" ng-click="model.thenRow.splice($index, 1); onChange()" ng-show="model.thenRow.length > 1"><i class="icon minus"></i></span>                              </div>                                                                                                                                                           </div>'
    };
}).directive("sadafContactList", function() {
    return {
        restrict: "E",
        transclude: true,
        scope: {
            model: "=ngModel"
        },
        controller: [ "$scope", function($scope) {
            $scope.model = $scope.model || [ {} ];
        } ],
        template: '<div class="ui tiny form">                                                                                                     <div ng-repeat="i in model" class="fields" >                                                              <div class="field"><input ng-model="i.phone" type="text"  placeholder="{{\'phone\' | translate}}"/></div>                       <div class="field"><input ng-model="i.email" type="text"  placeholder="{{\'email\' | translate}}"/></div>                       <div class="field">                        <i class="icon tiny plus pointer grey" ng-click="model.splice( $index+1, 0, {})"></i>                                                   <i class="icon tiny minus pointer grey" ng-click="model.splice($index, 1)" ng-show="model.length > 1"></i>                        </div>                </div>                                                                                             </div>'
    };
}).directive("sadafRemovable", function() {
    return {
        restrict: "E",
        transclude: true,
        scope: {
            onDelete: "&onDelete"
        },
        controller: [ "$scope", function($scope) {
            $scope.model = $scope.model || [ {} ];
        } ],
        template: '<div layout="row" layout-align="start center">                <span class ="material-icons small" ng-click="onDelete()">close</span>                <div ng-transclude></div>            </div>'
    };
}).directive("fileread", [ function() {
    return {
        scope: {
            fileread: "="
        },
        link: function(scope, element, attributes) {
            element.bind("change", function(changeEvent) {
                scope.$apply(function() {
                    scope.fileread = scope.fileread || {};
                    scope.fileread = changeEvent.target.files[0];
                });
            });
        }
    };
} ]).directive("xtree", function() {
    return {
        restrict: "E",
        transclude: true,
        scope: {
            root: "=ngModel",
            option: "=",
            url: "&"
        },
        controller: [ "$scope", "$http", "$translate", function($scope, $http, $translate) {
            $scope.root = $scope.root || {
                name: "root",
                open: true
            };
            $scope.active = function(u) {
                var temp = u.active;
                if (!$scope.option.multiple) {
                    doRecursive($scope.root, function(item) {
                        item.active = false;
                    });
                }
                u.active = temp;
            };
            $scope.selectAll = function(data, s) {
                _.each(data.contents, function(d) {
                    d.active = s;
                });
            };
            function doRecursive(e, callback) {
                callback(e);
                if (e.nodes) {
                    _.forEach(e.nodes, function(item) {
                        doRecursive(item, callback);
                    });
                    _.forEach(e.contents, function(item) {
                        doRecursive(item, callback);
                    });
                }
            }
        } ],
        template: '<div class ="sadaf-tree">                                                                                                                                    <div style="list-style:none" class ="tree-element ul">                                                                                                       <div ng-repeat="data in [root]" class ="tree-element li" ng-include="\'tree_item_renderer.html\'"></div>                                             </div>                                                                                                                                               </div>                                                                                                                                                                                                                                                                                                            <script type="text/ng-template" id="tree_item_renderer.html">                                                                                                <collapse class ="block" selectable-dir="option.selectableDir" ng-model="data"                                                                               hide-icon="{{(!data.nodes || !data.nodes.length ) && ( option.justDir || ( !data.contents || !data.contents.length) ) && data.loaded }}">                                                                                                                                                                         <collapse-header class ="block" ng-click="$event.stopPropagation(); option.url(data)">                                                                       <md-checkbox ng-show="option.selectableDir" ng-model="data.active"ng-change="active(data)" ng-click="$event.stopPropagation()"                                       style="margin:0">{{data.name}}</md-checkbox>                                                                                                 <span ng-show="!option.selectableDir">{{data.name}}</span>                                                                                           </collapse-header>                                                                                                                                                                                                                                                                                                <collapse-body class ="block">                                                                                                                               <div class ="tree-element ul" style="list-style:none" >                                                                                                      <div class="ui active dimmer inverted" style="position:inherit; display:inline" ng-show="!data.loaded">                     <div class="ui active mini inline text loader">                                                         </div>                                                                                                                                                                        </div>                                                                                                                                                                        <div ng-show="data.loaded" class ="tree-element li"><md-checkbox ng-show="option.multiple" ng-click="$event.stopPropagation()" ng-model="data.selectAll" ng-change="selectAll(data, data.selectAll)"><small> {{"select_all" | translate}} </small></md-checkbox></div>                                                                                                                                               <div ng-repeat="data in data.nodes" class ="tree-element li" ng-include="\'tree_item_renderer.html\'"></div>                                             <div ng-repeat="u in data.contents" class ="tree-element li" ng-class ="{active : u.active}" ng-hide="option.justDir">                                       <md-checkbox ng-model="u.active" ng-change="active(u)" style="margin-bottom:0">{{u.name}}</md-checkbox>                                              </div>                                                                                                                                               </div>                                                                                                                                               </collapse-body>                                                                                                                                                                                                                                                                                              </collapse>                                                                                                                                                                                                                                                                                                   </script>'
    };
}).directive("menuPermission", function() {
    return {
        restrict: "E",
        transclude: true,
        scope: {
            menus: "=",
            roles: "="
        },
        controller: [ "$scope", "$http", "$translate", function($scope, $http, $translate) {} ],
        template: '            <menu-item class="panel ">                <menu-header>{{ \'menus\' | translate }}</menu-header>                <menu-body>                    <div style="margin:0 20px">                                                              {{menus}}<collapse ng-repeat="(k,v) in menus">                                                                   <div layout="row">                                                                                             <collapse-header>                                                                                              {{k}}                                                                                                  </collapse-header>                                                                                         <span flex></span>                                                                                     </div>                                                                                                     <collapse-body>                                                                                                <div style="margin:0 20px">                                                                                <div ng-repeat="r in v" layout="row" layout-align="start center">                                              <md-checkbox ng-model="r.check">{{r.name}}</md-checkbox>                                                   <span flex></span>                                                                                                                                                                                                 </div>                                                                                                 </div>                                                                                                 </collapse-body>                                                                                       </collapse>                                                                                            </div>                                                                                         </menu-body>            </menu-item>            <menu-item class="panel ">                <menu-header>{{ \'datasources\' | translate }}</menu-header>                <menu-body>                    <datasource-permission ng-model="roles" class="block" type="chart" id="{{parent.id}}"></datasource-permission>                </menu-body>            </menu-item>'
    };
}).directive("legendPosition", function() {
    return {
        restrict: "E",
        transclude: true,
        scope: {
            model: "=ngModel",
            change: "&"
        },
        controller: [ "$scope", "$http", "$translate", function($scope, $http, $translate) {
            $scope.model = $scope.model || "top left";
        } ],
        template: '<div class="position-circles">                                                                                                                                                                                                                 <i ng-click="model=\'top left\';change()" ng-class="{active: model==\'top left\'}" class="icon circle" style="top:0;left:0"></i>                                            <i ng-click="model=\'top right\';change()" ng-class="{active: model==\'top right\'}" class="icon circle" style="top:0;right:0"></i>                                         <i ng-click="model=\'top center\';change()" ng-class="{active: model==\'top center\'}" class="icon circle" style="top:0;left:11px"></i>                                     <i ng-click="model=\'bottom left\';change()" ng-class="{active: model==\'bottom left\'}" class="icon circle" style="bottom:0;left:0"></i>                                   <i ng-click="model=\'bottom right\';change()" ng-class="{active: model==\'bottom right\'}" class="icon circle" style="bottom:0;right:0"></i>                                <i ng-click="model=\'bottom center\';change()" ng-class="{active: model==\'bottom center\'}" class="icon circle" style="bottom:0;left:11px"></i>                            <i ng-click="model=\'center right\';change()" ng-class="{active: model==\'center right\'}" class="icon circle" style="top:11px;right:0"></i>                                <i ng-click="model=\'center left\';change()" ng-class="{active: model==\'center left\'}" class="icon circle" style="top:11px;left:0"></i>                               </div>'
    };
}).directive("sdFormat", function() {
    return {
        restrict: "E",
        transclude: true,
        scope: {
            model: "=ngModel",
            change: "&ngChange"
        },
        controller: [ "$scope", "$http", "$translate", function($scope, $http, $translate) {
            $scope.model = $scope.model || ",.0f";
        } ],
        template: "<select ng-change=\"change()\" ng-model=\"model\"  ng-options=\"i.name as  i.value for i in [                                    {name:'A', value: 'عادی'  },                                                                                                                             {name:'.0%', value:'درصد' },                                                                                                                               {name:',.1%', value:'#,#.0%'},                                                                                                                           {name:',.2%', value:'#,#.00%'},                                                                                                                          {name:',.0f', value:'#,#'},                                                                                                                              {name:',.1f', value:'#,#.0'},                                                                                                                            {name:',.2f', value:'#,#.00'},                                                                                                                           {name:',.3s', value:'#,#K'},                                                                                                                             {name:'(,.0f', value:'(#,#)'},                                                                                                                             {name:'(,.1f', value:'(#,#.0)'},                                                                                                                             {name:'(,.2f', value:'(#,#.00)'},                                                                                                                             {name:'custom', value:'سفارشی' },                                                                                                                   ]\">"
    };
}).directive("sdTimeFunction", function() {
    return {
        restrict: "E",
        transclude: true,
        scope: {
            model: "=ngModel"
        },
        controller: [ "$scope", "$http", "$translate", function($scope, $http, $translate) {
            $scope.$watch("model", function(v) {
                if (!$scope.model || !$scope.model.variableDefaultFunction) $scope.model = _.extend({}, {
                    variableDefaultFunction: "MonthToDate",
                    functionDateFormat: "yy/mm/dd",
                    functionUnitAgo: 1,
                    functionUnitAgoOffset: "1",
                    functionUnitAgoTwo: 1,
                    functionUnitAgoTwoOffset: "1"
                }, v);
            });
        } ],
        templateUrl: app.urlPrefix + "dist/partial/management/charts/directives/types/timeFunction.html?v=" + app.version
    };
}).directive("intervalFetch", function() {
    return {
        restrict: "E",
        transclude: true,
        scope: {
            model: "=ngModel",
            fields: "=?",
            datasourceId: "@"
        },
        controller: [ "$scope", "$http", "$translate", "intervalFetchService", function($scope, $http, $translate, intervalFetchService) {
            var offset = 0;
            var count = 20;
            $scope.requests = [];
            $(".ui.dimmer.modals .interval-fetch-modal").remove();
            $scope.model = $scope.model || {
                dateType: "jalali-date"
            };
            function fixTime(d) {
                d.timex = moment.utc(d.time).fromNow();
                d.time = moment.utc(d.time).format("jYYYY/jMM/jDD HH:mm:ss");
            }
            function getReqs() {
                $scope.loadRequests = true;
                $scope.loadRequestsError = false;
                intervalFetchService.get($scope.datasourceId, offset, count).then(function(data) {
                    $scope.loadRequests = false;
                    _.each(data, function(d) {
                        fixTime(d);
                    });
                    $scope.requests = $scope.requests.concat(data);
                    _.each($scope.requests, function(item) {
                        item.duration = moment.duration(item.duration).format("h:mm:ss:SSS");
                    });
                    offset += data.length;
                    if (data.length < (count || 20)) $scope.noMore = true;
                }, function(res) {
                    $scope.loadRequests = false;
                    $scope.loadRequestsError = true;
                });
            }
            getReqs();
            $scope.more = function() {
                getReqs();
            };
            $scope.deleteAll = function() {
                var f = confirm("با حذف تمام درخواست‌ها، اطلاعات موجود در منبع داده نیز پاک می‌شوند. آیا برای حذف همه اطمینان دارید؟");
                if (f) {
                    $scope.deleteAllProgress = true;
                    intervalFetchService.deleteAll($scope.datasourceId).then(function() {
                        $scope.deleteAllProgress = false;
                        $scope.requests = null;
                    }, function() {
                        $scope.deleteAllProgress = false;
                    });
                }
            };
            $scope.addModel = {};
            $scope.addNew = function() {
                if (!$scope.addModel.addFrom || !$scope.addModel.addTo) {
                    alert("مقادیر شروع و پایان باید وارد شود");
                    return;
                }
                $scope.addNewProgress = true;
                intervalFetchService.add($scope.datasourceId, $scope.addModel.addFrom, $scope.addModel.addTo).then(function(data) {
                    $scope.addNewProgress = false;
                    data.refreshProgress = false;
                    fixTime(data);
                    $scope.requests = $scope.requests || [];
                    $scope.requests.push(data);
                    $(".ui.interval-fetch-modal").modal("hide");
                }, function() {
                    $scope.addNewProgress = false;
                    alert("اجرا با خطا مواجه شد!");
                });
            };
            $scope.addModal = function() {
                $(".ui.interval-fetch-modal").modal("show");
            };
            $scope.delete = function(req) {
                var f = confirm("آیا برای حذف اطمینان دارید؟");
                if (!f) return;
                req.refreshProgress = true;
                intervalFetchService.remove(req.id).then(function() {
                    req.refreshProgress = true;
                    _.remove($scope.requests, {
                        id: req.id
                    });
                }, function() {
                    alert("خطایی در حذف اطلاعات رخ داده است");
                    req.refreshProgress = false;
                });
            };
            $scope.refresh = function(req) {
                req.refreshProgress = true;
                intervalFetchService.refresh(req.id).then(function(data) {
                    req.refreshProgress = false;
                    fixTime(data);
                    req.timex = data.timex;
                    req.time = data.time;
                    req.effectedRows = data.effectedRows;
                    req.duration = data.duration;
                }, function() {
                    req.refreshProgress = false;
                });
            };
            $scope.persian = persian;
        } ],
        templateUrl: app.urlPrefix + "dist/partial/management/directives/interval-fetch.html?v=" + app.version
    };
}).directive("rolesTree", function() {
    return {
        restrict: "E",
        transclude: true,
        scope: {
            root: "="
        },
        controller: [ "$scope", "$http", "$translate", "roles", "$mdToast", "utils", function($scope, $http, $translate, roles, $mdToast, utils) {
            $scope.app = app;
            $scope.selected = null;
            $scope.deleteOne = function(item) {
                $scope.selected = item;
                var modal = $(".role-delete-modal").modal("show");
            };
            $scope.deleteRole = function(withChild) {
                $scope.deleteType = withChild ? "with-child" : "";
                var link = app.urlPrefix + "api/roles/delete" + (withChild ? "?withChild=true" : "");
                if ($scope.selected == null) return;
                function removeRec(tree, item) {
                    if (_.isArray(tree.nodes)) {
                        for (var i = 0; i < tree.nodes.length; i++) {
                            if (tree.nodes[i].id == item.id) {
                                tree.nodes.splice(i, 1);
                                return;
                            }
                            removeRec(tree.nodes[i], item);
                        }
                    }
                    return;
                }
                $scope.deleteProgress = true;
                $http.post(link, [ $scope.selected.id ]).then(function(res) {
                    roles.reset();
                    removeRec($scope.root, $scope.selected);
                    var toast = $mdToast.simple().textContent("حذف انجام شد");
                    $mdToast.show(toast);
                    $(".role-delete-modal").modal("hide");
                    console.log($(".role-delete-modal"));
                    $scope.deleteProgress = false;
                }, function(error) {
                    $scope.deleteProgress = false;
                    utils.showErrorToast(error.data.desc);
                    $(".role-delete-modal").modal("hide");
                });
            };
            $(".ui.dimmer.modals .role-delete-modal").remove();
        } ],
        templateUrl: app.urlPrefix + "dist/partial/management/directives/roles-tree.html?v=" + app.version
    };
}).directive("sadafIcons", function() {
    return {
        scope: {
            model: "=ngModel",
            change: "&ngChange"
        },
        controller: [ "$scope", "$http", "$translate", "roles", "$timeout", "utils", "$mdMenu", function($scope, $http, $translate, roles, $timeout, utils, $mdMenu) {
            $scope.id = _.random(1e5, 999999, false);
            $scope.app = app;
            $scope.icons = [ "add to calendar icon", "address book icon", "address book outline icon", "address card icon", "address card outline icon", "alarm icon", "alarm mute icon", "alarm mute outline icon", "alarm outline icon", "at icon", "browser icon", "bug icon", "calendar icon", "calendar outline icon", "checked calendar icon", "cloud icon", "code icon", "comment icon", "comment outline icon", "comments icon", "comments icon", "comments outline icon", "copyright icon", "creative commons icon", "dashboard icon", "delete calendar icon", "external icon", "external icon", "external square icon", "eyedropper icon", "feed icon", "find icon", "hand pointer icon", "handshake icon", "hashtag icon", "heartbeat icon", "history icon", "home icon", "hourglass empty icon", "hourglass end icon", "hourglass full icon", "hourglass half icon", "hourglass start icon", "id badge icon", "id card icon", "id card outline icon", "idea icon", "image icon", "inbox icon", "industry icon", "lab icon", "mail icon", "mail outline icon", "mail square icon", "mouse pointer icon", "open envelope icon", "open envelope outline icon", "options icon", "paint brush icon", "payment icon", "percent icon", "podcast icon", "privacy icon", "protect icon", "registered icon", "remove from calendar icon", "search icon", "setting icon", "settings icon", "shop icon", "shopping bag icon", "shopping basket icon", "sidebar icon", "signal icon", "sitemap icon", "tag icon", "tags icon", "tasks icon", "terminal icon", "text telephone icon", "ticket icon", "trademark icon", "trophy icon", "window close icon", "window close outline icon", "window maximize icon", "window minimize icon", "window restore icon", "add to cart icon", "add user icon", "adjust icon", "archive icon", "ban icon", "bookmark icon", "call icon", "call square icon", "clone icon", "cloud download icon", "cloud upload icon", "talk icon", "talk outline icon", "compress icon", "configure icon", "download icon", "edit icon", "erase icon", "exchange icon", "expand icon", "external share icon", "filter icon", "hide icon", "in cart icon", "lock icon", "mail forward icon", "object group icon", "object ungroup icon", "pin icon", "print icon", "random icon", "recycle icon", "refresh icon", "remove bookmark icon", "remove user icon", "repeat icon", "reply all icon", "reply icon", "retweet icon", "send icon", "send outline icon", "share alternate icon", "share alternate square icon", "share icon", "share square icon", "sign in icon", "sign out icon", "theme icon", "translate icon", "undo icon", "unhide icon", "unlock alternate icon", "unlock icon", "upload icon", "wait icon", "wizard icon", "write icon", "write square icon", "announcement icon", "birthday icon", "help circle icon", "help icon", "info circle icon", "info icon", "warning circle icon", "warning icon", "warning sign icon", "child icon", "doctor icon", "handicap icon", "spy icon", "student icon", "user icon", "user circle", "user circle outline", "user outline", "users icon", "female icon", "gay icon", "genderless icon", "heterosexual icon", "intergender icon", "lesbian icon", "male icon", "man icon", "neuter icon", "non binary transgender icon", "other gender horizontal icon", "other gender icon", "other gender vertical icon", "transgender icon", "woman icon", "block layout icon", "crop icon", "grid layout icon", "list layout icon", "maximize icon", "resize horizontal icon", "resize vertical icon", "zoom icon", "zoom out icon", "anchor icon", "bar icon", "bathtub icon", "bomb icon", "book icon", "bullseye icon", "calculator icon", "cocktail icon", "diamond icon", "fax icon", "fire extinguisher icon", "fire icon", "flag checkered icon", "flag icon", "flag outline icon", "gift icon", "hand lizard icon", "hand peace icon", "hand paper icon", "hand rock icon", "hand scissors icon", "hand spock icon", "law icon", "leaf icon", "legal icon", "lemon icon", "life ring icon", "lightning icon", "magnet icon", "money icon", "moon icon", "plane icon", "puzzle icon", "road icon", "rocket icon", "shipping icon", "shower icon", "snowflake icon", "soccer icon", "sticky note icon", "sticky note outline icon", "suitcase icon", "sun icon", "thermometer empty icon", "thermometer quarter icon", "thermometer half icon", "thermometer three quarters icon", "thermometer full icon", "travel icon", "treatment icon", "tv icon", "umbrella icon", "world icon", "asterisk icon", "certificate icon", "circle icon", "circle notched icon", "circle thin icon", "crosshairs icon", "cube icon", "cubes icon", "ellipsis horizontal icon", "ellipsis vertical icon", "quote left icon", "quote right icon", "spinner icon", "square icon", "square outline icon", "add circle icon", "add square icon", "check circle icon", "check circle outline icon", "check square icon", "checkmark box icon", "checkmark icon", "minus circle icon", "minus icon", "minus square icon", "minus square outline icon", "move icon", "plus icon", "plus square outline icon", "radio icon", "remove circle icon", "remove circle outline icon", "remove icon", "selected radio icon", "toggle off icon", "toggle on icon", "area chart icon", "bar chart icon", "camera retro icon", "film icon", "line chart icon", "newspaper icon", "photo icon", "pie chart icon", "sound icon", "angle double down icon", "angle double left icon", "angle double right icon", "angle double up icon", "angle down icon", "angle left icon", "angle right icon", "angle up icon", "arrow circle down icon", "arrow circle left icon", "arrow circle outline down icon", "arrow circle outline left icon", "arrow circle outline right icon", "arrow circle outline up icon", "arrow circle right icon", "arrow circle up icon", "arrow down icon", "arrow left icon", "arrow right icon", "arrow up icon", "caret down icon", "caret left icon", "caret right icon", "caret up icon", "chevron circle down icon", "chevron circle left icon", "chevron circle right icon", "chevron circle up icon", "chevron down icon", "chevron left icon", "chevron right icon", "chevron up icon", "long arrow down icon", "long arrow left icon", "long arrow right icon", "long arrow up icon", "pointing down icon", "pointing left icon", "pointing right icon", "pointing up icon", "toggle down icon", "toggle left icon", "toggle right icon", "toggle up icon", "mobile icon", "tablet icon", "battery empty icon", "battery low icon", "battery medium icon", "battery high icon", "battery full icon", "desktop icon", "disk outline icon", "game icon", "keyboard icon", "laptop icon", "plug icon", "power icon", "file archive outline icon", "file audio outline icon", "file code outline icon", "file excel outline icon", "file icon", "file image outline icon", "file outline icon", "file pdf outline icon", "file powerpoint outline icon", "file text icon", "file text outline icon", "file video outline icon", "file word outline icon", "folder icon", "folder open icon", "folder open outline icon", "folder outline icon", "level down icon", "level up icon", "trash icon", "trash outline icon", "barcode icon", "bluetooth alternative icon", "bluetooth icon", "css3 icon", "database icon", "fork icon", "html5 icon", "microchip icon", "openid icon", "qrcode icon", "rss icon", "rss square icon", "server icon", "usb icon", "empty heart icon", "empty star icon", "frown icon", "heart icon", "meh icon", "smile icon", "star half empty icon", "star half icon", "star icon", "thumbs down icon", "thumbs outline down icon", "thumbs outline up icon", "thumbs up icon", "backward icon", "closed captioning icon", "eject icon", "fast backward icon", "fast forward icon", "forward icon", "music icon", "mute icon", "pause circle icon", "pause circle outline icon", "pause icon", "play icon", "record icon", "step backward icon", "step forward icon", "stop circle icon", "stop circle outline icon", "stop icon", "unmute icon", "video play icon", "video play outline icon", "volume down icon", "volume off icon", "volume up icon", "bicycle icon", "building icon", "building outline icon", "bus icon", "car icon", "coffee icon", "compass icon", "emergency icon", "first aid icon", "food icon", "h icon", "hospital icon", "hotel icon", "location arrow icon", "map icon", "map outline icon", "map pin icon", "map signs icon", "marker icon", "military icon", "motorcycle icon", "paw icon", "ship icon", "space shuttle icon", "spoon icon", "street view icon", "subway icon", "taxi icon", "train icon", "television icon", "tree icon", "university icon", "columns icon", "sort alphabet ascending icon", "sort alphabet descending icon", "sort ascending icon", "sort content ascending icon", "sort content descending icon", "sort descending icon", "sort icon", "sort numeric ascending icon", "sort numeric descending icon", "table icon", "bitcoin icon", "dollar icon", "euro icon", "lira icon", "pound icon", "ruble icon", "rupee icon", "shekel icon", "won icon", "yen icon", "wheelchair icon", "asl interpreting icon", "assistive listening systems icon", "audio description icon", "blind icon", "braille icon", "deafness icon", "low vision icon", "sign language icon", "universal access icon", "volume control phone icon", "align center icon", "align justify icon", "align left icon", "align right icon", "attach icon", "bold icon", "copy icon", "cut icon", "font icon", "header icon", "indent icon", "italic icon", "linkify icon", "list icon", "ordered list icon", "outdent icon", "paragraph icon", "paste icon", "save icon", "strikethrough icon", "subscript icon", "superscript icon", "text cursor icon", "text height icon", "text width icon", "underline icon", "unlinkify icon", "unordered list icon" ];
            $scope.faIcons = [ "abacus", "acorn", "ad", "address-book", "address-card", "adjust", "air-freshener", "alarm-clock", "alicorn", "align-center", "align-justify", "align-left", "align-right", "allergies", "ambulance", "american-sign-language-interpreting", "analytics", "anchor", "angle-double-down", "angle-double-left", "angle-double-right", "angle-double-up", "angle-down", "angle-left", "angle-right", "angle-up", "angry", "ankh", "apple-alt", "apple-crate", "archive", "archway", "arrow-alt-circle-down", "arrow-alt-circle-left", "arrow-alt-circle-right", "arrow-alt-circle-up", "arrow-alt-down", "arrow-alt-from-bottom", "arrow-alt-from-left", "arrow-alt-from-right", "arrow-alt-from-top", "arrow-alt-left", "arrow-alt-right", "arrow-alt-square-down", "arrow-alt-square-left", "arrow-alt-square-right", "arrow-alt-square-up", "arrow-alt-to-bottom", "arrow-alt-to-left", "arrow-alt-to-right", "arrow-alt-to-top", "arrow-alt-up", "arrow-circle-down", "arrow-circle-left", "arrow-circle-right", "arrow-circle-up", "arrow-down", "arrow-from-bottom", "arrow-from-left", "arrow-from-right", "arrow-from-top", "arrow-left", "arrow-right", "arrow-square-down", "arrow-square-left", "arrow-square-right", "arrow-square-up", "arrow-to-bottom", "arrow-to-left", "arrow-to-right", "arrow-to-top", "arrow-up", "arrows-alt-h", "arrows-alt-v", "arrows-alt", "arrows-h", "arrows-v", "arrows", "assistive-listening-systems", "asterisk", "at", "atlas", "atom-alt", "atom", "audio-description", "award", "axe-battle", "axe", "backpack", "backspace", "backward", "badge-check", "badge-dollar", "badge-percent", "badge", "badger-honey", "balance-scale-left", "balance-scale-right", "balance-scale", "ballot-check", "ballot", "ban", "band-aid", "barcode-alt", "barcode-read", "barcode-scan", "barcode", "bars", "baseball-ball", "baseball", "basketball-ball", "basketball-hoop", "bat", "bath", "battery-bolt", "battery-empty", "battery-full", "battery-half", "battery-quarter", "battery-slash", "battery-three-quarters", "bed", "beer", "bell-school-slash", "bell-school", "bell-slash", "bell", "bezier-curve", "bible", "bicycle", "binoculars", "birthday-cake", "blanket", "blender-phone", "blender", "blind", "bold", "bolt", "bomb", "bone-break", "bone", "bong", "book-alt", "book-dead", "book-heart", "book-open", "book-reader", "book-spells", "book", "bookmark", "books", "booth-curtain", "bow-arrow", "bowling-ball", "bowling-pins", "box-alt", "box-ballot", "box-check", "box-fragile", "box-full", "box-heart", "box-open", "box-up", "box-usd", "box", "boxes-alt", "boxes", "boxing-glove", "braille", "brain", "briefcase-medical", "briefcase", "broadcast-tower", "broom", "browser", "brush", "bug", "building", "bullhorn", "bullseye-arrow", "bullseye-pointer", "bullseye", "burn", "bus-alt", "bus-school", "bus", "business-time", "cabinet-filing", "calculator-alt", "calculator", "calendar-alt", "calendar-check", "calendar-edit", "calendar-exclamation", "calendar-minus", "calendar-plus", "calendar-star", "calendar-times", "calendar", "camera-alt", "camera-retro", "camera", "campfire", "campground", "candle-holder", "candy-corn", "cannabis", "capsules", "car-alt", "car-battery", "car-bump", "car-crash", "car-garage", "car-mechanic", "car-side", "car-tilt", "car-wash", "car", "caret-circle-down", "caret-circle-left", "caret-circle-right", "caret-circle-up", "caret-down", "caret-left", "caret-right", "caret-square-down", "caret-square-left", "caret-square-right", "caret-square-up", "caret-up", "cart-arrow-down", "cart-plus", "cat", "cauldron", "certificate", "chair-office", "chair", "chalkboard-teacher", "chalkboard", "charging-station", "chart-area", "chart-bar", "chart-line-down", "chart-line", "chart-pie-alt", "chart-pie", "check-circle", "check-double", "check-square", "check", "chess-bishop-alt", "chess-bishop", "chess-board", "chess-clock-alt", "chess-clock", "chess-king-alt", "chess-king", "chess-knight-alt", "chess-knight", "chess-pawn-alt", "chess-pawn", "chess-queen-alt", "chess-queen", "chess-rook-alt", "chess-rook", "chess", "chevron-circle-down", "chevron-circle-left", "chevron-circle-right", "chevron-circle-up", "chevron-double-down", "chevron-double-left", "chevron-double-right", "chevron-double-up", "chevron-down", "chevron-left", "chevron-right", "chevron-square-down", "chevron-square-left", "chevron-square-right", "chevron-square-up", "chevron-up", "child", "church", "circle-notch", "circle", "city", "claw-marks", "clipboard-check", "clipboard-list-check", "clipboard-list", "clipboard-prescription", "clipboard", "clock", "clone", "closed-captioning", "cloud-download-alt", "cloud-download", "cloud-drizzle", "cloud-hail-mixed", "cloud-hail", "cloud-meatball", "cloud-moon-rain", "cloud-moon", "cloud-rain", "cloud-rainbow", "cloud-showers-heavy", "cloud-showers", "cloud-sleet", "cloud-snow", "cloud-sun-rain", "cloud-sun", "cloud-upload-alt", "cloud-upload", "cloud", "clouds-moon", "clouds-sun", "clouds", "club", "cocktail", "code-branch", "code-commit", "code-merge", "code", "coffee-togo", "coffee", "coffin", "cog", "cogs", "coins", "columns", "comment-alt-check", "comment-alt-dollar", "comment-alt-dots", "comment-alt-edit", "comment-alt-exclamation", "comment-alt-lines", "comment-alt-minus", "comment-alt-plus", "comment-alt-slash", "comment-alt-smile", "comment-alt-times", "comment-alt", "comment-check", "comment-dollar", "comment-dots", "comment-edit", "comment-exclamation", "comment-lines", "comment-minus", "comment-plus", "comment-slash", "comment-smile", "comment-times", "comment", "comments-alt-dollar", "comments-alt", "comments-dollar", "comments", "compact-disc", "compass-slash", "compass", "compress-alt", "compress-wide", "compress", "concierge-bell", "container-storage", "conveyor-belt-alt", "conveyor-belt", "cookie-bite", "cookie", "copy", "copyright", "corn", "couch", "cow", "credit-card-blank", "credit-card-front", "credit-card", "cricket", "crop-alt", "crop", "cross", "crosshairs", "crow", "crown", "cube", "cubes", "curling", "cut", "dagger", "database", "deaf", "democrat", "desktop-alt", "desktop", "dewpoint", "dharmachakra", "diagnoses", "diamond", "dice-d10", "dice-d12", "dice-d20", "dice-d4", "dice-d6", "dice-d8", "dice-five", "dice-four", "dice-one", "dice-six", "dice-three", "dice-two", "dice", "digital-tachograph", "diploma", "directions", "divide", "dizzy", "dna", "do-not-enter", "dog-leashed", "dog", "dollar-sign", "dolly-empty", "dolly-flatbed-alt", "dolly-flatbed-empty", "dolly-flatbed", "dolly", "donate", "door-closed", "door-open", "dot-circle", "dove", "download", "drafting-compass", "dragon", "draw-circle", "draw-polygon", "draw-square", "drum-steelpan", "drum", "drumstick-bite", "drumstick", "duck", "dumbbell", "dungeon", "ear", "eclipse-alt", "eclipse", "edit", "eject", "elephant", "ellipsis-h-alt", "ellipsis-h", "ellipsis-v-alt", "ellipsis-v", "empty-set", "engine-warning", "envelope-open-dollar", "envelope-open-text", "envelope-open", "envelope-square", "envelope", "equals", "eraser", "euro-sign", "exchange-alt", "exchange", "exclamation-circle", "exclamation-square", "exclamation-triangle", "exclamation", "expand-alt", "expand-arrows-alt", "expand-arrows", "expand-wide", "expand", "external-link-alt", "external-link-square-alt", "external-link-square", "external-link", "eye-dropper", "eye-evil", "eye-slash", "eye", "fast-backward", "fast-forward", "fax", "feather-alt", "feather", "female", "field-hockey", "fighter-jet", "file-alt", "file-archive", "file-audio", "file-certificate", "file-chart-line", "file-chart-pie", "file-check", "file-code", "file-contract", "file-csv", "file-download", "file-edit", "file-excel", "file-exclamation", "file-export", "file-image", "file-import", "file-invoice-dollar", "file-invoice", "file-medical-alt", "file-medical", "file-minus", "file-pdf", "file-plus", "file-powerpoint", "file-prescription", "file-signature", "file-spreadsheet", "file-times", "file-upload", "file-user", "file-video", "file-word", "file", "fill-drip", "fill", "film-alt", "film", "filter", "fingerprint", "fire-extinguisher", "fire-smoke", "fire", "first-aid", "fish", "fist-raised", "flag-alt", "flag-checkered", "flag-usa", "flag", "flame", "flask-poison", "flask-potion", "flask", "flushed", "fog", "folder-minus", "folder-open", "folder-plus", "folder-times", "folder", "folders", "font", "football-ball", "football-helmet", "forklift", "forward", "fragile", "frog", "frown-open", "frown", "function", "funnel-dollar", "futbol", "gamepad", "gas-pump-slash", "gas-pump", "gavel", "gem", "genderless", "ghost", "gift-card", "gift", "glass-martini-alt", "glass-martini", "glasses-alt", "glasses", "globe-africa", "globe-americas", "globe-asia", "globe-stand", "globe", "golf-ball", "golf-club", "gopuram", "graduation-cap", "greater-than-equal", "greater-than", "grimace", "grin-alt", "grin-beam-sweat", "grin-beam", "grin-hearts", "grin-squint-tears", "grin-squint", "grin-stars", "grin-tears", "grin-tongue-squint", "grin-tongue-wink", "grin-tongue", "grin-wink", "grin", "grip-horizontal", "grip-vertical", "h-square", "h1", "h2", "h3", "hammer-war", "hammer", "hamsa", "hand-heart", "hand-holding-box", "hand-holding-heart", "hand-holding-magic", "hand-holding-seedling", "hand-holding-usd", "hand-holding-water", "hand-holding", "hand-lizard", "hand-paper", "hand-peace", "hand-point-down", "hand-point-left", "hand-point-right", "hand-point-up", "hand-pointer", "hand-receiving", "hand-rock", "hand-scissors", "hand-spock", "hands-heart", "hands-helping", "hands-usd", "hands", "handshake-alt", "handshake", "hanukiah", "hashtag", "hat-witch", "hat-wizard", "haykal", "hdd", "head-side", "head-vr", "heading", "headphones-alt", "headphones", "headset", "heart-circle", "heart-rate", "heart-square", "heart", "heartbeat", "helicopter", "helmet-battle", "hexagon", "highlighter", "hiking", "hippo", "history", "hockey-mask", "hockey-puck", "hockey-sticks", "home-heart", "home", "hood-cloak", "horse", "hospital-alt", "hospital-symbol", "hospital", "hot-tub", "hotel", "hourglass-end", "hourglass-half", "hourglass-start", "hourglass", "house-damage", "house-flood", "hryvnia", "humidity", "hurricane", "i-cursor", "id-badge", "id-card-alt", "id-card", "image", "images", "inbox-in", "inbox-out", "inbox", "indent", "industry-alt", "industry", "infinity", "info-circle", "info-square", "info", "inhaler", "integral", "intersection", "inventory", "italic", "jack-o-lantern", "jedi", "joint", "journal-whills", "kaaba", "key-skeleton", "key", "keyboard", "keynote", "khanda", "kidneys", "kiss-beam", "kiss-wink-heart", "kiss", "kite", "kiwi-bird", "knife-kitchen", "lambda", "lamp", "landmark-alt", "landmark", "language", "laptop-code", "laptop", "laugh-beam", "laugh-squint", "laugh-wink", "laugh", "layer-group", "layer-minus", "layer-plus", "leaf-heart", "leaf-maple", "leaf-oak", "leaf", "lemon", "less-than-equal", "less-than", "level-down-alt", "level-down", "level-up-alt", "level-up", "life-ring", "lightbulb-dollar", "lightbulb-exclamation", "lightbulb-on", "lightbulb-slash", "lightbulb", "link", "lips", "lira-sign", "list-alt", "list-ol", "list-ul", "list", "location-arrow", "location-circle", "location-slash", "location", "lock-alt", "lock-open-alt", "lock-open", "lock", "long-arrow-alt-down", "long-arrow-alt-left", "long-arrow-alt-right", "long-arrow-alt-up", "long-arrow-down", "long-arrow-left", "long-arrow-right", "long-arrow-up", "loveseat", "low-vision", "luchador", "luggage-cart", "lungs", "mace", "magic", "magnet", "mail-bulk", "male", "mandolin", "map-marked-alt", "map-marked", "map-marker-alt-slash", "map-marker-alt", "map-marker-check", "map-marker-edit", "map-marker-exclamation", "map-marker-minus", "map-marker-plus", "map-marker-question", "map-marker-slash", "map-marker-smile", "map-marker-times", "map-marker", "map-pin", "map-signs", "map", "marker", "mars-double", "mars-stroke-h", "mars-stroke-v", "mars-stroke", "mars", "mask", "medal", "medkit", "megaphone", "meh-blank", "meh-rolling-eyes", "meh", "memory", "menorah", "mercury", "meteor", "microchip", "microphone-alt-slash", "microphone-alt", "microphone-slash", "microphone", "microscope", "mind-share", "minus-circle", "minus-hexagon", "minus-octagon", "minus-square", "minus", "mobile-alt", "mobile-android-alt", "mobile-android", "mobile", "money-bill-alt", "money-bill-wave-alt", "money-bill-wave", "money-bill", "money-check-alt", "money-check", "monitor-heart-rate", "monkey", "monument", "moon-cloud", "moon-stars", "moon", "mortar-pestle", "mosque", "motorcycle", "mountain", "mountains", "mouse-pointer", "music", "narwhal", "network-wired", "neuter", "newspaper", "not-equal", "notes-medical", "object-group", "object-ungroup", "octagon", "oil-can", "oil-temp", "om", "omega", "otter", "outdent", "paint-brush-alt", "paint-brush", "paint-roller", "palette", "pallet-alt", "pallet", "paper-plane", "paperclip", "parachute-box", "paragraph", "parking-circle-slash", "parking-circle", "parking-slash", "parking", "passport", "pastafarianism", "paste", "pause-circle", "pause", "paw-alt", "paw-claws", "paw", "peace", "pegasus", "pen-alt", "pen-fancy", "pen-nib", "pen-square", "pen", "pencil-alt", "pencil-paintbrush", "pencil-ruler", "pencil", "pennant", "people-carry", "percent", "percentage", "person-booth", "person-carry", "person-dolly-empty", "person-dolly", "person-sign", "phone-office", "phone-plus", "phone-slash", "phone-square", "phone-volume", "phone", "pi", "pie", "pig", "piggy-bank", "pills", "place-of-worship", "plane-alt", "plane-arrival", "plane-departure", "plane", "play-circle", "play", "plug", "plus-circle", "plus-hexagon", "plus-octagon", "plus-square", "plus", "podcast", "podium-star", "podium", "poll-h", "poll-people", "poll", "poo-storm", "poo", "poop", "portrait", "pound-sign", "power-off", "pray", "praying-hands", "prescription-bottle-alt", "prescription-bottle", "prescription", "presentation", "print-slash", "print", "procedures", "project-diagram", "pumpkin", "puzzle-piece", "qrcode", "question-circle", "question-square", "question", "quidditch", "quote-left", "quote-right", "quran", "rabbit-fast", "rabbit", "racquet", "rainbow", "raindrops", "ram", "ramp-loading", "random", "receipt", "rectangle-landscape", "rectangle-portrait", "rectangle-wide", "recycle", "redo-alt", "redo", "registered", "repeat-1-alt", "repeat-1", "repeat-alt", "repeat", "reply-all", "reply", "republican", "retweet-alt", "retweet", "ribbon", "ring", "road", "robot", "rocket", "route-highway", "route-interstate", "route", "rss-square", "rss", "ruble-sign", "ruler-combined", "ruler-horizontal", "ruler-triangle", "ruler-vertical", "ruler", "running", "rupee-sign", "sad-cry", "sad-tear", "save", "scalpel-path", "scalpel", "scanner-keyboard", "scanner-touchscreen", "scanner", "scarecrow", "school", "screwdriver", "scroll-old", "scroll", "scrubber", "scythe", "search-dollar", "search-location", "search-minus", "search-plus", "search", "seedling", "server", "shapes", "share-all", "share-alt-square", "share-alt", "share-square", "share", "sheep", "shekel-sign", "shield-alt", "shield-check", "shield-cross", "shield", "ship", "shipping-fast", "shipping-timed", "shoe-prints", "shopping-bag", "shopping-basket", "shopping-cart", "shovel", "shower", "shredder", "shuttle-van", "shuttlecock", "sigma", "sign-in-alt", "sign-in", "sign-language", "sign-out-alt", "sign-out", "sign", "signal-1", "signal-2", "signal-3", "signal-4", "signal-alt-1", "signal-alt-2", "signal-alt-3", "signal-alt-slash", "signal-alt", "signal-slash", "signal", "signature", "sitemap", "skeleton", "skull-crossbones", "skull", "slash", "sliders-h-square", "sliders-h", "sliders-v-square", "sliders-v", "smile-beam", "smile-plus", "smile-wink", "smile", "smog", "smoke", "smoking-ban", "smoking", "snake", "snow-blowing", "snowflake", "socks", "solar-panel", "sort-alpha-down", "sort-alpha-up", "sort-amount-down", "sort-amount-up", "sort-down", "sort-numeric-down", "sort-numeric-up", "sort-up", "sort", "spa", "space-shuttle", "spade", "spider-black-widow", "spider-web", "spider", "spinner-third", "spinner", "splotch", "spray-can", "square-full", "square-root-alt", "square-root", "square", "squirrel", "staff", "stamp", "star-and-crescent", "star-exclamation", "star-half-alt", "star-half", "star-of-david", "star-of-life", "star", "stars", "steering-wheel", "step-backward", "step-forward", "stethoscope", "sticky-note", "stomach", "stop-circle", "stop", "stopwatch", "store-alt", "store", "stream", "street-view", "strikethrough", "stroopwafel", "subscript", "subway", "suitcase-rolling", "suitcase", "sun-cloud", "sun-dust", "sun-haze", "sun", "sunrise", "sunset", "superscript", "surprise", "swatchbook", "swimmer", "swimming-pool", "sword", "swords", "synagogue", "sync-alt", "sync", "syringe", "table-tennis", "table", "tablet-alt", "tablet-android-alt", "tablet-android", "tablet-rugged", "tablet", "tablets", "tachometer-alt-average", "tachometer-alt-fast", "tachometer-alt-fastest", "tachometer-alt-slow", "tachometer-alt-slowest", "tachometer-alt", "tachometer-average", "tachometer-fast", "tachometer-fastest", "tachometer-slow", "tachometer-slowest", "tachometer", "tag", "tags", "tally", "tape", "tasks", "taxi", "teeth-open", "teeth", "temperature-frigid", "temperature-high", "temperature-hot", "temperature-low", "tennis-ball", "terminal", "text-height", "text-width", "th-large", "th-list", "th", "theater-masks", "thermometer-empty", "thermometer-full", "thermometer-half", "thermometer-quarter", "thermometer-three-quarters", "thermometer", "theta", "thumbs-down", "thumbs-up", "thumbtack", "thunderstorm-moon", "thunderstorm-sun", "thunderstorm", "ticket-alt", "ticket", "tilde", "times-circle", "times-hexagon", "times-octagon", "times-square", "times", "tint-slash", "tint", "tire-flat", "tire-pressure-warning", "tire-rugged", "tire", "tired", "toggle-off", "toggle-on", "toilet-paper-alt", "toilet-paper", "tombstone-alt", "tombstone", "toolbox", "tooth", "toothbrush", "torah", "torii-gate", "tornado", "tractor", "trademark", "traffic-cone", "traffic-light-go", "traffic-light-slow", "traffic-light-stop", "traffic-light", "train", "transgender-alt", "transgender", "trash-alt", "trash", "treasure-chest", "tree-alt", "tree", "trees", "triangle", "trophy-alt", "trophy", "truck-container", "truck-couch", "truck-loading", "truck-monster", "truck-moving", "truck-pickup", "truck-ramp", "truck", "tshirt", "tty", "turkey", "turtle", "tv-retro", "tv", "umbrella-beach", "umbrella", "underline", "undo-alt", "undo", "unicorn", "union", "universal-access", "university", "unlink", "unlock-alt", "unlock", "upload", "usd-circle", "usd-square", "user-alt-slash", "user-alt", "user-astronaut", "user-chart", "user-check", "user-circle", "user-clock", "user-cog", "user-crown", "user-edit", "user-friends", "user-graduate", "user-injured", "user-lock", "user-md", "user-minus", "user-ninja", "user-plus", "user-secret", "user-shield", "user-slash", "user-tag", "user-tie", "user-times", "user", "users-class", "users-cog", "users-crown", "users", "utensil-fork", "utensil-knife", "utensil-spoon", "utensils-alt", "utensils", "value-absolute", "vector-square", "venus-double", "venus-mars", "venus", "vial", "vials", "video-plus", "video-slash", "video", "vihara", "volcano", "volleyball-ball", "volume-down", "volume-mute", "volume-off", "volume-slash", "volume-up", "volume", "vote-nay", "vote-yea", "vr-cardboard", "walking", "wallet", "wand-magic", "wand", "warehouse-alt", "warehouse", "watch-fitness", "watch", "water-lower", "water-rise", "water", "weight-hanging", "weight", "whale", "wheat", "wheelchair", "whistle", "wifi-1", "wifi-2", "wifi-slash", "wifi", "wind-warning", "wind", "window-alt", "window-close", "window-maximize", "window-minimize", "window-restore", "window", "windsock", "wine-bottle", "wine-glass-alt", "wine-glass", "won-sign", "wrench", "x-ray", "yen-sign", "yin-yang" ];
            $scope.faBrand = [ "500px", "accessible-icon", "accusoft", "acquisitions-incorporated", "adn", "adversal", "affiliatetheme", "algolia", "alipay", "amazon-pay", "amazon", "amilia", "android", "angellist", "angrycreative", "angular", "app-store-ios", "app-store", "apper", "apple-pay", "apple", "asymmetrik", "audible", "autoprefixer", "avianex", "aviato", "aws", "bandcamp", "behance-square", "behance", "bimobject", "bitbucket", "bitcoin", "bity", "black-tie", "blackberry", "blogger-b", "blogger", "bluetooth-b", "bluetooth", "btc", "buromobelexperte", "buysellads", "cc-amazon-pay", "cc-amex", "cc-apple-pay", "cc-diners-club", "cc-discover", "cc-jcb", "cc-mastercard", "cc-paypal", "cc-stripe", "cc-visa", "centercode", "chrome", "cloudscale", "cloudsmith", "cloudversify", "codepen", "codiepie", "connectdevelop", "contao", "cpanel", "creative-commons-by", "creative-commons-nc-eu", "creative-commons-nc-jp", "creative-commons-nc", "creative-commons-nd", "creative-commons-pd-alt", "creative-commons-pd", "creative-commons-remix", "creative-commons-sa", "creative-commons-sampling-plus", "creative-commons-sampling", "creative-commons-share", "creative-commons-zero", "creative-commons", "critical-role", "css3-alt", "css3", "cuttlefish", "d-and-d-beyond", "d-and-d", "dashcube", "delicious", "deploydog", "deskpro", "dev", "deviantart", "digg", "digital-ocean", "discord", "discourse", "dochub", "docker", "draft2digital", "dribbble-square", "dribbble", "dropbox", "drupal", "dyalog", "earlybirds", "ebay", "edge", "elementor", "ello", "ember", "empire", "envira", "erlang", "ethereum", "etsy", "expeditedssl", "facebook-f", "facebook-messenger", "facebook-square", "facebook", "fantasy-flight-games", "firefox", "first-order-alt", "first-order", "firstdraft", "flickr", "flipboard", "fly", "font-awesome-alt", "font-awesome-flag", "font-awesome", "fonticons-fi", "fonticons", "fort-awesome-alt", "fort-awesome", "forumbee", "foursquare", "free-code-camp", "freebsd", "fulcrum", "galactic-republic", "galactic-senate", "get-pocket", "gg-circle", "gg", "git-square", "git", "github-alt", "github-square", "github", "gitkraken", "gitlab", "gitter", "glide-g", "glide", "gofore", "goodreads-g", "goodreads", "google-drive", "google-play", "google-plus-g", "google-plus-square", "google-plus", "google-wallet", "google", "gratipay", "grav", "gripfire", "grunt", "gulp", "hacker-news-square", "hacker-news", "hackerrank", "hips", "hire-a-helper", "hooli", "hornbill", "hotjar", "houzz", "html5", "hubspot", "imdb", "instagram", "internet-explorer", "ioxhost", "itunes-note", "itunes", "java", "jedi-order", "jenkins", "joget", "joomla", "js-square", "js", "jsfiddle", "kaggle", "keybase", "keycdn", "kickstarter-k", "kickstarter", "korvue", "laravel", "lastfm-square", "lastfm", "leanpub", "less", "line", "linkedin-in", "linkedin", "linode", "linux", "lyft", "magento", "mailchimp", "mandalorian", "markdown", "mastodon", "maxcdn", "medapps", "medium-m", "medium", "medrt", "meetup", "megaport", "microsoft", "mix", "mixcloud", "mizuni", "modx", "monero", "napster", "neos", "nimblr", "nintendo-switch", "node-js", "node", "npm", "ns8", "nutritionix", "odnoklassniki-square", "odnoklassniki", "old-republic", "opencart", "openid", "opera", "optin-monster", "osi", "page4", "pagelines", "palfed", "patreon", "paypal", "penny-arcade", "periscope", "phabricator", "phoenix-framework", "phoenix-squadron", "php", "pied-piper-alt", "pied-piper-hat", "pied-piper-pp", "pied-piper", "pinterest-p", "pinterest-square", "pinterest", "playstation", "product-hunt", "pushed", "python", "qq", "quinscape", "quora", "r-project", "ravelry", "react", "reacteurope", "readme", "rebel", "red-river", "reddit-alien", "reddit-square", "reddit", "renren", "replyd", "researchgate", "resolving", "rev", "rocketchat", "rockrms", "safari", "sass", "schlix", "scribd", "searchengin", "sellcast", "sellsy", "servicestack", "shirtsinbulk", "shopware", "simplybuilt", "sistrix", "sith", "skyatlas", "skype", "slack-hash", "slack", "slideshare", "snapchat-ghost", "snapchat-square", "snapchat", "soundcloud", "speakap", "spotify", "squarespace", "stack-exchange", "stack-overflow", "staylinked", "steam-square", "steam-symbol", "steam", "sticker-mule", "strava", "stripe-s", "stripe", "studiovinari", "stumbleupon-circle", "stumbleupon", "superpowers", "supple", "teamspeak", "telegram-plane", "telegram", "tencent-weibo", "the-red-yeti", "themeco", "themeisle", "think-peaks", "trade-federation", "trello", "tripadvisor", "tumblr-square", "tumblr", "twitch", "twitter-square", "twitter", "typo3", "uber", "uikit", "uniregistry", "untappd", "usb", "ussunnah", "vaadin", "viacoin", "viadeo-square", "viadeo", "viber", "vimeo-square", "vimeo-v", "vimeo", "vine", "vk", "vnv", "vuejs", "weebly", "weibo", "weixin", "whatsapp-square", "whatsapp", "whmcs", "wikipedia-w", "windows", "wix", "wizards-of-the-coast", "wolf-pack-battalion", "wordpress-simple", "wordpress", "wpbeginner", "wpexplorer", "wpforms", "wpressr", "xbox", "xing-square", "xing", "y-combinator", "yahoo", "yandex-international", "yandex", "yelp", "yoast", "youtube-square", "youtube", "zhihu" ];
            var data1 = _.map($scope.icons, function(i) {
                return {
                    text: i,
                    mark: '<i data-name="' + i + '" class="pointer icons-menu ' + i + '"></i>'
                };
            });
            var data2 = _.map($scope.faIcons, function(i) {
                return {
                    text: i,
                    mark: '<i data-name="fal fa-' + i + '" class="pointer icons-menu fal fa-' + i + '"></i>'
                };
            });
            var data3 = _.map($scope.faIcons, function(i) {
                return {
                    text: i,
                    mark: '<i data-name="far fa-' + i + '" class="pointer icons-menu far fa-' + i + '"></i>'
                };
            });
            var data4 = _.map($scope.faIcons, function(i) {
                return {
                    text: i,
                    mark: '<i data-name="fas fa-' + i + '" class="pointer icons-menu fas fa-' + i + '"></i>'
                };
            });
            var data5 = _.map($scope.faBrand, function(i) {
                return {
                    text: i,
                    mark: '<i data-name="fab fa-' + i + '" class="pointer icons-menu fab fa-' + i + '"></i>'
                };
            });
            var temp = data1.concat(data2, data3, data4, data5);
            temp = _.map(temp, function(d, i) {
                return {
                    index: Math.floor(i / 9),
                    text: d.text,
                    mark: d.mark
                };
            });
            temp = _.groupBy(temp, "index");
            temp = _.map(temp, function(k, v) {
                return {
                    text: _.map(k, "text").join(""),
                    mark: "<tr><td>" + k.map(function(d) {
                        return d.mark;
                    }).join("</td><td>") + "</td></tr>"
                };
            });
            data = temp;
            var contentId = "contentArea" + $scope.id;
            var clusterize;
            $timeout(function() {
                clusterize = new Clusterize({
                    rows: _.map(data, "mark"),
                    scrollId: "scrollArea" + $scope.id,
                    contentId: contentId,
                    callbacks: {
                        clusterChanged: function() {
                            $("#" + contentId).find("tr:not(.clusterize-extra-row) td i").on("click", function() {
                                var name = $(this).data("name");
                                $timeout(function() {
                                    $scope.model = $scope.model || {};
                                    $scope.model.name = name;
                                    $scope.model.type = "icon";
                                    $mdMenu.hide();
                                    if ($scope.change) $scope.change();
                                }, 0);
                            });
                        }
                    }
                });
            }, 0);
            $scope.filter = function(q) {
                clusterize.update(_.map(data.filter(function(d) {
                    return d.text.indexOf(q) != -1;
                }), "mark"));
            };
            $scope.picModel = {
                select: function(id) {
                    $scope.model = $scope.model || {};
                    $scope.model.name = id;
                    $scope.model.type = "image";
                    if ($scope.change) $scope.change();
                }
            };
        } ],
        templateUrl: app.urlPrefix + "dist/partial/management/directives/icons.html?v=" + app.version
    };
}).service("intervalFetchService", [ "$http", function($http) {
    var get = function(datasourceId, offset, count) {
        if (!offset) offset = 0;
        if (!count) count = 20;
        return $http.get(app.urlPrefix + "api/intervalfetchs/get/" + datasourceId, {
            params: {
                offset: offset,
                count: count
            }
        }).then(function(res) {
            return res.data;
        });
    };
    var refresh = function(id) {
        return $http.get(app.urlPrefix + "api/intervalfetchs/refresh/" + id).then(function(res) {
            return res.data;
        });
    };
    var add = function(datasourceId, from, to) {
        return $http.get(app.urlPrefix + "api/intervalfetchs/add/" + datasourceId, {
            params: {
                from: from,
                to: to
            }
        }).then(function(d) {
            return d.data;
        });
    };
    var deleteAll = function(datasourceId) {
        return $http.get(app.urlPrefix + "api/intervalfetchs/deleteAll/" + datasourceId);
    };
    var remove = function(id) {
        return $http.get(app.urlPrefix + "api/intervalfetchs/delete/" + id);
    };
    return {
        get: get,
        refresh: refresh,
        deleteAll: deleteAll,
        add: add,
        remove: remove
    };
} ]);

var ngApp = angular.module("management");

ngApp.controller("menusCtrl", [ "$scope", "$http", "$sce", "$routeParams", "$location", "$mdSidenav", "toolbar", "$timeout", "$translate", "$mdMedia", "iframeService", function($scope, $http, $sce, $routeParams, $location, $mdSidenav, toolbar, $timeout, $translate, $mdMedia, iframeService) {
    var map = {
        "Moderation/DataSource/index/": "/datasources",
        "Account/UsersList": "/users",
        "Account/RolesList": "/roles",
        "Moderation/Charts/index/": "/charts",
        "Moderation/GlobalVariable/index/": "/variables",
        "Moderation/DatasourceInterRelation/index/": "/datasourceJoin",
        "Moderation/AutoUpdate/index/": "/settings/update",
        "Moderation/Settings/Mail/": "/settings/mail",
        "Moderation/Settings/GeneralSettings/": "/settings",
        onlineUsers: "/onlineUsers",
        licence: "/licence"
    };
    var iconMap = {
        "Account/UsersList": "person",
        "Account/RolesList": "group",
        "Moderation/DataSource/index/": "storage",
        "Moderation/Charts/index/": "timeline",
        "Moderation/GlobalVariable/index/": "space_bar",
        "Moderation/DatasourceInterRelation/index/": "linear_scale",
        "Moderation/AutoUpdate/index/": "update",
        "Moderation/Settings/Mail/": "mail",
        "Moderation/Settings/GeneralSettings/": "settings",
        onlineUsers: "rowing",
        licence: "card_membership",
        dashboards: "dashboard",
        syncUserVariablesList: "sync",
        eventNotifications: "notifications_none",
        "forms/list": "assignment"
    };
    $scope.iframeService = iframeService;
    $scope.lock = $mdMedia("gt-md");
    $scope.toolbar = toolbar;
    $scope.app = app;
    $scope.persian = persian;
    $scope.mainMenuType = 1;
    $scope.toggle = function() {
        console.log("### locl", $scope.lock, $mdMedia("gt-md"));
        if ($mdMedia("gt-md")) {
            $scope.lock = !$scope.lock;
        } else {
            $mdSidenav("r").toggle();
            console.log("### call toggle");
        }
    };
    $http.get(app.urlPrefix + "menu/MenuCategories/3").then(function(data) {
        $scope.menuCategories = data.data;
        try {
            $scope.menuCategories.data[4].menus.splice(0, 1);
        } catch (e) {}
        var link = $location.path();
        _.each($scope.menuCategories.data, function(mc) {
            _.each(mc.menus, function(m) {
                m.menu.icon = iconMap[m.menu.Link] || "code";
                m.menu.Link = map[m.menu.Link] || m.menu.Link;
            });
        });
        if (!link || link == "/" || link == "/nothings") {
            $location.path($scope.menuCategories.isRoleAdmin ? "/roles" : $scope.menuCategories.data[0].menus[0].menu.Link);
        }
        function setActiveMenu() {
            $scope.closeAll();
            var path = $location.path();
            _.each($scope.menuCategories.data, function(mc) {
                _.each(mc.menus, function(m) {
                    m.active = false;
                    if (path.replace(/^\/(.*)/i, "$1") == m.menu.Link.replace(/^\/(.*)/i, "$1")) {
                        m.active = true;
                        mc.isOpen = true;
                    }
                });
            });
        }
        setActiveMenu();
        $scope.$on("$locationChangeStart", function(event, newUrl, oldUrl) {
            setActiveMenu();
        });
    });
    $scope.setLink = function(m) {
        $mdSidenav("r").toggle();
        $timeout(function() {
            $location.path(m.menu.Link);
        }, 400);
    };
    $scope.closeNav = function() {
        $mdSidenav("r").toggle();
    };
    $scope.closeAll = function(menuCategory) {
        _.each($scope.menuCategories.data, function(mc) {
            if (menuCategory) {
                if (mc.category.Id !== menuCategory.category.Id) mc.isOpen = false;
            } else {
                mc.isOpen = false;
            }
        });
    };
    $scope.gotoDashboard = function() {
        $location.path();
    };
    if (+$("#lang").val() == 0) {
        $translate.use("fa");
    } else {
        $translate.use("en");
    }
} ]);

ngApp.service("toolbar", [ function() {
    var titles = [ {
        name: "",
        click: function() {}
    } ];
    var sideNave;
    function setTitles(t) {
        titles = t;
    }
    function getTitles() {
        return titles;
    }
    function setSideNave(s) {
        sideNave = s;
    }
    function toggleSideNave() {
        if (sideNave) {
            sideNave.toggle();
        }
    }
    return {
        setTitles: setTitles,
        getTitles: getTitles,
        setSideNave: setSideNave,
        toggleSideNave: toggleSideNave
    };
} ]);

var ngApp = angular.module("management");

ngApp.config([ "$routeProvider", "$locationProvider", function($routeProvider, $locationProvider) {
    $routeProvider.when("/datasources/add/mssql/:type/:packageId?/:id?", {
        templateUrl: app.urlPrefix + "dist/partial/management/datasource/mssql.html?v=" + app.version,
        controller: "datasourceMssqlCtrl"
    }).when("/datasources/add/file/:packageId?/:id?", {
        templateUrl: app.urlPrefix + "dist/partial/management/datasource/file.html?v=" + app.version,
        controller: "datasourcefileCtrl"
    }).when("/datasources/add/web/:packageId?/:id?", {
        templateUrl: app.urlPrefix + "dist/partial/management/datasource/web.html?v=" + app.version,
        controller: "datasourceWebCtrl"
    }).when("/datasources/add/join/:packageId?/:id?", {
        templateUrl: app.urlPrefix + "dist/partial/management/datasource/join.html?v=" + app.version,
        controller: "datasourceJoinCtrl"
    }).when("/datasources/new/:id?", {
        templateUrl: app.urlPrefix + "dist/partial/management/datasource/new.html?v=" + app.version,
        controller: "datasourceNewCtrl"
    }).when("/datasources/:id?", {
        templateUrl: app.urlPrefix + "dist/partial/management/datasource/list.html?v=" + app.version,
        controller: "datasourceListCtrl"
    }).when("/datasourceJoin", {
        templateUrl: app.urlPrefix + "dist/partial/management/datasource/interRelation.html?v=" + app.version,
        controller: "interRelationCtrl"
    }).when("/charts/:id?", {
        templateUrl: app.urlPrefix + "dist/partial/management/charts/list.html?v=" + app.version,
        controller: "chartsListCtrl"
    }).when("/charts/edit/:packageId?/:id?", {
        templateUrl: app.urlPrefix + "dist/partial/management/charts/editor.html?v=" + app.version,
        controller: "chartsEditorCtrl"
    }).when("/charts/new/:type/:packageId/:datasourceId?/:charttype?", {
        templateUrl: app.urlPrefix + "dist/partial/management/charts/editor.html?v=" + app.version,
        controller: "chartsEditorCtrl"
    }).when("/variables", {
        templateUrl: app.urlPrefix + "dist/partial/management/datasource/list.html?v=" + app.version,
        controller: "datasourceCtrl"
    }).when("/users", {
        templateUrl: app.urlPrefix + "dist/partial/management/account/userList.html?v=" + app.version,
        controller: "usersListCtrl"
    }).when("/users/edit/:id?", {
        templateUrl: app.urlPrefix + "dist/partial/management/account/userEdit.html?v=" + app.version,
        controller: "userEditCtrl"
    }).when("/roles", {
        templateUrl: app.urlPrefix + "dist/partial/management/account/roleList.html?v=" + app.version,
        controller: "rolesListCtrl"
    }).when("/roles/edit/:id?/:parent?", {
        templateUrl: app.urlPrefix + "dist/partial/management/account/roleEdit.html?v=" + app.version,
        controller: "roleEditCtrl"
    }).when("/variables", {
        templateUrl: app.urlPrefix + "dist/partial/management/account/variables.html?v=" + app.version,
        controller: "variablesCtrl"
    }).when("/settings/update", {
        templateUrl: app.urlPrefix + "dist/partial/management/account/update.html?v=" + app.version,
        controller: "updateCtrl"
    }).when("/settings/mail", {
        templateUrl: app.urlPrefix + "dist/partial/management/account/mail.html?v=" + app.version,
        controller: "mailCtrl"
    }).when("/settings", {
        templateUrl: app.urlPrefix + "dist/partial/management/account/settings.html?v=" + app.version,
        controller: "settingsCtrl"
    }).when("/onlineUsers", {
        templateUrl: app.urlPrefix + "dist/partial/management/account/onlineUsers.html?v=" + app.version,
        controller: "onlineUsersCtrl"
    }).when("/licence", {
        templateUrl: app.urlPrefix + "dist/partial/management/account/licence.html?v=" + app.version,
        controller: "licenceCtrl"
    }).when("/activeDirectory", {
        templateUrl: app.urlPrefix + "dist/partial/management/account/activeDirectory.html?v=" + app.version,
        controller: "activeDirectoryCtrl",
        controllerAs: "ad"
    }).when("/userBulkInsert", {
        templateUrl: app.urlPrefix + "dist/partial/management/account/userBulkInsert.html?v=" + app.version,
        controller: "userBulkInsertCtrl",
        controllerAs: "ubi"
    }).when("/syncUserVariablesList", {
        templateUrl: app.urlPrefix + "dist/partial/management/account/syncUserVariablesList.html?v=" + app.version,
        controller: "syncUserVariablesListCtrl",
        controllerAs: "cnl"
    }).when("/syncUserVariablesDetail/:id?", {
        templateUrl: app.urlPrefix + "dist/partial/management/account/syncUserVariablesDetail.html?v=" + app.version,
        controller: "syncUserVariablesDetailCtrl",
        controllerAs: "cnl"
    }).when("/logs", {
        templateUrl: app.urlPrefix + "dist/partial/management/account/log.html?v=" + app.version,
        controller: "logCtrl"
    }).when("/upload_chart", {
        templateUrl: app.urlPrefix + "dist/partial/management/account/uploadChart.html?v=" + app.version,
        controller: "uploadChart"
    }).when("/upload_chart/:id", {
        templateUrl: app.urlPrefix + "dist/partial/management/account/uploadChartDetail.html?v=" + app.version,
        controller: "uploadChartDetail"
    }).when("/dashboards/:id", {
        templateUrl: app.urlPrefix + "dist/partial/management/dashboard/detail.html?v=" + app.version,
        controller: "dashboardDetailCtrl"
    }).when("/dashboards", {
        templateUrl: app.urlPrefix + "dist/partial/management/dashboard/dashboards.html?v=" + app.version,
        controller: "dashboardsCtrl"
    }).when("/themes", {
        templateUrl: app.urlPrefix + "dist/partial/management/account/themes.html?v=" + app.version,
        controller: "themesCtrl"
    }).when("/compare-data", {
        templateUrl: app.urlPrefix + "dist/partial/management/account/themes.html?v=" + app.version,
        controller: "themesCtrl"
    }).when("/eventNotifications", {
        templateUrl: app.urlPrefix + "dist/partial/management/account/themes.html?v=" + app.version,
        controller: "themesCtrl"
    });
} ]);

var ngApp = angular.module("management");

ngApp.service("templates", [ function() {
    var tmpl = {
        package_dialog: app.urlPrefix + "dist/partial/management/packages/select-package.html"
    };
    return {
        tmpl: tmpl
    };
} ]);

var ngApp = angular.module("management");

ngApp.controller("activeDirectoryCtrl", [ "$scope", "$http", "$sce", "$timeout", "$mdToast", "toolbar", "$translate", "utils", "roles", function($scope, $http, $sce, $timeout, $mdToast, toolbar, $translate, utils, roles) {
    var ad = this;
    $scope.utils = utils;
    $scope.app = app;
    $translate("Active Directory Integration").then(function(t) {
        $scope.listTranslate = t;
        toolbar.setTitles([ {
            name: t,
            onclick: function() {}
        } ]);
    });
    ad.moment = moment;
    ad.bindOption = 2;
    roles.get().then(function(res) {
        ad.roles = res.data.list;
    });
    $(".ui.dimmer.modals .cert-modal").remove();
    this.getList = function() {
        ad.progress = true;
        $http.post(app.urlPrefix + "api/activedirectory/GetUserList", JSON.stringify({
            server: ad.server,
            user: ad.user,
            pass: ad.pass,
            container: ad.container,
            bindOption: ad.bindOption,
            ssl: ad.ssl,
            approveHash: ad.approveHash
        })).then(function(data) {
            ad.progress = false;
            ad.approveHash = null;
            if (data.data.result) {
                ad.data = data.data.list;
                $(".cert-modal").modal("hide");
            }
            if (!data.data.result) {
                ad.cert = data.data.cert;
                ad.certHash = data.data.hash;
                $(".cert-modal").modal("show");
            }
        }).catch(function(error) {
            ad.approveHash = null;
            utils.showErrorToast(error.data.desc);
            ad.progress = false;
        });
    };
    ad.approveCert = function() {
        ad.approveHash = ad.certHash;
        ad.getList();
    };
    this.selectAll = function(check) {
        _.forEach(ad.data, function(i) {
            i.select = check;
        });
    };
    this.saveSelectedUsers = function() {
        ad.saveProgress = true;
        ad.moment = moment;
        var selected = _.filter(ad.data, {
            select: true
        }).map(function(d) {
            return {
                server: d.server,
                user: d.SamAccountName,
                pass: d.DisplayName,
                container: ad.container,
                bindOption: ad.bindOption,
                approveHash: d.approveHash,
                ssl: d.ssl
            };
        });
        var roles = _.filter(ad.roles, {
            check: true
        });
        $http.post(app.urlPrefix + "api/activedirectory/SaveUsers", JSON.stringify({
            users: selected,
            roles: roles
        })).then(function(data) {
            ad.saveProgress = false;
            if (data.data && data.data.length) {
                ad.error = $sce.trustAsHtml("<ul><li>" + data.data.map(function(d) {
                    return filterXSS(d.user) + ", ";
                }).join("</li><li>") + "</li></ul>");
            } else {
                var toast = $mdToast.simple().textContent("کاربرهای انتخاب شده با موفقیت به سیستم اضافه شدند");
                $mdToast.show(toast);
            }
            ad.data = null;
        }, function(error) {
            utils.showErrorToast(error.data.desc);
            ad.saveProgress = false;
        });
    };
} ]);

var ngApp = angular.module("management");

ngApp.controller("userBulkInsertCtrl", [ "$scope", "$http", "$sce", "$timeout", "$mdToast", "toolbar", "$translate", "utils", "roles", function($scope, $http, $sce, $timeout, $mdToast, toolbar, $translate, utils, roles) {
    var ubi = this;
    $scope.utils = utils;
    $scope.app = app;
    $translate("اضافه کردن گروهی کاربرها").then(function(t) {
        $scope.listTranslate = t;
        toolbar.setTitles([ {
            name: t,
            onclick: function() {}
        } ]);
    });
    ubi.bindOption = 2;
    roles.get().then(function(res) {
        ubi.roles = res.data.list;
    });
    ubi.process = function() {
        if (!ubi.rawData || !ubi.rawData.length) {
            alert("داده‌ی درستی وارد نشده است");
            return;
        }
        var lines = _.split(ubi.rawData, /[\r\n]/);
        ubi.data = _.map(lines, function(line) {
            var cols = _.split(line, /[;\t]/);
            var o = {
                name: "",
                family: "",
                username: "",
                password: "",
                complex: false,
                needChange: false
            };
            if (cols.length >= 1) o.name = cols[0];
            if (cols.length >= 2) o.family = cols[1];
            if (cols.length >= 3) o.username = cols[2];
            if (cols.length >= 4) o.password = cols[3];
            if (cols.length >= 5 && +cols[4]) o.complex = true;
            if (cols.length >= 6 && +cols[5]) o.needChange = true;
            return o;
        });
    };
    this.selectAll = function(check) {
        _.forEach(ubi.data, function(i) {
            i.select = check;
        });
    };
    this.saveSelectedUsers = function() {
        ubi.saveProgress = true;
        var selected = _.filter(ubi.data, {
            select: true
        });
        var roles = _.filter(ubi.roles, {
            check: true
        });
        $http.post(app.urlPrefix + "api/users/bulkinsert", JSON.stringify({
            users: selected,
            roles: roles
        })).then(function(data) {
            ubi.saveProgress = false;
            var toast = $mdToast.simple().textContent("کاربرهای انتخاب شده با موفقیت به سیستم اضافه شدند");
            $mdToast.show(toast);
            _.each(data.data.existed, function(d) {
                _.find(ubi.data, {
                    username: d.username
                }).status = 1;
            });
            _.each(data.data.inserted, function(d) {
                _.find(ubi.data, {
                    username: d.username
                }).status = 2;
            });
        }, function(error) {
            utils.showErrorToast(error.data.desc);
            ubi.saveProgress = false;
        });
    };
} ]);

var ngApp = angular.module("management");

ngApp.controller("syncUserVariablesListCtrl", [ "$scope", "$http", "$sce", "$timeout", "$mdToast", "toolbar", "$translate", "utils", "roles", "$mdDialog", function($scope, $http, $sce, $timeout, $mdToast, toolbar, $translate, utils, roles, $mdDialog) {
    var cnl = this;
    cnl.utils = utils;
    cnl.app = app;
    var ad = {};
    function showErrorToast(msg) {
        $mdToast.show({
            template: '<md-toast class="md-toast error"> <span class="md-toast-text" flex>' + msg + "</span></md-toast>",
            hideDelay: 3e3,
            position: "bottom left"
        });
    }
    $translate("User Variable Sync").then(function(t) {
        $scope.listTranslate = t;
        toolbar.setTitles([ {
            name: t,
            onclick: function() {}
        } ]);
    });
    cnl.progress = true;
    $http.get(app.urlPrefix + "api/syncUserVariables/get").then(function(res) {
        cnl.progress = false;
        cnl.data = res.data;
    }, function() {
        cnl.progress = false;
        showErrorToast("خطایی در دریافت اطلاعات رخ داده است");
    });
    cnl.sync = function(ev, i) {
        i.progress = true;
        $http.get(app.urlPrefix + "api/syncUserVariables/sync?id=" + i.Id).then(function(res) {
            i.progress = false;
            i.LastRefresh = res.data.LastRefresh;
            $mdToast.show($mdToast.simple().textContent(" منبع داده " + i.DatasourceName + "  و متغیر " + i.VariableName + " با موفقیت همگام شدند"));
        }, function() {
            i.progress = false;
            showErrorToast("خطایی در همگام‌سازی رخ داده است");
        });
    };
    cnl.delete = function(ev, i) {
        var confirm = $mdDialog.confirm().title("حذف برای همیشه؟").textContent("آیا ارتباط بین منبع داده " + i.DatasourceName + "  و متغیر " + i.VariableName + " حذف شود؟").ariaLabel("حذف").targetEvent(ev).ok("حذف!").cancel("لغو");
        $mdDialog.show(confirm).then(function() {
            $http.get(app.urlPrefix + "api/syncUserVariables/delete?id=" + i.Id).then(function(res) {
                $mdToast.show($mdToast.simple().textContent("عملیات با موفقیت به اتمام رسید"));
                _.remove(cnl.data, {
                    Id: i.Id
                });
            }, function() {
                showErrorToast("خطایی در حذف رخ داده است");
            });
        });
    };
} ]);

ngApp.controller("syncUserVariablesDetailCtrl", [ "$scope", "$http", "$sce", "$timeout", "$mdToast", "toolbar", "$translate", "utils", "datasources", "$routeParams", function($scope, $http, $sce, $timeout, $mdToast, toolbar, $translate, utils, datasources, $routeParams) {
    var cnl = this;
    $scope.utils = utils;
    $scope.app = app;
    var id = typeof $routeParams.id != "undefined" ? $routeParams.id : 0;
    $translate("User Variable Sync").then(function(t) {
        $scope.listTranslate = t;
        toolbar.setTitles([ {
            name: t,
            onclick: function() {}
        } ]);
    });
    function error(res) {
        cnl.getInfoProgress = false;
        cnl.error = res.data.desc;
    }
    function clearError() {
        cnl.error = null;
    }
    function showErrorToast(msg) {
        $mdToast.show({
            template: '<md-toast class="md-toast error"> <span class="md-toast-text" flex>' + msg + "</span></md-toast>",
            hideDelay: 3e3,
            position: "bottom left"
        });
    }
    if (id > 0) {
        cnl.getInfoProgress = true;
        var link = app.urlPrefix + "api/syncUserVariables/get?id=" + id;
        $http.get(link).then(function(res) {
            cnl.userProperties = [];
            cnl.selectedDatasource = {
                id: res.data.DatasourceId,
                name: res.data.DatasourceName
            };
            cnl.usernameColumn = res.data.UsernameColumn;
            cnl.variableValueColumn = res.data.VariableValueColumn;
            cnl.variableName = res.data.VariableName;
            cnl.getColumns();
        }, function(res) {
            error(res);
        });
    }
    cnl.selectDatasource = function(ev) {
        datasources.select(ev, {
            type: [ "datasources" ]
        }).then(function(res) {
            clearError();
            cnl.selectedDatasource = res.selected[0];
            cnl.getColumns();
        });
    };
    cnl.getColumns = function() {
        datasources.getColumns(cnl.selectedDatasource.id).then(function success(data) {
            cnl.getInfoProgress = false;
            cnl.datasourceColumns = data.CubeInfo.Dimensions[0].Hierarchies;
            cnl.userProperties = data.UsersProperty;
        }, function error(res) {
            error(res);
        });
    };
    cnl.saveAndSync = function(ev) {
        if (!$scope.syncForm.$valid) {
            showErrorToast("فیلدهای ضروری باید پر شوند");
            return;
        }
        cnl.syncProgress = true;
        cnl.syncError = null;
        cnl.effectedUsers = null;
        $http.post(app.urlPrefix + "api/syncUserVariables/saveAndSync", {
            id: id,
            datasourceId: cnl.selectedDatasource.id,
            usernameColumn: cnl.usernameColumn,
            variableValueColumn: cnl.variableValueColumn,
            variableName: cnl.variableName
        }).then(function success(res) {
            cnl.syncProgress = false;
            cnl.effectedUsers = res.data.effected;
            id = res.data.id;
            $mdToast.show($mdToast.simple().textContent("عملیات با موفقیت به اتمام رسید"));
        }, function error(res) {
            cnl.syncProgress = false;
            cnl.syncError = res.data.desc;
            showErrorToast("خطایی در روند همگام سازی به وجود آمده است");
        });
    };
} ]);

var ngApp = angular.module("management");

ngApp.controller("licenceCtrl", [ "$scope", "$http", "$sce", "$timeout", "$mdToast", "toolbar", "$translate", "utils", function($scope, $http, $sce, $timeout, $mdToast, toolbar, $translate, utils) {
    $scope.utils = utils;
    $translate("licence_manager").then(function(t) {
        $scope.listTranslate = t;
        toolbar.setTitles([ {
            name: t,
            onclick: function() {}
        } ]);
    });
    $scope.progress = true;
    $http.get(app.urlPrefix + "api/licence/get").then(function(data) {
        $scope.progress = false;
        $scope.data = data.data;
    });
    $scope.clear = function() {
        $http.get(app.urlPrefix + "api/licence/clear").then(function(data) {
            window.location = app.urlPrefix + "Account/LogOff";
        });
    };
} ]);

var ngApp = angular.module("management");

ngApp.filter("htmlSafe", [ "$sce", function($sce) {
    return function(htmlCode) {
        return $sce.trustAsHtml(filterXSS(htmlCode));
    };
} ]);

ngApp.controller("mailCtrl", [ "$scope", "$http", "$sce", "$timeout", "$mdToast", function($scope, $http, $sce, $timeout, $mdToast) {
    function isEmpty(i) {
        if (i) i = i.trim();
        return _.isEmpty(i);
    }
    $(".ui.dimmer.modals .mail-cert-modal").remove();
    $scope.moment = moment;
    function validate() {
        if (isEmpty(($scope.port || "") + "") || isEmpty($scope.host) || isEmpty(($scope.timeout || "") + "") || isEmpty($scope.username) || isEmpty($scope.password)) {
            $scope.message = null;
            $scope.error = $sce.trustAsHtml("فیلدهای ضروری باید پر شوند");
            return false;
        }
        return true;
    }
    $scope.save = function(e) {
        $scope.message = null;
        $scope.error = null;
        if (!validate()) {
            return;
        }
        $scope.progress = true;
        $http.post(app.urlPrefix + "Moderation/Settings/Mail", JSON.stringify({
            port: $scope.port,
            host: $scope.host,
            ssl: $scope.ssl,
            timeout: $scope.timeout,
            username: $scope.username,
            password: $scope.password,
            approveHash: $scope.approveHash
        }), {
            headers: {
                "Content-Type": "application/json; charset=utf-8"
            }
        }).then(function(res) {
            $scope.progress = false;
            $scope.approveHash = null;
            $(".mail-cert-modal").modal("hide");
            if (checkCert(res.data, "save")) return;
            if (res.data.result) {
                window.history.back();
                var toast = $mdToast.simple().textContent("تغییرات ثبت شد");
                $mdToast.show(toast);
            } else {
                $scope.message = null;
                $scope.error = $sce.trustAsHtml(filterXSS(res.data.error));
            }
        }, function(res) {
            $(".mail-cert-modal").modal("hide");
            $scope.approveHash = null;
            $scope.progress = false;
            $scope.message = null;
            $scope.error = $sce.trustAsHtml(filterXSS(res.data.desc));
        });
    };
    function checkCert(data, mode) {
        if (!data.result && data.cert) {
            $(".mail-cert-modal").modal("show");
            $scope.certMode = mode;
            $scope.cert = data.cert;
            $scope.certHash = data.hash;
            return true;
        }
        return false;
    }
    $scope.approveCert = function() {
        $scope.approveHash = $scope.certHash;
        if ($scope.certMode === "test") {
            $scope.test();
        }
        if ($scope.certMode === "save") {
            $scope.save();
        }
    };
    $scope.test = function(e) {
        $scope.error = null;
        $scope.message = null;
        if (!validate()) {
            return;
        }
        $scope.progress = true;
        $http.post(app.urlPrefix + "Moderation/Settings/Test", JSON.stringify({
            port: $scope.port,
            host: $scope.host,
            ssl: $scope.ssl,
            timeout: $scope.timeout,
            username: $scope.username,
            password: $scope.password,
            approveHash: $scope.approveHash
        }), {
            headers: {
                "Content-Type": "application/json; charset=utf-8"
            }
        }).then(function(res) {
            $scope.progress = false;
            $(".mail-cert-modal").modal("hide");
            $scope.approveHash = null;
            if (checkCert(res.data, "test")) return;
            if (res.data.result) {
                $scope.message = $sce.trustAsHtml("ارسال پست الکترونیک با اطلاعات وارد درست است");
                var toast = $mdToast.simple().textContent("ارسال پست الکترونیک با اطلاعات وارد درست است");
                $mdToast.show(toast);
            } else {
                $scope.message = null;
                $scope.error = $sce.trustAsHtml(filterXSS(res.data.error));
            }
        }, function(res) {
            $(".mail-cert-modal").modal("hide");
            $scope.approveHash = null;
            $scope.progress = false;
            $scope.message = null;
            $scope.error = $sce.trustAsHtml(filterXSS(res.data.desc));
        });
    };
    $scope.infoProgress = true;
    $http.get(app.urlPrefix + "api/settings/getMailInfo").then(function(res) {
        $scope.infoProgress = false;
        var m = res.data;
        $scope.port = m.port;
        $scope.host = m.host;
        $scope.ssl = m.ssl;
        $scope.timeout = m.timeout;
        $scope.username = m.username;
        $scope.password = m.password;
    }, function(res) {
        $scope.infoProgress = false;
        $scope.error = $sce.trustAsHtml(filterXSS(res.data.desc));
    });
} ]);

var ngApp = angular.module("management");

ngApp.controller("onlineUsersCtrl", [ "$scope", "$http", "$sce", "$timeout", "$mdToast", "toolbar", "$translate", "utils", function($scope, $http, $sce, $timeout, $mdToast, toolbar, $translate, utils) {
    $scope.utils = utils;
    $translate("online_users").then(function(t) {
        $scope.listTranslate = t;
        toolbar.setTitles([ {
            name: t,
            onclick: function() {}
        } ]);
    });
    $scope.kick = function(row) {
        $http.post(app.urlPrefix + "api/onlineusers/kick/" + row.id).then(function(data) {});
    };
    $scope.progress = true;
    $http.get(app.urlPrefix + "api/onlineusers/get").then(function(data) {
        $scope.progress = false;
        $scope.data = data.data.list;
        $scope.SecurityCertPatch = data.data.SecurityCertPatch;
    });
} ]);

var ngApp = angular.module("management");

ngApp.controller("roleEditCtrl", [ "$scope", "$http", "$mdToast", "$mdDialog", "$routeParams", "$location", "packages", "$timeout", "$translate", "$sce", "roles", "menus", "utils", "datasources", function($scope, $http, $mdToast, $mdDialog, $routeParams, $location, packages, $timeout, $translate, $sce, roles, menus, utils, datasources) {
    $scope.app = app;
    var Permission = {
        ChartAdd: 1,
        ChartView: 2,
        ChartEdit: 3,
        ChartDelete: 4,
        MenuAdd: 5,
        MenuView: 6,
        MenuEdit: 7,
        MenuDelete: 8,
        DataSourceAdd: 9,
        DataSourceView: 10,
        DataSourceEdit: 11,
        DataSourceDelete: 12,
        FormAdd: 22,
        FormView: 23,
        FormEdit: 24,
        FormDelete: 25,
        AdminAccessOnCharts: 13,
        AdminAccessOnMenus: 14,
        AdminAccessOnDataSources: 15,
        AdminAccessOnForms: 21,
        DashboardAddDeleteArragneCharts: 16,
        ManageAllUsersAndRoles: 17,
        ViewManageMainMenu: 18,
        ArrangeMenus: 19,
        UploadChart: 26,
        UserChangeInfo: 27,
        UserChangePassword: 28,
        ViewLogs: 29,
        Chart_Extra_comment: 30,
        Chart_Extra_excel: 31,
        Chart_Extra_desc: 32,
        Chart_Extra_filter: 33,
        ThemeAdd: 34,
        ThemeView: 35,
        ThemeEdit: 36,
        ThemeDelete: 37
    };
    $scope.actions = [ {
        title: "مدیریت نمودارها",
        childes: [ {
            id: Permission.ChartAdd,
            name: "ساخت نمودار جدید"
        }, {
            id: Permission.ChartView,
            name: "مشاهده نمودار"
        }, {
            id: Permission.ChartEdit,
            name: "ویرایش نمودار"
        }, {
            id: Permission.ChartDelete,
            name: "حذف نمودار"
        }, {
            id: Permission.Chart_Extra_comment,
            name: "مجوز کامنت روی تمام نمودارها"
        }, {
            id: Permission.Chart_Extra_excel,
            name: "مجوز خروجی اکسل روی تمام نمودارها"
        }, {
            id: Permission.Chart_Extra_filter,
            name: "مجوز فیلتر روی تمام نمودارها"
        }, {
            id: Permission.Chart_Extra_desc,
            name: "مجوز توضیحات روی تمام نمودارها"
        } ]
    }, {
        title: "مدیریت منوها",
        childes: [ {
            id: Permission.MenuAdd,
            name: "ساخت منوی جدید"
        }, {
            id: Permission.MenuView,
            name: "مشاهده منو"
        }, {
            id: Permission.MenuEdit,
            name: "ویرایش منو"
        }, {
            id: Permission.MenuDelete,
            name: "حذف منو"
        } ]
    }, {
        title: "مدیریت فرم‌ها",
        childes: [ {
            id: Permission.FormAdd,
            name: "ساخت فرم جدید"
        }, {
            id: Permission.FormView,
            name: "مشاهده فرم"
        }, {
            id: Permission.FormEdit,
            name: "ویرایش فرم"
        }, {
            id: Permission.FormDelete,
            name: "حذف فرم"
        } ]
    }, {
        title: "مدیریت منابع داده",
        childes: [ {
            id: Permission.DataSourceAdd,
            name: "ساخت منبع داده‌ی جدید"
        }, {
            id: Permission.DataSourceView,
            name: "مشاهده منبع داده"
        }, {
            id: Permission.DataSourceEdit,
            name: "ویرایش منبع داده"
        }, {
            id: Permission.DataSourceDelete,
            name: "حذف منبع داده"
        } ]
    }, {
        title: "مدیریت پوسته‌ها",
        childes: [ {
            id: Permission.ThemeAdd,
            name: "ساخت پوسته جدید"
        }, {
            id: Permission.ThemeView,
            name: "مشاهده پوسته"
        }, {
            id: Permission.ThemeEdit,
            name: "ویرایش پوسته"
        }, {
            id: Permission.ThemeDelete,
            name: "حذف پوسته"
        } ]
    }, {
        title: "مدیریت صفحات داشبوردی و کاربران و نقش‌ها",
        childes: [ {
            type: "input",
            id: Permission.ArrangeMenus,
            name: "تغییر ترتیب منوها"
        } ]
    }, {
        title: "دسترسی کامل",
        childes: [ {
            type: "input",
            id: Permission.AdminAccessOnCharts,
            name: "دسترسی کامل به تمام نمودارها"
        }, {
            type: "input",
            id: Permission.AdminAccessOnMenus,
            name: "دسترسی کامل به تمام منوها"
        }, {
            type: "input",
            id: Permission.AdminAccessOnDataSources,
            name: "دسترسی کامل به تمام منابع داده"
        }, {
            type: "input",
            id: Permission.AdminAccessOnForms,
            name: "دسترسی کامل به تمام فرم‌ها"
        } ]
    }, {
        title: "سایر مجوز‌ها",
        childes: [ {
            id: Permission.UploadChart,
            name: "آپلود کردن نمودار"
        }, {
            id: Permission.UserChangeInfo,
            name: "تغییر اطلاعات کابران زیرمجموعه"
        }, {
            id: Permission.UserChangePassword,
            name: "تغییر کلمه عبور کابران زیرمجموعه"
        }, {
            id: Permission.ManageAllUsersAndRoles,
            name: "مدیر اصلی سیستم"
        }, {
            id: Permission.ViewLogs,
            name: "مشاهده لاگ‌های سیستم"
        } ]
    } ];
    var id = typeof $routeParams.id !== "undefined" ? $routeParams.id : 0;
    $scope.parent = typeof $routeParams.parent !== "undefined" ? +$routeParams.parent : 0;
    function error(res) {
        $scope.error = $sce.trustAsHtml(filterXSS("<b>" + res.data.title + "</b> <br/>" + res.data.desc));
        showErrorToast(res.data.desc);
    }
    var isEdit = id > 0;
    $scope.id = id;
    $scope.isEdit = isEdit;
    roles.get().then(function(res) {
        $scope.isAdmin = res.data.isAdmin;
        var a = _.filter(res.data.list, {
            isAdmin: true
        });
        if (isEdit) a = _.reject(a, {
            id: +$scope.id
        });
        if ($scope.isAdmin) a = [ {
            name: "بدون پدر",
            id: 0
        } ].concat(a);
        if (!isEdit && $scope.parent === 0) {
            $scope.parent = a[0].id;
            $scope.changeParent();
        }
        $scope.roles = a;
    });
    function getMenus() {
        menus.getParentMenu($scope.parent).then(function(res) {
            _.forEach(res.data, function(i) {
                i.check = false;
            });
            $scope.menus = _.groupBy(res.data, function(m) {
                return JSON.stringify({
                    name: m.parent,
                    id: m.parentId
                });
            });
            $scope.menusFlat = res.data;
            _.forEach($scope.menus, function(groups) {
                _.forEach(groups, function(m) {
                    m.action = 1;
                });
            });
            $scope.menuCategoriesAction = {};
            restoreData();
        });
        getParentFunctionalPermissions();
    }
    $http.get(app.urlPrefix + "api/themes/getnames").then(function(res) {
        $scope.themes = res.data.list;
        $scope.selectThemes = _.extend([], res.data.list);
        $scope.selectThemes.splice(0, 0, {
            name: "پیش فرض",
            id: -1
        });
        _.each($scope.themes, function(item) {
            item.action = 1;
        });
        restoreData();
    }).catch(function() {
        $scope.themes = [];
        $scope.selectThemes = _.extend([], []);
        restoreData();
    });
    $http.get(app.urlPrefix + "api/mainmenus/get/-1").then(function(res) {
        $scope.mainmenus = res.data.list;
        _.each($scope.mainmenus, function(item) {
            item.action = 1;
        });
        restoreData();
    }).catch(function() {
        $scope.mainmenus = [];
        restoreData();
    });
    $scope.jsonParse = function(s) {
        return JSON.parse(s);
    };
    $scope.setViewPermission = function(k, menus) {
        var id = JSON.parse(k).id;
        if (_.some(menus, {
            check: true
        })) {
            $scope.menuCategoriesAction[id] = $scope.menuCategoriesAction[id] || 1;
        } else {
            delete $scope.menuCategoriesAction[id];
        }
    };
    function getUsers() {
        $http.get(app.urlPrefix + "api/users/get?parentRole=" + $scope.parent + "&role=" + $scope.id).then(function(data) {
            $scope.progress = false;
            $scope.users = data.data.list;
            $scope.manageableUsers = _.map(data.data.list, _.clone);
            restoreData();
        }, utils.error);
    }
    getUsers();
    $scope.datasources = [];
    $scope.addDatasource = function(ev) {
        datasources.select(ev, {
            type: [ "datasources" ],
            multipleDatasource: true,
            parentRole: $scope.parent
        }).then(function(res) {
            var insert = _.filter(res.selected, function(d) {
                return !_.some($scope.datasources, {
                    id: d.id
                });
            });
            $scope.datasources = $scope.datasources.concat(insert.map(function(d) {
                return {
                    id: d.id,
                    name: d.name,
                    action: 1,
                    permissions: d.permissions
                };
            }));
        });
    };
    $scope.clearDatasources = function() {
        $scope.datasources = [];
    };
    $scope.charts = [];
    $scope.addChart = function(ev) {
        datasources.select(ev, {
            type: [ "charts" ],
            parentRole: $scope.parent
        }).then(function(res) {
            var insert = _.filter(res.selected, function(d) {
                return !_.some($scope.charts, {
                    id: d.id
                });
            });
            $scope.charts = $scope.charts.concat(insert.map(function(d) {
                return {
                    id: d.id,
                    name: d.name,
                    action: 1,
                    permissions: d.permissions
                };
            }));
        });
    };
    $scope.clearCharts = function() {
        $scope.charts = [];
    };
    $scope.extraActionAllx = [];
    $scope.$watch("extraActionAllx", function(n, o) {
        if (_.isArray(n)) _.each($scope.charts, function(item) {
            item.chartExtraPermissions = n.slice();
        });
    }, true);
    $scope.datasourceActionAll = 1;
    $scope.chartActionAll = 1;
    $scope.actionAll = function(type, c) {
        var list = type === "datasource" ? $scope.datasources : $scope.charts;
        var check = type === "datasource" ? $scope.datasourceActionAll : $scope.chartActionAll;
        _.forEach(list, function(d) {
            d.action = +c;
        });
    };
    if (isEdit) {
        $http.get(app.urlPrefix + "api/roles/get?id=" + id).then(function(res) {
            var time = new Date();
            $scope.model = res.data.model;
            $scope.securityCertPatch = res.data.securityCertPatch;
            $scope.licenseThemes = res.data.themes;
            $scope.useApp = res.data.useApp;
            $scope.sign = res.data.sign;
            $scope.childs = res.data.childs;
            if (!$scope.licenseThemes) {
                var index = _.indexOf($scope.actions, {
                    title: "مدیریت پوسته‌ها"
                });
                if (index !== -1) {
                    $scope.actions.splice(index, 1);
                }
            }
            _.each($scope.childs, function(child) {
                if (child.parent === $scope.id) child.parent = 0;
            });
            $scope.childTree = roles.createTree($scope.childs);
            if ($scope.model.ParentRole) $scope.parent = $scope.model.ParentRole;
            getMenus();
            $scope.isAdmin = res.data.isAdmin;
            restoreData();
            $timeout(function() {
                console.log("time", new Date() - time);
            });
        }, error);
    } else {
        getMenus();
    }
    $scope.changeParent = function() {
        setModelData(false);
        getMenus();
        getUsers();
    };
    function getParentFunctionalPermissions() {
        $http.get(app.urlPrefix + "api/roles/GetRoleFunctional?id=" + $scope.parent).then(function(res) {
            _.each($scope.actions, function(d) {
                _.each(d.childes, function(a) {
                    if (_.isArray(res.data)) {
                        a.disable = res.data.indexOf(a.id) === -1;
                    }
                });
            });
            console.log($scope.actions);
        });
    }
    function restoreData() {
        if ($scope.model && $scope.users && $scope.menus && $scope.themes && $scope.mainmenus) {
            console.log("#### call restore");
            $scope.model.FirstMenuId = $scope.model.FirstMenuId + "";
            if ($scope.model.FunctionalActions) {
                _.forEach($scope.actions, function(item) {
                    _.forEach(item.childes, function(child) {
                        child.check = $scope.model.FunctionalActions.indexOf(child.id) !== -1;
                    });
                });
            }
            _.forEach($scope.users, function(user) {
                user.check = $scope.model.Users.indexOf(user.id) !== -1;
            });
            _.forEach($scope.manageableUsers, function(user) {
                user.check = $scope.model.ManageableUsers.indexOf(user.id) !== -1;
            });
            _.forEach($scope.model.MenuActions, function(menu) {
                var split = menu.split("-").map(function(d) {
                    return +d;
                });
                var action = split[0];
                var id = split[1];
                _.forEach($scope.menus, function(group, v) {
                    var find = _.find(group, {
                        id: id
                    });
                    if (find) {
                        find.action = action;
                        find.check = true;
                        return false;
                    }
                });
            });
            $scope.datasources = $scope.model.DatasourceActions.map(function(d) {
                return JSON.parse(d);
            });
            $scope.charts = $scope.model.ChartActions.map(function(d) {
                return JSON.parse(d);
            });
            _.each($scope.charts, function(chart) {
                var find = _.find($scope.model.ChartExtraPermissions, {
                    id: chart.id
                });
                if (find) chart.chartExtraPermissions = find.permissions;
            });
            _.forEach($scope.model.MenuCategoryActions, function(item) {
                var split = item.split("-").map(function(d) {
                    return +d;
                });
                var action = split[0];
                var id = split[1];
                var findCat = false;
                _.forEach($scope.menus, function(group, v) {
                    var cat = JSON.parse(v);
                    if (cat.id === id) {
                        $scope.menuCategoriesAction[cat.id] = action;
                        findCat = true;
                        return false;
                    }
                });
                if (!findCat) {
                    delete $scope.menuCategoriesAction[id];
                }
            });
            $scope.forms = $scope.model.forms;
            _.each($scope.themes, function(item) {
                var find = _.find($scope.model.themes, {
                    id: item.id
                });
                if (find) {
                    item.action = find.action;
                    item.check = true;
                }
            });
            _.each($scope.mainmenus, function(item) {
                var find = _.find($scope.model.mainmenus, {
                    id: item.id
                });
                if (find) {
                    item.action = find.action;
                    item.check = true;
                }
            });
            $scope.model.activeTheme = $scope.model.activeTheme || -1;
        }
    }
    function showErrorToast(msg) {
        $mdToast.show({
            template: '<md-toast class="md-toast error"> <span class="md-toast-text" flex>' + msg + "</span></md-toast>",
            hideDelay: 3e3,
            position: "bottom left"
        });
    }
    $scope.saveProgress = false;
    $translate([ "permission_view", "permission_view_edit", "permission_view_edit_delete" ]).then(function(t) {
        $scope.actionsKey = [ {
            v: 1,
            c: t["permission_view"]
        }, {
            v: 2,
            c: t["permission_view_edit"]
        }, {
            v: 4,
            c: t["permission_view_edit_delete"]
        } ];
    });
    function setModelData(forsave) {
        if (forsave) {
            $scope.model.DatasourceActions = $scope.datasources.map(function(d) {
                return d.action + "-" + d.id;
            });
            $scope.model.ChartActions = $scope.charts.map(function(d) {
                return d.action + "-" + d.id;
            });
            $scope.model.ChartExtraPermissions = $scope.charts.map(function(d) {
                return {
                    id: d.id,
                    permissions: d.chartExtraPermissions
                };
            });
            $scope.model.forms = !$scope.forms ? [] : $scope.forms.map(function(d) {
                return {
                    id: d.id,
                    action: d.action,
                    recordPermission: d.recordPermission
                };
            });
            $scope.model.themes = !$scope.themes ? [] : _.filter($scope.themes, {
                check: true
            }).map(function(d) {
                return {
                    id: d.id,
                    action: d.action
                };
            });
            $scope.model.mainmenus = !$scope.mainmenus ? [] : _.filter($scope.mainmenus, {
                check: true
            }).map(function(d) {
                return {
                    id: d.id,
                    action: d.action
                };
            });
        } else {
            $scope.model.DatasourceActions = $scope.datasources.map(function(d) {
                return JSON.stringify(d);
            });
            $scope.model.ChartActions = $scope.charts.map(function(d) {
                JSON.stringify(d);
            });
            $scope.model.forms = !$scope.forms ? [] : $scope.forms.map(function(d) {
                return {
                    id: d.id,
                    action: d.action,
                    recordPermission: d.recordPermission
                };
            });
        }
        $scope.model.Users = _.filter($scope.users, {
            check: true
        }).map(function(d) {
            return d.id;
        });
        $scope.model.ManageableUsers = _.filter($scope.manageableUsers, {
            check: true
        }).map(function(d) {
            return d.id;
        });
        $scope.model.MenuActions = [];
        _.forEach($scope.menus, function(value) {
            var checked = _.filter(value, {
                check: true
            });
            _.forEach(checked, function(c) {
                $scope.model.MenuActions.push(c.action + "-" + c.id);
            });
        });
        $scope.model.MenuCategoryActions = [];
        _.forEach($scope.menuCategoriesAction, function(v, k) {
            if (+v) $scope.model.MenuCategoryActions.push(v + "-" + k);
        });
        $scope.model.FunctionalActions = [];
        $scope.model.ParentRole = $scope.parent;
        _.forEach($scope.actions, function(value) {
            var checked = _.filter(value.childes, {
                check: true
            });
            _.forEach(checked, function(c) {
                $scope.model.FunctionalActions.push(c.id);
            });
        });
    }
    $scope.save = function(exit) {
        $scope.saveProgressState = exit ? "exit" : "stay";
        $scope.error = null;
        $scope.testResult = null;
        setModelData(true);
        $scope.saveProgress = true;
        $http.post(app.urlPrefix + "api/roles/edit", $scope.model).then(function(res) {
            $scope.saveProgress = false;
            roles.reset();
            $translate([ "new_role_created", "edit_complete" ]).then(function(t) {
                var toast = $mdToast.simple().textContent(isEdit ? t["edit_complete"] : t["new_role_created"]);
                $mdToast.show(toast);
            });
            if (exit) $location.path("/roles"); else if (!isEdit) $location.path("/roles/edit/" + res.data + "/" + $scope.parent);
        }, function(res) {
            $scope.saveProgress = false;
            $scope.error = $sce.trustAsHtml(filterXSS("<b>" + res.data.title + "</b> <br/>" + res.data.desc));
            showErrorToast(res.data.desc);
        });
    };
    $scope.checkAll = function(r) {
        _.forEach(r.childes, function(i) {
            if (!i.disable) i.check = r.checkAll;
        });
    };
    $scope.addFormSettings = {};
    $scope.onFormSelect = function(forms, settings) {
        $scope.forms = $scope.forms || [];
        _.each(forms, function(form) {
            if (!_.some($scope.forms, {
                id: form.id
            })) {
                $scope.forms.push({
                    id: form.id,
                    name: form.name,
                    action: 1
                });
            }
        });
        $timeout(function() {
            settings.visible = false;
        }, 0);
    };
} ]);

ngApp.directive("formPremission", function() {
    return {
        restrict: "E",
        replace: true,
        transclude: true,
        scope: {
            model: "=ngModel"
        },
        controller: [ "$scope", "$http", "formsService", function(scope, $http, formsService) {} ],
        template: '<div class="ui mini input">                        <sm-dropdown model="model" class="multiple selection" items="[                                                            {k:\'new record\', v:5},                                                            {k:\'edit record\', v:6},                                                            {k:\'delete record\', v:7},                                                          ]" label="item.k" value="item.v" default-text="asdasd"></sm-dropdwon>                    </div>'
    };
});

var ngApp = angular.module("management");

ngApp.controller("rolesListCtrl", [ "$scope", "$http", "$mdToast", "$mdDialog", "$routeParams", "$location", "packages", "$timeout", "$translate", "utils", "roles", "toolbar", function($scope, $http, $mdToast, $mdDialog, $routeParams, $location, packages, $timeout, $translate, utils, roles, toolbar) {
    $scope.utils = utils;
    $translate("لیست نقش‌ها").then(function(t) {
        toolbar.setTitles([ {
            name: t,
            click: function() {
                $location.path("/roles");
            }
        } ]);
    });
    $scope.progress = true;
    roles.get().then(function(res) {
        $scope.progress = false;
        $scope.data = _.filter(res.data.list, {
            editPermission: true
        });
        $scope.securityCertPatch = res.data.securityCertPatch;
        $scope.root = roles.createTree($scope.data);
    });
    $scope.isSelected = function() {
        return _.some($scope.data, {
            select: true
        });
    };
    $scope.new = function(ev) {
        $location.path("roles/edit");
    };
    $scope.deleteOne = function(item) {
        _.each($scope.data, function(d) {
            d.select = false;
        });
        item.select = true;
        $scope.delete();
    };
    $scope.deleteRole = function(withChild) {
        $scope.deleteType = withChild ? "with-child" : "";
        var link = app.urlPrefix + "api/roles/delete" + (withChild ? "?withChild=true" : "");
        var ids = _.filter($scope.data, {
            select: true
        }).map(function(d) {
            return d.id;
        });
        $scope.deleteProgress = true;
        $http.post(link, ids).then(function(res) {
            $scope.data = _.filter($scope.data, function(item) {
                return res.data.indexOf(item.id) == -1;
            });
            roles.reset();
            $scope.root = roles.createTree($scope.data);
            var toast = $mdToast.simple().textContent("حذف انجام شد");
            $mdToast.show(toast);
            $(".role-delete-modal").modal("hide");
            console.log($(".role-delete-modal"));
            $scope.deleteProgress = false;
        }, function(error) {
            $scope.deleteProgress = false;
            utils.showErrorToast(error.data.desc);
            $(".role-delete-modal").modal("hide");
        });
    };
    $(".ui.dimmer.modals .role-delete-modal").remove();
    $scope.delete = function(ev) {
        var modal = $(".role-delete-modal").modal("show");
    };
    $scope.goto = function(row, event) {
        $location.path("roles/edit/" + row.id);
    };
    var timer;
    $scope.$watch("search", function() {
        $timeout.cancel(timer);
        timer = $timeout(function() {
            if (typeof $scope.search == "undefined") return;
            $scope.progress = true;
            $http.get(app.urlPrefix + "api/roles/get" + "?query=" + $scope.search).then(function(data) {
                $scope.progress = false;
                $scope.data = data.data.list;
            });
        }, 400);
    });
    $scope.selectAll = function() {
        if ($scope.data) {
            _.forEach($scope.data, function(item) {
                item.select = $scope.selectAllCheckbox;
            });
        }
    };
} ]);

var ngApp = angular.module("management");

ngApp.controller("settingsCtrl", [ "$scope", "$http", "$sce", "$timeout", "$mdToast", "roles", function($scope, $http, $sce, $timeout, $mdToast, roles) {
    $scope.saveProgress = false;
    $(".ui.dimmer.modals .sms-cert-modal").remove();
    $scope.moment = moment;
    $scope.app = app;
    $scope.langs = [ {
        key: 0,
        value: "فارسی"
    }, {
        key: 1,
        value: "English"
    } ];
    roles.get().then(function(res) {
        $scope.roles = res.data.list;
    });
    $http.get(app.urlPrefix + "api/users/get").then(function(data) {
        $scope.users = data.data.list;
    });
    $http.get(app.urlPrefix + "api/LocationIp/get").then(function(data) {
        $scope.locations = data.data;
    });
    $scope.save = function(e) {
        $scope.saveProgress = true;
        $scope.error = null;
        $http.post(app.urlPrefix + "api/Settings/save", JSON.stringify($scope.model), {
            headers: {
                "Content-Type": "application/json; charset=utf-8"
            }
        }).then(function(res) {
            $scope.saveProgress = false;
            if (res.data.result) {
                var toast = $mdToast.simple().textContent("تغییرات ثبت شد");
                $mdToast.show(toast);
            } else {
                $scope.error = $sce.trustAsHtml(filterXSS(res.data.error));
            }
        }).catch(function(res) {
            $scope.saveProgress = false;
            $scope.error = $sce.trustAsHtml(filterXSS(res.data.desc));
        });
    };
    $scope.checkSmsCert = function() {
        $scope.certCheckProgress = true;
        $http.get(app.urlPrefix + "api/sms/VerifyUrlCert").then(function(res) {
            $scope.certCheckProgress = false;
            $scope.invelidCert = !res.data.result;
            $(".sms-cert-modal").modal("show");
            if (!res.data.result) {
                $scope.cert = res.data.cert;
                $scope.hash = res.data.hash;
            }
        }).catch(function() {
            $scope.certCheckProgress = false;
            alert("خطایی رخ داده است");
        });
    };
    $scope.approveCert = function() {
        $scope.certProgress = true;
        $http.post(app.urlPrefix + "api/sms/ApproveCert", '"' + $scope.hash + '"').then(function(res) {
            $scope.certProgress = false;
            $(".sms-cert-modal").modal("hide");
            $scope.model.smsApprovedHash = $scope.hash;
        }).catch(function() {
            $scope.certProgress = false;
            alert("خطایی رخ داده است");
        });
    };
    $http.get(app.urlPrefix + "api/settings/getGeneralInfo").then(function(data) {
        $scope.model = data.data.model;
        $scope.model.preventLoginRules = $scope.model.preventLoginRules || [];
        $scope.securityCertPatch = data.data.securityCertPatch;
        $scope.cdn = data.data.cdn;
        $scope.compareData = data.data.compareData;
        $scope.uploadLogo = data.data.uploadLogo;
    });
    $scope.addCdn = function() {
        $scope.model.cdn = $scope.model.cdn || {};
        $scope.model.cdn.items = $scope.model.cdn.items || [];
        $scope.model.cdn.items.push({
            type: 0
        });
    };
    $scope.previewFile = function(el, inverse) {
        var file = el.files[0];
        if (file.size > 100 * 1024) {
            alert("حجم فایل باید کمتر از ۱۰۰ کیلو بایت باشد");
            return;
        }
        var reader = new FileReader();
        var index = $(el).attr("index");
        reader.addEventListener("load", function() {
            $timeout(function() {
                if (inverse) $scope.model.logoInverse = reader.result; else $scope.model.logo = reader.result;
            }, 0);
        }, false);
        if (file) {
            reader.readAsDataURL(file);
        }
    };
} ]);

var ngApp = angular.module("management");

ngApp.controller("themesCtrl", [ "$scope", "$http", "$sce", "$timeout", "$location", "roles", "datasources", function($scope, $http, $sce, $timeout, $location, roles, datasources) {
    $scope.datasources = datasources;
    $scope.path = $location.path();
    $scope.compareDataModel = {
        datasources: datasources
    };
} ]);

var ngApp = angular.module("management");

var mapType = {
    Account: "مدیریت ورورد و کاربران",
    DataIntegrity: "صحت داده",
    BarChart: "خروجی اکسل و نمودار درختی",
    Charts: "نمودارها",
    CustomCharts: "نمودار دلخواد",
    Dashboard: "داشبورد",
    DashboardPage: "مدیریت داشبورد ",
    Dashboards: "داشبوردها",
    DataSource: "مدیریت منابع داده",
    DatasourceInterRelation: "مدیریت ارتباط بین منابع داده",
    Datasources: "لیست منابع داده",
    Excel: "خروجی اکسل",
    Filter: "فیلتر",
    Forms: "فرمها",
    GlobalVariable: "متغیرهای سراسری",
    Intervalfetchs: "دریافت دوره‌ای داده‌ها",
    JoinDataSource: "ارتباط بین منابع داده",
    Logs: "لاگ برنامه",
    Map: "دریافت نقشه",
    Maps: "مدیریت نقشه",
    Menu: "مدیریت منوها",
    Menus: "لیست منوها در قسمت مدیریت برنامه",
    Notification: "اعلان‌ها",
    OlapChartDesign: "مدیریت ساخت نمودار",
    Package: "مدیریت فولدرها",
    Permissions: "دریافت مجوز",
    Permission: "مجوزها",
    Profile: "پروفایل کاربر",
    Roles: "نقش‌ها",
    Sadaf: "کنترلر اصلی برنامه",
    Settings: "مدیریت تنظیمات برنامه",
    Users: "مدیریت کاربران",
    WebResource: "مدیریت وب سرویس‌ها",
    Alert: "هشدارها",
    Obfuscator: "درهم ساز",
    Captcha: "کپچا",
    License: "مجوز استفاده برنامه",
    RefreshManager: "تازه کردن منبع داده",
    ActiveDirectory: "اکتیودایرکتوری",
    Email: "پست الکترونیک"
};

var mapOperation = {
    VerifyCode: "کد احراز هویت",
    RemoveOldestRecord: "حذف رکوردهای قدیمی",
    Obfuscate: "درهم کردن",
    DeObfuscate: "باز کردن",
    LimitNotification: "اعلان محدودیت",
    Check: "بررسی",
    Activation: "فعال کردن لایسنس برنامه",
    Add: "اضافه کردن",
    AddMenu: "اضافه کردن منو",
    ChangePass: "تغییر کلمه عبور",
    Checkusername: "بررسی نام کاربری",
    Clone: "تکرار",
    CloneChart: "تکرار نمودار",
    Copy: "کپی",
    Create: "ایجاد",
    CubeInformation: "دریافت اطلاعات منبع داده",
    Dashboard: "داشبورد",
    Delete: "حذف",
    DeleteCharts: "حذف نمودارها",
    DeleteMenu: "حذف منو",
    Download: "دانلود",
    DuplicateMenu: "تکرار منو",
    Edit: "ویرایش",
    EditMenu: "ویرایش منو",
    Export: "خروجی",
    ExportToExcel: "خروجی به اکسل",
    GeneralSettings: "تنظیمات کلی",
    Get: "دریافت",
    GetCaptcha: "دریافت کد کپچا",
    GetChartMenus: "دریافت منوهای نمودار",
    GetChartPermissions: "دریافت مجوزهای نمودار",
    GetCurrent: "دریافت اطلاعات کاربر فعلی",
    GetDatasourceDimension: "دریافت یک ستون از منبع داده",
    GetDatasourceList: "لیست منابع داده",
    GetDatasourcePermissions: "مجوزهای منبع داده",
    GetEditor: "دریافت اطلاعات مربوط به ساخت نمودار",
    GetGeneralInfo: "دریافت اطلاعات تنظیمات",
    GetList: "دریافت لیست",
    GetMailInfo: "دریافت اطلاعات ایمیل سامانه",
    GetMember: "دریافت داده‌های یک ستون از منبع داده",
    GetPropertyAutoCompleteEntries: "دریافت اطلاعات متغیرهای قبلی تعریف شده در سامانه برای نمایش لیست خودکار متغیرهای قبلی در ساخت متغیر زمان ویرایش کاربر",
    GetRecords: "دریافت رکوردهای لاگ",
    GetRelatedDatasource: "دریافت لیست منابع داده مرتبط با یک منبع داده",
    GetRoleFunctional: "دریافت لیست مجوزهای عملیاتی یک نقش",
    GetSingleChartInfo: "دریافت اطلاعات کلی از یک نمودار",
    GetTreeData: "دریافت اطلاعات نمودار درختی",
    Help: "راهنما",
    Index: "اکشن پیش فرض برنامه در کنترلر پیش فرض‌(sadaf)",
    Login: "ورود به برنامه",
    LogOff: "خروج از برنامه",
    MainMenu: "دریافت منوهای اصلی (مدیریت - داشبوردها)",
    Management: "اکشن مدیریت مربوط به کنترلر پیش فرض (برای باز شدن صفحه مدیریت این اکشن فراخوانی می‌شود)",
    MenuCategories: "دریافت لیست گروه‌های منو به همراه زیر منوها",
    MoveToPackage: "انتقال منابع داده یا نمودارها به یک پوشه",
    New: "جدید",
    Refresh: "تازه کردن",
    RemoveChartFromPage: "حذف نمودار از صفحه داشبورد",
    Sample: "نمایش داده های نمونه از فایل بارگذاری شده اکسل",
    Save: "ذخیره",
    SaveChart: "ذخیره نمودار",
    SendActivationSms: "ارسال کد فعالسازی پیامک در روند ثبت نام",
    SetChartsOrder: "ذخیره ترتیب نمودارها",
    Signup: "ثبت نام",
    ToogleFullscreen: "حالت تمام صفحه کردن داشبورد",
    Update: "به روز رسانی کاربر",
    UpdateSettings: "به روز رسانی تنظیمات",
    Upload: "آپلود نقشه جدید",
    UploadFiles: "آپلود فایل اکسل",
    VerifyPassword: "بررسی درست بودن کلمه عبور",
    View: "نمایش",
    AcceptInvalidCertificate: "تایید گواهینامه نامعتبر توسط کاربر",
    CheckCertificate: "بررسی گواهینامه",
    GetList: "دریافت لیست",
    CanLogin: "بررسی امکان لاگین"
};

var mapResult = {
    Begin: "شروع عملیات",
    End: "پایان عملیات",
    Failed: "اجرای ناموفق عملیات",
    Ok: "اجرای موفق"
};

ngApp.controller("logCtrl", [ "$scope", "$http", "$sce", "$timeout", "$mdToast", "roles", function($scope, $http, $sce, $timeout, $mdToast, roles) {
    $scope.saveProgress = false;
    function maper(o) {
        return Object.keys(o).map(function(key, index) {
            return {
                label: o[key] || key,
                value: key
            };
        });
    }
    $(".ui.dimmer.modals .settings").remove();
    roles.get().then(function(res) {
        $scope.roles = res.data.list;
    });
    $scope.mapType = _.sortBy(maper(mapType), "label");
    $scope.mapOperation = _.sortBy(maper(mapOperation), "label");
    $scope.mapResult = _.sortBy(maper(mapResult), "label");
    $scope.filters = {};
    $scope.filters.rowCount = 20;
    $scope.filters.sortKeys = [ {
        order: "desc",
        name: "time"
    }, {
        order: "desc",
        name: "date"
    } ];
    $scope.langs = [ {
        key: 0,
        value: "فارسی"
    }, {
        key: 1,
        value: "English"
    } ];
    $scope.showModal = function() {
        $(".ui.modal.settings").modal("show");
    };
    $scope.save = function(e) {
        $scope.saveProgress = true;
        $http.post(app.urlPrefix + "api/logs/save", JSON.stringify($scope.model), {
            headers: {
                "Content-Type": "application/json; charset=utf-8"
            }
        }).then(function(res) {
            $scope.saveProgress = false;
            $(".ui.modal.settings").modal("hide");
            var toast = $mdToast.simple().textContent("تغییرات ثبت شد");
            $mdToast.show(toast);
            $scope.error = null;
        }).catch(function(res) {
            $scope.saveProgress = false;
            $scope.error = $sce.trustAsHtml(res.data.desc);
        });
    };
    $scope.sortBy = function(key) {
        if (key === "sign") return;
        $scope.filters.sortKeys = $scope.filters.sortKeys || [];
        var r = _.remove($scope.filters.sortKeys, {
            name: key
        });
        var item = {
            order: "desc",
            name: key
        };
        if (r && r.length > 0) {
            item = r[0];
        }
        item.order = item.order === "desc" ? "asc" : "desc";
        $scope.filters.sortKeys.push(item);
        getRecords();
    };
    $scope.orderIcon = function(key) {
        var item = _.find($scope.filters.sortKeys, {
            name: key
        });
        if (!item) return "";
        return item && item.order == "desc" ? "down" : "up";
    };
    $http.get(app.urlPrefix + "api/logs/get").then(function(res) {
        $scope.model = res.data;
    });
    function getRecords() {
        $scope.filters.page = $scope.page;
        $scope.getListProgress = true;
        $http.post(app.urlPrefix + "api/logs/getRecords", $scope.filters).then(function(res) {
            $scope.getListProgress = false;
            $scope.logs = res.data.list;
            $scope.checkList = res.data.checkList;
            $scope.pageCount = res.data.pageCount;
            $scope.page = res.data.page;
            $scope.securityCertPatch = res.data.securityCertPatch;
        }).catch(function() {
            $scope.getListProgress = false;
        });
    }
    getRecords();
    $scope.filter = function() {
        $scope.page = 0;
        getRecords();
    };
    $scope.prevPage = function() {
        $scope.page--;
        if ($scope.page < 0) {
            $scope.page = 0;
            return;
        }
        getRecords();
    };
    $scope.nextPage = function() {
        $scope.page++;
        if ($scope.page >= $scope.pageCount) {
            $scope.page--;
            return;
        }
        getRecords();
    };
} ]);

ngApp.filter("dicMap", function() {
    return function(input, type) {
        if (type === "type") return mapType[input] || input;
        if (type === "operation") return mapOperation[input] || input;
        if (type === "result") return mapResult[input] || input;
    };
});

var ngApp = angular.module("management");

ngApp.controller("uploadChart", [ "$scope", "$http", "$sce", "$timeout", "$mdToast", "customChart", "utils", function($scope, $http, $sce, $timeout, $mdToast, customChart, utils) {
    $(".ui.dimmer.modals .new-custom-chart-modal").remove();
    $scope.utils = utils;
    $scope.model = {};
    $scope.add = function() {
        $scope.model = {};
        $(".new-custom-chart-modal").modal("show");
    };
    $scope.remove = function(item, i) {
        var f = confirm(app.lang.translate("delete custom chart desc"));
        if (f) {
            customChart.remove(item.id).then(function() {
                $scope.data.splice(i, 1);
                var toast = $mdToast.simple().textContent("حذف انجام شد");
                $mdToast.show(toast);
            }).catch(function() {
                utils.showErrorToast("خطا در انجام عملیات");
            });
        }
    };
    $scope.edit = function(item) {
        $(".new-custom-chart-modal").modal("show");
        $scope.editProgress = true;
        customChart.get(item.id).then(function(data) {
            $scope.editProgress = false;
            $scope.model = data;
        }).catch(function() {
            $scope.editProgress = false;
            utils.showErrorToast("خطا در انجام عملیات");
        });
    };
    customChart.get().then(function(data) {
        $scope.data = data;
    });
    $scope.save = function(ev) {
        $scope.model.settingsTemplate = $scope.model.settingsTemplate || "{}";
        if (!$scope.model.name || !$scope.model.name.trim()) {
            alert("نام را وارد کنید");
            return;
        }
        try {
            eval("var sTemp = " + $scope.model.settingsTemplate);
            if (typeof sTemp == "undefined") {
                alert("الگوی تنظیمات درست نیست");
                return;
            }
            $scope.model.settingsTemplate = JSON.stringify(sTemp, null, "    ");
        } catch (e) {
            alert("الگوی تنظیمات درست نیست");
            return;
        }
        $scope.saveProgress = true;
        $http.post(app.urlPrefix + "api/customCharts/edit", $scope.model).then(function(res) {
            var data = res.data;
            $scope.saveProgress = false;
            $(".new-custom-chart-modal").modal("hide");
            var toast = $mdToast.simple().textContent("ذخیره با موفقیت انجام شد");
            $mdToast.show(toast);
            if ($scope.model.id) {
                var item = _.find($scope.data, {
                    id: $scope.model.id
                });
                item.name = data.name;
            } else {
                $scope.data = $scope.data || [];
                $scope.data.push({
                    id: data.id,
                    name: data.name
                });
            }
        }).catch(function() {
            $(".new-custom-chart-modal").modal("hide");
            $scope.saveProgress = false;
        });
    };
} ]);

var ngApp = angular.module("management");

ngApp.controller("uploadChartDetail", [ "$scope", "$http", "$sce", "$timeout", "$mdToast", "customChart", "utils", "$routeParams", function($scope, $http, $sce, $timeout, $mdToast, customChart, utils, $routeParams) {
    $scope.utils = utils;
    $scope.model = {};
    $scope.app = app;
    $scope.add = function() {
        $scope.model = {};
        $(".new-custom-chart-modal").modal("show");
    };
    function aceLoaded(editor, e) {
        editor.renderer.setPadding(18);
        editor.commands.addCommand({
            name: "myCommand",
            bindKey: {
                win: "Ctrl-S",
                mac: "Command-S"
            },
            exec: function(editor) {
                $timeout(function() {
                    $scope.save();
                }, 0);
            }
        }), $scope.insertFormula = function(uniqename) {
            editor.insert(uniqename);
            editor.focus();
        };
    }
    $scope.aceOption = {
        useWrapMode: true,
        showGutter: false,
        theme: "sqlserver",
        mode: "sqlserver",
        maxLines: 14,
        onLoad: aceLoaded,
        require: [ "beautify" ]
    };
    $scope.remove = function(item, i) {
        var f = confirm(app.lang.translate("delete custom chart desc"));
        if (f) {
            customChart.remove(item.id).then(function() {
                $scope.data.splice(i, 1);
                var toast = $mdToast.simple().textContent("حذف انجام شد");
                $mdToast.show(toast);
            }).catch(function() {
                utils.showErrorToast("خطا در انجام عملیات");
            });
        }
    };
    $scope.edit = function() {
        $scope.editProgress = true;
        customChart.get($routeParams.id).then(function(data) {
            $scope.editProgress = false;
            $scope.model = data;
        }).catch(function() {
            $scope.editProgress = false;
            utils.showErrorToast("خطا در انجام عملیات");
        });
    };
    $scope.edit();
    $scope.save = function(ev) {
        $scope.model.settingsTemplate = $scope.model.settingsTemplate || "{}";
        if (!$scope.model.name || !$scope.model.name.trim()) {
            alert("نام را وارد کنید");
            return;
        }
        try {
            eval("var sTemp = " + $scope.model.settingsTemplate);
            if (typeof sTemp == "undefined") {
                alert("الگوی تنظیمات درست نیست");
                return;
            }
            $scope.model.settingsTemplate = JSON.stringify(sTemp, null, "    ");
        } catch (e) {
            alert("الگوی تنظیمات درست نیست");
            return;
        }
        $scope.saveProgress = true;
        $http.post(app.urlPrefix + "api/customCharts/edit", $scope.model).then(function(res) {
            var data = res.data;
            $scope.saveProgress = false;
            $(".new-custom-chart-modal").modal("hide");
            var toast = $mdToast.simple().textContent("ذخیره با موفقیت انجام شد");
            $mdToast.show(toast);
            if ($scope.model.id) {
                var item = _.find($scope.data, {
                    id: $scope.model.id
                });
                item.name = data.name;
            } else {
                $scope.data = $scope.data || [];
                $scope.data.push({
                    id: data.id,
                    name: data.name
                });
            }
        }).catch(function() {
            $(".new-custom-chart-modal").modal("hide");
            $scope.saveProgress = false;
        });
    };
} ]);

var ngApp = angular.module("management");

ngApp.controller("updateCtrl", [ "$scope", "$http", "$mdToast", "$mdDialog", "$routeParams", "$location", "packages", "$timeout", "$translate", "utils", "datasources", function($scope, $http, $mdToast, $mdDialog, $routeParams, $location, packages, $timeout, $translate, utils, datasources) {
    $scope.progress = true;
    $http.get(app.urlPrefix + "api/users/get").then(function(data) {
        $scope.progress = false;
        $scope.data = data.data.list;
    }, utils.error);
    utils.onError(function(er) {
        $scope.error = er;
        $scope.progress = false;
    });
    $scope.isSelected = function() {
        return _.some($scope.data, {
            select: true
        });
    };
    $scope.new = function(ev) {
        $location.path("users/edit");
    };
    $scope.delete = function(ev) {
        var link = app.urlPrefix + "api/users/delete";
        var ids = _.filter($scope.data, {
            select: true
        }).map(function(d) {
            return d.id;
        });
        var confirm = $mdDialog.confirm().title("حذف برای همیشه؟").textContent(ids.length + " مورد برای حذف انتخاب شده است").ariaLabel("حذف").targetEvent(ev).ok("حذف!").cancel("لغو");
        $mdDialog.show(confirm).then(function() {
            $http.post(link, ids).then(function(res) {
                $scope.data = _.filter($scope.data, function(item) {
                    return res.data.indexOf(item.id) == -1;
                });
                var toast = $mdToast.simple().textContent("حذف انجام شد");
                $mdToast.show(toast);
            }, function(error) {
                utils.showErrorToast(error.data.desc);
            });
        });
    };
    $scope.goto = function(row, event) {
        $location.path("users/edit/" + row.id);
    };
    var timer;
    $scope.$watch("search", function() {
        $timeout.cancel(timer);
        timer = $timeout(function() {
            if (typeof $scope.search == "undefined") return;
            $scope.progress = true;
            $http.get(app.urlPrefix + "api/users/get" + "?query=" + $scope.search).then(function(data) {
                $scope.progress = false;
                $scope.data = data.data.list;
            });
        }, 400);
    });
    $scope.selectAll = function() {
        if ($scope.data) {
            _.forEach($scope.data, function(item) {
                item.select = $scope.selectAllCheckbox;
            });
        }
    };
} ]);

var ngApp = angular.module("management");

ngApp.controller("userEditCtrl", [ "$scope", "$http", "$mdToast", "$mdDialog", "$routeParams", "$location", "packages", "$timeout", "$translate", "$sce", "roles", function($scope, $http, $mdToast, $mdDialog, $routeParams, $location, packages, $timeout, $translate, $sce, roles) {
    function error(res) {
        $scope.error = $sce.trustAsHtml(filterXSS("<b>" + res.data.title + "</b> <br/>" + res.data.desc));
    }
    var id = typeof $routeParams.id !== "undefined" ? $routeParams.id : 0;
    var isEdit = id > 0;
    $scope.id = id;
    $scope.isEdit = isEdit;
    $scope.app = app;
    roles.get().then(function(res) {
        $scope.roles = angular.merge({}, res.data.list);
        _.forEach($scope.roles, function(item) {
            item.action = 1;
            item.check = false;
        });
        checkRoleActions();
        var r = _.filter($scope.roles, {
            isAdmin: true
        });
        $scope.root = roles.createTree(r);
        invalidateSelectedRoles();
    });
    $scope.props = [];
    if (isEdit) {
        $http.get(app.urlPrefix + "api/users/get?id=" + id).then(function(res) {
            $scope.model = res.data.data;
            $scope.verification = res.data.verification;
            $scope.roleAdmins = res.data.roleAdmins;
            if ($scope.model.Properties) $scope.props = JSON.parse($scope.model.Properties);
            checkRoleActions();
        }, error);
    } else {
        $scope.model = {
            active: true
        };
    }
    $scope.verify = function() {
        $scope.verifyProgress = true;
        $http.post(app.urlPrefix + "api/users/verify?id=" + id).then(function(res) {
            $scope.verifyProgress = false;
            $scope.model.isNameAuthenticated = res.data.isNameAuthenticated;
            $scope.model.isMobileAuthenticated = res.data.isMobileAuthenticated;
        }).catch(function() {
            $scope.verifyProgress = false;
        });
    };
    $scope.approve = function() {
        $scope.approveProgress = true;
        $http.post(app.urlPrefix + "api/users/approve?id=" + id).then(function() {
            $scope.approveProgress = false;
            $scope.model.isNameAuthenticated = true;
            $scope.model.isMobileAuthenticated = true;
        }).catch(function() {
            $scope.approveProgress = false;
        });
    };
    $http.get(app.urlPrefix + "api/users/getPropertyAutoCompleteEntries").then(function(res) {
        $scope.auto = res.data;
        $scope.auto.flatValues = [];
        _.each($scope.auto.values, function(d) {
            _.each(d.values, function(i) {
                if ($scope.auto.flatValues.indexOf(i) === -1) {
                    $scope.auto.flatValues.push(i);
                }
            });
        });
    }, error);
    function checkRoleActions() {
        if ($scope.model && $scope.model.Roles && $scope.roles) {
            _.forEach($scope.roles, function(role) {
                if ($scope.model.Roles.indexOf(role.id) !== -1) role.check = true;
            });
        }
    }
    function getCheckedRole(node, array) {
        if (!node) return;
        if (node.check) array.push(node.id);
        _.each(node.nodes, function(item) {
            getCheckedRole(item, array);
        });
    }
    function invalidateSelectedRoles() {
        var checkedRoles = [];
        getCheckedRole($scope.root, checkedRoles);
        $scope.selectedRoles = _.filter($scope.roles, function(d) {
            return checkedRoles.indexOf(d.id) !== -1;
        });
    }
    $scope.$watch("root", function(n) {
        invalidateSelectedRoles();
    }, true);
    function showErrorToast(msg) {
        $mdToast.show({
            template: '<md-toast class="md-toast error"> <span class="md-toast-text" flex>' + msg + "</span></md-toast>",
            hideDelay: 3e3,
            position: "bottom left"
        });
    }
    $scope.saveProgress = false;
    $scope.save = function() {
        $scope.error = null;
        $scope.testResult = null;
        if (!$scope.userForm.$valid) {
            $translate("form_invalid").then(function(t) {
                showErrorToast(t);
            });
            return;
        }
        var checkedRoles = [];
        getCheckedRole($scope.root, checkedRoles);
        $scope.model.Roles = checkedRoles;
        var main = _.indexOf(checkedRoles, $scope.model.mainRole);
        if (main === -1 && checkedRoles.length) {
            showErrorToast("نقش اصلی باید در لیست نقش‌ها انتخاب شده باشد");
            return;
        }
        $scope.model.Properties = JSON.stringify(_.map($scope.props, function(d) {
            return {
                Key: d.Key,
                Value: d.Value
            };
        }));
        $scope.saveProgress = true;
        $http.post(app.urlPrefix + "api/users/edit", $scope.model).then(function(res) {
            $scope.saveProgress = false;
            var toast = $mdToast.simple().textContent(isEdit ? "تغییرات ثبت شد" : "منبع داده جدید ایجاد شد");
            $mdToast.show(toast);
            $location.path("/users");
        }, function(res) {
            $scope.saveProgress = false;
            $scope.error = $sce.trustAsHtml(filterXSS("<b>" + res.data.title + "</b> <br/>" + res.data.desc));
        });
    };
    $("#user-expire-time").datepicker({
        changeMonth: true,
        changeYear: true,
        dateFormat: "yy/mm/dd",
        onClose: function(selectedDate, instance) {}
    });
} ]);

var ngApp = angular.module("management");

ngApp.controller("usersListCtrl", [ "$scope", "$http", "$mdToast", "$mdDialog", "$routeParams", "$location", "packages", "$timeout", "$translate", "utils", "datasources", "toolbar", function($scope, $http, $mdToast, $mdDialog, $routeParams, $location, packages, $timeout, $translate, utils, datasources, toolbar) {
    $scope.utils = utils;
    $translate("لیست کاربران").then(function(t) {
        toolbar.setTitles([ {
            name: t,
            click: null
        } ]);
    });
    $scope.app = app;
    $scope.progress = true;
    $http.get(app.urlPrefix + "api/users/get").then(function(data) {
        $scope.progress = false;
        $scope.data = data.data.list;
        $scope.securityCertPatch = data.data.securityCertPatch;
    }, utils.error);
    utils.onError(function(er) {
        $scope.error = er;
        $scope.progress = false;
    });
    $scope.isSelected = function() {
        return _.some($scope.data, {
            select: true
        });
    };
    $scope.new = function(ev) {
        $location.path("users/edit");
    };
    $scope.delete = function(ev) {
        var link = app.urlPrefix + "api/users/delete";
        var ids = _.filter($scope.data, {
            select: true
        }).map(function(d) {
            return d.id;
        });
        var confirm = $mdDialog.confirm().title("حذف برای همیشه؟").textContent(ids.length + " مورد برای حذف انتخاب شده است").ariaLabel("حذف").targetEvent(ev).ok("حذف!").cancel("لغو");
        $mdDialog.show(confirm).then(function() {
            $http.post(link, ids).then(function(res) {
                $scope.data = _.filter($scope.data, function(item) {
                    return res.data.indexOf(item.id) == -1;
                });
                var toast = $mdToast.simple().textContent("حذف انجام شد");
                $mdToast.show(toast);
            }, function(error) {
                utils.showErrorToast(error.data.desc);
            });
        });
    };
    $scope.goto = function(row, event) {
        $location.path("users/edit/" + row.id);
    };
    var timer;
    $scope.$watch("search", function() {
        $timeout.cancel(timer);
        timer = $timeout(function() {
            if (typeof $scope.search == "undefined") return;
            $scope.progress = true;
            $http.get(app.urlPrefix + "api/users/get" + "?query=" + $scope.search).then(function(data) {
                $scope.progress = false;
                $scope.data = data.data.list;
            });
        }, 400);
    });
    $scope.selectAll = function() {
        if ($scope.data) {
            _.forEach($scope.data, function(item) {
                item.select = $scope.selectAllCheckbox;
            });
        }
    };
} ]);

var ngApp = angular.module("management");

ngApp.controller("variablesCtrl", [ "$scope", "$http", "$mdToast", "$mdDialog", "$routeParams", "$location", "packages", "$timeout", "$translate", "utils", "datasources", "$mdMedia", "toolbar", function($scope, $http, $mdToast, $mdDialog, $routeParams, $location, packages, $timeout, $translate, utils, datasources, $mdMedia, toolbar) {
    $scope.utils = utils;
    $translate("متغیرهای سراسری").then(function(t) {
        toolbar.setTitles([ {
            name: t,
            click: null
        } ]);
    });
    $scope.progress = true;
    $http.get(app.urlPrefix + "moderation/globalvariable/getlist").then(function(data) {
        $scope.progress = false;
        $scope.data = data.data;
        $scope.data = $scope.data.map(function(d) {
            return correctValue(d);
        });
    }, utils.error);
    utils.onError(function(er) {
        $scope.error = er;
        $scope.progress = false;
    });
    $scope.isSelected = function() {
        return _.some($scope.data, {
            select: true
        });
    };
    function correctValue(d) {
        d.DefaultValue = JSON.parse(d.DefaultValue);
        if (d.DefaultValue) d.DefaultValue = d.DefaultValue.map(function(v) {
            return v.replace(/\[(index|calc)-\d+\]/gim, "");
        });
        return d;
    }
    $scope.new = function(ev) {
        showDialog(ev).then(function(model) {
            $http.post(app.urlPrefix + "moderation/globalvariable/add", model).then(function(res) {
                $scope.data = $scope.data || [];
                $scope.data.push(correctValue(res.data));
                $translate("new_variable_created").then(function(t) {
                    var toast = $mdToast.simple().textContent(t);
                    $mdToast.show(toast);
                });
            });
        });
    };
    $scope.delete = function(ev) {
        var link = app.urlPrefix + "moderation/globalvariable/deleteAll";
        var ids = _.filter($scope.data, {
            select: true
        }).map(function(d) {
            return d.Id;
        });
        var confirm = $mdDialog.confirm().title("حذف برای همیشه؟").textContent(ids.length + " مورد برای حذف انتخاب شده است").ariaLabel("حذف").targetEvent(ev).ok("حذف!").cancel("لغو");
        $mdDialog.show(confirm).then(function() {
            $http.post(link, ids).then(function(res) {
                $scope.data = _.filter($scope.data, function(item) {
                    return res.data.indexOf(item.Id) == -1;
                });
                $translate("delete_complete").then(function(t) {
                    var toast = $mdToast.simple().textContent(t);
                    $mdToast.show(toast);
                });
            }, function(error) {
                utils.showErrorToast(error.data.desc);
            });
        });
    };
    $scope.goto = function(row, ev) {
        showDialog(ev, row).then(function(model) {
            $http.post(app.urlPrefix + "moderation/globalvariable/add", model).then(function(res) {
                row.DefaultValue = correctValue(res.data).DefaultValue;
                $translate("edit_complete").then(function(t) {
                    var toast = $mdToast.simple().textContent(t);
                    $mdToast.show(toast);
                });
            });
        });
    };
    var timer;
    $scope.$watch("search", function() {
        $timeout.cancel(timer);
        timer = $timeout(function() {
            if (typeof $scope.search == "undefined") return;
            $scope.progress = true;
            $http.get(app.urlPrefix + "api/users/get" + "?query=" + $scope.search).then(function(data) {
                $scope.progress = false;
                $scope.data = data.data.list;
            });
        }, 400);
    });
    $scope.selectAll = function() {
        if ($scope.data) {
            _.forEach($scope.data, function(item) {
                item.select = $scope.selectAllCheckbox;
            });
        }
    };
    function showDialog(ev, model) {
        return $mdDialog.show({
            controller: [ "$scope", "$mdDialog", "$timeout", function(sp, $mdDialog, $timeout) {
                sp.cancel = function() {
                    $mdDialog.cancel();
                };
                sp.select = function() {
                    if (!sp.gbForm.$valid) {
                        sp.gbForm.$setSubmitted();
                        return;
                    }
                    $mdDialog.hide(sp.model);
                };
                sp.model = {
                    Name: "",
                    Scope: 0,
                    DefaultValue: []
                };
                if (model) {
                    sp.model = angular.merge({}, model);
                }
            } ],
            parent: angular.element(document.body),
            targetEvent: ev,
            clickOutsideToClose: true,
            fullscreen: $mdMedia("sm") || $mdMedia("xs"),
            template: '<md-dialog aria-label="{{\'choose\' | translate}}" ng-cloak >                                                                               <md-toolbar md-theme="default">                                                                                                                            <div class ="md-toolbar-tools">                                                                                                         <h2>{{\'choose\' | translate}}</h2>                                                                                                 <span flex></span>                                                                                                                  <span class ="material-icons" ng-click="cancel()">close</span>                                                                  </div>                                                                                                                          </md-toolbar>                                                                                                                       <md-dialog-content>                                                                                                                     <div class ="md-dialog-content" flex>                                                                                               <form name="gbForm">                                                                                                                   <div layout="row" layout-align="start center">                                                                                           <md-input-container flex="50" >                                                                                                         <label>{{\'name\' | translate}}</label>                                                                                             <input required name="name" ng-model="model.Name" md-autofocus>                                                                     <div ng-messages="gbForm.name.$error" ng-if=\'gbForm.$submitted || gbForm.name.$touched\'>                                            <div ng-message="required">{{\'form_username_required\' | translate}}</div>                                                       </div>                                                                                                                          </md-input-container>                                                                                                               <md-input-container flex="50">                                                                                                          <label>{{\'scope\' | translate}}</label>                                                                                            <md-select  ng-model="model.Scope">                                                                                                     <md-option value="0">{{\'scope_all_page\' | translate}}</md-option>                                                                 <md-option value="1">{{\'scope_current_page\' | translate}}</md-option>                                                         </md-select>                                                                                                                    </md-input-container>                                                                                                       </form>                                                                                                                             </div>                                                                                                                                                                                                                                                                     <md-chips flex ng-model="model.DefaultValue"                                                                                             ng-click=" $event.stopPropagation()"                                                                                                ng-change="row"                                                                                                                     placeholder="{{\'insert_user_prop_value\' | translate}}"                                                                            delete-button-label="{{\'delete_user_prop_value\' | translate}}"                                                                    delete-hint="{{\'press_delete_user_prop_value\' | translate}}"                                                                      secondary-placeholder="{{\'add_user_prop_value\' | translate}}"></md-chips>                                                                                                                                                                                     </div>                                                                                                                          </md-dialog-content>                                                                                                                <md-dialog-actions layout="row">                                                                                                        <md-button ng-click="select()" >                                                                                                        {{\'choose\' | translate}}                                                                                                      </md-button>                                                                                                                        <md-button ng-click="cancel()">                                                                                                         {{\'cancel\' | translate}}                                                                                                      </md-button>                                                                                                                    </md-dialog-actions>                                                                                                        </md-dialog>'
        });
    }
} ]);

(function() {
    var defaultInfo = {
        bar: {
            info: {
                aggregation: "1",
                canExportXlsx: true,
                refreshPeriod: "0",
                horizontalLines: true,
                sortMeasures: false,
                showSortBox: true,
                formatString: ",.0f",
                stackedBar: "1",
                stackedLine: "1",
                tooltip: "2",
                tooltipHeader: "{{set.key}}",
                tooltipFormat: '{{point.label}}: <span class="ltr inline" style="padding:0; margin:0;"><b>{{point.data}}</b></span>',
                xAxisLen: 20,
                font: {
                    bold: false,
                    color: "#333333",
                    italic: false,
                    fontSize: "12px",
                    fontName: "IRANSans",
                    formatString: ",.0f",
                    formatStringCustom: ",.0f"
                },
                secondaryY: {
                    enable: false,
                    ticksType: "auto",
                    ticksCount: 10,
                    ticksSpace: 20,
                    measures: {},
                    font: {
                        bold: false,
                        color: "#333333",
                        italic: false,
                        fontSize: "12px",
                        fontName: "IRANSans",
                        formatString: ",.0f",
                        formatStringCustom: ",.0f"
                    }
                },
                xAxisRotate: "-90",
                AxeY: {
                    ticksType: "auto",
                    ticksCount: 10,
                    ticksSpace: 20
                },
                showLegends: true
            }
        },
        map: {
            info: {
                aggregation: "1",
                canExportXlsx: true,
                refreshPeriod: "0",
                borderColor: "#374649",
                defaultColor: "#eeeeee",
                borderWidth: .5,
                tooltip: "3",
                tooltipFormat: '{{point.label}}: <span class="ltr inline" style="padding:0; margin:0;"><b>{{point.data}}</b></span>',
                tooltipHeader: "{{set.key}}",
                map: {
                    selectedMap: "1"
                },
                chartType: "pie",
                showLabels: false,
                mapType: "path",
                chartSize: 50,
                realMap: {
                    initialZoom: 5,
                    fillOpacity: .5
                },
                showLegend: true,
                selectableArea: true
            }
        },
        pie: {
            info: {
                aggregation: "1",
                canExportXlsx: true,
                tooltip: "3",
                hole: "50",
                refreshPeriod: "0",
                formatString: ",.0f",
                colorType: 1,
                tooltipHeader: "{{set.key}}",
                tooltipFormat: "{{point.label}}: {{point.data}} :: {{point.percentage}}%",
                sort: false
            }
        },
        tree: {
            info: {
                selectable: "one",
                aggregation: "1",
                canExportXlsx: true,
                tooltip: "3",
                refreshPeriod: "0",
                formatString: ",.0f",
                tooltipHeader: "{{set.key}}",
                tooltipFormat: "{{point.label}}: {{point.data}} :: {{point.percentage}}%",
                justFilterDirectChild: true
            }
        },
        gauge: {
            info: {
                font: {
                    bold: true,
                    color: "#333333",
                    italic: false,
                    fontSize: "34px",
                    fontName: "IRANSans",
                    formatString: ",.0f",
                    formatStringCustom: ",.0f"
                },
                aggregation: "1",
                canExportXlsx: true,
                textBold: true,
                textItalic: false,
                refreshPeriod: "0",
                segmentType: "singleSegment",
                style: "arc",
                height: "medium",
                formatString: ",.2f",
                fontSize: "3em",
                color: "#333333",
                colorAriaThree: "#e14d57",
                colorAriaTwo: "#FBEE58",
                colorAriaOne: "#71b37c"
            }
        },
        radar: {
            info: {
                aggregation: "1",
                canExportXlsx: true,
                refreshPeriod: "0",
                formatString: ",.0f"
            }
        },
        table: {
            info: {
                aggregation: "1",
                canExportXlsx: true,
                refreshPeriod: "0",
                sortMeasures: false,
                condensed: false,
                bordered: false,
                stripped: true,
                hover: true,
                showHeader: true,
                showRowNumber: false,
                rowAsKey: false,
                selectable: "multi",
                showAddButton: true,
                cellHeight: 60
            }
        },
        userControl: {
            info: {
                aggregation: "1",
                canExportXlsx: false,
                showFilterIcon: "0",
                type: "combo",
                comboStyle: "bootstrap",
                label: "",
                sliderRange: "min-max",
                dateFormatShow: "yy/mm/dd",
                dateOp: "eq",
                sliderFormat: ",.0f",
                variableId: "-1",
                variableDefaultType: "NONE",
                functionDateFormat: "yy/mm/dd",
                functionUnitAgo: 1,
                functionUnitAgoTwo: 0,
                functionUnitAgoOffset: 1,
                functionUnitAgoTwoOffset: 1,
                dateFormatValue: "yy/mm/dd",
                textOperand: "or",
                useLike: true,
                useNormal: true
            }
        },
        text: {
            info: {
                aggregation: "1",
                canExportXlsx: false,
                formatString: ",.0f",
                refreshPeriod: "0",
                showFilterIcon: "0",
                html: ""
            }
        }
    };
    var chartTypeMap = {
        1: "bar",
        2: "pie",
        4: "gauge",
        8: "radar",
        5: "table",
        6: "map",
        7: "userControl",
        9: "tree",
        10: "text"
    };
    var md = angular.module("management");
    md.directive("draggableItems", [ "$timeout", "refreshChartService", function($timeout, refreshChartService) {
        return function(scope, element, attrs) {
            function prepareSortable() {
                $("#columnList .datasource-field").draggable({
                    appendTo: ".chart-editor",
                    helper: "clone",
                    start: function(event, ui) {
                        $(ui.helper).addClass("ui-helper");
                        $(ui.helper).width($(event.currentTarget).width());
                    }
                });
                $("#divX, #divY, #divProv").droppable({
                    activeClass: "ui-state-default",
                    hoverClass: "ui-state-hover",
                    accept: ":not(.ui-sortable-helper)",
                    drop: function(event, ui) {
                        var id = $(this).attr("id");
                        if (scope.$parent.isOlap) {
                            var type = ui.draggable.attr("type");
                            var obj = null;
                            if (type == "measure" || type == "kpi") {
                                if (id != "divY") return;
                                obj = type == "measure" ? _.find(scope.$parent.olapCubes[+scope.$parent.selectedOlapCube || 0].Measures, {
                                    UniqueName: ui.draggable.data("name")
                                }) : _.find(scope.$parent.olapCubes[+scope.$parent.selectedOlapCube || 0].Kpis, {
                                    UniqueName: ui.draggable.data("name")
                                });
                                obj.type = type;
                                scope.$apply(function() {
                                    var div = id == "divX" ? scope.dimensions : id == "divY" ? scope.measures : scope.where;
                                    div.push($.extend({}, obj));
                                });
                            }
                            if (type == "dimension") {
                                var g = ui.draggable.attr("group-name");
                                obj = scope.$parent.olapCubes[+scope.$parent.selectedOlapCube || 0].Dimensions[+ui.draggable.attr("DimIndex")].group[g][+ui.draggable.attr("index")];
                                obj.type = "dimension";
                                var div = id == "divX" ? scope.dimensions : id == "divY" ? scope.measures : scope.where;
                                scope.$apply(function() {
                                    div.push($.extend({}, obj));
                                });
                            }
                            if (type == "namedset") {
                                var g = ui.draggable.attr("group-name");
                                obj = scope.$parent.olapCubes[+scope.$parent.selectedOlapCube || 0].NamedSets[+ui.draggable.attr("index")];
                                obj.type = "namedset";
                                var div = id == "divX" ? scope.dimensions : id == "divY" ? scope.measures : scope.where;
                                scope.$apply(function() {
                                    div.push($.extend({}, obj));
                                });
                            }
                            refreshChartService.refreshChart();
                        } else {
                            scope.$apply(function() {
                                var prop = getRelatedChartProp(scope.$parent.chartProp, scope.$parent.chartType, null, null, null, scope.$parent);
                                var concat = scope.dimensions.concat(scope.measures).concat(scope.where);
                                var div = id == "divX" ? scope.dimensions : id == "divY" ? scope.measures : scope.where;
                                var prepareDefualts = id == "divX" ? setDefaultForDimensions : id == "divY" ? setDefaultForMeasures : setDefaultForWheres;
                                div.push($.extend({}, prepareDefualts(scope.datasource.CubeInfo.Dimensions[+ui.draggable.attr("DimIndex")].Hierarchies[+ui.draggable.attr("index")], concat, prop, scope)));
                            });
                            refreshChartService.refreshChart();
                        }
                    }
                });
            }
            if (scope.$last) {
                prepareSortable();
            }
        };
    } ]);
    md.service("refreshChartService", [ "$timeout", function($timeout) {
        var refresh;
        var registerRefreshFunction = function(func) {
            refresh = func;
        };
        var refreshChart = function(param) {
            if (!refresh) return;
            refresh(param);
        };
        return {
            refreshChart: refreshChart,
            registerRefreshFunction: registerRefreshFunction
        };
    } ]);
    md.controller("chartsEditorCtrl", [ "$scope", "$http", "$mdToast", "$mdDialog", "$routeParams", "$location", "packages", "$timeout", "$translate", "utils", "$compile", "$mdSidenav", "$mdMedia", "menus", "datasources", "roles", "refreshChartService", "customChart", function($scope, $http, $mdToast, $mdDialog, $routeParams, $location, packages, $timeout, $translate, utils, $compile, $mdSidenav, $mdMedia, menus, datasources, roles, refreshChartService, customChart) {
        $scope.app = app;
        var packageId = typeof $routeParams.packageId != "undefined" ? $routeParams.packageId : 0;
        var id = typeof $routeParams.id != "undefined" ? $routeParams.id : 0;
        var chartTypeFromUrl = typeof $routeParams.charttype != "undefined" ? $routeParams.charttype : 0;
        var type = $routeParams.type;
        var isEdit = id > 0;
        $scope.isEdit = isEdit;
        $scope.id = id;
        var datasourceId;
        var chartId = id;
        var saveLink = app.urlPrefix + "moderation/olapchartdesign/SaveChart";
        var editMode = isEdit;
        var dataType;
        $scope.managementOnly = {
            sasa: "ddd"
        };
        $scope.olapData = {
            measures: [],
            kpis: []
        };
        $scope.dimensions = [];
        $scope.measures = [];
        $scope.where = [];
        $scope.chartDimensions = [];
        $scope.chartMeasures = [];
        $scope.chartType = {
            isCustom: false,
            id: 1
        };
        if (chartTypeFromUrl) {
            debugger;
            $scope.chartType = {
                isCustom: false,
                id: 5
            };
        }
        $scope.chartProp = $.extend({}, defaultInfo);
        $scope.relatedDatasource = [];
        $scope.filterException = {};
        $scope.calculatedFields = {};
        $scope.selectedTab = 0;
        $scope.showAddDatasource = function() {
            datasources.select(null, {
                type: [ "datasources" ]
            }).then(function(res) {
                var selected = res.selected[0];
                $scope.addRelatedDatasource(selected.id);
            });
        };
        $scope.showRelatedDatasource = function(ev) {
            $mdDialog.show({
                controller: [ "$scope", "$mdDialog", function(sp, $mdDialog) {
                    sp.$scope = $scope;
                    if (!$scope.relatedDatasourceList) $http.get(app.urlPrefix + "Moderation/OlapChartDesign/GetRelatedDatasource?DataSourceId=" + datasourceId).then(function(res) {
                        $scope.relatedDatasourceList = res.data.filter(function(d) {
                            return $scope.datasource.CubeInfo.Dimensions.map(function(d) {
                                return +d.UniqueName;
                            }).indexOf(+d.Id) === -1;
                        });
                    });
                    sp.cancel = function() {
                        $mdDialog.cancel();
                    };
                } ],
                templateUrl: "chart-editor/related-datasource.html",
                parent: angular.element(document.body),
                targetEvent: ev,
                clickOutsideToClose: true,
                fullscreen: $mdMedia("sm") || $mdMedia("xs")
            });
        };
        $scope.removeRelatedDatasource = function(i, u) {
            $scope.relatedDatasource.splice($scope.relatedDatasource.indexOf(+u.UniqueName), 1);
            var dim = $scope.datasource.CubeInfo.Dimensions.splice(i, 1);
            dim[0].Hierarchies.forEach(function(d) {
                function deleteField(arr) {
                    var index = arr.map(function(d) {
                        return d.UniqueName;
                    }).indexOf(d.UniqueName);
                    if (index !== -1) arr.splice(index, 1);
                }
                deleteField($scope.dimensions);
                deleteField($scope.measures);
                deleteField($scope.where);
            });
            $scope.refreshChart();
        };
        $scope.addRelatedDatasource = function(id) {
            $http.get(app.urlPrefix + "Moderation/OlapChartDesign/GetDatasourceDimension?DataSourceId=" + id).then(function(data) {
                $scope.finishedJob++;
                if ($scope.finishedJob == $scope.maxJob) {
                    $scope.$broadcast("finishJobs");
                }
                $scope.datasource.CubeInfo.Dimensions.push(data.data);
                if ($scope.relatedDatasource.indexOf(id) == -1) $scope.relatedDatasource.push(id);
            }, function() {
                if ($scope.relatedDatasource.indexOf(id) != -1) $scope.relatedDatasource.splice($scope.relatedDatasource.indexOf(id), 1);
                $scope.finishedJob++;
                if ($scope.finishedJob == $scope.maxJob) {
                    $scope.$broadcast("finishJobs");
                }
                $scope.refreshChart();
            });
        };
        $scope.filterRelatedDatasource = function(item) {
            return $scope.relatedDatasource.indexOf(+item.Id) === -1;
        };
        $scope.menu = {
            name: "salam"
        };
        function changeChartType() {
            if ($scope.chartType.isCustom) {
                customChart.getSettingsTemplate($scope.chartType.id).then(function(template) {
                    $scope.chartProp.customChartSettingTemplat = JSON.parse(template || "{}");
                    $scope.chartProp.customChart = $scope.chartProp.customChart || {
                        general: {},
                        series: {},
                        info: {
                            aggregation: 1
                        }
                    };
                    $scope.chartProp.customChart.config = $scope.chartProp.customChartSettingTemplat.config;
                    _.each($scope.chartProp.customChartSettingTemplat.general, function(item) {
                        if (typeof $scope.chartProp.customChart.general[item.key] == "undefined") {
                            $scope.chartProp.customChart.general[item.key] = item.default;
                        }
                    });
                    $scope.customChartDefaultSeries = {};
                    _.each($scope.chartProp.customChartSettingTemplat.series, function(item) {
                        if (typeof $scope.chartProp.customChart.series[item.key] == "undefined") {
                            $scope.customChartDefaultSeries[item.key] = item.default;
                        }
                    });
                    $scope.refreshChart();
                });
            }
            var el = {};
            $scope.cntrName = "chartsEditorCtrl";
            switch (+$scope.chartType.id) {
              case 1:
                el = '<div  ng-chart-properties management-only="managementOnly" open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="bar" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>';
                break;

              case 2:
                el = '<div  ng-chart-properties management-only="managementOnly" open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="pie" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>';
                break;

              case 4:
                el = '<div  ng-chart-properties management-only="managementOnly" open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="gauge" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>';
                break;

              case 5:
                el = '<div  ng-chart-properties management-only="managementOnly" open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="table" dimensions="dimensions" measures="measures" where="where" datasource="datasource"  filter-exception="filterException" calculated-fields="calculatedFields"></div>';
                break;

              case 6:
                el = '<div  ng-chart-properties management-only="managementOnly" open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="map" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>';
                break;

              case 7:
                el = '<div  ng-chart-properties management-only="managementOnly" open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="userControl" dimensions="dimensions" measures="measures" where="where" datasource="datasource"  filter-exception="filterException" calculated-fields="calculatedFields"></div>';
                break;

              case 8:
                el = '<div  ng-chart-properties management-only="managementOnly" open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="radar" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>';
                break;

              case 9:
                el = '<div  ng-chart-properties management-only="managementOnly" open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="tree" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>';
                break;

              case 10:
                el = '<div ng-chart-properties management-only="managementOnly" open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="text" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>';
                break;

              default:
                el = '<div ng-chart-properties open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="bar" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>';
                break;
            }
            if ($scope.chartType.isCustom) {
                el = '<div ng-chart-properties managementOnly="managementOnly" open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="customChart" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>';
            }
            $timeout(append, 0);
            function append() {
                if (!angular.element("#divProp div")) {
                    $timeout(append, 50);
                    return;
                }
                angular.element("#divProp div").remove();
                angular.element("#divProp").append(el);
                $compile(angular.element("#divProp"))($scope);
                if (!$scope.chartType.isCustom) $scope.refreshChart();
            }
        }
        $scope.refreshingCube = function() {
            var cube = $scope.olapCubes[$scope.selectedOlapCube];
            $scope.refreshCube = true;
            $http.get(app.urlPrefix + "Moderation/OlapChartDesign/ResetCube?CubeName=" + cube.Name + "&DataSourceId=" + datasourceId).then(function() {
                $scope.refreshCube = false;
            }, function() {
                $scope.refreshCube = false;
                alert("اشکال در روند اجرای برنامه");
            });
        };
        $scope.gettingData = true;
        $scope.collapseAll = function(p) {
            _.each($scope.olapCubes[+$scope.selectedOlapCube].Dimensions, function(d) {
                d.expand = p;
            });
            $scope.measureExp = p;
            $scope.kpiExp = p;
        };
        $scope.changeCube = function() {
            var cube = $scope.olapCubes[$scope.selectedOlapCube];
            if (cube.Dimensions) return;
            $http.get(app.urlPrefix + "Moderation/OlapChartDesign/GetCubeInnerData?CubeName=" + cube.Name + "&DataSourceId=" + datasourceId).then(function(res) {
                var r = performance.now();
                $scope.olapCubes[$scope.selectedOlapCube] = res.data.CubeInfo;
                groupMeasuresAndDims($scope.olapCubes[$scope.selectedOlapCube]);
            }, function() {});
        };
        $scope.gr = function(a, f, u) {
            return _.groupBy(a, f);
        };
        function groupMeasuresAndDims(cube) {
            _.forEach(cube.Dimensions, function(d) {
                d.group = _.groupBy(d.Hierarchies, "DisplayFolder");
            });
            cube.pkiGroup = _.groupBy(cube.Kpis, "ParentUniquename");
            cube.MeasureGroups = cube.MeasureGroups || [];
            cube.MeasureGroups.unshift({
                name: "All",
                caption: "همه"
            });
            $scope.selectedMeasureGroup = "All";
            $scope.datasource.CubeInfo = $scope.olapCubes[$scope.selectedOlapCube];
        }
        $scope.getColumnList = function() {
            if (!$scope.datasource) {
                $http.get(app.urlPrefix + "Moderation/OlapChartDesign/CubeInformation?DataSourceId=" + datasourceId).then(function(res) {
                    $scope.gettingData = false;
                    var data = res.data;
                    $scope.isOlap = data.isOlap;
                    $scope.datasource = data;
                    if (data.isOlap) {
                        $scope.olapCubes = data.olapCubes;
                        $scope.selectedOlapCube = "0";
                        groupMeasuresAndDims($scope.olapCubes[0]);
                    }
                    $scope.$broadcast("datasourceReady");
                });
            }
        };
        $scope.gotoDatasource = function(ds) {
            var Types = {
                MsOlap: 1,
                MSSQL: 2,
                MySQL: 3,
                File: 4,
                WebResource: 5,
                JoinDatasource: 6
            };
            var packageId = 0;
            switch (ds.DatasourceType) {
              case Types.MySQL:
                $location.path("datasources/add/mssql/" + Types.MySQL + "/" + packageId + "/" + ds.UniqueName);
                break;

              case Types.MsOlap:
                $location.path("datasources/add/mssql/" + Types.MsOlap + "/" + packageId + "/" + ds.UniqueName);
                break;

              case Types.MSSQL:
                $location.path("datasources/add/mssql/" + Types.MSSQL + "/" + packageId + "/" + ds.UniqueName);
                break;

              case Types.File:
                $location.path("datasources/add/file/" + packageId + "/" + ds.UniqueName);
                break;

              case Types.WebResource:
                $location.path("datasources/add/web/" + packageId + "/" + ds.UniqueName);
                break;

              case Types.JoinDatasource:
                $location.path("datasources/add/join/" + packageId + "/" + ds.UniqueName);
                break;

              default:            }
        };
        $scope.gotoChart = function(u) {
            $location.path("charts/edit/0/" + u.Id);
        };
        var filterDialog = function(ev) {
            $mdDialog.show({
                controller: [ "$scope", "$mdDialog", function(sp, $mdDialog) {
                    sp.parent = $scope;
                    sp.cancel = function() {
                        $mdDialog.cancel();
                    };
                    sp.save = function() {
                        sp.parent.refreshChart();
                        $mdDialog.cancel();
                    };
                } ],
                templateUrl: "editor/filterMember.html",
                parent: angular.element(document.body),
                targetEvent: ev,
                clickOutsideToClose: true,
                fullscreen: $mdMedia("sm") || $mdMedia("xs")
            });
        };
        $scope.filterMember = function(i, silent, callback) {
            $scope.members = null;
            if (!silent) {
                filterDialog();
            }
            var oldVersion = i.members && !i.members.list;
            $http.post(app.urlPrefix + "Moderation/OlapChartDesign/GetMember", JSON.stringify({
                CubeName: $scope.isOlap ? $scope.olapCubes[+$scope.selectedOlapCube || 0].Name : "",
                Uniquename: $scope.isOlap ? i.UniqueName : i.formula,
                orderBy: i.sortKey === "NONE" ? i.formula : i.sortFormula,
                orderType: i.sortOrder,
                DataSourceId: datasourceId,
                calculatedFields: []
            }), {
                headers: {
                    "Content-Type": "application/json; charset=utf-8"
                }
            }).then(function(d) {
                var res = d.data;
                if (res.result) {
                    var temp = {
                        name: i.Name,
                        isNumeric: res.isNumeric,
                        list: res.data,
                        numericFilter: {
                            type: "condition",
                            conditions: [ {
                                condition: "none",
                                parameter: "0"
                            }, {
                                condition: "none",
                                parameter: ""
                            } ],
                            conditionType: "and",
                            func: "aboveAvg"
                        },
                        aggregation: i.aggregation,
                        filter: {
                            type: "value",
                            funcType: "time"
                        }
                    };
                    temp = _.extend({}, temp, i.members);
                    if (i.members) {
                        var checked = _.filter(i.members.list, {
                            Checked: true
                        });
                        checked.forEach(function(f) {
                            var entry = _.find(temp.list, {
                                UniqueName: f.UniqueName
                            });
                            if (entry) {
                                entry.Checked = true;
                            }
                        });
                    }
                    i.members = temp;
                }
                $scope.members = i.members;
                if (callback) callback();
            });
            i.userProperty = $scope.datasource.UsersProperty.map(function(d) {
                var o = {
                    Name: d
                };
                if (i.userProperty) {
                    o.Checked = _.some(i.userProperty, {
                        Name: d,
                        Checked: true
                    });
                }
                return o;
            }).slice(0);
            i.globalVariable = $scope.datasource.GlobalVariable.map(function(d) {
                var o = {
                    Name: d.Name,
                    Id: d.Id
                };
                if (i.globalVariable) {
                    o.Checked = _.some(i.globalVariable, {
                        Id: d.Id,
                        Checked: true
                    });
                }
                return o;
            }).slice(0);
            $scope.globalVariable = i.globalVariable;
            $scope.userProperty = i.userProperty;
        };
        $scope.checkAll = function(a, e) {
            if (a) {
                a.forEach(function(d) {
                    d.Checked = e;
                });
            }
        };
        $scope.sortableOptions = {
            stop: function() {
                $timeout(function() {
                    $scope.refreshChart();
                }, 0);
            },
            receive: function(event, ui) {
                var targetId = $(event.target).attr("id");
                var sourceId = $(ui.sender).attr("id");
            }
        };
        function isComboKpi() {
            return $scope.type == "combo-kpi";
        }
        $scope.refreshChart = function(refreshMode) {
            app.chartCommons.drillDown.clearAll();
            var option = $.extend({
                needDim: true,
                needMeasure: true,
                needServerData: true
            }, refreshChartOptions($scope));
            $scope.chartRenderError = null;
            var config = app.customChart.getConfig($scope.chartType) || {};
            if (config.needData !== false && !isComboKpi() && option.needDim && $scope.dimensions.length == 0) {
                $("#divChart").empty();
                $translate("chart_editor_need_dimention").then(function(t) {
                    $scope.chartRenderError = t;
                });
                return;
            }
            if (config.needData !== false && !isComboKpi() && option.needMeasure && $scope.measures.length == 0) {
                $("#divChart").empty();
                $translate("chart_editor_need_measure").then(function(t) {
                    $scope.chartRenderError = t;
                });
                return;
            }
            if (config.needData !== false && isComboKpi() && !$scope.combo.selectedChart.length) {
                $("#divChart").empty();
                $translate("chart_editor_need_chart").then(function(t) {
                    $scope.chartRenderError = t;
                });
                return;
            }
            if (refreshMode && $("#divChart").data("isChart")) {
                var s = $("#divChart").data("settings");
                if (typeof s.input == "undefined") return;
                if (!s.input.result) {
                    refreshMode = null;
                }
                if (!isComboKpi() && option.needServerData && !s.input.fields && (+$scope.chartType.id == 7 && !$scope.chartType.isCustom)) {
                    refreshMode = "refreshWithData";
                }
            }
            var ChartInfo = {
                Title: "",
                CubeName: $scope.isOlap ? $scope.olapCubes[+$scope.selectedOlapCube || 0].Name : "xxx",
                Description: "",
                Hierarchies: mapping($scope.dimensions, $scope.isOlap),
                Where: mapping($scope.where, $scope.isOlap),
                SeriesLevel: mapping($scope.measures, $scope.isOlap),
                DataSourceId: datasourceId,
                Detail: JSON.stringify({
                    chartProp: getRelatedChartProp($scope.chartProp, $scope.chartType, $scope.dimensions, $scope.measures, $scope.where, $scope),
                    needServerData: option.needServerData,
                    tableInfo: $scope.tableInfo,
                    relatedDatasource: $scope.relatedDatasource,
                    filterException: $scope.filterException,
                    calculatedFields: $scope.calculatedFields,
                    dataType: $scope.type,
                    combo: $scope.combo
                })
            };
            if ($scope.isOlap) {
                ChartInfo.Measurs = _.map(_.filter($scope.measures, [ "type", "measure" ]), "UniqueName");
                ChartInfo.Kpis = _.map(_.filter($scope.measures, [ "type", "kpi" ]), "UniqueName");
            }
            var data = {
                ChartInfo: ChartInfo,
                notEditMode: false
            };
            var opt = {
                chartProp: getRelatedChartProp($scope.chartProp, $scope.chartType, $scope.dimensions, $scope.measures, $scope.where, $scope),
                parameters: data,
                editMode: true,
                needServerData: option.needServerData,
                tableInfo: $scope.tableInfo,
                relatedDatasource: $scope.relatedDatasource,
                calculatedFields: $scope.calculatedFields,
                dataType: $scope.type,
                combo: $scope.combo
            };
            $("#divChart").data("chartInfo", ChartInfo);
            app.chartCommons.drillDown.clear(-1);
            clearTimeout($scope.lastRefreshTimeout);
            $scope.lastRefreshTimeout = setTimeout(function myfunction() {
                opt.permissions = {};
                opt.type = $scope.chartType;
                opt.title = $scope.chartName || "";
                if (!refreshMode) {
                    $("#divChart").empty();
                }
                dashboard.addChart(null, opt, refreshMode, 0, $("#divChart"));
            }, 400);
            $("#divChart").off("legendClick");
            $("#divChart").on("legendClick", function(i, a, b, c) {
                $timeout(function() {
                    $scope.menu.set("series");
                    $scope.chartProp.selectedSeries = c.key;
                }, 20);
            });
        };
        refreshChartService.registerRefreshFunction($scope.refreshChart);
        $scope.gotoDimentionSettings = function(dim, index) {
            $scope.menu.set("dimension");
            $scope.menu.selectedDimension = index + "";
        };
        $scope.gotoMeasureSettings = function(dim, index) {
            $scope.menu.set("measure");
            $scope.menu.selectedMeasure = index + "";
        };
        $scope.gotoWhereSettings = function(dim, index) {
            $scope.menu.set("where");
            $scope.menu.selectedwhere = index + "";
        };
        $("#divChart").bind("tableInfo", null, function(e, d) {
            $timeout(function() {
                var lastLimit = $scope.tableInfo ? $scope.tableInfo.Limit || 10 : 10;
                $scope.tableInfo = d.TableInfo;
                $scope.tableInfo.Limit = lastLimit;
                $scope.chartProp.tableInfo = $scope.tableInfo;
            }, 0);
        });
        $("#divChart").bind("columnsWidth", null, function(e, d) {
            $timeout(function() {
                $scope.chartProp.table.info.columnsWidth = d.columnsWidth;
            }, 0);
        });
        $("#divChart").bind("chartproperty", null, function(e, d) {
            $timeout(function() {
                $scope.chartProp.series = d;
                if ($scope.chartType.isCustom) {
                    _.each($scope.chartProp.series, function(item) {
                        if ($scope.chartProp.customChart && $scope.chartProp.customChart.series && typeof $scope.chartProp.customChart.series[item] == "undefined") {
                            $scope.chartProp.customChart.series[item] = _.extend({}, $scope.customChartDefaultSeries);
                        }
                    });
                }
            }, 0);
        });
        $("#divChart").bind("dimColor", null, function(e, d) {
            $timeout(function() {
                $scope.chartProp.dimColor = $scope.chartProp.dimColor || {};
                _.each(d, function(item) {
                    $scope.chartProp.dimColor[item] = {};
                });
            }, 0);
        });
        menus.get().then(function(res) {
            _.forEach(res.data, function(d) {
                d.check = false;
            });
            var a = _.sortBy(res.data, [ "parentOrder", "order" ]);
            $scope.menus = _.groupBy(angular.merge([], a), "parent");
            checkMenuChecks();
        });
        $scope.showDialog = function(ev, exit) {
            $mdDialog.show({
                controller: [ "$scope", "$mdDialog", function(sp, $mdDialog) {
                    sp.parent = $scope;
                    sp.cancel = function() {
                        $mdDialog.cancel();
                    };
                    sp.save = function() {
                        if (!isEdit) sp.parent.saveNewChart(exit);
                        $mdDialog.cancel();
                    };
                } ],
                templateUrl: "editor/save-chart.html",
                parent: angular.element(document.body),
                targetEvent: ev,
                clickOutsideToClose: true,
                fullscreen: $mdMedia("sm") || $mdMedia("xs")
            });
        };
        $scope.save = function(ev, exit) {
            if (!editMode) {
                $scope.showDialog(ev, exit);
                return;
            }
            $scope.saveNewChart(exit);
        };
        function checkMenuChecks() {
            if ($scope.menusSelected && $scope.menus) {
                _.forEach($scope.menus, function(group) {
                    _.forEach(group, function(menu) {
                        if ($scope.menusSelected.indexOf(menu.id) != -1) menu.check = true;
                    });
                });
            }
        }
        function backFromEditor() {
            if (typeof Storage !== "undefined") {
                var returnUrl = localStorage.getItem("returnUrl");
                localStorage.removeItem("returnUrl");
                if (!_.isUndefined(returnUrl) && !_.isEmpty(returnUrl)) {
                    window.location.href = returnUrl;
                    return;
                }
            }
            if (window.history.length <= 2) {
                $location.path("charts");
            } else {
                window.history.back();
            }
        }
        $scope.cancel = function() {
            backFromEditor();
        };
        $scope.delete = function(ev) {
            var link = app.urlPrefix + "Moderation/Charts/DeleteCharts";
            var confirm = $mdDialog.confirm().title("حذف برای همیشه؟").textContent("آیا برای حذف نمودار " + $scope.chartName + " اطمینان دارید؟").ariaLabel("حذف").targetEvent(ev).ok("حذف!").cancel("لغو");
            $mdDialog.show(confirm).then(function() {
                $http.post(link, [ "ChartId-" + $scope.id ]).then(function(res) {
                    if (res.data.result) {
                        var toast = $mdToast.simple().textContent("حذف انجام شد");
                        $mdToast.show(toast);
                        if (window.history.length == 2) {
                            $location.path("charts");
                        } else {
                            window.history.back();
                        }
                    }
                }, function() {
                    var toast = $mdToast.simple().textContent("اشکال در حذف!");
                    $mdToast.show(toast);
                });
            });
        };
        $scope.saveNewChart = function(exit) {
            if (!$scope.chartName) {
                $translate("form_name_required").then(function(t) {
                    utils.showErrorToast(t);
                });
                return false;
            }
            var chartActions = _.filter($scope.roles, {
                check: true
            }).map(function(i) {
                return i.action + "-" + i.id;
            });
            var chartExtraActions = _.filter($scope.roles, {
                check: true
            }).map(function(i) {
                return {
                    id: i.id,
                    permissions: i.extra
                };
            });
            var menus = [];
            _.forEach($scope.menus, function(group) {
                _.forEach(group, function(menu) {
                    if (menu.check) menus.push(menu.id);
                });
            });
            cleanChartprop($scope.chartProp, $scope.chartType);
            var option = $.extend({
                needDim: true,
                needMeasure: true,
                needServerData: true
            }, refreshChartOptions($scope));
            if ($scope.combo && !editMode) $scope.combo.title = $("#chartTitleFarsi").val();
            var prop = getRelatedChartProp($scope.chartProp, $scope.chartType, $scope.dimensions, $scope.measures, $scope.where, $scope);
            console.log("#  save managementOnly", $scope.managementOnly);
            var opt = {
                datasourceId: datasourceId,
                relatedDatasource: $scope.relatedDatasource,
                dimensions: $scope.dimensions,
                measures: $scope.measures,
                where: $scope.where,
                chartType: $scope.chartType,
                expandedChartType: $scope.expandedChartType,
                chartProp: prop,
                needServerData: option.needServerData,
                tableInfo: $scope.tableInfo,
                filterException: $scope.filterException,
                calculatedFields: $scope.calculatedFields,
                dataType: $scope.type,
                combo: $scope.combo,
                isOlap: $scope.isOlap,
                selectedOlapCube: $scope.selectedOlapCube
            };
            var d = {
                id: chartId,
                editMode: editMode,
                xChartType: $scope.chartType.id,
                isCustom: $scope.chartType.isCustom,
                xTitleFarsi: $scope.chartName,
                chartUniquename: "",
                cubeName: $scope.isOlap ? $scope.olapCubes[+$scope.selectedOlapCube || 0].Name : "xxx",
                hierarchy: mapping($scope.dimensions, $scope.isOlap),
                where: mapping($scope.where, $scope.isOlap),
                seriesLevel: mapping($scope.measures, $scope.isOlap),
                ChartActions: chartActions,
                chartExtraActions: chartExtraActions,
                Menus: menus,
                detail: JSON.stringify(opt),
                DataSourceId: datasourceId,
                Desc: $scope.chartDesc,
                PackageId: packageId,
                managementOnly: $scope.managementOnly
            };
            if ($scope.isOlap) {
                d.measures = _.map(_.filter($scope.measures, [ "type", "measure" ]), "UniqueName");
                d.kpis = _.map(_.filter($scope.measures, [ "type", "kpi" ]), "UniqueName");
            }
            $scope.saveProgress = true;
            $http.post(saveLink, JSON.stringify(d), {
                headers: {
                    "Content-Type": "application/json; charset=utf-8"
                }
            }).then(function(res) {
                $scope.saveProgress = false;
                $translate("chart_editor_save_success").then(function(t) {
                    $mdToast.show($mdToast.simple().textContent(t));
                });
                $location.path("charts/edit/" + packageId + "/" + res.data.id).replace();
                datasources.reset();
                if (exit) backFromEditor();
            }).catch(function() {
                $scope.saveProgress = false;
                $mdToast.show({
                    template: '<md-toast class="md-toast error"> <span class="md-toast-text" flex>خطا در ذخیره‌سازی</span></md-toast>',
                    hideDelay: 3e3,
                    position: "bottom left"
                });
            });
            return true;
        };
        $scope.addLevelType = function() {
            if (typeof $scope.chartProp.levelTypes === "undefined") {
                $scope.chartProp.levelTypes = {
                    enable: true,
                    current: 0,
                    props: [ getLevelprop($scope) ]
                };
            }
            var alias = $scope.chartProp.levelTypes;
            alias.props = alias.props || [ {} ];
            alias.props.push(getLevelprop($scope));
            var old = alias.current;
            alias.current = alias.props.length - 1 + "";
            $scope.changeLevelType(alias.current, old);
        };
        $scope.removeLevelType = function() {
            var obj = $scope.chartProp.levelTypes;
            if (obj.props.length < 2) return;
            if (_.isArray(obj.props) && obj.props.length) {
                $scope.chartProp.levelTypes.props.splice(obj.props.length - 1, 1);
            }
            if (+obj.current === obj.props.length) {
                obj.current = +obj.current - 1 + "";
                $scope.changeLevelType(obj.current, +obj.current + 1);
            }
            if (obj.props.length === 1) {
                obj.enable = false;
            }
        };
        $scope.changeLevelType = function(nVal, oVal) {
            var alias = $scope.chartProp.levelTypes;
            alias.props = alias.props || [];
            if (alias.props.length > +oVal) {
                alias.props[+oVal] = getLevelprop($scope);
            }
            var newProp = _.merge({}, alias.props[+nVal]);
            if (newProp && newProp.type) {
                var key = chartTypeMap[+newProp.type.id];
                if (newProp.type.isCustom) {
                    key = "customChart";
                }
                $scope.chartProp[key] = _.merge({}, newProp.prop);
                $scope.chartType = _.merge({}, newProp.type);
            }
            changeChartType();
        };
        $scope.restore = function(restore) {
            var defaults = {
                datasourceId: -1,
                dimensions: [],
                relatedDatasource: [],
                measures: [],
                where: [],
                chartType: 1,
                chartProp: {},
                tableInfo: null,
                filterException: {},
                calculatedFields: {},
                isOlap: false
            };
            restore = $.extend({}, defaults, restore);
            datasourceId = restore.datasourceId;
            $scope.relatedDatasource = restore.relatedDatasource;
            $scope.where = restore.where;
            $scope.chartType = restore.chartType;
            if (typeof restore.chartType.isCustom === "undefined") {
                $scope.chartType = {
                    isCustom: false,
                    id: restore.chartType
                };
            }
            var chartProp = {};
            if ($scope.chartType.isCustom) {
                chartProp["customChart"] = restore.chartProp;
            } else {
                chartProp[chartTypeMap[+$scope.chartType.id]] = restore.chartProp;
            }
            chartProp.levelTypes = restore.chartProp.levelTypes;
            $scope.dimensions = restore.dimensions;
            $scope.measures = restore.measures;
            $scope.chartProp = _.extend({}, defaultInfo, chartProp);
            $scope.expandedChartType = restore.expandedChartType;
            $scope.tableInfo = restore.tableInfo;
            $scope.filterException = restore.filterException;
            $scope.calculatedFields = restore.calculatedFields || {};
            $scope.maxJob = 0;
            $scope.finishedJob = -1;
            $scope.isOlap = restore.isOlap;
            $scope.selectedOlapCube = restore.selectedOlapCube;
            $scope.selectedOlapCube = _.findIndex($scope.olapCubes, {
                Name: $scope.chart.CubeName
            }) + "";
            if ($scope.isOlap && +$scope.selectedOlapCube != 0) {
                $scope.changeCube();
            }
            $scope.type = restore.dataType;
            $scope.combo = restore.combo || {};
            $scope.combo.synonyms = $scope.combo.synonyms || [];
            $scope.combo.aggregation = $scope.combo.aggregation || 0;
            $scope.maxJob = $scope.relatedDatasource ? $scope.relatedDatasource.length : 0;
            $scope.relatedDatasource.forEach(function(d) {
                $scope.addRelatedDatasource(d);
            });
            _.each($scope.combo.selectedChart, function(item) {
                $http.get(app.urlPrefix + "api/charts/get?id=" + item.Id).then(function(d) {
                    if (!d.data) {
                        _.remove($scope.combo.selectedChart, {
                            Id: item.Id
                        });
                        $scope.refreshChart();
                        return;
                    }
                    var f = _.find($scope.combo.selectedChart, {
                        Id: item.Id
                    });
                    f.Name = d.data.Name;
                });
            });
            if (_.isUndefined($scope.expandedChartType)) {
                var t = _.findKey($scope.chartNameMap, _.find($scope.chartNameMap, {
                    type: +$scope.chartType.id
                }));
                $scope.expandedChartType = +t;
            }
            changeChartType();
        };
        $scope.chagePivotFormula = function(pivot) {
            if (!$scope.measures) return;
            if (pivot == 1) {
                $scope.measures.forEach(function(d) {
                    var formula = "SUM(" + d.UniqueName + ")";
                    var func = "SUM";
                    if (!d.IsNumeric) {
                        formula = "COUNT(" + d.UniqueName + ")";
                        func = "COUNT";
                    }
                    d.formula = formula;
                    d.aggregation = func;
                });
            } else {
                $scope.measures.forEach(function(d) {
                    d.formula = d.UniqueName;
                    d.aggregation = "NONE";
                });
            }
        };
        $scope.setType = function(type) {
            $scope.type = type;
            if (type !== "combo-kpi") {
                $scope.getColumnList();
            } else {
                $scope.$broadcast("datasourceReady");
            }
            resize();
        };
        function resize() {
            var panelHeader = 55 + 1;
            var navbar = 50;
            var navbarMarginbottom = 10;
            var margins = 36 + 55 + 1 + 10 + 1 + 50 + 140 + 50 + 2;
            $("#tdChart").css("height", $(window).height() - margins + "px").css("overfolw", "auto");
            $("#menu").css("height", $(".panel-body.chart-design").height() + "px").css("overfolw", "auto");
            $("#chrt-prop").css("height", $(".panel-body.chart-design").height() + "px").css("overfolw", "auto");
            if ($scope.type === "combo-kpi") {
                $("#tdChart").css("height", $(window).height() - margins + 140 + "px").css("overfolw", "auto");
            }
        }
        $scope.charts = [];
        $scope.getCharts = function() {
            $http.get(app.urlPrefix + "api/charts/get").then(function(d) {
                if (d.data.result) $scope.charts = d.data.list; else $scope.charts = [];
            }, function() {
                $scope.charts = [];
            });
        };
        $scope.showChartsDialog = function() {
            $("#charts-modal").modal("show");
            if (!$scope.charts || !$scope.charts.length) $scope.getCharts();
        };
        $scope.combo = {
            combineType: 0,
            aggregation: 0,
            selectedChart: [],
            synonyms: []
        };
        $scope.addChart = function(i) {
            $scope.combo.selectedChart.push(i);
            $scope.refreshChart();
        };
        $scope.selectChart = function(ev) {
            datasources.select(ev, [ "charts" ]).then(function(res) {
                if (res.type === "charts") {
                    _.forEach(res.selected, function(item) {
                        $scope.combo.selectedChart.push({
                            Id: item.id,
                            Name: item.name
                        });
                    });
                    $scope.refreshChart();
                }
            });
        };
        customChart.get().then(function(data) {
            $scope.customCharts = data;
            _.each(data, function(c) {
                $scope.chartNameMap[c.id + 1e3] = {
                    name: c.name,
                    type: c.id
                };
            });
        });
        if (isEdit) {
            $scope.selectedTab = 1;
            $http.get(app.urlPrefix + "api/charts/GetChartMenus?id=" + id).then(function(res) {
                $scope.menusSelected = res.data;
                checkMenuChecks();
            });
            roles.get().then(function(res) {
                $scope.roles = angular.merge({}, res.data.list);
                _.forEach($scope.roles, function(item) {
                    item.action = 1;
                    item.extra = [];
                    item.check = false;
                });
                checkRoleActions();
            });
            $http.get(app.urlPrefix + "api/permissions/getChartPermissions?id=" + $scope.id).then(function(res) {
                $scope.rolePermissions = res.data.list;
                checkRoleActions();
            });
            function checkRoleActions() {
                if ($scope.rolePermissions && $scope.roles) {
                    $scope.rolePermissionLoaded = true;
                    _.forEach($scope.roles, function(role) {
                        var permission = _.find($scope.rolePermissions, {
                            roleId: role.id
                        });
                        if (permission) {
                            role.action = permission.actionSum == 1 ? 1 : permission.actionSum == 3 ? 2 : 4;
                            if (_.isArray(permission.extra)) {
                                role.extra = permission.extra.slice();
                            }
                            role.check = true;
                        }
                    });
                }
            }
            $http.get(app.urlPrefix + "api/charts/getEditor?id=" + id).then(function(res) {
                datasourceId = res.data.dataSourceId;
                dataType = res.data.type;
                $scope.chart = res.data.chart;
                var detail = JSON.parse(res.data.chart.Detail);
                $scope.$on("datasourceReady", function() {
                    $scope.restore(detail);
                });
                $scope.setType(dataType);
                $scope.chartName = $scope.chart.Name;
                $scope.chartDesc = $scope.chart.Description;
                $scope.managementOnly = res.data.managementOnly;
            }, function(error) {
                if (error.data.desc) {
                    alert(error.data.desc);
                } else {
                    alert("خطا در دریافت اطلاعات نمودار");
                }
            });
        } else {
            datasourceId = $routeParams.datasourceId;
            dataType = $routeParams.type;
            if (dataType == "combo-kpi") {
                _.forEach(datasources.lastSelected.charts, function(item) {
                    $scope.combo.selectedChart.push({
                        Id: item.id,
                        Name: item.name
                    });
                });
            }
            $scope.setType(dataType);
            changeChartType();
        }
        $scope._ = _;
        $scope.existIn = function(item, array) {
            return _.some(array, {
                UniqueName: item.UniqueName
            });
        };
        $scope.notInMeasureGroup = function(dimension) {};
        $scope.addToChart = function(item) {
            var notNumber = !item.IsNumeric;
            var prop = getRelatedChartProp($scope.chartProp, $scope.chartType, null, null, null, $scope);
            var concat = $scope.dimensions.concat($scope.measures).concat($scope.where);
            var div = notNumber ? $scope.dimensions : $scope.measures;
            var prepareDefualts = notNumber ? setDefaultForDimensions : setDefaultForMeasures;
            div.push($.extend({}, prepareDefualts(item, concat, prop, $scope)));
            refreshChartService.refreshChart();
        };
        $scope.hide = function(item, type, v) {
            if (type === "measure") {
                var inGroup = item.GroupName == $scope.selectedMeasureGroup || $scope.selectedMeasureGroup == "All";
                var contain = true;
                if ($scope.query) contain = _.includes(normilize(item.Name).toLowerCase(), normilize($scope.query).toLowerCase());
                var ret = !inGroup || !contain;
                return ret;
            }
            if (type === "dimension") {
                var inGroup = _.indexOf(item.MeasureGroups, $scope.selectedMeasureGroup) != -1 || $scope.selectedMeasureGroup == "All";
                var contain = true;
                if ($scope.query) {
                    contain = _.includes(normilize(item.Name), normilize($scope.query));
                    for (var i = 0; i < item.Hierarchies.length; i++) {
                        contain = _.includes(normilize(item.Hierarchies[i].Name).toLowerCase(), normilize($scope.query).toLowerCase());
                        if (contain) break;
                    }
                }
                return !inGroup || !contain;
            }
            if (type === "check-name") {
                var contain = true;
                if ($scope.query) contain = _.includes(normilize(item.Name).toLowerCase(), normilize($scope.query).toLowerCase());
                return !contain;
            }
        };
        $scope.expandedChartType = 1;
        var lastExpandedChartType = 1;
        $scope.changeChartType = function(t, isCustom) {
            lastExpandedChartType = $scope.expandedChartType;
            app.chartCommons.clicked = true;
            $scope.expandedChartType = t;
            if (typeof $scope.chartNameMap[t] == "undefined") {
                $scope.chartType.id = t - 1e3;
            } else {
                $scope.chartType.id = $scope.chartNameMap[t].type;
            }
            $scope.chartType.isCustom = isCustom || false;
            if (lastExpandedChartType === 14 && $scope.expandedChartType !== 14) {
                $scope.chagePivotFormula(1);
            }
            if (lastExpandedChartType !== 14 && $scope.expandedChartType === 14) {
                $scope.chagePivotFormula(-1);
            }
            app.chartCommons.expandedType = $scope.expandedChartType;
            var prop = $scope.chartProp[chartTypeMap[+$scope.chartType.id]];
            if (!prop) {
                $scope.chartProp[chartTypeMap[+$scope.chartType.id]] = $.extend({}, defaultInfo);
                prop = $scope.chartProp[chartTypeMap[+$scope.chartType.id]];
            }
            app.chartCommons.changeSeriesPropertyBaseOnExpandedType(prop);
            changeChartType();
        };
        $scope.chartNameMap = {
            1: {
                name: app.lang.translate("bar"),
                type: 1
            },
            2: {
                name: app.lang.translate("stack-bar"),
                type: 1
            },
            3: {
                name: app.lang.translate("خطی"),
                type: 1
            },
            4: {
                name: app.lang.translate("stack-line"),
                type: 1
            },
            5: {
                name: app.lang.translate("area"),
                type: 1
            },
            6: {
                name: app.lang.translate("stack area"),
                type: 1
            },
            7: {
                name: app.lang.translate("pie"),
                type: 2
            },
            8: {
                name: app.lang.translate("donut"),
                type: 2
            },
            9: {
                name: app.lang.translate("arc gauge"),
                type: 4
            },
            10: {
                name: app.lang.translate("نمودار رادار"),
                type: 8
            },
            11: {
                name: app.lang.translate("نقشه"),
                type: 6
            },
            12: {
                name: app.lang.translate("نمودار درختی"),
                type: 9
            },
            13: {
                name: app.lang.translate("aggregated table"),
                type: 5
            },
            14: {
                name: app.lang.translate("table"),
                type: 5
            },
            15: {
                name: app.lang.translate("single select"),
                type: 7
            },
            16: {
                name: app.lang.translate("multi select"),
                type: 7
            },
            17: {
                name: app.lang.translate("تاریخ"),
                type: 7
            },
            18: {
                name: app.lang.translate("محدوده تاریخ"),
                type: 7
            },
            19: {
                name: app.lang.translate("range number"),
                type: 7
            },
            20: {
                name: app.lang.translate("search"),
                type: 7
            },
            21: {
                name: app.lang.translate("percent-stack-bar"),
                type: 1
            },
            22: {
                name: app.lang.translate("percent-stack-line"),
                type: 1
            },
            23: {
                name: app.lang.translate("percent-stack-area"),
                type: 1
            },
            24: {
                name: app.lang.translate("multi part arc gauge"),
                type: 4
            },
            25: {
                name: app.lang.translate("linear gauge"),
                type: 4
            },
            26: {
                name: app.lang.translate("multi part linear gauge"),
                type: 4
            },
            27: {
                name: app.lang.translate("number"),
                type: 4
            },
            28: {
                name: app.lang.translate("جعبه‌ای"),
                type: 1
            }
        };
    } ]);
    md.directive("ngChartProperties", function() {
        return {
            restrict: "AE",
            require: "^ngModel",
            scope: {
                ngModel: "=",
                dimensions: "=",
                measures: "=",
                where: "=",
                datasource: "=",
                type: "@",
                isOlap: "=",
                relatedDatasourceList: "=",
                calculatedFields: "=",
                filterException: "=",
                openMenuName: "=",
                managementOnly: "="
            },
            templateUrl: function(el, attrs) {
                switch (attrs["type"]) {
                  case "customChart":
                    return app.urlPrefix + "dist/partial/management/charts/directives/types/customChart.html?v=" + app.version;

                  case "bar":
                    return app.urlPrefix + "dist/partial/management/charts/directives/types/barLine.html?v=" + app.version;

                  case "map":
                    return app.urlPrefix + "dist/partial/management/charts/directives/types/map.html?v=" + app.version;

                  case "pie":
                    return app.urlPrefix + "dist/partial/management/charts/directives/types/pie.html?v=" + app.version;

                  case "gauge":
                    return app.urlPrefix + "dist/partial/management/charts/directives/types/gauge.html?v=" + app.version;

                  case "radar":
                    return app.urlPrefix + "dist/partial/management/charts/directives/types/radar.html?v=" + app.version;

                  case "table":
                    return app.urlPrefix + "dist/partial/management/charts/directives/types/table.html?v=" + app.version;

                  case "userControl":
                    return app.urlPrefix + "dist/partial/management/charts/directives/types/userControl.html?v=" + app.version;

                  case "tree":
                    return app.urlPrefix + "dist/partial/management/charts/directives/types/tree.html?v=" + app.version;

                  case "text":
                    return app.urlPrefix + "dist/partial/management/charts/directives/types/text.html?v=" + app.version;

                  default:
                    return app.urlPrefix + "dist/partial/management/charts/directives/types/customChart.html?v=" + app.version;
                }
            },
            controller: [ "$scope", "$timeout", function($scope, $timeout) {
                $scope.cntrName = "ngChartProperties";
                $scope.license = app.license || {};
                $scope._ = _;
                $scope.changeColor = function(e, scope, prop) {
                    $(e.target).colorSelector(scope && scope[prop] ? scope[prop] : "#1f77b4", function(d) {
                        $(e.target).css("background-color", d);
                        $scope.$apply(function() {
                            if (scope) scope[prop] = d;
                            $scope.refreshChart("refresh");
                            $scope.changeAllSeries(prop, d);
                        });
                    });
                };
                $scope.refreshChart = function(i) {
                    $scope.$parent.refreshChart(i);
                };
                $scope.chagePivotFormula = function(pivot) {
                    $scope.$parent.chagePivotFormula(pivot);
                };
                $scope.setTableInfoLimit = function(limit, useDistinct) {
                    $scope.$parent.tableInfo = $scope.$parent.tableInfo || {};
                    if (typeof limit != "undefined" && limit != null) $scope.$parent.tableInfo.Limit = limit;
                    if (typeof useDistinct != "undefined") $scope.$parent.tableInfo.useDistinct = useDistinct;
                };
                if ($scope.$parent.dereg) {
                    $scope.$parent.dereg();
                }
                $scope.$parent.dereg = $scope.$watch("dimensions", function(n, o) {
                    if (typeof n == "undefined") return;
                    $scope.ngModel.tree = $scope.ngModel.tree || {};
                    $scope.ngModel.tree.dimensions = $scope.ngModel.tree.dimensions || [];
                    for (var i = 0; i < n.length; i++) {
                        var el = n[i];
                        var hasValue = _.filter($scope.ngModel.tree.dimensions, {
                            name: el.Name
                        }).length;
                        if (!hasValue) {
                            $scope.ngModel.tree.dimensions.push({
                                type: i == 0 ? "id" : i == 1 ? "parent" : i == 2 ? "name" : "type",
                                name: el.Name
                            });
                        }
                    }
                }, true);
                $scope.changeAllSeries = function(prop, val) {
                    if ($scope.ngModel.selectedSeries == "{All}") {
                        var series = $scope.ngModel[$scope.type].series;
                        for (var k in series) {
                            series[k][prop] = series["{All}"] ? series["{All}"][prop] : val;
                        }
                    }
                };
            } ],
            link: function() {
                app.lang.setLang();
            }
        };
    });
    md.directive("managementOnlyDir", function() {
        return {
            scope: {
                managementOnly: "="
            },
            controller: [ "$scope", "$timeout", function($scope, $timeout) {
                $scope.updateModel = function(data) {
                    $scope.managementOnly.notifications = data;
                };
                $scope.render = true;
                $scope.updateModel = function(data) {
                    $scope.managementOnly.notifications = data;
                    $scope.render = false;
                    $timeout(function() {
                        $scope.render = true;
                    }, 0);
                    console.log("$scope.updateModel ", data);
                };
            } ],
            template: '                <menu-item class="">                    <menu-header style="position:relative" class="pointer">                        <div data-toggle="" href="#events">اعلان‌های سیستمی</div>                    </menu-header>                    <menu-body id="events" class="prop-section   form-horizontal">                        <register-notification type="\'chart\'" onupdate="updateModel" ng-model="managementOnly.notifications" ng-if="render"></register-notification>                    </menu-body>                </menu-item>'
        };
    });
    function getNewName(name, array) {
        var ext = 1;
        var n = array.map(function(d) {
            return d.toLowerCase();
        });
        if (n.indexOf(name.toLowerCase()) == -1) return name;
        while (n.indexOf(name.toLowerCase() + ext) != -1) ext++;
        return name + ext;
    }
    function mapping(dims, isOlap) {
        return dims.filter(function(d) {
            return !d.type || d.type != "kpi" && d.type != "measure";
        }).map(function(d) {
            return {
                Name: d.Name,
                UniqueName: d.UniqueName,
                Top: d.Top,
                sortOrder: d.sortOrder,
                sortKey: d.sortKey,
                sortFormula: d.sortFormula,
                formula: d.formula,
                formulas: d.formulas,
                applyLevel: d.applyLevel || 0,
                IsNamedSet: d.type === "namedset",
                aggregation: d.aggregation,
                Members: !d.members || !d.members.list ? [] : d.members.list.filter(function(d) {
                    return d.Checked;
                }).map(function(d) {
                    return isOlap ? d.UniqueName : d.Name;
                }),
                UserProperties: !d.userProperty ? [] : d.userProperty.filter(function(d) {
                    return d.Checked;
                }).map(function(d) {
                    return d.Name;
                }),
                GlobalViariable: !d.globalVariable ? [] : d.globalVariable.filter(function(d) {
                    return d.Checked;
                }).map(function(d) {
                    return d.Id;
                }),
                NumericFilter: !d.members ? "" : JSON.stringify(d.members.numericFilter),
                IsNumeric: !d.members ? false : d.members.isNumeric,
                filter: d.members ? d.members.filter : {},
                detail: JSON.stringify(d.detail || {})
            };
        });
    }
    function cleanChartprop(prop, type) {
        for (var p in prop) {
            try {
                var object = prop[p].series;
                if (typeof object === "undefined" || !object || !prop.hasOwnProperty(p)) continue;
                if (p !== (type.isCustom ? "customChart" : chartTypeMap[type.id])) {
                    delete prop[p];
                    continue;
                }
                for (var key in object) {
                    if (object.hasOwnProperty(key)) {
                        if (prop.series.indexOf(key) === -1) {
                            delete object[key];
                        }
                    }
                }
            } catch (e) {}
        }
    }
    function getLevelprop($scope) {
        var relate = _.merge({}, getRelatedChartProp($scope.chartProp, $scope.chartType, $scope.dimensions, $scope.measures, $scope.where));
        delete relate.levelTypes;
        return {
            prop: relate,
            type: _.merge({}, $scope.chartType)
        };
    }
    function getRelatedChartProp(prop, type, dimensions, measures, where, $scope) {
        if (!_.isUndefined(prop.tree)) {
            _.remove(prop.tree.dimensions, function(d) {
                return _.isUndefined(_.find(dimensions, {
                    Name: d.name
                }));
            });
        }
        var key = chartTypeMap[+type.id];
        if (type.isCustom) {
            key = "customChart";
        }
        if (!prop[key]) {
            prop[key] = defaultInfo[key];
        }
        var o = prop[key] || {};
        try {
            if ($scope) prop.levelTypes.props[+prop.levelTypes.current] = getLevelprop($scope);
        } catch (e) {}
        o.levelTypes = prop.levelTypes;
        return o;
    }
    function setDefaultForMeasures(d, arr, prop, scope) {
        var formula = "SUM(" + d.UniqueName + ")";
        var func = "SUM";
        if (!d.IsNumeric) {
            formula = "" + d.UniqueName + "";
            func = "NONE";
            if (!scope.measures.length) {
                formula = "COUNT(" + d.UniqueName + ")";
                func = "COUNT";
            }
        }
        d.Top = {
            IsTop: false,
            Top: 10,
            IsPercent: false,
            TopOrder: "DESC"
        };
        var r = $.extend({}, d, {
            formula: formula,
            aggregation: func
        });
        if (+prop.info.aggregation === -1) {
            r.formula = d.UniqueName;
            r.aggregation = "NONE";
        }
        r.Name = getNewName(d.Name, arr.map(function(d) {
            return d.Name;
        }));
        return r;
    }
    function setDefaultForDimensions(d, arr) {
        var r = $.extend({}, d, {
            sortOrder: "ASC",
            sortKey: "NONE",
            sortFormula: d.UniqueName,
            formula: d.UniqueName,
            applyLevel: 0,
            detail: {
                histogramCategory: {
                    enable: false,
                    width: 10,
                    count: 7,
                    overflowEnable: false,
                    underflowEnable: false,
                    overflow: 100,
                    underflow: 0,
                    type: "auto",
                    customLabels: [],
                    customLabelEnable: false
                }
            }
        });
        r.Name = getNewName(d.Name, arr.map(function(d) {
            return d.Name;
        }));
        return r;
    }
    function setDefaultForWheres(d, arr) {
        var r = $.extend({}, d, {
            sortOrder: "ASC",
            sortKey: "NONE",
            formula: d.UniqueName
        });
        r.Name = getNewName(d.Name, arr.map(function(d) {
            return d.Name;
        }));
        return r;
    }
    function refreshChartOptions(scope) {
        var chartType = scope.chartType.id;
        var chartProp = scope.chartProp[chartTypeMap[+chartType]];
        if (scope.chartType.isCustom) {
            return {
                needDim: true,
                needMeasure: true,
                needServerData: true
            };
        }
        switch (+chartType) {
          case chartTypes.UserControl:
            if (chartProp.info.type === "datepicker" || chartProp.info.type === "datepicker-range" || chartProp.info.type === "text") {
                return {
                    needDim: true,
                    needMeasure: false,
                    needServerData: false
                };
            }
            return {
                needDim: true,
                needMeasure: false,
                needServerData: true
            };

          case chartTypes.Tree:
            return {
                needDim: true,
                needMeasure: false,
                needServerData: true
            };

          case chartTypes.TABLE:
            if (+chartProp.info.aggregation === -1) return {
                needDim: true,
                needMeasure: false,
                needServerData: true
            }; else return {
                needDim: true,
                needMeasure: true,
                needServerData: true
            };

          default:
            return {
                needDim: true,
                needMeasure: true,
                needServerData: true
            };
        }
    }
    md.service("customChart", [ "$http", function($http) {
        var get = function(id) {
            if (!id) {
                return $http.get(app.urlPrefix + "api/customCharts/get").then(function(res) {
                    return res.data;
                });
            }
            return $http.get(app.urlPrefix + "api/customCharts/get/" + id).then(function(res) {
                return res.data;
            });
        };
        var getSettingsTemplate = function(id) {
            return $http.get(app.urlPrefix + "api/customCharts/getSettingsTemplate/" + id).then(function(res) {
                return res.data;
            });
        };
        var remove = function(id) {
            return $http.get(app.urlPrefix + "api/customCharts/remove/" + id).then(function(res) {
                return res.data;
            });
        };
        return {
            get: get,
            getSettingsTemplate: getSettingsTemplate,
            remove: remove
        };
    } ]);
    md.directive("topMeasure", function() {
        return {
            restrict: "E",
            scope: {
                model: "=?ngModel",
                change: "&ngChange",
                dims: "=?dims"
            },
            link: function(scope, element, attrs, tabsCtrl) {},
            controller: [ "$scope", function($scope) {
                $scope.dims = $scope.dims || [];
                if ($scope.model) $scope.model.selectedDims = $scope.model.selectedDims || {};
            } ],
            template: '                                                                                                                 <div class="form-row" layout="row" layout-align="start center" layout-wrap>                                                                 <md-switch ng-model="model.IsTop" ng-change="change()">                                                                         {{ \'isTop\' | translate }}                                                                                             </md-switch>                                                                                                            </div>                                                                                                                      <div ng-if="model.IsTop">                                                                                                       <div class="form-row" layout="row" layout-align="start center">                                                                 <label>{{ \'top\' | translate }}</label>                                                                                    <span class="form-divider" flex></span>                                                                                     <div>                                                                                                                           <md-switch ng-model="model.IsPercent" ng-change="change()" style="display:inline">                                              {{ \'IsPercent\' | translate }}                                                                                         </md-switch>                                                                                                                                                                                                                                            <input type="number" class="form-control" placeholder="{{ \'top\' | translate }}"                                                  ng-model-options="{ updateOn: \'blur\' }"                                                                                   ng-change="change()"                                                                                                        ng-model="model.Top" />                                                                                                                                                                                                                          <select class="selectpicker form-control"                                                                                           ng-model="model.TopOrder"                                                                                                   ng-change="change()"                                ng-options="color.name as  color.value for color in [                                    {name:\'DESC\', value: \'نزولی\'  },                                     {name:\'ASC\', value: \'صعودی\'  },                                     ]">                                                                                               </select>                                                                                                               </div>                                                                                                                  </div>                                                                                                                      <div class="form-row" layout="row" layout-align="start center">                                                                 <label>{{ \'Applied_to\' | translate }}</label>                                                                             <span class="form-divider" flex></span>                    <div>                                                                                                                           <md-checkbox ng-repeat="d in dims track by $index" ng-model="model.selectedDims[d.Name]" ng-change="change()">{{d.Name}}</md-checkbox>                       </div>                                                                                                                  </div>                                                                                                                  </div>                                                                                                                      '
        };
    });
})();

var ngApp = angular.module("management");

ngApp.controller("chartsListCtrl", [ "$scope", "$http", "$mdToast", "$mdDialog", "$routeParams", "$location", "packages", "$timeout", "$translate", "utils", "datasources", "toolbar", function($scope, $http, $mdToast, $mdDialog, $routeParams, $location, packages, $timeout, $translate, utils, datasources, toolbar) {
    $scope.utils = utils;
    var packageId = typeof $routeParams.id != "undefined" ? $routeParams.id : 0;
    $scope.app = app;
    $scope._ = _;
    var param = packageId ? "?packageId=" + packageId : "";
    $scope.progress = true;
    $http.get(app.urlPrefix + "api/charts/getList" + param).then(function(data) {
        process(data);
    }, error);
    function process(data) {
        var start = new Date();
        $scope.progress = false;
        $scope.allData = data.data.list;
        $scope.securityCertPatch = data.data.securityCertPatch;
        $scope.pageCount = 40;
        $scope.page = 1;
        $scope.maxPage = Math.ceil($scope.allData.length / $scope.pageCount);
        $scope.setPage = function(n) {
            $scope.page = n;
            $scope.data = $scope.allData.slice(($scope.page - 1) * $scope.pageCount, $scope.page * $scope.pageCount);
        };
        $scope.setPage(1);
        $translate("لیست نمودارها").then(function(t) {
            $scope.listTranslate = t;
            data.data.path.unshift({
                name: t,
                id: null
            });
            $scope.path = data.data.path.map(function(d) {
                d.click = function() {
                    $scope.goto({
                        type: 1,
                        id: d.id
                    });
                };
                return d;
            });
            toolbar.setTitles($scope.path);
        });
        $timeout(function() {
            console.log("Process time: " + (new Date() - start));
        }, 0);
    }
    utils.onError(function(er) {
        $scope.error = er;
        $scope.progress = false;
    });
    $translate("لیست نمودارها").then(function(t) {
        $scope.listTranslate = t;
    });
    var isSelected = function() {
        return _.some($scope.data, {
            select: true
        });
    };
    $scope.menuInvalidate = function() {
        var flag = isSelected();
        var dirCount = _.filter($scope.data, {
            select: true,
            type: 1
        }).length;
        var chartCount = _.filter($scope.data, {
            select: true,
            type: 2
        }).length;
        $scope.canCopy = flag;
        $scope.canDelete = flag;
        $scope.canForward = flag;
        $scope.canDirEdit = dirCount == 1 && chartCount == 0;
    };
    function getSelectedIds() {
        return _.map(_.filter($scope.data, {
            select: true
        }), function(d) {
            return d.type == 2 ? "ChartId-" + d.id : "PackageId-" + d.id;
        });
    }
    function addPackages(p) {
        var index = _.lastIndexOf($scope.data.map(function(e) {
            return e.type;
        }), 1);
        if (index == -1) $scope.data = p.concat($scope.data); else Array.prototype.splice.apply($scope.data, [ index + 1, 0 ].concat(p));
    }
    function error(e) {
        utils.showErrorToast(e.data.desc);
    }
    $scope.copy = function() {
        var link = app.urlPrefix + "Moderation/Charts/CloneCharts";
        var ids = getSelectedIds();
        $http.post(link, ids).then(function(res) {
            if (res.data.result) {
                if (res.data.inserted) {
                    $scope.data = $scope.data.concat(res.data.inserted);
                }
                if (res.data.packages) {
                    addPackages(res.data.packages);
                }
                var toast = $mdToast.simple().textContent("کپی انجام شد");
                $mdToast.show(toast);
            }
        }, error);
    };
    function deleteFromList(ids) {
        $scope.data = _.filter($scope.data, function(d) {
            var str = d.type == 2 ? "ChartId-" + d.id : "PackageId-" + d.id;
            return ids.indexOf(str) == -1;
        });
    }
    $scope.delete = function(ev) {
        var link = app.urlPrefix + "Moderation/Charts/DeleteCharts";
        var ids = getSelectedIds();
        var confirm = $mdDialog.confirm().title("حذف برای همیشه؟").textContent(ids.length + " مورد برای حذف انتخاب شده است").ariaLabel("حذف").targetEvent(ev).ok("حذف!").cancel("لغو");
        $mdDialog.show(confirm).then(function() {
            $http.post(link, ids).then(function(res) {
                if (res.data.result) {
                    if (res.data.deletedIds) {
                        deleteFromList(res.data.deletedIds);
                    }
                    var toast = $mdToast.simple().textContent("حذف انجام شد");
                    $mdToast.show(toast);
                    $scope.menuInvalidate();
                }
            }, error);
        });
    };
    $scope.forward = function(ev) {
        datasources.select(ev, {
            type: [ "charts" ],
            justDir: true,
            selectableDir: true,
            multipleChart: false
        }).then(function(res) {
            var selected = res.selected[0];
            if ($routeParams.id == selected.id) {
                var toast = $mdToast.simple().textContent("موارد انتخاب شده در همین پوشه هستند");
                $mdToast.show(toast);
                return;
            }
            var Ids = getSelectedIds();
            $http.post(app.urlPrefix + "Moderation/Charts/MoveToPackage", {
                Ids: Ids,
                packageId: selected.id
            }).then(function(data) {
                deleteFromList(data.data.ids);
                var toast = $mdToast.simple().textContent("انتقال انجام شد");
                $mdToast.show(toast);
            }, error);
        }, error);
    };
    $scope.dirEdit = function(ev) {
        var ids = getSelectedIds();
        var id = ids[0].replace("PackageId-", "");
        packages.edit(ev, 2, id, function(data) {
            _.find($scope.data, {
                select: true
            }).name = data.data.info.Name;
            var toast = $mdToast.simple().textContent("نام پوشه تغییر کرد");
            $mdToast.show(toast);
        }, error);
    };
    $scope.newPackage = function(ev) {
        packages.create(ev, 1, $routeParams.id, function(data) {
            addPackages([ {
                id: data.data.info.Id,
                name: data.data.info.Name,
                type: 1
            } ]);
            var toast = $mdToast.simple().textContent("پوشه جدید ایجاد شد");
            $mdToast.show(toast);
            datasources.reset();
        });
    };
    $scope.goto = function(row, event) {
        if (row.type == 1) {
            $location.path("charts" + (row.id ? "/" + row.id : ""));
        } else if (row.type == 2) {
            $location.path("charts/edit/" + packageId + "/" + row.id);
        }
    };
    $scope.getTypeName = function(i) {
        var TYPE_BAR = 1;
        var TYPE_PIE = 2;
        var TYPE_LINE = 3;
        var TYPE_GAUGE = 4;
        var TYPE_TABLE = 5;
        var TYPE_MAP = 6;
        var TYPE_USER_CONTROL = 7;
        var TYPE_RADAR = 8;
        var TYPE_TREE = 9;
        var imageSource = "";
        switch (+i) {
          case TYPE_BAR:
            imageSource = "Bar";
            break;

          case TYPE_PIE:
            imageSource = "Pie";
            break;

          case TYPE_LINE:
            imageSource = "Line";
            break;

          case TYPE_TABLE:
            imageSource = "Table";
            break;

          case TYPE_MAP:
            imageSource = "Map";
            break;

          case TYPE_USER_CONTROL:
            imageSource = "User Control";
            break;

          case TYPE_RADAR:
            imageSource = "Radar";
            break;

          case TYPE_TREE:
            imageSource = "Tree";
            break;
        }
        return imageSource;
    };
    $scope.getChartTypeImage = function(i) {
        var imageSource = "";
        var chartTypes = {};
        chartTypes.BAR = 1;
        chartTypes.PIE = 2;
        chartTypes.LINE = 3;
        chartTypes.GAUGE = 4;
        chartTypes.TABLE = 5;
        chartTypes.MAP = 6;
        chartTypes.USER_CONTROL = 7;
        chartTypes.RADAR = 8;
        chartTypes.TREE = 9;
        switch (+i) {
          case chartTypes.BAR:
            imageSource = app.urlPrefix + "Images/bar.png";
            break;

          case chartTypes.GAUGE:
            imageSource = app.urlPrefix + "Images/guage.png";
            break;

          case chartTypes.PIE:
            imageSource = app.urlPrefix + "Images/pie.png";
            break;

          case chartTypes.LINE:
            imageSource = app.urlPrefix + "Images/line.png";
            break;

          case chartTypes.TABLE:
            imageSource = app.urlPrefix + "Images/table.png";
            break;

          case chartTypes.MAP:
            imageSource = app.urlPrefix + "Images/map.png";
            break;

          case chartTypes.USER_CONTROL:
            imageSource = app.urlPrefix + "Images/combo_box.png";
            break;

          case chartTypes.RADAR:
            imageSource = app.urlPrefix + "Images/radar_plot.png";
            break;

          case chartTypes.TREE:
            imageSource = app.urlPrefix + "Images/tree.png";
            break;
        }
        return imageSource;
    };
    var timer;
    $scope.$watch("search", function() {
        $timeout.cancel(timer);
        timer = $timeout(function() {
            if (typeof $scope.search == "undefined") return;
            $scope.progress = true;
            $http.get(app.urlPrefix + "api/charts/getList" + "?q=" + $scope.search).then(function(data) {
                process(data);
            }, error);
        }, 400);
    });
    $scope.selectAll = function() {
        if ($scope.data) {
            _.forEach($scope.data, function(item) {
                item.select = $scope.selectAllCheckbox;
            });
        }
        $scope.menuInvalidate();
    };
    $scope.newChart = function(ev) {
        datasources.select(ev, {
            type: [ "charts", "datasources" ]
        }).then(function(res) {
            if (res.type == "charts") {
                datasources.lastSelected.charts = res.selected;
                $location.path("charts/new/combo-kpi/" + ($routeParams.id ? $routeParams.id : "0"));
            } else {
                $location.path("charts/new/normal/" + ($routeParams.id ? $routeParams.id : "0") + "/" + res.selected[0].id);
            }
        });
    };
    $scope.sortDetail = {};
    $scope.sort = function(field) {
        $scope.sortDetail[field] = $scope.sortDetail[field] || {};
        $scope.sortDetail[field].isDesc = !$scope.sortDetail[field].isDesc;
        var f = _.filter($scope.data, {
            type: 1
        });
        var d = _.filter($scope.data, {
            type: 2
        });
        d = _.sortBy(d, [ field ]);
        f = _.sortBy(f, [ field ]);
        if (!$scope.sortDetail[field].isDesc) {
            d = _.reverse(d);
            f = _.reverse(f);
        }
        $scope.data = f.concat(d);
    };
} ]);

(function($) {
    var md = angular.module("management");
    md.directive("alert", [ "$timeout", "$http", "datasources", function($timeout, $http, datasources) {
        return {
            restrict: "E",
            templateUrl: app.urlPrefix + "dist/partial/management/charts/directives/alert.html?v=" + app.version,
            scope: {
                model: "=prop",
                config: "="
            },
            controller: [ "$scope", "$sce", function($scope, $sce) {
                $scope.name = "ALERT_CONTROLLER";
                $scope.s = $sce;
                $scope.contactList = [ {
                    phone: "",
                    email: ""
                } ];
                $scope.roleList = null;
                $scope.userList = null;
                $scope.schedule = {
                    occure: "daily",
                    dailyRecurs: 1,
                    weeklyRecurs: 1,
                    weeklySat: false,
                    weeklySun: false,
                    weeklyMon: false,
                    weeklyTus: false,
                    weeklyWen: false,
                    weeklyThu: false,
                    weeklyFri: false,
                    monthlyDayOf: 1,
                    monthlyRecurs: 1,
                    dailyFrequency: "once",
                    dailyFrequencyAtHour: "1200",
                    dailyFrequencyRecur: 1,
                    dailyFrequencyRecurType: "hour",
                    dailyFrequencyStart: "1200",
                    dailyFrequencyStop: "2359"
                };
                $scope.getPreview = function(alert, isPreview) {
                    console.log("### alertx c", alert);
                    var chartId = $scope.$parent.$parent.$parent.$parent.id;
                    if (+chartId == 0) {
                        alert("ابتدا باید نمودار را ذخیره کنید");
                        return;
                    }
                    alert.previewProgress = true;
                    $http.post(app.urlPrefix + "Moderation/Alert/preview", {
                        id: chartId,
                        alert: alert,
                        isPreview: isPreview
                    }).then(function(res) {
                        alert.previewProgress = false;
                        alert.preview = res.data;
                    }).catch(function(res) {
                        alert.previewProgress = false;
                        alert.preview = {
                            result: false,
                            message: res
                        };
                    });
                };
                $scope.selectDatasource = function(ev, alert) {
                    datasources.select(ev, {
                        type: [ "datasources" ]
                    }).then(function(res) {
                        alert.error = null;
                        alert.selectedDatasource = res.selected[0];
                        alert.selectedDatasourceId = res.selected[0].id;
                        alert.datasourceCaptionsColumn = [];
                        $scope.getColumns(alert);
                    });
                };
                $scope.getColumns = function(alert) {
                    datasources.getColumns(alert.selectedDatasource.id).then(function success(data) {
                        alert.getInfoProgress = false;
                        alert.datasourceColumns = data.CubeInfo.Dimensions[0].Hierarchies;
                        alert.userProperties = data.UsersProperty;
                    }, function error(res) {
                        alert.error = res;
                    });
                };
                $scope.newAlert = function() {
                    $scope.model[$scope.config.name].alerts.push({
                        type: "sms",
                        body: "@{name}\n@{update-time}\n@{content}\n@{filters}",
                        rules: [ {} ],
                        schedule: _.merge({}, $scope.schedule),
                        format: "[@{k} :: ][, ][@{m}: @{n}]",
                        selectedSeries: [],
                        contactType: "role"
                    });
                    $timeout(function() {
                        app.lang.setLang();
                    }, 0);
                };
                $scope.formatClock = function(o) {
                    var s = o + "";
                    return s.substr(0, 2) + ":" + s.substr(2);
                };
                if ($scope.model[$scope.config.name]) $scope.model[$scope.config.name].alerts = $.extend([], $scope.model[$scope.config.name].alerts);
                $scope.addContact = function(alert) {
                    if (!alert.contactList) alert.contactList = [ {
                        email: "",
                        phone: ""
                    } ];
                    if (alert.contactList.length == 0) alert.contactList = [ {
                        email: "",
                        phone: ""
                    } ];
                    $scope.contactList = alert.contactList;
                };
                $scope.addSchedule = function(alert) {
                    if (!alert.schedule) {
                        alert.schedule = {
                            occure: "daily",
                            dailyRecurs: 1,
                            weeklyRecurs: 1,
                            weeklySat: false,
                            weeklySun: false,
                            weeklyMon: false,
                            weeklyTus: false,
                            weeklyWen: false,
                            weeklyThu: false,
                            weeklyFri: false,
                            monthlyDayOf: 1,
                            monthlyRecurs: 1,
                            dailyFrequency: "once",
                            dailyFrequencyAtHour: "1200",
                            dailyFrequencyRecur: 1,
                            dailyFrequencyRecurType: "hour",
                            dailyFrequencyStart: "1200",
                            dailyFrequencyStop: "2359"
                        };
                    }
                    $scope.schedule = alert.schedule;
                };
                $scope.addUser = function(alert) {
                    function showUser() {
                        if (!alert.userList || alert.userList.length == 0) {
                            alert.userList = $scope.serverUserList.map(function(d) {
                                return {
                                    name: d.name,
                                    id: d.id,
                                    username: d.username
                                };
                            });
                        }
                        $scope.userList = alert.userList;
                    }
                    if (!$scope.serverUserList) {
                        $http.get(app.urlPrefix + "Account/GetUsers").then(function(data) {
                            $scope.serverUserList = data.data.list;
                            showUser();
                        });
                    } else {
                        showUser();
                    }
                };
                $scope.addRole = function(alert) {
                    function showRole() {
                        if (!alert.roleList || alert.roleList.length == 0) {
                            alert.roleList = $scope.serverRoleList.map(function(d) {
                                return {
                                    name: d.name,
                                    id: d.id
                                };
                            });
                        }
                        $scope.roleList = alert.roleList;
                    }
                    if (!$scope.serverRoleList) {
                        $http.get(app.urlPrefix + "Account/GetRoles").then(function(data) {
                            $scope.serverRoleList = data.data.list;
                            showRole();
                        });
                    } else {
                        showRole();
                    }
                };
                $scope.changeItem = function(alert, i) {
                    var data = $.extend({}, alert.rules[i]);
                    app.indicator($scope.model.series, data, function(data, silent) {
                        $timeout(function() {
                            alert.rules[i] = data;
                        }, 0);
                    }, []);
                };
                $scope.toggleSelectedSeries = function(alert, s) {
                    if (!alert.selectedSeries) alert.selectedSeries = [];
                    var index = alert.selectedSeries.indexOf(s);
                    if (index == -1) {
                        alert.selectedSeries.push(s);
                    } else {
                        alert.selectedSeries.splice(index, 1);
                    }
                };
                $scope.persian = function(i) {
                    return persian(i);
                };
                $scope.mapOp = {
                    "1": "برابر باشد با",
                    "2": "برابر نباشد با",
                    "3": "بزرگتر باشد از",
                    "4": "بزرگتر يا مساوي باشد از",
                    "5": "کوچکتر باشد از",
                    "6": "کوچکتر يا مساوي باشد از",
                    "7": "شامل",
                    "8": "نباشد شامل"
                };
            } ],
            link: function() {
                app.lang.setLang();
            }
        };
    } ]);
})(jQuery);

(function($) {
    var md = angular.module("management");
    md.filter("filterCalculateFields", function() {
        return function(data, parameter) {
            var filtered = [];
            for (var i = 0; i < data.length; i++) {
                if (i < parameter) filtered.push(data[i]);
            }
            return filtered;
        };
    });
    md.directive("calculateFields", function() {
        return {
            restrict: "E",
            templateUrl: app.urlPrefix + "dist/partial/management/charts/directives/calculateField.html?v=" + Math.random(),
            scope: {
                calculatedFields: "="
            },
            controller: [ "$scope", "$mdDialog", "$mdMedia", function($scope, $mdDialog, $mdMedia) {
                $scope.refreshChart = function(i) {
                    $scope.$parent.refreshChart(i);
                };
                var editedIndex = -1;
                $scope.add = function(ev) {
                    editedIndex = -1;
                    $scope.currentFormula = {};
                    $scope.showDialog(ev);
                };
                $scope.edit = function(i, ev) {
                    editedIndex = i;
                    $scope.currentFormula = {
                        name: $scope.calculatedFields.fields[i].name,
                        formula: $scope.calculatedFields.fields[i].formula
                    };
                    $scope.showDialog(ev);
                };
                $scope.calculatedFields = $scope.calculatedFields || {};
                $scope.calculatedFields.fields = $scope.calculatedFields.fields || [];
                $scope.save = function() {
                    if (!$scope.currentFormula.name) {
                        alert("فیلد نام نمی تواند خالی باشد");
                        return false;
                    }
                    var exist = _.some($scope.calculatedFields.fields, function(d) {
                        return d.name.trim() == $scope.currentFormula.name.trim();
                    }) || _.some($scope.$parent.ngModel.series, function(d) {
                        return d.trim() == $scope.currentFormula.name.trim();
                    });
                    if (exist) {
                        if (editedIndex != -1 && $scope.calculatedFields.fields[editedIndex].name == $scope.currentFormula.name) {} else {
                            alert("نام انتخابی تکراری است");
                            return false;
                        }
                    }
                    if (editedIndex == -1) {
                        $scope.calculatedFields.fields.push({
                            name: $scope.currentFormula.name,
                            formula: $scope.currentFormula.formula
                        });
                    } else {
                        $scope.calculatedFields.fields[editedIndex].name = $scope.currentFormula.name;
                        $scope.calculatedFields.fields[editedIndex].formula = $scope.currentFormula.formula;
                    }
                    return true;
                };
                $scope.showDialog = function(ev) {
                    $mdDialog.show({
                        controller: [ "$scope", "$mdDialog", function(sp, $mdDialog) {
                            sp.parent = $scope;
                            sp.cancel = function() {
                                $mdDialog.cancel();
                            };
                            sp.save = function() {
                                if (sp.parent.save()) {
                                    sp.parent.refreshChart();
                                    $mdDialog.cancel();
                                }
                            };
                            sp.addColumn = function(k, i) {
                                if (!sp.parent.currentFormula.formula) sp.parent.currentFormula.formula = "";
                                sp.parent.currentFormula.formula += " {R+0, [" + k + "]} ";
                                $(".formula-input").focus();
                            };
                        } ],
                        templateUrl: "editor/calc/calc-fields-modal.html",
                        parent: angular.element(document.body),
                        targetEvent: ev,
                        clickOutsideToClose: true,
                        fullscreen: $mdMedia("sm") || $mdMedia("xs")
                    });
                };
            } ],
            link: function() {
                app.lang.setLang();
            }
        };
    });
})(jQuery);

(function($) {
    var md = angular.module("management");
    md.directive("dimMeasWhere", function() {
        return {
            restrict: "E",
            templateUrl: app.urlPrefix + "dist/partial/management/charts/directives/dimMeasWhere.html?v=" + app.version,
            scope: {
                dimensions: "=",
                measures: "=",
                where: "=",
                datasource: "=",
                model: "=?model"
            },
            controller: [ "$scope", "$mdDialog", "$mdMedia", function($scope, $mdDialog, $mdMedia) {
                $scope.model = $scope.model || {};
                $scope.model.selectedDimension = 0;
                $scope.model.selectedMeasure = 0;
                $scope.model.selectedwhere = 0;
                $scope.addFormula = function(items) {
                    items.formulas = items.formulas || [];
                    items.formulas.push({});
                };
                $scope.changeFormula = function(d) {
                    d.members = null;
                };
                $scope.refreshChart = function(i) {
                    $scope.$parent.refreshChart(i);
                };
                $scope.$watch("datasource", function(d) {
                    if (d) $scope.dimentionWithNone = [ {
                        UniqueName: "NONE",
                        Name: "خودش"
                    }, {
                        UniqueName: "CUSTOM_FORMULA",
                        Name: "سفارشی ..."
                    } ].concat(d.CubeInfo.Dimensions[0].Hierarchies);
                }, true);
                $scope.changeDimensionName = function(oldName, p) {
                    var newName = p.Name;
                    var concat = $scope.dimensions.concat($scope.measures).concat($scope.where).map(function(d) {
                        return d.Name;
                    }) || [];
                    var existName = concat.filter(function(d) {
                        return d == newName;
                    }).length > 1;
                    if (existName) {
                        p.Name = oldName;
                        setTimeout(function() {
                            alert("نام انتخاب شده تکراری است");
                        }, 0);
                    } else {
                        $scope.refreshChart();
                    }
                };
                $scope.changeMeasureAggregation = function(i) {
                    var func = $scope.measures[+i].aggregation;
                    if (func == "NONE") {
                        $scope.measures[+i].formula = $scope.measures[+i].UniqueName;
                    } else {
                        $scope.measures[+i].formula = func + "(" + $scope.measures[+i].UniqueName + ")";
                    }
                    $scope.changeFormula($scope.measures[+i]);
                };
                $scope.showDialog = function(type, ev, item) {
                    var lastType = type;
                    $mdDialog.show({
                        controller: [ "$scope", "$mdDialog", function(sp, $mdDialog) {
                            sp.parent = $scope;
                            var selectedMeasure;
                            switch (type) {
                              case "dimention":
                                sp.formula = $scope.dimensions[$scope.model.selectedDimension].formula;
                                break;

                              case "measure":
                                sp.formula = item.formula;
                                selectedMeasure = item;
                                break;

                              case "where":
                                sp.formula = $scope.where[$scope.model.selectedwhere].formula;
                                break;

                              default:                            }
                            sp.aceOption = {
                                useWrapMode: true,
                                showGutter: false,
                                theme: "sqlserver",
                                mode: "sqlserver",
                                maxLines: 14,
                                onLoad: aceLoaded,
                                require: [ "ace/ext/beautify" ]
                            };
                            var session;
                            sp.aceOption.onChange = function(_editor) {
                                sp.formula = session.getValue();
                            };
                            function aceLoaded(editor, e) {
                                editor.renderer.setPadding(18);
                                session = editor.getSession();
                                sp.insertFormula = function(uniqename) {
                                    editor.insert(uniqename);
                                    editor.focus();
                                };
                            }
                            sp.cancel = function() {
                                $mdDialog.cancel();
                            };
                            sp.save = function() {
                                switch (lastType) {
                                  case "dimention":
                                    $scope.dimensions[$scope.model.selectedDimension].formula = sp.formula;
                                    break;

                                  case "measure":
                                    selectedMeasure.formula = sp.formula;
                                    break;

                                  case "where":
                                    $scope.where[$scope.model.selectedwhere].formula = sp.formula;
                                    break;

                                  default:                                }
                                $mdDialog.cancel();
                            };
                        } ],
                        templateUrl: "editor/formula/edit.html",
                        parent: angular.element(document.body),
                        targetEvent: ev,
                        clickOutsideToClose: false,
                        fullscreen: true || $mdMedia("gt-xs") || $mdMedia("sm") || $mdMedia("xs")
                    });
                };
            } ],
            link: function() {
                app.lang.setLang();
            }
        };
    });
})(jQuery);

(function($) {
    var md = angular.module("management");
    md.directive("filterExcept", function() {
        return {
            restrict: "E",
            templateUrl: app.urlPrefix + "dist/partial/management/charts/directives/filterExcept.html?v=" + app.version,
            scope: {
                datasource: "=",
                filterException: "="
            },
            controller: [ "$scope", "$mdDialog", "$mdMedia", function($scope, $mdDialog, $mdMedia) {
                $scope.refreshChart = function(i) {
                    $scope.$parent.refreshChart(i);
                };
                $scope.toggleAllToList = function(u) {
                    $scope.filterException.allFields = $scope.filterException.allFields || [];
                    var index = $scope.filterException.allFields.indexOf(u.UniqueName);
                    if (index != -1) {
                        $scope.filterException.allFields.splice(index, 1);
                    } else {
                        $scope.filterException.allFields.push(u.UniqueName);
                        $scope.filterException.fields = _.reject($scope.filterException.fields, function(i) {
                            var pattern = "\\[id" + u.UniqueName + "\\]";
                            return new RegExp(pattern).test(i.UniqueName);
                        });
                    }
                };
                $scope.toggleToList = function(i) {
                    $scope.filterException.fields = $scope.filterException.fields || [];
                    var isArray = _.filter($scope.filterException.fields, {
                        Name: i.Name,
                        UniqueName: i.UniqueName
                    });
                    if (!isArray.length) {
                        $scope.filterException.fields.push({
                            Name: i.Name,
                            UniqueName: i.UniqueName
                        });
                    } else {
                        isArray.forEach(function(i) {
                            $scope.filterException.fields.splice(_.indexOf($scope.filterException.fields, i), 1);
                        });
                    }
                };
                $scope.isInList = function(i) {
                    return _.filter($scope.filterException.fields, {
                        UniqueName: i.Name,
                        UniqueName: i.UniqueName
                    }).length;
                };
                $scope.getDatasourceName = function(i) {
                    var datasource = _.find($scope.datasource.CubeInfo.Dimensions, function(d) {
                        return d.UniqueName == i;
                    });
                    if (!datasource) return "";
                    return datasource.Name.replace(/as id\d+/gi, "");
                };
                $scope.showDialog = function(ev) {
                    $mdDialog.show({
                        controller: [ "$scope", "$mdDialog", function(sp, $mdDialog) {
                            sp.parent = $scope;
                            sp.cancel = function() {
                                $mdDialog.cancel();
                            };
                        } ],
                        templateUrl: "editor/filter-except/select-except-modal.html",
                        parent: angular.element(document.body),
                        targetEvent: ev,
                        clickOutsideToClose: false,
                        fullscreen: $mdMedia("sm") || $mdMedia("xs")
                    });
                };
            } ],
            link: function() {
                app.lang.setLang();
            }
        };
    });
})(jQuery);

(function($) {
    var md = angular.module("management");
    md.service("myService", [ "$http", function($http) {
        var menus = null;
        this.getMenus = function() {
            if (menus == null) menus = $http.get(app.urlPrefix + "api/menus/get");
            return menus;
        };
    } ]);
    md.factory("myFactory", function() {
        return {
            sayHello: function(name) {
                return "Hi " + name + "!";
            }
        };
    });
    md.directive("generalSettings", [ "myService", "myFactory", function(myService, myFactory) {
        return {
            restrict: "E",
            templateUrl: app.urlPrefix + "dist/partial/management/charts/directives/generalSettings.html?v=" + app.version,
            scope: {
                model: "=ngModel",
                props: "=",
                change: "&ngChange"
            },
            controller: [ "$scope", function($scope) {
                $scope.menus = [];
                $scope.ff = function() {
                    $scope.change();
                };
                myService.getMenus().then(function(item) {
                    var d = item.data;
                    if (d.filter(function(i) {
                        return +i.id === -1;
                    }).length === 0) {}
                    $scope.menus = d;
                }, function() {
                    $scope.error = "خطا در دریافت اطلاعات";
                });
            } ],
            link: function() {
                app.lang.setLang();
            }
        };
    } ]);
})(jQuery);

(function($) {
    var md = angular.module("management");
    md.directive("globalVariable", function() {
        return {
            restrict: "E",
            templateUrl: app.urlPrefix + "dist/partial/management/charts/directives/globalVariable.html?v=" + app.version,
            scope: {
                dimensions: "=",
                measures: "=",
                prop: "="
            },
            controller: [ "$scope", function($scope) {} ],
            link: function() {
                app.lang.setLang();
            }
        };
    });
})(jQuery);

(function($) {
    var md = angular.module("management");
    md.directive("numberFormat", function() {
        return {
            restrict: "E",
            templateUrl: app.urlPrefix + "dist/partial/management/charts/directives/numberFormat.html?v=" + app.version,
            scope: {
                model: "=ngModel"
            },
            controller: [ "$scope", function($scope) {
                $scope.model = $.extend({
                    formatString: ",.2f",
                    formatStringCustom: ",.2f"
                }, $scope.model);
                $scope.refreshChart = function(e) {
                    $scope.$parent.refreshChart(e);
                };
            } ],
            link: function() {
                app.lang.setLang();
            }
        };
    });
})(jQuery);

(function($) {
    var md = angular.module("management");
    md.directive("textEditor", function() {
        return {
            restrict: "E",
            templateUrl: app.urlPrefix + "dist/partial/management/charts/directives/textEditor.html?v=" + app.version + new Date(),
            scope: {
                model: "=prop",
                onChange: "&?",
                "default": "=?"
            },
            controller: [ "$scope", function($scope) {
                $scope.model = _.merge({
                    bold: false,
                    color: "#333333",
                    align: "right",
                    italic: false,
                    fontSize: "10px",
                    fontName: "IRANSans",
                    formatString: ",.2f",
                    formatStringCustom: ",.2f"
                }, $scope.default || {}, $scope.model);
            } ],
            link: function(scope, element, attrs) {
                app.lang.setLang();
                $(element).find(".ui.button.font-popup").popup({
                    popup: $(element).find(".ui.popup"),
                    transition: "scale",
                    on: "click"
                });
            }
        };
    });
})(jQuery);

(function($) {
    var md = angular.module("management");
    md.directive("dimentionColorSelector", function() {
        return {
            restrict: "E",
            templateUrl: app.urlPrefix + "dist/partial/management/charts/directives/dimentionColorSelector.html?v=" + app.version,
            scope: {
                model: "=ngModel",
                dimColor: "=",
                ngChange: "&?"
            },
            controller: [ "$scope", "$timeout", function($scope, $timeout) {
                $scope.model = $scope.model || {
                    enable: false,
                    palette: "1",
                    data: {}
                };
                $scope.colorSet = function(force) {
                    var colors = d3.scaleOrdinal(d3.schemeCategory10);
                    switch (+$scope.model.palette) {
                      case 2:
                        colors = d3.scaleOrdinal(d3.schemeBrBG[11]);
                        break;

                      case 3:
                        colors = d3.scaleOrdinal(d3.schemePuOr[11]);
                        break;

                      case 4:
                        colors = d3.scaleOrdinal(d3.schemeRdGy[11]);
                        break;

                      default:                    }
                    var i = 0;
                    _.each($scope.model.data, function(item) {
                        if (!item.color || force) {
                            item.color = colors(i);
                        }
                        i++;
                    });
                };
                $scope.$watch("dimColor", function(n) {
                    $scope.model = $scope.model || {
                        enable: false,
                        palette: "1"
                    };
                    $scope.model.data = $scope.model.data || {};
                    if (n) {
                        for (var key in n) {
                            $scope.model.data[key] = $scope.model.data[key] || n[key];
                        }
                    }
                    $scope.colorSet(false);
                }, true);
                $scope.clear = function() {
                    $scope.model.data = {};
                    $scope.dimColor = {};
                    $scope.ngChange();
                };
            } ]
        };
    });
})(jQuery);

(function($) {
    var md = angular.module("management");
    md.directive("mapSelector", [ "$timeout", function($timeout) {
        return {
            restrict: "E",
            scope: {
                model: "=prop"
            },
            controller: [ "$scope", "$http", "$mdDialog", "$mdMedia", function($scope, $http, $mdDialog, $mdMedia) {
                $scope.model = $.extend({
                    selectedMap: "1"
                }, $scope.model);
                $scope.refreshList = function() {
                    $scope.list = null;
                    $scope.getList();
                };
                $scope.getList = function() {
                    if (!$scope.list) {
                        $http.get(app.urlPrefix + "Moderation/Map/GetList").then(function(data) {
                            if (data.data.result) {
                                $scope.list = data.data.list;
                            }
                        });
                    }
                };
                $scope.getList();
                $scope.showUploadDialog = function(ev) {
                    $mdDialog.show({
                        controller: [ "$scope", "$mdDialog", "$timeout", "$mdToast", function(sp, $mdDialog, $timeout, $mdToast) {
                            sp.parent = $scope;
                            sp.cancel = function() {
                                $mdDialog.cancel();
                            };
                            sp.selectFile = function() {
                                $("#file-upload[type=file]").click();
                            };
                            sp.upload = function() {
                                if (!sp.name || !sp.file) {
                                    var toast = $mdToast.simple().textContent("نام و فایل نقشه را وارد کنید");
                                    $mdToast.show(toast);
                                    return;
                                }
                                var formData = new FormData();
                                formData.append("file", sp.file);
                                formData.append("name", sp.name);
                                var xhr = new XMLHttpRequest();
                                xhr.upload.addEventListener("load", function() {
                                    $timeout(function() {
                                        $mdDialog.cancel();
                                        var toast = $mdToast.simple().textContent("آپلود با موفقیت انجام شد");
                                        $mdToast.show(toast);
                                    }, 0);
                                });
                                function error() {
                                    $timeout(function() {
                                        var toast = $mdToast.simple().textContent("آپلود ناموفق بود");
                                        $mdToast.show(toast);
                                    }, 0);
                                }
                                xhr.upload.addEventListener("error", error);
                                xhr.upload.addEventListener("abort", error);
                                xhr.open("POST", app.urlPrefix + "Moderation/Map/Upload");
                                xhr.send(formData);
                            };
                            sp.d3 = d3;
                        } ],
                        templateUrl: "editor/map/upload-map.html",
                        parent: angular.element(document.body),
                        targetEvent: ev,
                        clickOutsideToClose: true,
                        fullscreen: $mdMedia("sm") || $mdMedia("xs")
                    });
                };
                $scope.showEditDialog = function(ev) {
                    $mdDialog.show({
                        controller: [ "$scope", "$mdDialog", "$timeout", "$mdToast", function(sp, $mdDialog, $timeout, $mdToast) {
                            sp.parent = $scope;
                            sp.cancel = function() {
                                $mdDialog.cancel();
                            };
                            sp.remove = function(map, i) {
                                var f = confirm("آیا برای حذف اطمینان دارید؟");
                                if (!f) return;
                                map.progressRemove = true;
                                $http.get(app.urlPrefix + "Moderation/Map/remove/" + map.id).then(function(data) {
                                    map.progressRemove = false;
                                    sp.parent.list.splice(i, 1);
                                }).catch(function() {
                                    map.progressRemove = false;
                                    alert("عملیات ناموفق");
                                });
                            };
                            sp.edit = function(map, i) {
                                map.progressEdit = true;
                                $http.post(app.urlPrefix + "Moderation/Map/edit", map).then(function(data) {
                                    map.progressEdit = false;
                                    map.change = false;
                                }).catch(function() {
                                    map.progressEdit = false;
                                    alert("عملیات ناموفق");
                                });
                            };
                        } ],
                        templateUrl: "editor/map/edit-map.html",
                        parent: angular.element(document.body),
                        targetEvent: ev,
                        clickOutsideToClose: true,
                        fullscreen: $mdMedia("sm") || $mdMedia("xs")
                    });
                };
            } ],
            templateUrl: app.urlPrefix + "dist/partial/management/charts/directives/types/mapSelector.html?v=" + app.version
        };
    } ]);
})(jQuery);

(function($) {
    var md = angular.module("management");
    md.directive("tableIndicator", [ "$timeout", function($timeout) {
        return {
            restrict: "E",
            scope: {
                prop: "=",
                dimensions: "=",
                measures: "=",
                config: "="
            },
            controller: [ "$scope", "$http", function($scope, $http) {
                if (!$scope.prop[$scope.config.name]) {
                    return;
                }
                $scope.prop[$scope.config.name].indicator = $scope.prop[$scope.config.name].indicator || [];
                $scope.model = $scope.prop[$scope.config.name].indicator;
                $scope.change = function() {
                    $scope.$parent.refreshChart("refresh");
                };
                $scope.changeItem = function(i) {};
            } ],
            link: function() {
                app.lang.setLang();
            },
            templateUrl: app.urlPrefix + "dist/partial/management/charts/directives/types/tableIndicator.html?v=" + app.version
        };
    } ]);
})(jQuery);

(function($) {
    var md = angular.module("management");
    md.directive("userControlVariableRelation", [ "$timeout", function($timeout) {
        return {
            restrict: "E",
            scope: {
                prop: "=",
                dimensions: "="
            },
            controller: [ "$scope", "$http", function($scope, $http) {
                $scope.$watch("dimensions", function(n, o) {
                    $scope.prop.userControl.info.dimensions = $scope.dimensions;
                }, true);
                if (!$scope.list) {
                    $http.get(app.urlPrefix + "Moderation/GlobalVariable/GetList").then(function(data) {
                        data.data.unshift({
                            Id: "-1",
                            Name: "NONE"
                        });
                        $scope.list = data.data;
                    });
                }
                $scope.AddGlobalVariables = function() {
                    app.globalVariableHelper.AddGlobalVariables(function(data) {
                        $timeout(function() {
                            $scope.list.push({
                                Id: data.Id,
                                Name: data.Name
                            });
                            $scope.prop.userControl.info.variableId = data.Id + "";
                        }, 0);
                    });
                };
            } ],
            templateUrl: app.urlPrefix + "dist/partial/management/charts/directives/types/variableRelation.html?v=" + app.version,
            link: function(scope, elm, attrs) {
                var selector = attrs["selector"];
                angular.element($(selector)).bind("default-value", function(e, isChange, values, variableType) {
                    $timeout(function() {
                        scope.prop.userControl.info.variableDefault = {
                            values: values,
                            type: variableType
                        };
                    }, 0);
                });
                app.lang.setLang();
            }
        };
    } ]);
})(jQuery);

var ngApp = angular.module("management");

ngApp.controller("datasourcefileCtrl", [ "$scope", "$http", "$mdToast", "$mdDialog", "$routeParams", "$location", "packages", "$timeout", "$window", "$sce", "datasources", function($scope, $http, $mdToast, $mdDialog, $routeParams, $location, packages, $timeout, $window, $sce, datasources) {
    var Types = {
        MsOlap: 1,
        MSSQL: 2,
        MySQL: 3,
        File: 4,
        WebResource: 5,
        JoinDatasource: 6
    };
    var packageId = typeof $routeParams.packageId != "undefined" ? $routeParams.packageId : 0;
    var id = typeof $routeParams.id != "undefined" ? $routeParams.id : 0;
    var type = $routeParams.type;
    var isEdit = id > 0;
    $scope.isEdit = isEdit;
    $scope.id = id;
    var savedKeepHistory = false;
    if (isEdit) {
        $http.get(app.urlPrefix + "api/datasources/get?type=" + Types.File + "&id=" + id).then(function(res) {
            $scope.name = res.data.name;
            $scope.keepHistory = res.data.keepHistory;
            savedKeepHistory = res.data.keepHistory;
            $scope.metainfo = res.data.metainfo;
        }, error);
        $http.get(app.urlPrefix + "Moderation/Excel/Sample?id=" + id).then(function(data) {
            if (data.data) {
                putListToResult(data.data);
            } else {
                $("#queryResult").html("");
                $("#test-result").removeClass().addClass("alert alert-danger").show().find("span").html("اشکال در دریافت اطلاعات").append('<p style="text-align: left;margin-top:7px;">' + filterXSS(data.error) + "</p>");
            }
        }, error);
    }
    function error(res) {
        $scope.error = $sce.trustAsHtml(filterXSS("<b>" + res.data.title + "</b> <br/>" + res.data.desc));
    }
    $scope.save = function() {
        $scope.error = null;
        if (!$scope.fileForm.$valid) {
            showErrorToast("فیلدهای ضروری باید پر شوند");
            return;
        }
        $scope.testResult = null;
        var RolesActions = _.filter($scope.roles, {
            check: true
        }).map(function(i) {
            return i.action + "-" + i.id;
        });
        if (!$scope.keepHistory && savedKeepHistory) {
            var c = confirm("در صورت ذخیره منبع داده، با توجه به عدم انتخاب گزینه نگهداری تاریخچه، رکوردهای قبلی پاک می‌شوند. آیا برای ادامه اطمینان دارید؟");
            if (!c) return;
        }
        $http.post(app.urlPrefix + "Moderation/Excel/save", {
            SheetName: $scope.sheetName,
            DataSourceName: $scope.name,
            KeepHistory: $scope.keepHistory,
            Id: id,
            PackageId: packageId,
            RolesActions: RolesActions,
            metainfo: $scope.metainfo,
            AceProvider: $scope.aceProvider
        }).then(function(data) {
            var toast = $mdToast.simple().textContent(isEdit ? "تغییرات ثبت شد" : "منبع داده جدید ایجاد شد");
            $mdToast.show(toast);
            function back() {
                if (window.history.length <= 2) {
                    $location.path("/datasources/" + packageId);
                } else {
                    window.history.back();
                }
            }
            back();
            datasources.reset();
        }, error);
    };
    function showErrorToast(msg) {
        $mdToast.show({
            template: '<md-toast class="md-toast error"> <span class="md-toast-text" flex>' + msg + "</span></md-toast>",
            hideDelay: 3e3,
            position: "bottom left"
        });
    }
    $scope.extention = "XLS";
    $scope.aceProvider = "12";
    $scope.progress = -1;
    function showXlsResult(data) {
        $scope.sheets = data.result;
        $scope.sheetName = $scope.sheets[0];
        $scope.changeSheet();
    }
    function putListToResult(data) {
        var html = "";
        var body = _.map(data, function(row, index) {
            return "<tr>" + _.map(row, function(td) {
                return index === 0 ? "<th>" + filterXSS(td) + "</th>" : "<td>" + filterXSS(td) + "</td>";
            }).join("") + "</tr>";
        }).join("");
        html = '<table class="table">' + body + "</table>";
        $scope.testResult = $sce.trustAsHtml(html);
    }
    $scope.changeSheet = function() {
        $http.get(app.urlPrefix + "Moderation/Excel/data?sheetName=" + encodeURIComponent($scope.sheetName) + "&AceProvider=" + $scope.aceProvider).then(function(data) {
            if (data.data) {
                putListToResult(data.data);
            } else {
                $scope.error = $sce.trustAsHtml("اشکال در دریافت اطلاعات");
            }
        });
    };
    $("#input-file-id").fileupload({
        dataType: "json",
        url: app.urlPrefix + "Moderation/Excel/UploadFiles",
        autoUpload: false,
        done: function(e, data) {
            $timeout(function() {
                switch (data.formData.type) {
                  case "XLS":
                    showXlsResult(data);
                    break;

                  case "CSV":
                    putListToResult(data.result);
                    break;

                  case "XML":
                    break;

                  default:                }
            }, 0);
        },
        add: function(e, data) {
            $timeout(function() {
                $scope.uploadData = data;
                $scope.fileName = $sce.trustAsHtml(filterXSS(data.files[0].name + "<br><sub><b>حجم:</b> " + (data.files[0].size / 1024).toFixed(2) + " KB</sub>"));
                var s = data.files[0].name.match(/\.[^.]+$/);
                if (s !== null) {
                    var ext = s[0];
                    if (ext === ".xlsx" || ext === "xls") $scope.extention = "XLS";
                    if (ext === ".csv") $scope.extention = "CSV";
                    if (ext === ".xml") $scope.extention = "XML";
                }
            }, 0);
        },
        error: function(e, data) {
            $timeout(function() {
                $scope.error = $sce.trustAsHtml(filterXSS('<div class="ltr"><b>' + e.responseJSON.title + "</b> <br/>" + e.responseJSON.desc + "</div>"));
            }, 0);
        }
    }).on("fileuploadprogressall", function(e, data) {
        var progress = parseInt(data.loaded / data.total * 100, 10);
        $timeout(function() {
            $scope.progress = progress;
        }, 0);
    });
    $scope.uploadData;
    $scope.upload = function() {
        $scope.error = null;
        $scope.testResult = null;
        $scope.uploadData.formData = {
            type: $scope.extention,
            aceProvider: $scope.aceProvider
        };
        $scope.uploadData.submit();
        $scope.progress = 0;
        setResultSize();
    };
    function setResultSize() {
        var w = $("#main-form").width();
        $("#testResult").css("max-width", w + "px");
        $("#testResult").css("overflow", "auto");
    }
} ]);

var ngApp = angular.module("management");

ngApp.service("interRelation", [ "$http", function($http) {
    var list;
    var get = function() {
        list = $http.get(app.urlPrefix + "moderation/datasourceInterRelation/get");
        return list;
    };
    return {
        get: get,
        reset: function() {
            list = null;
        }
    };
} ]);

ngApp.controller("interRelationCtrl", [ "$scope", "$http", "$mdToast", "$mdDialog", "$translate", "interRelation", "$mdMedia", "utils", "toolbar", function($scope, $http, $mdToast, $mdDialog, $translate, interRelation, $mdMedia, utils, toolbar) {
    $scope.utils = utils;
    $translate("interRelation").then(function(t) {
        toolbar.setTitles([ {
            name: t,
            click: null
        } ]);
    });
    $scope.progress = true;
    interRelation.get().then(function(res) {
        $scope.progress = false;
        $scope.data = res.data.list.map(function(d) {
            var item = JSON.parse(d.data);
            item.conditions.forEach(function(d) {
                if (typeof d.left === "string") {
                    var temp = d.left;
                    d.left = {
                        column: temp,
                        isText: false,
                        formula: null
                    };
                    d.op = "=";
                }
                if (typeof d.right === "string") {
                    var temp = d.right;
                    d.right = {
                        column: temp,
                        isText: false,
                        formula: null
                    };
                }
            });
            item.id = d.id;
            return item;
        });
        $scope.getList(function() {
            $scope.modalRelationObject = {
                conditions: [ {} ],
                left: -1,
                right: -1
            };
        });
    });
    $scope.modalRelationObject = {
        conditions: [ {} ],
        left: 0,
        right: 0
    };
    var isFirst = true;
    $scope.getList = function(callback) {
        if (isFirst) {
            isFirst = false;
            $http.get(app.urlPrefix + "Moderation/JoinDataSource/GetDatasourceList").then(function(data) {
                $scope.datasourceList = data.data;
                if (callback) callback();
            });
        } else {
            if (callback) callback();
        }
    };
    $scope.add = function(event) {
        if ($scope.modalRelationObject.conditions.length == 0) {
            alert("حداقل یک رابطه تعریف کنید");
            return false;
        }
        $scope.modalRelationObject.name = $scope.datasourceList.filter(function(d) {
            return +$scope.modalRelationObject.left == d.Id;
        })[0].Name + " - " + $scope.datasourceList.filter(function(d) {
            return +$scope.modalRelationObject.right == d.Id;
        })[0].Name;
        $http.post(app.urlPrefix + "Moderation/DatasourceInterRelation/Save", JSON.stringify($scope.modalRelationObject), {
            headers: {
                "Content-Type": "application/json; charset=utf-8"
            }
        }).then(function(t) {
            var res = t.data;
            if (res.result) {
                if (!$scope.modalRelationObject.id) {
                    $scope.modalRelationObject.id = res.id;
                    $scope.data.splice($scope.data.length, 0, $scope.modalRelationObject);
                } else {
                    var d = $scope.data.filter(function(d) {
                        return d.id == $scope.modalRelationObject.id;
                    })[0];
                    d = angular.extend({}, $scope.modalRelationObject);
                }
            } else {
                $scope.error = $sce.trustAsHtml(filterXSS(res.message));
            }
        });
    };
    $scope.cancel = function() {};
    $scope.new = function(ev) {
        $scope.modalRelationObject = {
            conditions: [ {
                op: "="
            } ],
            left: 0,
            right: 0
        };
        showDialog(ev);
    };
    $scope.edit = function(ev, d) {
        $scope.modalRelationObject = d;
        showDialog(ev);
    };
    $scope.delete = function(ev) {
        var link = app.urlPrefix + "Moderation/DatasourceInterRelation/Delete";
        var ids = _.filter($scope.data, {
            select: true
        }).map(function(d) {
            return d.id;
        });
        var confirm = $mdDialog.confirm().title("حذف برای همیشه؟").textContent(ids.length + " مورد برای حذف انتخاب شده است").ariaLabel("حذف").targetEvent(ev).ok("حذف!").cancel("لغو");
        $mdDialog.show(confirm).then(function() {
            $http.post(link, ids).then(function(res) {
                if (res.data.deleted) {
                    $scope.data = _.filter($scope.data, function(d) {
                        return res.data.deleted.indexOf(d.id) == -1;
                    });
                }
                var toast = $mdToast.simple().textContent("حذف انجام شد");
                $mdToast.show(toast);
            });
        });
    };
    $scope.selectedCount = function() {
        return _.filter($scope.data, {
            select: true
        }).length;
    };
    $scope.selectAll = function() {
        _.forEach($scope.data, function(d) {
            d.select = $scope.selectAllCheckbox;
        });
    };
    $scope.restore = function(model) {
        $scope.modalRelationObject = model;
    };
    $scope.getLastFocus = function(e) {
        $scope.lastFocus = e.target;
        var input = e.target;
        if (!input) return;
        if ("selectionStart" in input) {
            $scope.selectionStart = input.selectionStart;
            $scope.selectionEnd = input.selectionEnd;
        } else if (document.selection) {
            input.focus();
            var sel = document.selection.createRange();
            var selLen = document.selection.createRange().text.length;
            sel.moveStart("character", -input.value.length);
            $scope.selectionStart = sel.text.length - selLen;
        }
    };
    $scope.addFormula = function(formula, id) {
        $($scope.lastFocus).focus();
        var text = $($scope.lastFocus).val();
        var inject = "[id" + id + "].[" + formula + "]";
        var offset = 0;
        text = text.substring(0, $scope.selectionStart) + text.substring($scope.selectionEnd, text.length);
        var v = text.substring(0, $scope.selectionStart) + inject + text.substring($scope.selectionStart, text.length);
        $($scope.lastFocus).val(v);
        var input = $($scope.lastFocus).get(0);
        input.setSelectionRange($scope.selectionStart + offset, $scope.selectionStart + offset);
        $scope.selectionStart = $scope.selectionStart + offset;
        $scope.selectionEnd = $scope.selectionStart;
    };
    function showDialog(ev) {
        $mdDialog.show({
            controller: [ "$scope", "$mdDialog", "$timeout", function(sp, $mdDialog, $timeout) {
                sp.parent = $scope;
                sp.cancel = function() {
                    $mdDialog.cancel();
                };
            } ],
            parent: angular.element(document.body),
            targetEvent: ev,
            clickOutsideToClose: true,
            fullscreen: $mdMedia("sm") || $mdMedia("xs"),
            templateUrl: "datasourceRelation/add-relation.html"
        });
    }
} ]);

ngApp.filter("filterColumns", function() {
    return function(items, conditions, isLeft, index) {
        if (!items) return;
        var selected = conditions.map(function(d) {
            return isLeft ? d.left : d.right;
        }).filter(function(d, i) {
            return d != -1 && i != +index;
        });
        return items.filter(function(d) {
            return selected.indexOf(d) == -1;
        });
    };
});

var ngApp = angular.module("management");

ngApp.controller("datasourceJoinCtrl", [ "$scope", "$http", "$mdToast", "$mdDialog", "$routeParams", "$location", "packages", "$timeout", "$window", "$sce", "$mdMedia", "utils", "datasources", function($scope, $http, $mdToast, $mdDialog, $routeParams, $location, packages, $timeout, $window, $sce, $mdMedia, utils, datasources) {
    var Types = {
        MsOlap: 1,
        MSSQL: 2,
        MySQL: 3,
        File: 4,
        WebResource: 5,
        JoinDatasource: 6
    };
    $scope.utils = utils;
    var packageId = typeof $routeParams.packageId != "undefined" ? $routeParams.packageId : 0;
    var id = typeof $routeParams.id != "undefined" ? $routeParams.id : 0;
    var type = $routeParams.type;
    var isEdit = id > 0;
    $scope.isEdit = isEdit;
    $scope.id = id;
    $scope.model = {};
    if (isEdit) {
        $http.get(app.urlPrefix + "api/datasources/get?type=" + Types.JoinDatasource + "&id=" + id).then(function(res) {
            $scope.restore(res.data.model, res.data.list);
        }, error);
    }
    function error(res) {
        $scope.saveProgress = false;
        $scope.testProgress = false;
        $scope.error = $sce.trustAsHtml(filterXSS("<b>" + res.data.title + "</b> <br/>" + res.data.desc));
    }
    function showErrorToast(msg) {
        $mdToast.show({
            template: '<md-toast class="md-toast error"> <span class="md-toast-text" flex>' + msg + "</span></md-toast>",
            hideDelay: 3e3,
            position: "bottom left"
        });
    }
    function setResultSize() {
        var w = $("#main-form").width();
        $("#testResult").css("max-width", w + "px");
        $("#testResult").css("overflow", "auto");
    }
    var isModalEdit = false;
    $scope.isSchedule = false;
    $scope.selectedDatasource = [];
    $scope.selectedFields = [];
    $scope.relationsList = [];
    $scope.relationType = "JOIN";
    var getList = function(ev) {
        if (!$scope.datasourceListPromise) $scope.datasourceListPromise = $http.get(app.urlPrefix + "Moderation/JoinDataSource/GetDatasourceList");
        return $scope.datasourceListPromise;
    };
    $scope.select = function(ev) {
        $mdDialog.show({
            controller: [ "$scope", "$mdDialog", function(sp, $mdDialog) {
                getList().then(function(d) {
                    $scope.datasourceList = d.data;
                    sp.datasourceList = d.data;
                    _.forEach(sp.datasourceList, function(d) {
                        d.check = false;
                    });
                });
                sp.select = function() {
                    _.filter(sp.datasourceList, {
                        check: true
                    }).forEach(function(d) {
                        $scope.addItemToDatasource(d.Id);
                    });
                    $mdDialog.hide();
                };
                sp.cancel = function() {
                    $mdDialog.cancel();
                };
            } ],
            templateUrl: "join/datasource_select.html",
            parent: angular.element(document.body),
            targetEvent: ev,
            clickOutsideToClose: true,
            fullscreen: $mdMedia("sm") || $mdMedia("xs")
        });
    };
    $scope.exploreDatasource = function(i, ev) {
        $mdDialog.show({
            controller: [ "$scope", "$mdDialog", function(sp, $mdDialog) {
                sp.exploreError = null;
                sp.explor = null;
                $http.post(app.urlPrefix + "Moderation/JoinDataSource/ExploreDatasource", JSON.stringify({
                    Id: $scope.selectedDatasource[i].Id
                }), {
                    headers: {
                        "Content-Type": "application/json; charset=utf-8"
                    }
                }).then(function(res) {
                    sp.exploreError = null;
                    var body = _.map(res.data.datasourceExplore, function(row, index) {
                        return "<tr>" + _.map(row, function(td) {
                            return index == 0 ? "<th>" + td + "</th>" : "<td>" + td + "</td>";
                        }).join("") + "</tr>";
                    }).join("");
                    sp.explor = $sce.trustAsHtml('<table class="table">' + filterXSS(body) + "</table>");
                }, function(e) {
                    $scope.exploreError = $sce.trustAsHtml(filterXSS(e.data.title + "<br/>" + e.data.desc));
                });
                sp.cancel = function() {
                    $mdDialog.cancel();
                };
            } ],
            templateUrl: "join/datasource_explor.html",
            parent: angular.element(document.body),
            targetEvent: ev,
            clickOutsideToClose: true,
            fullscreen: $mdMedia("sm") || $mdMedia("xs")
        });
    };
    $scope.showRelationDialog = function(ev) {
        $mdDialog.show({
            controller: [ "$scope", "$mdDialog", function(sp, $mdDialog) {
                sp.$scope = $scope;
                sp.cancel = function() {
                    $scope.cancelItemtoRelationsList();
                    $mdDialog.cancel();
                };
                sp.ok = function() {
                    $scope.addItemtoRelationsList();
                    $mdDialog.hide();
                };
            } ],
            templateUrl: "join/datasource_add_relation.html",
            parent: angular.element(document.body),
            targetEvent: ev,
            clickOutsideToClose: true,
            fullscreen: $mdMedia("sm") || $mdMedia("xs")
        });
    };
    $scope.addItemToDatasource = function(id) {
        var inserted = $scope.selectedDatasource.filter(function(d) {
            return d.Id.replace(/(\d+)-\d+/, "$1") == id;
        }).length;
        var item = $scope.datasourceList.filter(function(d) {
            return d.Id == id;
        });
        if (item && item.length > 0) {
            var p = [];
            for (var i = 0; i < item[0].PartitionCount || 0; i++) {
                p.push({
                    index: i,
                    check: true
                });
            }
            $scope.selectedDatasource.push({
                Id: item[0].Id + "-" + inserted,
                Name: item[0].Name + (inserted > 0 ? " شماره" + inserted : ""),
                Fields: item[0].Fields,
                Partitions: p
            });
        }
    };
    $scope.removeSelectedDatasource = function(idx) {
        var item = $scope.selectedDatasource[idx];
        $scope.selectedDatasource.splice(idx, 1);
        $scope.relationsList = $scope.relationsList.filter(function(d) {
            return d.left != item.Id && d.right != item.Id;
        });
        $scope.selectedFields = $scope.selectedFields.filter(function(d) {
            var p = d.split(",");
            return p[0] != item.Id;
        });
    };
    $scope.persian = function(d) {
        return persian(d);
    };
    $scope.aliasArray = {};
    $scope.toggleSelectedFields = function(p) {
        var idx = $scope.selectedFields.indexOf(p);
        if (idx > -1) {
            $scope.selectedFields.splice(idx, 1);
        } else {
            $scope.selectedFields.push(p);
        }
    };
    $scope.toggleSelectedFieldsCheckAll = function(i, event) {
        var isCheched = $(event.target).prop("checked");
        for (var j = 0; j < i.Fields.length; j++) {
            var item = i.Id + "," + j;
            var idx = $scope.selectedFields.indexOf(item);
            if (idx > -1 && !isCheched) $scope.selectedFields.splice(idx, 1);
            if (idx == -1 && isCheched) $scope.selectedFields.push(item);
        }
    };
    $scope.addRelationLimit = function() {
        $scope.modalRelationObject.conditions.push({
            left: 0,
            op: "=",
            right: 0
        });
    };
    $scope.removeRelationLimit = function(idx) {
        $scope.modalRelationObject.conditions.splice(idx, 1);
    };
    $scope.addItemtoRelationsList = function() {
        if (!isModalEdit) $scope.relationsList.push($scope.modalRelationObject);
        $scope.cancelItemtoRelationsList();
    };
    $scope.cancelItemtoRelationsList = function() {
        isModalEdit = false;
        $scope.modalRelationObject = {
            conditions: [ {
                left: 0,
                op: "=",
                right: 0
            } ],
            left: "0",
            right: "0",
            includeRight: true,
            includeLeft: true,
            repeatRows: false
        };
    };
    $scope.editRelation = function(idx) {
        isModalEdit = true;
        $("#add-relation-modal").modal("show");
        $scope.modalRelationObject = $scope.relationsList[idx];
    };
    function back() {
        if (window.history.length == 2) {
            $location.path("/datasources/" + packageId);
        } else {
            window.history.back();
        }
    }
    $scope.cancel = function() {
        back();
    };
    $scope.deleteDatasource = function(event) {
        $(event.target).button("loading");
        var id = $("#datasource-id").val();
        $http.post(app.urlPrefix + "Moderation/JoinDataSource/Delete", JSON.stringify({
            id: id
        }), {
            headers: {
                "Content-Type": "application/json; charset=utf-8"
            }
        }).then(function(res) {
            $(event.target).button("reset");
            if (res.data.result) {
                app.router.navigate("Moderation/DataSource/index/", {
                    trigger: true
                });
            }
        });
    };
    $scope.restore = function(model, list) {
        $scope.isEdit = true;
        $scope.datasourceList = list;
        model.selectedDs = model.selectedDs || [];
        list.forEach(function(d) {
            var exist = model.selectedDs.filter(function(f) {
                return +f.replace(/(\d+)-\d+/, "$1") == +d.Id;
            });
            for (var i = 0; i < exist.length; i++) {
                var item = exist[i];
                var inserted = +item.replace(/(\d+)-(\d+)/, "$2");
                var p = [];
                for (var i = 0; i < d.PartitionCount || 0; i++) {
                    p.push({
                        index: i,
                        check: true
                    });
                }
                var sd = {
                    Id: item,
                    Name: d.Name + (inserted > 0 ? " شماره" + inserted : ""),
                    Fields: d.Fields,
                    Partitions: p
                };
                $scope.selectedDatasource.push(sd);
            }
        });
        $scope.selectedFields = model.selectedFields || [];
        $scope.relationsList = model.relationsList || [];
        $scope.name = model.name;
        $scope.disable = model.disable;
        $scope.disableMessage = model.disableMessage;
        $scope.script = model.script;
        $scope.relationType = model.relationType;
        $scope.aliasArray = JSON.parse(model.aliasArray);
        $scope.isSchedule = model.isSchedule, $scope.schedule = model.schedule;
        $scope.partitions = model.partitions || [];
    };
    function getModel() {
        return {
            id: id,
            isEdit: isEdit,
            name: $scope.name,
            disable: $scope.disable,
            disableMessage: $scope.disableMessage,
            selectedDs: $scope.selectedDatasource.map(function(d) {
                return d.Id;
            }),
            selectedFields: $scope.selectedFields,
            relationsList: $scope.relationsList.map(function(d) {
                return {
                    left: d.left,
                    right: d.right,
                    includeRight: d.includeRight,
                    includeLeft: d.includeLeft,
                    repeatRows: d.repeatRows,
                    conditions: d.conditions.map(function(f) {
                        return {
                            left: f.left,
                            right: f.right,
                            op: f.op
                        };
                    })
                };
            }),
            script: $scope.script,
            relationType: $scope.relationType,
            aliasArray: JSON.stringify($scope.aliasArray),
            isSchedule: $scope.isSchedule,
            schedule: $scope.schedule,
            partitions: $scope.partitions
        };
    }
    function error(res) {
        $scope.saveProgress = false;
        $scope.testProgress = false;
        $scope.scriptProgress = false;
        $scope.error = $sce.trustAsHtml("<b>" + filterXSS(res.data.title) + "</b> <br/>");
    }
    $scope.saveJoin = function(event) {
        var model = getModel();
        model.packageId = packageId;
        model.RolesActions = _.filter($scope.roles, {
            check: true
        }).map(function(i) {
            return i.action + "-" + i.id;
        });
        $scope.saveProgress = true;
        $http.post(app.urlPrefix + "Moderation/JoinDataSource/SaveRelation", JSON.stringify(model), {
            headers: {
                "Content-Type": "application/json; charset=utf-8"
            }
        }).then(function(res) {
            $scope.saveProgress = false;
            $scope.error = null;
            back();
            datasources.reset();
        }, error);
    };
    $scope.getScript = function(event) {
        var model = getModel();
        $scope.scriptProgress = true;
        $http.post(app.urlPrefix + "Moderation/JoinDataSource/GetScript", JSON.stringify(model), {
            headers: {
                "Content-Type": "application/json; charset=utf-8"
            }
        }).then(function(res) {
            $scope.scriptProgress = false;
            if (res.data.result) {
                $scope.script = res.data.script;
                $scope.error = null;
            } else $scope.error = $sce.trustAsHtml(filterXSS(res.data.message));
        });
    };
    $scope.test = function(event) {
        var model = getModel();
        $scope.testProgress = true;
        $http.post(app.urlPrefix + "Moderation/JoinDataSource/Test", JSON.stringify(model), {
            headers: {
                "Content-Type": "application/json; charset=utf-8"
            }
        }).then(function(t) {
            var res = t.data;
            $scope.testProgress = false;
            if (res.result) {
                $scope.testResult = res.queryResult;
                $scope.error = null;
            } else {
                $scope.error = $sce.trustAsHtml(filterXSS(res.message));
            }
        });
    };
    $scope.modalRelationObject = {
        conditions: [ {
            left: 0,
            op: "=",
            right: 0
        } ],
        left: "0",
        right: "0",
        includeRight: true,
        includeLeft: true,
        repeatRows: false
    };
    $scope.showDialog = function(ev) {
        showDialog(ev, $scope.script).then(function(f) {
            $scope.script = f;
        });
    };
    function showDialog(ev, formula) {
        return $mdDialog.show({
            controller: [ "$scope", "$mdDialog", "$timeout", function(sp, $mdDialog, $timeout) {
                sp.cancel = function() {
                    $mdDialog.cancel();
                };
                sp.save = function() {
                    $mdDialog.hide(sp.formula);
                };
                if (formula) {
                    sp.formula = formula;
                }
                sp.aceOption = {
                    useWrapMode: true,
                    showGutter: false,
                    theme: "sqlserver",
                    mode: "sqlserver",
                    maxLines: 14,
                    onLoad: aceLoaded,
                    require: [ "ace/ext/beautify" ]
                };
                function aceLoaded(editor, e) {
                    editor.renderer.setPadding(18);
                    sp.insertFormula = function(uniqename) {
                        editor.insert(uniqename);
                        editor.focus();
                    };
                }
            } ],
            parent: angular.element(document.body),
            targetEvent: ev,
            clickOutsideToClose: true,
            fullscreen: true,
            template: '<md-dialog aria-label="{{\'editor\' | translate}}" ng-cloak class="fullscreen-dialog">                                 <md-toolbar>                                                                                                                            <div class="md-toolbar-tools">                                                                                                          <h2>{{\'editor\' | translate}}</h2>                                                                                                   <span flex></span>                                                                                                                  <md-button class="md-icon-button" ng-click="cancel()">                                                                                  <span class="material-icons">close</span>                                                                                       </md-button>                                                                                                                    </div>                                                                                                                          </md-toolbar>                                                                                                                       <md-dialog-content layout-margin flex layout="row" class="md-dialog-contentx">                                                          <style>                                                                                                                                 .ace_editor {                                                                                                                           border: 1px solid #efefef;                                                                                                      }                                                                                                                                                                                                                                                                           .ace_editor, .ace_editor div {                                                                                                          font: 16px/normal \'Courier New\', \'Menlo\', \'Ubuntu Mono\', \'Consolas\', \'source-code-pro\', monospace;                              }                                                                                                                                                                                                                                                                   md-dialog.fullscreen-dialog {                                                                                                           max-width: 100%;                                                                                                                    max-height: 100%;                                                                                                                   width: 100%;                                                                                                                        height: 100%;                                                                                                                       border-radius: 0;                                                                                                               }                                                                                                                               </style>                                                                                                                                                                                                                                                                <div class="ltr" flex="100" ui-ace="aceOption" ng-model="formula">                                                                      select * from tbl_meuns                                                                                                         </div>                                                                                                                                                                                                                                                              </md-dialog-content>                                                                                                                <md-dialog-actions layout="row">                                                                                                        <md-button ng-click="save()">                                                                                                           {{ \'ذخیره\' | translate }}                                                                                                        </md-button>                                                                                                                        <md-button ng-click="cancel()">                                                                                                         {{ \'cancel\' | translate }}                                                                                                      </md-button>                                                                                                                    </md-dialog-actions>                                                                                                            </md-dialog>'
        });
    }
} ]);

var ngApp = angular.module("management");

ngApp.controller("datasourceListCtrl", [ "$scope", "$http", "$mdToast", "$mdDialog", "$routeParams", "$location", "packages", "$timeout", "$translate", "datasources", "utils", "toolbar", function($scope, $http, $mdToast, $mdDialog, $routeParams, $location, packages, $timeout, $translate, datasources, utils, toolbar) {
    $scope.utils = utils;
    var packageId = typeof $routeParams.id != "undefined" ? $routeParams.id : 0;
    $scope.app = app;
    $scope._ = _;
    var param = packageId ? "?packageId=" + packageId : "";
    $scope.progress = true;
    $http.get(app.urlPrefix + "api/datasources/get" + param).then(function(data) {
        process(data);
        return;
        $scope.progress = false;
        var start = new Date();
        $scope.allData = data.data.list;
        $scope.pageCount = 40;
        $scope.page = 1;
        $scope.maxPage = ($scope.allData.length - 1) / $scope.pageCount + 1;
        $scope.setPage = function(n) {
            $scope.page = n;
            $scope.data = $scope.allData.slice(($scope.page - 1) * $scope.pageCount, $scope.page * $scope.pageCount);
        };
        $scope.setPage(1);
        $translate("لیست منابع داده").then(function(t) {
            $scope.listTranslate = t;
            data.data.path.unshift({
                name: t,
                id: null
            });
            $scope.path = data.data.path.map(function(d) {
                d.click = function() {
                    $scope.goto({
                        type: 1,
                        id: d.id
                    });
                };
                return d;
            });
            toolbar.setTitles($scope.path);
        });
    }, error);
    function process(data) {
        var start = new Date();
        $scope.progress = false;
        $scope.securityCertPatch = data.data.securityCertPatch;
        $scope.allData = data.data.list;
        $scope.pageCount = 40;
        $scope.page = 1;
        $scope.maxPage = Math.ceil($scope.allData.length / $scope.pageCount);
        $scope.setPage = function(n) {
            $scope.page = n;
            $scope.data = $scope.allData.slice(($scope.page - 1) * $scope.pageCount, $scope.page * $scope.pageCount);
        };
        $scope.setPage(1);
        $translate("لیست منابع داده").then(function(t) {
            $scope.listTranslate = t;
            data.data.path.unshift({
                name: t,
                id: null
            });
            $scope.path = data.data.path.map(function(d) {
                d.click = function() {
                    $scope.goto({
                        type: 1,
                        id: d.id
                    });
                };
                return d;
            });
            toolbar.setTitles($scope.path);
        });
        $timeout(function() {
            console.log("Process time: " + (new Date() - start));
        }, 0);
    }
    var isSelected = function() {
        return _.some($scope.data, {
            select: true
        });
    };
    $scope.menuInvalidate = function() {
        console.log("#### menuInvalidate");
        var flag = isSelected();
        var dirCount = _.filter($scope.data, {
            select: true,
            type: 1
        }).length;
        var chartCount = _.filter($scope.data, {
            select: true,
            type: 2
        }).length;
        $scope.canCopy = flag;
        $scope.canDelete = flag;
        $scope.canForward = flag;
        $scope.canDirEdit = dirCount == 1 && chartCount == 0;
    };
    function getSelectedIds() {
        return _.map(_.filter($scope.data, {
            select: true
        }), function(e) {
            return [ e.id, e.type ];
        });
    }
    function addPackages(p) {
        var index = _.lastIndexOf($scope.data.map(function(e) {
            return e.type;
        }), 1);
        if (index == -1) $scope.data = p.concat($scope.data); else Array.prototype.splice.apply($scope.data, [ index + 1, 0 ].concat(p));
    }
    $scope.copy = function() {
        var link = app.urlPrefix + "Moderation/Datasource/Clone";
        var ids = getSelectedIds();
        $http.post(link, ids).then(function(res) {
            if (res.data.result) {
                if (res.data.datasources) {
                    _.each(res.data.datasources, function(d) {
                        $scope.data.splice(_.findIndex($scope.data, {
                            type: 2
                        }), 0, d);
                    });
                }
                if (res.data.packages) {
                    addPackages(res.data.packages);
                }
                var toast = $mdToast.simple().textContent("کپی انجام شد");
                $mdToast.show(toast);
            }
        }, error);
    };
    function deleteFromList(ids) {
        $scope.data = _.filter($scope.data, function(item) {
            return !_.some(ids, {
                id: item.id,
                type: item.type
            });
        });
    }
    $scope.delete = function(ev) {
        var link = app.urlPrefix + "Moderation/Datasource/Delete";
        var ids = getSelectedIds();
        var confirm = $mdDialog.confirm().title("حذف برای همیشه؟").textContent(ids.length + " مورد برای حذف انتخاب شده است").ariaLabel("حذف").targetEvent(ev).ok("حذف!").cancel("لغو");
        $mdDialog.show(confirm).then(function() {
            $http.post(link, ids).then(function(res) {
                if (res.data.result) {
                    if (res.data.deletedIds) {
                        deleteFromList(res.data.deletedIds);
                    }
                    var toast = $mdToast.simple().textContent("حذف انجام شد");
                    $mdToast.show(toast);
                    $scope.menuInvalidate();
                }
            }, error);
        }, function() {
            $scope.status = "You decided to keep your debt.";
        });
    };
    $scope.forward = function(ev) {
        datasources.select(ev, {
            type: [ "datasources" ],
            justDir: true,
            selectableDir: true,
            multipleChart: false
        }).then(function(res) {
            var selected = res.selected[0];
            if ($routeParams.id == selected.id) {
                var toast = $mdToast.simple().textContent("موارد انتخاب شده در همین پوشه هستند");
                $mdToast.show(toast);
                return;
            }
            var Ids = getSelectedIds();
            $http.post(app.urlPrefix + "Moderation/Datasource/MoveToPackage", {
                Ids: Ids,
                packageId: selected.id
            }).then(function(data) {
                deleteFromList(data.data.ids);
                var toast = $mdToast.simple().textContent("انتقال انجام شد");
                $mdToast.show(toast);
            }, error);
        });
    };
    $scope.dirEdit = function(ev) {
        var ids = getSelectedIds();
        packages.edit(ev, 2, ids[0][0], function(data) {
            _.find($scope.data, {
                select: true
            }).name = data.data.info.Name;
            var toast = $mdToast.simple().textContent("نام پوشه تغییر کرد");
            $mdToast.show(toast);
        }, error);
    };
    $scope.newPackage = function(ev) {
        packages.create(ev, 2, $routeParams.id, function(data) {
            addPackages([ {
                id: data.data.info.Id,
                name: data.data.info.Name,
                type: 1
            } ]);
            var toast = $mdToast.simple().textContent("پوشه جدید ایجاد شد");
            $mdToast.show(toast);
            datasources.reset();
        }, error);
    };
    $scope.insertChart = function(row, ev) {
        $location.path("charts/new/normal/0/" + row.id);
    };
    $scope.gotoChart = function(c) {
        $location.path("charts/edit/" + 0 + "/" + c.id);
    };
    $scope.goto = function(row, event) {
        var Types = {
            MsOlap: 1,
            MSSQL: 2,
            MySQL: 3,
            File: 4,
            WebResource: 5,
            JoinDatasource: 6
        };
        if (row.systemType == 4 || row.systemType == 1) {
            alert("امکان ویرایش منابع داده سیستمی وجود ندارد");
            return;
        }
        if (row.type == 1) {
            $location.path("datasources" + (row.id ? "/" + row.id : ""));
        } else if (row.type == 2) {
            switch (row.dsType) {
              case Types.MySQL:
                $location.path("datasources/add/mssql/" + Types.MySQL + "/" + packageId + "/" + row.id);
                break;

              case Types.MsOlap:
                $location.path("datasources/add/mssql/" + Types.MsOlap + "/" + packageId + "/" + row.id);
                break;

              case Types.MSSQL:
                $location.path("datasources/add/mssql/" + Types.MSSQL + "/" + packageId + "/" + row.id);
                break;

              case Types.File:
                $location.path("datasources/add/file/" + packageId + "/" + row.id);
                break;

              case Types.WebResource:
                $location.path("datasources/add/web/" + packageId + "/" + row.id);
                break;

              case Types.JoinDatasource:
                $location.path("datasources/add/join/" + packageId + "/" + row.id);
                break;

              default:            }
        }
    };
    $scope.getTypeName = function(i) {
        var MsOlap = 1;
        var MSSQL = 2;
        var MySQL = 3;
        var File = 4;
        var WebResource = 5;
        var JoinDatasource = 6;
        var imageSource = "";
        switch (+i) {
          case MsOlap:
            imageSource = "MsOlap";
            break;

          case MSSQL:
            imageSource = "MSSQL";
            break;

          case MySQL:
            imageSource = "MySQL";
            break;

          case File:
            imageSource = "File";
            break;

          case WebResource:
            imageSource = "WebResource";
            break;

          case JoinDatasource:
            imageSource = "JoinDatasource";
            break;
        }
        return imageSource;
    };
    var timer;
    $scope.$watch("search", function() {
        $timeout.cancel(timer);
        timer = $timeout(function() {
            if (typeof $scope.search == "undefined") return;
            $scope.progress = true;
            $http.get(app.urlPrefix + "api/datasources/get" + "?q=" + $scope.search).then(function(data) {
                process(data);
                return;
                $scope.progress = false;
                $scope.data = data.data.list;
                $scope.path = data.data.path;
                $scope.path.unshift({
                    name: "لیست منابع داده",
                    id: null
                });
            }, error);
        }, 400);
    });
    $scope.selectAll = function() {
        if ($scope.data) {
            _.forEach($scope.data, function(item) {
                item.select = $scope.selectAllCheckbox;
            });
        }
        $scope.menuInvalidate();
    };
    $scope.newDatasource = function(ev) {
        $location.path("datasources/new/" + ($routeParams.id ? $routeParams.id : ""));
    };
    $scope.addTimeDatasoure = function(ev) {
        $translate([ "Create Time Datasource", "Enter the datasource name.", "name", "ok", "cancel" ]).then(function(msgs) {
            var confirm = $mdDialog.prompt().title(msgs["Create Time Datasource"]).textContent(msgs["Enter the datasource name."]).placeholder(msgs["name"]).ariaLabel(msgs["name"]).targetEvent(ev).ok(msgs["ok"]).cancel(msgs["cancel"]);
            $mdDialog.show(confirm).then(function(result) {
                $http.get(app.urlPrefix + "api/datasources/createDatetimeDatasource?name=" + result + "&pId=" + packageId).then(function(ds) {
                    $scope.data.splice(_.findIndex($scope.data, {
                        type: 2
                    }), 0, ds.data);
                }, function() {
                    alert("خطایی در ساخت منبع داده رخ داده است");
                });
            });
        });
    };
    $scope.sortDetail = {};
    $scope.sort = function(field) {
        $scope.sortDetail[field] = $scope.sortDetail[field] || {};
        $scope.sortDetail[field].isDesc = !$scope.sortDetail[field].isDesc;
        var f = _.filter($scope.data, {
            type: 1
        });
        var d = _.filter($scope.data, {
            type: 2
        });
        d = _.sortBy(d, [ field ]);
        f = _.sortBy(f, [ field ]);
        if (!$scope.sortDetail[field].isDesc) {
            d = _.reverse(d);
            f = _.reverse(f);
        }
        $scope.data = f.concat(d);
    };
    function error(e) {
        utils.showErrorToast(e.data.desc);
    }
} ]);

var ngApp = angular.module("management");

ngApp.controller("datasourceMssqlCtrl", [ "$scope", "$http", "$mdToast", "$mdDialog", "$routeParams", "$location", "packages", "$timeout", "$window", "$sce", "roles", "datasources", function($scope, $http, $mdToast, $mdDialog, $routeParams, $location, packages, $timeout, $window, $sce, roles, datasources) {
    var Types = {
        MsOlap: 1,
        MSSQL: 2,
        MySQL: 3,
        File: 4,
        WebResource: 5,
        JoinDatasource: 6
    };
    function error(res) {
        $scope.error = $sce.trustAsHtml("<b>" + filterXSS(res.data.title) + "</b> <br/>");
    }
    var packageId = typeof $routeParams.packageId != "undefined" ? $routeParams.packageId : 0;
    var id = typeof $routeParams.id != "undefined" ? $routeParams.id : 0;
    var type = $routeParams.type;
    var isEdit = id > 0;
    $scope.id = id;
    $scope.isEdit = isEdit;
    $scope.type = type;
    $scope.schedule = {};
    $scope.schedulePartition = [];
    if (isEdit) {
        $http.get(app.urlPrefix + "api/datasources/get?type=" + type + "&id=" + id).then(function(res) {
            $scope.model = res.data.model;
            if ($scope.model.Schedule) $scope.schedule = JSON.parse($scope.model.Schedule);
            if ($scope.model.schedulePartition) $scope.schedulePartition = JSON.parse($scope.model.schedulePartition);
            $scope.model.Type = type;
            if ($scope.model.intervalFetch) {
                var fields = [ $scope.model.intervalFetch.fieldTrash ].concat($scope.model.intervalFetch.fieldId || []);
                $scope.fields = fields;
            }
        }, error);
    } else {
        $scope.model = {
            Authentication: 0,
            CollationDefault: 1,
            AutoRefresh: "15",
            Type: type
        };
    }
    function showErrorToast(msg) {
        $mdToast.show({
            template: '<md-toast class="md-toast error"> <span class="md-toast-text" flex>' + msg + "</span></md-toast>",
            hideDelay: 3e3,
            position: "bottom left"
        });
    }
    $scope.saveProgress = false;
    function back() {
        if (window.history.length == 2) {
            $location.path("/datasources/" + packageId);
        } else {
            window.history.back();
        }
    }
    $scope.cancel = function() {
        back();
    };
    function scrollDown() {
        $("md-content").animate({
            scrollTop: 4e3
        }, 500);
    }
    $scope.save = function(withData) {
        $scope.model.saveData = withData;
        $scope.error = null;
        $scope.testResult = null;
        $scope.model.Schedule = JSON.stringify($scope.schedule);
        $scope.model.schedulePartition = JSON.stringify($scope.schedulePartition);
        $scope.model.RolesActions = _.filter($scope.roles, {
            check: true
        }).map(function(i) {
            return i.action + "-" + i.id;
        });
        $scope.saveProgress = true;
        $http.post(app.urlPrefix + "Moderation/Datasource/AddMsOlap", {
            model: $scope.model,
            Type: type,
            IsEdit: isEdit,
            PackageId: packageId
        }).then(function(res) {
            $scope.saveProgress = false;
            var toast = $mdToast.simple().textContent(isEdit ? "تغییرات ثبت شد" : "منبع داده جدید ایجاد شد");
            $mdToast.show(toast);
            back();
            datasources.reset();
        }, function(res) {
            $scope.saveProgress = false;
            $scope.error = $sce.trustAsHtml("<b>" + filterXSS(res.data.title) + "</b> <br/>");
            scrollDown();
        });
    };
    $scope.testProgress = false;
    $scope.test = function() {
        $scope.error = null;
        $scope.testResult = null;
        $scope.mssql.$submitted = true;
        if (!$scope.mssql.$valid) {
            showErrorToast("فیلدهای ضروری باید پر شوند");
            return;
        }
        $scope.model.Schedule = JSON.stringify($scope.schedule);
        $scope.model.schedulePartition = JSON.stringify($scope.schedulePartition);
        $scope.testProgress = true;
        $http.post(app.urlPrefix + "Moderation/Datasource/TestMsOlap", {
            model: $scope.model
        }).then(function(res) {
            $scope.testProgress = false;
            var html = "";
            if (type !== Types.MsOlap || $scope.model.Query) {
                var body = _.map(res.data.queryResult, function(row, index) {
                    return "<tr>" + _.map(row, function(td) {
                        return index === 0 ? "<th>" + filterXSS(td) + "</th>" : "<td>" + filterXSS(td) + "</td>";
                    }).join("") + "</tr>";
                }).join("");
                html = '<table class="table">' + body + "</table>";
                $scope.fields = res.data.queryResult[0];
            }
            if (type === Types.MsOlap && !$scope.model.Query) {
                html = '<div style="background-color:#dff0d8" flex>اتصال با موفقیت برقرار شد</div>';
            }
            $scope.testResult = $sce.trustAsHtml(html);
        }, function(error) {
            $scope.testProgress = false;
            $scope.error = $sce.trustAsHtml("<b>" + filterXSS(error.data.title) + "</b> <br/>");
            scrollDown();
        });
    };
    $scope.showDialog = function(ev) {
        showDialog(ev, $scope.model.Query).then(function(f) {
            $scope.model.Query = f;
        });
    };
    function showDialog(ev, formula) {
        return $mdDialog.show({
            controller: [ "$scope", "$mdDialog", "$timeout", function(sp, $mdDialog, $timeout) {
                sp.cancel = function() {
                    $mdDialog.cancel();
                };
                sp.save = function() {
                    $mdDialog.hide(sp.formula);
                };
                if (formula) {
                    sp.formula = formula;
                }
                sp.aceOption = {
                    useWrapMode: true,
                    showGutter: false,
                    theme: "sqlserver",
                    mode: "sqlserver",
                    maxLines: 14,
                    onLoad: aceLoaded,
                    require: [ "ace/ext/beautify" ]
                };
                function aceLoaded(editor, e) {
                    editor.renderer.setPadding(18);
                    sp.insertFormula = function(uniqename) {
                        editor.insert(uniqename);
                        editor.focus();
                    };
                }
            } ],
            parent: angular.element(document.body),
            targetEvent: ev,
            clickOutsideToClose: true,
            fullscreen: true,
            template: '<md-dialog aria-label="{{\'editor\' | translate}}" ng-cloak class="fullscreen-dialog">                                 <md-toolbar>                                                                                                                            <div class="md-toolbar-tools">                                                                                                          <h2>{{\'editor\' | translate}}</h2>                                                                                                   <span flex></span>                                                                                                                  <md-button class="md-icon-button" ng-click="cancel()">                                                                                  <span class="material-icons">close</span>                                                                                       </md-button>                                                                                                                    </div>                                                                                                                          </md-toolbar>                                                                                                                       <md-dialog-content layout-margin flex layout="row" class="md-dialog-contentx">                                                          <style>                                                                                                                                 .ace_editor {                                                                                                                           border: 1px solid #efefef;                                                                                                      }                                                                                                                                                                                                                                                                           .ace_editor, .ace_editor div {                                                                                                          font: 16px/normal \'Courier New\', \'Menlo\', \'Ubuntu Mono\', \'Consolas\', \'source-code-pro\', monospace;                              }                                                                                                                                                                                                                                                                   md-dialog.fullscreen-dialog {                                                                                                           max-width: 100%;                                                                                                                    max-height: 100%;                                                                                                                   width: 100%;                                                                                                                        height: 100%;                                                                                                                       border-radius: 0;                                                                                                               }                                                                                                                               </style>                                                                                                                                                                                                                                                                <div class="ltr" flex="100" ui-ace="aceOption" ng-model="formula">                                                                      select * from tbl_meuns                                                                                                         </div>                                                                                                                                                                                                                                                              </md-dialog-content>                                                                                                                <md-dialog-actions layout="row">                                                                                                        <md-button ng-click="save()">                                                                                                           {{ \'ذخیره\' | translate }}                                                                                                        </md-button>                                                                                                                        <md-button ng-click="cancel()">                                                                                                         {{ \'cancel\' | translate }}                                                                                                      </md-button>                                                                                                                    </md-dialog-actions>                                                                                                            </md-dialog>'
        });
    }
} ]);

var ngApp = angular.module("management");

ngApp.controller("datasourceNewCtrl", [ "$scope", "$http", "$mdToast", "$mdDialog", "$routeParams", "$location", "packages", "$timeout", "$translate", function($scope, $http, $mdToast, $mdDialog, $routeParams, $location, packages, $timeout, $translate) {
    var Types = {
        MsOlap: 1,
        MSSQL: 2,
        MySQL: 3,
        File: 4,
        WebResource: 5,
        JoinDatasource: 6
    };
    var packageId = typeof $routeParams.id == "undefined" ? 0 : $routeParams.id;
    $translate([ "sql server title", "sql server desc", "analysis service title", "analysis service desc", "file title", "file desc", "web service title", "web service desc", "datasource join title", "datasource join desc" ]).then(function(msg) {
        $scope.list = [ {
            href: "datasources/add/mssql/" + Types.MSSQL + "/" + packageId,
            icon: app.urlPrefix + "Images/ds-type-db.png",
            title: msg["sql server title"],
            desc: msg["sql server desc"]
        }, {
            href: "datasources/add/mssql/" + Types.MsOlap + "/" + packageId,
            icon: app.urlPrefix + "Images/ds-type-xmla.png",
            title: msg["analysis service title"],
            desc: msg["analysis service desc"]
        }, {
            href: "datasources/add/file/" + packageId,
            icon: app.urlPrefix + "Images/ds-type-upload.png",
            title: msg["file title"],
            desc: msg["file desc"]
        }, {
            href: "datasources/add/web/" + packageId,
            icon: app.urlPrefix + "Images/ds-type-point.png",
            title: msg["web service title"],
            desc: msg["web service desc"]
        }, {
            href: "datasources/add/join/" + packageId,
            icon: app.urlPrefix + "Images/join-datasource.png",
            title: msg["datasource join title"],
            desc: msg["datasource join desc"]
        } ];
    });
    $scope.goto = function(item) {
        console.log(item);
        $location.path(item.href);
    };
} ]);

(function($) {
    var md = angular.module("datasourcePartitionExpressionCat", [ "ngAnimate", "ui.mask", "datasourceScheduleCat" ]);
    md.directive("partitionExpression", [ "$timeout", "$http", function($timeout, $http) {
        return {
            restrict: "E",
            templateUrl: app.urlPrefix + "dist/partial/management/datasource/PartitionExprission.html",
            scope: {
                type: "=?",
                datasources: "=?",
                partition: "=ngModel"
            },
            controller: [ "$scope", "$http", function($scope, $http) {
                if (!$scope.type) $scope.type = 1;
                if (!$scope.partition) {
                    $scope.partition = [];
                }
                $scope.newPartition = function() {
                    $scope.partition.push({
                        formulas: [ {} ],
                        datasources: [],
                        autoRefresh: 60,
                        schedule: {}
                    });
                    $timeout(function() {
                        app.lang.setLang();
                    }, 0);
                };
                $scope.getPartitionName = function(i) {
                    var map = {
                        0: "اول",
                        1: "دوم",
                        2: "سوم",
                        3: "چهارم",
                        4: "‍‍‍پنجم",
                        5: "ششم",
                        6: "هفتم",
                        7: "هشتم",
                        8: "نهم",
                        9: "دهم"
                    };
                    if (+i < 10) return map[+i];
                    return "اضافه";
                };
                $scope.addDatasourceToPartition = function(item) {
                    var f = $scope.datasources.filter(function(d) {
                        return d.Id == item.id;
                    });
                    if (f.length > 0) item.partitions = $.extend(true, [], f[0].Partitions); else item.partitions = [];
                    $timeout(function() {
                        app.lang.setLang();
                    }, 0);
                };
                app.lang.setLang();
            } ],
            link: function() {
                app.lang.setLang();
            }
        };
    } ]);
})(jQuery);

(function() {
    var md = angular.module("datasourceScheduleCat", [ "ngAnimate", "ui.mask", "ngMaterial" ]);
    md.directive("datasourceSchedule", [ "$timeout", "$http", function($timeout, $http) {
        return {
            restrict: "E",
            templateUrl: app.urlPrefix + "dist/partial/management/datasource/Schedule.html?v=" + app.version,
            scope: {
                model: "=?ngModel"
            },
            controller: [ "$scope", "$http", "$element", "$mdMedia", "$mdDialog", function($scope, $http, $element, $mdMedia, $mdDialog) {
                if (!$scope.model || !$scope.model.occure) {
                    $scope.model = {
                        occure: "daily",
                        dailyRecurs: 1,
                        weeklyRecurs: 1,
                        weeklySat: true,
                        weeklySun: false,
                        weeklyMon: false,
                        weeklyTus: false,
                        weeklyWen: false,
                        weeklyThu: false,
                        weeklyFri: false,
                        monthlyDayOf: 1,
                        monthlyRecurs: 1,
                        dailyFrequency: "once",
                        dailyFrequencyAtHour: "0600",
                        dailyFrequencyRecur: 1,
                        dailyFrequencyRecurType: "hour",
                        dailyFrequencyStart: "0001",
                        dailyFrequencyStop: "2359"
                    };
                }
                $scope.formatClock = function(o) {
                    var s = o + "";
                    return s.substr(0, 2) + ":" + s.substr(2);
                };
                $scope.edit = function(ev) {
                    function ok(obj) {}
                    var useFullScreen = $mdMedia("sm") || $mdMedia("xs");
                    $mdDialog.show({
                        controller: [ "$scope", "$mdDialog", packageSelectController ],
                        templateUrl: app.urlPrefix + "dist/partial/management/datasource/scheduleDialog.html?v=" + Math.random(),
                        parent: angular.element(document.body),
                        targetEvent: ev,
                        clickOutsideToClose: true,
                        fullscreen: useFullScreen
                    }).then(ok);
                };
                function packageSelectController(scp, $mdDialog) {
                    scp.model = $scope.model;
                    scp.cancel = function() {
                        $mdDialog.cancel();
                    };
                    scp.checkValue = function() {
                        if (scp.model.dailyFrequencyRecurType == "second" && +scp.model.dailyFrequencyRecur < 10) {
                            scp.model.dailyFrequencyRecur = 10;
                        }
                    };
                    scp.save = function() {
                        $mdDialog.hide(scp.model);
                    };
                }
            } ]
        };
    } ]);
})();

(function() {
    var ngApp = angular.module("management");
    ngApp.directive("schemaTypes", [ function() {
        return {
            templateUrl: app.urlPrefix + "dist/partial/management/datasource/schemaTypes.html?v=" + app.version,
            scope: {
                model: "=?ngModel",
                id: "=?"
            },
            controller: [ "$scope", "$http", function($scope, $http) {
                $scope.types = [ {
                    name: "INT",
                    type: 0
                }, {
                    name: "BIGINT",
                    type: 1
                }, {
                    name: "DECIMAL",
                    type: 2
                }, {
                    name: "NVARCHAR_100",
                    type: 3
                }, {
                    name: "NVARCHAR_400",
                    type: 4
                }, {
                    name: "NVARCHAR_4000",
                    type: 5
                }, {
                    name: "NVARCHAR_MAX",
                    type: 6
                }, {
                    name: "DATE",
                    type: 7
                }, {
                    name: "DATE_TIME",
                    type: 8
                }, {
                    name: "BOOLEAN",
                    type: 9
                }, {
                    name: "FLOAT",
                    type: 10
                }, {
                    name: "UNKOWN",
                    type: 11
                }, {
                    name: "DATE_TIME2",
                    type: 12
                } ];
                var i = 0;
                $scope.$watch("model", function(n) {
                    i++;
                    if (i >= 3) {
                        $scope.change = true;
                        console.log("### chage model", $scope.change, n);
                    }
                }, true);
                $scope.save = function() {
                    $scope.saveProgress = true;
                    $http.post(app.urlPrefix + "api/datasources/changeSchema/" + $scope.id, $scope.model).then(function() {
                        $scope.saveProgress = false;
                        $scope.change = false;
                    }).catch(function(res) {
                        $scope.error = res.data.desc;
                        $scope.saveProgress = false;
                    });
                };
                $scope.remove = function() {
                    confirm("با پاک کردن اسکیما، داده‌های قبلی به همراه اسکیمای جدول نیز پاک خواهند شد. آیا برای اینکار اطمینان دارید؟");
                    $scope.removeProgress = true;
                    $http.post(app.urlPrefix + "api/datasources/cleanDatasource/" + $scope.id).then(function() {
                        $scope.removeProgress = false;
                        $scope.model = [];
                    }).catch(function(res) {
                        $scope.error = res.data.desc;
                        $scope.removeProgress = false;
                    });
                };
            } ]
        };
    } ]);
})();

var ngApp = angular.module("management");

ngApp.controller("datasourceWebCtrl", [ "$scope", "$http", "$mdToast", "$mdDialog", "$routeParams", "$location", "packages", "$timeout", "$window", "$sce", "datasources", function($scope, $http, $mdToast, $mdDialog, $routeParams, $location, packages, $timeout, $window, $sce, datasources) {
    var Types = {
        MsOlap: 1,
        MSSQL: 2,
        MySQL: 3,
        File: 4,
        WebResource: 5,
        JoinDatasource: 6
    };
    var packageId = typeof $routeParams.packageId != "undefined" ? $routeParams.packageId : 0;
    var id = typeof $routeParams.id != "undefined" ? $routeParams.id : 0;
    var type = $routeParams.type;
    var isEdit = id > 0;
    $scope.isEdit = isEdit;
    $scope.id = id;
    $scope.model = {
        contentType: "1",
        packageId: packageId
    };
    if (isEdit) {
        $http.get(app.urlPrefix + "api/datasources/get?type=" + Types.WebResource + "&id=" + id).then(function(res) {
            $scope.model = res.data.model;
            if ($scope.model.Schedule) $scope.schedule = JSON.parse($scope.model.Schedule);
            if ($scope.model.parameters) $scope.parameters = $scope.model.parameters.map(function(d) {
                return {
                    name: d[0],
                    value: d[1],
                    type: d[2] || "Query"
                };
            });
            if ($scope.model.intervalFetch) {
                var fields = [ $scope.model.intervalFetch.fieldTrash ].concat($scope.model.intervalFetch.fieldId || []);
                fields = _.uniq(fields);
                $scope.fields = fields;
            }
        }, error);
    }
    function error(res) {
        $scope.saveProgress = false;
        $scope.testProgress = false;
        $scope.error = res.data.title;
    }
    $scope.schedule = {};
    $scope.parameters = [ {
        type: "Query"
    } ];
    function prepareData(isTest) {
        $scope.model.isEdit = isEdit;
        $scope.model.isTest = isTest;
        $scope.model.id = id;
        $scope.model.parameters = $scope.parameters.filter(function(d) {
            return d.name;
        }).map(function(d) {
            return [ d.name, d.value, d.type ];
        });
        $scope.model.Schedule = JSON.stringify($scope.schedule);
        $scope.model.RolesActions = _.filter($scope.roles, {
            check: true
        }).map(function(i) {
            return i.action + "-" + i.id;
        });
    }
    $scope.saveProgress = false;
    $scope.save = function(withData) {
        $scope.model.saveData = withData || !$scope.isEdit ? true : false;
        $scope.error = null;
        $scope.testResult = null;
        if (!$scope.webForm.$valid) {
            showErrorToast("فیلدهای ضروری باید پر شوند");
            return;
        }
        prepareData(false);
        link = app.urlPrefix + "Moderation/WebResource/Add";
        $scope.saveProgress = true;
        $http.post(link, $scope.model).then(function(res) {
            $scope.saveProgress = false;
            var toast = $mdToast.simple().textContent(isEdit ? "تغییرات ثبت شد" : "منبع داده جدید ایجاد شد");
            $mdToast.show(toast);
            back();
            datasources.reset();
        }, error);
    };
    function back() {
        if (window.history.length == 2) {
            $location.path("/datasources/" + packageId);
        } else {
            window.history.back();
        }
    }
    $scope.testProgress = false;
    $scope.test = function() {
        $scope.error = null;
        $scope.testResult = null;
        if (!$scope.webForm.$valid) {
            showErrorToast("فیلدهای ضروری باید پر شوند");
            return;
        }
        prepareData(true);
        link = app.urlPrefix + "Moderation/WebResource/Add";
        $scope.testProgress = true;
        $http.post(link, $scope.model).then(function(res) {
            $scope.testProgress = false;
            var html = "";
            var body = _.map(res.data.list, function(row, index) {
                return "<tr>" + _.map(row, function(td) {
                    return index == 0 ? "<th>" + filterXSS(td) + "</th>" : "<td>" + filterXSS(td) + "</td>";
                }).join("") + "</tr>";
            }).join("");
            html = '<table class="table">' + body + "</table>";
            $scope.testResult = $sce.trustAsHtml(html);
            $scope.fields = res.data.list[0];
        }, error);
    };
    function showErrorToast(msg) {
        $mdToast.show({
            template: '<md-toast class="md-toast error"> <span class="md-toast-text" flex>' + msg + "</span></md-toast>",
            hideDelay: 3e3,
            position: "bottom left"
        });
    }
    function setResultSize() {
        var w = $("#main-form").width();
        $("#testResult").css("max-width", w + "px");
        $("#testResult").css("overflow", "auto");
    }
} ]);

var ngApp = angular.module("management");

ngApp.service("indicator", [ "$mdDialog", "$mdMedia", "$rootScope", "templates", "$http", function($mdDialog, $mdMedia, $rootScope, templates, $http) {
    var get = function(ev, series) {
        var useFullScreen = $mdMedia("sm") || $mdMedia("xs");
        return $mdDialog.show({
            controller: [ "$scope", "$mdDialog", packageSelectController ],
            parent: angular.element(document.body),
            targetEvent: ev,
            clickOutsideToClose: true,
            fullscreen: useFullScreen,
            templateUrl: templates.tmpl.package_dialog
        });
        function packageSelectController($scope, $mdDialog) {
            $scope.cancel = function() {
                $mdDialog.cancel();
            };
        }
    };
    return {
        get: get
    };
} ]);

var ngApp = angular.module("management");

ngApp.service("packages", [ "$mdDialog", "$mdMedia", "$rootScope", "$http", function($mdDialog, $mdMedia, $rootScope, $http) {
    var packageList;
    function getPackageList(scope, withContent) {
        if (!packageList) {
            packageList = $http.post(app.urlPrefix + "Moderation/Package/GetPackagesObject", {
                scope: scope,
                withContent: withContent
            });
        }
        return packageList;
    }
    var select = function(ev, scope, withContent, ok, fail) {
        var useFullScreen = $mdMedia("sm") || $mdMedia("xs");
        $mdDialog.show({
            controller: packageSelectController,
            templateUrl: app.urlPrefix + "dist/partial/management/packages/select-package.html",
            parent: angular.element(document.body),
            targetEvent: ev,
            clickOutsideToClose: true,
            fullscreen: useFullScreen
        }).then(ok, fail);
        function packageSelectController($scope, $mdDialog) {
            getPackageList(scope, withContent).then(function(d) {
                $scope.root = d.data.root;
                console.log("set root in package service ", $scope.root);
            });
            function doRecursive(e, callback) {
                callback(e);
                if (e.subPackages) {
                    _.forEach(e.subPackages, function(item) {
                        doRecursive(item, callback);
                    });
                }
            }
            $scope.clearSelect = function() {
                doRecursive($scope.root, function(item) {
                    item.select = false;
                });
            };
            $scope.cancel = function() {
                $mdDialog.cancel();
            };
            $scope.select = function() {
                var selected = null;
                doRecursive($scope.root, function(item) {
                    if (item.select) selected = item;
                });
                $mdDialog.hide(selected);
            };
        }
    };
    var create = function(ev, scope, parentId, ok, fail, cancel) {
        var confirm = $mdDialog.prompt().title("ایجاد پوشه جدید").textContent("نام پوشه جدید را وارد کنید").placeholder("نام پوشه").ariaLabel("نام پوشه").targetEvent(ev).ok("ایجاد").cancel("لغو");
        $mdDialog.show(confirm).then(function(name) {
            packageList = null;
            $http.post(app.urlPrefix + "Moderation/Package/Create", {
                name: name,
                scope: scope,
                parentId: parentId
            }).then(ok, fail);
        }, cancel);
    };
    var edit = function(ev, scope, id, ok, fail, cancel) {
        var confirm = $mdDialog.prompt().title("تغییر نام پوشه").textContent("نام جدید را وارد کنید").placeholder("نام پوشه").ariaLabel("نام پوشه").targetEvent(ev).ok("تغییر").cancel("لغو");
        $mdDialog.show(confirm).then(function(name) {
            packageList = null;
            $http.post(app.urlPrefix + "Moderation/Package/Edit", {
                id: id,
                name: name
            }).then(ok, fail);
        }, cancel);
    };
    return {
        name: "packages",
        select: select,
        create: create,
        edit: edit
    };
} ]);

var ngApp = angular.module("management");

ngApp.service("utils", [ "$http", "$translate", "$sce", "$mdToast", function($http, $translate, $sce, $mdToast) {
    function persian(s, showPersian) {
        if (typeof showPersian == "undefined") {
            showPersian = app.lang.isRtl();
        }
        if (!showPersian) return s;
        var reps = {
            0: "۰",
            1: "۱",
            2: "۲",
            3: "۳",
            4: "۴",
            5: "۵",
            6: "۶",
            7: "۷",
            8: "۸",
            9: "۹"
        };
        s = s + "";
        return s.replace(/(\d)/g, function(s, key) {
            return reps[key] || s;
        });
    }
    function depersian(s) {
        var reps = {
            "۰": 0,
            "۱": 1,
            "۲": 2,
            "۳": 3,
            "۴": 4,
            "۵": 5,
            "۶": 6,
            "۷": 7,
            "۸": 8,
            "۹": 9
        };
        s = s + "";
        return s.replace(/([۰۱۲۳۴۵۶۷۸۹])/g, function(s, key) {
            return typeof reps[key] != "undefined" ? reps[key] : s;
        });
    }
    function normilize(s) {
        var reps = {
            "ي": "ی",
            "إ": "ا",
            "ؤ": "و",
            "أ": "ا",
            "ک": "ك"
        };
        s = s + "";
        return s.replace(/(.)/g, function(s, key) {
            return reps[key] || s;
        });
    }
    function error(res) {
        var lastError = $sce.trustAsHtml(filterXSS("<b>" + res.data.title + "</b> <br/>" + res.data.desc));
        if (errorCalback) errorCalback(lastError);
    }
    var errorCalback;
    var onError = function(calback) {
        errorCalback = calback;
    };
    function showErrorToast(msg) {
        $mdToast.show({
            template: '<md-toast class="md-toast error"> <span class="md-toast-text" flex>' + msg + "</span></md-toast>",
            hideDelay: 3e3,
            position: "bottom left"
        });
    }
    return {
        persian: persian,
        depersian: depersian,
        normilize: normilize,
        error: error,
        onError: onError,
        showErrorToast: showErrorToast
    };
} ]);

var cat = angular.module("settingsCat", [ "ngAnimate" ]);

cat.controller("myController", [ "$scope", "$http", "$sce", "$timeout", function($scope, $http, $sce, $timeout) {
    $scope.langs = [ {
        key: 0,
        value: "فارسی"
    }, {
        key: 1,
        value: "English"
    } ];
    $scope.save = function(e) {
        $(e.target).button("loading");
        $http.post(app.urlPrefix + "Moderation/Settings/GeneralSettings", JSON.stringify({
            Brand: $scope.brand,
            Language: $scope.language
        }), {
            headers: {
                "Content-Type": "application/json; charset=utf-8"
            }
        }).then(function(res) {
            $(e.target).button("reset");
            if (res.data.result) {
                $("a.navbar-brand").text(res.data.brand);
                window.history.back();
            } else {
                $scope.error = $sce.trustAsHtml(filterXSS(res.data.error));
            }
        });
    };
    $scope.restore = function(model) {
        if (!model) return;
        $timeout(function() {
            var m = JSON.parse(model);
            console.log(m);
            $scope.brand = m.Brand;
            $scope.language = m.Language;
        }, 0);
    };
} ]);

var cat = angular.module("settingsCat", [ "ngAnimate" ]);

cat.controller("myController", [ "$scope", "$http", "$sce", "$timeout", function($scope, $http, $sce, $timeout) {
    $scope.save = function(e) {
        $http.post(app.urlPrefix + "Moderation/Settings/Mail", JSON.stringify({
            port: $scope.port,
            host: $scope.host,
            ssl: $scope.ssl,
            timeout: $scope.timeout,
            username: $scope.username,
            password: $scope.password
        }), {
            headers: {
                "Content-Type": "application/json; charset=utf-8"
            }
        }).then(function(res) {
            if (res.data.result) {
                window.history.back();
            } else {
                $scope.error = $sce.trustAsHtml(filterXSS(res.data.error));
            }
        });
    };
    $scope.restore = function(model) {
        if (!model) return;
        $timeout(function() {
            var m = JSON.parse(model);
            console.log("[settingsCat] ");
            console.log(m);
            $scope.port = m.port;
            $scope.host = m.host;
            $scope.ssl = m.ssl;
            $scope.timeout = m.timeout;
            $scope.username = m.username;
            $scope.password = m.password;
        }, 0);
    };
} ]);

var ngApp = angular.module("management");

ngApp.controller("dashboardsCtrl", [ "$scope", "$http", "$sce", "$timeout", "$mdToast", "toolbar", "$translate", "utils", "menus", function($scope, $http, $sce, $timeout, $mdToast, toolbar, $translate, utils, menus) {
    $scope.utils = utils;
    $scope.app = app;
    menus.get().then(function(res) {
        $scope.data = res.data;
        _.each($scope.data, function(item) {
            item.time = item.updateDate == 0 ? "" : moment.utc(item.updateDate).format("jYYYY/jMM/jDD HH:mm:ss");
        });
    });
} ]);

var ngApp = angular.module("management");

ngApp.controller("dashboardDetailCtrl", [ "$scope", "$http", "$sce", "$timeout", "$mdToast", "toolbar", "$translate", "utils", "menus", "$routeParams", "mainmenus", "menuCategories", "$location", function($scope, $http, $sce, $timeout, $mdToast, toolbar, $translate, utils, menus, $routeParams, mainmenus, menuCategories, $location) {
    $scope.utils = utils;
    $scope.app = app;
    $scope.id = $routeParams.id;
    menus.getMenu($routeParams.id).then(function(res) {
        $scope.model = res.data.model;
        $scope.model.notifications = $scope.model.notifications || {};
        $scope.metadataModule = res.data.metadataModule;
    });
    $scope.render = true;
    $scope.updateModel = function(data) {
        $scope.model.notifications = data;
        $scope.render = false;
        $timeout(function() {
            $scope.render = true;
        }, 0);
        console.log("$scope.updateModel ", data);
    };
    mainmenus.get(-1).then(function(res) {
        $scope.mainMenus = res.data.list;
    });
    menuCategories.get().then(function(res) {
        $scope.menuCategories = res.data.list;
    });
    function getUsers() {
        $http.get(app.urlPrefix + "api/users/get").then(function(data) {
            $scope.users = data.data.list;
        }, utils.error);
    }
    getUsers();
    $scope.save = function() {
        $scope.saveProgress = true;
        $scope.error = null;
        $scope.model.rolesAction = _.filter($scope.roles, {
            check: true
        }).map(function(i) {
            return {
                action: i.action,
                id: i.id,
                name: i.name
            };
        });
        menus.save($scope.model).then(function(res) {
            $scope.saveProgress = false;
            $scope.model = res.data;
            if ($scope.id == 0) {
                $location.path("/dashboards/" + res.data.id);
            }
            var toast = $mdToast.simple().textContent("تغییرات با موفقیت ذخیره شد");
            $mdToast.show(toast);
        }).catch(function(res) {
            $scope.saveProgress = false;
            $scope.error = $sce.trustAsHtml(filterXSS(res.data.desc));
        });
    };
    $scope.restore = function(model) {
        var old = _.extend({}, $scope.model);
        _.each(model.rolesAction, function(item) {
            item.check = false;
            var f = _.find($scope.roles, {
                id: item.id
            });
            if (f) {
                f.action = item.action;
                f.check = true;
            }
        });
        $scope.model = model;
        $scope.save();
    };
    $scope.cancel = function() {
        back();
    };
    function back() {
        if (window.history.length == 2) {
            $location.path("/dashboards");
        } else {
            window.history.back();
        }
    }
} ]);

var ngApp = angular.module("management");

ngApp.directive("versions", function() {
    return {
        restrict: "E",
        scope: {
            id: "@id",
            type: "@type",
            onRestore: "&"
        },
        controller: [ "$scope", "versionsSvr", function($scope, versionsSvr) {
            $scope.app = app;
            $scope.moment = moment;
            versionsSvr.get($scope.id, $scope.type).then(function(res) {
                $scope.list = res.data.list;
                _.each($scope.list, function(item) {
                    item.time = item.updateDate == 0 ? "" : moment.utc(item.timestamp).format("jYYYY/jMM/jDD HH:mm:ss");
                });
            }).catch(function(res) {
                alert("دریافت با خطا مواجه شده است");
            });
            $scope.showDetail = function(i) {
                versionsSvr.detail(i.id).then(function(res) {
                    $scope.showDetailFlag = true;
                    $scope.detail = JSON.parse(res.data);
                }).catch(function() {
                    alert("دریافت با خطا مواجه شده است");
                });
            };
            $scope.remove = function(i, index) {
                var f = confirm("آیا برای حذف این رکورد اطمینان دارید؟");
                if (!f) return;
                versionsSvr.remove(i.id).then(function(res) {
                    $scope.list.splice(index, 1);
                }).catch(function() {
                    alert("عملیات با خطا مواجه شده است");
                });
            };
            $scope.restore = function() {
                if ($scope.onRestore) {
                    var f = confirm("آیا برای بازگردانی اطمینان دارید؟");
                    if (!f) return;
                    $scope.onRestore({
                        model: $scope.detail
                    });
                }
            };
            $scope.cancelDetail = function() {
                $scope.showDetailFlag = false;
            };
        } ],
        templateUrl: app.urlPrefix + "dist/partial/management/directives/versions.html?v=" + app.version
    };
});

angular.module("services").service("versionsSvr", [ "$http", function($http) {
    function get(id, type) {
        return $http.get(app.urlPrefix + "api/versions/get?id=" + id + "&type=" + type);
    }
    function detail(id) {
        return $http.get(app.urlPrefix + "api/versions/detail/" + id);
    }
    function remove(id) {
        return $http.get(app.urlPrefix + "api/versions/remove/" + id);
    }
    return {
        get: get,
        detail: detail,
        remove: remove
    };
} ]);

(function() {
    var md = angular.module("management");
    md.directive("datasourceMetainfo", [ "$timeout", "$http", "roles", function($timeout, $http, roles) {
        return {
            restrict: "E",
            templateUrl: app.urlPrefix + "dist/partial/management/datasource/datasourceMetainfo.html?v=" + app.version,
            scope: {
                model: "=ngModel"
            },
            controller: [ "$scope", "$http", function($scope, $http) {
                $scope.show = app.datasourceMetadata;
                $scope.model = $scope.model || {};
            } ]
        };
    } ]);
})();
// داشبورد مدیریتی صدف info@sadafdashboard.ir 

var app = app || {};

app.chartCommons = {};

app.chartCommons.tooltip = {
    tooltipFormatter: function(set, fh, f, showPersain) {
        var body = set.points.map(function(point) {
            var bodyFormat = f || '{{point.label}}: <p class="ltr inline" style="padding:0; margin:0;" ><b>{{point.data}}</b></p>';
            return bodyFormat.replace(/{{([^(}})]+)}}/gm, function(i, p1) {
                if (!p1.match(/point\.(data|label|color|format|percentage)/)) return p1;
                var e = eval(p1);
                if (e === "NaN") e = "تعریف نشده";
                var s = !isNaN(e) ? persian(d3.format(point.format)(e), showPersain) : e;
                return '<span class="inline ltr">' + s + "</span>";
            });
        }).join("<br/>");
        var headerFormat = fh || "";
        var header = headerFormat.replace(/{{([^(}})]+)}}/gm, function(i, p1) {
            var e = eval(p1);
            return isNaN(e) || p1 === "set.key" ? e : persian(d3.format(set.format)(e), showPersain);
        });
        if (header && body.trim()) header += "<BR/>";
        r = '<div style="margin:0;text-align: right; padding:0;direction: rtl;">' + header + body + "</div>";
        var d = _.cloneDeep(filterXSS.whiteList);
        d.span = [ "class" ];
        var fxx = filterXSS(r, {
            whiteList: d
        });
        return fxx;
    }
};

app.chartCommons.levelTypeUtils = {
    getParam: function(settings) {
        if (settings.editMode) return;
        if (settings.chartProp.levelTypes && settings.chartProp.levelTypes.enable) {
            var find = app.chartCommons.drillDown.get(settings.ChartInPageId);
            var drillCount = find && _.isArray(find.drillDown) ? find.drillDown.length : 0;
            var index = Math.min(drillCount, Object.keys(settings.chartProp.levelTypes.props).length - 1);
            var newSet = settings.chartProp.levelTypes.props[index];
            newSet.prop.levelTypes = _.merge({}, settings.chartProp.levelTypes);
            settings.chartProp = newSet.prop;
            settings.type = newSet.type;
        }
    }
};

app.chartCommons.highchartSetTheme = function() {
    var colors = d3.scale.category10();
    Highcharts.setOptions({
        lang: {
            loading: "در حال بارگذاری...",
            months: [ "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December" ],
            shortMonths: [ "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec" ],
            weekdays: [ "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday" ],
            decimalPoint: ".",
            numericSymbols: [ "k", "M", "G", "T", "P", "E" ],
            resetZoom: "حالت اولیه",
            resetZoomTitle: "حالت اولیه 1:1",
            thousandsSep: ","
        },
        global: {
            useUTC: true,
            canvasToolsURL: "http://code.highcharts.com/4.1.4/modules/canvas-tools.js",
            VMLRadialGradientURL: "http://code.highcharts.com/4.1.4/gfx/vml-radial-gradient.png"
        }
    });
    Highcharts.theme = {
        chart: {},
        xAxis: {
            title: {
                text: null,
                align: "middle"
            }
        },
        yAxis: {
            endOnTick: false,
            title: {
                text: null,
                align: "middle"
            },
            labels: {
                formatter: function() {
                    return persian(d3.format(",")(this.value));
                }
            },
            lineWidth: 2,
            lineColor: "#D8D8D8",
            tickWidth: 1
        },
        tooltip: {
            valueSuffix: "",
            useHTML: true,
            formatter: function() {
                return "<b>" + this.x + "</b>: <b>" + this.series.tooltipOptions.pointFormatter(this) + "</b>";
            },
            headerFormat: "",
            style: {
                "text-align": "right"
            }
        },
        plotOptions: {
            bar: {
                dataLabels: {
                    enabled: true
                }
            },
            series: {
                animation: {
                    duration: 800,
                    easing: "easeInCubic"
                },
                allowPointSelect: true,
                fillOpacity: .1,
                marker: {
                    fillColor: "#FFFFFF",
                    lineWidth: 2,
                    lineColor: null
                }
            }
        },
        credits: {
            enabled: false
        },
        colors: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 ].map(function(d, i) {
            return colors(i);
        }),
        chart: {
            animation: {
                duration: 400,
                easing: "linear"
            },
            panning: true,
            panKey: "shift"
        },
        title: {
            text: null,
            style: {
                color: "#000",
                font: "bold 16px Droid, Tahoma, Arial"
            }
        },
        subtitle: {
            style: {
                color: "#666666",
                font: "bold 12px Droid, Tahoma, Arial"
            }
        },
        legend: {
            itemStyle: {
                font: "9pt Droid, Tahoma, Arial",
                color: "black"
            },
            itemHoverStyle: {
                color: "gray"
            }
        }
    };
    Highcharts.setOptions(Highcharts.theme);
};

app.chartCommons.getError = function(input) {
    if (!input.result) {
        var title = +input.errorType == 0 ? "منبع داده غیر فعال است" : "اشکال در پرس و جو";
        return "<div class='temporal error'> <h4>" + title + "</h4><p>" + input.errorMessage + "</p></div>";
    }
    return "<div class='temporal error'> مشکلی در روند برنام ایجاد شده است</div>";
};

app.chartCommons.clearFilterParamsCache = function(allParams) {
    if (!allParams) {
        allParams = JSON.parse(localStorage.getItem("filter-params") || "[]");
    }
    var time = new Date().getTime() - 1e3 * 60 * 60 * 24;
    _.remove(allParams, function(item) {
        if (item.time < time) return true;
        return false;
    });
    localStorage.setItem("filter-params", JSON.stringify(allParams));
};

app.chartCommons.openLink = function(model, data) {
    if (!model || !model.checked) return;
    if (!model.type) {
        model.type = "dashboard";
        if (model.dashboardId == -1) model.type = "link";
    }
    if (app.mobileMode) {
        JavaListener.post("open-dashboard", JSON.stringify(model));
        return;
    }
    if (model.type == "dashboard") {
        var key = "";
        if (model.passFilterType == "value-with-other" || model.passFilterType == "value") {
            if (model.passFilterType == "value") {
                app.chartCommons.userFilter.clearAll();
                app.chartCommons.drillDown.clearAll();
            }
            if (data) {
                var x = {
                    id: -1,
                    values: data.value,
                    valuesCaption: data.caption,
                    variableType: 0,
                    dimensionName: data.dimensionName,
                    chartInPageId: data.ChartInPageId,
                    datasourceId: data.DataSourceId,
                    disableClear: false,
                    refreshDatasource: data.refreshDatasource
                };
                app.chartCommons.userFilter.setFilter(x);
            }
            data = {
                drillDown: app.chartCommons.drillDown.filters,
                userFilter: app.chartCommons.userFilter.filters
            };
            var allParams = JSON.parse(localStorage.getItem("filter-params") || "[]");
            key = "filter-" + md5(JSON.stringify(data));
            _.remove(allParams, {
                key: key
            });
            allParams.push({
                dash: model.dashboardId,
                key: key,
                data: data,
                time: new Date().getTime()
            });
            localStorage.setItem("filter-params", JSON.stringify(allParams));
        }
        var appc = location.hash.replace(/.*app\/(\d+)\/dashboard.*/, "$1");
        location.hash = "#/app/" + appc + "/dashboard/" + model.dashboardId + (key ? "/" + key : "");
    }
    if (model.type == "back") {
        window.history.back();
    }
    if (model.type == "link") {
        var win = window.open(model.link, "_blank");
        if (win) {
            win.focus();
        } else {
            alert("Please allow popups for this site");
        }
    }
};

app.chartCommons.calculateFields = function(series, calcFormulas, columnIsNumeric) {
    return;
    if (!calcFormulas || !calcFormulas.fields) return;
    if (!series) return;
    var formulas = calcFormulas.fields;
    function calc(item, series, columnIsNumeric) {
        if (series.labels.indexOf(item.name) != -1) {
            return;
        }
        if (!(series.data instanceof Array)) {
            return;
        }
        var isValid = /^({\s*r?([+-]?\d*)\s*,?\s*c?(\d*)}|[\d\s\+-\/\)\(\*]*|'[^']*')*$/gim.test(item.formula);
        if (!isValid) {
            alert("### Not valid " + item.formula);
            return;
        }
        var indexes = [];
        var repFormula = item.formula.replace(/{\s*r?([\+-]?\d*)\s*,?\s*c?(\d*)}/gim, function(i, r, c) {
            indexes.push({
                row: +r,
                col: +c
            });
            return "$" + (indexes.length - 1);
        });
        function getCell(array, row, col) {
            row = row < 0 ? 0 : row >= array.length ? array.length - 1 : row;
            col = col < 0 ? 0 : col >= array[0].length ? array[0].length - 1 : col;
            return array[row][col];
        }
        for (var i = 0; i < series.data.length; i++) {
            var rowFormula = repFormula.replace(/\$(\d+)/gim, function(s, index) {
                var o = indexes[+index];
                var cell = getCell(series.data, o.row + i, o.col);
                if (columnIsNumeric) {
                    if (!columnIsNumeric[o.col]) return "'" + cell + "'";
                }
                return cell || 0;
            });
            series.data[i].push(eval(rowFormula));
        }
        series.labels.push(item.name);
    }
    _.forEach(formulas, function(f) {
        calc(f, series, columnIsNumeric);
    });
};

app.chartCommons.drillDown = {
    filters: [],
    add: function(chartInPageId, datasourceId, k, v, refreshDatasource) {
        if (!_.isArray(v)) {
            v = [ v ];
        }
        if (!_.isArray(k)) {
            k = [ k ];
        }
        if (_.isArray(v)) {
            v = JSON.stringify(v);
            k = JSON.stringify(k);
        }
        var chart = _.find(this.filters, {
            chartInPageId: chartInPageId
        });
        if (_.isUndefined(chart)) {
            var entry = {
                chartInPageId: chartInPageId,
                datasourceId: datasourceId,
                refreshDatasource: refreshDatasource,
                drillDown: [ {
                    key: k,
                    value: v
                } ]
            };
            this.filters.push(entry);
            return entry.drillDown;
        }
        var pair = _.find(chart.drillDown, {
            key: k
        });
        if (!_.isUndefined(pair)) {
            _.remove(chart.drillDown, {
                key: k
            });
        }
        chart.drillDown.push({
            key: k,
            value: v
        });
        return chart.drillDown;
    },
    up: function(chartInPageId, upLevel) {
        var chart = _.find(this.filters, {
            chartInPageId: chartInPageId
        });
        if (_.isUndefined(chart)) return [];
        if (_.isUndefined(upLevel)) upLevel = 1;
        for (var i = 0; i < upLevel; i++) {
            if (chart.drillDown.length > 0) chart.drillDown.pop();
        }
        return chart.drillDown;
    },
    get: function(chartInPageId) {
        return _.find(this.filters, {
            chartInPageId: chartInPageId
        });
    },
    clear: function(chartInPageId) {
        return _.remove(this.filters, {
            chartInPageId: chartInPageId
        });
    },
    clearAll: function() {
        this.filters = [];
    }
};

app.chartCommons.getFilterHierarchy = function(chartInPageId, data) {
    var data = $(".cid" + chartInPageId + " .chart-dimentions-content").data("data");
    if (_.isUndefined(data)) return null;
    function justSelectedMembers(h) {
        if (!_.isArray(h)) return;
        for (var i = 0; i < h.length; i++) {
            var item = h[i];
            if (typeof item.Members != "undefined" && item.Members) {
                item.Members = item.Members.filter(function(d, i) {
                    return d.IsChecked;
                });
                item.FilteredMemberByUser = true;
            }
        }
        return h;
    }
    return {
        Hierarchies: justSelectedMembers(data.Hierarchies),
        Where: justSelectedMembers(data.Where),
        SeriesLevel: justSelectedMembers(data.SeriesLevel)
    };
};

app.chartCommons.userFilter = {
    filters: [],
    clearAll: function() {
        this.filters = [];
    },
    setUserControlFilters: function(d) {
        this.filters = [];
        if (_.isArray(d)) this.filters = d;
    },
    setFilter: function(data) {
        if (this.filters.length == 0) {
            this.filters.push(data);
            return;
        }
        var chartFilter = _.find(this.filters, {
            chartInPageId: data.chartInPageId,
            dimensionName: data.dimensionName
        });
        if (!_.isUndefined(chartFilter)) {
            _.remove(this.filters, {
                chartInPageId: data.chartInPageId,
                dimensionName: data.dimensionName
            });
        }
        this.filters.push(data);
    },
    setFilterIfNotExist: function(data) {
        if (_.isEmpty(data.values)) return;
        if (_.isArray(data.values) && data.values.length == 0) return;
        if (this.filters.length == 0) {
            this.filters.push(data);
            return;
        }
        var chartFilter = _.find(this.filters, {
            chartInPageId: data.chartInPageId
        });
        if (_.isUndefined(chartFilter)) {
            this.filters.push(data);
        }
    },
    getFilterValue: function(chartInPageId) {
        var chartFilter = _.find(this.filters, {
            chartInPageId: chartInPageId
        });
        if (_.isUndefined(chartFilter)) return null;
        return chartFilter;
    }
};

app.chartCommons.lastRefreshDateFormat = function(date) {
    if (!date) return "";
    if (app.lang.langType !== 0) {
        return date.D + "/" + date.M + "/" + date.Y + " - " + date.h + ":" + date.m + ":" + date.s + " ";
    }
    var dif = "";
    if (date.Diff) {
        if (date.Diff < 60 * 60 * 24) {
            dif += " - <b>";
            dif += date.Diff < 60 ? Math.floor(date.Diff) + " ثانیه پیش" : date.Diff < 60 * 60 ? Math.floor(date.Diff / 60) + " دقیقه پیش" : Math.floor(date.Diff / (60 * 60)) + " ساعت پیش";
            dif += "</b>";
        }
    }
    var monthName = +date.M == 1 ? "فروردین" : +date.M == 2 ? "اردیبهشت" : +date.M == 3 ? "خرداد" : +date.M == 4 ? "تیر" : +date.M == 5 ? "مرداد" : +date.M == 6 ? "شهریور" : +date.M == 7 ? "مهر" : +date.M == 8 ? "آبان" : +date.M == 9 ? "آذر" : +date.M == 10 ? "دی" : +date.M == 11 ? "بهمن" : "اسفند";
    return persian(date.D + " " + monthName + " ماه " + date.Y + " ساعت " + date.h + ":" + date.m + ":" + date.s + " " + dif, true);
};

app.chartCommons.setFilterParameter = function(settings) {
    var refresDs = settings.input && settings.input.RefreshDatasource ? settings.input.RefreshDatasource : null;
    var filters = app.chartCommons.getFilterParameter(settings.ChartInPageId, refresDs);
    settings.parameters.drillDown = filters.drillDown;
    if (settings.editMode) return;
    settings.parameters.otherFilters = filters.otherFilters;
    settings.parameters.userControlFilter = filters.userControlFilter;
    settings.parameters.userVariable = filters.userVariable;
};

app.chartCommons.getFilterParameter = function(chartInPage, refreshDatasource) {
    var ret = {
        drillDown: null
    };
    var selfDrill = _.find(app.chartCommons.drillDown.filters, {
        chartInPageId: chartInPage
    });
    if (!_.isUndefined(selfDrill)) ret.drillDown = selfDrill.drillDown;
    ret.otherFilters = _.filter(app.chartCommons.drillDown.filters, function(d) {
        if (!refreshDatasource) return false;
        var refresh = refreshDatasource.indexOf(d.datasourceId) != -1;
        return refresh && d.chartInPageId != chartInPage;
    });
    ret.userControlFilter = $.extend([], _.filter(app.chartCommons.userFilter.filters, function(d) {
        if (!refreshDatasource) return false;
        var refresh = refreshDatasource.indexOf(d.datasourceId) != -1;
        return refresh;
    }));
    var userVariable = JSON.parse(localStorage.getItem("userVariable"));
    ret.userVariable = userVariable;
    return ret;
};

app.chartCommons.expandedType = 1;

app.chartCommons.clicked = false;

app.chartCommons.changeSeriesPropertyBaseOnExpandedType = function(props, justOneSeries) {
    var expandedType = app.chartCommons.expandedType;
    props = props || {};
    props.info = props.info || {};
    props.info.aggregation = "1";
    if (expandedType === 1) {
        _.each(props.series, function(p, k) {
            if (justOneSeries && k != justOneSeries) return;
            p.seriesType = "bar";
            p.areaOpacity = .1;
        });
        props.info.stackedBar = "1";
        props.info.stackedLine = "1";
        props.info.isBox = false;
    }
    if (expandedType === 28) {
        _.each(props.series, function(p, k) {
            if (justOneSeries && k != justOneSeries) return;
            p.seriesType = "bar";
        });
        props.info.stackedBar = "1";
        props.info.stackedLine = "1";
        props.info.isBox = true;
    }
    if (expandedType == 2) {
        _.each(props.series, function(p, k) {
            if (justOneSeries && k != justOneSeries) return;
            p.seriesType = "bar";
            p.areaOpacity = .1;
        });
        props.info.stackedBar = "2";
        props.info.isBox = false;
        props.info.stackedLine = "1";
    }
    if (expandedType == 21) {
        _.each(props.series, function(p, k) {
            if (justOneSeries && k != justOneSeries) return;
            p.seriesType = "bar";
            p.areaOpacity = .1;
        });
        props.info.stackedBar = "3";
        props.info.stackedLine = "1";
        props.info.isBox = false;
    }
    if (expandedType == 3) {
        _.each(props.series, function(p, k) {
            if (justOneSeries && k != justOneSeries) return;
            p.seriesType = "line";
            p.lineType = "line-dot-area";
            p.areaOpacity = .1;
        });
        props.info.stackedBar = "1";
        props.info.stackedLine = "1";
        props.info.isBox = false;
    }
    if (expandedType == 4) {
        _.each(props.series, function(p, k) {
            if (justOneSeries && k != justOneSeries) return;
            p.areaOpacity = .1;
            p.lineType = "line-dot-area";
            p.seriesType = "line";
        });
        props.info.stackedBar = "1";
        props.info.stackedLine = "2";
        props.info.isBox = false;
    }
    if (expandedType == 22) {
        _.each(props.series, function(p, k) {
            if (justOneSeries && k != justOneSeries) return;
            p.areaOpacity = .1;
            p.seriesType = "line";
            p.lineType = "line-dot-area";
        });
        props.info.stackedBar = "1";
        props.info.stackedLine = "3";
        props.info.isBox = false;
    }
    if (expandedType == 5) {
        _.each(props.series, function(p, k) {
            if (justOneSeries && k != justOneSeries) return;
            p.seriesType = "line";
            p.lineType = "line-area";
            p.areaOpacity = .4;
        });
        props.info.stackedBar = "1";
        props.info.stackedLine = "1";
        props.info.isBox = false;
    }
    if (expandedType == 6) {
        _.each(props.series, function(p, k) {
            if (justOneSeries && k != justOneSeries) return;
            p.seriesType = "line";
            p.lineType = "line-area";
            p.areaOpacity = .4;
        });
        props.info.stackedBar = "1";
        props.info.stackedLine = "2";
        props.info.isBox = false;
    }
    if (expandedType == 23) {
        _.each(props.series, function(p, k) {
            if (justOneSeries && k != justOneSeries) return;
            p.seriesType = "line";
            p.lineType = "line-area";
            p.areaOpacity = .4;
        });
        props.info.stackedBar = "1";
        props.info.stackedLine = "3";
        props.info.isBox = false;
    }
    if (expandedType == 7) {
        props.info.hole = "0";
    }
    if (expandedType == 8) {
        props.info.hole = "50";
    }
    if (expandedType == 14) {
        props.info.aggregation = "-1";
    }
    if (expandedType == 29) {
        props.info.aggregation = "-1";
    }
    if (expandedType == 13) {
        props.info.aggregation = "1";
    }
    if (expandedType == 15) {
        props.info.type = "combo";
    }
    if (expandedType == 16) {
        props.info.type = "multi";
    }
    if (expandedType == 17) {
        props.info.type = "datepicker";
    }
    if (expandedType == 18) {
        props.info.type = "datepicker-range";
    }
    if (expandedType == 19) {
        props.info.type = "slider";
    }
    if (expandedType == 20) {
        props.info.type = "text";
    }
    if (expandedType == 9) {
        props.info.segmentType = "singleSegment";
        props.info.style = "arc";
    }
    if (expandedType == 24) {
        props.info.segmentType = "multiSegment";
        props.info.style = "arc";
    }
    if (expandedType == 25) {
        props.info.segmentType = "singleSegment";
        props.info.style = "horizontal";
    }
    if (expandedType == 26) {
        props.info.segmentType = "multiSegment";
        props.info.style = "horizontal";
    }
    if (expandedType == 27) {
        props.info.style = "number";
        props.info.icons = props.info.icons || [ {
            name: "icon warning"
        } ];
        props.info.showLabels = true;
    }
};

app.chartCommons.setDefault = function(props, d, type) {
    var colors = d3.scaleOrdinal(d3.schemeCategory10);
    if (_.isUndefined(d)) return;
    _.each(d, function(i, j) {
        var color = colors(j);
        var k = type;
        props.series = props.series || {};
        var dd = {
            bar: {
                seriesColor: color,
                seriesType: "bar",
                formatString: ",.0f",
                numberFactor: "1",
                showValues: false,
                hidden: false,
                cumulative: false,
                cumulative_formula: "sum",
                lineFace: "5,0",
                lineWeight: "2",
                lineStyle: "linear",
                lineType: "line-dot-area",
                showValueColor: "#333333",
                areaOpacity: .1,
                formatStringCustom: ",.0f",
                font: {
                    bold: false,
                    color: "#333333",
                    italic: false,
                    fontSize: "11px",
                    fontName: "IRANSans",
                    formatString: ",.3s",
                    formatStringCustom: ",.0f"
                },
                top: {
                    IsTop: false,
                    Top: 10,
                    IsPercent: false,
                    TopOrder: "DESC"
                }
            },
            map: {
                hidden: false,
                formatString: ",.0f",
                colorStart: "#31a354",
                colorEnd: "#c7e9c0",
                top: {
                    IsTop: false,
                    Top: 10,
                    IsPercent: false,
                    TopOrder: "DESC"
                }
            },
            pie: {
                main: true,
                numberFactor: "1",
                top: {
                    IsTop: false,
                    Top: 10,
                    IsPercent: false,
                    TopOrder: "DESC"
                }
            },
            gauge: {
                type: "value",
                typeMs: "value",
                numberFactor: "1",
                top: {
                    IsTop: false,
                    Top: 10,
                    IsPercent: false,
                    TopOrder: "DESC"
                }
            },
            radar: {
                numberFactor: "1",
                seriesColor: color,
                top: {
                    IsTop: false,
                    Top: 10,
                    IsPercent: false,
                    TopOrder: "DESC"
                }
            },
            table: {
                numberFactor: "1",
                textAlign: "right",
                formatString: ",.0f",
                fontSize: "1em",
                textItalic: false,
                textBold: false,
                color: "#000000",
                rowResult: "0",
                isHidden: false,
                top: {
                    IsTop: false,
                    Top: 10,
                    IsPercent: false,
                    TopOrder: "DESC"
                }
            },
            userControl: {
                numberFactor: "1",
                type: "value"
            },
            text: {}
        };
        var change = false;
        if (_.isUndefined(props.series[i]) && app.chartCommons.clicked === true) {
            change = true;
            app.chartCommons.clicked = false;
        }
        props.series[i] = $.extend({}, dd[k], props.series[i]);
        if (change) app.chartCommons.changeSeriesPropertyBaseOnExpandedType(props, i);
    });
};

app.chartCommons.commentUtils = {
    getLabelsMeasures: function(input) {
        var labels = [];
        var measures = [];
        var measuresKey = [];
        if (input.matrix) {
            _.each(input.matrix, function(d) {
                labels.push(d.captions);
            });
            _.each(input.series.labels, function(d) {
                measuresKey.push(d);
            });
            _.each(input.seriesLablesCaptions || input.series.labels, function(d) {
                measures.push(d);
            });
        } else {
            labels = input.headers;
        }
        return {
            labels: labels,
            measures: measures,
            measuresKey: measuresKey
        };
    },
    getCommentCount: function(comments, category, label) {
        var stringArray = category;
        if (_.isArray(category)) stringArray = _.sortBy(category).join(", ");
        return comments.filter(function(c) {
            return stringArray == c.label && c.measure == label;
        }).length;
    },
    getChartSelector: function(cip) {
        return ".cid" + cip;
    },
    clickOnCommentIcon: function(d, cip) {
        $(app.chartCommons.commentUtils.getChartSelector(cip)).trigger("new-comment", d);
        try {
            d3.event.preventDefault();
            d3.event.stopPropagation();
        } catch (e) {}
    },
    highlight: function(collections, d) {
        var f = false;
        _.each(collections, function(col) {
            if (col instanceof jQuery) {
                col.removeClass("selected");
            } else {
                col.classed("selected", false);
            }
        });
        _.each(collections, function(col) {
            if (f) return false;
            if (col instanceof jQuery) {
                var tableData = $(col[0]).data("table-data");
                col.each(function(d2, e) {
                    var i = $(e).data("xrow");
                    var j = $(e).data("xcol");
                    var d2 = tableData.rows[i][j];
                    if (d.category == d2.category && d.seriesLable == d2.seriesLable) {
                        d3.select(this).classed("selected", true);
                        f = true;
                        return false;
                    }
                });
                return;
            }
            col.each(function(d2) {
                if (d.category == d2.category && d.seriesLable == d2.seriesLable) {
                    d3.select(this).classed("selected", true);
                    f = true;
                    return false;
                }
            });
        });
    },
    setOnHighlightListener: function(d3Collection, cip) {
        var collections = $(app.chartCommons.commentUtils.getChartSelector(cip)).data("collections") || [];
        collections.push(d3Collection);
        $(app.chartCommons.commentUtils.getChartSelector(cip)).data("collections", collections);
        $(app.chartCommons.commentUtils.getChartSelector(cip)).off("highlight-element");
        $(app.chartCommons.commentUtils.getChartSelector(cip)).on("highlight-element", function(e, d) {
            if (!d) return;
            var collections = $(app.chartCommons.commentUtils.getChartSelector(cip)).data("collections") || [];
            app.chartCommons.commentUtils.highlight(collections, d);
        });
    },
    destroyListener: function(cip) {
        $(app.chartCommons.commentUtils.getChartSelector(cip)).data("collections", null);
    },
    addCommentIcon: function(cip, g, fx, fy) {
        if (!app.commentOnChart) return;
        var settings = $(app.chartCommons.commentUtils.getChartSelector(cip)).find(".chart-data").data("settings");
        if (!settings.permissions.Comment) return;
        var container = g.append("g").attr("transform", function(d, i) {
            return "translate(" + fx(d, i) + "," + fy(d, i) + ")scale(0.38)";
        }).attr("class", function(d) {
            return "comment" + (d.commentCount ? " show" : "");
        }).on("click", function(d) {
            app.chartCommons.commentUtils.clickOnCommentIcon(d, cip);
        });
        var t = container.append("rect");
        t.attrs({
            width: 50,
            height: 24,
            "class": "comment-background"
        });
        container.append("path").attr("d", "M10.718,18.561l6.78,5.311C17.609,23.957,17.677,24,17.743,24  c0.188,0,0.244-0.127,0.244-0.338v-5.023c0-0.355,0.233-0.637,0.548-0.637L21,18c2.219,0,3-1.094,3-2s0-13,0-14s-0.748-2-3.014-2  H2.989C0.802,0,0,0.969,0,2s0,13.031,0,14s0.828,2,3,2h6C9,18,10.255,18.035,10.718,18.561z");
        container.append("text").text(function(d) {
            return d.commentCount ? persian(d.commentCount, true) : "";
        }).attrs({
            x: 34,
            y: "0.7em"
        }).styles({
            "font-size": "20px"
        });
    },
    updateIconCommentCount: function(cip, cm, length) {
        var col = $(app.chartCommons.commentUtils.getChartSelector(cip)).data("collections")[0];
        if (col instanceof jQuery) {
            var tableData = $(col[0]).data("table-data");
            col.each(function() {
                var i = $(this).data("xrow");
                var j = $(this).data("xcol");
                var d = tableData.rows[i][j];
                var stringCat = _.sortBy(d.category).join(", ");
                if (d.seriesLable == cm.measure && stringCat == cm.label) {
                    var tabeleTd = $(app.chartCommons.commentUtils.getChartSelector(cip) + " td[data-xcol=" + j + "][data-xrow=" + i + "]");
                    var $tdComment = $(this).find(".comment");
                    var $tdComment2 = tabeleTd.find("svg:not(.td-comment) .comment");
                    if ($tdComment.length == 0) {
                        var $comment = $(app.chartCommons.commentUtils.getChartSelector(cip) + " svg");
                        $tdComment = $comment.clone().removeClass("td-comment");
                        $tdComment2 = $comment.clone().removeClass("td-comment");
                        $(this).append($tdComment);
                        tabeleTd.append($tdComment2);
                    }
                    $tdComment.find(".comment").attr("class", "comment show");
                    $tdComment.find("text").text(length ? persian(length, true) : "");
                    $tdComment2.find(".comment").attr("class", "comment show");
                    $tdComment2.find("text").text(length ? persian(length, true) : "");
                }
            });
            return;
        }
        var el = this;
        var chartComments = d3.selectAll(app.chartCommons.commentUtils.getChartSelector(cip) + " .comment");
        var modalComments = d3.selectAll("#" + app.chartCommons.commentUtils.getChartInModalSelector(cip) + " .comment");
        function update(col) {
            col.each(function(d) {
                var stringCat = _.sortBy(d.category).join(", ");
                if (d.seriesLable == cm.measure && stringCat == cm.label) {
                    d3.select(this).select("text").text(length ? persian(length, true) : "");
                    d3.select(this).classed("show", length > 0 ? true : false);
                }
            });
        }
        update(modalComments);
        update(chartComments);
    },
    getChartInModalSelector: function(cip) {
        return "modal-chart-container-" + cip;
    },
    showLastVersionChart: function() {}
};

app.chartCommons.renderComments = function(settings, input) {
    if (!app.commentOnChart) return;
    if (!settings.permissions.Comment) return;
    if (!input.FinalWhereList) return;
    var selector = app.chartCommons.commentUtils.getChartSelector(settings.ChartInPageId);
    var chartSelector = app.chartCommons.commentUtils.getChartInModalSelector(settings.ChartInPageId);
    var $commentIcon = $(selector + " .show-chart-comments");
    var commentSideHeight = 300;
    $(selector + " .comment-section").remove();
    var FilteredComments = input.comment;
    if (settings.fromCommentDialog) {
        return;
    }
    var lastVersionModalSelector = ".last-version-modal";
    $(".comment-modal.modal" + settings.ChartInPageId).remove();
    $(selector).off("new-comment");
    $commentIcon.off("click");
    createLastVersionChartModal();
    function createLastVersionChartModal() {
        var template = '<div class="ui fuild modal ' + lastVersionModalSelector.substring(1, 1e3) + ' rtl"  style="cursor: initial;">' + '     <i class="close icon"></i>' + '     <div class="header">نسخه قبلی نمودار</div>' + '     <div class="content" id="' + lastVersionModalSelector.substring(1, 1e3) + '" style="height:350px">' + '         <div class="ui active inverted dimmer"><div class="ui text loader">آماده‌سازی نمودار</div></div>' + "     </div>" + "</div>";
        if ($(lastVersionModalSelector).length == 0) {
            var $modal = $(template);
            $("body").append($modal);
            $modal.modal({
                allowMultiple: true,
                onVisible: function() {
                    app.chartCommons.commentUtils.showLastVersionChart();
                },
                onHidden: function() {
                    $(lastVersionModalSelector + " .content").html('<div class="ui active inverted dimmer"><div class="ui text loader">آماده‌سازی نمودار</div></div>');
                }
            });
        }
    }
    function createLableMeasureSelectTag(a, name) {
        if (!a || !a.length) return "";
        return filterXSS("" + '<div class="six wide field">' + '<select class="ui tiny search selection dropdown ' + (name ? name : "") + '">' + "<option>" + a.join("</option><option>") + "</option>" + "</select>" + "</div>");
    }
    function getValueFormat(d) {
        return filterXSS('<div class="ui mini label value comment-value" data-label="' + d.label + '" data-measure="' + d.measure + '" data-value="' + d.value + '" style="">  ' + d.measure + " در " + d.label + ": " + persian(d3.format(",.2f")(d.value), true) + "</div>");
    }
    function createComment(d) {
        var version = "";
        if (+d.chartVersion !== +input.version) {
            version = persian(" نسخه " + d.chartVersion + " نمودار ", true);
            version = '            <span class="version pointer" style="color:red;" data-version="' + d.chartVersion + '">' + version + "</span>";
        }
        return '<div class="comment" data-id="' + d.id + '">' + '    <div class="content">' + '        <span class="author">' + d.username + "</span>" + '        <span class="value-string">' + getValueFormat(d) + "</span>" + '        <div class="metadata">' + '            <span class="date">' + moment(d.time).fromNow() + "</span>" + version + "        </div>" + '        <div class="text">' + '            <span class="comment-text">' + filterXSS(d.comment) + "            </span>" + '            <span class="auto-hide animated ">' + '            <a class="reply pointer metadata"> پاسخ </a>' + (d.userId === app.userId ? '            <a class="edit pointer metadata"> ویرایش </a>' : "") + (d.userId === app.userId ? '            <a class="remove pointer metadata"> حذف </a>' : "") + "            </span>" + "        </div>" + '        <div class="actions">' + "        </div>" + "    </div>" + (d.childs && d.childs.length ? createComments(d.childs) : "") + "</div>";
    }
    var isMobile = $(window).width() < 768;
    function createComments(comments, style) {
        var c = (comments || []).map(createComment, style).join("");
        return '<div class="ui tiny relaxed threaded comments ' + (!style ? "" : " root") + '" ' + (!style ? "" : 'style=" ' + (isMobile ? "" : "min-height:" + commentSideHeight + "px; overflow:auto;") + '   flex-grow: 1;flex-shrink: 1;flex-basis: 0px;"') + ">" + c + "</div>";
    }
    function getPopupContent(comments) {
        var c = createComments(comments, true) + '<form class="ui tiny form">' + '  <div class="field">' + '    <input type="text" rows="2" placeholder="نظر شما چیست؟" />' + "  </div>" + '  <div class="fields">' + createLableMeasureSelectTag(labels, "labels") + createLableMeasureSelectTag(measures, "measures") + "  </div>" + "</form>";
        return '<div class="ui popup comment-popup comment-section rtl" style="cursor: initial;">' + c + "</div>";
    }
    function getModalContent(comments) {
        var finalWhere = input.FinalWhereList.map(function(d) {
            var t = "" + '<div class="ui orange mini label">' + "<span>" + d.Key.replace(/\[id\d+\].\[(.*)\]/, "$1") + ": </span>" + '<span style="font-weight:200;">' + d.Value.join(",") + "</span>" + "</div>";
            return t;
        }).join("");
        var comentTemplate = createComments(comments, true);
        var formTemplae = '<form class="ui tiny form">' + '  <div class="final-where">' + filterXSS(finalWhere) + "</div>" + '  <div class="comment-modal-value"><span class="measure-value"></span> در <span class="label-value"></span>  <span class="value-value"></span></div>' + '  <div class="field">' + '    <textarea type="text"  rows="1" placeholder="' + app.lang.translate("new comment") + '"></textarea>' + "  </div>" + "</form>";
        return '<div class="ui modal comment-modal comment-section rtl modal' + settings.ChartInPageId + '" style="cursor: initial;">' + '     <i class="close icon"></i>' + '     <div class="header">' + app.lang.translate("commenting") + "</div>" + '     <div class="content ' + (isMobile ? "scrolling" : "") + '" style="padding:0">' + '         <div class="ui mobile reversed stackable padded grid">' + '             <div class="six wide column" ' + (isMobile ? "" : 'style="border-left: 1px solid #dcddde;display: flex;flex-direction: column;justify-content: flex-end;"') + ">" + comentTemplate + '     <div class="header" style="flex"></div>' + formTemplae + "             </div>" + '             <div class="six wide column chart-container" id="' + chartSelector + '" >' + '                   <div class="ui active inverted dimmer"><div class="ui text loader">' + app.lang.translate("preparing chart") + "</div></div>" + "             </div>" + "         </div>" + "     </div>" + "</div>";
    }
    function getModalContent_v0(comments) {
        var comentTemplate = createComments(comments, true);
        var formTemplae = '<form class="ui tiny form">' + '  <div class="field">' + '    <input type="text"  placeholder="نظر شما چیست؟" />' + "  </div>" + '  <div class="fields">' + createLableMeasureSelectTag(labels, "labels") + createLableMeasureSelectTag(measures, "measures") + "  </div>" + "</form>";
        return '<div class="ui modal comment-modal comment-section rtl modal' + settings.ChartInPageId + '" style="cursor: initial;">' + '     <i class="close icon"></i><div class="header">کامنت گذاری</div>' + '     <div class="content" style="padding:0">' + '         <div class="ui padded grid">' + '             <div class="six wide column" style="border-left: 1px solid #dcddde;">' + comentTemplate + "             </div>" + '             <div class="six wide column chart-container" id="' + chartSelector + '" style="height: 400px;">' + '                   <div class="ui active inverted dimmer"><div class="ui text loader">آماده‌سازی نمودار</div></div>' + "             </div>" + "         </div>" + "     </div>" + '     <div class="actions">' + formTemplae + "     </div>" + "</div>";
    }
    function removeSelectedComment() {
        $popup.find(".selected-comment").remove();
        $popup.find(".selected-comment-edit").remove();
        $input.val(null);
    }
    function getValueByLabelMeasure(l, m) {
        if (!l || !m) return "";
        var lIndex = labels.indexOf(l);
        var mIndex = measures.indexOf(m);
        var selectedValue = input.series.data[lIndex][mIndex];
        return selectedValue;
    }
    function setEditBoxValues(d) {
        $input.val(d.comment);
        if (!d.seriesLable) {}
        var val = getValueByLabelMeasure(d.seriesLable, d.measure);
        $labelText.data("v", d.seriesLable);
        $measureText.data("v", d.measure);
        $input.focus();
        $showSelectedValueContainer.hide();
        if (d.seriesLable) {
            $showSelectedValueContainer.show();
            $labelText.text(d.seriesLable);
            $measureText.text(d.measure);
            $value.text(persian(d3.format(",.2f")(val), true));
        }
    }
    function setReplyListener($el) {
        $el.find(".version").on("click", function() {
            var v = $(this).data("version");
            app.chartCommons.commentUtils.showLastVersionChart = function() {
                $(lastVersionModalSelector + " .content").charts(settings.type, {
                    id: lastVersionModalSelector.substring(1, 1e3),
                    parameters: {
                        type: settings.dataType,
                        fromCommentDialog: true,
                        lastVersionInfo: {
                            version: v,
                            lastVersionChartId: settings.chartId
                        }
                    }
                });
            };
            $(lastVersionModalSelector).modal("show");
        });
        $el.find(".reply").on("click", function() {
            var id = $(this).parents(".comment").data("id");
            removeSelectedComment();
            $selectedComment = $('<div class="ui mini label selected-comment field" data-id="' + id + '">پاسخ به ' + id + ' <i class="icon close" style="margin:0;"/>  </div>');
            $popup.find(".ui.form").prepend($selectedComment);
            $selectedComment.find(".icon").on("click", removeSelectedComment);
            $input.focus();
        });
        $el.find(".edit").on("click", function() {
            var id = $(this).parents(".comment").data("id");
            var $comment = $(this).parents(".comment").first();
            removeSelectedComment();
            $selectedComment = $('<div class="ui mini label selected-comment-edit field" data-id="' + id + '"> ویرایش ' + id + ' <i class="icon close" style="margin:0;"/>  </div>');
            $popup.find(".ui.form").prepend($selectedComment);
            $selectedComment.find(".icon").on("click", removeSelectedComment);
            setEditBoxValues({
                comment: $comment.find(".comment-text").first().text().trim(),
                label: $comment.find(".value").first().data("label"),
                measure: $comment.find(".value").first().data("measure")
            });
        });
        $el.find(".remove").on("click", function() {
            var id = $(this).parents(".comment").data("id");
            var $comment = $(this).parents(".comment").first();
            var f = confirm("در صورت حذف کامنت تمام پاسخ‌ها نیز حذف می‌شوند. آیا برای حذف اطمینان دارید؟");
            if (!f) return;
            var url = app.urlPrefix + "api/chartComments/Delete?id=" + id;
            $.post(url).done(function(cm) {
                $comment.transition("scale");
                var rootComment = null;
                _.each(FilteredComments, function(f) {
                    if (f.id == id) {
                        rootComment = f;
                    }
                });
                findComment(input.comment, id, function(cs, c, index) {
                    if (c.id == id) {
                        cs.splice(index, 1);
                    }
                });
                if (rootComment) {
                    var len = app.chartCommons.commentUtils.getCommentCount(FilteredComments, cm.label, cm.measure);
                    app.chartCommons.commentUtils.updateIconCommentCount(settings.ChartInPageId, cm, len);
                }
            });
        });
    }
    function findComment(comments, id, callback) {
        var f = null;
        var index = 0;
        _.each(comments, function(c) {
            if (callback) callback(comments, c, index);
            if (c.id == id) {
                f = c;
                return false;
            }
            var inChild = findComment(c.childs, id);
            if (inChild) {
                f = inChild;
                return false;
            }
            index++;
        });
        return f;
    }
    function filterComments(filter) {
        $popup.find(" .root.comments > .comment").hide();
        _.each(filter, function(d) {
            $popup.find(" .root.comments > .comment[data-id=" + d.id + "]").show();
        });
    }
    function getFilteredComment(d) {
        var stringCat = _.sortBy(d.category).join(", ");
        return FilteredComments.filter(function(c) {
            return stringCat == c.label && d.seriesLable == c.measure;
        });
    }
    function showChart() {
        var s = _.extend({}, settings);
        s.id = chartSelector;
        s.fromCommentDialog = true;
        $("#" + s.id).empty();
        app.chartCommons.commentUtils.destroyListener(s.ChartInPageId);
        app.chartCommons.draw(s.type, input, s, false);
        $("#" + chartSelector).on("select-series", function(e, d) {
            setEditBoxValues({
                comment: "",
                label: d.category,
                measure: d.seriesLable,
                measureKey: d.seriesKey
            });
            filterComments(getFilteredComment(d));
        });
    }
    if (FilteredComments) {
        moment.locale("fa");
        $(selector).data("init-befor", true);
        var l = app.chartCommons.commentUtils.getLabelsMeasures(input);
        var labels = l.labels;
        var measures = l.measures;
        var measuresKey = l.measuresKey;
        var $popup = $(getModalContent(FilteredComments));
        var $input = $popup.find("textarea");
        var $btn = $popup.find(".button");
        var $chartContainer = $popup.find(".chart-container");
        var $showSelectedValueContainer = $popup.find(".comment-modal-value");
        var $measureText = $popup.find(".measure-value");
        var $labelText = $popup.find(".label-value");
        var $value = $popup.find(".value-value");
        var submit = function() {
            var selectedLabel = $labelText.data("v");
            var selectedMeasure = $measureText.data("v");
            if (!_.isArray(selectedLabel)) selectedLabel = [ selectedLabel ];
            if (_.isArray(selectedMeasure)) selectedMeasure = selectedMeasure[0];
            if (_.isEmpty($input.val())) {
                alert("کامنت خود را بنویسید");
                return;
            }
            if (_.isEmpty(selectedLabel)) {
                alert("یکی از ردیف‌های اطلاعاتی را انتخاب کنید");
                return;
            }
            if (_.isEmpty(selectedMeasure)) {
                alert("یکی از داده‌ها را انتخاب کنید");
                return;
            }
            var selectedValue = getValueByLabelMeasure(selectedLabel, selectedMeasure);
            var savedSettings = $(selector + " .chart-data").data("settings");
            var filters = app.chartCommons.getFilterParameter(savedSettings.ChartInPageId, savedSettings.input.RefreshDatasource);
            var parentId = $popup.find(".selected-comment").data("id");
            var editId = $popup.find(".selected-comment-edit").data("id");
            function success(cm) {
                $btn.removeClass("loading");
                $input.val(null);
                removeSelectedComment();
                FilteredComments = FilteredComments || [];
                var parent = findComment(FilteredComments, parentId);
                if (parent) {
                    parent.childs = parent.childs || [];
                    parent.childs.push(cm);
                } else {
                    FilteredComments.push(cm);
                    var len = app.chartCommons.commentUtils.getCommentCount(FilteredComments, cm.label, cm.measure);
                    app.chartCommons.commentUtils.updateIconCommentCount(settings.ChartInPageId, cm, len);
                }
                var $comments = $popup.find(".comments.root");
                if (parentId) {
                    $parentComment = $popup.find(".comment[data-id=" + parentId + "] .comments");
                    if ($parentComment.length == 0) {
                        $parentComment = $popup.find(".comment[data-id=" + parentId + "]");
                        var $innerComments = $(createComments());
                        $parentComment.append($innerComments);
                        $parentComment = $innerComments;
                    }
                    $comments = $parentComment;
                }
                var $cm = $(createComment(cm));
                $comments.append($cm);
                setReplyListener($cm);
                setTimeout(function() {
                    var c = $popup.find(".root.comments [data-id=" + cm.id + "]");
                    var r = $popup.find(".root.comments");
                    r.animate({
                        scrollTop: r.scrollTop() + c.offset().top - r.height() + c.height()
                    }, 400);
                    setTimeout(function() {
                        c.transition("pulse");
                    }, 400);
                }, 400);
            }
            var stringLabels = _.sortBy(selectedLabel).join(", ");
            var data = {
                where: savedSettings.input.FinalWhereList,
                chartId: savedSettings.chartId,
                dashboardId: dashboard.pageId,
                datasourceId: savedSettings.input.DataSourceId,
                dimention: savedSettings.input.CurrentDimName,
                input: JSON.stringify(savedSettings.input),
                drillDown: filters.drillDown,
                otherFilters: filters.otherFilters,
                userControlFilter: filters.userControlFilter,
                userVariable: filters.userVariable,
                comment: $input.val().trim(),
                parentId: parentId,
                label: stringLabels,
                measure: selectedMeasure,
                value: selectedValue
            };
            $btn.addClass("loading");
            if (editId) {
                $.post(app.urlPrefix + "api/ChartComments/edit?" + "id=" + editId + "&text=" + $input.val().trim() + "&label=" + selectedLabel + "&measure=" + selectedMeasure + "&value=" + selectedValue).done(function(cm) {
                    $btn.removeClass("loading");
                    removeSelectedComment();
                    $input.val(null);
                    var $comment = $popup.find(".comment[data-id=" + editId + "]").first();
                    var $commentText = $popup.find(".comment[data-id=" + editId + "] .comment-text").first();
                    var $commentValueString = $popup.find(".comment[data-id=" + editId + "] .value-string").first();
                    $commentText.text(cm.comment);
                    $commentValueString.html(getValueFormat(cm));
                    setTimeout(function() {
                        $comment.transition("pulse");
                    }, 400);
                }).fail(function(e) {
                    $btn.removeClass("loading");
                });
                return;
            }
            $.ajax({
                type: "POST",
                url: app.urlPrefix + "api/ChartComments/save/0",
                data: JSON.stringify(data),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: success,
                error: function(xhr) {
                    $btn.removeClass("loading");
                }
            });
        };
        var box = {
            type: "modal",
            render: function() {
                $(selector).append($popup);
                setReplyListener($popup);
                $input.on("keyup", function(e) {
                    if (e.keyCode == 13 && e.ctrlKey) {
                        $input.val($input.val() + "\n");
                        return;
                    }
                    if (e.keyCode == 13) {
                        submit();
                    }
                });
                if (this.type == "modal") {
                    $popup.modal({
                        allowMultiple: true,
                        onVisible: function myfunction() {
                            showChart();
                            $(app.chartCommons.commentUtils.getChartSelector(settings.ChartInPageId)).trigger("highlight-element", [ box.highlightedValue ]);
                        }
                    });
                    $commentIcon.on("click", function() {
                        var d = {
                            category: labels[0],
                            seriesLable: measures[1],
                            seriesLablekey: measuresKey[1]
                        };
                        $(selector).trigger("new-comment", d);
                    });
                }
                if (this.type == "popup") {
                    $commentIcon.popup({
                        popup: $(selector + " .popup.ui"),
                        target: $(selector + " .ui.card .content"),
                        title: "کامنت‌ها",
                        position: "top right",
                        boundary: $(".main-container"),
                        on: "click",
                        lastResort: true,
                        prefer: "opposite",
                        onShow: function(e, i) {
                            $(selector + " .menu-bar").addClass("show-dropdown");
                        },
                        onVisible: function() {
                            $parentDiv = $(".main-container.full-height-container");
                            $innerListItem = $popup;
                            $parentDiv.animate({
                                scrollTop: $parentDiv.scrollTop() - $parentDiv.height() + $innerListItem.offset().top + $innerListItem.height() + 40
                            }, 400);
                        },
                        onHide: function(e, i) {
                            $(selector + " .menu-bar").removeClass("show-dropdown");
                        }
                    });
                }
            },
            show: function() {
                if (this.type == "modal") {
                    $popup.modal("show");
                }
                if (this.type == "popup") {
                    $commentIcon.popup("show");
                }
            }
        };
        box.render();
        $(selector).on("new-comment", function(e, d) {
            setEditBoxValues({
                comment: "",
                seriesLable: d.category,
                measure: d.seriesLable,
                measureKey: d.seriesKey
            });
            filterComments(getFilteredComment(d));
            box.highlightedValue = d;
            box.show();
            $(selector).trigger("highlight-element", [ box.highlightedValue ]);
        });
    }
};

jQuery.fn.extend({
    lazyDropdown: function(options) {
        return this.each(function() {
            var $e = $(this);
            $e.on("click", function(ev) {
                if (!$e.data("init-dd")) {
                    ev.stopPropagation();
                    ev.preventDefault();
                    $e.data("init-dd", true);
                    $e.dropdown(options);
                    $e.click();
                }
            });
        });
    }
});

app.chartCommons.indicator = {
    ifToString: function(ifRows, labels, captions, settings) {
        var opMap = {
            "1": "برابر باشد با",
            "2": "مخاف باشد با",
            "3": "کوچک تر باشد از",
            "4": "کوچکتر یا مساوی باشد از",
            "5": "بزرگ‌تر باشد از",
            "6": "بزرگ‌تر یا مساوی باشد از",
            "7": "شامل",
            "8": "عدم شمول"
        };
        var getCaption = function(name) {
            if (!labels || !captions) return;
            var index = labels.indexOf(name);
            var prop = settings.chartProp.series[name] = settings.chartProp.series[name] || {};
            return prop.name || captions[index];
        };
        var ifString = _.map(ifRows, function(row) {
            return "" + getCaption(row.firstField) + " " + opMap[row.operand] + " " + (row.secondFieldIsText ? row.secondFieldInput : "" + getCaption(row.secondFieldSelect) + "");
        });
        return ifString.join(" و ");
    },
    checkRow: function(ifObj, fields, headers) {
        var Index = headers.indexOf(ifObj.firstField);
        if (Index == -1) return false;
        try {
            var r = fields[Index];
        } catch (e) {
            debugger;
        }
        var firstVal = fields[Index];
        var secVal = 0;
        if (ifObj.secondFieldIsText) {
            secVal = ifObj.secondFieldInput;
        } else {
            var i = headers.indexOf(ifObj.secondFieldSelect);
            if (i === -1) return false;
            secVal = fields[i];
        }
        firstVal = depersian(firstVal);
        secVal = depersian(secVal);
        if (!isNaN(secVal)) secVal = +secVal;
        if (!isNaN(firstVal)) firstVal = +firstVal;
        switch (+ifObj.operand) {
          case 1:
            return firstVal == secVal;

          case 2:
            return firstVal != secVal;

          case 3:
            return firstVal > secVal;

          case 4:
            return firstVal >= secVal;

          case 5:
            return firstVal < secVal;

          case 6:
            return firstVal <= secVal;

          case 7:
            return firstVal.indexOf(secVal) > -1;

          case 8:
            return firstVal.indexOf(secVal) <= -1;

          default:        }
    },
    getIndicator: function(fields, headers, indicator) {
        var result = [];
        var hKeys = headers;
        if (indicator) indicator.forEach(function(ind) {
            var isTrue = true;
            $.each(ind.ifRow, function(i, d) {
                if (!app.chartCommons.indicator.checkRow(d, fields, hKeys)) {
                    isTrue = false;
                    return false;
                }
            });
            if (isTrue) {
                result.push(JSON.parse(JSON.stringify(ind.thenRow)));
            }
        });
        return result;
    }
};

(function() {
    var out$ = typeof exports != "undefined" && exports || typeof define != "undefined" && {} || this || window;
    if (typeof define !== "undefined") define("save-svg-as-png", [], function() {
        return out$;
    });
    var xmlns = "http://www.w3.org/2000/xmlns/";
    var doctype = '<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd" [<!ENTITY nbsp "&#160;">]>';
    var urlRegex = /url\(["']?(.+?)["']?\)/;
    var fontFormats = {
        woff2: "font/woff2",
        woff: "font/woff",
        otf: "application/x-font-opentype",
        ttf: "application/x-font-ttf",
        eot: "application/vnd.ms-fontobject",
        sfnt: "application/font-sfnt",
        svg: "image/svg+xml"
    };
    var isElement = function isElement(obj) {
        return obj instanceof HTMLElement || obj instanceof SVGElement;
    };
    var requireDomNode = function requireDomNode(el) {
        if (!isElement(el)) throw new Error("an HTMLElement or SVGElement is required; got " + el);
    };
    var isExternal = function isExternal(url) {
        return url && url.lastIndexOf("http", 0) === 0 && url.lastIndexOf(window.location.host) === -1;
    };
    var getFontMimeTypeFromUrl = function getFontMimeTypeFromUrl(fontUrl) {
        var formats = Object.keys(fontFormats).filter(function(extension) {
            return fontUrl.indexOf("." + extension) > 0;
        }).map(function(extension) {
            return fontFormats[extension];
        });
        if (formats) return formats[0];
        console.error("Unknown font format for " + fontUrl + ". Fonts may not be working correctly.");
        return "application/octet-stream";
    };
    var arrayBufferToBase64 = function arrayBufferToBase64(buffer) {
        var binary = "";
        var bytes = new Uint8Array(buffer);
        for (var i = 0; i < bytes.byteLength; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return window.btoa(binary);
    };
    var getDimension = function getDimension(el, clone, dim) {
        var v = el.viewBox && el.viewBox.baseVal && el.viewBox.baseVal[dim] || clone.getAttribute(dim) !== null && !clone.getAttribute(dim).match(/%$/) && parseInt(clone.getAttribute(dim)) || el.getBoundingClientRect()[dim] || parseInt(clone.style[dim]) || parseInt(window.getComputedStyle(el).getPropertyValue(dim));
        return typeof v === "undefined" || v === null || isNaN(parseFloat(v)) ? 0 : v;
    };
    var getDimensions = function getDimensions(el, clone, width, height) {
        if (el.tagName === "svg") return {
            width: width || getDimension(el, clone, "width"),
            height: height || getDimension(el, clone, "height")
        }; else if (el.getBBox) {
            var _el$getBBox = el.getBBox(), x = _el$getBBox.x, y = _el$getBBox.y, _width = _el$getBBox.width, _height = _el$getBBox.height;
            return {
                width: x + _width,
                height: y + _height
            };
        }
    };
    var reEncode = function reEncode(data) {
        return decodeURIComponent(encodeURIComponent(data).replace(/%([0-9A-F]{2})/g, function(match, p1) {
            var c = String.fromCharCode("0x" + p1);
            return c === "%" ? "%25" : c;
        }));
    };
    var uriToBlob = function uriToBlob(uri) {
        var byteString = window.atob(uri.split(",")[1]);
        var mimeString = uri.split(",")[0].split(":")[1].split(";")[0];
        var buffer = new ArrayBuffer(byteString.length);
        var intArray = new Uint8Array(buffer);
        for (var i = 0; i < byteString.length; i++) {
            intArray[i] = byteString.charCodeAt(i);
        }
        return new Blob([ buffer ], {
            type: mimeString
        });
    };
    var query = function query(el, selector) {
        if (!selector) return;
        try {
            return el.querySelector(selector) || el.parentNode && el.parentNode.querySelector(selector);
        } catch (err) {
            console.warn('Invalid CSS selector "' + selector + '"', err);
        }
    };
    var detectCssFont = function detectCssFont(rule, href) {
        var match = rule.cssText.match(urlRegex);
        var url = match && match[1] || "";
        if (!url || url.match(/^data:/) || url === "about:blank") return;
        var fullUrl = url.startsWith("../") ? href + "/../" + url : url.startsWith("./") ? href + "/." + url : url;
        return {
            text: rule.cssText,
            format: getFontMimeTypeFromUrl(fullUrl),
            url: fullUrl
        };
    };
    var inlineImages = function inlineImages(el) {
        return Promise.all(Array.from(el.querySelectorAll("image")).map(function(image) {
            var href = image.getAttributeNS("http://www.w3.org/1999/xlink", "href") || image.getAttribute("href");
            if (!href) return Promise.resolve(null);
            if (isExternal(href)) {
                href += (href.indexOf("?") === -1 ? "?" : "&") + "t=" + new Date().valueOf();
            }
            return new Promise(function(resolve, reject) {
                var canvas = document.createElement("canvas");
                var img = new Image();
                img.crossOrigin = "anonymous";
                img.src = href;
                img.onerror = function() {
                    return reject(new Error("Could not load " + href));
                };
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    canvas.getContext("2d").drawImage(img, 0, 0);
                    image.setAttributeNS("http://www.w3.org/1999/xlink", "href", canvas.toDataURL("image/png"));
                    resolve(true);
                };
            });
        }));
    };
    var cachedFonts = {};
    var inlineFonts = function inlineFonts(fonts) {
        return Promise.all(fonts.map(function(font) {
            return new Promise(function(resolve, reject) {
                if (cachedFonts[font.url]) return resolve(cachedFonts[font.url]);
                var req = new XMLHttpRequest();
                req.addEventListener("load", function() {
                    var fontInBase64 = arrayBufferToBase64(req.response);
                    var fontUri = font.text.replace(urlRegex, 'url("data:' + font.format + ";base64," + fontInBase64 + '")') + "\n";
                    cachedFonts[font.url] = fontUri;
                    resolve(fontUri);
                });
                req.addEventListener("error", function(e) {
                    console.warn("Failed to load font from: " + font.url, e);
                    cachedFonts[font.url] = null;
                    resolve(null);
                });
                req.addEventListener("abort", function(e) {
                    console.warn("Aborted loading font from: " + font.url, e);
                    resolve(null);
                });
                req.open("GET", font.url);
                req.responseType = "arraybuffer";
                req.send();
            });
        })).then(function(fontCss) {
            return fontCss.filter(function(x) {
                return x;
            }).join("");
        });
    };
    var cachedRules = null;
    var styleSheetRules = function styleSheetRules() {
        if (cachedRules) return cachedRules;
        return cachedRules = Array.from(document.styleSheets).map(function(sheet) {
            try {
                return {
                    rules: sheet.cssRules,
                    href: sheet.href
                };
            } catch (e) {
                console.warn("Stylesheet could not be loaded: " + sheet.href, e);
                return {};
            }
        });
    };
    var inlineCss = function inlineCss(el, options) {
        var _ref = options || {}, selectorRemap = _ref.selectorRemap, modifyStyle = _ref.modifyStyle, modifyCss = _ref.modifyCss, fonts = _ref.fonts;
        var generateCss = modifyCss || function(selector, properties) {
            var sel = selectorRemap ? selectorRemap(selector) : selector;
            var props = modifyStyle ? modifyStyle(properties) : properties;
            return sel + "{" + props + "}\n";
        };
        var css = [];
        var detectFonts = typeof fonts === "undefined";
        var fontList = fonts || [];
        styleSheetRules().forEach(function(_ref2) {
            var rules = _ref2.rules, href = _ref2.href;
            if (!rules) return;
            Array.from(rules).forEach(function(rule) {
                if (typeof rule.style != "undefined") {
                    if (query(el, rule.selectorText)) css.push(generateCss(rule.selectorText, rule.style.cssText)); else if (detectFonts && rule.cssText.match(/^@font-face/)) {
                        var font = detectCssFont(rule, href);
                        if (font) fontList.push(font);
                    } else css.push(rule.cssText);
                }
            });
        });
        return inlineFonts(fontList).then(function(fontCss) {
            return css.join("\n") + fontCss;
        });
    };
    out$.prepareSvg = function(el, options, done) {
        requireDomNode(el);
        var _ref3 = options || {}, _ref3$left = _ref3.left, left = _ref3$left === undefined ? 0 : _ref3$left, _ref3$top = _ref3.top, top = _ref3$top === undefined ? 0 : _ref3$top, w = _ref3.width, h = _ref3.height, _ref3$scale = _ref3.scale, scale = _ref3$scale === undefined ? 1 : _ref3$scale, _ref3$responsive = _ref3.responsive, responsive = _ref3$responsive === undefined ? false : _ref3$responsive;
        return inlineImages(el).then(function() {
            var clone = el.cloneNode(true);
            var _ref4 = options || {}, _ref4$backgroundColor = _ref4.backgroundColor, backgroundColor = _ref4$backgroundColor === undefined ? "transparent" : _ref4$backgroundColor;
            clone.style.backgroundColor = backgroundColor;
            var _getDimensions = getDimensions(el, clone, w, h), width = _getDimensions.width, height = _getDimensions.height;
            if (el.tagName !== "svg") {
                if (el.getBBox) {
                    clone.setAttribute("transform", clone.getAttribute("transform").replace(/translate\(.*?\)/, ""));
                    var svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                    svg.appendChild(clone);
                    clone = svg;
                } else {
                    console.error("Attempted to render non-SVG element", el);
                    return;
                }
            }
            clone.setAttribute("version", "1.1");
            clone.setAttribute("viewBox", [ left, top, width, height ].join(" "));
            if (!clone.getAttribute("xmlns")) clone.setAttributeNS(xmlns, "xmlns", "http://www.w3.org/2000/svg");
            if (!clone.getAttribute("xmlns:xlink")) clone.setAttributeNS(xmlns, "xmlns:xlink", "http://www.w3.org/1999/xlink");
            if (responsive) {
                clone.removeAttribute("width");
                clone.removeAttribute("height");
                clone.setAttribute("preserveAspectRatio", "xMinYMin meet");
            } else {
                clone.setAttribute("width", width * scale);
                clone.setAttribute("height", height * scale);
            }
            Array.from(clone.querySelectorAll("foreignObject > *")).forEach(function(foreignObject) {
                if (!foreignObject.getAttribute("xmlns")) foreignObject.setAttributeNS(xmlns, "xmlns", "http://www.w3.org/1999/xhtml");
            });
            return inlineCss(el, options).then(function(css) {
                var style = document.createElement("style");
                style.setAttribute("type", "text/css");
                style.innerHTML = "<![CDATA[\n" + css + "\n]]>";
                var defs = document.createElement("defs");
                defs.appendChild(style);
                clone.insertBefore(defs, clone.firstChild);
                var outer = document.createElement("div");
                outer.appendChild(clone);
                var src = outer.innerHTML.replace(/NS\d+:href/gi, 'xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href');
                if (typeof done === "function") done(src, width, height); else return {
                    src: src,
                    width: width,
                    height: height
                };
            });
        });
    };
    out$.svgAsDataUri = function(el, options, done) {
        requireDomNode(el);
        var result = out$.prepareSvg(el, options).then(function(_ref5) {
            var src = _ref5.src, width = _ref5.width, height = _ref5.height;
            var svgXml = "data:image/svg+xml;base64," + window.btoa(reEncode(doctype + src));
            if (typeof done === "function") {
                done(svgXml, width, height);
            }
            return svgXml;
        });
        return result;
    };
    out$.svgAsPngUri = function(el, options, done) {
        requireDomNode(el);
        var _ref6 = options || {}, _ref6$encoderType = _ref6.encoderType, encoderType = _ref6$encoderType === undefined ? "image/png" : _ref6$encoderType, _ref6$encoderOptions = _ref6.encoderOptions, encoderOptions = _ref6$encoderOptions === undefined ? .8 : _ref6$encoderOptions, canvg = _ref6.canvg;
        var convertToPng = function convertToPng(_ref7) {
            var src = _ref7.src, width = _ref7.width, height = _ref7.height;
            var canvas = document.createElement("canvas");
            var context = canvas.getContext("2d");
            var pixelRatio = window.devicePixelRatio || 1;
            canvas.width = width * pixelRatio;
            canvas.height = height * pixelRatio;
            canvas.style.width = canvas.width + "px";
            canvas.style.height = canvas.height + "px";
            context.setTransform(pixelRatio, 0, 0, pixelRatio, 0, 0);
            if (canvg) canvg(canvas, src); else context.drawImage(src, 0, 0);
            var png = void 0;
            try {
                png = canvas.toDataURL(encoderType, encoderOptions);
            } catch (e) {
                if (typeof SecurityError !== "undefined" && e instanceof SecurityError || e.name === "SecurityError") {
                    console.error("Rendered SVG images cannot be downloaded in this browser.");
                    return;
                } else throw e;
            }
            if (typeof done === "function") done(png, canvas.width, canvas.height);
            return Promise.resolve(png);
        };
        if (canvg) return out$.prepareSvg(el, options).then(convertToPng); else return out$.svgAsDataUri(el, options).then(function(uri) {
            return new Promise(function(resolve, reject) {
                var image = new Image();
                image.onload = function() {
                    return resolve(convertToPng({
                        src: image,
                        width: image.width,
                        height: image.height
                    }));
                };
                image.onerror = function() {
                    reject("There was an error loading the data URI as an image on the following SVG\n" + window.atob(uri.slice(26)) + "Open the following link to see browser's diagnosis\n" + uri);
                };
                image.src = uri;
            });
        });
    };
    out$.download = function(name, uri) {
        if (navigator.msSaveOrOpenBlob) navigator.msSaveOrOpenBlob(uriToBlob(uri), name); else {
            var saveLink = document.createElement("a");
            if ("download" in saveLink) {
                saveLink.download = name;
                saveLink.style.display = "none";
                document.body.appendChild(saveLink);
                try {
                    var blob = uriToBlob(uri);
                    var url = URL.createObjectURL(blob);
                    saveLink.href = url;
                    saveLink.onclick = function() {
                        return requestAnimationFrame(function() {
                            return URL.revokeObjectURL(url);
                        });
                    };
                } catch (e) {
                    console.warn("This browser does not support object URLs. Falling back to string URL.");
                    saveLink.href = uri;
                }
                saveLink.click();
                document.body.removeChild(saveLink);
            } else {
                window.open(uri, "_temp", "menubar=no,toolbar=no,status=no");
            }
        }
    };
    out$.saveSvg = function(el, name, options) {
        requireDomNode(el);
        out$.svgAsDataUri(el, options || {}, function(uri) {
            return out$.download(name, uri);
        });
    };
    out$.saveSvgAsPng = function(el, name, options) {
        requireDomNode(el);
        out$.svgAsPngUri(el, options || {}, function(uri) {
            return out$.download(name, uri);
        });
    };
})();

app.chartCommons.exportPng = {
    svgString2Image: function(svgString, width, height, format, callback) {
        var format = format ? format : "png";
        var canvas = document.createElement("canvas");
        var context = canvas.getContext("2d");
        canvas.width = width;
        canvas.height = height;
        var r = $('<div class="bar-chart"><img /></div>');
        var image = r.find("img").get(0);
        image.onload = function() {
            context.clearRect(0, 0, width, height);
            context.drawImage(image, 0, 0, width, height);
            canvas.toBlob(function(blob) {
                var filesize = Math.round(blob.length / 1024) + " KB";
                if (callback) callback(blob, filesize);
            });
        };
        image.src = svgString;
    },
    getSVGString: function(svgNode) {
        var doctype = '<?xml version="1.0" standalone="no"?>' + '<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">';
        var source = new XMLSerializer().serializeToString(svgNode);
        var blob = new Blob([ doctype + source ], {
            type: "image/svg+xml;charset=utf-8"
        });
        var url = window.URL.createObjectURL(blob);
        return url;
        svgNode.setAttribute("xlink", "http://www.w3.org/1999/xlink");
        var cssStyleText = getCSSStyles(svgNode);
        appendCSS(cssStyleText, svgNode);
        var serializer = new XMLSerializer();
        var svgString = serializer.serializeToString(svgNode);
        svgString = svgString.replace(/(\w+)?:?xlink=/g, "xmlns:xlink=");
        svgString = svgString.replace(/NS\d+:href/g, "xlink:href");
        return svgString;
        return "<div class='bar-chart'>" + svgString + "</div>";
        function getCSSStyles(parentElement) {
            var selectorTextArr = [];
            selectorTextArr.push("#" + parentElement.id);
            for (var c = 0; c < parentElement.classList.length; c++) if (!contains("." + parentElement.classList[c], selectorTextArr)) selectorTextArr.push("." + parentElement.classList[c]);
            var nodes = parentElement.getElementsByTagName("*");
            for (var i = 0; i < nodes.length; i++) {
                var id = nodes[i].id;
                if (!contains("#" + id, selectorTextArr)) selectorTextArr.push("#" + id);
                var classes = nodes[i].classList;
                for (var c = 0; c < classes.length; c++) if (!contains("." + classes[c], selectorTextArr)) selectorTextArr.push("." + classes[c]);
            }
            var extractedCSSText = "";
            for (var i = 0; i < document.styleSheets.length; i++) {
                var s = document.styleSheets[i];
                try {
                    if (!s.cssRules) continue;
                } catch (e) {
                    if (e.name !== "SecurityError") throw e;
                    continue;
                }
                var cssRules = s.cssRules;
                for (var r = 0; r < cssRules.length; r++) {
                    if (contains(cssRules[r].selectorText, selectorTextArr)) extractedCSSText += cssRules[r].cssText;
                }
            }
            return extractedCSSText;
            function contains(str, arr) {
                return arr.indexOf(str) === -1 ? false : true;
            }
        }
        function appendCSS(cssText, element) {
            var styleElement = document.createElement("style");
            styleElement.setAttribute("type", "text/css");
            styleElement.innerHTML = cssText;
            var refNode = element.hasChildNodes() ? element.children[0] : null;
            element.insertBefore(styleElement, refNode);
        }
    }
};

function prepareData(input, props) {
    var data = [];
    var matrix = input.matrix || [];
    for (var i = 0; i < input.matrix.length; i++) {
        var item = {};
        item.index = i;
        item.label = input.matrix[i].captions;
        item.onClickVal = input.matrix[i].canDrill ? input.matrix[i].values : "";
        item.canDrill = input.matrix[i].canDrill;
        item.value = input.matrix[i].values;
        item.kpis = input.kpis.data[i];
        item.series = input.series.data[i];
        var temp = [];
        if (item.kpis) for (var j = 0; j < item.kpis.length; j++) {
            var datum = [];
            for (var k = 0; k < item.kpis[j].length; k++) {
                if (item.kpis[j][k] === "") datum.push(item.kpis[j][k]); else datum.push(parseFloat(item.kpis[j][k]) || 0);
            }
            temp.push(datum);
        }
        item.kpis = temp;
        temp = [];
        for (var j = 0; j < item.series.length; j++) {
            if (item.series[j] === "" || item.series[j] === null || isNaN(item.series[j])) temp.push(item.series[j]); else temp.push(parseFloat(item.series[j]) || 0);
        }
        item.series = temp;
        data.push(item);
    }
    return data;
}

function persian(s, showPersian) {
    if (s == null) return s;
    if (typeof showPersian == "undefined") {
        showPersian = app.lang.isRtl();
    }
    if (!showPersian) return s;
    var reps = {
        0: "۰",
        1: "۱",
        2: "۲",
        3: "۳",
        4: "۴",
        5: "۵",
        6: "۶",
        7: "۷",
        8: "۸",
        9: "۹"
    };
    s = s + "";
    return s.replace(/(\d)/g, function(s, key) {
        return reps[key] || s;
    });
}

function depersian(s) {
    var reps = {
        "۰": 0,
        "۱": 1,
        "۲": 2,
        "۳": 3,
        "۴": 4,
        "۵": 5,
        "۶": 6,
        "۷": 7,
        "۸": 8,
        "۹": 9
    };
    s = s + "";
    return s.replace(/([۰۱۲۳۴۵۶۷۸۹])/g, function(s, key) {
        return typeof reps[key] != "undefined" ? reps[key] : s;
    });
}

function normilize(s) {
    var reps = {
        "ي": "ی",
        "إ": "ا",
        "ؤ": "و",
        "أ": "ا",
        "آ": "ا",
        "ک": "ك"
    };
    s = s + "";
    return s.replace(/(.)/g, function(s, key) {
        return reps[key] || s;
    });
}

d3.selection.prototype.settingsIcon = function(option) {
    return;
    option.CanExportXlsx = /true/gi.test(option.CanExportXlsx);
    if (!option.deleteLink) option.deleteLink = "#";
    if (!option.editLink) option.editLink = "#";
    var obj = $(this._groups[0][0]);
    obj.append('<span  class="glyphicon glyphicon-link close small-icon" style="margin-right: 5px;"> </span>');
    obj.addClass("over-show");
    if (option.RemoveFromPage || option.EditPermission || option.CanExportXlsx) {
        obj.append('<div class="ui mini dropdown icon circular left floated " ng-click="$event.stopPropagation();">                    <i class="settings icon"></i>                    <div class=" menu transition hidden" tabindex="-1">                      ' + (option.EditPermission ? ' <div class="item" ><a href="' + option.editLink + '"><span class="glyphicon glyphicon-pencil gray"/> <span data-trans-key="ویرایش" > </span></a></div>' : "") + "                      " + (option.EditPermission ? ' <div class="item" ><a class="clone-chart"><span class="glyphicon glyphicon-duplicate gray"/> <span data-trans-key="تکرار" > </span> </a></div>' : "") + "                      " + (option.RemoveFromPage ? ' <div class="item" ><a href="' + option.deleteLink + '"><span class="glyphicon glyphicon-trash gray"/> <span data-trans-key="حذف نمودار از صفحه" > </span></a></div>' : "") + "                      " + (option.CanExportXlsx ? '  <div class="item" ><a class="export-excel"><span class="glyphicon glyphicon-export gray"/> <span data-trans-key="خروجی اکسل" > </span></a></div>' : "") + '                       <div><a class="item export-print"><span class="glyphicon glyphicon-print gray"/> <span data-trans-key="print" > </span></a></div>                 </div>                </div>');
        obj.find(".export-excel").on("click", function() {
            if (option.onExportXlsx) option.onExportXlsx();
        });
        obj.find(".export-print").on("click", function() {
            app.print.printSingle("#" + option.settings.id, option.title);
        });
        obj.find(".clone-chart").on("click", function() {
            app.post(app.urlPrefix + "Moderation/Charts/CloneChart", {
                Id: option.chartId,
                PageId: dashboard.pageId
            }, function(data) {
                if (data.result && data.insertedId) {
                    var id = data.insertedId;
                    var link = app.urlPrefix + "charts/DashboardPage/getChartDetails";
                    app.post(link, {
                        chartId: id
                    }, function(data2) {
                        data2.pageId = data.chartInPageId;
                        dashboard.charts.push(data2);
                        dashboard.addChart(data2, null, false);
                        $("html, body").animate({
                            scrollTop: $(document).height() - $(window).height()
                        }, 1e3);
                    });
                }
            });
        });
    }
    var addedBefore = 0;
    function changeHieght(e) {}
    var hasDesc = typeof option.desc != "undefined" && option.desc != null && option.desc != "";
    var hasLastRefresh = typeof option.LastRefresh != "undefined" && option.LastRefresh != null;
    if ((hasDesc || hasLastRefresh) && option.CanExportXlsx) {
        obj.append('<span class="btn-group pull-right " >                 <span  type="button"  class="glyphicon glyphicon-info-sign close small-icon dropdown-toggle show-node left-margin" style="' + (option.isFresh ? "" : "color:red") + '"> </span>            </span>');
        obj.find(".glyphicon-info-sign").on("click", function() {
            obj.find(".desc").slideToggle({
                easing: "linear",
                duration: 200
            });
        });
    }
    var dateFormat = function(date) {
        if (app.lang.langType != 0) {
            return date.D + "/" + date.M + "/" + date.Y + " - " + date.h + ":" + date.m + ":" + date.s + " ";
        }
        var dif = "";
        if (date.Diff) {
            if (date.Diff < 60 * 60 * 24) {
                dif += " - <b>";
                dif += date.Diff < 60 ? Math.floor(date.Diff) + " ثانیه پیش" : date.Diff < 60 * 60 ? Math.floor(date.Diff / 60) + " دقیقه پیش" : Math.floor(date.Diff / (60 * 60)) + " ساعت پیش";
                dif += "</b>";
            }
        }
        var monthName = +date.M == 1 ? "فروردین" : +date.M == 2 ? "اردیبهشت" : +date.M == 3 ? "خرداد" : +date.M == 4 ? "تیر" : +date.M == 5 ? "مرداد" : +date.M == 6 ? "شهریور" : +date.M == 7 ? "مهر" : +date.M == 8 ? "آبان" : +date.M == 9 ? "آذر" : +date.M == 10 ? "دی" : +date.M == 11 ? "بهمن" : "اسفند";
        return persian(date.D + " " + monthName + " ماه " + date.Y + " ساعت " + date.h + ":" + date.m + ":" + date.s + " " + dif, true);
    };
    option.title += "&nbsp;";
    var desc = app.lang.translate("desc");
    var lastUpdate = app.lang.translate("lastUpdate");
    obj.append("            " + (option.showFilterIcon <= 0 ? "" : '<span class="btn-group pull-right " >                 <span  type="button"  class="glyphicon glyphicon-filter close small-icon dropdown-toggle show-node left-margin" > </span>            </span>') + '            <span class="myprogress pull-right" style="visibility:hidden"><img width="18px" height="18px" src="' + app.urlPrefix + 'Images/progress.gif"/></span>              <div class="title-move" style="cursor:move; margin-bottom:3px; margin-top:3px;">' + persian(option.title) + '</div>             <div class="desc" style="z-index:100;width:100%; right:0;display:none; padding: 10px; position: absolute; text-align: justify;">                   <div style=" padding:0;border: 0 none;">' + (!hasDesc ? "" : '<div style="margin-bottom:10px"><b style="border-bottomx: 1px solid #C0C0C0;display: xblock;padding-bottom: 5px;">' + desc + ": </b>" + (option.desc != null ? option.desc.replace(/(\r\n|\n|\r)/gm, "<br/>") : "") + "</div>") + (!hasLastRefresh ? "" : '<div style="font-size:0.8em"><b style="border-bottomx: 1px solid #C0C0C0;padding-bottom: 5px;">' + lastUpdate + ": </b>" + dateFormat(option.LastRefresh) + "</div>") + '</div>             </div>             <div  class="clear filter " style="z-index:20;margin:0 -7px; display:none; position:absolute; width:100%; height:' + ($("#" + option.settings.id).height() - $("#" + option.settings.id + " .title").height() - 20) + 'px; overflow:auto" ></div>');
    var settings = option.settings;
    obj.find(".glyphicon-link").on("click", function() {
        if (typeof settings == "undefined" || typeof settings.link == "undefined") settings.link = "hide"; else settings.link = settings.link == "show" ? "bold" : "show";
        if ($(this).hasClass("link")) $(this).removeClass("link"); else $(this).addClass("link");
    });
    if (typeof settings == "undefined" || typeof settings.link == "undefined" || option.settings.link == "hide") {
        obj.find(".glyphicon-link").hide();
    } else {
        if (option.settings.link == "show") obj.find(".glyphicon-link").removeClass("link"); else obj.find(".glyphicon-link").addClass("link");
    }
    obj.find(".clear.filter").on("click", function() {
        obj.find(".filter").slideToggle({
            done: function(ui, item) {
                app.lang.setLang({
                    selector: obj.find(".filter").selector
                });
            },
            start: function(e) {}
        });
    });
    obj.find(".glyphicon-filter").on("click", function() {
        var filter = obj.find(".filter");
        if (filter.html() == "") {
            filter.html('<div style="padding:3px"><img style="width: 1.3em" src="' + app.urlPrefix + 'Images/progress.gif" /><span  data-trans-key="در حال بارگذاری..."></span></div>');
            $.ajax(app.urlPrefix + "Charts/BarChart/GetChart?Id=" + option.chartId + "&ChartInPageId=" + option.ChartInPageId).done(function(data) {
                filter.data("data", data);
                var hierarchyHtml = null, ProvisionHtml = null, SeriesLevelHtml = null;
                function convertToUl(data, index) {
                    if (data != null) {
                        return "<ul class='sortable list-unstyled pointer' index='" + index + "'>" + data.map(function(item, i) {
                            if (!item.ShowFilter) {
                                return '<li value="' + item.Uniquename + '"> ' + item.Caption + "</li>";
                            }
                            return '<li value="' + item.Uniquename + '">  ' + item.Caption + '<span class="glyphicon glyphicon-filter icon-btn filter-member-dialog" style="float:left; margin-right:5px;"></span></li>';
                        }).join("") + "</ul>";
                    }
                    return "";
                }
                hierarchyHtml = convertToUl(data.Hierarchies, "Hierarchies");
                ProvisionHtml = convertToUl(data.Where, "Where");
                SeriesLevelHtml = convertToUl(data.SeriesLevel, "SeriesLevel");
                var table = '<table class="table chart-design" style="position:absolute;margin-bottom:0px; background-color:#fff;display:none; border-bottom:1px solid silver">                                         <tr class="active">                                             <th style="' + (SeriesLevelHtml == "" ? "display:none" : "") + '"><span data-trans-key="شاخص‌ها (ستون‌های عددی)" > </span> </th>                                             <th style="' + (hierarchyHtml == "" ? "display:none" : "") + '"><span data-trans-key="ابعاد (ستون‌های رشته‌ای)" > </span> </th>                                             <th style="' + (ProvisionHtml == "" ? "display:none" : "") + '"><span data-trans-key="شرط" > </span></th>                                         </tr>                                         <tr>                                             <td  style="' + (SeriesLevelHtml == "" ? "display:none" : "") + '"id="div-x" class="myc">' + SeriesLevelHtml + '</td>                                             <td  style="' + (hierarchyHtml == "" ? "display:none" : "") + '"id="div-y" class="myc">' + hierarchyHtml + '</td>                                             <td  style="' + (ProvisionHtml == "" ? "display:none" : "") + '"id="div-where" class="myc">' + ProvisionHtml + "</td>                                         </tr>                                     </table>";
                table = '<div style="position:relative; height:100%;"><div class="close-filter pointer" style="position:absolute; height:100%; width:100%;background-color:rgba(66, 66, 66, 0.368627); "></div>' + table + "</div>";
                filter.html(filterXSS(table));
                filter.find("table.chart-design").slideToggle({
                    done: function() {},
                    start: function(e) {
                        var end = e.tweens.filter(function(d) {
                            return d.prop == "height";
                        })[0].end;
                        changeHieght({
                            filter: end
                        });
                    }
                });
                filter.find(".close-filter").on("click", function() {});
                function onChange() {
                    function sortDataHierarchies(data, index) {
                        var array = data[index];
                        var newAr = [];
                        filter.find("ul[index=" + index + "] li").each(function(i, d) {
                            var Uniquename = $(this).attr("value");
                            var item = $.grep(array, function(d) {
                                return d.Uniquename == Uniquename;
                            })[0];
                            item.Members = $(this).data("members");
                            newAr.push(item);
                        });
                        data[index] = newAr;
                    }
                    sortDataHierarchies(data, "Hierarchies");
                    sortDataHierarchies(data, "Where");
                    sortDataHierarchies(data, "SeriesLevel");
                    option.onFilterChange(data);
                }
                filter.find(".filter-member-dialog").on("click", function() {
                    var el = $(this).parent();
                    var Uniquename = $(this).parent().attr("value");
                    var array = data[$(this).closest("ul").attr("index")];
                    var element = $.grep(array, function(d, i) {
                        return d.Uniquename == Uniquename;
                    })[0];
                    var members = $(this).parent().data("members");
                    var link = app.urlPrefix + "Charts/BarChart/GetMemberOfFilterHierarchy?Uniquename=" + Uniquename + "&Id=" + option.chartId + "&ChartInPageId=" + option.ChartInPageId;
                    if (typeof members == "undefined") {
                        $.ajax(link).done(function(d) {
                            $(this).parent().data("members", d);
                            showDialog(d, link);
                        });
                    } else {
                        showDialog(members, link);
                    }
                    function showDialog(members, link) {
                        app.helper.filterMemberDialog(members, link, function(mem) {
                            el.data("members", mem);
                            onChange();
                        });
                    }
                });
                filter.find(".sortable").sortable({
                    start: function(e, ui) {
                        ui.placeholder.addClass("filter-placeholder");
                        ui.placeholder.height(ui.item.height());
                        ui.placeholder.width(ui.item.width());
                        ui.placeholder.parent().width(ui.item.width());
                        ui.placeholder.parent().parent().width(ui.item.width());
                    },
                    stop: function(e, ui) {
                        onChange();
                    }
                });
            });
        }
        filter.slideToggle({
            done: function(ui, item) {
                app.lang.setLang({
                    selector: filter.selector
                });
            },
            start: function(e) {}
        });
    });
    if (!option.RemoveFromPage) obj.find(".title-move").css("cursor", "auto");
    return this;
};

d3.selection.prototype.legend = function(option, showPersian) {
    option.order = option.order || "horizental";
    option.colorPos = option.colorPos || "left";
    option.font = option.font || {};
    option.click = option.click || function() {};
    var divPad = 15;
    var st = {
        "top right": {
            "text-align": "right"
        },
        "top left": {
            "text-align": "left"
        },
        "top center": {
            "text-align": "center"
        },
        "bottom right": {
            "text-align": "right"
        },
        "bottom left": {
            "text-align": "left"
        },
        "bottom center": {
            "text-align": "center"
        },
        "center right": {
            "text-align": "right"
        },
        "center left": {
            "text-align": "right"
        }
    };
    var className = {
        "top right": "legend-top-right",
        "top left": "legend-top-left",
        "top center": "legend-top-center",
        "bottom right": "legend-bottom-right",
        "bottom left": "legend-bottom-left",
        "bottom center": "legend-bottom-center",
        "center right": "legend-center-right",
        "center left": "legend-center-left"
    };
    option.position = option.position || "top left";
    var style = {};
    var ul = this.append("div").attr("class", "legend-div temporal ").append("div").attr("class", "list-inline " + className[option.position]).styles(style);
    var items = ul.selectAll("nothingd").data(option.data).enter().append("span").style("font-size", option.font.fontSize || "9px").style("font-family", option.font.fontName || "IRANSans").style("font-weight", option.font.bold ? "bold" : "300" || "300").style("font-style", option.font.italic ? "italic" : "inherit" || "inherit").style("color", option.font.color || "#333333").attr("class", "pointer legend-item").on("click", function(d, i) {
        if (option.selector) {
            $(option.selector).trigger("legendClick", [ d.label, i, d ]);
        }
        option.click(d, i);
    });
    items.append("span").classed("text", true).text(function(d) {
        return persian(d.label, showPersian);
    });
    if (option.order === "vertical") {
        items.style("display", "block");
    }
    var colorItem;
    if (option.colorPos === "left") {
        colorItem = items.append("span");
    } else {
        colorItem = items.insert("span", ".text");
        items.style("text-align", "right");
    }
    colorItem.attr("class", "legend-color").style("background-color", function(d) {
        return d.color;
    }).style("-webkit-print-color-adjust", "exact");
    return ul;
};

d3.selection.prototype.breadcrumb = function(levels, settings, titlebar, showPersian) {
    var s = levels.slice(0);
    if (typeof s[0] !== "undefined" && s[0] !== null) {
        s.unshift(app.lang.translate("پاک کردن"));
    }
    var last = s[s.length - 1];
    s.splice(s.length - 1, 1);
    if (s.length > 0) {
        var callback = function(d, i) {
            var isFromCommentDialog = $("#" + settings.id).hasClass("fromCommentDialog");
            if (isFromCommentDialog) {
                return;
            }
            var isProgress = titlebar.isProgress;
            var showProgress = titlebar.showProgress;
            if (isProgress()) return;
            showProgress(true);
            var chartFilter = app.chartCommons.drillDown.up(settings.ChartInPageId, s.length - i);
            settings.parameters = {
                drillDown: chartFilter,
                isUp: true,
                upLevel: s.length - i,
                chartId: settings.chartId,
                ChartInPageId: settings.ChartInPageId
            };
            settings.drill = "up";
            app.chartCommons.levelTypeUtils.getParam(settings);
            $("#" + settings.id).charts(settings.type, "refreshWithData", settings);
        };
        var html = '<div class="ui mini breadcrumb floated right temporal">' + s.map(function(d) {
            return '<a class="section clickable">' + d + "</a>";
        }).join('<i class="' + (app.lang.isRtl() ? "left" : "right") + ' arrow icon divider"></i>') + '<i class="' + (app.lang.isRtl() ? "left" : "right") + ' arrow icon divider"></i><div class="section active">' + last + "</div></div>";
        $(this._groups[0][0]).append(html);
        $(this._groups[0][0]).find(".breadcrumb .clickable").each(function(i, d) {
            $(this).on("click", function() {
                callback(0, i);
            });
        });
        return;
    }
};

d3.selection.prototype.titlebar = function(option) {
    var title;
    var el = this;
    var $el = $(el._groups[0][0]);
    var isProgress = function() {
        return $el.find(".myprogress").css("visibility") == "visible";
    };
    var progress = $el.parents(".ui.card").find(".progress-overall");
    var showProgress = function(b) {
        if (b) {
            $el.find("*").attr("disabled", true);
            $el.find(".myprogress").css("visibility", "visible");
            progress.fadeIn();
        } else {
            $el.find("*").attr("disabled", false);
            $el.find(".myprogress").css("visibility", "hidden");
            progress.fadeOut();
        }
    };
    return {
        title: title,
        showProgress: showProgress,
        isProgress: isProgress
    };
};

var d3Utils = {
    prepareDataForBarChart: function(data, settings, seriesLabels, kpisLabels, seriesLabelsCaptions, kpisLabelsCaptions) {
        var colors = d3.scaleOrdinal(d3.schemeCategory10);
        $.each(data, function(i, item) {
            if (!item.kpis) return true;
            var tmpKpi = [];
            $.each(item.kpis, function(ii, d) {
                var p = settings.chartProp.series[kpisLabels[ii]] || settings.chartProp.series["default"];
                var c = colors(ii);
                if (typeof p == "undefined" && typeof model != "undefined") {
                    p = $.extend(true, {}, typeof model.seriesProp[kpisLabels[ii]] != "undefined" ? model.seriesProp[kpisLabels[ii]] : model.seriesProp.default);
                    p.seriesColor = colors(ii);
                }
                tmpKpi.push({
                    data: d,
                    prop: p,
                    key: kpisLabels[ii],
                    label: kpisLabelsCaptions && kpisLabelsCaptions.length > ii ? kpisLabelsCaptions[ii] : kpisLabels[ii],
                    type: "kpi",
                    seriesLable: kpisLabelsCaptions && kpisLabelsCaptions.length > ii ? kpisLabelsCaptions[ii] : kpisLabels[ii],
                    type: "kpi",
                    seriesKey: kpisLabels[ii],
                    category: item.label
                });
            });
            if (!item.series) return true;
            $.each(item.series, function(ii, d) {
                var p = settings.chartProp.series[seriesLabels[ii]];
                var cnd = d === "" || d === null || isNaN(d);
                var ctmpChild = {
                    type: "series",
                    data: cnd ? d : d * parseFloat(p.numberFactor),
                    prop: p,
                    key: seriesLabels[ii],
                    label: seriesLabelsCaptions && seriesLabelsCaptions.length > ii ? seriesLabelsCaptions[ii] : seriesLabels[ii],
                    seriesLable: seriesLabelsCaptions && seriesLabelsCaptions.length > ii ? seriesLabelsCaptions[ii] : seriesLabels[ii],
                    seriesKey: seriesLabels[ii],
                    category: item.label
                };
                ctmpChild.commentCount = app.chartCommons.commentUtils.getCommentCount(settings.input.comment, ctmpChild.category, ctmpChild.label);
                tmpKpi.push(ctmpChild);
            });
            item.series = tmpKpi;
        });
    },
    convertToKeyValue: function(input) {
        var seriesLabels = _.map(input.series.labels, function(d, i) {
            var hasCaption = input.seriesLablesCaptions && input.seriesLablesCaptions.length > i;
            return {
                key: d,
                value: hasCaption ? input.seriesLablesCaptions[i] : d
            };
        });
        var kpiLabels = _.map(input.kpis.labels, function(d, i) {
            var hasCaption = input.kpisLablesCaptions && input.kpisLablesCaptions.length > i;
            return {
                key: d,
                value: hasCaption ? input.kpisLablesCaptions[i] : d
            };
        });
        return {
            seriesLabels: seriesLabels,
            kpiLabels: kpiLabels
        };
    }
};

var app = app || {};

app.helper = app.helper || {};

(function() {
    var badForm = [ "ي", "إ", "ؤ", "أ", "ي", "ك" ];
    var normalForm = [ "ی", "ا", "و", "ا", "ی", "ک" ];
    function normalize(q) {
        for (var i = 0; i < q.length; i++) {
            for (var j = 0; j < badForm.length; j++) {
                if (q.charAt(i) === badForm[j]) q = q.replace(q.charAt(i), normalForm[j]);
            }
        }
        return q;
    }
    app.helper.filterMemberDialogOk = function() {
        var obj = $("#filter-member-dialog").data("data");
        $("#filter-member-dialog .li ").each(function(i, item) {
            var input = $(this).find("input");
            var member = $.grep(obj.members, function(d) {
                return d.Uniquename == input.attr("value");
            })[0];
            member.IsChecked = input.prop("checked");
        });
        obj.onfinish(obj.members);
        $("#filter-member-dialog").modal("hide");
    };
    app.helper.filterMemberDialog = function(members, link, onfinish) {
        var callback = function(e) {
            var winHeight = window.innerHeight;
            var modelHeight = $("#filter-member-dialog").outerHeight();
            var ulHeight = winHeight - modelHeight - 50;
            body = '<div class="ui form"><input type="text" class="form-control" id="filter-member-search" placeholder="جستجو"></div>                    <input id="select-all-member-filter" type="checkbox" style="margin-top:10px"/><label style="margin-right:5px;" for="select-all-member-filter"> همه </label>                    <div class="member-list"></div>';
            var el = $("#filter-member-dialog #filter-member-dialog-content");
            el.html(body);
            $("#select-all-member-filter").change(function() {
                var isChecked = this.checked;
                $("#filter-member-dialog .member-list .li input").filter(function() {
                    return $(this).is(":visible");
                }).prop("checked", isChecked);
            });
            setMembers(ulHeight, members, el);
            var timeout;
            $("#filter-member-dialog #filter-member-search").keyup(function() {
                var query = $(this).val().toLowerCase();
                query = normalize(query);
                if (link) {
                    if (query && query.length == 1) return;
                    clearTimeout(timeout);
                    timeout = setTimeout(function() {
                        $.ajax(link + "&query=" + query).done(function(d) {
                            var obj = $("#filter-member-dialog").data("data");
                            obj.members = d;
                            setMembers(ulHeight, d, el);
                        });
                    }, 400);
                } else {
                    $("#filter-member-dialog li").show();
                    $("#filter-member-dialog li").filter(function() {
                        var val = $(this).text().toLowerCase();
                        val = normalize(val);
                        return val.indexOf(query.toLowerCase()) == -1;
                    }).hide();
                }
            });
        };
        $("#filter-member-dialog").modal({
            onVisible: callback
        }).modal("show");
        function setMembers(ulHeight, members, el) {
            var body = '<div class=" " style="height:50vh; overflow:auto;"> ' + members.map(function(item, i) {
                return '<div class="li"><input value="' + item.Uniquename + '" type="checkbox" id="member-' + i + '" ' + (item.IsChecked ? " checked " : "") + ' /> <label class="unstyled-lable" for="member-' + i + '">' + item.Caption + "</label></div>";
            }).join("") + "</div>";
            el.find(".member-list").html(body);
            $("#filter-member-dialog").modal("refresh");
        }
        $("#filter-member-dialog").data("data", {
            members: members,
            onfinish: onfinish
        });
        $("#filter-member-dialog").modal("show");
    };
})($);

(function($) {
    function maybeCall(thing, ctx) {
        return typeof thing == "function" ? thing.call(ctx) : thing;
    }
    function Tipsy(element, options) {
        this.$element = $(element);
        this.options = options;
        this.enabled = true;
        this.fixTitle();
    }
    Tipsy.prototype = {
        show: function() {
            var title = this.getTitle();
            if (title && this.enabled) {
                var $tip = this.tip();
                $tip.find(".tipsy-inner")[this.options.html ? "html" : "text"](title);
                $tip[0].className = "tipsy";
                $tip.remove().css({
                    top: 0,
                    left: 0,
                    visibility: "hidden",
                    display: "block"
                }).prependTo(document.body);
                var pos = $.extend({}, this.$element.offset(), {
                    width: this.$element[0].offsetWidth || 0,
                    height: this.$element[0].offsetHeight || 0
                });
                if (typeof this.$element[0].nearestViewportElement == "object") {
                    var el = this.$element[0];
                    var rect = el.getBoundingClientRect();
                    pos.width = rect.width;
                    pos.height = rect.height;
                }
                var actualWidth = $tip[0].offsetWidth, actualHeight = $tip[0].offsetHeight, gravity = maybeCall(this.options.gravity, this.$element[0]);
                var tp;
                switch (gravity.charAt(0)) {
                  case "n":
                    tp = {
                        top: pos.top + pos.height + this.options.offset,
                        left: pos.left + pos.width / 2 - actualWidth / 2
                    };
                    break;

                  case "s":
                    tp = {
                        top: pos.top - actualHeight - this.options.offset,
                        left: pos.left + pos.width / 2 - actualWidth / 2
                    };
                    break;

                  case "e":
                    tp = {
                        top: pos.top + pos.height / 2 - actualHeight / 2,
                        left: pos.left - actualWidth - this.options.offset
                    };
                    break;

                  case "w":
                    tp = {
                        top: pos.top + pos.height / 2 - actualHeight / 2,
                        left: pos.left + pos.width + this.options.offset
                    };
                    break;

                  case "c":
                    tp = {
                        top: pos.top + pos.height / 2 - actualHeight / 2,
                        left: pos.left + pos.width / 2 - actualWidth / 2
                    };
                    break;
                }
                if (gravity.length == 2) {
                    if (gravity.charAt(1) == "w") {
                        tp.left = pos.left + pos.width / 2 - 15;
                    } else {
                        tp.left = pos.left + pos.width / 2 - actualWidth + 15;
                    }
                }
                $tip.css(tp).addClass("tipsy-" + gravity);
                $tip.find(".tipsy-arrow")[0].className = "tipsy-arrow tipsy-arrow-" + gravity.charAt(0);
                if (this.options.className) {
                    $tip.addClass(maybeCall(this.options.className, this.$element[0]));
                }
                if (this.options.fade) {
                    $tip.stop().css({
                        opacity: 0,
                        display: "block",
                        visibility: "visible"
                    }).animate({
                        opacity: this.options.opacity
                    });
                } else {
                    $tip.css({
                        visibility: "visible",
                        opacity: this.options.opacity
                    });
                }
                var t = this;
                var set_hovered = function(set_hover) {
                    return function() {
                        t.$tip.stop();
                        t.tipHovered = set_hover;
                        if (!set_hover) {
                            if (t.options.delayOut === 0) {
                                t.hide();
                            } else {
                                setTimeout(function() {
                                    if (t.hoverState == "out") t.hide();
                                }, t.options.delayOut);
                            }
                        }
                    };
                };
                $tip.hover(set_hovered(true), set_hovered(false));
            }
        },
        hide: function() {
            if (this.options.fade) {
                this.tip().stop().fadeOut(function() {
                    $(this).remove();
                });
            } else {
                this.tip().remove();
            }
        },
        fixTitle: function() {
            var $e = this.$element;
            if ($e.attr("title") || typeof $e.attr("original-title") != "string") {
                $e.attr("original-title", $e.attr("title") || "").removeAttr("title");
            }
            if (typeof $e.get(0).nearestViewportElement == "object") {
                if ($e.children("title").length) {
                    $e.append("<original-title>" + ($e.children("title").text() || "") + "</original-title>").children("title").remove();
                }
            }
        },
        getTitle: function() {
            var title, $e = this.$element, o = this.options;
            this.fixTitle();
            if (typeof o.title == "string") {
                var title_name = o.title == "title" ? "original-title" : o.title;
                if ($e.children(title_name).length) {
                    title = $e.children(title_name).html();
                } else {
                    title = $e.attr(title_name);
                }
            } else if (typeof o.title == "function") {
                title = o.title.call($e[0]);
            }
            title = ("" + title).replace(/(^\s*|\s*$)/, "");
            return title || o.fallback;
        },
        tip: function() {
            if (!this.$tip) {
                this.$tip = $('<div class="tipsy"></div>').html('<div class="tipsy-arrow"></div><div class="tipsy-inner"></div>');
            }
            return this.$tip;
        },
        validate: function() {
            if (!this.$element[0].parentNode) {
                this.hide();
                this.$element = null;
                this.options = null;
            }
        },
        enable: function() {
            this.enabled = true;
        },
        disable: function() {
            this.enabled = false;
        },
        toggleEnabled: function() {
            this.enabled = !this.enabled;
        }
    };
    $.fn.tipsy = function(options) {
        if (options === true) {
            return this.data("tipsy");
        } else if (typeof options == "string") {
            var tipsy = this.data("tipsy");
            if (tipsy) tipsy[options]();
            return this;
        }
        options = $.extend({}, $.fn.tipsy.defaults, options);
        if (options.hoverlock && options.delayOut === 0) {
            options.delayOut = 100;
        }
        function get(ele) {
            var tipsy = $.data(ele, "tipsy");
            if (!tipsy) {
                tipsy = new Tipsy(ele, $.fn.tipsy.elementOptions(ele, options));
                $.data(ele, "tipsy", tipsy);
            }
            return tipsy;
        }
        function enter() {
            var tipsy = get(this);
            tipsy.hoverState = "in";
            if (options.delayIn === 0) {
                tipsy.show();
            } else {
                tipsy.fixTitle();
                setTimeout(function() {
                    if (tipsy.hoverState == "in") tipsy.show();
                }, options.delayIn);
            }
        }
        function leave() {
            var tipsy = get(this);
            tipsy.hoverState = "out";
            if (options.delayOut === 0) {
                tipsy.hide();
            } else {
                var to = function() {
                    if (!tipsy.tipHovered || !options.hoverlock) {
                        if (tipsy.hoverState == "out") tipsy.hide();
                    }
                };
                setTimeout(to, options.delayOut);
            }
        }
        if (options.trigger != "manual") {
            var binder = options.live ? "live" : "bind", eventIn = options.trigger == "hover" ? "mouseenter" : "focus", click = options.trigger == "hover" ? "click" : "blur", eventOut = options.trigger == "hover" ? "mouseleave" : "blur";
            this[binder](eventIn, enter)[binder](eventOut, leave)[binder](click, leave);
        }
        return this;
    };
    $.fn.tipsy.defaults = {
        className: null,
        delayIn: 0,
        delayOut: 0,
        fade: false,
        fallback: "",
        gravity: "n",
        html: false,
        live: false,
        offset: 0,
        opacity: .8,
        title: "title",
        trigger: "hover",
        hoverlock: false
    };
    $.fn.tipsy.elementOptions = function(ele, options) {
        return $.metadata ? $.extend({}, options, $(ele).metadata()) : options;
    };
    $.fn.tipsy.autoNS = function() {
        return $(this).offset().top > $(document).scrollTop() + $(window).height() / 2 ? "s" : "n";
    };
    $.fn.tipsy.autoWE = function() {
        return $(this).offset().left > $(document).scrollLeft() + $(window).width() / 2 ? "e" : "w";
    };
    $.fn.tipsy.autoBounds = function(margin, prefer) {
        return function() {
            var dir = {
                ns: prefer[0],
                ew: prefer.length > 1 ? prefer[1] : false
            }, boundTop = $(document).scrollTop() + margin, boundLeft = $(document).scrollLeft() + margin, $this = $(this);
            if ($this.offset().top < boundTop) dir.ns = "n";
            if ($this.offset().left < boundLeft) dir.ew = "w";
            if ($(window).width() + $(document).scrollLeft() - $this.offset().left < margin) dir.ew = "e";
            if ($(window).height() + $(document).scrollTop() - $this.offset().top < margin) dir.ns = "s";
            return dir.ns + (dir.ew ? dir.ew : "");
        };
    };
})(jQuery);

var app = app || {};

app.charts = app.charts || {};

app.charts.bar = {};

app.charts.bar.draw = function(input, settings, refreshWithData, titlebar) {
    var useComment = false;
    settings.input = input;
    var chartTitle = input.title;
    var chartInfo = input.chartInfo;
    app.chartCommons.calculateFields(input.series, settings.calculatedFields);
    var seriesLabels = typeof input.series != "undefined" ? input.series.labels : [];
    var kpisLabels = typeof input.kpis != "undefined" ? input.kpis.labels : [];
    var seriesLabelsCaptions = input.seriesLablesCaptions;
    var kpisLabelsCaptions = input.kpisLablesCaptions;
    var selector = "#" + settings.id;
    var isFromCommentDialog = $(selector).hasClass("fromCommentDialog");
    var margin = {
        top: 20,
        right: 20,
        bottom: 40,
        left: 20
    };
    var width = $(selector).width();
    var barHeight = settings.chartProp.info.chartSize == "small" ? 80 : settings.chartProp.info.chartSize == "medium" ? 130 : settings.chartProp.info.chartSize == "large" ? 160 : settings.chartProp.info.chartSize == "veryLarge" ? 200 : 130;
    var animate = app.mobileMode ? false : true;
    var hasHref = settings.chartProp.info.openDashboard && settings.chartProp.info.openDashboard.checked;
    var showPersian = typeof input.lang == "undefined" ? true : +input.lang == 0 ? true : false;
    var height = barHeight + margin.top + margin.bottom;
    var colors = d3.scaleOrdinal(d3.schemeCategory10);
    var isProgress = titlebar.isProgress;
    var showProgress = titlebar.showProgress;
    var title = titlebar.title;
    var getFormatString = function(prop, backup) {
        if (!prop) return ",.2f";
        var p = prop;
        if (!prop.formatString) {
            if (!backup) return ",.2f";
            p = backup;
        }
        return p.formatString != "custom" ? p.formatString : p.formatStringCustom;
    };
    var stacked = +settings.chartProp.info.stackedBar;
    var isStack = stacked == 3 || stacked == 2 ? true : false;
    var isStackPercent = stacked == 3 ? true : false;
    var stackedLine = +settings.chartProp.info.stackedLine;
    var isStackLine = stackedLine == 3 || stackedLine == 2 ? true : false;
    var isStackLinePercent = stackedLine == 3 ? true : false;
    app.chartCommons.setDefault(settings.chartProp, kpisLabels.concat(seriesLabels), "bar");
    if (!input.result) {
        $("#" + settings.id).append(app.chartCommons.getError(input));
        return;
    }
    var data = prepareData(input, settings.chartProp);
    var needAnimation = data.length < 25;
    var cc = d3.scaleOrdinal(d3.schemeCategory10);
    var pushedColor = [];
    for (var i = 0; i < seriesLabels.length; i++) {
        var p = settings.chartProp.series[seriesLabels[i]];
        if (typeof p == "undefined") {
            if (settings.chartProp.series.length == 0) {
                p = {
                    seriesColor: "#1F77B4",
                    seriesType: "bar",
                    formatStringCustom: ",.2f",
                    formatString: ",.2f",
                    numberFactor: "1",
                    showValues: false,
                    hidden: false,
                    cumulative: false,
                    lineFace: "5,0",
                    lineWeight: "2",
                    lineStyle: "linear",
                    lineType: "line-dot-area",
                    showValueColor: "#333333"
                };
            } else {
                p = $.extend({}, settings.chartProp.series[Object.keys(settings.chartProp.series)[0]]);
            }
            var color = "#1F77B4";
            for (var i = 0; i < 10; i++) {
                color = cc(i) || "#1f77b4";
                if (pushedColor.indexOf(color.toLowerCase()) == -1) break;
            }
            p.seriesColor = color;
            p.name = null;
            settings.chartProp.series[seriesLabels[i]] = p;
        }
        if (!p.font || p.datasourceType) p.font = {
            bold: false,
            color: p.showValueColor || "#333333",
            italic: false,
            fontSize: p.showValueFontSize || "12px",
            fontName: "Droid"
        };
        pushedColor.push(p.seriesColor.toLowerCase());
    }
    d3Utils.prepareDataForBarChart(data, settings, seriesLabels, kpisLabels, seriesLabelsCaptions, kpisLabelsCaptions);
    _.each(data, function(d) {
        _.each(d.series, function(s, i) {
            s.sIndex = i;
        });
    });
    var s = seriesLabels;
    if (settings.chartProp.info.isBox) {
        data = _.map(data, function(item) {
            var out = [];
            for (var i = 0; i < item.series.length / 6; i++) {
                var row = item.series[i * 6 + 0];
                row.box = {
                    q1: item.series[i * 6 + 0],
                    q2: item.series[i * 6 + 1],
                    q3: item.series[i * 6 + 2],
                    min: item.series[i * 6 + 3],
                    max: item.series[i * 6 + 4],
                    avg: item.series[i * 6 + 5]
                };
                out.push(row);
            }
            item.series = out;
            return item;
        });
        s = _.filter(seriesLabels, function(d, i) {
            return i % 6 === 0;
        });
    }
    if (settings.editMode) {
        $(selector).trigger("chartproperty", [ kpisLabels.concat(s) ]);
        $(selector).trigger("dimColor", [ _.map(input.matrix, function(d) {
            return d.values.join("-");
        }) ]);
    }
    var tempData = null;
    for (var i = 0; i < data.length; i++) {
        if (!tempData) tempData = new Array(data.length);
        for (var j = 0; j < data[i].series.length; j++) {
            if (!tempData[i]) tempData[i] = new Array(data[i].series.length);
            tempData[i][j] = tempData[i][j] || {
                sum: null,
                avg: null,
                "var": null
            };
            if (data[i].series[j].prop && data[i].series[j].prop.cumulative) {
                if (typeof data[i].series[j].prop.cumulative_formula == "undefined" || data[i].series[j].prop.cumulative_formula == "sum") {
                    tempData[i][j].sum = d3.sum(data.filter(function(d, index) {
                        return index <= i;
                    }), function(d, i) {
                        return d.series[j].data;
                    });
                }
                if (data[i].series[j].prop.cumulative_formula == "avg") {
                    tempData[i][j].avg = d3.mean(data.filter(function(d, index) {
                        return index <= i;
                    }), function(d, i) {
                        return d.series[j].data;
                    });
                }
                if (data[i].series[j].prop.cumulative_formula == "var") {
                    tempData[i][j].var = d3.variance(data.filter(function(d, index) {
                        return index <= i;
                    }), function(d, i) {
                        return d.series[j].data;
                    });
                }
                if (data[i].series[j].data == null && data[i].series[j].prop.dontShowZeroValue) {
                    tempData[i][j].sum = null;
                    tempData[i][j].avg = null;
                    tempData[i][j].var = null;
                }
            }
        }
    }
    for (var i = 0; i < data.length; i++) {
        for (var j = 0; j < data[i].series.length; j++) {
            if (data[i].series[j].prop && data[i].series[j].prop.cumulative) {
                data[i].series[j].data = tempData[i][j].var || tempData[i][j].sum || tempData[i][j].avg;
            }
        }
    }
    if (isStackPercent) {
        data.forEach(function(item) {
            var bars = item.series.filter(function(d, i) {
                return !d.prop.hidden && d.prop.seriesType == "bar";
            });
            var sum = d3.sum(bars.map(function(d) {
                return Math.abs(d.data);
            }));
            bars.forEach(function(d) {
                d.data = d.data / sum * 100;
            });
        });
    }
    $(selector).addClass("bar-line-chart");
    var legendBar = d3.select(selector).append("div").attr("class", "legend-bar temporal");
    var sort;
    var sortSelector;
    sort = d3.select(selector).select("#sort_checkbox_btn");
    sortSelector = d3.select(selector).select("#sort_checkbox select");
    if (!sort._groups[0][0] && data.length > 0) {
        var sortDiv = legendBar.append("div").attr("id", "sort_checkbox").attr("class", "sort-checkbox");
        sort = sortDiv.append("label").append("input").attr("type", "checkbox").attr("id", "sort_checkbox_btn");
        sortDiv.select("label").append("span");
        app.lang.translateAsync("sort", function(t) {
            var label = $(sortDiv._groups[0][0]).find("span");
            label.html(" " + t);
        });
        var sortSelector = sortDiv.append("select").on("change", function() {
            var is = sort.property("checked");
            settings.isSort = is;
            if (sort.property("checked")) change();
        }).style("margin", "0 7px");
        if (kpisLabels.length + seriesLabels.length == 1) {
            sortSelector.style("visibility", "hidden").style("width", "1px");
        }
        sortSelector.selectAll("nothings").data(data[0].series.filter(function(d, i) {
            return !d.prop.hidden;
        }).map(function(d) {
            return {
                name: (d.prop.name || d.label).replace(/^\[measure\]/, ""),
                value: d.label
            };
        })).enter().append("option").text(function(d) {
            return persian(d.name, showPersian);
        }).attr("value", function(d) {
            return d.value;
        });
    }
    if (typeof settings.chartProp.info.showSortBox != "undefined" && !settings.chartProp.info.showSortBox) {
        $(selector + " #sort_checkbox").hide();
    }
    legendBar.breadcrumb(input.levels, settings, titlebar, showPersian);
    if (!input.matrix || input.matrix.length == 0) {
        legendBar.append("div").attr("class", "temporal").style("font-size", "0.8em").style("margin", "15px").append("span").attr("class", "translate").attr("data-trans-key", "داده‌ای برای نمایش وجود ندارد").text("داده‌ای برای نمایش وجود ندارد");
        return;
    }
    if (settings.chartProp.info.showLegends || typeof settings.chartProp.info.showLegends == "undefined") legendBar.legend({
        width: width,
        font: settings.chartProp.info.legendFont,
        position: settings.chartProp.info.legendPosition,
        selector: selector,
        data: data[0].series.filter(function(d, i) {
            return !d.prop.hidden;
        }).map(function(d) {
            return {
                label: (d.prop.name || d.label).replace(/^\[measure\]/, ""),
                color: d.prop.seriesColor,
                key: d.key,
                sIndex: d.sIndex
            };
        }),
        click: function(d) {
            if (!settings.editMode) $(selector + " .series-" + d.sIndex).fadeToggle();
        }
    }, showPersian);
    if (settings.chartProp.indicatorLegendShow) {
        legendBar.legend({
            order: "horizental",
            width: width,
            font: settings.chartProp.indicatorLegendFont,
            position: settings.chartProp.info.legendPosition,
            selector: selector,
            data: _.map(settings.chartProp.indicator, function(d, i) {
                var then = _.find(d.thenRow, {
                    operand: "1"
                });
                var color = then ? then.secondFieldColor : "#eeeeee";
                var title = d.title || app.chartCommons.indicator.ifToString(d.ifRow, input.series.labels, input.seriesLablesCaptions, settings);
                return {
                    label: title,
                    color: color
                };
            })
        }, showPersian);
    }
    var svg = null;
    if (_.indexOf([ "bottom left", "bottom right", "bottom center" ], settings.chartProp.info.legendPosition) != -1) {
        svg = d3.select(selector).insert("svg", ":first-child").attr("class", "temporal line-chart");
    } else {
        svg = d3.select(selector).append("svg").attr("class", "temporal line-chart");
    }
    var max = d3.max(data, function(d) {
        return d3.max(d.series.filter(function(d, i) {
            return !d.prop.hidden;
        }), function(d) {
            if (d.type == "kpi") {
                return d3.max(d.data);
            }
            if (d.type == "series") {
                return +d.data || 0;
            }
        });
    });
    var min = d3.min(data, function(d) {
        return d3.min(d.series.filter(function(d, i) {
            return !d.prop.hidden;
        }), function(d) {
            if (d.type == "kpi") {
                return d3.min(d.data);
            }
            if (d.type == "series") {
                return +d.data || 0;
            }
        });
    });
    if (settings.chartProp.info.isBox) {
        max = d3.max(data, function(d) {
            return d3.max(d.series.filter(function(d, i) {
                return !d.prop.hidden;
            }), function(d) {
                return d3.max([ d.box.q1.data, d.box.q2.data, d.box.q3.data, d.box.min.data, d.box.max.data, d.box.avg.data ]);
            });
        });
        min = d3.min(data, function(d) {
            return d3.min(d.series.filter(function(d, i) {
                return !d.prop.hidden;
            }), function(d) {
                return d3.min([ d.box.q1.data, d.box.q2.data, d.box.q3.data, d.box.min.data, d.box.max.data, d.box.avg.data ]);
            });
        });
    }
    if (isStack) {
        var maxStack = d3.max(data, function(d) {
            return d3.sum(d.series.filter(function(d, i) {
                return !d.prop.hidden && d.prop.seriesType == "bar";
            }), function(d) {
                if (d.type == "kpi") {
                    return d3.max(d.data);
                }
                if (d.type == "series") {
                    return d.data > 0 ? d.data : 0;
                }
            });
        });
        max = maxStack > max ? maxStack : max;
        var minStack = d3.min(data, function(d) {
            return d3.sum(d.series.filter(function(d, i) {
                return !d.prop.hidden;
            }), function(d) {
                if (d.type == "kpi") {
                    return d3.min(d.data);
                }
                if (d.type == "series") {
                    return d.data < 0 ? d.data : 0;
                }
            });
        });
        min = minStack < min ? minStack : min;
    }
    if (isStackLine) {
        var maxStack = d3.max(data, function(d) {
            return d3.sum(d.series.filter(function(d, i) {
                return !d.prop.hidden && d.prop.seriesType == "line";
            }), function(d) {
                if (d.type == "kpi") {
                    return d3.max(d.data);
                }
                if (d.type == "series") {
                    return d.data > 0 ? d.data : 0;
                }
            });
        });
        max = maxStack > max ? maxStack : max;
        var minStack = d3.min(data, function(d) {
            return d3.sum(d.series.filter(function(d, i) {
                return !d.prop.hidden;
            }), function(d) {
                if (d.type == "kpi") {
                    return d3.min(d.data);
                }
                if (d.type == "series") {
                    return d.data < 0 ? d.data : 0;
                }
            });
        });
        min = minStack < min ? minStack : min;
    }
    function calcMinMax(min, max) {
        if (!settings.chartProp.info.yAxisAuto) {
            if (min > 0) min = 0;
        }
        if (min == max) {
            if (min < 0) max = 0;
            if (min > 0) min = 0;
        }
        min = min == 0 ? 0 : min - Math.abs(.25 * (max - min));
        max = max + Math.abs(.25 * (max - min));
        return {
            min: min,
            max: max
        };
    }
    var tMinMax = calcMinMax(min, max);
    min = tMinMax.min;
    max = tMinMax.max;
    var barCount = data[0].series.filter(function(d) {
        return d.type == "series" && d.prop.seriesType == "bar" && !d.prop.hidden;
    }).length;
    var lineCount = data[0].series.filter(function(d) {
        return d.type == "series" && d.prop.seriesType == "line" && !d.prop.hidden;
    }).length;
    if (isStackLinePercent && lineCount > 0 || isStackPercent && barCount > 0) {
        max = 100;
        min = min < 0 ? -100 : 0;
    }
    if (settings.chartProp.info.yAxisMax) {
        max = +settings.chartProp.info.yAxisMax;
    }
    if (settings.chartProp.info.yAxisMin) {
        min = +settings.chartProp.info.yAxisMin;
    }
    var xAxisLen = +settings.chartProp.info.xAxisLen || 20;
    if (!settings.chartProp.info.font) settings.chartProp.info.font = {
        bold: false,
        color: "#333333",
        italic: false,
        fontSize: "12px",
        fontName: "Droid"
    };
    var xTrimLen = 50;
    var step = data.length / xTrimLen;
    var sample = function(d, i) {
        if (data.length < 35) return true;
        if (data.length <= xTrimLen) return true;
        if (i === 0) this.meter = 0;
        if (i >= this.meter) {
            this.meter += step;
            return true;
        }
        return false;
    };
    function getRotate() {
        return app.lang.isRtl() ? "rotate(-90)" : "rotate(-90)";
    }
    function rotateV2() {
        var transform = "translate(0.25em, 1em) rotate(-90deg)";
        var textAnchor = app.lang.isRtl() ? "end" : "start";
        var size = +settings.chartProp.info.font.fontSize.replace("px", "");
        var em_1 = size * 1 + "px";
        var em_025 = size * .25 + "px";
        var em_125 = size * 1.25 + "px";
        var em_15 = size * 1.5 + "px";
        if (settings.chartProp.info.xAxisRotate === "-90") transform = "translate(" + em_025 + ", " + em_1 + ") rotate(-90deg)";
        if (settings.chartProp.info.xAxisRotate === "-60") transform = "translate(" + em_025 + ", " + em_1 + ") rotate(-60deg)";
        if (settings.chartProp.info.xAxisRotate === "-45") transform = "translate(" + em_025 + ", " + em_1 + ") rotate(-45deg)";
        if (settings.chartProp.info.xAxisRotate === "-30") transform = "translate(" + em_025 + ", " + em_125 + ") rotate(-30deg)";
        if (settings.chartProp.info.xAxisRotate === "0") {
            transform = "translate(0px, " + em_15 + ") rotate(0deg)";
            textAnchor = "middle";
        }
        return {
            transform: transform,
            "text-anchor": textAnchor
        };
    }
    var xAxisLableWidth = 30;
    app.dashboardLayoutVersion = app.dashboardLayoutVersion || 2;
    if (app.dashboardLayoutVersion === 2) {
        var xtemp = d3.scaleBand().range([ width - 400, width ]).paddingInner(.1);
        xtemp.domain(data.map(function(d) {
            return d.label + "#" + d.index;
        }).filter(sample));
        var xAxis = d3.axisBottom(xtemp).tickFormat(function(str) {
            var s = str.replace(new RegExp("#\\d+$"), "");
            return (s.length > xAxisLen ? "..." : "") + persian(s.substring(0, xAxisLen), showPersian);
        });
        var xx = d3.select(selector).append("svg");
        xx.append("g").attr("class", "x axis").call(xAxis);
        xx.selectAll("g text").attr("fill", settings.chartProp.info.font.color).attr("class", "axes-x-label").style("font-family", settings.chartProp.info.font.fontName).style("font-size", settings.chartProp.info.font.fontSize).style("font-weight", settings.chartProp.info.font.bold ? "bold" : "normal").style("font-style", settings.chartProp.info.font.italic ? "italic" : "normal").attr("x", "0").attr("dy", "0").attr("y", "0").styles(rotateV2()).append("title").text(function(d) {
            return persian(d.replace(new RegExp("#\\d+$"), ""), showPersian);
        });
        var c = xx.node();
        var box = c.getBBox();
        try {
            xAxisLableWidth = xx.selectAll("text")._groups[0][1].getBBox().height;
        } catch (e) {}
        var titleHeight = $(selector + " .title").outerHeight() || 0;
        var lb = $(selector + " .legend-bar");
        var legendHeight = typeof lb == "undefined" ? 0 : lb.height() + +lb.css("margin-top").replace("px", "");
        xx.remove();
        barHeight = $(selector).height() - titleHeight - box.height - margin.bottom - legendHeight;
        if (barHeight < 50) barHeight = 50;
        svg.attr("width", width).attr("height", barHeight + box.height + margin.bottom);
    }
    var y = d3.scaleLinear().range([ barHeight + margin.top, margin.top ]).domain([ min, max ]);
    var secondaryY = _.extend({
        enable: false,
        ticksType: "auto",
        ticksCount: 10,
        ticksSpace: 20,
        measures: {},
        font: {
            bold: false,
            color: "#333333",
            italic: false,
            fontSize: "10px",
            fontName: "IRANSans",
            formatString: settings.chartProp.info.formatString || ",.2f",
            formatStringCustom: ",.2f"
        }
    }, settings.chartProp.info.secondaryY);
    if (isStack || isStackLine) {
        secondaryY.enable = false;
    }
    if (secondaryY.enable) {
        var y2Max = d3.max(data, function(d) {
            return d3.max(d.series.filter(function(d, i) {
                return !d.prop.hidden && secondaryY.measures[d.seriesKey] === true;
            }), function(d) {
                if (d.type == "kpi") {
                    return d3.max(d.data);
                }
                if (d.type == "series") {
                    return +d.data || 0;
                }
            });
        });
        var y2Min = d3.min(data, function(d) {
            return d3.min(d.series.filter(function(d, i) {
                return !d.prop.hidden && secondaryY.measures[d.seriesKey] === true;
            }), function(d) {
                if (d.type == "kpi") {
                    return d3.min(d.data);
                }
                if (d.type == "series") {
                    return +d.data || 0;
                }
            });
        });
        var tMinMax = calcMinMax(y2Min, y2Max);
        y2Min = tMinMax.min;
        y2Max = tMinMax.max;
        var y2 = d3.scaleLinear().range([ barHeight + margin.top, margin.top ]).domain([ y2Min, y2Max ]);
    }
    if (settings.chartProp.info.formatString == "%") settings.chartProp.info.formatString = ".0%";
    settings.chartProp.info.fontYaxe = _.extend({
        bold: false,
        color: "#333333",
        italic: false,
        fontSize: "10px",
        fontName: "IRANSans",
        formatString: settings.chartProp.info.formatString || ",.2f",
        formatStringCustom: ",.2f"
    }, settings.chartProp.info.fontYaxe);
    var yAxis = d3.axisLeft(y).tickFormat(function(d) {
        var format = d3.format(settings.chartProp.info.fontYaxe.formatString);
        return persian(format(d), showPersian) + "";
    });
    var AxeY = _.extend({
        ticksType: "auto",
        ticksCount: 10,
        ticksSpace: 20
    }, settings.chartProp.info.AxeY);
    var tic = Math.floor(barHeight / 22) + 1;
    if (AxeY.ticksType === "count") {
        tic = AxeY.ticksCount;
    }
    if (AxeY.ticksType === "space") {
        tic = Math.floor(barHeight / AxeY.ticksSpace) + 1;
    }
    yAxis.ticks(tic);
    var yElement = svg.append("g").attr("class", "y axis").attr("transform", "translate(-10,0)");
    yElement.call(yAxis);
    yElement.selectAll(".tick text").attr("fill", settings.chartProp.info.fontYaxe.color).styles({
        "font-size": settings.chartProp.info.fontYaxe.fontSize,
        "font-family": settings.chartProp.info.fontYaxe.fontName,
        "font-weight": settings.chartProp.info.fontYaxe.bold ? "bold" : "normal",
        "font-style": settings.chartProp.info.fontYaxe.italic ? "italic" : "normal"
    });
    var yAxisBox = yElement._groups[0][0].getBBox();
    var y2AxisBox = {};
    if (secondaryY.enable) {
        var y2Axis = d3.axisRight(y2).tickFormat(function(d) {
            var format = d3.format(secondaryY.font.formatString);
            return persian(format(d), showPersian) + "";
        });
        var tic = Math.floor(barHeight / 22) + 1;
        if (secondaryY.ticksType === "count") {
            tic = secondaryY.ticksCount;
        }
        if (secondaryY.ticksType === "space") {
            tic = Math.floor(barHeight / secondaryY.ticksSpace) + 1;
        }
        y2Axis.ticks(tic);
        var y2Element = svg.append("g").attr("class", "y2 axis").attr("transform", "translate(-10,0)");
        y2Element.call(y2Axis);
        y2Element.selectAll(".tick text").attr("fill", secondaryY.font.color).styles({
            "font-size": secondaryY.font.fontSize,
            "font-family": secondaryY.font.fontName,
            "font-weight": secondaryY.font.bold ? "bold" : "normal",
            "font-style": secondaryY.font.italic ? "italic" : "normal"
        });
        y2AxisBox = y2Element._groups[0][0].getBBox();
    }
    var barWidth = width - yAxisBox.width - (y2AxisBox.width || 0) - margin.left;
    data = data.filter(function(d, i) {
        return i < barWidth - 2 - barWidth * .1;
    });
    var range = [ width - barWidth - (y2AxisBox.width || 0) + 10, width - 10 - (y2AxisBox.width || 0) ];
    var innerPad = .1;
    var outterPad = data.length == 1 ? 1 : data.length < 5 ? .5 : 0;
    var barsCharts = data[0].series.filter(function(d, i) {
        return !d.prop.hidden && d.prop.seriesType == "bar";
    });
    if (barsCharts.length == 0) outterPad = 0;
    yElement.attr("transform", "translate(" + (yAxisBox.width + margin.left) + ",0)");
    if (secondaryY.enable) {
        y2Element.attr("transform", "translate(" + (barWidth + margin.left + yAxisBox.width) + ",0)");
    }
    var tmpBar = $.grep(data[0].series, function(d, i) {
        return d.prop.seriesType == "bar" && !d.prop.hidden;
    });
    var tmpLine = $.grep(data[0].series, function(d, i) {
        return d.prop.seriesType == "line" && !d.prop.hidden;
    });
    var x = d3.scaleBand().range(range).paddingInner(innerPad).paddingOuter(outterPad);
    x.domain(data.map(function(d) {
        return d.label + "#" + d.index;
    }));
    var x0 = d3.scaleBand().range([ 0, x.bandwidth() ]).domain($.map(tmpBar, function(d) {
        return d.label;
    }));
    var xtrim = d3.scaleBand().range(range).paddingInner(innerPad).paddingOuter(outterPad);
    xTrimLen = Math.abs(range[0] - range[1]) / xAxisLableWidth;
    step = data.length / xTrimLen;
    xtrim.domain(data.map(function(d) {
        return d.label + "#" + d.index;
    }).filter(sample));
    var xAxis = d3.axisBottom(xtrim).tickFormat(function(str) {
        var s = str.replace(new RegExp("#\\d+$"), "");
        return (s.length > xAxisLen ? "..." : "") + persian(s.substring(0, xAxisLen), showPersian);
    });
    svg.append("svg:rect").attr("class", "background").style("fill", "white").style("opacity", "0").attr("width", barWidth).attr("height", +svg.attr("height")).attr("transform", "translate(" + (width - barWidth) + ",0)").on("click", function(d, i) {
        if (isFromCommentDialog) {
            return;
        }
        if (input.levels == "") return;
        if (isProgress()) return;
        showProgress(true);
        settings.isSort = sort.property("checked");
        app.chartCommons.drillDown.up(settings.ChartInPageId);
        settings.parameters = {
            isUp: true,
            chartId: settings.chartId,
            ChartInPageId: settings.ChartInPageId,
            notEditMode: !settings.editMode
        };
        app.chartCommons.levelTypeUtils.getParam(settings);
        $(selector).charts(settings.type, "refreshWithData", settings);
    });
    if (settings.chartProp.info.horizontalLines) svg.select(".y.axis").selectAll("g line").attr("x2", barWidth).attr("x1", "-6").style("opacity", "0.1");
    var flag = settings.chartProp.globalvariable && settings.chartProp.globalvariable.length > 0 && !settings.editMode && settings.chartProp.globalvariable.filter(function(d) {
        return d.field == input.CurrentDimName;
    }).length > 0;
    svg.append("g").attr("class", "x axis").attr("transform", "translate(0," + (barHeight + margin.top) + ")").call(xAxis);
    var t = svg.select(".x.axis").selectAll("g text").attr("class", "axes-x-label").attr("x", "0").attr("dy", "0").attr("y", "0").styles(rotateV2()).style("font-family", settings.chartProp.info.font.fontName).style("font-size", settings.chartProp.info.font.fontSize).attr("fill", settings.chartProp.info.font.color).style("font-weight", settings.chartProp.info.font.bold ? "bold" : "normal").style("font-style", settings.chartProp.info.font.italic ? "italic" : "normal");
    svg.select(".x.axis").selectAll("g").append("title").text(function(d) {
        return persian(d.replace(new RegExp("#\\d+$"), ""), showPersian);
    });
    var maxC = d3.max(t._groups[0], function(d) {
        return d.getBBox().width;
    });
    var maxLen = t._groups[0].length * maxC;
    var xRotate = maxLen > barWidth;
    xRotate = true;
    if (xRotate) {
        t.styles(rotateV2());
    }
    var onClickCalback = function(d, i) {
        $(".tipsy").remove();
        if (isFromCommentDialog) {
            return;
        }
        if (settings.chartProp.globalvariable && settings.chartProp.globalvariable.length > 0 && !settings.editMode) {
            app.globalVariableHelper.updateGlobalVariables([ input.CurrentDimName ], [ d.value ], settings.chartProp.globalvariable);
            $(selector + " .gd.selected-item").attr("class", $(this).attr("class").replace("selected-item", ""));
            $(selector + " .circle.selected-item").attr("class", $(this).attr("class").replace("selected-item", ""));
            $(this).attr("class", $(this).attr("class") + " selected-item");
        }
        if (!d.canDrill) {
            if (hasHref && !settings.editMode) {
                app.chartCommons.openLink(settings.chartProp.info.openDashboard, {
                    ChartInPageId: settings.ChartInPageId,
                    DataSourceId: settings.input.DataSourceId,
                    dimensionName: settings.input.dimensionName,
                    value: d.value,
                    refreshDatasource: settings.input.RefreshDatasource
                });
            }
            return;
        }
        if (isProgress()) return;
        showProgress(true);
        var is = sort.property("checked");
        settings.isSort = is;
        app.chartCommons.drillDown.add(settings.ChartInPageId, settings.input.DataSourceId, settings.input.CurrentDimName, d.onClickVal, settings.input.RefreshDatasource);
        settings.parameters = {
            selectedItem: d.onClickVal,
            chartId: settings.chartId,
            ChartInPageId: settings.ChartInPageId,
            notEditMode: !settings.editMode
        };
        app.chartCommons.levelTypeUtils.getParam(settings);
        $(selector).charts(settings.type, "refreshWithData", settings);
    };
    var chart = svg.append("g").attr("class", "charts");
    var g = chart.selectAll(".gd").data(data).enter().append("g").attr("transform", "translate(" + x(data[0].label + "#" + data[0].index) + ",0)").attr("class", function(d) {
        return "gd " + (d.onClickVal != "" || d.canDrill || flag || hasHref ? " pointer" : "");
    }).on("click", onClickCalback);
    function checkRow(ifObj, fields, headers) {
        var Index = headers.indexOf(ifObj.firstField);
        var firstVal = fields[Index];
        var secVal = ifObj.secondFieldIsText ? ifObj.secondFieldInput : fields[headers.indexOf(ifObj.secondFieldSelect)];
        firstVal = depersian(firstVal);
        secVal = depersian(secVal);
        if (!isNaN(secVal)) secVal = +secVal;
        if (!isNaN(firstVal)) firstVal = +firstVal;
        switch (+ifObj.operand) {
          case 1:
            return firstVal == secVal;

          case 2:
            return firstVal != secVal;

          case 3:
            return firstVal > secVal;

          case 4:
            return firstVal >= secVal;

          case 5:
            return firstVal < secVal;

          case 6:
            return firstVal <= secVal;

          case 7:
            return firstVal.indexOf(secVal) > -1;

          case 8:
            return firstVal.indexOf(secVal) <= -1;

          default:        }
    }
    var calc = {
        lastTexts: [],
        clear: function() {
            this.lastTexts = [];
        },
        noConfilict: function(w, h, xMap, y) {
            var noConfilict = true;
            for (var j = 0; j < this.lastTexts.length; j++) {
                var last = this.lastTexts[j];
                noConfilict = xMap + x.bandwidth() / 2 - w / 2 > last.x + 3 || last.y - last.h - 3 > y || last.y < y - h - 3;
                if (!noConfilict) break;
            }
            if (noConfilict) {
                if (this.lastTexts.length >= 5) this.lastTexts.shift();
                this.lastTexts.push({
                    x: xMap + w / 2,
                    y: y,
                    h: h
                });
            }
            return noConfilict;
        }
    };
    function pushThenRow(ret, values, headers) {
        if (settings.chartProp.indicator) {
            settings.chartProp.indicator.forEach(function(ind) {
                var isTrue = true;
                $.each(ind.ifRow, function(i, d) {
                    if (!checkRow(d, values, headers)) {
                        isTrue = false;
                        return false;
                    }
                });
                if (isTrue) {
                    ret.map(function(d) {
                        d.thenRows = d.thenRows || [];
                        d.thenRows.push(ind.thenRow);
                        return d;
                    });
                }
            });
        }
    }
    var recOverlap = settings.chartProp.info.overlapBars || false;
    var isbox = settings.chartProp.info.isBox;
    function getColor(d, i, def) {
        var dimColor = settings.chartProp.info.dimColor = settings.chartProp.info.dimColor || {};
        if (dimColor.enable) {
            var c = dimColor.data[d.category.join("-")];
            c = c || {};
            return c.color || def;
        }
        return def;
    }
    if (!isStack && !isbox) {
        var gg = g.selectAll("nothings").data(function(d) {
            var ret = d.series.filter(function(d) {
                return d.type == "series" && d.prop.seriesType == "bar" && !d.prop.hidden;
            });
            var headers = d.series.map(function(d) {
                return d.label;
            });
            var values = d.series.map(function(d) {
                return d.data;
            });
            pushThenRow(ret, values, headers);
            return ret;
        }).enter().append("g").attr("class", function(d) {
            return "series " + "series-" + d.sIndex;
        }).attr("transform", function(d, i) {
            return recOverlap ? "" : "translate(" + x0(d.label) + ",0)";
        });
        gg.append("rect").attr("sss", "xxxs").attr("width", recOverlap ? x.bandwidth() : x0.bandwidth()).attr("fill", function(d, i) {
            var color = getColor(d, i, d.prop.seriesColor);
            if (d.thenRows) {
                $.each(d.thenRows, function(i, thenRow) {
                    $.each(thenRow, function(i, thenRowItem) {
                        if (d.label != thenRowItem.firstField) return true;
                        switch (+thenRowItem.operand) {
                          case 1:
                            color = thenRowItem.secondFieldColor;
                            break;
                        }
                    });
                });
            }
            return color;
        }).attr("y", function(d) {
            var yFun = y;
            if (secondaryY.enable && secondaryY.measures[d.seriesKey] == true) {
                yFun = y2;
            }
            return d.data >= 0 ? yFun(d.data > max ? max : d.data) : yFun(Math.min(0, max));
        }).attr("height", function(d) {
            var yFun = y;
            if (secondaryY.enable && secondaryY.measures[d.seriesKey] == true) {
                yFun = y2;
            }
            var h = d.data > 0 ? yFun(Math.max(0, min)) - yFun(d.data > max ? max : d.data) : yFun(d.data < min ? min : d.data) - yFun(Math.min(0, max));
            return h;
        }).on("click", function(d) {
            if (isFromCommentDialog) {
                app.chartCommons.commentUtils.clickOnCommentIcon(d, settings.ChartInPageId);
            }
        });
        app.chartCommons.commentUtils.addCommentIcon(settings.ChartInPageId, gg, function(d) {
            return recOverlap ? x.bandwidth() / 2 - 5 : x0.bandwidth() / 2 - 5;
        }, function(d) {
            return (d.data >= 0 ? y(d.data > max ? max : d.data) : y(Math.min(0, max))) - 24;
        });
        if (isFromCommentDialog) {
            app.chartCommons.commentUtils.setOnHighlightListener(g.selectAll(".series"), settings.ChartInPageId);
        }
        var gt = chart.selectAll(".gd-text").data(data).enter().append("g").attr("transform", "translate(" + x(data[0].label + "#" + data[0].index) + ",0)").attr("class", function(d) {
            return "gd-text" + (d.onClickVal != "" || flag ? " pointer" : "");
        }).on("click", onClickCalback);
        var texts = gt.selectAll("nothings").data(function(d) {
            return d.series.filter(function(d) {
                return d.type == "series" && d.prop.seriesType == "bar" && !d.prop.hidden;
            });
        }).enter().append("text").text(function(d) {
            return !d.prop.showValues ? "" : persian(d3.format(getFormatString(d.prop.font, d.prop))(d.data), showPersian);
        }).attr("class", function(d) {
            return "series " + "series-" + d.sIndex;
        }).style("font-family", function(d) {
            return d.prop.font.fontName;
        }).style("font-size", function(d) {
            return d.prop.font.fontSize;
        }).attr("fill", function(d) {
            return d.prop.font.color;
        }).style("font-weight", function(d) {
            return d.prop.font.bold ? "bold" : "normal";
        }).style("font-style", function(d) {
            return d.prop.font.italic ? "italic" : "normal";
        }).attr("x", "0.3em").attr("dy", function(d) {
            return d.data >= 0 ? "-0.3em" : "1em";
        }).attr("transform", function(d, i) {
            return recOverlap ? "" : "translate(" + x0(d.label) + ",0)";
        }).attr("y", function(d) {
            var yFun = y;
            if (secondaryY.enable && secondaryY.measures[d.seriesKey] == true) {
                yFun = y2;
            }
            return d.data >= 0 ? yFun(d.data > max ? max : d.data) : yFun(d.data);
        }).on("click", function(d) {
            if (isFromCommentDialog) {
                app.chartCommons.commentUtils.clickOnCommentIcon(d, settings.ChartInPageId);
            }
        });
        var mapped = data.map(function(d) {
            return d.label + "#" + d.index;
        });
        texts._groups.forEach(function(item, i) {
            item.forEach(function(t, j) {
                var tw = t.getBBox().width;
                var th = t.getBBox().height;
                var bw = recOverlap ? x.bandwidth() : x0.bandwidth();
                var rr = x;
                var dd = data;
                var ri = i;
                var xMid = bw / 2 - tw / 2;
                d3.select(t).attr("x", xMid);
                if (!calc.noConfilict(tw, th, x(mapped[i]), d3.select(t).attr("y"))) {
                    $(t).remove();
                }
            });
        });
        calc.clear();
    } else if (isbox) {
        var gg = g.selectAll("nothings").data(function(d) {
            var ret = d.series.filter(function(d) {
                return d.type == "series" && d.prop.seriesType == "bar" && !d.prop.hidden;
            });
            var headers = d.series.map(function(d) {
                return d.label;
            });
            var values = d.series.map(function(d) {
                return d.data;
            });
            pushThenRow(ret, values, headers);
            return ret;
        }).enter().append("g");
        gg.attr("class", function(d) {
            return "series " + "series-" + d.sIndex;
        }).attr("transform", function(d, i) {
            return "translate(" + x0(d.label) + ",0)";
        });
        var getY = function(d) {
            var yFun = y;
            if (secondaryY.enable && secondaryY.measures[d.seriesKey] === true) {
                yFun = y2;
            }
            return d.data >= 0 ? yFun(d.data > max ? max : d.data) : yFun(0);
        };
        var xBase = 5;
        var boxWidth = x0.bandwidth() - xBase * 2;
        var colorFill = function(d, i) {
            return getColor(d, i, d.prop.seriesColor);
        };
        gg.append("line").attr("x1", xBase).attr("x2", boxWidth + xBase).attr("y1", function(d) {
            return getY(d.box.q2);
        }).attr("y2", function(d) {
            return getY(d.box.q2);
        }).style("display", function(d) {
            var box = d.prop.boxOption || {};
            if (box.dontShowMedian === true) {
                return "none";
            }
            return "auto";
        }).attr("stroke", colorFill);
        gg.append("line").attr("x1", boxWidth / 2 + xBase).attr("x2", boxWidth / 2 + xBase).attr("y1", function(d) {
            return getY(d.box.min);
        }).attr("y2", function(d) {
            return getY(d.box.q1);
        }).attr("stroke", colorFill);
        gg.append("line").attr("x1", boxWidth / 3 + xBase).attr("x2", 2 * boxWidth / 3 + xBase).attr("y1", function(d) {
            return getY(d.box.min);
        }).attr("y2", function(d) {
            return getY(d.box.min);
        }).attr("stroke", colorFill);
        gg.append("line").attr("x1", boxWidth / 3 + xBase).attr("x2", 2 * boxWidth / 3 + xBase).attr("y1", function(d) {
            return getY(d.box.max);
        }).attr("y2", function(d) {
            return getY(d.box.max);
        }).attr("stroke", colorFill);
        gg.append("line").attr("x1", boxWidth / 2 + xBase).attr("x2", boxWidth / 2 + xBase).attr("y1", function(d) {
            return getY(d.box.max);
        }).attr("y2", function(d) {
            return getY(d.box.q3);
        }).attr("stroke", colorFill);
        gg.append("circle").attr("cx", boxWidth / 2 + xBase).attr("cy", function(d) {
            return getY(d.box.avg);
        }).attr("r", "5px").style("display", function(d) {
            var box = d.prop.boxOption || {};
            if (box.dontShowAvg === true) {
                return "none";
            }
            return "auto";
        }).attr("stroke", colorFill);
        gg.append("rect").attr("width", boxWidth).attr("x", xBase).attr("stroke", colorFill).attr("fill", function(d) {
            var color = getColor(d, i, d.prop.seriesColor);
            if (d.thenRows) {
                $.each(d.thenRows, function(i, thenRow) {
                    $.each(thenRow, function(i, thenRowItem) {
                        if (d.label !== thenRowItem.firstField) return true;
                        switch (+thenRowItem.operand) {
                          case 1:
                            color = thenRowItem.secondFieldColor;
                            break;
                        }
                    });
                });
            }
            return color + "99";
        }).attr("y", function(d) {
            return getY(d.box.q3);
        }).attr("height", function(d) {
            return getY(d.box.q1) - getY(d.box.q3);
        }).on("click", function(d) {
            if (isFromCommentDialog) {
                app.chartCommons.commentUtils.clickOnCommentIcon(d, settings.ChartInPageId);
            }
        });
        var getBoxFontProp = function(d, i) {
            var box = d.prop.boxOption || {};
            var show = {};
            if (i === 0 || i === 2) show = box.q1q3ValueFont;
            if (i === 1) show = box.midValueFont;
            if (i === 3 || i === 4) show = box.minMaxValueFont;
            return show || {};
        };
        gg.append("g").selectAll("text").data(function(d) {
            return [ d.box.q1, d.box.q2, d.box.q3, d.box.min, d.box.max ];
        }).enter().append("text").attr("y", function(d) {
            return getY(d);
        }).attr("x", xBase).text(function(d, i) {
            var box = d.prop.boxOption || {};
            var show = false;
            if (i === 0 || i === 2) show = box.showq1q3Value;
            if (i === 1) {
                show = box.showMidValue && box.dontShowMedian !== true;
            }
            if (i === 3 || i === 4) show = box.showMinMaxValue;
            var font = getBoxFontProp(d, i);
            return show ? persian(d3.format(getFormatString(font, d.prop))(d.data), showPersian) : "";
        }).styles(function(d, i) {
            var font = getBoxFontProp(d, i);
            return {
                "font-family": font.fontName,
                "font-size": font.fontSize,
                fill: font.color,
                "font-weight": font.bold ? "bold" : "normal",
                "font-style": font.italic ? "italic" : "normal"
            };
        });
    } else {
        var mapped = data.map(function(d) {
            return d.label + "#" + d.index;
        });
        settings.chartProp.info.satckSumFont = settings.chartProp.info.satckSumFont || {};
        g.selectAll(".sum-text").data(function(d) {
            var ret = d.series.filter(function(d) {
                return d.type === "series" && d.prop.seriesType === "bar" && !d.prop.hidden;
            });
            return [ _.sum(_.map(ret, "data")) ];
        }).enter().append("text").attr("y", function(d) {
            var yFun = y;
            return d >= 0 ? yFun(d > max ? max : d) : yFun(0);
        }).text(function(d, i) {
            return !settings.chartProp.info.satckSumShow ? "" : d === 0 ? "" : persian(d3.format(settings.chartProp.info.satckSumFont.formatString)(d), showPersian);
        }).attr("dy", "-0.3em").style("font-family", settings.chartProp.info.satckSumFont.fontName).style("font-size", settings.chartProp.info.satckSumFont.fontSize).attr("fill", settings.chartProp.info.satckSumFont.color).style("font-weight", settings.chartProp.info.satckSumFont.bold ? "bold" : "normal").style("font-style", settings.chartProp.info.satckSumFont.italic ? "italic" : "normal").attr("x", function(d) {
            var tw = d3.select(this).node().getBBox().width;
            return x.bandwidth() / 2 - tw / 2;
        });
        var gg = g.selectAll("nothings").data(function(d) {
            var ret = d.series.filter(function(d) {
                return d.type === "series" && d.prop.seriesType === "bar" && !d.prop.hidden;
            });
            var headers = d.series.map(function(d) {
                return d.label;
            });
            var values = d.series.map(function(d) {
                return d.data;
            });
            pushThenRow(ret, values, headers);
            return ret;
        }).enter().append("g");
        gg.attr("class", function(d) {
            return "series " + "series-" + d.sIndex;
        }).attr("transform", function(d, i) {
            return "translate(0,0)";
        });
        gg.append("rect").attr("width", x.bandwidth()).attr("fill", function(d, i) {
            var color = d.prop.seriesColor;
            if (d.thenRows) {
                $.each(d.thenRows, function(i, thenRow) {
                    $.each(thenRow, function(i, thenRowItem) {
                        if (d.label != thenRowItem.firstField) return true;
                        switch (+thenRowItem.operand) {
                          case 1:
                            color = thenRowItem.secondFieldColor;
                            break;
                        }
                    });
                });
            }
            return color;
        }).attr("y", function(d) {
            var yFun = y;
            if (secondaryY.enable && secondaryY.measures[d.seriesKey] == true) {
                yFun = y2;
            }
            return d.data >= 0 ? yFun(d.data > max ? max : d.data) : yFun(0);
        }).attr("height", function(d) {
            var yFun = y;
            if (secondaryY.enable && secondaryY.measures[d.seriesKey] == true) {
                yFun = y2;
            }
            return d.data > 0 ? yFun(Math.max(0, min)) - yFun(d.data > max ? max : d.data) : yFun(d.data < min ? min : d.data) - yFun(0);
        }).on("click", function(d) {
            if (isFromCommentDialog) {
                app.chartCommons.commentUtils.clickOnCommentIcon(d, settings.ChartInPageId);
            }
        });
        var texts = [ [] ];
        var texts = gg.append("text").attr("class", function(d) {
            return "" + "series-" + d.sIndex;
        }).text(function(d, i) {
            return !d.prop.showValues ? "" : d.data == 0 ? "" : persian(d3.format(getFormatString(d.prop.font, d.prop))(d.data), showPersian);
        }).attr("dy", "0.3em").style("font-family", function(d) {
            return d.prop.font.fontName;
        }).style("font-size", function(d) {
            return d.prop.font.fontSize;
        }).attr("fill", function(d) {
            return d.prop.font.color;
        }).style("font-weight", function(d) {
            return d.prop.font.bold ? "bold" : "normal";
        }).style("font-style", function(d) {
            return d.prop.font.italic ? "italic" : "normal";
        }).attr("x", function(d) {
            var tw = d3.select(this).node().getBBox().width;
            return x.bandwidth() / 2 - tw / 2;
        }).attr("y", function(d) {
            var yFun = y;
            if (secondaryY.enable && secondaryY.measures[d.seriesKey] == true) {
                yFun = y2;
            }
            var height = d.data > 0 ? yFun(Math.max(0, min)) - yFun(d.data > max ? max : d.data) : yFun(d.data < min ? min : d.data) - yFun(0);
            var yx = d.data >= 0 ? yFun(d.data > max ? max : d.data) : yFun(0);
            return yx + height / 2;
        });
        app.chartCommons.commentUtils.addCommentIcon(settings.ChartInPageId, gg, function(d) {
            return x.bandwidth() / 2 - 5;
        }, function(d) {
            var yFun = y;
            if (secondaryY.enable && secondaryY.measures[d.seriesKey] == true) {
                yFun = y2;
            }
            var height = d.data > 0 ? yFun(Math.max(0, min)) - yFun(d.data > max ? max : d.data) : yFun(d.data < min ? min : d.data) - yFun(0);
            var yx = d.data >= 0 ? yFun(d.data > max ? max : d.data) : yFun(0);
            return yx + height / 2 - 24;
        });
        if (isFromCommentDialog) {
            app.chartCommons.commentUtils.setOnHighlightListener(g.selectAll(".series"), settings.ChartInPageId);
        }
        var comments = gg.selectAll(".comment");
        var lastEnd = -999999;
        gg._groups.forEach(function(els, i) {
            var textGroup = texts[i] || [];
            var maxHeightPos = 0;
            var maxHeightNeg = 0;
            var xMid = 0;
            els = _.reverse(els);
            textGroup = _.reverse(textGroup);
            els.forEach(function(d, j) {
                var t = textGroup[j] || null;
                var val = d["__data__"]["data"];
                var h = d3.select(d).select("rect").attr("height");
                if (val >= 0) {
                    d3.select(d).attr("transform", function(d, i) {
                        return "translate(0," + maxHeightPos + ")";
                    });
                    maxHeightPos -= +h;
                } else {
                    d3.select(d).attr("transform", function(d, i) {
                        return "translate(0," + maxHeightNeg + ")";
                    });
                    maxHeightNeg += +h;
                }
            });
        });
    }
    var gg = g.selectAll("nothing").data(function(d) {
        return d.series.filter(function(d) {
            return d.type == "kpi" && d.prop.seriesType == "bar" && !d.prop.hidden;
        });
    }).enter().append("g").attr("class", "kpi").attr("transform", function(d, i) {
        return "translate(" + x0(d.label) + ",0)";
    });
    gg.append("rect").attr("width", x0.bandwidth()).attr("y", function(d) {
        return y(d.data[1] * 1.1);
    }).attr("height", function(d) {
        return barHeight + margin.top - y(d.data[1] * 1.1);
    }).attr("fill", "#eee");
    gg.append("rect").attr("width", x0.bandwidth()).attr("y", function(d) {
        return y(d.data[0]);
    }).attr("height", function(d) {
        return barHeight + margin.top - y(d.data[0]);
    }).attr("fill", function(d, i) {
        return colors(i);
    });
    gg.append("rect").attr("width", x0.bandwidth()).attr("y", function(d) {
        return y(d.data[1] * 1);
    }).attr("height", function(d) {
        return d.data[1] == 0 ? 0 : 2;
    }).attr("fill", "#333");
    var getStatusColor = function(val) {
        if (val > 0) {
            return "#71b37c";
        } else if (val == 0) {
            return "#8d8d8d";
        } else {
            return "#e14d57";
        }
    };
    gg.append("circle").attr("r", function(d) {
        return d.data[1] == 0 ? 0 : x0.bandwidth() / 2 < 5 ? x0.bandwidth() / 2 : 5;
    }).attr("fill", function(d) {
        return getStatusColor(d.data[1]);
    }).attr("cx", x0.bandwidth() / 2).attr("cy", function(d) {
        return y(d.data[1] * 1.1) - (x0.bandwidth() / 2 < 5 ? x0.bandwidth() / 2 : 5);
    });
    function getTooltipHtml(index, type, seriesType, indexOfSeries) {
        var rr = lineData;
        if (seriesType === "line") {
            index = lineData[indexOfSeries].values[index].dIndex;
        }
        var d = data[index].series;
        if (type === 1 && seriesType && typeof indexOfSeries !== "undefined") {
            d = d.filter(function(d) {
                return d.prop.seriesType === seriesType && !d.prop.hidden;
            });
            d = [ d[indexOfSeries] ];
        }
        if (type === 2) {
            d = d.filter(function(d) {
                return !d.prop.hidden;
            });
        }
        if (settings.chartProp.info.isBox) {
            var a = [];
            _.each(d, function(i) {
                _.each([ i.box.q1, i.box.q2, i.box.q3, i.box.min, i.box.max, i.box.avg ], function(item, i) {
                    var prefix = i == 0 ? "Q1" : i == 1 ? "Q2" : i == 2 ? "Q3" : i == 3 ? "MIN" : i == 4 ? "MAX" : i == 5 ? "AVG" : "";
                    a.push({
                        prop: item.prop,
                        data: item.data,
                        label: (item.prop.name || item.label) + " " + prefix,
                        format: getFormatString(item.prop),
                        color: item.prop.seriesColor
                    });
                });
            });
            d = a;
        }
        d = d.map(function(d) {
            return {
                data: d.data,
                label: d.prop.name || d.label,
                format: getFormatString(d.prop),
                color: d.prop.seriesColor
            };
        });
        return app.chartCommons.tooltip.tooltipFormatter({
            points: d,
            key: data[index].label,
            sum: d3.sum(d, function(d) {
                return d.data;
            }),
            avg: d3.sum(d, function(d) {
                return d.data;
            }) / d.length,
            format: d.length > 0 ? d[0].format : ",.2f"
        }, settings.chartProp.info.tooltipHeader, settings.chartProp.info.tooltipFormat, showPersian);
    }
    var colorStepGroup = chart.append("g");
    var areaGroup = chart.append("g");
    var lineGroup = chart.append("g");
    var circleGroup = chart.append("g");
    var lineData = getLineData(data);
    var lineInterpolate = d3.curveLinear;
    var area0 = d3.area().x(function(d) {
        return x(d.label) + x.bandwidth() / 2;
    }).y0(barHeight + margin.top).y1(y(min)).curve(lineInterpolate);
    var area = d3.area().x(function(d) {
        return x(d.label) + x.bandwidth() / 2;
    }).y0(barHeight + margin.top).y1(function(d) {
        var yFun = y;
        if (secondaryY.enable && secondaryY.measures[d.seriesKey] == true) {
            yFun = y2;
        }
        return yFun(d.value > max ? max : d.value < min ? min : d.value);
    }).curve(lineInterpolate);
    var line0 = d3.line().x(function(d) {
        return x(d.label) + x.bandwidth() / 2;
    }).y(function(d) {
        var yFun = y;
        var xMin = min;
        if (secondaryY.enable && secondaryY.measures[d.seriesKey] == true) {
            yFun = y2;
            xMin = y2Min;
        }
        return yFun(xMin);
    }).curve(lineInterpolate);
    var line = d3.line().x(function(d) {
        return Math.floor(x(d.label) + x.bandwidth() / 2);
    }).y(function(d) {
        var yFun = y;
        var xMin = min;
        var xMax = max;
        if (secondaryY.enable && secondaryY.measures[d.seriesKey] == true) {
            yFun = y2;
            xMin = y2Min;
            xMax = y2Max;
        }
        return Math.floor(yFun(d.value > xMax ? xMax : d.value < xMin ? xMin : d.value));
    }).curve(lineInterpolate);
    var temp = areaGroup.selectAll("nothings").data(lineData).enter().append("path").attr("class", function(d) {
        return "area " + " series-" + d.sIndex;
    }).attr("id", function(d, i) {
        return "area" + i;
    }).attr("fill", function(d, i) {
        if (!settings.chartProp.indicator || !settings.chartProp.indicator.length) return d.prop.seriesColor;
        return "url(#" + settings.id + "-" + i + ")";
    }).attr("z-index", "-1").style("opacity", function(d) {
        return d.prop.areaOpacity || .1;
    }).datum(function(d) {
        var ls = d.prop.lineType;
        if (ls == "line-dot-area" || ls == "line-area") return isStackLine ? d.valueStacked : d.values; else return 0;
    });
    if (animate) {
        temp.attr("d", function(d) {
            if (_.isArray(d) && d.length == 0) {
                return "M0,0";
            }
            return d === 0 ? "M0,0" : area0.curve(getCurve(d[0].prop.lineStyle))(d);
        }).transition().duration(settings.animationDuration).attr("d", function(d) {
            if (_.isArray(d) && d.length == 0) {
                return "M0,0";
            }
            return d === 0 ? "M0,0" : area.curve(getCurve(d[0].prop.lineStyle))(d);
        });
    } else {
        temp.attr("d", function(d) {
            if (_.isArray(d) && d.length == 0) {
                return "M0,0";
            }
            return d === 0 ? "M0,0" : area.curve(getCurve(d[0].prop.lineStyle))(d);
        });
    }
    function getCurve(s) {
        if (s == "linear") return d3.curveLinear;
        if (s == "cardinal") return d3.curveNatural;
        if (s == "step") return d3.curveStep;
        return d3.curveLinear;
    }
    temp = lineGroup.selectAll("nothings").data(lineData).enter().append("path").attr("class", function(d) {
        return "line " + " series-" + d.sIndex;
    }).attr("id", function(d, i) {
        return "line" + i;
    }).attr("stroke", function(d, i) {
        if (!settings.chartProp.indicator || !settings.chartProp.indicator.length) return d.prop.seriesColor;
        return "url(#" + settings.id + "-" + i + ")";
    }).attr("stroke-width", function(d, i) {
        return d.prop.lineWeight;
    }).attr("stroke-dasharray", function(d, i) {
        return d.prop.lineFace;
    }).datum(function(d) {
        var ls = d.prop.lineType;
        if (ls == "line-dot-area" || ls == "line-dot" || ls == "line-area" || ls == "line") return isStackLine ? d.valueStacked : d.values; else return 0;
    });
    if (animate) {
        temp.attr("d", function(d) {
            if (_.isArray(d) && d.length == 0) {
                return line0;
            }
            return d === 0 ? line0 : line0.curve(getCurve(d[0].prop.lineStyle))(d);
        }).transition().duration(settings.animationDuration).attr("d", function(d) {
            if (_.isArray(d) && d.length == 0) {
                return line;
            }
            return d === 0 ? line : line.curve(getCurve(d[0].prop.lineStyle))(d);
        });
    } else {
        temp.attr("d", function(d) {
            if (_.isArray(d) && d.length == 0) {
                return line;
            }
            return d === 0 ? line : line.curve(getCurve(d[0].prop.lineStyle))(d);
        });
    }
    var flag = settings.chartProp.globalvariable && settings.chartProp.globalvariable.length > 0 && !settings.editMode && settings.chartProp.globalvariable.filter(function(d) {
        return d.field == input.CurrentDimName;
    }).length > 0;
    var lineClickCallback = function(d, i) {
        if (isFromCommentDialog) {
            app.chartCommons.commentUtils.clickOnCommentIcon(d, settings.ChartInPageId);
            return;
        }
        if (settings.chartProp.globalvariable && settings.chartProp.globalvariable.length > 0 && !settings.editMode) {
            app.globalVariableHelper.updateGlobalVariables([ input.CurrentDimName ], [ d.primv ], settings.chartProp.globalvariable);
            $(selector + " .circle.selected-item").attr("class", $(this).attr("class").replace("selected-item", ""));
            $(selector + " .gd.selected-item").attr("class", $(this).attr("class").replace("selected-item", ""));
            $(this).attr("class", $(this).attr("class") + " selected-item");
        }
        if (d.onClickVal == "") {
            if (hasHref && !settings.editMode) {
                app.chartCommons.openLink(settings.chartProp.info.openDashboard, {
                    ChartInPageId: settings.ChartInPageId,
                    DataSourceId: settings.input.DataSourceId,
                    dimensionName: settings.input.dimensionName,
                    value: d.value,
                    refreshDatasource: settings.input.RefreshDatasource
                });
            }
            return;
        }
        if (isProgress()) return;
        showProgress(true);
        settings.isSort = is;
        app.chartCommons.drillDown.add(settings.ChartInPageId, settings.input.DataSourceId, settings.input.CurrentDimName, d.onClickVal, settings.input.RefreshDatasource);
        settings.parameters = {
            selectedItem: d.onClickVal,
            chartId: settings.chartId,
            ChartInPageId: settings.ChartInPageId,
            notEditMode: !settings.editMode
        };
        app.chartCommons.levelTypeUtils.getParam(settings);
        $(selector).charts(settings.type, "refreshWithData", settings);
        var is = sort.property("checked");
    };
    var transparentCircle = false;
    tempG = circleGroup.selectAll("nothings").data(lineData).enter().append("g").attr("class", function(d) {
        return "circle-group " + (d.onClickVal != "" || flag ? " pointer" : "");
    });
    var entries = tempG.selectAll(".entry").data(function(d) {
        return isStackLine ? d.valueStacked : d.values;
    }).enter().append("g").attr("class", "entry");
    var temp = entries.append("circle").attr("class", function(d) {
        return "circle" + " series-" + d.sIndex;
    }).attr("stroke", function(d, i) {
        var ret = [ d ];
        var label = d3.select(this.parentNode).datum().seriesLable;
        var headers = data[i].series.map(function(d) {
            return d.label;
        });
        var values = data[i].series.map(function(d) {
            return d.data;
        });
        var tarr = app.chartCommons.indicator.getIndicator(values, headers, settings.chartProp.indicator);
        var color = d.prop.seriesColor;
        var dx = _.flatten(tarr);
        _.each(dx, function(thenRowItem) {
            if (label !== thenRowItem.firstField) return true;
            switch (+thenRowItem.operand) {
              case 1:
                color = thenRowItem.secondFieldColor;
                break;
            }
        });
        return color;
    }).attr("stroke-width", function(d, i) {
        return d.prop.lineWeight;
    }).on("click", lineClickCallback).on("mouseover", function(d) {
        d3.select(this).attr("stroke-width", parseInt(d.prop.lineWeight) + 3);
    }).on("mouseout", function(d) {
        d3.select(this).attr("stroke-width", d.prop.lineWeight);
    }).attr("cx", function(d) {
        return line.curve(getCurve(d.prop.lineStyle)).x()(d);
    }).style("opacity", function() {
        var ls = d3.select(this.parentNode).datum().prop.lineType;
        if (ls == "line-area" || ls == "line") return 0;
        return 1;
    }).attr("r", "4");
    if (animate) {
        temp.attr("cy", y(min)).transition().duration(settings.animationDuration).attr("cy", function(d) {
            return line.curve(getCurve(d.prop.lineStyle)).y()(d);
        });
    } else {
        temp.attr("cy", function(d) {
            return line.curve(getCurve(d.prop.lineStyle)).y()(d);
        });
    }
    app.chartCommons.commentUtils.addCommentIcon(settings.ChartInPageId, entries, function(d) {
        return line.curve(getCurve(d.prop.lineStyle)).x()(d) - 5;
    }, function(d) {
        return line.curve(d.prop.lineStyle).y()(d) - 24;
    });
    if (isFromCommentDialog) {
        var t = tempG.selectAll(".entry");
        app.chartCommons.commentUtils.setOnHighlightListener(tempG.selectAll(".entry"), settings.ChartInPageId);
    }
    if (settings.chartProp.indicator && settings.chartProp.indicator.length) colorStepGroup.attr("class", "colorStepGroups").selectAll(".colorStepGroup").data(lineData).enter().append("linearGradient").attr("id", function(d, i) {
        return settings.id + "-" + i;
    }).attr("class", "colorStepGroup").attr("gradientUnits", function(d) {
        var t = _.filter(settings.chartProp.indicator, function(item) {
            return _.map(item.thenRow, "firstField").indexOf(d.label) !== -1;
        });
        return t.length ? "objectBoundingBox" : "userSpaceOnUse";
    }).selectAll("stop-color").data(function(d) {
        var r = [];
        var unit = 1 / ((d.values.length - 1) * 2);
        var sum = -1 * unit;
        d.values.map(function(dd, i) {
            var e = {
                value: dd.value,
                label: d.label,
                color: d.prop.seriesColor
            };
            var ret = [ e ];
            var headers = data[i].series.map(function(d) {
                return d.label;
            });
            var values = data[i].series.map(function(d) {
                return d.data;
            });
            var tarr = app.chartCommons.indicator.getIndicator(values, headers, settings.chartProp.indicator);
            var color = d.prop.seriesColor;
            var dx = _.flatten(tarr);
            _.each(dx, function(thenRowItem) {
                if (e.label !== thenRowItem.firstField) return true;
                switch (+thenRowItem.operand) {
                  case 1:
                    color = thenRowItem.secondFieldColor;
                    break;
                }
            });
            e.color = color;
            e.offset = sum < 0 ? 0 : sum;
            r.push(e);
            e = $.extend({}, e);
            sum += unit * 2;
            e.offset = sum > 1 ? sum - unit : sum;
            r.push(e);
        });
        return r;
    }).enter().append("stop").attr("stop-color", function(d, i) {
        var color = d.color;
        return color;
    }).attr("offset", function(d) {
        return d.offset;
    });
    temp = circleGroup.selectAll("nothings").data(lineData).enter().append("g").attr("class", function(d) {
        return "text-vals";
    }).selectAll("text").data(function(d) {
        return d.prop.showValues ? isStackLine ? d.valueStacked : d.values : 0;
    }).enter().append("text").text(function(d) {
        return persian(d3.format(getFormatString(d.prop.font, d.prop))(d.valueLabel), showPersian);
    }).attr("class", function(d) {
        return "text-value pointer" + " series-" + d.sIndex;
    }).style("font-family", function(d) {
        return d.prop.font.fontName;
    }).style("font-size", function(d) {
        return d.prop.font.fontSize;
    }).attr("fill", function(d) {
        return d.prop.font.color;
    }).style("font-weight", function(d) {
        return d.prop.font.bold ? "bold" : "normal";
    }).style("font-style", function(d) {
        return d.prop.font.italic ? "italic" : "normal";
    }).style("text-anchor", app.lang.isRtl() ? "start" : "end").attr("dy", "-10").attr("dy", "-10").attr("x", function(d, i) {
        var w = d3.select(this).node().getBBox().width;
        var h = d3.select(this).node().getBBox().height;
        var p = x(mapped[i]);
        var y = line.curve(getCurve(d.prop.lineStyle)).y()(d);
        return line.curve(getCurve(d.prop.lineStyle)).x()(d) - w / 2;
    }).on("click", lineClickCallback);
    if (animate) {
        temp.attr("y", y(min)).transition().duration(settings.animationDuration).attr("y", function(d) {
            return line.curve(getCurve(d.prop.lineStyle)).y()(d);
        });
    } else {
        temp.attr("y", function(d) {
            return line.curve(getCurve(d.prop.lineStyle)).y()(d);
        });
    }
    function getGravity(el) {
        return window.innerWidth - el[0].getBoundingClientRect().left < 300 ? "e" : "w";
    }
    $(selector + " .circle").each(function() {
        var e = $(this);
        $(this).tipsy({
            gravity: getGravity(e),
            html: true,
            title: function() {
                var type = +settings.chartProp.info.tooltip || 1;
                var r = "";
                var index = $(this).parent("g.entry").index();
                var indexOfLine = $(this).parents("g.circle-group").index();
                r = getTooltipHtml(index, type, "line", indexOfLine);
                return r;
            }
        });
    });
    $(selector + " .text-value").each(function() {
        var e = $(this);
        $(this).tipsy({
            gravity: getGravity(e),
            html: true,
            title: function() {
                var type = +settings.chartProp.info.tooltip || 1;
                var r = "";
                var index = $(this).index();
                var indexOfLine = $(this).parent("g.text-vals").index() - $(this).parent("g.text-vals").parent().children().length / 2;
                r = getTooltipHtml(index, type, "line", indexOfLine);
                return r;
            }
        });
    });
    sort.on("change", change);
    sortSelector.on("change", change);
    var firstRun = true;
    var sortTimeout = setTimeout(function() {
        if (settings.isSort) sort.property("checked", true).each(change); else sort.each(change);
        firstRun = false;
    }, 0);
    function getLineData(data) {
        var lineMeasures = data[0].series.filter(function(d, i) {
            return d.prop.seriesType == "line" && !d.prop.hidden;
        });
        var res = lineMeasures.map(function(d, i) {
            var r = {
                sIndex: d.sIndex,
                label: d.label,
                prop: d.prop,
                values: data.map(function(dd, ii) {
                    var r = {
                        sIndex: d.sIndex,
                        dIndex: dd.index,
                        label: dd.label + "#" + dd.index,
                        value: dd.series.filter(function(ddd, iii) {
                            return ddd.label == d.label;
                        })[0].data,
                        valueLabel: dd.series.filter(function(ddd, iii) {
                            return ddd.label == d.label;
                        })[0].data,
                        prop: dd.series.filter(function(ddd, iii) {
                            return ddd.label == d.label;
                        })[0].prop,
                        onClickVal: dd.onClickVal,
                        primv: dd.value,
                        category: dd.label,
                        commentCount: dd.series.filter(function(ddd, iii) {
                            return ddd.label == d.label;
                        })[0].commentCount,
                        seriesLable: d.label,
                        seriesKey: d.key
                    };
                    return r;
                }),
                valueStacked: data.map(function(dd, ii) {
                    return {
                        sIndex: d.sIndex,
                        label: dd.label + "#" + dd.index,
                        valueLabel: dd.series.filter(function(ddd, iii) {
                            return ddd.label == d.label;
                        })[0].data,
                        value: dd.series.filter(function(ddd, iii) {
                            return ddd.label == d.label;
                        })[0].data,
                        prop: dd.series.filter(function(ddd, iii) {
                            return ddd.label == d.label;
                        })[0].prop,
                        onClickVal: dd.onClickVal,
                        primv: dd.value
                    };
                })
            };
            return r;
        });
        var sum = res.length == 0 ? [] : res[0].valueStacked.map(function(d) {
            return Math.abs(d.value);
        });
        res.forEach(function(item, i) {
            if (i == 0) return;
            var beforeEl = res[i - 1];
            item.valueStacked.forEach(function(d, j) {
                sum[j] += Math.abs(d.value);
                d.value += beforeEl.valueStacked[j].value;
            });
        });
        if (isStackLinePercent) {
            res.forEach(function(item, i) {
                item.valueStacked.forEach(function(d, j) {
                    d.value = d.value / sum[j] * 100;
                });
            });
        }
        res.forEach(function(r, i) {
            r.values = r.values.filter(function(d) {
                return d.value !== "";
            });
            r.valueStacked = r.valueStacked.filter(function(d) {
                return d.value !== "";
            });
            if (r.prop.dontShowZeroValue) {
                r.values = r.values.filter(function(d) {
                    return d.value != null && d.value != 0;
                });
                r.valueStacked = r.valueStacked.filter(function(d) {
                    return d.value != null && d.value != 0;
                });
            }
        });
        return res;
    }
    function change() {
        clearTimeout(sortTimeout);
        bol = sort.property("checked");
        settings.isSort = bol;
        var index = sortSelector._groups[0][0].selectedIndex;
        var indexVal = sortSelector._groups[0][0].value;
        var df = sortSelector._groups[0][0];
        var isKpi = true;
        if (index >= kpisLabels.length) isKpi = false;
        x.domain(settings.isSort ? data.sort(function(a, b) {
            na = a.series.filter(function(d) {
                return d.label == indexVal;
            });
            nb = b.series.filter(function(d) {
                return d.label == indexVal;
            });
            if (!(na instanceof Array)) return 0;
            na = na[0];
            nb = nb[0];
            if (na.type == "series") {
                return nb.data - na.data;
            } else {
                return nb.data[0] - na.data[0];
            }
            return isKpi ? b.series.filter(function(d) {
                return d.label == indexVal;
            }).data[0] - a.series.filter(function(d) {
                return d.label == indexVal;
            }).data[0] : b.series.filter(function(d) {
                return d.label == indexVal;
            }).data - a.series.filter(function(d) {
                return d.label == indexVal;
            }).data;
        }).map(function(d) {
            return d.label + "#" + d.index;
        }) : data.sort(function(a, b) {
            return a.index - b.index;
        }).map(function(d) {
            return d.label + "#" + d.index;
        }));
        xtrim.domain(settings.isSort ? data.filter(sample).sort(function(a, b) {
            na = a.series.filter(function(d) {
                return d.label == indexVal;
            });
            nb = b.series.filter(function(d) {
                return d.label == indexVal;
            });
            if (!(na instanceof Array)) return 0;
            na = na[0];
            nb = nb[0];
            if (na.type == "series") {
                return nb.data - na.data;
            } else {
                return nb.data[0] - na.data[0];
            }
            return isKpi ? b.series.filter(function(d) {
                return d.label == indexVal;
            }).data[0] - a.series.filter(function(d) {
                return d.label == indexVal;
            }).data[0] : b.series.filter(function(d) {
                return d.label == indexVal;
            }).data - a.series.filter(function(d) {
                return d.label == indexVal;
            }).data;
        }).map(function(d) {
            return d.label + "#" + d.index;
        }) : data.filter(sample).sort(function(a, b) {
            return a.index - b.index;
        }).map(function(d) {
            return d.label + "#" + d.index;
        }));
        var transition = svg.transition().duration(settings.animationDuration), delay = function(d, i) {
            return !needAnimation ? 0 : i * 50;
        };
        transition.on("end", function() {
            $(selector + " .kpi").each(function() {
                var e = $(this);
                $(this).tipsy({
                    gravity: getGravity(e),
                    html: true,
                    title: function() {
                        var type = +settings.chartProp.info.tooltip || 1;
                        var index = data.map(function(d) {
                            return d.index;
                        }).indexOf($(this).parent(".gd").get(0).__data__.index);
                        return getTooltipHtml(index, type, "bar", $(this).index());
                    }
                });
            });
            $(selector + " .series").each(function() {
                var e = $(this);
                $(this).tipsy({
                    gravity: getGravity(e),
                    html: true,
                    title: function() {
                        var arr = data.map(function(d) {
                            return d.index;
                        });
                        var item = $(this).parent(".gd").get(0) || $(this).parent(".gd-text").get(0);
                        var el = item.__data__.index;
                        var type = +settings.chartProp.info.tooltip || 1;
                        var index = arr.indexOf(el);
                        var t = getTooltipHtml(index, type, "bar", $(this).index());
                        return t;
                    }
                });
            });
            $(selector + " .gd-text text").each(function() {
                var e = $(this);
                $(this).tipsy({
                    gravity: getGravity(e),
                    html: true,
                    title: function() {
                        var type = +settings.chartProp.info.tooltip || 1;
                        var index = data.map(function(d) {
                            return d.index;
                        }).indexOf($(this).parent(".gd-text").get(0).__data__.index);
                        return getTooltipHtml(index, type, "bar", $(this).index());
                    }
                });
            });
        });
        transition.selectAll(".gd").delay(delay).attr("transform", function(d) {
            return "translate(" + x(d.label + "#" + d.index) + ",0)";
        });
        transition.selectAll(".gd-text").delay(delay).attr("transform", function(d) {
            return "translate(" + x(d.label + "#" + d.index) + ",0)";
        });
        var lineData = getLineData(data);
        svg.selectAll(".area").data(lineData).datum(function(d) {
            var ls = d.prop.lineType;
            if (ls == "line-dot-area" || ls == "line-area") return isStackLine ? d.valueStacked : d.values; else return 0;
        }).transition().duration(settings.animationDuration).attr("d", function(d) {
            if (_.isArray(d) && d.length == 0) {
                return "M0,0";
            }
            return d === 0 ? "M0,0" : area.curve(getCurve(d[0].prop.lineStyle))(d);
        });
        svg.selectAll(".line").data(lineData).datum(function(d) {
            var ls = d.prop.lineType;
            if (ls == "line-dot-area" || ls == "line-dot" || ls == "line-area" || ls == "line") return isStackLine ? d.valueStacked : d.values; else return 0;
        }).transition().duration(settings.animationDuration).attr("d", function(d) {
            if (_.isArray(d) && d.length == 0) {
                return "M0,0";
            }
            return d === 0 ? "M0,0" : line.curve(getCurve(d[0].prop.lineStyle))(d);
        });
        svg.selectAll(".circle-group").data(lineData).selectAll(".circle").data(function(d) {
            var ls = d.prop.lineType;
            if (ls == "line-dot-area" || ls == "line-dot" || ls == "dot") return isStackLine ? d.valueStacked : d.values; else return 0;
        }).transition().duration(settings.animationDuration).attr("stroke", function(d, i) {
            var ret = [ d ];
            var label = d3.select(this.parentNode).datum().seriesLable;
            var headers = data[i].series.map(function(d) {
                return d.label;
            });
            var values = data[i].series.map(function(d) {
                return d.data;
            });
            pushThenRow(ret, values, headers);
            d = ret[0];
            var color = d.prop.seriesColor;
            if (d.thenRows) {
                $.each(d.thenRows, function(i, thenRow) {
                    $.each(thenRow, function(i, thenRowItem) {
                        if (label != thenRowItem.firstField) return true;
                        switch (+thenRowItem.operand) {
                          case 1:
                            color = thenRowItem.secondFieldColor;
                            break;
                        }
                    });
                });
            }
            return color;
        }).attr("cx", function(d) {
            return line.curve(getCurve(d.prop.lineStyle)).x()(d);
        }).attr("cy", function(d) {
            return line.curve(getCurve(d.prop.lineStyle)).y()(d);
        });
        svg.selectAll(".text-vals").data(lineData).selectAll(".text-value").data(function(d) {
            var ls = d.prop.lineType;
            if (ls == "line-dot-area" || ls == "line-dot" || ls == "dot") return isStackLine ? d.valueStacked : d.values; else return 0;
        }).transition().duration(settings.animationDuration).attr("x", function(d) {
            try {
                var w = d3.select(this).node().getBBox().width;
                return line.curve(getCurve(d.prop.lineStyle)).x()(d) - w / 2;
            } catch (e) {
                return 0;
            }
        }).text(function(d) {
            return persian(d3.format(getFormatString(d.prop.font, d.prop))(d.valueLabel), showPersian);
        }).attr("dy", "-10").attr("y", function(d) {
            return line.curve(getCurve(d.prop.lineStyle)).y()(d);
        });
        svg.selectAll(".colorStepGroup").data(lineData).selectAll("stop").data(function(d) {
            var r = [];
            var unit = 1 / ((d.values.length - 1) * 2);
            var sum = -1 * unit;
            d.values.map(function(dd, i) {
                var e = {
                    value: dd.value,
                    label: d.label,
                    color: d.prop.seriesColor
                };
                var ret = [ e ];
                var headers = data[i].series.map(function(d) {
                    return d.label;
                });
                var values = data[i].series.map(function(d) {
                    return d.data;
                });
                pushThenRow(ret, values, headers);
                e = ret[0];
                e.offset = sum < 0 ? 0 : sum;
                r.push(e);
                e = $.extend({}, e);
                sum += unit * 2;
                e.offset = sum > 1 ? sum - unit : sum;
                r.push(e);
            });
            return r;
        }).transition().attr("stop-color", function(d, i) {
            var color = d.color;
            if (d.thenRows) {
                $.each(d.thenRows, function(i, thenRow) {
                    $.each(thenRow, function(i, thenRowItem) {
                        if (d.label != thenRowItem.firstField) return true;
                        switch (+thenRowItem.operand) {
                          case 1:
                            color = thenRowItem.secondFieldColor;
                            break;
                        }
                    });
                });
            }
            return color;
        }).attr("offset", function(d) {
            return d.offset;
        });
        transition.select(".x.axis").call(xAxis).selectAll("g").delay(delay);
        transition.select(".x.axis").selectAll("g text").attr("class", "axes-x-label").attr("x", "0").attr("dy", "0").attr("y", "0").style("transform", rotateV2()).style("font-family", settings.chartProp.info.font.fontName).style("font-size", settings.chartProp.info.font.fontSize).attr("fill", settings.chartProp.info.font.color).style("font-weight", settings.chartProp.info.font.bold ? "bold" : "normal").style("font-style", settings.chartProp.info.font.italic ? "italic" : "normal").delay(delay);
        svg.select(".x.axis").selectAll("g text").style("font-family", settings.chartProp.info.font.fontName).style("font-size", settings.chartProp.info.font.fontSize).attr("fill", settings.chartProp.info.font.color).style("font-weight", settings.chartProp.info.font.bold ? "bold" : "normal").style("font-style", settings.chartProp.info.font.italic ? "italic" : "normal").style("text-anchor", "end").attr("x", "0").attr("dy", "0").attr("y", "0").styles(rotateV2()).append("title").text(function(d) {
            return persian(d.replace(new RegExp("#\\d+$"), ""), showPersian);
        });
    }
    $(selector).trigger("heightChange");
};

var chartTypes = {
    BAR: 1,
    PIE: 2,
    LINE: 3,
    GAUGE: 4,
    TABLE: 5,
    MAP: 6,
    UserControl: 7,
    Radar: 8,
    Tree: 9,
    Text: 10,
    CE_MAP: {
        1: "barLine",
        2: "pie",
        4: "gauge",
        5: "table",
        6: "map",
        7: "userControl",
        8: "radar",
        9: "tree",
        10: "text"
    },
    NAMES: {
        1: "نمودار خطی-میله‌ای",
        2: "نمودار دایره‌ای",
        4: "نمودار عقربه‌ای",
        5: "جدول",
        7: "کنترل کاربری",
        8: "نمودار رادار",
        9: "نمودار درختی",
        10: "متن"
    }
};

(function($) {
    var defaultSettings = {
        isSort: false,
        fadeSpeed: 200,
        fadeinEasing: "easeInOutCubic",
        chartId: -1,
        animationDuration: 1e3,
        animationEase: "cubic-out"
    };
    jQuery.fn.charts = function(type, methodName) {
        var methods = {
            init: init,
            refresh: refresh,
            refreshWithData: refreshWithData,
            abort: abort
        };
        if (methods[methodName]) {
            var args = Array.prototype.slice.call(arguments, 0);
            var methodName = args.splice(1, 1);
            return methods[methodName].apply(this, args);
        } else if (typeof method == "object" || typeof method == "undefined" || !methodName) {
            return methods.init.apply(this, arguments);
        } else $.Error("Method " + methodName + " does not exist on jQuery.sitBarChart: you must specify type");
    };
    function refresh(type, options, redrowAll) {
        var settings = $(this).data("settings");
        if (typeof settings == "undefined") return;
        settings.isRefresh = true;
        settings = $.extend(settings, options);
        if (settings.chartProp.info.disable && !settings.editMode) {
            showDisableMessage(settings);
            return;
        }
        setTimeout(function() {
            draw(type, settings.input, settings, true, redrowAll);
            settings.parameters.selectedItem = null;
            settings.parameters.isUp = false;
        }, 0);
        return this;
    }
    function invalidateBackground(settings) {
        if (!settings.editMode) return;
        var info = settings.chartProp.info || {};
        if (settings.type.isCustom) {
            info = settings.chartProp.general.info || {};
        }
        var div = $("#" + settings.id).parents(".chart-widget");
        if (info.backgroundColor) {
            div.find(".ui.card ").css("background", info.backgroundColor);
        }
        if (info.dontShowTitle === true) {
            div.find(".ui.card .title-content").hide();
        } else {
            div.find(".ui.card .title-content").show();
        }
        if (info.titleFont) {
            div.find(".ui.card .title-content").css({
                "font-size": info.titleFont.fontSize,
                color: info.titleFont.color,
                "font-family": info.titleFont.fontName,
                "font-weight": info.titleFont.bold ? "bold" : "normal",
                "font-style": info.titleFont.italic ? "italic" : "normal"
            });
            div.find(".ui.card .title").css({
                "text-align": info.titleFont.align
            });
        }
    }
    function abort($e) {
        var ajaxRequest = $e.data("ajaxRequest");
        if (ajaxRequest != null) ajaxRequest.abort();
        return this;
    }
    function refreshRelatedDatasources(settings) {
        $(".bar-chart").each(function() {
            var s = $(this).data("settings");
            if (typeof s.input != "undefined" && typeof s.input.RefreshDatasource != "undefined") {
                if (+s.ChartInPageId == +settings.ChartInPageId) return;
                s.titlebar.showProgress(true);
                $(this).charts(s.type, "refreshWithData", s, {
                    refreshRelatedDatasources: false
                });
            }
        });
        app.filterBox.refresh();
    }
    function refreshWithData(type, options, opts) {
        abort($(this));
        opts = $.extend({
            refreshRelatedDatasources: true
        }, opts);
        var $el = $(this);
        var settings = $(this).data("settings");
        settings = $.extend(settings, options);
        settings.isRefresh = false;
        if (typeof settings.chartProp == "undefined") {
            return;
        }
        if (typeof type.isCustom == "undefined") {
            type = {
                id: +type,
                isCustom: false
            };
        }
        if (settings.chartProp.info.disable && !settings.editMode) {
            showDisableMessage(settings);
            return;
        }
        app.chartCommons.setFilterParameter(settings);
        settings.parameters.filterHierarchy = app.chartCommons.getFilterHierarchy(settings.ChartInPageId);
        if (settings.editMode) {
            settings.parameters.ChartInfo = $("#divChart").data("chartInfo");
        }
        var resultRows = [];
        if (type.id == chartTypes.TABLE) {
            for (var prop in settings.chartProp.series) {
                if (settings.chartProp.series.hasOwnProperty(prop)) {
                    resultRows.push({
                        Name: prop,
                        Type: settings.chartProp.series[prop].rowResult
                    });
                }
            }
        }
        settings.dataUrl = getDataUrl(type);
        var caller = app.mobileMode ? proxy.ajax : $.ajax;
        var d = $.extend(settings.parameters, {
            resultRows: resultRows,
            type: settings.dataType
        });
        var data = JSON.stringify(d);
        if (opts.refreshRelatedDatasources) {
            if (settings.ChartInPageId) {
                app.moderation.dashboadpage.refreshRelatedDatasources(settings.input.RefreshDatasource, [ +settings.ChartInPageId ]);
                if (app.filterBox && app.filterBox.refresh) app.filterBox.refresh();
            }
        }
        var ajaxRequest = caller({
            url: settings.dataUrl,
            type: "POST",
            dataType: "json",
            contentType: "application/json",
            data: data,
            async: settings.async,
            requestId: settings.requestId,
            success: function(input) {
                draw(type, input, settings, true);
                settings.parameters.selectedItem = null;
                settings.parameters.isUp = false;
            }
        });
        $(this).data("ajaxRequest", ajaxRequest);
        return this;
    }
    function showDisableMessage(settings) {
        var selector = "#" + settings.id;
        $(selector).empty();
        $(selector).html('<div class="temporal" style="display: flex;justify-content: center;flex-direction: column;text-align: center; align-items: center;flex: 1">                <img style="margin:12px;"width="32" src="' + app.urlPrefix + 'images/barricade-256.png"/>                <p>نمودار در حال تغییر است</p>            </div > ');
    }
    function init(type, options) {
        var settings = $.extend({}, defaultSettings, options);
        var $this = $(this);
        settings.id = $this.attr("id");
        settings.type = type;
        $this.data("isChart", true);
        $this.data("settings", settings);
        if (typeof type.isCustom === "undefined") {
            type = {
                id: +type,
                isCustom: false
            };
        }
        if (settings.chartProp.info.disable && !settings.editMode) {
            showDisableMessage(settings);
            return;
        }
        app.chartCommons.setFilterParameter(settings);
        app.chartCommons.levelTypeUtils.getParam(settings);
        type = settings.type;
        var resultRows = [];
        if (type.id == chartTypes.TABLE) {
            for (var prop in settings.chartProp.series) {
                if (settings.chartProp.series.hasOwnProperty(prop)) {
                    resultRows.push({
                        Name: prop,
                        Type: settings.chartProp.series[prop].rowResult
                    });
                }
            }
        }
        settings.dataUrl = getDataUrl(type);
        var caller = app.mobileMode ? proxy.ajax : $.ajax;
        var d = $.extend(settings.parameters, {
            resultRows: resultRows,
            type: settings.dataType
        });
        var data = JSON.stringify(d);
        var config = app.customChart.getConfig(type);
        if (config.needData === false) {
            draw(type, {
                result: true
            }, settings, false);
        } else {
            var ajaxRequest = caller({
                url: settings.dataUrl,
                type: "POST",
                dataType: "json",
                data: data,
                success: function(input, isOnline, date) {
                    settings.mobileModeData = {
                        isOnline: isOnline,
                        date: date
                    };
                    if (typeof settings.chartProp == "undefined" && input.detail) {
                        settings = $.extend(settings, JSON.parse(input.detail));
                    }
                    if (settings.beforeDraw) settings.beforeDraw(settings);
                    draw(type, input, settings, false);
                    settings.parameters.selectedItem = null;
                    settings.parameters.isUp = false;
                },
                cache: false,
                contentType: "application/json",
                error: function(d) {
                    if (settings.error) settings.error(settings);
                    if (!app.mobileMode && d && d.responseJSON && d.responseJSON.forceSignout) {
                        console.log("شما از برنامه خارج شده‌اید. ممکن است کاربر دیگری با نام کاربری شما وارد سیستم شده باشد.");
                        alert("شما از برنامه خارج شده‌اید. ممکن است کاربر دیگری با نام کاربری شما وارد سیستم شده باشد.");
                        window.location.href = app.urlPrefix;
                    }
                    var selector = "#" + settings.id;
                    $(selector).addClass("bar-chart").empty();
                    if (d && d.responseJSON && d.responseJSON.desc) {
                        $(selector).addClass("bar-chart").html(filterXSS("<b>" + d.responseJSON.title + ' </b>  <span class="glyphicon glyphicon-info-sign"> </span> <br/ > <p style="direction:ltr;">' + d.responseJSON.desc + "</p>"));
                    } else {
                        $(selector).addClass("bar-chart").html('خطا در دریافت اطلاعات <span class="glyphicon glyphicon-info-sign"> </span>');
                    }
                    $(selector).css({
                        display: "flex",
                        overflow: "auto",
                        padding: "20px 14px",
                        "flex-flow": "column"
                    });
                },
                requestId: settings.requestId
            });
            $(this).data("ajaxRequest", ajaxRequest);
        }
        return $this;
    }
    function getDataUrl(type) {
        if (type.isCustom) {
            return app.urlPrefix + "api/chartdata/getdata";
        }
        switch (parseInt(type.id)) {
          case chartTypes.UserControl:
            return app.urlPrefix + "api/chartdata/GetColumnMembers";

          case chartTypes.Tree:
            return app.urlPrefix + "Charts/BarChart/getTreeData";

          default:
            return app.urlPrefix + "api/chartdata/getdata";
        }
    }
    function draw(type, input, settings, refreshWithDataFlag, redrowAll) {
        if (!settings.editMode) {
            dashboard.setLastRefresh(settings.ChartInPageId, input.LastRefresh);
        }
        invalidateBackground(settings);
        settings.input = input;
        if (arguments.length < 4) {
            $.error("تعداد پارامترها باید حداقل چهار تا باشد");
            return;
        }
        if (typeof settings.chartProp == "undefined") {
            return;
        }
        settings.chartProp = _.extend({
            info: {}
        }, settings.chartProp);
        var refreshPeriod = 0;
        if (settings.chartProp.info.refreshPeriod) {
            refreshPeriod = +settings.chartProp.info.refreshPeriod;
        }
        if (settings.type.isCustom && settings.chartProp.general.info) {
            refreshPeriod = +settings.chartProp.general.info.refreshPeriod;
        }
        if (refreshPeriod > 0) {
            var lastTimeout = $("#" + settings.id).data("timeout");
            if (lastTimeout) clearTimeout(lastTimeout);
            var timeout = setTimeout(function() {
                $("#" + settings.id).charts(type, "refreshWithData", null, {
                    refreshRelatedDatasources: false
                });
            }, refreshPeriod * 1e3);
            $("#" + settings.id).data("timeout", timeout);
        }
        $("#dashboard-chart-panel").trigger("chartComplete", [ settings, input ]);
        var selector = "#" + settings.id;
        if (refreshWithDataFlag && !redrowAll) {
            $(selector).parents(".chart-widget").find(".temporal").remove();
        } else {
            $(selector).addClass("bar-chart").empty();
        }
        if (settings.fromCommentDialog) {
            $(selector).addClass("fromCommentDialog");
        }
        input = $.extend({
            EditPermission: false,
            Description: "",
            LastRefresh: 0,
            isFresh: true,
            title: ""
        }, input);
        var titlebar = {
            title: null,
            showProgress: function() {},
            isProgress: function() {}
        };
        titlebar = d3.select(selector).titlebar({
            EditPermission: input.EditPermission,
            editLink: settings.editLink,
            RemoveFromPage: settings.RemoveFromPage,
            deleteLink: settings.removeLink,
            desc: input.Description,
            LastRefresh: input.LastRefresh,
            isFresh: input.isFresh,
            title: input.title,
            chartId: settings.chartId,
            ChartInPageId: settings.ChartInPageId,
            type: type,
            editMode: settings.editMode,
            refreshWithData: refreshWithDataFlag,
            redrowAll: redrowAll,
            settings: settings,
            showFilterIcon: typeof settings.chartProp.info.showFilterIcon == "undefined" ? 1 : +settings.chartProp.info.showFilterIcon
        });
        settings.titlebar = titlebar;
        titlebar.showProgress(false);
        if (!input.result) {
            $("#" + settings.id).append(app.chartCommons.getError(input));
            $("#" + settings.id).css({
                display: "flex",
                overflow: "auto",
                padding: "20px 14px",
                "flex-flow": "column"
            });
            return;
        }
        if (typeof type.isCustom == "undefined") {
            type = {
                id: +type,
                isCustom: false
            };
        }
        if (type.isCustom) {
            settings.selector = "#" + settings.id;
            var seriesLabels = typeof input.series !== "undefined" ? input.series.labels : [];
            var kpisLabels = typeof input.kpis !== "undefined" ? input.kpis.labels : [];
            if (settings.editMode) {
                $(settings.selector).trigger("chartproperty", [ kpisLabels.concat(seriesLabels) ]);
            }
            app.customChart.charts[type.id](input, settings, refreshWithDataFlag, titlebar);
            return;
        }
        switch (parseInt(type.id)) {
          case chartTypes.BAR:
            app.charts.bar.draw(input, settings, refreshWithDataFlag, titlebar);
            break;

          case chartTypes.GAUGE:
            app.charts.gauge.draw(input, settings, refreshWithDataFlag, titlebar);
            break;

          case chartTypes.PIE:
            app.charts.pie.draw(input, settings, refreshWithDataFlag, titlebar);
            break;

          case chartTypes.TABLE:
            app.charts.table.draw(input, settings, refreshWithDataFlag, titlebar);
            break;

          case chartTypes.MAP:
            app.charts.map.draw(input, settings, refreshWithDataFlag, titlebar);
            break;

          case chartTypes.UserControl:
            app.charts.userControl.draw(input, settings, refreshWithDataFlag, titlebar);
            break;

          case chartTypes.Radar:
            app.charts.radar.draw(input, settings, refreshWithDataFlag, titlebar);
            break;

          case chartTypes.Tree:
            app.charts.tree.draw(input, settings, refreshWithDataFlag, titlebar);
            break;

          case chartTypes.Text:
            app.charts.text.draw(input, settings, refreshWithDataFlag, titlebar);
            break;

          default:        }
        app.lang.setLang({
            selector: selector
        });
        if (settings.finishDraw) settings.finishDraw(settings);
        app.chartCommons.renderComments(settings, input);
    }
    app.chartCommons.draw = draw;
    app.customChart = {
        cacheJs: {},
        charts: {},
        getJs: function(id, success, fail) {
            if (typeof app.customChart.cacheJs[id] != "undefined") {
                success(app.customChart.cacheJs[id]);
                return;
            }
            $.ajax({
                url: app.urlPrefix + "api/customcharts/getjs/" + id,
                cache: true
            }).done(function(data) {
                app.customChart.cacheJs[id] = data;
                var $script = $("head script#id-" + id);
                if (!$script.length) {
                    $("head").append("<script id=" + "id-" + id + ">" + " app.customChart.charts[" + id + "] = function(input, settings, refreshWithData, titlebar){" + "\n" + data.code + "\n" + "}</script>");
                    $("head").append('<style type="text/css">' + "\n" + data.css + "\n" + "</style>");
                }
                success(data);
            }).fail(function(xhr, textStatus, errorThrown) {
                if (fail) fail();
            });
        },
        getConfig: function(type) {
            var config = {};
            if (app.customChart.config && app.customChart.config[type.id] && type.isCustom) {
                config = app.customChart.config[type.id] || {};
            }
            return config;
        }
    };
})(jQuery);

var app = app || {};

app.charts = app.charts || {};

app.charts.gauge = {};

app.charts.gauge.draw = function(input, settings, refreshWithData, titlebar) {
    settings.input = input;
    app.chartCommons.calculateFields(input.series, settings.calculatedFields);
    var title = input.title;
    var chartInfo = input.chartInfo;
    var showPersian = typeof input.lang == "undefined" ? true : +input.lang == 0 ? true : false;
    var seriesLabels = typeof input.series != "undefined" ? input.series.labels : [];
    var kpisLabels = typeof input.kpis != "undefined" ? input.kpis.labels : [];
    var seriesLabelsCaptions = input.seriesLablesCaptions;
    var kpisLabelsCaptions = input.kpisLablesCaptions;
    var yAxeLable = settings.LabelY;
    var selector = "#" + settings.id;
    var margin = {
        top: 95,
        right: 20,
        bottom: 0,
        left: 20
    };
    var width = $(selector).width();
    var isFromCommentDialog = $(selector).hasClass("fromCommentDialog");
    var barHeight = settings.chartProp.info.chartSize == "small" ? 70 + 150 : settings.chartProp.info.chartSize == "medium" ? 100 + 150 : settings.chartProp.info.chartSize == "large" ? 130 + 150 : settings.chartProp.info.chartSize == "veryLarge" ? 180 + 150 : 100 + 150;
    var arcHeight = settings.chartProp.info.height == "small" ? 20 : settings.chartProp.info.height == "medium" ? 30 : settings.chartProp.info.height == "large" ? 40 : settings.chartProp.info.height == "veryLarge" ? 50 : 30;
    var hasHref = settings.chartProp.info.openDashboard && settings.chartProp.info.openDashboard.checked;
    var height = barHeight + margin.top + margin.bottom;
    var colors = d3.scaleOrdinal(d3.schemeCategory10);
    settings.width = width;
    var isProgress = titlebar.isProgress;
    var showProgress = titlebar.showProgress;
    var title = titlebar.title;
    function propertyOf(o, k) {
        if (typeof o == "undefined") return null;
        return o[k];
    }
    var formatString = propertyOf(settings.chartProp.info.font, "formatString") || settings.chartProp.info.formatString || ",.2f";
    var formatStringCustom = propertyOf(settings.chartProp.info.font, "formatStringCustom") || settings.chartProp.info.formatString || ",.2f";
    var fontName = propertyOf(settings.chartProp.info.font, "fontName") || "Droid";
    var fontSize = propertyOf(settings.chartProp.info.font, "fontSize") || settings.chartProp.info.fontSize || "46px";
    var italic = propertyOf(settings.chartProp.info.font, "italic") != null ? propertyOf(settings.chartProp.info.font, "italic") : settings.chartProp.info.textItalic || false;
    var color = propertyOf(settings.chartProp.info.font, "color") || settings.chartProp.info.color || "#333333";
    var bold = propertyOf(settings.chartProp.info.font, "bold") != null ? propertyOf(settings.chartProp.info.font, "bold") : settings.chartProp.info.textBold || false;
    var font = {};
    font.formatString = formatString;
    font.formatStringCustom = formatStringCustom;
    font.fontName = fontName;
    font.fontSize = fontSize;
    font.italic = italic;
    font.color = color;
    font.bold = bold;
    font.formatString = font.formatString != "custom" ? font.formatString : font.formatStringCustom;
    app.chartCommons.setDefault(settings.chartProp, kpisLabels.concat(seriesLabels), "gauge");
    if (settings.editMode) {
        $(selector).trigger("chartproperty", [ seriesLabels.concat(kpisLabels) ]);
    }
    if (!input.result) {
        $("#" + settings.id).append(app.chartCommons.getError(input));
        return;
    }
    var data = prepareData(input);
    settings.chartProp.info.segmentType = settings.chartProp.info.segmentType || "singleSegment";
    var isSingleSegment = settings.chartProp.info.segmentType == "singleSegment";
    var defaultValue = settings.chartProp.info.value;
    var defaultTarget = settings.chartProp.info.target;
    var defaultTrend = settings.chartProp.info.trend;
    var defaultStatus = settings.chartProp.info.status;
    var defaultMin = settings.chartProp.info.min;
    var defaultMax = settings.chartProp.info.max;
    var defaultYellow = settings.chartProp.info.yellow;
    var defaultGreen = settings.chartProp.info.green;
    if (defaultTarget == "") defaultTarget = undefined;
    var hasValue = isNaN(defaultValue || "nan") ? false : true;
    var hasTarget = isNaN(defaultTarget || "nan") ? false : true;
    var hasStatus = isNaN(defaultStatus || "nan") ? false : true;
    var hasTrend = isNaN(defaultTrend || "nan") ? false : true;
    var hasMin = isNaN(defaultMin || "nan") ? false : true;
    var hasMax = isNaN(defaultMax || "nan") ? false : true;
    var hasYellow = isNaN(defaultYellow || "nan") ? false : true;
    var hasGreen = isNaN(defaultGreen || "nan") ? false : true;
    $(selector).css({
        overflow: "auto",
        padding: "0"
    });
    if ((!_.isArray(input.levels) || input.levels.length == 0) && !settings.editMode) {
        $(selector).css({
            overflow: "hidden"
        });
    }
    for (var i = 0; i < data.length; i++) {
        var item = data[i];
        var kpi = [];
        if (isSingleSegment) kpi = [ +defaultValue, +defaultTarget, +defaultStatus, +defaultTrend ]; else kpi = [ +defaultValue, +defaultTarget, +defaultTrend, +defaultMin, +defaultYellow, +defaultGreen, +defaultMax ];
        var changeKpi = false;
        for (var j = 0; j < item.series.length; j++) {
            var prop = settings.chartProp.series[seriesLabels[j]];
            var index = -1;
            if (isSingleSegment) index = prop.type == "value" && !hasValue ? 0 : prop.type == "target" && !hasTarget ? 1 : prop.type == "status" && !hasStatus ? 2 : prop.type == "trend" && !hasTrend ? 3 : -1; else index = prop.typeMs == "value" && !hasValue ? 0 : prop.typeMs == "target" && !hasTarget ? 1 : prop.typeMs == "trend" && !hasTrend ? 2 : prop.typeMs == "min" && !hasMin ? 3 : prop.typeMs == "yellow" && !hasYellow ? 4 : prop.typeMs == "green" && !hasGreen ? 5 : prop.typeMs == "max" && !hasMax ? 6 : -1;
            if (index != -1) {
                kpi[index] = item.series[j] * +prop.numberFactor;
                changeKpi = true;
            }
        }
        if (changeKpi || item.kpis.length == 0) item.kpis.push(kpi);
        if (isSingleSegment) {
            if (typeof kpi[0] == "undefined" || isNaN(kpi[0])) kpi[0] = 0;
            if (typeof kpi[2] == "undefined" || isNaN(kpi[2])) kpi[2] = 1;
            if (typeof kpi[3] == "undefined" || isNaN(kpi[3])) kpi[3] = 1;
        } else {
            if (typeof kpi[0] == "undefined" || isNaN(kpi[0])) kpi[0] = 0;
            if (typeof kpi[2] == "undefined" || isNaN(kpi[2])) kpi[2] = 1;
            if (typeof kpi[3] == "undefined" || isNaN(kpi[3])) kpi[3] = 0;
            if (typeof kpi[4] == "undefined" || isNaN(kpi[4])) kpi[4] = kpi[0] > 0 ? kpi[0] * .3 : 30;
            if (typeof kpi[5] == "undefined" || isNaN(kpi[5])) kpi[5] = kpi[0] > 0 ? kpi[0] * .7 : 70;
            if (typeof kpi[6] == "undefined" || isNaN(kpi[6])) kpi[6] = kpi[0] > 0 ? kpi[0] * 1.2 : 100;
        }
    }
    var legendBar = d3.select(selector).append("div").attr("class", "legend-bar temporal");
    legendBar.breadcrumb(input.levels, settings, titlebar, showPersian);
    if (!input.matrix || input.matrix.length == 0) {
        d3.select(selector).append("div").attr("class", "temporal").style("font-size", "0.8em").style("margin", "15px").append("span").attr("class", "translate").attr("data-trans-key", "داده‌ای برای نمایش وجود ندارد").text("داده‌ای برای نمایش وجود ندارد");
        return;
    }
    function getFloat(d, isMax) {
        return isNaN(d) ? isMax ? -99999 : 99999 : parseFloat(d);
    }
    var max = d3.max(data, function(d) {
        return d3.max(d.kpis, function(d) {
            return Math.max(getFloat(d[0], true), getFloat(d[1], true));
        });
    });
    var min = d3.min(data, function(d) {
        return d3.min(d.kpis, function(d) {
            return Math.min(getFloat(d[0], false), getFloat(d[1], false));
        });
    });
    var pkiColors = [ "#eee", "#ddd", "#ccc" ];
    var redColor = settings.chartProp.info.colorAriaOne || "#e14d57";
    var yellowColor = settings.chartProp.info.colorAriaTwo || "#FBEE58";
    var greenColor = settings.chartProp.info.colorAriaThree || "#71b37c";
    var getStatusColor = function(val) {
        if (val > 0) {
            return greenColor;
        } else if (val == 0) {
            return yellowColor;
        } else {
            return redColor;
        }
    };
    var myInterpolate = function(a, b) {
        var re = /^([0-9,.-]+)$/, ma, mb, f = d3.format(font.formatString);
        ma = re.exec(a);
        mb = re.exec(b);
        if (ma && mb) {
            a = parseFloat(ma[1]);
            b = parseFloat(mb[1]) - a;
            return function(t) {
                var v = a + b * t;
                return persian(f(v), showPersian);
            };
        } else {
            return function(t) {
                return a;
            };
        }
    };
    var gaugeHeight = barHeight;
    if (app.dashboardLayoutVersion == 2) {}
    var vw = $(selector).width();
    var vh = $(selector).height();
    var items = data.length;
    function getWidgetSize(vw, vh, items, type) {
        var minW = type == "arc" ? 200 : type == "number" ? 150 : 150;
        var minH = type == "arc" ? 200 : type == "number" ? 100 : 60;
        if (vw >= items * minW) {
            return {
                w: vw / items,
                h: Math.max(vh, minH)
            };
        }
        if (vh >= items * minH) {
            return {
                w: Math.max(vw, minW),
                h: vh / items
            };
        }
        var columnCount = Math.ceil(vw * 1 / minW);
        var rowCount = Math.ceil(items * 1 / columnCount);
        return {
            w: Math.max(vw / columnCount, minW),
            h: Math.max(vh / rowCount, minH)
        };
    }
    var widgetSize = getWidgetSize(vw, vh, items, settings.chartProp.info.style);
    d3.select(selector).styles({
        display: "flex",
        "align-items": "center",
        "flex-direction": "column"
    });
    var barWidth = width;
    widgetSize.h -= 28;
    widgetSize.w -= 28;
    if ((!_.isArray(input.levels) || input.levels.length == 0) && !settings.editMode && items == 1) {
        $(selector).css({
            overflow: "hidden"
        });
    }
    var div1 = d3.select(selector).append("div").attr("class", "temporal gauge-container").styles({
        display: "flex",
        "align-items": "center",
        "flex-wrap": "wrap",
        "justify-content": "space-around",
        "flex-grow": 1,
        "flex-shrink": 1,
        "flex-basis": "0%",
        width: "100%"
    }).selectAll("nothings").data(data).enter().append("div").attr("class", function(d, i) {
        if (d.onClickVal == "" && !hasHref) return "gauge-item temporal"; else return "gauge-item temporal pointer";
    }).on("click", function(d, i) {
        if (isFromCommentDialog) {
            app.chartCommons.commentUtils.clickOnCommentIcon(d, settings.ChartInPageId);
            return;
        }
        if (d.onClickVal == "") {
            if (hasHref && !settings.editMode) {
                app.chartCommons.openLink(settings.chartProp.info.openDashboard, {
                    ChartInPageId: settings.ChartInPageId,
                    DataSourceId: settings.input.DataSourceId,
                    dimensionName: settings.input.dimensionName,
                    value: d.value,
                    refreshDatasource: settings.input.RefreshDatasource
                });
            }
            return;
        }
        if (isProgress()) return;
        showProgress(true);
        settings.drill = "down";
        app.chartCommons.drillDown.add(settings.ChartInPageId, settings.input.DataSourceId, settings.input.CurrentDimName, d.onClickVal, settings.input.RefreshDatasource);
        settings.parameters = {
            selectedItem: d.onClickVal,
            chartId: settings.chartId,
            ChartInPageId: settings.ChartInPageId
        };
        app.chartCommons.levelTypeUtils.getParam(settings);
        $(selector).charts(settings.type, "refreshWithData", settings);
    }).each(function(d, i) {
        switch (settings.chartProp.info.style) {
          case "arc":
            if (isSingleSegment) createArcGauge(this, d, i, widgetSize.h, widgetSize.w); else createArcGaugeMultiSection(this, d, i, widgetSize.h, widgetSize.w);
            break;

          case "horizontal":
            if (isSingleSegment) createLinearGauge(this, d, i, widgetSize.h, widgetSize.w); else createLinearGaugeMultiSection(this, d, i, widgetSize.h, widgetSize.w);
            break;

          case "circle":
            if (isSingleSegment) createArcGauge(this, d, i, widgetSize.h, widgetSize.w); else createArcGaugeMultiSection(this, d, i, widgetSize.h, widgetSize.w);
            break;

          case "semiCircle":
            if (isSingleSegment) createArcGauge(this, d, i, widgetSize.h, widgetSize.w); else createArcGaugeMultiSection(this, d, i, widgetSize.h, widgetSize.w);
            break;

          case "verical":
            if (isSingleSegment) createLinearGauge(this, d, i, widgetSize.h, widgetSize.w); else createLinearGaugeMultiSection(this, d, i, widgetSize.h, widgetSize.w);
            break;

          case "number":
            createNumber(this, d, i, widgetSize.h, widgetSize.w);
            break;

          default:        }
    });
    function createLinearGauge(n, divdata, divindex, h, w) {
        var pad = 5;
        w -= 24 * 2;
        var divsr = d3.select(n).selectAll("nothings").data(function(d) {
            return d.kpis;
        }).enter().append("div").styles({
            width: w + "px",
            "margin-left": "10px",
            "margin-right": "10px"
        }).append("div");
        var cols = "12";
        if (settings.chartProp.info.showLabels) {
            divsr.append("div").text(function(d, i) {
                var kl = kpisLabels[i];
                return persian(divdata.label + (kl ? " - " + kl : ""), showPersian);
            });
            var cols = "9";
        }
        var divs = divsr.append("div");
        var textDivValue = divs.append("div").style("text-align", "left").style("position", "relative");
        barWidth = $(divs._groups[0][0]).width();
        var svgs = divs.append("svg").attr("width", barWidth).attr("class", "line-svg").attr("height", arcHeight + 2 * pad);
        var newMin = 0, newMax = 0;
        if (min >= 0 && max >= 0) {
            newMin = 0;
            newMax = 1.2 * max;
        } else {
            var m = Math.max(Math.abs(max), Math.abs(min));
            newMin = m * -1.2;
            newMax = m * 1.2;
        }
        var x = d3.scaleLinear().range([ 0, barWidth ]).domain([ newMin, newMax ]);
        svgs.append("rect").attr("height", arcHeight).attr("y", pad).attr("fill", pkiColors[0]).attr("width", barWidth);
        svgs.append("rect").attr("height", arcHeight).attr("y", pad).attr("fill", function(d, i) {
            return getStatusColor(d[2]);
        }).attr("width", 0).transition().duration(settings.animationDuration).attr("width", function(d) {
            return x(d[0]);
        });
        svgs.append("rect").attr("width", "5").attr("x", "0").attr("y", "0").attr("height", arcHeight + pad).attr("fill", "#333").transition().duration(settings.animationDuration).attr("x", function(d) {
            return x(d[0]) - 5 < newMin ? newMin : x(d[0]) - 5;
        });
        svgs.filter(function(d) {
            return !isNaN(d[1]);
        }).append("path").attr("transform", function(d) {
            return "translate(" + (x(d[1]) - 5 < newMin ? newMin : x(d[1]) - 5) + ",0)";
        }).attr("d", "M0 " + pad + " 0 " + (arcHeight + 2 * pad)).attr("stroke-dasharray", "2,2").attr("stroke-width", "2").attr("stroke", "black").attr("fill", "none").attr("class", "target-pointer").style("display", function(d) {
            if (isNaN(d[1])) return "none";
            return "auto";
        });
        var textDiv = divs.append("div").style("text-align", "left").style("position", "relative");
        textDivValue.append("div").attr("class", "gauge-value").style("color", font.color).style("font-family", font.fontName).style("font-size", font.fontSize).style("font-weight", font.bold ? "bold" : "normal").style("font-style", font.italic ? "italic" : "normal").text(function(d) {
            return persian(d3.format(font.formatString)(d[0]), showPersian);
        }).style("left", "0").transition().duration(settings.animationDuration).style("left", function(d) {
            var ow = $(this).outerWidth();
            var left = x(d[0]) - 5 - ow / 2;
            if (left < 0) left = 0;
            if (left + ow > barWidth) left = barWidth - ow;
            return left + "px";
        }).tween("text", function(d) {
            var i = myInterpolate("0", d[0]);
            var node = this;
            return function(t) {
                node.textContent = i(t);
            };
        });
        var target = textDiv.filter(function(d) {
            return !isNaN(d[1]);
        }).append("div").attr("class", "gauge-target").text(function(d) {
            return persian(d3.format(font.formatString)(d[1]), showPersian);
        }).style("left", function(d) {
            var ow = $(this).outerWidth();
            var left = x(d[1]) - 5 - ow / 2;
            if (left < 0) left = 0;
            if (left + ow > barWidth) left = barWidth - ow;
            return left + "px";
        }).style("display", function(d) {
            if (isNaN(d[1])) return "none";
            return "auto";
        });
        var valueDivHeight = $(textDivValue._groups[0][0]).find(".gauge-value").outerHeight();
        var targetDivHeight = $(textDiv._groups[0][0]).find(".gauge-target").outerHeight();
        textDivValue.style("height", valueDivHeight + "px");
        $(textDivValue._groups[0][0]).find(".gauge-value").css("height", valueDivHeight + "px");
        $(textDivValue._groups[0][0]).find(".gauge-value").css("position", "absolute");
        textDiv.style("height", targetDivHeight + "px");
        $(textDiv._groups[0][0]).find(".gauge-target").css("height", targetDivHeight + "px");
        $(textDiv._groups[0][0]).find(".gauge-target").css("position", "absolute");
    }
    function createNumber(n, divdata, divindex, h, w) {
        var root = d3.select(n);
        root.style("display", "none");
        var divs = d3.select(n).selectAll("nothings").data(function(d) {
            return d.kpis;
        }).enter().append("div");
        if (settings.chartProp.info.haveCustomText) {
            divs.append("div").attr("class", "custom-text-gauge").call(function(d) {
                var thens = _.reduce(app.chartCommons.indicator.getIndicator(data[divindex].series, seriesLabels, settings.chartProp.indicator), function(r, v) {
                    r = r || [];
                    r.push(v);
                    return r;
                });
                var selectedLable = seriesLabels[0];
                _.forOwn(settings.chartProp.series, function(value, key) {
                    if (settings.chartProp.series[key].type === "value") {
                        selectedLable = key;
                    }
                });
                var thisThens = _.filter(thens, {
                    firstField: selectedLable
                });
                d.html(function(d2, i) {
                    var kl = kpisLabels[i];
                    var label = persian(divdata.label + (kl ? " - " + kl : ""), showPersian);
                    var value = persian(d3.format(font.formatString)(d2[0]), showPersian);
                    var iconThen = _.filter(thisThens, {
                        operand: "2"
                    });
                    var icon = "";
                    var iconType = "icon";
                    if (settings.chartProp.info.icons && settings.chartProp.info.icons.length) {
                        icon = settings.chartProp.info.icons[divindex % settings.chartProp.info.icons.length];
                        if (typeof icon === "string") {
                            icon = "";
                        } else {
                            iconType = icon.type || "icon";
                            icon = icon.name;
                        }
                    }
                    if (iconThen.length) {
                        icon = iconThen[iconThen.length - 1].secondFieldIcon.name;
                        iconType = iconThen[iconThen.length - 1].secondFieldIcon.type;
                    }
                    var colorThen = _.filter(thisThens, {
                        operand: "1"
                    });
                    var color = font.color;
                    if (colorThen.length) color = colorThen.pop().secondFieldColor;
                    var iconTag = "";
                    if (iconType === "icon") {
                        iconTag = '<i class="' + icon + '"></i>';
                    }
                    if (iconType === "image") {
                        iconTag = '<img style="width:1.5em" src="' + app.urlPrefix + "api/upload/getpic/" + icon + '"></i>';
                    }
                    var o = settings.chartProp.info.customText.replace("@value", '<span class="ltr inline">' + value + "</span>").replace("@label", label).replace("@icon", iconTag);
                    return o;
                });
            });
            $(root.node()).transition("scale");
            return;
        }
        var size = settings.chartProp.info.height === "small" ? "mini" : settings.chartProp.info.height === "medium" ? "tiny" : settings.chartProp.info.height === "large" ? "" : "large";
        var statistic = divs.append("div").attr("class", "ui xstatistic " + size).call(function(d) {
            var thens = _.reduce(app.chartCommons.indicator.getIndicator(data[divindex].series, seriesLabels, settings.chartProp.indicator), function(r, v) {
                r = r || [];
                r.push(v);
                return r;
            });
            var selectedLable = seriesLabels[0];
            _.forOwn(settings.chartProp.series, function(value, key) {
                if (settings.chartProp.series[key].type === "value") {
                    selectedLable = key;
                }
            });
            var thisThens = _.filter(thens, {
                firstField: selectedLable
            });
            d.styles({
                color: font.color,
                "font-family": font.fontName,
                "font-size": font.fontSize,
                "font-weight": font.bold ? "bold" : "normal",
                "font-style": font.italic ? "italic" : "normal"
            });
            d.append("div").classed("value", true).append("span").attr("class", "text ltr inline").text(function(d) {
                return persian(d3.format(font.formatString)(d[0]), showPersian);
            });
            d.select(".value").append("i").attr("class", function(d, i) {
                var iconThen = _.filter(thisThens, {
                    operand: "2"
                });
                var icon = "";
                if (settings.chartProp.info.icons && settings.chartProp.info.icons.length) {
                    icon = settings.chartProp.info.icons[divindex % settings.chartProp.info.icons.length];
                    if (typeof icon === "string") {
                        icon = "";
                    } else {
                        icon = icon.name;
                    }
                }
                if (iconThen.length) icon = iconThen[iconThen.length - 1].secondFieldIcon;
                if (!icon) {
                    icon = "ng-hide";
                }
                return icon;
            }).style("color", function(d) {
                var colorThen = _.filter(thisThens, {
                    operand: "1"
                });
                var color = font.color;
                if (colorThen.length) color = colorThen.pop().secondFieldColor;
                return color;
            }).style("font-size", font.fontSize).style("margin", "0 10px");
        }).call(function(d) {
            var label = d.append("div").classed("xlabel", true).styles({
                "font-family": font.fontName,
                "line-height": "1.7em",
                "font-size": "40%",
                "font-weight": "300"
            });
            if (settings.chartProp.info.valueStaticTop) {
                label.append("div").text(settings.chartProp.info.valueStaticTop);
            }
            if (settings.chartProp.info.showLabels) {
                label.append("div").text(function(d, i) {
                    var kl = kpisLabels[i];
                    return persian(divdata.label + (kl ? " - " + kl : ""), showPersian);
                });
            }
            if (settings.chartProp.info.valueStaticDown) {
                label.append("div").text(settings.chartProp.info.valueStaticDown);
            }
        });
        $(root.node()).transition("scale");
    }
    function createLinearGaugeMultiSection(n, divdata, divindex, h, w) {
        var pad = 5;
        w -= 24 * 2;
        var divsr = d3.select(n).selectAll("nothings").data(function(d) {
            return d.kpis;
        }).enter().append("div").styles({
            "margin-left": "10px",
            "margin-right": "10px",
            width: w + "px"
        }).append("div");
        var cols = "12";
        if (settings.chartProp.info.showLabels) {
            divsr.append("div").text(function(d, i) {
                var kl = kpisLabels[i];
                return persian(divdata.label + (kl ? " - " + kl : ""), showPersian);
            });
            var cols = "9";
        }
        var divs = divsr.append("div").attr("class", "col-md-" + cols);
        var textDivValue = divs.append("div").style("text-align", "left").style("position", "relative");
        barWidth = $(divs._groups[0][0]).width();
        var svgs = divs.append("svg").attr("width", barWidth).attr("height", arcHeight + 2 * pad);
        var xarray = [];
        svgs._groups.forEach(function(d, i) {
            var data = d[0].__data__;
            xarray.push(d3.scaleLinear().range([ 0, barWidth ]).domain([ data[3], data[6] ]));
        });
        svgs.append("rect").attr("height", arcHeight).attr("y", pad).attr("fill", greenColor).attr("width", barWidth);
        svgs.append("rect").attr("height", arcHeight).attr("y", pad).attr("fill", yellowColor).attr("width", function(d, i) {
            return xarray[i](d[5]);
        });
        svgs.append("rect").attr("height", arcHeight).attr("y", pad).attr("fill", redColor).attr("width", function(d, i) {
            return xarray[i](d[4]);
        });
        svgs.append("path").attr("transform", function(d, i) {
            var val = xarray[i](d[3] < d[6] ? d[3] : d[6]);
            return "translate(" + (val < xarray[i](d[3]) ? xarray[i](d[3]) : val) + ",0)";
        }).attr("d", "M0 " + pad + " 0 " + (arcHeight + 2 * pad)).attr("stroke-dasharray", "2,2").attr("stroke-width", "1").attr("stroke", "black").attr("fill", "none").attr("class", "none");
        svgs.append("path").attr("transform", function(d, i) {
            var val = xarray[i](d[6] < d[6] ? d[6] : d[6]);
            return "translate(" + (val < xarray[i](d[3]) ? xarray[i](d[3]) : val) + ",0)";
        }).attr("d", "M0 " + pad + " 0 " + (arcHeight + 2 * pad)).attr("stroke-dasharray", "2,2").attr("stroke-width", "1").attr("stroke", "black").attr("fill", "none").attr("class", "none");
        svgs.append("path").attr("transform", function(d, i) {
            var val = xarray[i](d[5] < d[6] ? d[5] : d[6]);
            return "translate(" + (val < xarray[i](d[3]) ? xarray[i](d[3]) : val) + ",0)";
        }).attr("d", "M0 " + pad + " 0 " + (arcHeight + 2 * pad)).attr("stroke-dasharray", "2,2").attr("stroke-width", "1").attr("stroke", "black").attr("fill", "none").attr("class", "none");
        svgs.append("path").attr("transform", function(d, i) {
            var val = xarray[i](d[4] < d[6] ? d[4] : d[6]);
            return "translate(" + (val < xarray[i](d[3]) ? xarray[i](d[3]) : val) + ",0)";
        }).attr("d", "M0 " + pad + " 0 " + (arcHeight + 2 * pad)).attr("stroke-dasharray", "2,2").attr("stroke-width", "1").attr("stroke", "black").attr("fill", "none");
        svgs.append("rect").attr("width", "5").attr("x", "0").attr("y", "0").attr("height", arcHeight + pad).attr("fill", "#333").transition().duration(settings.animationDuration).attr("x", function(d, i) {
            var val = xarray[i](d[0] < d[3] ? d[3] : d[0] < d[6] ? d[0] : d[6]) - 5;
            return val < xarray[i](d[3]) ? xarray[i](d[3]) : val;
        });
        svgs.filter(function(d) {
            return !isNaN(d[1]);
        }).append("path").attr("transform", function(d, i) {
            var val = xarray[i](d[1] < d[6] ? d[1] : d[6]) - 5;
            return "translate(" + (val < xarray[i](d[3]) ? xarray[i](d[3]) : val) + ",0)";
        }).attr("d", "M0 " + pad + " 0 " + (arcHeight + 2 * pad)).attr("stroke-dasharray", "2,2").attr("stroke-width", "2").attr("stroke", "black").attr("fill", "none");
        var textDiv = divs.append("div").style("text-align", "left").style("position", "relative").style("margin-top", "-10px");
        textDivValue.append("span").attr("class", "gauge-value").style("color", font.color).style("font-family", font.fontName).style("font-size", font.fontSize).style("font-weight", font.bold ? "bold" : "normal").style("font-style", font.italic ? "italic" : "normal").text(function(d) {
            return persian(d3.format(font.formatString)(d[0]), showPersian);
        }).style("left", "0").transition().duration(settings.animationDuration).style("left", function(d, i) {
            var ow = $(this).outerWidth();
            var left = xarray[i](d[0]) - 5 - ow / 2;
            if (left < 0) left = 0;
            if (left + ow > barWidth) left = barWidth - ow;
            return left + "px";
        }).tween("text", function(d) {
            var i = myInterpolate(d[3], d[0]);
            var node = this;
            return function(t) {
                node.textContent = i(t);
            };
        });
        textDiv.filter(function(d) {
            return !isNaN(d[1]);
        }).append("span").attr("class", "gauge-target").text(function(d) {
            return persian(d3.format(font.formatString)(d[1]), showPersian);
        }).style("left", function(d, i) {
            var ow = $(this).outerWidth();
            var left = xarray[i](d[1]) - 5 - ow / 2;
            if (left < 0) left = 0;
            if (left + ow > barWidth) left = barWidth - ow;
            return left + "px";
        });
        textDiv.append("span").attr("class", "gauge-target").text(function(d) {
            return persian(d3.format(font.formatString)(d[3]), showPersian);
        }).style("left", function(d, i) {
            var ow = $(this).outerWidth();
            var left = xarray[i](d[3]) - ow / 2;
            if (left < 0) left = 0;
            if (left + ow > barWidth) left = barWidth - ow;
            return left + "px";
        });
        textDiv.append("span").attr("class", "gauge-target").text(function(d) {
            return persian(d3.format(font.formatString)(d[6]), showPersian);
        }).style("left", function(d, i) {
            var ow = $(this).outerWidth();
            var left = xarray[i](d[6]) - ow / 2;
            if (left < 0) left = 0;
            if (left + ow > barWidth) left = barWidth - ow;
            return left + "px";
        });
        textDiv.append("span").attr("class", "gauge-target").text(function(d) {
            return persian(d3.format(font.formatString)(d[4]), showPersian);
        }).style("left", function(d, i) {
            var ow = $(this).outerWidth();
            var left = xarray[i](d[4]) - ow / 2;
            if (left < 0) left = 0;
            if (left + ow > barWidth) left = barWidth - ow;
            return left + "px";
        });
        textDiv.append("span").attr("class", "gauge-target").text(function(d) {
            return persian(d3.format(font.formatString)(d[5]), showPersian);
        }).style("left", function(d, i) {
            var ow = $(this).outerWidth();
            var left = xarray[i](d[5]) - ow / 2;
            if (left < 0) left = 0;
            if (left + ow > barWidth) left = barWidth - ow;
            return left + "px";
        });
        var valueDivHeight = $(textDivValue._groups[0][0]).find(".gauge-value").outerHeight();
        textDivValue.style("height", valueDivHeight + "px");
        $(textDivValue._groups[0][0]).find(".gauge-value").css("height", valueDivHeight + "px");
        $(textDivValue._groups[0][0]).find(".gauge-value").css("position", "absolute");
        var target = $(textDiv._groups[0][0]).find(".gauge-target").outerHeight();
        textDiv.style("height", target + "px");
        $(textDiv._groups[0][0]).find(".gauge-target").css("height", target + "px");
        $(textDiv._groups[0][0]).find(".gauge-target").css("position", "absolute");
    }
    function createArcGauge(n, divdata, divindex, chartHeight, chartWidth) {
        arcPreProcess(n, divdata, divindex, chartHeight, chartWidth, function(divs, needleExtra, extraPointer, startAngle, endAngle, outerRadius, innerRadius, gaugeHeightRatio, gaugeHeight, gaugeInnerHeight, valueYpos, svgHeight) {
            var newMin = 0, newMax = 0;
            if (min >= 0 && max >= 0) {
                newMin = 0;
                newMax = 1.2 * max;
            } else {
                var m = Math.max(Math.abs(max), Math.abs(min));
                newMin = m * -1.2;
                newMax = m * 1.2;
            }
            var x = d3.scaleLinear().range([ startAngle, endAngle ]).domain([ newMin, newMax ]);
            var arc0 = d3.arc().innerRadius(outerRadius).outerRadius(innerRadius).startAngle(startAngle).endAngle(endAngle);
            var arc = d3.arc().innerRadius(outerRadius).outerRadius(innerRadius).startAngle(startAngle).endAngle(function(d) {
                return x(d);
            });
            var svgs = divs.append("div").style("margin-bottom", "0").append("svg").attr("width", outerRadius * 2).attr("height", svgHeight).append("g").attr("transform", "translate(" + outerRadius + "," + outerRadius + ")");
            if (settings.chartProp.info.showLabels) {
                divs.append("div").text(function(d, i) {
                    var kl = kpisLabels[i];
                    return persian(divdata.label + (kl ? " - " + kl : ""), showPersian);
                });
            }
            var backArc = svgs.append("path").attr("d", arc0).attr("transform", "translate(" + needleExtra + "," + needleExtra + ")").attr("fill", pkiColors[0]);
            var backArcHeight = backArc.node().getBBox().height;
            var path = svgs.append("path").attr("fill", function(d, i) {
                return getStatusColor(d[2]);
            }).attr("transform", "translate(" + needleExtra + "," + needleExtra + ")").transition().duration(settings.animationDuration).attrTween("d", function(a) {
                var i = d3.interpolate(newMin, a[0]);
                return function(t) {
                    return arc(i(t));
                };
            });
            var needle = svgs.append("g");
            needle.append("rect").attr("width", "5").attr("transform", "translate(" + (needleExtra - 2.5) + "," + needleExtra + ")").attr("height", outerRadius + extraPointer).attr("fill", "#333");
            needle.attr("transform", "rotate(" + (startAngle * (180 / Math.PI) + 180) + " " + needleExtra + " " + needleExtra + " )");
            needle.append("circle").attr("r", "5").attr("cx", needleExtra).attr("cy", needleExtra);
            needle.transition().duration(settings.animationDuration).attrTween("transform", function(d) {
                var x0 = x(d[0]);
                var zero = startAngle * (180 / Math.PI) + 180;
                if (isNaN(x0)) final = zero; else var final = x(d[0]) * (180 / Math.PI) + 180;
                var i = d3.interpolate(zero, final);
                return function(t) {
                    return "rotate(" + i(t) + " " + needleExtra + " " + needleExtra + " )";
                };
            });
            svgs.filter(function(d) {
                return !isNaN(d[1]);
            }).append("path").attr("d", "M" + needleExtra + " " + needleExtra + " " + needleExtra + " " + (arcHeight + needleExtra + extraPointer)).attr("stroke-dasharray", "2,2").attr("stroke-width", "2").attr("stroke", "black").attr("fill", "none").attr("transform", function(d) {
                return "rotate(" + x(d[1]) * (180 / Math.PI) + " " + needleExtra + " " + needleExtra + ")" + "translate(" + 0 + "," + (-outerRadius - extraPointer) + ")";
            });
            svgs.filter(function(d) {
                return !isNaN(d[1]);
            }).append("text").attr("class", "gauge-target").attr("text-anchor", "middle").attr("dy", "-0.3em").text(function(d) {
                return persian(d3.format(font.formatString)(d[1]), showPersian);
            }).attr("transform", function(d) {
                return "rotate(" + x(d[1]) * (180 / Math.PI) + " " + needleExtra + " " + needleExtra + " )" + "translate(" + needleExtra + "," + (-outerRadius + needleExtra - extraPointer) + ")";
            });
            var box = $(selector + " svg > g").get(0).getBBox();
            var gaugeVal = svgs.append("text").attr("class", "gauge-value").attr("text-anchor", "middle").style("fill", font.color).style("font-family", font.fontName).attr("dy", "1em").style("font-size", font.fontSize).style("font-weight", font.bold ? "bold" : "normal").style("font-style", font.italic ? "italic" : "normal").text(function(d) {
                return persian(d3.format(font.formatString)(d[0]), showPersian);
            }).attr("transform", "translate(" + needleExtra + "," + valueYpos + ")").transition().duration(settings.animationDuration).tween("text", function(d) {
                var i = myInterpolate(d[3], d[0]);
                var node = this;
                return function(t) {
                    node.textContent = i(t);
                };
            });
        });
    }
    function createArcGaugeMultiSection(n, divdata, divindex, chartHeight, chartWidth) {
        arcPreProcess(n, divdata, divindex, chartHeight, chartWidth, function(divs, needleExtra, extraPointer, startAngle, endAngle, outerRadius, innerRadius, gaugeHeightRatio, gaugeHeight, gaugeInnerHeight, valueYpos, svgHeight) {
            var xarray = [];
            divs.each(function(data, i) {
                xarray.push(d3.scaleLinear().range([ startAngle, endAngle ]).domain([ data[3], data[6] ]));
            });
            var arc0 = d3.arc().innerRadius(outerRadius).outerRadius(innerRadius).startAngle(startAngle).endAngle(endAngle);
            var arc = d3.arc().innerRadius(outerRadius).outerRadius(innerRadius).startAngle(function(d) {
                return d.start;
            }).endAngle(function(d) {
                return d.end;
            });
            var arc0 = d3.arc().innerRadius(outerRadius).outerRadius(innerRadius).startAngle(startAngle).endAngle(endAngle);
            var svgs = divs.append("div").style("margin-bottom", "0").append("svg").attr("width", outerRadius * 2 + 2 * needleExtra).attr("height", svgHeight).append("g").attr("transform", "translate(" + outerRadius + "," + outerRadius + ")");
            if (settings.chartProp.info.showLabels) {
                divs.append("div").style("margin-bottom", "10px").text(function(d, i) {
                    var kl = kpisLabels[i];
                    return persian(divdata.label + (kl ? " - " + kl : ""), showPersian);
                });
            }
            function drowArc(startIndex, endIndex, redColor, needleExtra) {
                svgs.append("path").attr("d", function(d, i) {
                    var map = d.map(function(dd, ii) {
                        return xarray[i](dd);
                    });
                    return arc({
                        start: map[startIndex],
                        end: map[endIndex]
                    });
                }).attr("fill", redColor).attr("transform", "translate(" + needleExtra + "," + needleExtra + ")");
            }
            drowArc(3, 4, redColor, needleExtra);
            drowArc(4, 5, yellowColor, needleExtra);
            drowArc(5, 6, greenColor, needleExtra);
            var needle = svgs.append("g");
            needle.append("rect").attr("width", "5").attr("transform", "translate(" + (needleExtra - 2.5) + "," + needleExtra + ")").attr("height", outerRadius + extraPointer).attr("fill", "#333");
            needle.attr("transform", "rotate(" + (startAngle * (180 / Math.PI) + 180) + " " + needleExtra + " " + needleExtra + ")");
            needle.append("circle").attr("r", "5").attr("cx", needleExtra).attr("cy", needleExtra);
            needle.transition().duration(settings.animationDuration).attrTween("transform", function(d, i) {
                var x0 = xarray[i](d[0] < d[3] ? d[3] : d[0] < d[6] ? d[0] : d[6]);
                var zero = startAngle * (180 / Math.PI) + 180;
                var final = zero;
                if (!isNaN(x0)) {
                    var a = d[0] < d[3] ? d[3] : d[0] < d[6] ? d[0] : d[6];
                    final = xarray[0](a) * (180 / Math.PI) + 180;
                }
                var i = d3.interpolate(zero, final);
                return function(t) {
                    return "rotate(" + i(t) + " " + needleExtra + " " + needleExtra + ")";
                };
            });
            extraPointer = 0;
            function drowDashPath(r) {
                svgs.append("path").attr("d", "M" + needleExtra + " " + needleExtra + " " + needleExtra + " " + (arcHeight + extraPointer + needleExtra)).attr("stroke-dasharray", "2,2").attr("stroke-width", "2").attr("stroke", "black").attr("fill", "none").attr("transform", function(d, i) {
                    return "rotate(" + r(d, i) + " " + needleExtra + " " + needleExtra + ")" + "translate(" + 0 + "," + (-outerRadius - extraPointer) + ")";
                });
            }
            drowDashPath(function(d, i) {
                return xarray[i](d[3]) * (180 / Math.PI);
            });
            drowDashPath(function(d, i) {
                return xarray[i](d[6]) * (180 / Math.PI);
            });
            drowDashPath(function(d, i) {
                return xarray[i](d[4]) * (180 / Math.PI);
            });
            drowDashPath(function(d, i) {
                return xarray[i](d[5]) * (180 / Math.PI);
            });
            function drowValue(r, index) {
                svgs.append("text").attr("class", "gauge-target").attr("text-anchor", "middle").attr("dy", "-0.3em").text(function(d) {
                    return persian(d3.format(font.formatString)(d[index]), showPersian);
                }).attr("transform", function(d, i) {
                    return "rotate(" + xarray[i](r(d)) * (180 / Math.PI) + " " + needleExtra + " " + needleExtra + ")" + "translate(" + needleExtra + "," + (-outerRadius + needleExtra - extraPointer) + ")";
                });
            }
            drowValue(function(d) {
                return d[3];
            }, 3);
            drowValue(function(d) {
                return d[6];
            }, 6);
            drowValue(function(d) {
                return d[4];
            }, 4);
            drowValue(function(d) {
                return d[5];
            }, 5);
            var gaugeVal = svgs.append("text").attr("class", "gauge-value").attr("text-anchor", "middle").style("fill", font.color).style("font-family", font.fontName).attr("dy", "1em").style("font-size", font.fontSize).style("font-weight", font.bold ? "bold" : "normal").style("font-style", font.italic ? "italic" : "normal").text(function(d) {
                return persian(d3.format(font.formatString)(d[0]), showPersian);
            }).attr("transform", "translate(" + needleExtra + "," + valueYpos + ")").transition().duration(settings.animationDuration).tween("text", function(d) {
                var i = myInterpolate(d[3], d[0]);
                var node = this;
                return function(t) {
                    node.textContent = i(t);
                };
            });
            d3.select(svgs.node().parentNode).attr("height", svgHeight);
        });
    }
    function arcPreProcess(n, divdata, divindex, chartHeight, chartWidth, callback) {
        var divs = d3.select(n).selectAll("nothings").data(function(d) {
            return d.kpis;
        }).enter().append("div").style("text-align", "center");
        var needleExtra = 0;
        var extraPointer = 10;
        var margin = 0;
        var startAngle = settings.chartProp.info.chartSize == "small" ? -Math.PI * 2 / 5 : settings.chartProp.info.chartSize == "medium" ? -Math.PI * 2 / 4 : -Math.PI * 2 / 3;
        var endAngle = -1 * startAngle;
        var gaugeHeightRatio = Math.abs(Math.sin(startAngle));
        var t = divs.append("div").attr("class", "gauge-value").style("color", font.color).style("font-family", font.fontName).style("font-size", font.fontSize).style("font-weight", font.bold ? "bold" : "normal").style("font-style", font.italic ? "italic" : "normal").text(function(d) {
            return persian(d3.format(font.formatString)(d[0]), showPersian);
        });
        var targetText = divs.append("svg").append("text").attr("class", "gauge-target").attr("text-anchor", "middle").attr("dy", "-0.3em").text(function(d) {
            return persian(d3.format(font.formatString)("80"), showPersian);
        });
        var gaugeValHeight = $(t.node()).height();
        var gaugeValBox = {
            width: $(t.node()).width(),
            height: $(t.node()).height()
        };
        t.remove();
        var targetTextHeight = targetText.node().getBBox().height;
        var targetTextBox = targetText.node().getBBox();
        divs.select("svg").remove();
        var labelDivHeight = settings.chartProp.info.showLabels ? 22 : 0;
        var gaugeOuterHeight = Math.min(chartWidth - extraPointer * 2, chartHeight - gaugeValHeight - labelDivHeight) - margin * 2;
        var recomRadius = gaugeOuterHeight / 2;
        var outerRadius = recomRadius;
        var innerRadius = outerRadius - arcHeight;
        var gaugeHeight = recomRadius * 2 * gaugeHeightRatio;
        var gaugeInnerHeight = innerRadius * 2 * gaugeHeightRatio;
        var betweenArcSpace = (Math.abs(Math.cos(startAngle)) + Math.abs(Math.cos(endAngle))) * recomRadius;
        var canTextPlaceBetweenArcs = betweenArcSpace >= gaugeValBox.width;
        var valueYpos = Math.abs(Math.sin(startAngle)) * recomRadius - gaugeValHeight;
        var svgHeight = gaugeOuterHeight;
        svgHeight = Math.max(svgHeight, gaugeOuterHeight);
        if (callback) callback(divs, needleExtra, extraPointer, startAngle, endAngle, outerRadius, innerRadius, gaugeHeightRatio, gaugeHeight, gaugeInnerHeight, valueYpos, svgHeight);
    }
};

var app = app || {};

app.charts = app.charts || {};

app.charts.map = {};

app.charts.map.draw = function(input, settings, refreshWithData, titlebar) {
    settings.input = input;
    app.chartCommons.calculateFields(input.series, settings.calculatedFields);
    var chartTitle = input.title;
    var chartInfo = input.chartInfo;
    var showPersian = typeof input.lang == "undefined" ? true : +input.lang == 0 ? true : false;
    var seriesLabels = typeof input.series != "undefined" ? input.series.labels : [];
    var kpisLabels = typeof input.kpis != "undefined" ? input.kpis.labels : [];
    var selector = "#" + settings.id;
    var tootipType = +settings.chartProp.info.tooltip || 1;
    var colors = d3.scaleOrdinal(d3.schemeCategory10);
    var isProgress = titlebar.isProgress;
    var showProgress = titlebar.showProgress;
    var title = titlebar.title;
    var hasHref = settings.chartProp.info.openDashboard && settings.chartProp.info.openDashboard.checked;
    app.chartCommons.setDefault(settings.chartProp, kpisLabels.concat(seriesLabels), "map");
    if (settings.editMode) {
        $(selector).trigger("chartproperty", [ kpisLabels.concat(seriesLabels) ]);
    }
    if (!input.result) {
        $("#" + settings.id).append(app.chartCommons.getError(input));
        return;
    }
    if (!input.matrix || input.matrix.length == 0) {
        d3.select(selector).append("div").attr("class", "temporal").style("font-size", "0.8em").style("margin", "15px").append("span").attr("class", "translate").attr("data-trans-key", "داده‌ای برای نمایش وجود ندارد").text("داده‌ای برای نمایش وجود ندارد");
        return;
    }
    var mapId = settings.chartProp.info.map.selectedMap;
    if (typeof settings.map != "undefined" && mapId == settings.map.id) {
        drawMap(settings.map.data);
    } else {
        d3.select(selector + "").append("div").style("padding", "15px").attr("class", "temporal info").text("در حال بارگذاری نقشه ...");
        $.get(app.urlPrefix + "Moderation/Map/Get?Id=" + mapId, null, function(data) {
            if (data.result) {
                settings.map = data.map;
                settings.map.id = mapId;
                drawMap(data.map.data);
            } else {
                d3.select(selector + " .info").text("نقشه انتخاب شده معتبر نیست. در منوی تنظیمات یک نقشه را انتخاب کنید یا نقشه‌ی مورد نظر خود را بارگذاری نمایید.");
            }
        });
    }
    function drawMap(data) {
        var data = JSON.parse(data);
        var mainIndex = seriesLabels.indexOf(settings.chartProp.info.mainSeries);
        if (mainIndex == -1) mainIndex = 0;
        $(selector + " .temporal").remove();
        var mapData = {};
        var mapDataClickValue = {};
        var sum = 0;
        for (var i = 0; i < input.matrix.length; i++) {
            var d = +input.series.data[i][mainIndex];
            mapData[input.matrix[i].captions[0]] = d;
            mapDataClickValue[input.matrix[i].values[0]] = input.matrix[i].values[0];
            sum += d;
        }
        settings.chartProp.info.colorStart = settings.chartProp.info.colorStart || "#31a354";
        settings.chartProp.info.colorEnd = settings.chartProp.info.colorEnd || "#c7e9c0";
        var mainProp = $.extend({
            formatString: ",.0f",
            colorStart: "#31a354",
            colorEnd: "#c7e9c0"
        }, settings.chartProp.series[input.series.labels[mainIndex]]);
        var max = d3.max(input.series.data, function(d) {
            return +d[mainIndex];
        });
        var min = d3.min(input.series.data, function(d) {
            return +d[mainIndex];
        });
        var color = d3.interpolate(settings.chartProp.info.colorEnd, settings.chartProp.info.colorStart);
        var pointerClass = "pointer";
        if (!settings.editMode) {
            pointerClass = "";
        }
        var legendDiv = d3.select(selector).append("div").attr("class", "legend temporal " + pointerClass).styles({
            "text-align": "left",
            position: "absolute",
            "background-color": "#fff",
            "z-index": "1",
            "border-radius": "4px",
            padding: "10px"
        });
        var legendHaveText = false;
        settings.chartProp.info.legendPosition = settings.chartProp.info.legendPosition || "top left";
        var st = {
            "top right": {
                top: 0,
                right: 0
            },
            "top left": {
                top: 0,
                left: 0
            },
            "top center": {
                top: 0,
                right: "50%",
                transform: "translate(50%)"
            },
            "bottom right": {
                bottom: 0,
                right: 0
            },
            "bottom left": {
                bottom: 0,
                left: 0
            },
            "bottom center": {
                bottom: 0,
                right: "50%",
                transform: "translate(50%)"
            },
            "center right": {
                top: "50%",
                right: 0
            },
            "center left": {
                top: "50%",
                left: 0
            }
        };
        legendDiv.styles(st[settings.chartProp.info.legendPosition]);
        if (settings.chartProp.info.showLegend) {
            legend(selector, settings.chartProp.info.colorStart, settings.chartProp.info.colorEnd, min, max, mainProp, legendDiv, mainIndex);
            legendHaveText = true;
        }
        if (settings.chartProp.indicatorLegendShow) {
            legendHaveText = true;
            legendDiv.legend({
                order: "vertical",
                colorPos: "right",
                width: width,
                font: settings.chartProp.indicatorLegendFont,
                position: settings.chartProp.info.legendPosition,
                selector: selector,
                data: _.map(settings.chartProp.indicator, function(d, i) {
                    var then = _.find(d.thenRow, {
                        operand: "1"
                    });
                    var color = then ? then.secondFieldColor : "#eeeeee";
                    var title = d.title || app.chartCommons.indicator.ifToString(d.ifRow, input.series.labels, input.seriesLablesCaptions, settings);
                    return {
                        label: title,
                        color: color
                    };
                })
            }, showPersian);
        }
        if (settings.chartProp.info.showChart && settings.chartProp.info.showChartLegend) {
            var labels = _.map(input.series.labels, function(d, i) {
                return {
                    name: d,
                    prop: getProp(i)
                };
            });
            legendHaveText = true;
            legendDiv.legend({
                order: "vertical",
                colorPos: "right",
                font: settings.chartProp.info.legendFont,
                width: $(selector).width(),
                selector: selector,
                data: labels.filter(function(d, i) {
                    return !d.prop.hidden;
                }).map(function(d) {
                    return {
                        label: (d.prop.name || d.name).replace(/^\[measure\]/, ""),
                        color: d.prop.color,
                        key: d.name
                    };
                })
            }, showPersian);
        }
        var height = $(selector).height();
        var width = $(selector).width();
        if (height < 150) height = 150;
        var json = topojson.feature(data, data.objects.map);
        var indexes = input.matrix.map(function(d) {
            return d.captions[0];
        });
        var codes = _.map(data.objects.map.geometries, "properties.Code");
        var diff = _.differenceWith(indexes, codes, _.isEqual);
        var extraCode = settings.chartProp.info.extraCode || {};
        if (extraCode.enable) {
            legendHaveText = true;
            legendDiv.insert("div", ":first-child").selectAll(".diff").data(diff).enter().append("div").style("margin-bottom", "10px").html(function(d) {
                var index = indexes.indexOf(d + "");
                var data = input.series.data[index];
                var item = _.find(extraCode.items, {
                    code: d
                });
                var name = item && item.caption ? item.caption : d;
                var h = getTooltipHtml(index, tootipType, name);
                var dh = $("<div />").html(h);
                dh.find("> div").css("font-size", settings.chartProp.info.extraCode.font.fontSize || "9px").css("font-family", settings.chartProp.info.extraCode.font.fontName || "IRANSans").css("font-weight", settings.chartProp.info.extraCode.font.bold ? "bold" : "200" || "200").css("font-style", settings.chartProp.info.extraCode.font.italic ? "italic" : "inherit" || "inherit");
                h = dh.html();
                return h;
            });
        }
        var colors = d3.scaleOrdinal(d3.schemeCategory10);
        var maxHeight = height * .25 * (settings.chartProp.info.chartSize || 50) / 100;
        var barWidth = 5;
        var barOriginOfsset = 8;
        var svg = null;
        function drawLeaflet() {
            var realMap = settings.chartProp.info.realMap || {};
            var url = "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";
            if (realMap.type === "open-street-online") {
                url = "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";
            }
            if (realMap.type === "open-street-offline") {
                url = "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";
            }
            if (realMap.type === "google-offline") {
                url = app.urlPrefix + "map_data//Tiles/{z}/gm_{x}_{y}_{z}.png";
            }
            if (realMap.type === "google-online") {
                url = "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";
            }
            $("#" + settings.id).append('<div class="temporal" id = "map" style = "width: 100%; height:100%;" ></div > ');
            var map = L.map($(selector + " #map").get(0)).setView([ 32.8, 53.6894 ], 5);
            L.tileLayer(url, {
                attributionControl: false,
                attribution: "داشبورد مدیریتی صدف"
            }).addTo(map);
            function onEachFeature(feature, layer) {
                layer.on({
                    mousemove: function(e) {
                        var d = e.target.feature;
                        mouseOver(d, null, null, e.containerPoint);
                    },
                    mouseout: mouseOut,
                    click: function(e) {
                        console.log(e);
                        var d = e.target.feature;
                        clicked(d);
                    }
                });
            }
            var geo = L.geoJson(json, {
                style: function(f, i) {
                    var color = getColorOfMap(f);
                    return {
                        color: settings.chartProp.info.borderColor || "#666",
                        strokeWidth: (settings.chartProp.info.borderWidth || "0.5") + "px",
                        fillColor: color,
                        fillOpacity: realMap.fillOpacity || .5,
                        weight: .8
                    };
                },
                onEachFeature: onEachFeature
            }).addTo(map);
            svg = d3.select(map.getPanes().overlayPane).append("svg");
            if (legendHaveText) {
                var legend = L.control({
                    position: settings.chartProp.info.legendPosition.replace(" ", "")
                });
                legend.onAdd = function(map) {
                    var div = $("<div />").css({
                        background: "#fff",
                        padding: "10px",
                        "border-radius": "4px",
                        "font-family": "iransans"
                    }).html(legendDiv.html()).get(0);
                    legendDiv.style("display", "none");
                    return div;
                };
                legend.addTo(map);
            }
            var getCenter = function(d) {
                var latLng = [ 0, 0 ];
                geo.eachLayer(function(layer) {
                    if (layer.feature.properties.Code === d.properties.Code) {
                        latLng = layer.getBounds().getCenter();
                    }
                });
                var center = map.latLngToLayerPoint(latLng);
                return center;
            };
            var dp = function() {
                if (settings.chartProp.info.showChart && settings.chartProp.info.chartType === "bar") {
                    drawBar(svg, getCenter, null);
                }
                if (settings.chartProp.info.showChart && settings.chartProp.info.chartType === "pie") {
                    drawPie(svg, getCenter, null);
                }
                if (settings.chartProp.info.showName) {
                    showNames(svg, getCenter);
                }
                if (settings.chartProp.info.showValue) {
                    showValues(svg, getCenter);
                }
            };
            map.on("zoomstart", function(e) {
                $(svg.node()).fadeOut();
            });
            var timer = null;
            map.on("zoomend", function(e) {
                if (timer) clearTimeout(timer);
                timer = setTimeout(function() {
                    svg.selectAll("*").remove();
                    dp();
                    $(svg.node()).fadeIn();
                }, 400);
            });
            dp();
            var panes = map.getPanes();
            var z = 1;
            _.each(panes, function(pane) {
                pane.style.zIndex = z++;
            });
            $(selector + " .leaflet-control-container").children().css("z-index", 1);
            console.log($(selector + " .leaflet-control-zoom "));
        }
        var path;
        function drawD3() {
            var projection = d3.geoMercator().scale(1).translate([ 0, 0 ]);
            path = d3.geoPath().projection(projection);
            var b = path.bounds(json), s = .95 / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height), t = [ (width - s * (b[1][0] + b[0][0])) / 2, (height - s * (b[1][1] + b[0][1])) / 2 ];
            projection.scale(s).translate(t);
            path = path.projection(projection);
            svg = d3.select(selector).append("div").style("overflow", "hidden").style("position", "relative").attr("class", "map-container temporal").append("svg").attr("class", "temporal").attr("width", width).attr("height", height).append("g");
            svg.selectAll("path").data(json.features).enter().append("path").attr("d", path).classed("pointer", true).style("fill", getColorOfMap).on("click", clicked).on("mousemove", mouseOver).on("mouseout", mouseOut);
            svg.append("path").datum(topojson.mesh(data, data.objects.map, function(a, b) {
                return true;
            })).attr("id", "state-borders").attr("stroke", settings.chartProp.info.borderColor || "#666").style("stroke-width", (settings.chartProp.info.borderWidth || "0.5") + "px").attr("d", path);
            if (settings.chartProp.info.showChart && settings.chartProp.info.chartType === "bar") {
                drawBar(svg, function(d) {
                    var c = path.centroid(d);
                    return {
                        x: c[0],
                        y: c[1]
                    };
                }, clicked);
            }
            if (settings.chartProp.info.showChart && settings.chartProp.info.chartType === "pie") {
                drawPie(svg, function(d) {
                    var c = path.centroid(d);
                    return {
                        x: c[0],
                        y: c[1]
                    };
                }, clicked);
            }
            if (settings.chartProp.info.showName) {
                showNames(svg, function(d) {
                    var c = path.centroid(d);
                    return {
                        x: c[0],
                        y: c[1]
                    };
                }, clicked);
            }
            if (settings.chartProp.info.showValue) {
                showValues(svg, function(d) {
                    var c = path.centroid(d);
                    return {
                        x: c[0],
                        y: c[1]
                    };
                }, clicked);
            }
        }
        function getColorOfMap(d) {
            var headers = input.series.labels;
            var index = indexes.indexOf(d.properties.Code + "");
            if (index !== -1) {
                var data = input.series.data[index];
                var tarr = app.chartCommons.indicator.getIndicator(data, headers, settings.chartProp.indicator);
                var thens = _.flatten(tarr);
                if (thens.length > 0) {
                    var thenFilter = _.filter(thens, {
                        operand: "1"
                    });
                    var then = _.first(thenFilter);
                    if (then) return then.secondFieldColor;
                }
            }
            var value = mapData[d.properties.Code + ""];
            if (typeof value === "undefined") return settings.chartProp.info.defaultColor || "#eee";
            if (max - min === 0) return color(1);
            return color((value - min) / (max - min));
        }
        if (!legendHaveText) {
            legendDiv.remove();
        }
        var mapType = settings.chartProp.info.mapType || "path";
        if (mapType === "path") {
            drawD3();
        } else {
            drawLeaflet();
        }
        var centered;
        function clicked(d) {
            if (hasHref && !settings.editMode) {
                var data = d.properties.Code + "";
                app.chartCommons.openLink(settings.chartProp.info.openDashboard, {
                    ChartInPageId: settings.ChartInPageId,
                    DataSourceId: settings.input.DataSourceId,
                    dimensionName: settings.input.dimensionName,
                    value: [ data ],
                    caption: [ d.properties.Name + "" ],
                    refreshDatasource: settings.input.RefreshDatasource
                });
                return;
            }
            var value = [ d.properties.Code + "" ];
            var caption = [ d.properties.Name + "" ];
            if (typeof path !== "undefined") {
                var x, y, k;
                if (d && centered !== d) {
                    var centroid = path.centroid(d);
                    x = centroid[0];
                    y = centroid[1];
                    k = 4;
                    centered = d;
                } else {
                    x = width / 2;
                    y = height / 2;
                    k = 1;
                    centered = null;
                    value = null;
                    caption = null;
                }
                svg.selectAll("path").classed("active", centered && function(d) {
                    return d === centered;
                });
                svg.transition().duration(750).attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")").style("stroke-width", 1.5 / k + "px");
            }
            var selectableArea = settings.chartProp.info.selectableArea;
            if (typeof selectableArea === "undefined") selectableArea = true;
            if (!settings.editMode && selectableArea) {
                app.chartCommons.userFilter.setFilter({
                    id: settings.ChartInPageId,
                    values: value,
                    valuesCaption: caption,
                    variableType: 0,
                    dimensionName: input.dimensionName,
                    chartInPageId: settings.ChartInPageId,
                    datasourceId: input.DataSourceId,
                    disableClear: false
                });
                app.moderation.dashboadpage.refreshRelatedDatasources(input.RefreshDatasource, [ +settings.ChartInPageId ]);
                app.filterBox.refresh();
            }
        }
        function mouseOver(d, i, pathes, containerPoint) {
            var index = indexes.indexOf(d.properties.Code + "");
            var center = {};
            if (!containerPoint) {
                var coordinates = d3.mouse($(this).parents("svg").get(0));
                center.x = coordinates[0] + 7;
                center.y = coordinates[1] + 7;
            } else {
                center = containerPoint;
            }
            d3.select(selector + " #map-tooltip ").transition().duration(200).style("opacity", .9);
            d3.select(selector + " #map-tooltip ").html(getTooltipHtml(index, tootipType, d.properties.Name)).style("left", center.x + "px").style("top", center.y + "px");
        }
        function mouseOut() {
            d3.select(selector + " #map-tooltip ").transition().duration(500).style("opacity", 0);
        }
        d3.select(selector).append("div").attr("id", "map-tooltip").attr("class", "temporal");
        _.each(input.series.labels, function(d, i) {
            var p = getProp(i);
            p.color = p.color || colors(i);
        });
        function drawBar(svg, getCenter, clicked) {
            svg.selectAll("g.bar").data(json.features).enter().append("g").classed("bar", true).attr("transform", function(d) {
                var index = indexes.indexOf(d.properties.Code + "");
                var data = input.series.data[index];
                d.childes = _.map(data, function(c, i) {
                    return {
                        index: i,
                        data: c
                    };
                });
                d.childes = _.filter(d.childes, function(c) {
                    return !getProp(c.index).hidden;
                });
                var center = getCenter(d);
                return "translate(" + (center.x - d.childes.length * barWidth / 2) + ", " + center.y + ")";
            }).on("click", clicked).on("mousemove", mouseOver).on("mouseout", mouseOut).selectAll("rect").data(function(d) {
                return d.childes;
            }).enter().append("rect").attr("width", barWidth + "px").attr("fill", function(d, i) {
                return getProp(d.index).color || colors(i);
            }).attr("height", function(d) {
                var normal = d.data / max;
                return normal * maxHeight + "px";
            }).attr("transform", function(d, i) {
                var normal = d.data / max;
                return "translate(" + i * barWidth + ", -" + normal * maxHeight + ")";
            });
        }
        function drawPie(svg, getCenter, clicked) {
            var pie = d3.pie().value(function(d) {
                return d.data;
            });
            var allSeriesMax = d3.max(input.series.data, function(d) {
                return d3.max(d, function(c) {
                    return +c;
                });
            });
            svg.selectAll("g.pie").data(json.features).enter().append("g").classed("pie", true).style("pointer-events", "auto").attr("transform", function(d) {
                var index = indexes.indexOf(d.properties.Code + "");
                var data = input.series.data[index];
                d.childes = _.map(data, function(c, i) {
                    return {
                        index: i,
                        data: c
                    };
                });
                d.childes = _.filter(d.childes, function(c) {
                    return !getProp(c.index).hidden;
                });
                var lMax = d3.max(d.childes, function(c) {
                    return c.data;
                });
                var o = lMax / allSeriesMax * maxHeight * .65;
                var minO = maxHeight * .65 / 2.5;
                if (minO > o) o = minO;
                var arc = d3.arc().innerRadius(0).outerRadius(o);
                _.each(d.childes, function(c) {
                    c.arc = arc;
                });
                var center = getCenter(d);
                return "translate(" + (center.x - d.childes.length * barWidth / 2) + ", " + center.y + ")";
            }).on("click", clicked).on("mousemove", mouseOver).on("mouseout", mouseOut).selectAll("path").data(function(d) {
                return pie(d.childes);
            }).enter().append("path").attr("d", function(d) {
                return d.data.arc(d);
            }).style("pointer-events", "auto").attr("fill", function(d, i) {
                return getProp(d.data.index).color || colors(i);
            });
        }
        function showNames(svg, getCenter, clicked) {
            svg.selectAll(".city-name").data(json.features).enter().append("svg:text").classed("city-name", true).text(function(d) {
                return d.properties.Name;
            }).attr("x", function(d) {
                return getCenter(d).x;
            }).attr("y", function(d) {
                return getCenter(d).y + barOriginOfsset;
            }).attr("text-anchor", "middle").attr("fill", settings.chartProp.info.nameEditor.color || "#333").style("font-size", settings.chartProp.info.nameEditor.fontSize || "9px").style("font-family", settings.chartProp.info.nameEditor.fontName || "IRANSans").style("font-weight", settings.chartProp.info.nameEditor.bold ? "bold" : "200" || "200").style("font-style", settings.chartProp.info.nameEditor.italic ? "italic" : "inherit" || "inherit").on("click", clicked).on("mousemove", mouseOver).on("mouseout", mouseOut);
        }
        function showValues(svg, getCenter, clicked) {
            svg.selectAll(".data-value").data(json.features).enter().append("svg:text").classed("data-value", true).text(function(d) {
                var value = mapData[d.properties.Code + ""];
                if (typeof value === "undefined") {
                    return "";
                }
                return persian(d3.format(settings.chartProp.info.valueEditor.formatString)(value), showPersian);
            }).attr("x", function(d) {
                return getCenter(d).x;
            }).attr("y", function(d) {
                return getCenter(d).y + barOriginOfsset + (settings.chartProp.info.showName ? -10 : 0);
            }).attr("text-anchor", "middle").attr("fill", settings.chartProp.info.valueEditor.color || "#333").style("font-size", settings.chartProp.info.valueEditor.fontSize || "9px").style("font-family", settings.chartProp.info.valueEditor.fontName || "IRANSans").style("font-weight", settings.chartProp.info.valueEditor.bold ? "bold" : "200" || "200").style("font-style", settings.chartProp.info.valueEditor.italic ? "italic" : "inherit" || "inherit").on("click", clicked).on("mousemove", mouseOver).on("mouseout", mouseOut);
        }
    }
    function legend(selector, color1, color2, min, max, mainProp, legend, mainIndex) {
        if (!settings.chartProp.info.showLegend) {
            return d3.select(selector).append("div");
        }
        var label = mainProp.name || input.seriesLablesCaptions[mainIndex];
        var colorGradientWidth = $(selector).width() * .05;
        var div = legend.append("div").style("text-align", "right").style("margin-bottom", "10px");
        div.append("div").text(label).style("margin", "0 0px");
        var innerdiv = div.append("div").classed("ltr", true).style("display", "inline-block");
        innerdiv.append("span").text(persian(d3.format(mainProp.formatString)(min || 0), showPersian));
        innerdiv.append("div").style("background", "-webkit-linear-gradient(to right, " + color2 + ", " + color1 + ")").style("background", "-o-linear-gradient(to right, " + color2 + ", " + color1 + ")").style("background", "-moz-linear-gradient(to right, " + color2 + ", " + color1 + ")").style("background", "linear-gradient(to right, " + color2 + ", " + color1 + ")").style("display", "inline-block").style("height", "7px").style("width", colorGradientWidth + "px").style("margin", "0 7px");
        innerdiv.append("span").text(persian(d3.format(mainProp.formatString)(max || 100), showPersian));
        if (!settings.chartProp.info.showChart || !settings.chartProp.info.showChartLegend) legend.on("click", function() {
            if (selector) {
                $(selector).trigger("legendClick", [ label, 0, {
                    key: input.series.labels[0]
                } ]);
            }
        });
        return legend;
    }
    function getProp(i) {
        return settings.chartProp.series[input.series.labels[i]];
    }
    function getTooltipHtml(index, type, key) {
        if (index == -1) {
            return app.chartCommons.tooltip.tooltipFormatter({
                points: input.series.labels.map(function(d, i) {
                    return {
                        data: "NaN",
                        label: getProp(i).name || input.series.labels[i],
                        format: getProp(i).formatString
                    };
                }),
                key: key,
                sum: "NaN",
                avg: "NaN",
                format: ",.2f"
            }, settings.chartProp.info.tooltipHeader, settings.chartProp.info.tooltipFormat, showPersian);
        }
        var d = input.series.data[index];
        if (type == 1) {
            d = [ d[0] ];
        } else if (type == 2) {
            var d = d.filter(function(d, i) {
                return !getProp(i).hidden;
            });
        }
        d = d.map(function(d, i) {
            return {
                data: d,
                label: getProp(i).name || input.seriesLablesCaptions[i],
                format: getProp(i).formatString
            };
        });
        return app.chartCommons.tooltip.tooltipFormatter({
            points: d,
            key: key,
            sum: d3.sum(d, function(d) {
                return d.data;
            }),
            avg: d3.sum(d, function(d) {
                return d.data;
            }) / d.length,
            format: d.length > 0 ? d[0].format : ",.2f"
        }, settings.chartProp.info.tooltipHeader, settings.chartProp.info.tooltipFormat);
    }
};

var app = app || {};

app.charts = app.charts || {};

app.charts.pie = {};

app.charts.pie.draw = function(input, settings, refreshWithData, titlebar) {
    settings.input = input;
    app.chartCommons.calculateFields(input.series, settings.calculatedFields);
    var title = input.title;
    var chartInfo = input.chartInfo;
    var seriesLabels = typeof input.series != "undefined" ? input.series.labels : [];
    var kpisLabels = typeof input.kpis != "undefined" ? input.kpis.labels : [];
    var showLabelOnChart = settings.chartProp.info.showLabels || settings.chartProp.info.showValues || settings.chartProp.info.showValuesPercent;
    var yAxeLable = settings.LabelY;
    var selector = "#" + settings.id;
    var margin = {
        top: 10,
        right: 20,
        bottom: 0,
        left: 20
    };
    var width = $(selector).width();
    var divHeight = $(selector).height();
    var barHeight = settings.chartProp.info.chartSize == "small" ? 150 : settings.chartProp.info.chartSize == "medium" ? 200 : settings.chartProp.info.chartSize == "large" ? 250 : settings.chartProp.info.chartSize == "veryLarge" ? 400 : 130;
    settings.width = width;
    var showPersian = typeof input.lang == "undefined" ? true : +input.lang == 0 ? true : false;
    var isProgress = titlebar.isProgress;
    var showProgress = titlebar.showProgress;
    var title = titlebar.title;
    var hasHref = settings.chartProp.info.openDashboard && settings.chartProp.info.openDashboard.checked;
    app.chartCommons.setDefault(settings.chartProp, kpisLabels.concat(seriesLabels), "pie");
    if (settings.editMode) {
        $(selector).trigger("chartproperty", [ kpisLabels.concat(seriesLabels) ]);
        $(selector).trigger("dimColor", [ _.map(input.matrix, function(d) {
            return d.values.join("-");
        }) ]);
    }
    if (!input.result) {
        $("#" + settings.id).append(app.chartCommons.getError(input));
        return;
    }
    $(selector).addClass("pie-chart");
    var data = prepareData(input);
    var seriesLabelsCaptions = input.seriesLablesCaptions;
    var kpisLabelsCaptions = input.kpisLablesCaptions;
    d3Utils.prepareDataForBarChart(data, settings, seriesLabels, kpisLabels, seriesLabelsCaptions, kpisLabelsCaptions);
    var sum = data.length == 0 ? [ 1 ] : data[0].series.map(function(d, i) {
        return d3.sum(data.map(function(d) {
            return d.series[i].data;
        }));
    });
    var colors = d3.scaleOrdinal(d3.schemeCategory10);
    switch (+settings.chartProp.info.colorType) {
      case 2:
        colors = d3.scaleOrdinal(d3.schemeBrBG[11]);
        break;

      case 3:
        colors = d3.scaleOrdinal(d3.schemePuOr[11]);
        break;

      case 4:
        colors = d3.scaleOrdinal(d3.schemeRdGy[11]);
        break;

      default:    }
    var getSeriesVal = function(d) {
        var f = d.series.filter(function(d) {
            return d.type === "series" && d.prop.main;
        });
        if (f.length > 0) return f[0].data;
        return d.series.filter(function(d) {
            return d.type === "series";
        })[0].data;
    };
    function getColor(d, i) {
        var dimColor = settings.chartProp.info.dimColor = settings.chartProp.info.dimColor || {};
        if (dimColor.enable) {
            var c = dimColor.data[d.value.join("-")];
            c = c || {};
            return c.color || colors(i);
        }
        return colors(i);
    }
    var legendBar = d3.select(selector).append("div").attr("class", "legend-bar temporal");
    legendBar.breadcrumb(input.levels, settings, titlebar, showPersian);
    if (!settings.chartProp.info.showLabels) {
        legendBar.legend({
            width: width,
            font: settings.chartProp.info.legendFont,
            position: settings.chartProp.info.legendPosition,
            selector: selector,
            data: data.map(function(d, i) {
                var f = d.series.filter(function(d) {
                    return d.type === "series" && d.prop.main;
                });
                var point = null;
                if (f.length > 0) point = f[0]; else point = d.series.filter(function(d) {
                    return d.type === "series";
                })[0];
                var r = {
                    label: d.label.join(", "),
                    color: getColor(d, i)
                };
                return r;
            })
        }, showPersian);
        legendBar.style("margin-bottom", "12px");
    } else {
        legendBar.append("div").attr("class", "legendBar");
    }
    var rootDiv = null;
    if (_.indexOf([ "bottom left", "bottom right", "bottom center" ], settings.chartProp.info.legendPosition) != -1) {
        rootDiv = d3.select(selector).insert("div", ":first-child").attr("class", "temporal").style("position", "relative");
    } else {
        rootDiv = d3.select(selector).append("div").attr("class", "temporal").style("position", "relative");
    }
    var arc;
    function renderPie() {
        console.log("#### renderPie");
        var height = 0;
        app.dashboardLayoutVersion = app.dashboardLayoutVersion || 2;
        if (app.dashboardLayoutVersion === 2) {
            var titleHeight = $(selector + " .title").outerHeight() || 0;
            var lb = $(selector + " .legend-bar");
            var legendHeight = typeof lb == "undefined" ? 0 : lb.outerHeight(true);
            height = $(selector).height() - titleHeight - legendHeight;
        } else if (app.dashboardLayoutVersion == 1) {
            width = barHeight;
            if (width > 300) width = 300;
        }
        var svgroot = rootDiv.append("svg").attr("class", "temporal").attr("width", width).attr("height", height);
        function calcRadius() {
            var radius = Math.min(width, height) / 2;
            var innerR = +settings.chartProp.info.hole / 100 * radius;
            var arc = d3.arc().innerRadius(innerR).outerRadius(radius);
            var arcText = d3.arc().innerRadius(radius * 1.1).outerRadius(radius * 1.1);
            return {
                radius: radius,
                arc: arc,
                arcText: arcText
            };
        }
        function midAngle(d) {
            return d.startAngle + (d.endAngle - d.startAngle) / 2;
        }
        var cr = calcRadius();
        var radius = cr.radius;
        arc = cr.arc;
        var arcText = cr.arcText;
        svgroot.append("svg:rect").attr("class", "background").style("fill", "white").style("opacity", "0").attr("width", width).attr("height", height).on("click", function(d, i) {
            if (input.levels == "") return;
            if (isProgress()) return;
            showProgress(true);
            settings.parameters = {
                isUp: true,
                chartId: settings.chartId,
                ChartInPageId: settings.ChartInPageId,
                notEditMode: !settings.editMode
            };
            app.chartCommons.drillDown.up(settings.ChartInPageId);
            app.chartCommons.levelTypeUtils.getParam(settings);
            $(selector).charts(settings.type, "refreshWithData", settings);
        }).on("mouseout", mouseout);
        var svg = svgroot.append("g").attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");
        var pie = d3.pie().value(getSeriesVal);
        if (!settings.chartProp.info.sort) {
            pie = pie.sort(null);
        }
        var path = svg.datum(data).selectAll("path").data(pie).enter();
        _.each(path._groups[0], function(d) {
            d.__data__.category = d.__data__.data.series[0].category;
            d.__data__.seriesLable = d.__data__.data.series[0].seriesLable;
            d.__data__.seriesKey = d.__data__.data.series[0].seriesKey;
            d.__data__.commentCount = d.__data__.data.series[0].commentCount;
        });
        var text = null;
        if (showLabelOnChart) {
            var leftSpace = 0, rightSpace = 0, labelHeight;
            svg.append("g").attr("class", "labels");
            text = svg.select(".labels").selectAll("text").data(pie).enter().append("text");
            text.attr("class", function(d, i) {
                return d.data.onClickVal != "" || flag || hasHref ? "label pointer" : " label";
            }).attr("id", function(d, j) {
                return "l-" + j;
            }).attr("dy", ".35em").text(function(d, i) {
                var ret = [];
                if (settings.chartProp.info.showLabels) {
                    ret.push(persian(d.data.label, showPersian));
                }
                if (settings.chartProp.info.showValues) {
                    ret.push(persian(d3.format(settings.chartProp.info.legendFont.formatString)(d.value), showPersian));
                }
                if (settings.chartProp.info.showValuesPercent) {
                    ret.push(persian(d3.format(",.2f")(d.value * 100 / sum), showPersian) + "%");
                }
                return ret.join(" - ");
            }).styles({
                direction: "rtl",
                "font-size": settings.chartProp.info.legendFont.fontSize
            }).on("click", click).on("mouseover", mouseover).on("mousemove", mouseover).each(function(d) {
                var side = midAngle(d) >= Math.PI ? "left" : "right";
                var w = this.getBBox();
                labelHeight = w.height;
                if (side == "left") {
                    if (leftSpace < w.width) leftSpace = w.width;
                } else {
                    if (rightSpace < w.width) rightSpace = w.width;
                }
            });
            width = width - rightSpace - leftSpace - 20;
            if (width < 70) width = 70;
            height = height - labelHeight * 2;
            cr = calcRadius();
            radius = cr.radius;
            arc = cr.arc;
            arcText = cr.arcText;
        }
        var flag = settings.chartProp.globalvariable && settings.chartProp.globalvariable.length > 0 && !settings.editMode && settings.chartProp.globalvariable.filter(function(d) {
            return d.field == input.CurrentDimName;
        }).length > 0;
        var parts = path.append("g").classed("part", true);
        parts.append("path").attr("class", function(d, i) {
            return d.data.onClickVal != "" || flag || hasHref ? "arc pointer" : " arc";
        }).attr("title", "").attr("fill", function(d, i) {
            return getColor(d.data, i);
        }).attr("d", arc).each(function(d) {
            this._current = d.data.series[0].data;
        }).on("click", click).on("mouseover", mouseover).on("mousemove", mouseover);
        var isFromCommentDialog = $(selector).hasClass("fromCommentDialog");
        app.chartCommons.commentUtils.addCommentIcon(settings.ChartInPageId, parts, function(d) {
            return arc.centroid(d)[0];
        }, function(d) {
            return arc.centroid(d)[1];
        });
        if (isFromCommentDialog) {
            app.chartCommons.commentUtils.setOnHighlightListener(parts, settings.ChartInPageId);
        }
        function click(d, i) {
            if (isFromCommentDialog) {
                app.chartCommons.commentUtils.clickOnCommentIcon(d, settings.ChartInPageId);
                return;
            }
            if (settings.chartProp.globalvariable && settings.chartProp.globalvariable.length > 0 && !settings.editMode) {
                app.globalVariableHelper.updateGlobalVariables([ input.CurrentDimName ], [ d.data.value ], settings.chartProp.globalvariable);
                $(selector + " path.selected-item").attr("class", $(this).attr("class").replace("selected-item", ""));
                $(this).attr("class", $(this).attr("class") + " selected-item");
            }
            if (d.data.onClickVal == "") {
                if (hasHref && !settings.editMode) {
                    app.chartCommons.openLink(settings.chartProp.info.openDashboard, {
                        ChartInPageId: settings.ChartInPageId,
                        DataSourceId: settings.input.DataSourceId,
                        dimensionName: settings.input.dimensionName,
                        value: d.value,
                        refreshDatasource: settings.input.RefreshDatasource
                    });
                }
                return;
            }
            if (isProgress()) return;
            showProgress(true);
            app.chartCommons.drillDown.add(settings.ChartInPageId, settings.input.DataSourceId, settings.input.CurrentDimName, d.data.onClickVal, settings.input.RefreshDatasource);
            settings.parameters = {
                selectedItem: d.data.onClickVal,
                chartId: settings.chartId,
                ChartInPageId: settings.ChartInPageId,
                notEditMode: !settings.editMode
            }, app.chartCommons.levelTypeUtils.getParam(settings);
            $(selector).charts(settings.type, "refreshWithData", settings);
        }
        function getrect(a) {
            return {
                left: a.pos[0] - (a.anchor === "start" ? a.box.width : 0),
                right: a.pos[0] + (a.anchor === "start" ? 0 : a.box.width),
                top: a.pos[1],
                bottom: a.pos[1] + a.box.height
            };
        }
        if (showLabelOnChart) {
            var index = [];
            text.attr("transform", function(d, i) {
                var pos = arcText.centroid(d);
                pos[0] = radius * 1.1 * (midAngle(d) < Math.PI ? 1 : -1);
                index[i] = {
                    pos: pos,
                    box: this.getBBox(),
                    data: d.data.label[0]
                };
                return "translate(" + pos + ")";
            }).style("text-anchor", function(d, i) {
                index[i].anchor = midAngle(d) >= Math.PI ? "start" : "end";
                return midAngle(d) >= Math.PI ? "start" : "end";
            }).style("display", function(d) {
                var a = d3.select(this);
                var atrans = getTransformation(a.attr("transform"));
                var aSign = a.style("text-anchor") == "start" ? 1 : -1;
                var aBox = this.getBBox();
                var ret = "auto";
                return ret;
            });
            for (var i = 0; i < index.length - 1; i++) {
                var base = index[i];
                for (var j = i + 1; j < index.length; j++) {
                    var item = index[j];
                    if (item.hide === true) continue;
                    var r1 = getrect(base);
                    var r2 = getrect(item);
                    var left = Math.max(r1.left, r2.left);
                    var right = Math.min(r1.right, r2.right);
                    var bottom = Math.min(r1.bottom, r2.bottom);
                    var top = Math.max(r1.top, r2.top);
                    if (left < right && bottom > top) {
                        item.hide = true;
                    }
                }
            }
            text.style("display", function(d, i) {
                return index[i].hide === true ? "none" : "auto";
            });
            svg.append("g").attr("class", "lines");
            var polyline = svg.select(".lines").selectAll("polyline").data(pie).enter().append("polyline");
            polyline.attr("points", function(d, i) {
                this._current = this._current || d;
                var interpolate = d3.interpolate(this._current, d);
                this._current = interpolate(0);
                var pos = arcText.centroid(d);
                pos[0] = radius * 1 * (midAngle(d) < Math.PI ? 1 : -1);
                return [ arc.centroid(d), arcText.centroid(d), pos ];
            }).style("display", function(d, i) {
                return $(selector + " #l-" + i).css("display");
            });
        }
    }
    var render = false;
    if (document.fonts.status === "loading") {
        app.charts.pie.fontCallback = app.charts.pie.fontCallback || [];
        app.charts.pie.fontCallback.push(function() {
            if (!render) {
                render = true;
                renderPie();
            }
        });
        document.fonts.onloadingdone = function(fontFaceSetEvent) {
            _.each(app.charts.pie.fontCallback, function(f) {
                if (f) f();
            });
        };
    } else {
        renderPie();
    }
    var spacing = 22;
    var alpha = .5;
    var loop = 0;
    function relax() {
        loop++;
        again = false;
        text.each(function(d, i) {
            a = this;
            da = d3.select(a);
            y1 = da.attr("y");
            var xy = da.attr("transform").replace(/translate\((.*)\)/gi, "$1").split(",").map(function(d) {
                return +d;
            });
            text.each(function(d, j) {
                b = this;
                if (a == b) return;
                db = d3.select(b);
                var xy2 = db.attr("transform").replace(/translate\((.*)\)/gi, "$1").split(",").map(function(d) {
                    return +d;
                });
                if (da.attr("text-anchor") != db.attr("text-anchor")) return;
                y2 = db.attr("y");
                deltaY = xy[1] - xy2[1];
                if (Math.abs(deltaY) > spacing) return;
                again = true;
                sign = deltaY > 0 ? 1 : -1;
                adjust = sign * alpha;
                da.attr("transform", "translate(" + xy[0] + "," + (xy[1] + adjust) + ")");
                da.attr("transform", "translate(" + xy2[0] + "," + (xy2[1] + adjust) + ")");
            });
        });
        if (again && loop < 5) {
            labelElements = text[0];
            setTimeout(relax, 20);
        }
    }
    function getTransformation(transform) {
        var g = document.createElementNS("http://www.w3.org/2000/svg", "g");
        g.setAttributeNS(null, "transform", transform);
        var matrix = g.transform.baseVal.consolidate().matrix;
        var a = matrix.a;
        var b = matrix.b;
        var c = matrix.c;
        var d = matrix.d;
        var e = matrix.e;
        var f = matrix.f;
        var scaleX, scaleY, skewX;
        if (scaleX = Math.sqrt(a * a + b * b)) a /= scaleX, b /= scaleX;
        if (skewX = a * c + b * d) c -= a * skewX, d -= b * skewX;
        if (scaleY = Math.sqrt(c * c + d * d)) c /= scaleY, d /= scaleY, skewX /= scaleY;
        if (a * d < b * c) a = -a, b = -b, skewX = -skewX, scaleX = -scaleX;
        return {
            translateX: e,
            translateY: f,
            rotate: Math.atan2(b, a) * Math.PI / 180,
            skewX: Math.atan(skewX) * Math.PI / 180,
            scaleX: scaleX,
            scaleY: scaleY
        };
    }
    function arrangeLabels(selection, label_class) {
        var move = 1;
        while (move > 0) {
            move = 0;
            selection.selectAll(label_class).each(function() {
                var that = this;
                var a = this.getBoundingClientRect();
                selection.selectAll(label_class).each(function() {
                    if (this != that) {
                        var b = this.getBoundingClientRect();
                        if (Math.abs(a.left - b.left) * 2 < a.width + b.width && Math.abs(a.top - b.top) * 2 < a.height + b.height) {
                            var dx = (Math.max(0, a.right - b.left) + Math.min(0, a.left - b.right)) * .01;
                            var dy = (Math.max(0, a.bottom - b.top) + Math.min(0, a.top - b.bottom)) * .02;
                            var tt = getTransformation(d3.select(this).attr("transform"));
                            var to = getTransformation(d3.select(that).attr("transform"));
                            move += Math.abs(dx) + Math.abs(dy);
                            to.translate = [ to.translateX + dx, to.translateY + dy ];
                            tt.translate = [ tt.translateX - dx, tt.translateY - dy ];
                            d3.select(this).attr("transform", "translate(" + tt.translate + ")");
                            d3.select(that).attr("transform", "translate(" + to.translate + ")");
                            a = this.getBoundingClientRect();
                        }
                    }
                });
            });
        }
    }
    var div = rootDiv.append("div").style("position", "absolute").style("color", "#fff").style("-moz-border-radius", "5px").style("-webkit-border-radius", "5px").style("border-radius", "5px").style("padding", "7px 15px").style("text-align", "right").style("z-index", "10").style("opacity", "0").style("background-color", "#000");
    function mouseover(d) {
        var coordinates = [ 0, 0 ];
        coordinates = d3.mouse(rootDiv.node());
        var x = coordinates[0] + 7;
        var y = coordinates[1] + 7;
        var point = arc.centroid(d);
        var series = d.data.series;
        var type = +settings.chartProp.info.tooltip || 1;
        if (type == 1) {
            series = [ series[0] ];
        }
        if (type == 2) series = series.filter(function(d) {
            return !d.prop.hidden;
        });
        series = series.map(function(d, i) {
            return {
                data: d.data,
                label: d.prop.name || d.label,
                format: settings.chartProp.info.formatString,
                color: d.prop.seriesColor,
                percentage: d.data * 100 / sum[i]
            };
        });
        var html = app.chartCommons.tooltip.tooltipFormatter({
            points: series,
            key: d.data.label,
            sum: d3.sum(d, function(d) {
                return d.data;
            }),
            avg: d3.sum(d, function(d) {
                return d.data;
            }) / d.length,
            format: d.length > 0 ? d[0].format : ",.2f"
        }, settings.chartProp.info.tooltipHeader, settings.chartProp.info.tooltipFormat, showPersian);
        div.html(html);
        div.style("opacity", 1).style("left", x + "px").style("top", y + "px");
    }
    function mouseout(d) {
        div.transition().duration(500).style("opacity", 1e-6).end().then(function() {
            div.style("left", 0 + "px").style("top", 0 + "px");
        });
    }
    $(selector).trigger("heightChange");
};

var app = app || {};

app.charts = app.charts || {};

app.charts.radar = {};

app.charts.radar.draw = function(input, settings, refreshWithData, titlebar) {
    settings.input = input;
    app.chartCommons.calculateFields(input.series, settings.calculatedFields);
    var chartTitle = input.title;
    var chartInfo = input.chartInfo;
    var showPersian = typeof input.lang == "undefined" ? true : +input.lang == 0 ? true : false;
    var seriesLabels = typeof input.series != "undefined" ? input.series.labels : [];
    var kpisLabels = typeof input.kpis != "undefined" ? input.kpis.labels : [];
    var selector = "#" + settings.id;
    var margin = {
        top: 10,
        right: 20,
        bottom: 0,
        left: 20
    };
    var barHeight = settings.chartProp.info.chartSize == "small" ? 180 : settings.chartProp.info.chartSize == "medium" ? 250 : settings.chartProp.info.chartSize == "large" ? 400 : settings.chartProp.info.chartSize == "veryLarge" ? 600 : 130;
    var hasHref = settings.chartProp.info.openDashboard && settings.chartProp.info.openDashboard.checked;
    var width = $(selector).width();
    var height = $(selector).height() - margin.top - margin.bottom;
    var colors = d3.scaleOrdinal(d3.schemeCategory10);
    settings.width = width;
    var isProgress = titlebar.isProgress;
    var showProgress = titlebar.showProgress;
    var title = titlebar.title;
    $(selector).addClass("radar-chart");
    app.chartCommons.setDefault(settings.chartProp, kpisLabels.concat(seriesLabels), "radar");
    if (settings.editMode) {
        $(selector).trigger("chartproperty", [ kpisLabels.concat(seriesLabels) ]);
    }
    if (!input.result) {
        $("#" + settings.id).append(app.chartCommons.getError(input));
        return;
    }
    var data = prepareData(input);
    for (var i = 0; i < data.length; i++) {
        for (var j = 0; j < data[i].series.length; j++) {
            if (settings.chartProp.series[seriesLabels[j]].cumulative) data[i].series[j] += data[i - 1] ? data[i - 1].series[j] : 0;
        }
    }
    var legendBar = d3.select(selector).append("div").attr("class", "legend-bar temporal");
    legendBar.breadcrumb(input.levels, settings, titlebar, showPersian);
    if (!input.matrix || input.matrix.length == 0) {
        d3.select(selector).append("div").attr("class", "temporal").style("font-size", "0.8em").style("margin", "15px").append("span").attr("class", "translate").attr("data-trans-key", "داده‌ای برای نمایش وجود ندارد").text("داده‌ای برای نمایش وجود ندارد");
        return;
    }
    var seriesLabelsCaptions = input.seriesLablesCaptions;
    var kpisLabelsCaptions = input.kpisLablesCaptions;
    d3Utils.prepareDataForBarChart(data, settings, seriesLabels, kpisLabels, seriesLabelsCaptions, kpisLabelsCaptions);
    legendBar.legend({
        width: width,
        selector: selector,
        data: data[0].series.filter(function(d) {
            return !d.prop.hidden;
        }).map(function(d) {
            return {
                label: (d.prop.name || d.label).replace(/^\[measure\]/, ""),
                color: d.prop.seriesColor,
                key: d.key
            };
        })
    }, showPersian);
    var titleHeight = $(selector + " .title").outerHeight() || 0;
    var lb = $(selector + " .legend-bar");
    var legendHeight = typeof lb == "undefined" ? 0 : lb.height() + +lb.css("margin-top").replace("px", "");
    height = $(selector).height() - titleHeight - legendHeight;
    if (height < 150) height = 150;
    var font = _.extend({
        bold: false,
        color: "#737373",
        italic: false,
        fontSize: "10px",
        fontName: "IRANSans",
        formatString: settings.chartProp.info.formatString || ",.2f",
        formatStringCustom: ",.2f"
    }, settings.chartProp.info.font);
    var drow = function() {
        var cfg = {
            radius: 4,
            w: 600,
            h: 600,
            factor: 1,
            factorLegend: .85,
            levels: 6,
            maxValue: 0,
            radians: 2 * Math.PI,
            opacityArea: .5,
            ToRight: 5,
            TranslateX: 0,
            TranslateY: 0,
            ExtraWidthX: 0,
            ExtraWidthY: 0,
            color: d3.scaleOrdinal(d3.schemeCategory10)
        };
        var div = d3.select(selector).append("div").attr("class", "temporal").style("position", "relative").style("margin", "0 auto").style("text-align", "left");
        var allAxis = data.map(function(i, j) {
            return i.label;
        });
        var total = allAxis.length;
        var textDivHeight = 0;
        var axisLableTemp = div.selectAll(".axis-label").data(allAxis).enter().append("div").text(function(d) {
            return persian(d, showPersian);
        }).attr("class", "axis-label").style("width", "100px").style("font-size", "11px").style("padding", "5px").style("text-overflow", "ellipsis").style("white-space", "nowrap").style("text-align", function(d, i) {
            textDivHeight = $(this).outerHeight() || 0;
            return "right";
        });
        axisLableTemp.remove();
        cfg.h = Math.min(height - textDivHeight * 2, width - 200);
        cfg.w = cfg.h;
        cfg.maxValue = Math.max(cfg.maxValue, d3.max(data, function(i) {
            return d3.max(i.series.filter(function(d, i) {
                return !d.prop.hidden;
            }).map(function(o) {
                return o.data;
            }));
        }));
        var radius = cfg.factor * Math.min(cfg.w / 2, cfg.h / 2);
        var Format = d3.format("%");
        div.style("height", cfg.h + textDivHeight * 2 + "px");
        div.style("width", cfg.w + 200 + "px");
        var dd = div.append("div");
        var svg = dd.append("svg");
        var axisLable = div.selectAll(".axis-label").data(allAxis).enter().append("div").text(function(d) {
            return persian(d, showPersian);
        }).attr("title", function(d) {
            return d;
        }).attr("class", "axis-label").style("width", "100px").style("position", "absolute").style("font-size", "11px").style("padding", "5px").style("text-overflow", "ellipsis").style("white-space", "nowrap").style("overflow", "hidden").style("text-align", function(d, i) {
            var left = cfg.w / 2 * (1 - cfg.factor * Math.sin(i * cfg.radians / total));
            var align = "right";
            if (left >= cfg.w / 2) align = "left";
            return align;
        });
        var textDivHeight = 0;
        axisLable.style("left", function(d, i) {
            var left = cfg.w / 2 * (1 - cfg.factor * Math.sin(i * cfg.radians / total));
            if (left >= cfg.w / 2) left += 100;
            return left + "px";
        }).style("top", function(d, i) {
            var h = $(d3.select(this).node()).outerHeight() || 0;
            textDivHeight = h;
            var top = cfg.h / 2 * (1 - cfg.factor * Math.cos(i * cfg.radians / total));
            top += h / 2;
            if (i == 0) top = 0;
            return top + "px";
        });
        var topOffset = textDivHeight;
        dd.style("left", "100px").style("position", "absolute").style("top", topOffset + "px");
        var g = svg.attr("width", cfg.w).attr("height", cfg.h).append("g").attr("transform", "translate(" + cfg.TranslateX + "," + cfg.TranslateY + ")");
        var tooltip;
        for (var j = 0; j < cfg.levels - 1; j++) {
            var levelFactor = cfg.factor * radius * ((j + 1) / cfg.levels);
            g.selectAll(".levels").data(allAxis).enter().append("svg:line").attr("x1", function(d, i) {
                return levelFactor * (1 - cfg.factor * Math.sin(i * cfg.radians / total));
            }).attr("y1", function(d, i) {
                return levelFactor * (1 - cfg.factor * Math.cos(i * cfg.radians / total));
            }).attr("x2", function(d, i) {
                return levelFactor * (1 - cfg.factor * Math.sin((i + 1) * cfg.radians / total));
            }).attr("y2", function(d, i) {
                return levelFactor * (1 - cfg.factor * Math.cos((i + 1) * cfg.radians / total));
            }).attr("class", "line").style("stroke", "grey").style("stroke-opacity", "0.75").style("stroke-width", "0.3px").attr("transform", "translate(" + (cfg.w / 2 - levelFactor) + ", " + (cfg.h / 2 - levelFactor) + ")");
        }
        for (var j = 0; j < cfg.levels; j++) {
            var levelFactor = cfg.factor * radius * ((j + 1) / cfg.levels);
            g.selectAll(".levels").data([ 1 ]).enter().append("svg:text").attr("x", function(d) {
                return levelFactor * (1 - cfg.factor * Math.sin(0));
            }).attr("y", function(d) {
                return levelFactor * (1 - cfg.factor * Math.cos(0));
            }).attr("class", "legend").style("font-size", font.fontSize).style("font-family", font.fontName).attr("dy", "1em").attr("transform", "translate(" + (cfg.w / 2 - levelFactor + cfg.ToRight) + ", " + (cfg.h / 2 - levelFactor) + ")").attr("fill", font.color).text(persian(d3.format(font.formatString)((j + 1) * cfg.maxValue / cfg.levels), showPersian));
        }
        var axis = g.selectAll(".axis").data(allAxis).enter().append("g").attr("class", "axis");
        axis.append("line").attr("x1", cfg.w / 2).attr("y1", cfg.h / 2).attr("x2", function(d, i) {
            return cfg.w / 2 * (1 - cfg.factor * Math.sin(i * cfg.radians / total));
        }).attr("y2", function(d, i) {
            return cfg.h / 2 * (1 - cfg.factor * Math.cos(i * cfg.radians / total));
        }).attr("class", "line").style("stroke", "grey").style("stroke-width", "1px");
        series = 0;
        data[0].series.forEach(function(y, x) {
            if (y.prop.hidden) return;
            dataValues = [];
            g.selectAll(".nodes").data(data, function(j, i) {
                dataValues.push([ cfg.w / 2 * (1 - parseFloat(Math.max(j.series[x].data, 0)) / cfg.maxValue * cfg.factor * Math.sin(i * cfg.radians / total)), cfg.h / 2 * (1 - parseFloat(Math.max(j.series[x].data, 0)) / cfg.maxValue * cfg.factor * Math.cos(i * cfg.radians / total)) ]);
            });
            dataValues.push(dataValues[0]);
            g.selectAll(".area").data([ dataValues ]).enter().append("polygon").attr("class", "radar-chart-serie" + series).style("stroke-width", "2px").style("stroke", data[0].series[x].prop.seriesColor).attr("points", function(d) {
                var str = "";
                for (var pti = 0; pti < d.length; pti++) {
                    str = str + cfg.w / 2 + "," + cfg.h / 2 + " ";
                }
                return str;
            }).style("fill", function(j, i) {
                return data[0].series[x].prop.seriesColor;
            }).style("fill-opacity", cfg.opacityArea).on("mouseover", function(d) {
                z = "polygon." + d3.select(this).attr("class");
                g.selectAll("polygon").transition(200).style("fill-opacity", .1);
                g.selectAll(z).transition(200).style("fill-opacity", .7);
            }).on("mouseout", function() {
                g.selectAll("polygon").transition(200).style("fill-opacity", cfg.opacityArea);
            }).transition(500).attr("points", function(d) {
                var str = "";
                for (var pti = 0; pti < d.length; pti++) {
                    str = str + d[pti][0] + "," + d[pti][1] + " ";
                }
                return str;
            });
            series++;
        });
        series = 0;
        var flag = settings.chartProp.globalvariable && settings.chartProp.globalvariable.length > 0 && !settings.editMode && settings.chartProp.globalvariable.filter(function(d) {
            return d.field == input.CurrentDimName;
        }).length > 0;
        _.each(data, function(d) {});
        var nData = data[0].series.map(function(d, i) {
            return data.map(function(m) {
                var s = m.series[i];
                s.onClickVal = m.onClickVal;
                return s;
            });
        });
        var entriesGroup = g.selectAll(".entry-group").data(nData).enter().append("g").classed("entry-group", true);
        var entries = entriesGroup.selectAll(".entry-group").data(function(d) {
            return d;
        }).enter().append("g").classed("entry", true);
        var isFromCommentDialog = $(selector).hasClass("fromCommentDialog");
        entries.append("svg:circle").attr("class", function(d, i) {
            return "radar-chart-serie" + i + " " + (d.onClickVal != "" || flag || hasHref ? " pointer" : "");
        }).classed("circle", true).attr("r", cfg.radius).attr("alt", function(j) {
            return d3.format(font.formatString)(j.data);
        }).attr("cx", function(j, i) {
            return cfg.w / 2;
        }).attr("cy", function(j, i) {
            return cfg.h / 2;
        }).attr("data-id", function(j) {
            return j.axis;
        }).style("fill", "#fff").style("stroke", function(d) {
            return d.prop.seriesColor;
        }).style("stroke-width", "2px").on("click", function(d, i) {
            if (isFromCommentDialog) {
                app.chartCommons.commentUtils.clickOnCommentIcon(d, settings.ChartInPageId);
                return;
            }
            if (settings.chartProp.globalvariable && settings.chartProp.globalvariable.length > 0 && !settings.editMode) {
                app.globalVariableHelper.updateGlobalVariables([ input.CurrentDimName ], [ d.value ], settings.chartProp.globalvariable);
                $(selector + " circle.selected-item").attr("class", $(this).attr("class").replace("selected-item", ""));
                $(this).attr("class", $(this).attr("class") + " selected-item");
            }
            if (d.onClickVal == "") {
                if (hasHref && !settings.editMode) {
                    app.chartCommons.openLink(settings.chartProp.info.openDashboard, {
                        ChartInPageId: settings.ChartInPageId,
                        DataSourceId: settings.input.DataSourceId,
                        dimensionName: settings.input.dimensionName,
                        value: d.value,
                        refreshDatasource: settings.input.RefreshDatasource
                    });
                }
                return;
            }
            if (isProgress()) return;
            showProgress(true);
            settings.parameters = {
                selectedItem: d.onClickVal,
                chartId: settings.chartId,
                ChartInPageId: settings.ChartInPageId,
                notEditMode: !settings.editMode
            };
            app.chartCommons.drillDown.add(settings.ChartInPageId, settings.input.DataSourceId, settings.input.CurrentDimName, d.onClickVal, settings.input.RefreshDatasource);
            app.chartCommons.levelTypeUtils.getParam(settings);
            $(selector).charts(settings.type, "refreshWithData", settings);
        }).on("mouseover", function(d) {
            newX = parseFloat(d3.select(this).attr("cx"));
            newY = parseFloat(d3.select(this).attr("cy"));
            tooltip.style("left", newX + 105 + "px").style("top", newY - 5 + "px").html(d.label + "<br/><b>" + d.label + ": </b>" + persian(d3.format(font.formatString)(d.data), showPersian)).transition(200).style("opacity", 1);
            var w = $(tooltip[0][0]).width();
            var h = $(tooltip[0][0]).height();
            tooltip.style("top", newY + h / 2 + "px");
            z = "polygon." + d3.select(this).attr("class");
            g.selectAll("polygon").transition(200).style("fill-opacity", .1);
            g.selectAll(z).transition(200).style("fill-opacity", .7);
        }).on("mouseout", function() {
            tooltip.transition(200).style("opacity", 0).each("end", function() {
                tooltip.style("left", 0).style("top", 0);
            });
            g.selectAll("polygon").transition(200).style("fill-opacity", cfg.opacityArea);
        }).transition(500).attr("cx", function(j, i) {
            return cfg.w / 2 * (1 - Math.max(j.data, 0) / cfg.maxValue * cfg.factor * Math.sin(i * cfg.radians / total));
        }).attr("cy", function(j, i) {
            return cfg.h / 2 * (1 - Math.max(j.data, 0) / cfg.maxValue * cfg.factor * Math.cos(i * cfg.radians / total));
        });
        app.chartCommons.commentUtils.addCommentIcon(settings.ChartInPageId, entries, function(j, i) {
            return cfg.w / 2 * (1 - Math.max(j.data, 0) / cfg.maxValue * cfg.factor * Math.sin(i * cfg.radians / total)) - 5;
        }, function(j, i) {
            return cfg.h / 2 * (1 - Math.max(j.data, 0) / cfg.maxValue * cfg.factor * Math.cos(i * cfg.radians / total)) - 24;
        });
        if (isFromCommentDialog) {
            app.chartCommons.commentUtils.setOnHighlightListener(entries, settings.ChartInPageId);
        }
        tooltip = div.append("div").attr("class", "tooltip").style("position", "absolute").style("color", "#fff").style("-moz-border-radius", "5px").style("-webkit-border-radius", "5px").style("border-radius", "5px").style("padding", "7px 15px").style("text-align", "right").style("z-index", "1000").style("opacity", "0").style("background-color", "#000").style("max-width", "200px").style("opacity", 0).style("font-size", "13px");
    };
    drow();
    $(selector).trigger("heightChange");
};

var app = app || {};

app.charts = app.charts || {};

app.charts.table = {};

app.charts.table.draw = function(input, settings, refreshWithData, titlebar) {
    var selector = "#" + settings.id;
    var margin = {
        top: 10,
        right: 20,
        bottom: 0,
        left: 20
    };
    var width = $(selector).width();
    var barHeight = settings.chartProp.info.chartSize == "small" ? 170 : settings.chartProp.info.chartSize == "medium" ? 300 : settings.chartProp.info.chartSize == "large" ? 400 : settings.chartProp.info.chartSize == "veryLarge" ? 500 : 250;
    var height = barHeight + margin.top + margin.bottom;
    settings.width = width;
    var isProgress = titlebar.isProgress;
    var showProgress = titlebar.showProgress;
    var title = titlebar.title;
    var showPersian = typeof input.lang == "undefined" ? true : +input.lang == 0 ? true : false;
    var hasHref = settings.chartProp.info.openDashboard && settings.chartProp.info.openDashboard.checked;
    if (_.isArray(settings.chartProp.info.columnsWidth)) {}
    var nullReplcament = settings.chartProp.info.nullReplacement;
    if (_.isUndefined(nullReplcament)) {
        nullReplcament = "";
    }
    var lastTableInfo = $(selector).data("table-info");
    var TableInfo = lastTableInfo || settings.tableInfo || {};
    $(selector).data("table-info", TableInfo);
    var showHeader = typeof settings.chartProp.info.showHeader != "undefined" ? settings.chartProp.info.showHeader : true;
    $(selector).addClass("table-chart-container table-chart");
    $(selector).parents(".content").addClass("hidden-overflow");
    if (settings.editMode) {
        $(selector).addClass("edit-mode");
        $(selector).css("margin", "0px");
    }
    if (app.dashboardLayoutVersion == 2 && !settings.editMode) {
        var titleHeight = $(selector + " .title").outerHeight() || 0;
        var chartHeight = $(selector).height() - titleHeight;
        barHeight = chartHeight;
    }
    if (typeof settings.chartProp.info.stripped == "undefined") settings.chartProp.info.stripped = true;
    if (typeof settings.chartProp.info.hover == "undefined") settings.chartProp.info.hover = true;
    var tableStyle = (settings.chartProp.info.bordered ? " table-bordered" : "") + (settings.chartProp.info.stripped ? " table-striped" : "") + (settings.chartProp.info.hover ? " table-hover" : "") + " ";
    var rowNumberLablel = "#ردیف";
    var tableInfo = {
        option: {},
        headerTemplate: function(headers) {
            var v = tableInfo;
            _.map(headers, function(h, i) {
                h.index = i;
            });
            this.filteredHeaders = _.filter(headers, function(h) {
                return !h.prop.isHidden;
            });
            var getHeaderStyle = function(prop) {
                var styleArray = [ "font-weight:" + (tableInfo.option.settings.chartProp.info.headerFont.bold ? "bold" : "normal"), "font-style:" + tableInfo.option.settings.chartProp.info.headerFont.italic ? "italic" : "normal", "font-size:" + tableInfo.option.settings.chartProp.info.headerFont.fontSize, "text-align:" + (prop.font.align || tableInfo.option.settings.chartProp.info.headerFont.align), "color:" + tableInfo.option.settings.chartProp.info.headerFont.color, "font-family:" + tableInfo.option.settings.chartProp.info.headerFont.fontName ];
                var style = styleArray.join(";");
                if (!tableInfo.option.settings.chartProp.info.headerNowrap) {
                    style += ";white-space:initial;";
                }
                return style;
            };
            var ths = _.map(this.filteredHeaders, function(h, i) {
                var name = filterXSS(h.prop.name || h.value);
                tableInfo.option.page = tableInfo.option.page || {};
                var entry = _.find(tableInfo.option.page.Order, {
                    Index: i
                });
                var icon = "";
                if (entry) {
                    icon = '<i class="icon sort ' + (entry.DescType == 1 ? "ascending" : "descending") + '"></i>';
                }
                tableInfo.option.settings.chartProp.info.headerFont = tableInfo.option.settings.chartProp.info.headerFont || {
                    bold: true,
                    italic: false,
                    fontSize: "13px",
                    fontName: "IRANSans"
                };
                var styleColumn = tableInfo.option.tableData.headers[h.index].prop;
                styleColumn.font = styleColumn.font || {};
                var style = getHeaderStyle(styleColumn);
                return '<th title="' + name + '" ><span class="resize"></span><div style="' + style + '">' + name + icon + "</div></th>";
            }).join("");
            var rowNum = "";
            if (settings.chartProp.info.showRowNumber) {
                var prop = tableInfo.option.settings.chartProp.series[rowNumberLablel];
                prop = prop || {};
                prop.font = prop.font || {};
                var styleArray = getHeaderStyle(prop);
                rowNum = '<th title="" ><span class="resize"></span><div style="' + styleArray + '">ردیف</div></th>';
            }
            return "<tr>" + rowNum + ths + "</tr>";
        },
        getFooterTemplate: function() {
            if (!_.some(tableInfo.option.resultRows, function(d) {
                return +d.Type > 0;
            })) return "";
            var ths = _.map(_.filter(tableInfo.option.tableData.headers, function(h, i) {
                return !h.prop.isHidden;
            }), function(h) {
                var info = _.find(tableInfo.option.resultRows, {
                    Name: h.key
                });
                if (!info || +info.Type === 0) return "<td><div></div></td>";
                var s = {
                    data: info.Value
                };
                var i = _.findIndex(tableInfo.option.tableData.headers, {
                    key: h.key
                });
                var style = tableInfo.getStyle(tableInfo.option.tableData.headers[i].prop);
                return '<td style="' + style + '" title="' + tableInfo.getText(s, i) + '"><div>' + tableInfo.getText(s, i) + "</div></td>";
            }).join("");
            var rowNum = "";
            if (settings.chartProp.info.showRowNumber) {
                rowNum = "<td><div></div></td>";
            }
            var t = '  <table class="ui celled table unstackable small  footer-table" style="margin:0;border-left: none;border-right: none;">                                                  ' + "    <tbody>                                                " + "<tr>" + rowNum + ths + "</tr>" + "    </tbody>                                               " + "  </table>                                                 ";
            return t;
        },
        svg: '<svg  class="td-comment" width="24" height="24" style="position: absolute; left: 6px; fill-opacity: 0.5;"><g transform="translate(0,0)scale(0.38)" class="comment"><rect width="24" height="24" class="comment-background"></rect><path d="M10.718,18.561l6.78,5.311C17.609,23.957,17.677,24,17.743,24  c0.188,0,0.244-0.127,0.244-0.338v-5.023c0-0.355,0.233-0.637,0.548-0.637L21,18c2.219,0,3-1.094,3-2s0-13,0-14s-0.748-2-3.014-2  H2.989C0.802,0,0,0.969,0,2s0,13.031,0,14s0.828,2,3,2h6C9,18,10.255,18.035,10.718,18.561z"></path><text x="34" y="0.7em" style="font-size: 20px;"></text></g></svg>',
        svgShow: '<svg  class="" width="24" height="24" style="position: absolute; left: 6px; fill-opacity: 0.5;"><g transform="translate(0,0)scale(0.38)" class="comment show"><rect width="24" height="24" class="comment-background"></rect><path d="M10.718,18.561l6.78,5.311C17.609,23.957,17.677,24,17.743,24  c0.188,0,0.244-0.127,0.244-0.338v-5.023c0-0.355,0.233-0.637,0.548-0.637L21,18c2.219,0,3-1.094,3-2s0-13,0-14s-0.748-2-3.014-2  H2.989C0.802,0,0,0.969,0,2s0,13.031,0,14s0.828,2,3,2h6C9,18,10.255,18.035,10.718,18.561z"></path><text x="34" y="0.7em" style="font-size: 20px;"></text></g></svg>',
        bodyTemplate: function(tableData) {
            var pageTemplate = "";
            if (this.option.remoteData) {
                var currentPage = this.option.page.Page;
                pageTemplate = this.paging(currentPage);
            }
            var stripClass = settings.chartProp.info.stripped ? "striped " : "";
            var hoverClass = settings.chartProp.info.hover ? "selectable " : "";
            var borderClass = settings.chartProp.info.bordered ? "celled " : "";
            var t = '<div class="clusterize temporal" style="overflow: hidden;">                                   ' + '  <table class="ui ' + stripClass + hoverClass + borderClass + ' table unstackable small  header-table" style="margin:0;border-left: none;border-right: none;">                                                  ' + "    <thead>                                                " + tableInfo.headerTemplate(tableData.headers) + "    </thead>                                               " + "  </table>                                                 " + '  <div id="scrollArea' + settings.id + '" class="clusterize-scroll" style="xdisplay: flex;max-height:200px; overflow:auto;">          ' + '    <table class="ui ' + stripClass + hoverClass + borderClass + ' table unstackable  small body-table" style="margin:0;border: none; border-bottom: 1px solid #eaeaea;">                                                ' + '      <tbody id="contentArea' + settings.id + '" class="clusterize-content">  ' + '        <tr class="clusterize-no-data">                    ' + "          <td>Loading data…</td>                           " + "        </tr>                                              " + "      </tbody>                                             " + "    </table>                                               " + (app.commentOnChart ? tableInfo.svg : "") + "  </div>                                                   " + tableInfo.getFooterTemplate(tableData.headers) + pageTemplate + "</div>                                                     ";
            return t;
        },
        getStyle: function(prop) {
            if (prop.formatString == "%") prop.formatString = ".0%";
            prop.font = _.extendWith({}, {
                bold: prop.textBold,
                italic: prop.textItalic,
                fontSize: prop.fontSize,
                color: prop.color,
                formatString: prop.formatString,
                fontName: "IRANSans"
            }, prop.font);
            var style = [ "font-weight:" + (prop.font.bold ? "bold" : "normal"), "font-style:" + prop.font.italic ? "italic" : "normal", "font-size:" + prop.font.fontSize, "font-family:" + prop.font.fontName, "text-align:" + (prop.font.align || prop.textAlign), "color:" + prop.font.color, "position:relative", "display:" + (prop.isHidden ? "none" : "auto") ];
            if (prop.forceLtr) {
                style.push(app.lang.isRtl() ? "direction:ltr" : "direction:rtl");
            }
            if (tableInfo.option.settings.chartProp.info.wrapContent) {
                style.push("white-space:initial");
                style.push("height:" + (tableInfo.option.settings.chartProp.info.cellHeight || 50) + "px");
            }
            return style.join(";");
        },
        getThenStyle: function(thens) {
            var style = [];
            if (thens) {
                _.each(thens, function(d) {
                    switch (+d.operand) {
                      case 1:
                        style.push("color:" + d.secondFieldColor);
                        break;

                      case 3:
                        style.push("background-color:" + d.secondFieldBackColor);
                        break;

                      case 4:
                        var v = +d.secondFieldStyle;
                        if (v === 1) {
                            style.push("font-weight: normal");
                            style.push("font-style: normal");
                        }
                        if (v === 2 || v === 4) style.push("font-weight: bold");
                        if (v === 3 || v === 4) style.push("font-style: italic");
                        if (v === 5) style.push("text-decoration: underline");
                        break;
                    }
                });
            }
            var icon = _.head(_.filter(thens, {
                operand: "2"
            }));
            console.log("icon", icon);
            var iconTemp = "";
            if (icon && icon.secondFieldIcon && icon.secondFieldIcon.type === "image") {
                iconTemp = ' <img style="width:1.5em" src="' + app.urlPrefix + "api/upload/getpic/" + icon.secondFieldIcon.name + '"></i>';
            } else if (icon && icon.secondFieldIcon) {
                var name = icon.secondFieldIcon.name || icon.secondFieldIcon;
                iconTemp = ' <i class="' + name + '"></i>';
            }
            var replace = _.head(_.filter(thens, {
                operand: "5"
            }));
            if (replace) replace = replace.secondFieldReplace;
            return {
                style: style.join(";"),
                icon: iconTemp,
                replace: replace
            };
        },
        getText: function(e, i) {
            var d = e.data;
            if (d === "") return nullReplcament;
            var isHtml = tableInfo.option.tableData.headers[i].prop.isHtml;
            var isn = isNaN(d);
            if (!isn) {
                var f = tableInfo.option.tableData.headers[i].prop.font.formatString;
                if (f === "custom") {
                    f = tableInfo.option.tableData.headers[i].prop.font.formatStringCustom;
                }
                return isHtml ? d : persian(d3.format(f)(d), showPersian);
            }
            return isHtml ? d : persian(d, showPersian);
        },
        render: function(option) {
            tableInfo.option = option;
            var selector = option.selector;
            var settings = option.settings;
            var tableData = option.tableData;
            var resultRows = option.resultRows;
            var isFromCommentDialog = $(selector).hasClass("fromCommentDialog");
            $(selector).append(tableInfo.bodyTemplate(tableData));
            var hKeys = _.map(tableData.headers, "key");
            tableInfo.dataset = tableData.rows.map(function(d, rowIndex) {
                var tarr = app.chartCommons.indicator.getIndicator(_.map(d, "data"), hKeys, settings.chartProp.indicator);
                var thens = _.flatten(tarr);
                var tdVals = [];
                var tds = d.map(function(s, colIndex) {
                    var thisThen = _.filter(thens, {
                        firstField: tableInfo.option.tableData.headers[colIndex].key
                    });
                    var style = tableInfo.getStyle(tableInfo.option.tableData.headers[colIndex].prop);
                    var thenStyle = tableInfo.getThenStyle(thisThen);
                    if (!tableInfo.option.tableData.headers[colIndex].prop.isHidden) {
                        tdVals.push(s.data);
                    }
                    var onClickVal = "";
                    if (tableInfo.option.pivoteMode) {
                        var d = tableData.rows[rowIndex][0];
                        onClickVal = d.onClickVal;
                    }
                    var isHtml = tableInfo.option.tableData.headers[colIndex].prop.isHtml;
                    var className = "";
                    if (settings.chartProp.info.selectable !== "none" || onClickVal !== "" || hasHref || _.size(settings.chartProp.globalvariable) > 0) {
                        className = "pointer";
                    }
                    var svg = "";
                    if (s.commentCount > 0) {
                        svg = tableInfo.svgShow.replace("</text>", persian(s.commentCount, showPersian) + "</text>");
                    }
                    if (!app.commentOnChart) {
                        svg = "";
                    }
                    var txt = filterXSS(thenStyle.replace || tableInfo.getText(s, colIndex));
                    return '<td class="entry ' + className + '" data-xrow="' + rowIndex + '" data-xcol="' + colIndex + '" title="' + (isHtml ? "" : txt) + '" ><div style="' + style + ";" + thenStyle.style + '">' + txt + (thenStyle.icon || "") + svg + "</div></td>";
                }).filter(function(s, i) {
                    return !tableInfo.option.tableData.headers[i].prop.isHidden;
                });
                var rowNum = "";
                if (settings.chartProp.info.showRowNumber) {
                    var offset = 0;
                    if (tableInfo.option.page.Page) {
                        offset = tableInfo.option.page.Limit * (tableInfo.option.page.Page - 1);
                    }
                    var prop = tableInfo.option.settings.chartProp.series[rowNumberLablel];
                    prop = prop || {};
                    prop.font = prop.font || {};
                    var style = tableInfo.getStyle(prop);
                    rowNum = '<td><div style="' + style + '">' + persian(offset + rowIndex + 1) + "</div></td>";
                }
                return {
                    markup: "<tr>" + rowNum + tds.join("") + "</tr>",
                    row: tdVals
                };
            });
            var $scroll = $("#scrollArea" + settings.id);
            var $content = $("#contentArea" + settings.id);
            var $headers = $(selector + " .header-table");
            var scrollBarWidth = 7;
            var fitHeaderColumns = function() {
                var columnsWidth = [];
                var first = true;
                return function() {
                    var $firstRow = $content.find("tr:not(.clusterize-extra-row):first");
                    var childs = $firstRow.children();
                    var footer = $(selector + " .footer-table tr:first-child td");
                    var scrollWidthg = 0;
                    var tableHeight = $(selector + " .body-table").height() || 0;
                    var all = ($(selector).height() || 0) - ($(selector + " .legend-bar").height() || 0) - ($(selector + " .header-table").height() || 0) - ($(selector + " .footer-table").height() || 0) - ($(selector + " .ui.pagination").height() || 0) - 4;
                    scrollWidthg = tableHeight > all ? scrollBarWidth : 0;
                    var c = $(selector).data("columnsWidth");
                    if (c) {
                        columnsWidth = c;
                    }
                    if (_.size(columnsWidth) == 0) {
                        childs = $headers.find("tr").children();
                        $firstRow.children().each(function(i) {
                            var w = $(this).outerWidth();
                            var h = $(childs.get(i)).outerWidth();
                            if (i != 0) w--;
                            if (w < 60 && h > w) w = 60;
                            if (_.isArray(settings.chartProp.info.columnsWidth)) {
                                w = Math.max(settings.chartProp.info.columnsWidth[i], w);
                            }
                            columnsWidth.push(w);
                        });
                        if (!_.isArray(settings.chartProp.info.columnsWidth)) {
                            var chartWidth = $(selector).width();
                            var sum = 0;
                            for (var i = 0; i < columnsWidth.length; i++) {
                                sum += columnsWidth[i];
                            }
                            if (sum > chartWidth) {
                                var maxWidth = 600;
                                var lastChangeIndex = 0;
                                for (var i = 0; i < columnsWidth.length; i++) {
                                    if (columnsWidth[i] > maxWidth) {
                                        sum -= columnsWidth[i] - maxWidth;
                                        columnsWidth[i] = maxWidth;
                                        lastChangeIndex = i;
                                    }
                                    if (sum <= chartWidth) {
                                        columnsWidth[lastChangeIndex] += chartWidth - sum - scrollWidthg - columnsWidth.length - 1;
                                        break;
                                    }
                                }
                            }
                        }
                    }
                    if (!settings.chartProp.info.enableHorzScroll) {
                        var width = $(selector).width() - scrollWidthg - columnsWidth.length;
                        var sum = _.sum(columnsWidth);
                        while (sum > width) {
                            console.log(width, scrollWidthg, sum);
                            for (var i = 0; i < columnsWidth.length; i++) {
                                columnsWidth[i]--;
                                sum--;
                            }
                        }
                    }
                    $headers.find("tr").children().each(function(i) {
                        var scrollWidth = 0;
                        if (childs.length - 1 == i) {
                            scrollWidth = scrollWidthg;
                        }
                        $(this).find("div").css({
                            width: columnsWidth[i] + scrollWidth + "px"
                        });
                    });
                    childs.each(function(i) {
                        var scrollWidth = 0;
                        if (childs.length - 1 == i) {
                            scrollWidth = scrollWidthg;
                        }
                        $(footer.get(i)).find("div").css({
                            width: columnsWidth[i] + scrollWidth + "px"
                        });
                    });
                    $content.find("tr:not(.clusterize-extra-row)").each(function() {
                        $(this).children().each(function(i) {
                            $(this).find("div").css({
                                width: columnsWidth[i] + "px"
                            });
                        });
                    });
                    first = false;
                };
            }();
            function onCellClick() {
                var i = $(this).data("xrow");
                var col = $(this).data("xcol");
                if (tableInfo.option.tableData.headers[col].prop.preventClick) return;
                if (tableInfo.option.pivoteMode) {
                    var d = tableData.rows[i][0];
                    if (isFromCommentDialog) {
                        return;
                    }
                    if (settings.chartProp.globalvariable && settings.chartProp.globalvariable.length > 0 && !settings.editMode) {
                        var h = input.series.labels.concat([ input.CurrentDimName ]);
                        var dh = d.series.concat(d.label);
                        app.globalVariableHelper.updateGlobalVariables(h, dh, settings.chartProp.globalvariable);
                        $(selector + " .selected-item").removeClass("selected-item");
                        $(this).addClass("selected-item");
                    }
                    if (d.onClickVal === "" || d.onClickVal === null) {
                        if (hasHref && !settings.editMode) {
                            app.chartCommons.openLink(settings.chartProp.info.openDashboard, {
                                ChartInPageId: settings.ChartInPageId,
                                DataSourceId: settings.input.DataSourceId,
                                dimensionName: settings.input.dimensionName,
                                value: d.value,
                                refreshDatasource: settings.input.RefreshDatasource
                            });
                        } else {
                            if (col < input.CurrentDimName.length) {
                                tableInfo.onTdClick(i, col, $(this));
                            }
                        }
                        return;
                    }
                    if (isProgress()) return;
                    showProgress(true);
                    settings.parameters = {
                        selectedItem: d.onClickVal,
                        chartId: settings.chartId,
                        ChartInPageId: settings.ChartInPageId,
                        notEditMode: !settings.editMode
                    };
                    app.chartCommons.drillDown.add(settings.ChartInPageId, settings.input.DataSourceId, settings.input.CurrentDimName, d.onClickVal, settings.input.RefreshDatasource);
                    app.chartCommons.levelTypeUtils.getParam(settings);
                    $(selector).charts(settings.type, "refreshWithData", settings);
                }
                if (!tableInfo.option.pivoteMode) {
                    tableInfo.onTdClick(i, col, $(this));
                }
            }
            var data = tableInfo.dataset;
            if (!tableInfo.option.remoteData && tableInfo.option.page) {
                if (tableInfo.option.page && tableInfo.option.page.Order && tableInfo.option.page.Order.length > 0) {
                    for (var p = 0; p < tableInfo.option.page.Order.length; p++) {
                        var entry = tableInfo.option.page.Order[p];
                        data = _.orderBy(data, function(d) {
                            return d.row[p];
                        }, entry.DescType == 1 ? "asc" : "desc");
                    }
                }
            }
            var $comment;
            tableInfo.clusterize = new Clusterize({
                rows: data.map(function(d) {
                    return d.markup;
                }),
                rows_in_block: Math.floor($(selector).height() / (settings.chartProp.info.cellHeight || 50)) + 1,
                scrollId: "scrollArea" + settings.id + "",
                contentId: "contentArea" + settings.id + "",
                callbacks: {
                    clusterChanged: function() {
                        fitHeaderColumns();
                        if (!tableInfo.option.remoteData) $content.find("tr:not(.clusterize-extra-row) td").on("mouseover", function(e, i) {
                            $(this).find("div").append($comment);
                        });
                        $content.find("tr:not(.clusterize-extra-row) td").on("click", onCellClick);
                        if (isFromCommentDialog) {
                            var collection = $content.find("tr:not(.clusterize-extra-row) td");
                            $(collection[0]).data("table-data", tableInfo.option.tableData);
                            app.chartCommons.commentUtils.setOnHighlightListener($content.find("tr:not(.clusterize-extra-row) td"), settings.ChartInPageId);
                        }
                    }
                }
            });
            $comment = $(selector + " .td-comment");
            $comment.on("click", function(event) {
                var row = $(this).parents("[data-xrow]").data("xrow");
                var col = $(this).parents("[data-xcol]").data("xcol");
                var d = tableInfo.option.tableData.rows[row][col];
                app.chartCommons.commentUtils.clickOnCommentIcon(d, settings.ChartInPageId);
                event.preventDefault();
                return false;
            });
            if (settings.chartProp.info.selectable == "edit" && settings.chartProp.info.showAddButton) {
                $openForm = $(' <div style="margin:5px;" class="temporal ui mini compact button form-new-record"><i class="icon add"></i> ' + app.lang.translate("new record") + " </div>");
                $(selector).parents(".chart-widget").find(".title").append($openForm);
                $openForm.on("click", function() {
                    $("body").trigger("open-form", [ input.form, 0, selector ]);
                });
            }
            var all = ($(selector).height() || 0) - ($(selector + " .legend-bar").height() || 0) - ($(selector + " .header-table").height() || 0) - ($(selector + " .footer-table").height() || 0) - ($(selector + " .form-new-record-container").outerHeight() || 0) - ($(selector + " .ui.pagination").height() || 0) - 4;
            $(selector + " .clusterize-scroll").css({
                "max-height": all + "px",
                "min-height": all + "px"
            });
            var scrollId = "#scrollArea" + settings.id + "";
            var offset = $(scrollId).scrollLeft();
            function trans3d() {
                var sLeft = $(scrollId).scrollLeft();
                $(selector + " .header-table").css("-ms-transform", "translate3d(" + (-offset + sLeft) + "px,0px,0px)");
                $(selector + " .footer-table").css("-ms-transform", "translate3d(" + (-offset + sLeft) + "px,0px,0px)");
                $(selector + " .header-table").css("-webkit-transform", "translate3d(" + (offset - sLeft) + "px,0px,0px)");
                $(selector + " .footer-table").css("-webkit-transform", "translate3d(" + (offset - sLeft) + "px,0px,0px)");
                $(selector + " .header-table").css("-moz-transform", "translate3d(" + -sLeft + "px,0px,0px)");
                $(selector + " .footer-table").css("-moz-transform", "translate3d(" + -sLeft + "px,0px,0px)");
            }
            $(function() {
                var pressed = false;
                var start = undefined;
                var startX, startWidth;
                $(selector + " .header-table th .resize").on("click", function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                });
                $(selector + " .header-table th .resize").mousedown(function(e) {
                    start = $(this).parent().find("div");
                    pressed = true;
                    startX = e.pageX;
                    startWidth = start.outerWidth();
                    $(start).addClass("resizing");
                });
                $(document).mousemove(function(e) {
                    if (pressed) {
                        var wid = startWidth + (startX - e.pageX);
                        $(start).css({
                            width: wid + "px"
                        });
                    }
                });
                $(document).mouseup(function(e) {
                    if (pressed) {
                        $(start).removeClass("resizing");
                        pressed = false;
                        var columnsWidth = [];
                        $(selector + " .header-table th").each(function() {
                            columnsWidth.push($(this).outerWidth());
                        });
                        columnsWidth[columnsWidth.length - 1] -= scrollBarWidth;
                        var s = 0;
                        for (var i = 0; i < columnsWidth.length; i++) {
                            s += columnsWidth[i];
                        }
                        $(selector).data("columnsWidth", columnsWidth);
                        fitHeaderColumns();
                        offset = $(scrollId).scrollLeft();
                        $(selector).trigger("columnsWidth", [ {
                            columnsWidth: columnsWidth
                        } ]);
                    }
                });
            });
            $(scrollId).on("scroll", trans3d);
            trans3d();
            $(selector + " .ui.pagination a").on("click", function() {
                var page = $(this).attr("value");
                tableInfo.gotoPage(parseInt(page));
            });
            $(selector + " .header-table th").on("click", function(e, i) {
                var col = +$(this).index();
                if (settings.chartProp.info.showRowNumber) col--;
                tableInfo.option.page = tableInfo.option.page || {};
                tableInfo.option.page.Order = tableInfo.option.page.Order || [];
                var entry = _.find(tableInfo.option.page.Order, {
                    Index: col
                });
                if (!entry) {
                    entry = {
                        Index: col,
                        DescType: 2
                    };
                }
                _.remove(tableInfo.option.page.Order, entry);
                tableInfo.option.page.Order.push(entry);
                entry.DescType = entry.DescType === 1 ? 2 : 1;
                $(this).find(".icon").remove();
                $(this).find("div").append('<i class="icon sort ' + (entry.DescType === 1 ? "ascending" : "descending") + '"></i>');
                tableInfo.sort();
            });
            if (!tableInfo.option.remoteData && tableInfo.option.page.Order) {
                tableInfo.sort();
            }
        },
        sort: function() {
            if (!tableInfo.option.remoteData) {
                var funArray = _.reverse(tableInfo.option.page.Order.map(function(item) {
                    return function(d) {
                        return d.row[item.Index];
                    };
                }));
                var orderArray = _.reverse(tableInfo.option.page.Order.map(function(item) {
                    return item.DescType === 1 ? "asc" : "desc";
                }));
                tableInfo.clusterize.update(_.map(_.orderBy(tableInfo.dataset, funArray, orderArray), "markup"));
            }
            if (tableInfo.option.remoteData) {
                tableInfo.sortRemote();
            }
            if (settings.editMode) {
                $(selector).trigger("tableInfo", [ {
                    TableInfo: tableInfo.option.page
                } ]);
            }
        },
        sortRemote: function() {
            if (isProgress()) return;
            showProgress(true);
            $.extend(settings.parameters, {
                TableInfo: tableInfo.option.page,
                notEditMode: !settings.editMode
            });
            app.chartCommons.levelTypeUtils.getParam(settings);
            $(selector).charts(settings.type, "refreshWithData", settings, {
                refreshRelatedDatasources: false
            });
        },
        paging: function(current) {
            var total = Math.ceil(tableInfo.option.totalRows / tableInfo.option.page.Limit);
            var showPageCount = 5;
            if (total == 1) return;
            if (total < showPageCount) showPageCount = total;
            var isFirst = current - Math.ceil(showPageCount / 2) > 0;
            var isLast = current + Math.ceil(showPageCount / 2) < total;
            var firstVal = !isFirst ? 1 : !isLast ? total - showPageCount + 1 : current - Math.ceil(showPageCount / 2) + 1;
            var li = "";
            for (var i = 0; i < showPageCount; i++) {
                li += "<a  " + (firstVal + i == current ? 'class="active item"' : 'class="item"') + ' value="' + (firstVal + i) + '"' + ">" + persian(firstVal + i, showPersian) + "</a>";
            }
            var $paging = "";
            if (li != "") $paging = '<div  class="ui borderless pagination menu attached  " style="">                                <a  ' + (!isFirst ? 'class="disabled item"' : 'class="item"') + ' value="' + 1 + '"' + ' style="border-right:1px solid #d4d4d5; border-radius:0;">&laquo;</a>                                ' + li + "                                <a  " + (!isLast ? 'class="disabled item"' : 'class="item"') + ' value="' + total + '"' + '>&raquo;</a>                                <div class="item" style="font-size: 0.8em;color: #9E9E9E;"> ' + app.lang.translate("all rows count") + ": " + persian(this.option.totalRows, showPersian) + "</div>                            </div>";
            return $paging;
        },
        gotoPage: function(page) {
            TableInfo = tableInfo.option.page;
            if (isProgress()) return;
            showProgress(true);
            TableInfo.Page = page;
            TableInfo.IsPageValid = true;
            $.extend(settings.parameters, {
                TableInfo: TableInfo,
                notEditMode: !settings.editMode
            });
            app.chartCommons.levelTypeUtils.getParam(settings);
            $(selector).charts(settings.type, "refreshWithData", settings, {
                refreshRelatedDatasources: false
            });
            settings.parameters.TableInfo.IsPageValid = false;
        },
        onTdClick: function(row, col, $td) {
            if (typeof settings.chartProp.info.selectable == "undefined") settings.chartProp.info.selectable = "multi";
            if (settings.chartProp.info.selectable == "none") return;
            if (settings.chartProp.info.selectable == "edit") {
                $("body").trigger("open-form", [ input.form, input.formIds[row], selector ]);
                return;
            }
            var selected = $td.hasClass("selected-item");
            var idx = col + 1 + (settings.chartProp.info.showRowNumber ? 1 : 0);
            if (settings.chartProp.info.rowAsKey && settings.chartProp.info.rowKey) {
                var i = _.findIndex(this.filteredHeaders, {
                    key: settings.chartProp.info.rowKey
                });
                if (i == -1) return;
                if (settings.chartProp.info.selectable == "one") $(selector + " .selected-item").removeClass("selected-item");
                if (selected) {
                    $td.parents("tr").find("td").removeClass("selected-item");
                } else {
                    $td.parents("tr").find("td").addClass("selected-item");
                }
            } else {
                if (settings.chartProp.info.selectable == "one") $(selector + " td:nth-child(" + idx + ").selected-item").removeClass("selected-item");
                if (selected) {
                    $td.removeClass("selected-item");
                } else {
                    $td.addClass("selected-item");
                }
            }
            if (settings.editMode) return;
            var values = $(selector + " td.selected-item").map(function() {
                var xrow = +$(this).data("xrow");
                var xcol = +$(this).data("xcol");
                if (xcol != col) return null;
                return tableInfo.option.tableData.rows[xrow][xcol].data;
            }).filter(function(d) {
                return d != null;
            }).toArray();
            var dim = this.filteredHeaders[col].key;
            if (hasHref && !settings.editMode) {
                app.chartCommons.openLink(settings.chartProp.info.openDashboard, {
                    ChartInPageId: settings.ChartInPageId,
                    DataSourceId: settings.input.DataSourceId,
                    dimensionName: dim,
                    value: values,
                    refreshDatasource: settings.input.RefreshDatasource
                });
                return;
            }
            var data = {
                Id: -1,
                Values: values,
                VariableType: 0,
                dimensionName: dim,
                datasourceId: input.DataSourceId,
                chartInPageId: settings.ChartInPageId,
                chartId: input.chartId
            };
            app.moderation.dashboadpage.selectValueOnChart(data, input.RefreshDatasource);
        }
    };
    if (+input.isPivot > -1) {
        settings.input = input;
        app.chartCommons.calculateFields(input.series, settings.calculatedFields);
        var chartInfo = input.chartInfo;
        var seriesLabels = typeof input.series != "undefined" ? input.series.labels : [];
        var kpisLabels = typeof input.kpis != "undefined" ? input.kpis.labels : [];
        var labels = d3Utils.convertToKeyValue(input);
        labels.seriesLabels = labels.seriesLabels.map(function(d) {
            d.prop = getProp(d.key);
            return d;
        });
        var seriesLabelsKeys = labels.seriesLabels.map(function(d) {
            return d.key;
        });
        var seriesLabelsValues = labels.seriesLabels.map(function(d) {
            return d.value;
        });
        var yAxeLable = settings.LabelY;
        var colors = d3.scaleOrdinal(d3.schemeCategory10);
        app.chartCommons.setDefault(settings.chartProp, seriesLabelsKeys.concat(chartInfo.hierarchyLabels), "table");
        if (settings.editMode) {
            var mLabels = seriesLabelsKeys.concat(chartInfo.hierarchyLabels);
            if (settings.chartProp.info.showRowNumber) {
                mLabels.splice(0, 0, rowNumberLablel);
            }
            $(selector).trigger("chartproperty", [ mLabels ]);
        }
        if (!input.result) {
            $("#" + settings.id).append(app.chartCommons.getError(input));
            return;
        }
        var data = prepareData(input, null, true);
        var seriesLabelsCaptions = input.seriesLablesCaptions;
        var kpisLabelsCaptions = input.kpisLablesCaptions;
        d3Utils.prepareDataForBarChart(data, settings, seriesLabels, kpisLabels, seriesLabelsCaptions, kpisLabelsCaptions);
        if (input.levels && input.levels.length > 0) {
            var legendBar = d3.select(selector).append("div").attr("class", "legend-bar temporal");
            legendBar.breadcrumb(input.levels, settings, titlebar, showPersian);
        }
        if (app.dashboardLayoutVersion === 2 && !settings.editMode) {
            var lb = $(selector + " .legend-bar");
            var topMargin = lb.css("margin-top");
            var topMarginDigit = topMargin ? +lb.css("margin-top").replace("px", "") : 0;
            var legendHeight = typeof lb === "undefined" ? 0 : lb.height() + 0;
            barHeight -= legendHeight;
        }
        if (!input.matrix || input.matrix.length === 0) {
            d3.select(selector).append("div").attr("class", "temporal").style("font-size", "0.8em").style("margin", "15px").append("span").attr("class", "translate").attr("data-trans-key", "داده‌ای برای نمایش وجود ندارد").text("داده‌ای برای نمایش وجود ندارد");
            return;
        }
        var headers = labels.seriesLabels.map(function(d) {
            return {
                key: d.key,
                value: d.value,
                prop: getProp(d.key)
            };
        });
        _.each(input.CurrentDimName, function(dim) {
            headers.unshift({
                key: dim,
                value: dim,
                prop: getProp(dim)
            });
        });
        var tableData = {
            rows: data.map(function(d) {
                var row = d.series;
                _.each(d.label, function(l, i) {
                    row.unshift({
                        data: l,
                        prop: headers[i].prop,
                        key: headers[i].key,
                        label: headers[i].value,
                        onClickVal: d.onClickVal ? d.value : null,
                        value: d.value
                    });
                });
                return row;
            }),
            headers: headers
        };
        tableInfo.render({
            selector: selector,
            settings: settings,
            tableData: tableData,
            resultRows: input.resultRows,
            pivoteMode: true,
            page: settings.tableInfo
        });
        return;
    } else {
        settings.input = input;
        app.chartCommons.setDefault(settings.chartProp, input.headers, "table");
        if (settings.editMode) {
            var mLabels = input.headers.concat([]);
            if (settings.chartProp.info.showRowNumber) {
                mLabels.splice(0, 0, rowNumberLablel);
            }
            $(selector).trigger("chartproperty", [ mLabels ]);
        }
        if (!input.result) {
            $("#" + settings.id).append(app.chartCommons.getError(input));
            return;
        }
        var nonPivotMatrix = input.nonPivotMatrix;
        var dims = input.Dimentions.Hierarchies.concat(input.Dimentions.SeriesLevel || []);
        var headers = input.headers.map(function(d, i) {
            return {
                key: dims[i],
                value: d,
                prop: getProp(d)
            };
        });
        var tableData = {
            rows: nonPivotMatrix.map(function(d) {
                var row = d.map(function(r) {
                    return {
                        data: r
                    };
                });
                return row;
            }),
            headers: headers
        };
        tableInfo.render({
            selector: selector,
            settings: settings,
            tableData: tableData,
            resultRows: input.resultRows,
            page: input.TableInfo,
            totalRows: input.nonPivotMatrixLength,
            remoteData: true
        });
        return;
        d3.select(selector).append("div").attr("class", "temporal table-body");
        var currentPage = input.TableInfo.Page;
        function paging(current) {
            var total = Math.ceil(input.nonPivotMatrixLength / input.TableInfo.Limit);
            var showPageCount = 5;
            if (total == 1) return;
            if (total < showPageCount) showPageCount = total;
            var isFirst = current - Math.ceil(showPageCount / 2) > 0;
            var isLast = current + Math.ceil(showPageCount / 2) < total;
            var firstVal = !isFirst ? 1 : !isLast ? total - showPageCount + 1 : current - Math.ceil(showPageCount / 2) + 1;
            var li = "";
            for (var i = 0; i < showPageCount; i++) {
                li += "<a  " + (firstVal + i == current ? 'class="active item"' : 'class="item"') + ' value="' + (firstVal + i) + '"' + ">" + (firstVal + i) + "</a>";
            }
            if (li != "") $(selector + " .table-body").append('<div  class="ui borderless pagination menu attached  " style="">                        <a  ' + (!isFirst ? 'class="disabled item"' : 'class="item"') + ' value="' + 1 + '"' + ' style="border-right:1px solid #d4d4d5; border-radius:0;">&laquo;</a>                        ' + li + "                        <a  " + (!isLast ? 'class="disabled item"' : 'class="item"') + ' value="' + total + '"' + ">&raquo;</a>                    </ul>");
            $(selector + " .table-body .pagination a").on("click", function() {
                var page = $(this).attr("value");
                gotoPage(parseInt(page));
            });
        }
        function drawTable(selector, data, currentPage) {
            $(selector + " .table-body").empty();
            var table = d3.select(selector + " .table-body").styles({
                overflow: "hidden"
            }).append("div").attr("id", "tablescroll").append("table").attr("class", " ui celled table unstackable small table-chart" + tableStyle + (settings.chartProp.info.condensed ? "table-condensed" : ""));
            var thead = table.append("thead").style("background-color", "white").append("tr");
            var tr = table.append("tbody").selectAll("nothing").data(data).enter().append("tr").attr("class", "pointer");
            if (settings.chartProp.globalvariable && settings.chartProp.globalvariable.length > 0 && !settings.editMode) {
                tr.on("click", function(filedsData) {
                    $(selector + " .selected-item").removeClass("selected-item");
                    $(this).addClass("selected-item");
                });
            }
            var tds = tr.selectAll("nothing").data(function(d) {
                return d;
            }).enter().append("td").style("font-weight", function(d, i) {
                return headers[i].prop.textBold ? "bold" : "normal";
            }).style("font-style", function(d, i) {
                return headers[i].prop.textItalic ? "italic" : "normal";
            }).style("font-size", function(d, i) {
                return headers[i].prop.fontSize;
            }).style("text-align", function(d, i) {
                return headers[i].prop.textAlign;
            }).style("color", function(d, i) {
                return headers[i].prop.color;
            }).style("display", function(d, i) {
                return headers[i].prop.isHidden ? "none" : "auto";
            }).attr("data-value", function(d) {
                return d;
            }).on("click", function(d, i) {
                onTdClick.call(this, d, i, dims, input.nonPivotMatrix);
            });
            tds.each(function(d, i) {
                var isn = isNaN(d);
                if (!isn) d *= +headers[i].prop.numberFactor;
                var r = d;
                if (!isn) {
                    r = d3.format(headers[i].prop.formatString)(d);
                }
                var isHtml = headers[i].prop.isHtml;
                var t = persian(r, showPersian && !isHtml);
                if (isHtml) d3.select(this).html(t); else d3.select(this).text(t);
            });
            var hasResult = false;
            var headersKey = headers.map(function(d) {
                return d.key;
            });
            input.resultRows.sort(function(a, b) {
                var aindex = headersKey.indexOf(a.Name);
                var bindex = headersKey.indexOf(b.Name);
                return aindex < bindex ? -1 : aindex > bindex ? 1 : 0;
            });
            var hiddenResultRows = table.select("tbody").append("tr").selectAll("nothing").data(input.resultRows).enter().append("td").style("font-weight", "bold").style("display", function(d, i) {
                return headers[i].prop.isHidden ? "none" : "auto";
            }).text(function(d, i) {
                if (d.Value == "" || d.Value == null) return "";
                var isn = isNaN(d.Value);
                var r = d.Value;
                var p = getProp(d.Name);
                if (!isn && +d.Type != 3) r = +d.Value * +p.numberFactor;
                if (!isn) {
                    r = d3.format(p.formatString)(r);
                }
                return persian(r, showPersian);
            });
            var sums = d3.select(selector + " .table-body").append("div").attr("class", "table-footer").append("table").attr("class", " ui celled table unstackable small table-chart" + tableStyle + (settings.chartProp.info.condensed ? "table-condensed" : "")).append("thead").append("tr").selectAll("nothing").data(input.resultRows).enter().append("th").style("width", "1px").style("display", function(d, i) {
                return headers[i].prop.isHidden ? "none" : "auto";
            }).style("font-weight", function(d, i) {
                return headers[i].prop.textBold ? "bold" : "normal";
            }).style("font-style", function(d, i) {
                return headers[i].prop.textItalic ? "italic" : "normal";
            }).style("font-size", function(d, i) {
                return headers[i].prop.fontSize;
            }).style("text-align", function(d, i) {
                return headers[i].prop.textAlign;
            }).style("color", function(d, i) {
                return headers[i].prop.color;
            }).text(function(d, i) {
                if (d.Value == "" || d.Value == null) return "";
                hasResult = true;
                var isn = isNaN(d.Value);
                var r = d.Value;
                var p = getProp(d.Name);
                if (!isn && +d.Type != 3) r = +d.Value * +p.numberFactor;
                if (!isn) {
                    r = d3.format(p.formatString)(r);
                }
                return persian(r, showPersian);
            });
            var table2 = d3.select(selector + " .table-body").insert("div", "#tablescroll").attr("class", "header-table").append("table").attr("class", " ui celled table unstackable small table-chart" + tableStyle + (settings.chartProp.info.condensed ? "table-condensed" : ""));
            var thead2 = table2.append("thead").style("background-color", "white").append("tr");
            addHeaders(headers, thead2, table2, {
                sort: function(k, el, tr) {
                    if (isProgress()) return;
                    showProgress(true);
                    if (TableInfo.Order == null) {
                        TableInfo.Order = [ {
                            Index: k,
                            DescType: 1
                        } ];
                    } else {
                        var find = false;
                        for (var i = 0; i < TableInfo.Order.length; i++) {
                            var d = TableInfo.Order[i];
                            if (d.Index == k) {
                                var newEl = {
                                    Index: k,
                                    DescType: d.DescType == 0 ? 1 : d.DescType == 1 ? 2 : 1
                                };
                                var s = TableInfo.Order.splice(i, 1);
                                TableInfo.Order.push(newEl);
                                find = true;
                                break;
                            }
                        }
                        if (!find) {
                            TableInfo.Order.push({
                                Index: k,
                                DescType: 1
                            });
                        }
                    }
                    $.extend(settings.parameters, {
                        TableInfo: TableInfo,
                        notEditMode: !settings.editMode
                    });
                    if (settings.editMode) {
                        $(selector).trigger("tableInfo", [ {
                            TableInfo: TableInfo
                        } ]);
                    }
                    $(selector).charts(chartTypes.TABLE, "refreshWithData", settings, {
                        refreshRelatedDatasources: false
                    });
                },
                filter: function() {
                    var params = getFilterParameter();
                    if (isProgress()) return;
                    showProgress(true);
                    TableInfo.Filter = params.map(function(d, i) {
                        d.value = depersian(d.value, showPersian);
                        if (RegExp(/^[\d,]+$/).test(d.value)) {
                            d.value = d.value.replace(/,/g, "");
                        }
                        return {
                            Index: i,
                            FilterType: d.type,
                            FilterParameter: d.value
                        };
                    });
                    TableInfo.Page = 1;
                    settings.TableInfo = TableInfo;
                    $.extend(settings.parameters, {
                        TableInfo: TableInfo,
                        notEditMode: !settings.editMode
                    });
                    $(selector).charts(chartTypes.TABLE, "refreshWithData", settings, {
                        refreshRelatedDatasources: false
                    });
                },
                filterclear: function(i) {
                    $(selector + " #filterbox-" + i + " input").val("");
                    var params = getFilterParameter();
                    if (isProgress()) return;
                    showProgress(true);
                    TableInfo.Filter = params.map(function(d, i) {
                        return {
                            Index: i,
                            FilterType: d.type,
                            FilterParameter: d.value
                        };
                    });
                    TableInfo.Page = 1;
                    settings.TableInfo = TableInfo;
                    $.extend(settings.parameters, {
                        TableInfo: TableInfo
                    });
                    $(selector).charts(chartTypes.TABLE, "refreshWithData", settings, {
                        refreshRelatedDatasources: false
                    });
                }
            });
            d3.select(thead2[0][0]).selectAll("th").style("width", "1px");
            if (!nonPivotMatrix || nonPivotMatrix.length == 0) {
                table.select("tbody").append("tr").append("td").attr("colspan", headers.length).append("div").style("font-size", "0.8em").append("span").attr("class", "translate").attr("data-trans-key", "داده‌ای برای نمایش وجود ندارد").text("داده‌ای برای نمایش وجود ندارد");
            }
            var f = tr[0];
            f.forEach(function(d, i) {
                getIndicator(d.__data__, headers, d);
            });
            addHeaders(headers, thead, table, {
                sort: function() {},
                filter: function() {},
                filterclear: function() {}
            });
            paging(currentPage);
            $(selector).trigger("heightChange");
            if (settings.chartProp.info.showRowNumber && showHeader) {
                var offset = (input.TableInfo.Page - 1) * input.TableInfo.Limit + 1;
                tr.insert("td", "td").text(function(d, i) {
                    return persian(offset + i, showPersian);
                }).style("text-align", "right");
                d3.select(hiddenResultRows.node().parentNode).insert("td", "td");
                thead2.insert("th", "th").text("ردیف");
                thead.insert("th", "th").text("ردیف");
                d3.select(selector + " .table-body .table-footer tr").insert("th", "th").style("width", "1px");
                sums = d3.selectAll(selector + " .table-body .table-footer tr th");
                hiddenResultRows = d3.select(hiddenResultRows.node().parentNode).selectAll("td");
            }
            postProcess(tr, thead, thead2, sums, hasResult, hiddenResultRows);
            $(selector).trigger("heightChange");
            var filterparameters = $(selector).data("filterbox");
            restoreFilterboxValue(filterparameters);
        }
        function gotoPage(page) {
            if (isProgress()) return;
            showProgress(true);
            TableInfo.Page = page;
            TableInfo.IsPageValid = true;
            $.extend(settings.parameters, {
                TableInfo: TableInfo,
                notEditMode: !settings.editMode
            });
            $(selector).charts(chartTypes.TABLE, "refreshWithData", settings, {
                refreshRelatedDatasources: false
            });
            settings.parameters.TableInfo.IsPageValid = false;
        }
        drawTable(selector, input.nonPivotMatrix, input.TableInfo.Page);
    }
    function onTdClick(d, i, dims, data) {
        var values = [];
        var dim = "";
        var selected = $(this).hasClass("selected-item");
        var trIndex = $(this).parents("tr").index();
        if (typeof settings.chartProp.info.selectable == "undefined") settings.chartProp.info.selectable = "multi";
        if (settings.chartProp.info.selectable == "none") return;
        if (settings.chartProp.info.selectable == "edit") {
            $("body").trigger("open-form", [ input.form, input.formIds[trIndex], selector ]);
            return;
        }
        if (settings.chartProp.info.rowAsKey && settings.chartProp.info.rowKey) {
            i = dims.indexOf(settings.chartProp.info.rowKey);
            if (i == -1) return;
            if (settings.chartProp.info.selectable == "one") $(selector + " .selected-item").removeClass("selected-item");
            if (selected) {
                $(this).parents("tr").find("td").removeClass("selected-item");
            } else {
                $(this).parents("tr").find("td").addClass("selected-item");
            }
        } else {
            if (settings.chartProp.info.selectable == "one") $(selector + " td:nth-child(" + (i + 1) + ").selected-item").removeClass("selected-item");
            if (selected) {
                $(this).removeClass("selected-item");
            } else {
                $(this).addClass("selected-item");
            }
        }
        var idx = i + 1 + (settings.chartProp.info.showRowNumber ? 1 : 0);
        var values = $(selector + " td:nth-child(" + idx + ").selected-item").map(function() {
            return data[trIndex][i];
        }).toArray();
        dim = dims[i];
        values = values.filter(function(item, pos) {
            return values.indexOf(item) == pos;
        });
        if (settings.editMode) return;
        var data = {
            Id: -1,
            Values: values,
            VariableType: 0,
            dimensionName: dim,
            datasourceId: input.DataSourceId,
            chartInPageId: settings.ChartInPageId,
            chartId: input.chartId
        };
        app.moderation.dashboadpage.selectValueOnChart(data, input.RefreshDatasource);
    }
    function hasScrollBar(el) {
        return $(el).get(0).scrollHeight > $(el).height();
    }
    function postProcess(tr, thead, thead2, sums, hasResult, hiddenResultRows) {
        var tt = tr[0][0];
        var maxWidth = 0;
        var fullWidth = $(selector).parents(".ui.card").width();
        $(tt).find("td").each(function(i, d) {
            var ds = sums[0][i];
            var ths = d3.select(thead2[0][0]).selectAll("th");
            var th = ths[0][i];
            var ths1 = d3.select(thead[0][0]).selectAll("th");
            var th1 = ths1[0][i];
            var width = $(d).outerWidth();
            var innerWidth = $(d).width();
            var padt = $(d).css("padding-top");
            var padl = $(d).css("padding-left");
            var padr = $(d).css("padding-right");
            var padb = $(d).css("padding-bottom");
            var setParams = function(el) {
                el.css("width", width + "px");
                el.css("max-width", width + "px");
                el.css("min-width", width + "px");
                el.css("padding-top", padt);
                el.css("padding-left", padl);
                el.css("padding-right", padr);
                el.css("padding-bottom", padb);
            };
            setParams($(ds));
            setParams($(tr[0][0]).map(function(j, dd) {
                return $(dd).find("td")[i];
            }));
            setParams($(th));
        });
        thead.remove();
        if (!hasResult) $(selector + " .table-footer").remove();
        hiddenResultRows.remove();
        var w = $(tt).outerWidth();
        $(selector + " table").css("width", w + "px");
        $(selector + " table").css("max-width", w + "px");
        function getScrollbarWidth() {
            var outer = document.createElement("div");
            outer.style.visibility = "hidden";
            outer.style.width = "100px";
            outer.style.msOverflowStyle = "scrollbar";
            document.body.appendChild(outer);
            var widthNoScroll = outer.offsetWidth;
            outer.style.overflow = "scroll";
            var inner = document.createElement("div");
            inner.style.width = "100%";
            outer.appendChild(inner);
            var widthWithScroll = inner.offsetWidth;
            outer.parentNode.removeChild(outer);
            return widthNoScroll - widthWithScroll;
        }
        if (hasScrollBar($(selector + " #tablescroll"))) {
            var scw = 0;
            scw = getScrollbarWidth();
            var expanded = scw + $(selector + " .header-table table th:last-child").outerWidth();
            $(selector + " .header-table table th:last-child").css({
                "min-width": expanded + "px",
                "max-width": expanded + "px",
                width: expanded + "px"
            });
            expanded = scw + $(selector + " .table-footer table th:last-child").outerWidth();
            $(selector + " .table-footer table th:last-child").css({
                "min-width": expanded + "px",
                "max-width": expanded + "px",
                width: expanded + "px"
            });
        }
        var offset = $(selector + " #tablescroll").scrollLeft();
        function trans3d() {
            $(selector + " .header-table").css("-ms-transform", "translate3d(" + (-offset + $(selector + " #tablescroll").scrollLeft()) + "px,0px,0px)");
            $(selector + " .table-footer").css("-ms-transform", "translate3d(" + (-offset + $(selector + " #tablescroll").scrollLeft()) + "px,0px,0px)");
            $(selector + " .header-table").css("-webkit-transform", "translate3d(" + (offset - $(selector + " #tablescroll").scrollLeft()) + "px,0px,0px)");
            $(selector + " .table-footer").css("-webkit-transform", "translate3d(" + (offset - $(selector + " #tablescroll").scrollLeft()) + "px,0px,0px)");
            $(selector + " .header-table").css("-moz-transform", "translate3d(" + -$(selector + " #tablescroll").scrollLeft() + "px,0px,0px)");
            $(selector + " .table-footer").css("-moz-transform", "translate3d(" + -$(selector + " #tablescroll").scrollLeft() + "px,0px,0px)");
        }
        $(selector + " #tablescroll").on("scroll", trans3d);
        trans3d();
        if (app.dashboardLayoutVersion == 2 && !settings.editMode) {
            var hScroll = $(selector + " .table-body").get(0).scrollWidth > $(selector + " .table-body").innerWidth() ? 15 : 0;
            hScroll = 0;
            var pagingDiv = 0;
            try {
                pagingDiv = $(selector + " .pagination").height() + +$(selector + " .pagination").css("margin-top").replace("px", "");
            } catch (e) {}
        }
    }
    function checkRow(ifObj, fields, headers) {
        var Index = headers.indexOf(ifObj.firstField);
        var firstVal = fields[Index];
        var secVal = ifObj.secondFieldIsText ? ifObj.secondFieldInput : fields[headers.indexOf(ifObj.secondFieldSelect)];
        firstVal = depersian(firstVal);
        secVal = depersian(secVal);
        if (!isNaN(secVal)) secVal = +secVal;
        if (!isNaN(firstVal)) firstVal = +firstVal;
        switch (+ifObj.operand) {
          case 1:
            return firstVal == secVal;

          case 2:
            return firstVal != secVal;

          case 3:
            return firstVal > secVal;

          case 4:
            return firstVal >= secVal;

          case 5:
            return firstVal < secVal;

          case 6:
            return firstVal <= secVal;

          case 7:
            return firstVal.indexOf(secVal) > -1;

          case 8:
            return firstVal.indexOf(secVal) <= -1;

          default:        }
    }
    function getIndicator(fields, headers, tr) {
        return;
        var result = [];
        var hKeys = headers.map(function(d) {
            return d.key;
        });
        if (settings.chartProp.indicator) settings.chartProp.indicator.forEach(function(ind) {
            var isTrue = true;
            $.each(ind.ifRow, function(i, d) {
                if (!checkRow(d, fields, hKeys)) {
                    isTrue = false;
                    return false;
                }
            });
            if (isTrue) {
                var tds = $(tr).find("td");
                $.each(ind.thenRow, function(i, thenObj) {
                    var firstFieldIndex = hKeys.indexOf(thenObj.firstField);
                    var td = $(tds[firstFieldIndex]);
                    switch (+thenObj.operand) {
                      case 1:
                        td.css("color", thenObj.secondFieldColor);
                        break;

                      case 2:
                        td.append(' <span class="' + thenObj.secondFieldIcon + '"> </span> ');
                        break;

                      case 3:
                        td.css("background-color", thenObj.secondFieldBackColor);
                        break;

                      case 4:
                        var v = +thenObj.secondFieldStyle;
                        if (v == 1) {
                            td.css("font-weight", "normal");
                            td.css("font-style", "normal");
                        }
                        if (v == 2 || v == 4) td.css("font-weight", "bold");
                        if (v == 3 || v == 4) td.css("font-style", "italic");
                        if (v == 5) td.css("text-decoration", "underline");
                        break;

                      case 5:
                        td.text(thenObj.secondFieldReplace);
                        break;
                    }
                });
            }
        });
    }
    function sorting(k, el, tr) {
        var obj = $(el);
        isDesc = false;
        if (TableInfo && TableInfo.Order) {
            for (var i = 0; i < TableInfo.Order.length; i++) {
                var d = TableInfo.Order[i];
                if (d.Index == k) {
                    isDesc = d.DescType == 2;
                    break;
                }
            }
        }
        tr.sort(function(a, b) {
            if (typeof a.label != "undefined") {
                a = [ a.label ].concat(a.series);
                b = [ b.label ].concat(b.series);
            }
            if (typeof isDesc != "undefined" && isDesc) {
                return /^[0-9.]+$/.test(a[k]) ? d3.descending(+a[k], +b[k]) : d3.descending(a[k], b[k]);
            } else {
                return /^[0-9.]+$/.test(a[k]) ? d3.ascending(+a[k], +b[k]) : d3.ascending(a[k], b[k]);
            }
        });
    }
    function addHeaders(headers, thead, table, calbacks) {
        if (!showHeader) return;
        var ths = thead.selectAll("nothing").data(headers).enter().append("th").html(function(d, i) {
            var filter = "";
            filter = '<div class="ui  dropdown " id="filterbox-' + i + '"><i class="table-filter-icon filter icon"></i><div class="menu"><div class="ui left icon input mini"><i class="search icon"></i><input type="text" name="search" placeholder="جستجو"></div><div class="item"></div>';
            var dx = '<div class="dropdown inline grid-filter" id="filterbox-' + i + '">                                      <span class="dropdown-toggle glyphicon glyphicon-filter" href="#" data-toggle="dropdown"></span>                                       <div class="dropdown-menu dropdown-menu-right" style="padding: 15px;z-index:1000">                                                                                           <div style="text-align: right;">                                                                                                             <div class="form-group">                                                                                                                     <select class="form-control">                                                                                                                <option value="1">شامل</option>                                                                                                         <option value="6">شامل نباشد</option>                                                                                                         <option value="2">دقیقا برابر با</option>                                                                                             <option value="3">بزرگ‌تر از</option>                                                                                                    <option value="4">کوچکتر از</option>                                                                                                    <option value="5">بین اعداد</option>                                                                                                </select>                                                                                                                                <input style="margin-top: 10px" class="form-control " value="">                                                                      </div>                                                                                                                                   <div class="btn-group btn-group-justified">                                                                                                  <a style="padding-right: 0; padding-left: 0;" class="btn btn-primary">فیلتر</a>                                                         <a style="padding-right: 0; padding-left: 0;" class="btn btn-default">پاک کردن</a>                                                  </div>                                                                                                                               </div>                                                                                                                               </div>                                                                                                                               </div>';
            return '<div class="inline header-text pointer" style="white-space:initial;">' + persian(d.prop.name || d.value, showPersian).replace(/^\[measure\]/, "") + "</div>" + filter;
        }).attr("class", "pointer hover-show-glyph").style("white-space", "nowrap").style("text-align", function(d, i) {
            return d.prop.textAlign;
        }).style("display", function(d, i) {
            return d.prop.isHidden ? "none" : "auto";
        });
        var sw = 0;
        ths[0].forEach(function(dd, idx) {
            sw += +$(dd).width();
            if (sw < 130 || idx == 0) {
                var el = $(dd).find(".dropdown-menu-right");
                el.removeClass("dropdown-menu-right");
                el.addClass("dropdown-menu-left");
            }
        });
        table.selectAll("thead th").each(function(d, i) {
            d3.select(this).select(".header-text").on("click", function() {
                calbacks.sort(i, this, tr);
                if (settings.editMode && selector) {
                    $(selector).trigger("legendClick", [ d.label, i, d ]);
                }
            });
        });
        table.selectAll("thead th").each(function(d, i) {
            $(this).find("input").keyup(function(e) {
                if (e.keyCode == 13) {
                    calbacks.filter();
                }
            });
        });
        table.selectAll("thead th").each(function(d, i) {
            $(this).find(".btn-default").on("click", function() {
                calbacks.filterclear(i);
            });
        });
        table.selectAll("thead th").each(function(d, i) {
            $(this).find(".dropdown").on("shown.bs.dropdown", function() {
                $(this).find("input").focus();
            });
        });
        for (var i = 0; i < headers.length; i++) {
            d3.select(selector + " #filterbox-" + i + " select").on("click", function(d) {
                d3.event.stopPropagation();
            });
            d3.select(selector + " #filterbox-" + i + " input").on("click", function(d) {
                d3.event.stopPropagation();
            });
            $(selector + " #filterbox-" + i + " input").mousedown(function(e) {
                if (e.which == 3) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                }
            });
            $(selector + " #filterbox-" + i).on("keypress", function(e) {
                if (e.keyCode === 13) {
                    e.preventDefault();
                    $(this).find(".btn-primary").click();
                }
            });
        }
        if (!settings.editMode) {
            $(selector).find(".ui.dropdown").lazyDropdown();
        }
    }
    function getPropOfIndexFromKeyValueLabel(i) {
        if (i >= headers.length) i = headers.length - 1;
        return headers[i].prop;
    }
    function getProp(d) {
        var def = {
            numberFactor: "1",
            textAlign: "right",
            formatString: ",.2f",
            fontSize: "1em",
            textItalic: false,
            textBold: false,
            color: "#000000",
            rowResult: "0",
            isHidden: false
        };
        try {
            return settings.chartProp.series[d] || settings.chartProp.series["default"] || def;
        } catch (e) {
            return def;
        }
    }
    function getFilterParameter() {
        var parameters = [];
        var headers = $(selector + " table thead th input");
        for (var i = 0; i < headers.length; i++) {
            value = $(selector + " #filterbox-" + i + " input").val();
            type = $(selector + " #filterbox-" + i + " select").val() || 1;
            if (type == null) {
                return;
            }
            if (typeof value != "undefined" && value != null && value != "") {
                $(selector + " #filterbox-" + i + " .glyphicon-filter").addClass("show");
                d3.select(selector + " #filterbox-" + i + " select").on("click", function(d) {
                    d3.event.stopPropagation();
                });
                d3.select(selector + " #filterbox-" + i + " input").on("click", function(d) {
                    d3.event.stopPropagation();
                });
                $(selector + " #filterbox-" + i + " input").mousedown(function(e) {
                    if (e.which == 3) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                    }
                });
            }
            parameters.push({
                value: value,
                type: type
            });
        }
        $(selector).data("filterbox", parameters);
        return parameters;
    }
    function filterTable() {
        var parameters = getFilterParameter();
        if (typeof tr != "undefined") {
            tr.style("display", function(a) {
                if (typeof a.label != "undefined") {
                    a = [ a.label ].concat(a.series);
                }
                var r = filter(a, parameters);
                return r ? null : "none";
            });
        }
        if (settings.editMode) {
            $(selector).trigger("tableInfo", [ {
                TableInfo: TableInfo
            } ]);
        }
    }
    function restoreFilterboxValue(filterparameters, dontFilter) {
        if (typeof filterparameters != "undefined") {
            var needfilter = false;
            for (var i = 0; i < filterparameters.length; i++) {
                if (typeof filterparameters[i].value != "undefined" && filterparameters[i].value != "") needfilter = true;
                $(selector + " #filterbox-" + i + " input").val(filterparameters[i].value);
                if (!_.isEmpty(filterparameters[i].value)) {
                    $(selector + " #filterbox-" + i + " .table-filter-icon").addClass("fill");
                }
                $(selector + " #filterbox-" + i + " select").val(filterparameters[i].type);
            }
            if (needfilter && !dontFilter) {
                filterTable();
            }
        }
    }
    if (input.TableInfo && input.TableInfo.Filter) {
        var filterparameters = input.TableInfo.Filter.map(function(d) {
            return {
                value: d.FilterParameter,
                type: d.FilterType
            };
        });
        restoreFilterboxValue(filterparameters);
    }
    var filterparameters = $(selector).data("filterbox");
    restoreFilterboxValue(filterparameters);
    function filter(tableValue, parameters) {
        var finalBool = true;
        for (var i = 0; i < parameters.length; i++) {
            parameter = parameters[i].value;
            parameter = depersian(parameter);
            parameter = RegExp(/^[\d,\s]+$/).test(parameter) ? +parameter.replace(/,/g, "") : parameter;
            type = parameters[i].type;
            if (typeof parameter == "undefined" || parameter == "") continue;
            switch (+type) {
              case 1:
                var dd = tableValue[i];
                finalBool = finalBool && tableValue[i].indexOf(parameter) != -1;
                break;

              case 6:
                var dd = tableValue[i];
                finalBool = finalBool && tableValue[i].indexOf(parameter) == -1;
                break;

              case 2:
                finalBool = finalBool && (parseFloat(tableValue[i]) || 0) == parameter;
                break;

              case 3:
                finalBool = finalBool && (parseFloat(tableValue[i]) || 0) > parameter;
                break;

              case 4:
                finalBool = finalBool && (parseFloat(tableValue[i]) || 0) < parameter;
                break;

              case 5:
                var params = parameter.split(",");
                if (params != "undefined") finalBool = finalBool && (parseFloat(tableValue[i]) || 0) > params[0] && (parseFloat(tableValue[i]) || 0) < params[1];
                break;

              default:            }
        }
        return finalBool;
    }
};

(function(name, definition) {
    if (typeof module != "undefined") module.exports = definition(); else if (typeof define == "function" && typeof define.amd == "object") define(definition); else this[name] = definition();
})("Clusterize", function() {
    "use strict";
    var ie = function() {
        for (var v = 3, el = document.createElement("b"), all = el.all || []; el.innerHTML = "<!--[if gt IE " + ++v + "]><i><![endif]-->", 
        all[0]; ) {}
        return v > 4 ? v : document.documentMode;
    }(), is_mac = navigator.platform.toLowerCase().indexOf("mac") + 1;
    var Clusterize = function(data) {
        if (!(this instanceof Clusterize)) return new Clusterize(data);
        var self = this;
        var defaults = {
            rows_in_block: 50,
            blocks_in_cluster: 4,
            tag: null,
            show_no_data_row: true,
            no_data_class: "clusterize-no-data",
            no_data_text: "No data",
            keep_parity: true,
            callbacks: {}
        };
        self.options = {};
        var options = [ "rows_in_block", "blocks_in_cluster", "show_no_data_row", "no_data_class", "no_data_text", "keep_parity", "tag", "callbacks" ];
        for (var i = 0, option; option = options[i]; i++) {
            self.options[option] = typeof data[option] != "undefined" && data[option] != null ? data[option] : defaults[option];
        }
        var elems = [ "scroll", "content" ];
        for (var i = 0, elem; elem = elems[i]; i++) {
            self[elem + "_elem"] = data[elem + "Id"] ? document.getElementById(data[elem + "Id"]) : data[elem + "Elem"];
            if (!self[elem + "_elem"]) throw new Error("Error! Could not find " + elem + " element");
        }
        if (!self.content_elem.hasAttribute("tabindex")) self.content_elem.setAttribute("tabindex", 0);
        var rows = isArray(data.rows) ? data.rows : self.fetchMarkup(), cache = {}, scroll_top = self.scroll_elem.scrollTop;
        self.insertToDOM(rows, cache);
        self.scroll_elem.scrollTop = scroll_top;
        var last_cluster = false, scroll_debounce = 0, pointer_events_set = false, scrollEv = function() {
            if (is_mac) {
                if (!pointer_events_set) self.content_elem.style.pointerEvents = "none";
                pointer_events_set = true;
                clearTimeout(scroll_debounce);
                scroll_debounce = setTimeout(function() {
                    self.content_elem.style.pointerEvents = "auto";
                    pointer_events_set = false;
                }, 50);
            }
            if (last_cluster != (last_cluster = self.getClusterNum())) {
                self.insertToDOM(rows, cache);
            }
            if (self.options.callbacks.scrollingProgress) self.options.callbacks.scrollingProgress(self.getScrollProgress());
        }, resize_debounce = 0, resizeEv = function() {
            clearTimeout(resize_debounce);
            resize_debounce = setTimeout(self.refresh, 100);
        };
        on("scroll", self.scroll_elem, scrollEv);
        on("resize", window, resizeEv);
        self.destroy = function(clean) {
            off("scroll", self.scroll_elem, scrollEv);
            off("resize", window, resizeEv);
            self.html((clean ? self.generateEmptyRow() : rows).join(""));
        };
        self.refresh = function(force) {
            if (self.getRowsHeight(rows) || force) self.update(rows);
        };
        self.update = function(new_rows) {
            rows = isArray(new_rows) ? new_rows : [];
            var scroll_top = self.scroll_elem.scrollTop;
            if (rows.length * self.options.item_height < scroll_top) {
                self.scroll_elem.scrollTop = 0;
                last_cluster = 0;
            }
            self.insertToDOM(rows, cache);
            self.scroll_elem.scrollTop = scroll_top;
        };
        self.clear = function() {
            self.update([]);
        };
        self.getRowsAmount = function() {
            return rows.length;
        };
        self.getScrollProgress = function() {
            return this.options.scroll_top / (rows.length * this.options.item_height) * 100 || 0;
        };
        var add = function(where, _new_rows) {
            var new_rows = isArray(_new_rows) ? _new_rows : [];
            if (!new_rows.length) return;
            rows = where == "append" ? rows.concat(new_rows) : new_rows.concat(rows);
            self.insertToDOM(rows, cache);
        };
        self.append = function(rows) {
            add("append", rows);
        };
        self.prepend = function(rows) {
            add("prepend", rows);
        };
    };
    Clusterize.prototype = {
        constructor: Clusterize,
        fetchMarkup: function() {
            var rows = [], rows_nodes = this.getChildNodes(this.content_elem);
            while (rows_nodes.length) {
                rows.push(rows_nodes.shift().outerHTML);
            }
            return rows;
        },
        exploreEnvironment: function(rows, cache) {
            var opts = this.options;
            opts.content_tag = this.content_elem.tagName.toLowerCase();
            if (!rows.length) return;
            if (ie && ie <= 9 && !opts.tag) opts.tag = rows[0].match(/<([^>\s\/]*)/)[1].toLowerCase();
            if (this.content_elem.children.length <= 1) cache.data = this.html(rows[0] + rows[0] + rows[0]);
            if (!opts.tag) opts.tag = this.content_elem.children[0].tagName.toLowerCase();
            this.getRowsHeight(rows);
        },
        getRowsHeight: function(rows) {
            var opts = this.options, prev_item_height = opts.item_height;
            opts.cluster_height = 0;
            if (!rows.length) return;
            var nodes = this.content_elem.children;
            if (!nodes.length) return;
            var node = nodes[Math.floor(nodes.length / 2)];
            opts.item_height = node.offsetHeight;
            if (opts.tag == "tr" && getStyle("borderCollapse", this.content_elem) != "collapse") opts.item_height += parseInt(getStyle("borderSpacing", this.content_elem), 10) || 0;
            if (opts.tag != "tr") {
                var marginTop = parseInt(getStyle("marginTop", node), 10) || 0;
                var marginBottom = parseInt(getStyle("marginBottom", node), 10) || 0;
                opts.item_height += Math.max(marginTop, marginBottom);
            }
            opts.block_height = opts.item_height * opts.rows_in_block;
            opts.rows_in_cluster = opts.blocks_in_cluster * opts.rows_in_block;
            opts.cluster_height = opts.blocks_in_cluster * opts.block_height;
            return prev_item_height != opts.item_height;
        },
        getClusterNum: function() {
            this.options.scroll_top = this.scroll_elem.scrollTop;
            return Math.floor(this.options.scroll_top / (this.options.cluster_height - this.options.block_height)) || 0;
        },
        generateEmptyRow: function() {
            var opts = this.options;
            if (!opts.tag || !opts.show_no_data_row) return [];
            var empty_row = document.createElement(opts.tag), no_data_content = document.createTextNode(opts.no_data_text), td;
            empty_row.className = opts.no_data_class;
            if (opts.tag == "tr") {
                td = document.createElement("td");
                td.colSpan = 100;
                td.appendChild(no_data_content);
            }
            empty_row.appendChild(td || no_data_content);
            return [ empty_row.outerHTML ];
        },
        generate: function(rows, cluster_num) {
            var opts = this.options, rows_len = rows.length;
            if (rows_len < opts.rows_in_block) {
                return {
                    top_offset: 0,
                    bottom_offset: 0,
                    rows_above: 0,
                    rows: rows_len ? rows : this.generateEmptyRow()
                };
            }
            var items_start = Math.max((opts.rows_in_cluster - opts.rows_in_block) * cluster_num, 0), items_end = items_start + opts.rows_in_cluster, top_offset = Math.max(items_start * opts.item_height, 0), bottom_offset = Math.max((rows_len - items_end) * opts.item_height, 0), this_cluster_rows = [], rows_above = items_start;
            if (top_offset < 1) {
                rows_above++;
            }
            for (var i = items_start; i < items_end; i++) {
                rows[i] && this_cluster_rows.push(rows[i]);
            }
            return {
                top_offset: top_offset,
                bottom_offset: bottom_offset,
                rows_above: rows_above,
                rows: this_cluster_rows
            };
        },
        renderExtraTag: function(class_name, height) {
            var tag = document.createElement(this.options.tag), clusterize_prefix = "clusterize-";
            tag.className = [ clusterize_prefix + "extra-row", clusterize_prefix + class_name ].join(" ");
            height && (tag.style.height = height + "px");
            return tag.outerHTML;
        },
        insertToDOM: function(rows, cache) {
            if (!this.options.cluster_height) {
                this.exploreEnvironment(rows, cache);
            }
            var data = this.generate(rows, this.getClusterNum()), this_cluster_rows = data.rows.join(""), this_cluster_content_changed = this.checkChanges("data", this_cluster_rows, cache), top_offset_changed = this.checkChanges("top", data.top_offset, cache), only_bottom_offset_changed = this.checkChanges("bottom", data.bottom_offset, cache), callbacks = this.options.callbacks, layout = [];
            if (this_cluster_content_changed || top_offset_changed) {
                if (data.top_offset) {
                    this.options.keep_parity && layout.push(this.renderExtraTag("keep-parity"));
                    layout.push(this.renderExtraTag("top-space", data.top_offset));
                }
                layout.push(this_cluster_rows);
                data.bottom_offset && layout.push(this.renderExtraTag("bottom-space", data.bottom_offset));
                callbacks.clusterWillChange && callbacks.clusterWillChange();
                this.html(layout.join(""));
                this.options.content_tag == "ol" && this.content_elem.setAttribute("start", data.rows_above);
                this.content_elem.style["counter-increment"] = "clusterize-counter " + (data.rows_above - 1);
                callbacks.clusterChanged && callbacks.clusterChanged();
            } else if (only_bottom_offset_changed) {
                this.content_elem.lastChild.style.height = data.bottom_offset + "px";
            }
        },
        html: function(data) {
            var content_elem = this.content_elem;
            if (ie && ie <= 9 && this.options.tag == "tr") {
                var div = document.createElement("div"), last;
                div.innerHTML = "<table><tbody>" + data + "</tbody></table>";
                while (last = content_elem.lastChild) {
                    content_elem.removeChild(last);
                }
                var rows_nodes = this.getChildNodes(div.firstChild.firstChild);
                while (rows_nodes.length) {
                    content_elem.appendChild(rows_nodes.shift());
                }
            } else {
                content_elem.innerHTML = data;
            }
        },
        getChildNodes: function(tag) {
            var child_nodes = tag.children, nodes = [];
            for (var i = 0, ii = child_nodes.length; i < ii; i++) {
                nodes.push(child_nodes[i]);
            }
            return nodes;
        },
        checkChanges: function(type, value, cache) {
            var changed = value != cache[type];
            cache[type] = value;
            return changed;
        }
    };
    function on(evt, element, fnc) {
        return element.addEventListener ? element.addEventListener(evt, fnc, false) : element.attachEvent("on" + evt, fnc);
    }
    function off(evt, element, fnc) {
        return element.removeEventListener ? element.removeEventListener(evt, fnc, false) : element.detachEvent("on" + evt, fnc);
    }
    function isArray(arr) {
        return Object.prototype.toString.call(arr) === "[object Array]";
    }
    function getStyle(prop, elem) {
        return window.getComputedStyle ? window.getComputedStyle(elem)[prop] : elem.currentStyle[prop];
    }
    return Clusterize;
});

!function() {
    "use strict";
    function t(o) {
        if (!o) throw new Error("No options passed to Waypoint constructor");
        if (!o.element) throw new Error("No element option passed to Waypoint constructor");
        if (!o.handler) throw new Error("No handler option passed to Waypoint constructor");
        this.key = "waypoint-" + e, this.options = t.Adapter.extend({}, t.defaults, o), 
        this.element = this.options.element, this.adapter = new t.Adapter(this.element), 
        this.callback = o.handler, this.axis = this.options.horizontal ? "horizontal" : "vertical", 
        this.enabled = this.options.enabled, this.triggerPoint = null, this.group = t.Group.findOrCreate({
            name: this.options.group,
            axis: this.axis
        }), this.context = t.Context.findOrCreateByElement(this.options.context), t.offsetAliases[this.options.offset] && (this.options.offset = t.offsetAliases[this.options.offset]), 
        this.group.add(this), this.context.add(this), i[this.key] = this, e += 1;
    }
    var e = 0, i = {};
    t.prototype.queueTrigger = function(t) {
        this.group.queueTrigger(this, t);
    }, t.prototype.trigger = function(t) {
        this.enabled && this.callback && this.callback.apply(this, t);
    }, t.prototype.destroy = function() {
        this.context.remove(this), this.group.remove(this), delete i[this.key];
    }, t.prototype.disable = function() {
        return this.enabled = !1, this;
    }, t.prototype.enable = function() {
        return this.context.refresh(), this.enabled = !0, this;
    }, t.prototype.next = function() {
        return this.group.next(this);
    }, t.prototype.previous = function() {
        return this.group.previous(this);
    }, t.invokeAll = function(t) {
        var e = [];
        for (var o in i) e.push(i[o]);
        for (var n = 0, r = e.length; r > n; n++) e[n][t]();
    }, t.destroyAll = function() {
        t.invokeAll("destroy");
    }, t.disableAll = function() {
        t.invokeAll("disable");
    }, t.enableAll = function() {
        t.Context.refreshAll();
        for (var e in i) i[e].enabled = !0;
        return this;
    }, t.refreshAll = function() {
        t.Context.refreshAll();
    }, t.viewportHeight = function() {
        return window.innerHeight || document.documentElement.clientHeight;
    }, t.viewportWidth = function() {
        return document.documentElement.clientWidth;
    }, t.adapters = [], t.defaults = {
        context: window,
        continuous: !0,
        enabled: !0,
        group: "default",
        horizontal: !1,
        offset: 0
    }, t.offsetAliases = {
        "bottom-in-view": function() {
            return this.context.innerHeight() - this.adapter.outerHeight();
        },
        "right-in-view": function() {
            return this.context.innerWidth() - this.adapter.outerWidth();
        }
    }, window.Waypoint = t;
}(), function() {
    "use strict";
    function t(t) {
        window.setTimeout(t, 1e3 / 60);
    }
    function e(t) {
        this.element = t, this.Adapter = n.Adapter, this.adapter = new this.Adapter(t), 
        this.key = "waypoint-context-" + i, this.didScroll = !1, this.didResize = !1, this.oldScroll = {
            x: this.adapter.scrollLeft(),
            y: this.adapter.scrollTop()
        }, this.waypoints = {
            vertical: {},
            horizontal: {}
        }, t.waypointContextKey = this.key, o[t.waypointContextKey] = this, i += 1, n.windowContext || (n.windowContext = !0, 
        n.windowContext = new e(window)), this.createThrottledScrollHandler(), this.createThrottledResizeHandler();
    }
    var i = 0, o = {}, n = window.Waypoint, r = window.onload;
    e.prototype.add = function(t) {
        var e = t.options.horizontal ? "horizontal" : "vertical";
        this.waypoints[e][t.key] = t, this.refresh();
    }, e.prototype.checkEmpty = function() {
        var t = this.Adapter.isEmptyObject(this.waypoints.horizontal), e = this.Adapter.isEmptyObject(this.waypoints.vertical), i = this.element == this.element.window;
        t && e && !i && (this.adapter.off(".waypoints"), delete o[this.key]);
    }, e.prototype.createThrottledResizeHandler = function() {
        function t() {
            e.handleResize(), e.didResize = !1;
        }
        var e = this;
        this.adapter.on("resize.waypoints", function() {
            e.didResize || (e.didResize = !0, n.requestAnimationFrame(t));
        });
    }, e.prototype.createThrottledScrollHandler = function() {
        function t() {
            e.handleScroll(), e.didScroll = !1;
        }
        var e = this;
        this.adapter.on("scroll.waypoints", function() {
            (!e.didScroll || n.isTouch) && (e.didScroll = !0, n.requestAnimationFrame(t));
        });
    }, e.prototype.handleResize = function() {
        n.Context.refreshAll();
    }, e.prototype.handleScroll = function() {
        var t = {}, e = {
            horizontal: {
                newScroll: this.adapter.scrollLeft(),
                oldScroll: this.oldScroll.x,
                forward: "right",
                backward: "left"
            },
            vertical: {
                newScroll: this.adapter.scrollTop(),
                oldScroll: this.oldScroll.y,
                forward: "down",
                backward: "up"
            }
        };
        for (var i in e) {
            var o = e[i], n = o.newScroll > o.oldScroll, r = n ? o.forward : o.backward;
            for (var s in this.waypoints[i]) {
                var a = this.waypoints[i][s];
                if (null !== a.triggerPoint) {
                    var l = o.oldScroll < a.triggerPoint, h = o.newScroll >= a.triggerPoint, p = l && h, u = !l && !h;
                    (p || u) && (a.queueTrigger(r), t[a.group.id] = a.group);
                }
            }
        }
        for (var c in t) t[c].flushTriggers();
        this.oldScroll = {
            x: e.horizontal.newScroll,
            y: e.vertical.newScroll
        };
    }, e.prototype.innerHeight = function() {
        return this.element == this.element.window ? n.viewportHeight() : this.adapter.innerHeight();
    }, e.prototype.remove = function(t) {
        delete this.waypoints[t.axis][t.key], this.checkEmpty();
    }, e.prototype.innerWidth = function() {
        return this.element == this.element.window ? n.viewportWidth() : this.adapter.innerWidth();
    }, e.prototype.destroy = function() {
        var t = [];
        for (var e in this.waypoints) for (var i in this.waypoints[e]) t.push(this.waypoints[e][i]);
        for (var o = 0, n = t.length; n > o; o++) t[o].destroy();
    }, e.prototype.refresh = function() {
        var t, e = this.element == this.element.window, i = e ? void 0 : this.adapter.offset(), o = {};
        this.handleScroll(), t = {
            horizontal: {
                contextOffset: e ? 0 : i.left,
                contextScroll: e ? 0 : this.oldScroll.x,
                contextDimension: this.innerWidth(),
                oldScroll: this.oldScroll.x,
                forward: "right",
                backward: "left",
                offsetProp: "left"
            },
            vertical: {
                contextOffset: e ? 0 : i.top,
                contextScroll: e ? 0 : this.oldScroll.y,
                contextDimension: this.innerHeight(),
                oldScroll: this.oldScroll.y,
                forward: "down",
                backward: "up",
                offsetProp: "top"
            }
        };
        for (var r in t) {
            var s = t[r];
            for (var a in this.waypoints[r]) {
                var l, h, p, u, c, d = this.waypoints[r][a], f = d.options.offset, w = d.triggerPoint, y = 0, g = null == w;
                d.element !== d.element.window && (y = d.adapter.offset()[s.offsetProp]), "function" == typeof f ? f = f.apply(d) : "string" == typeof f && (f = parseFloat(f), 
                d.options.offset.indexOf("%") > -1 && (f = Math.ceil(s.contextDimension * f / 100))), 
                l = s.contextScroll - s.contextOffset, d.triggerPoint = Math.floor(y + l - f), h = w < s.oldScroll, 
                p = d.triggerPoint >= s.oldScroll, u = h && p, c = !h && !p, !g && u ? (d.queueTrigger(s.backward), 
                o[d.group.id] = d.group) : !g && c ? (d.queueTrigger(s.forward), o[d.group.id] = d.group) : g && s.oldScroll >= d.triggerPoint && (d.queueTrigger(s.forward), 
                o[d.group.id] = d.group);
            }
        }
        return n.requestAnimationFrame(function() {
            for (var t in o) o[t].flushTriggers();
        }), this;
    }, e.findOrCreateByElement = function(t) {
        return e.findByElement(t) || new e(t);
    }, e.refreshAll = function() {
        for (var t in o) o[t].refresh();
    }, e.findByElement = function(t) {
        return o[t.waypointContextKey];
    }, window.onload = function() {
        r && r(), e.refreshAll();
    }, n.requestAnimationFrame = function(e) {
        var i = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || t;
        i.call(window, e);
    }, n.Context = e;
}(), function() {
    "use strict";
    function t(t, e) {
        return t.triggerPoint - e.triggerPoint;
    }
    function e(t, e) {
        return e.triggerPoint - t.triggerPoint;
    }
    function i(t) {
        this.name = t.name, this.axis = t.axis, this.id = this.name + "-" + this.axis, this.waypoints = [], 
        this.clearTriggerQueues(), o[this.axis][this.name] = this;
    }
    var o = {
        vertical: {},
        horizontal: {}
    }, n = window.Waypoint;
    i.prototype.add = function(t) {
        this.waypoints.push(t);
    }, i.prototype.clearTriggerQueues = function() {
        this.triggerQueues = {
            up: [],
            down: [],
            left: [],
            right: []
        };
    }, i.prototype.flushTriggers = function() {
        for (var i in this.triggerQueues) {
            var o = this.triggerQueues[i], n = "up" === i || "left" === i;
            o.sort(n ? e : t);
            for (var r = 0, s = o.length; s > r; r += 1) {
                var a = o[r];
                (a.options.continuous || r === o.length - 1) && a.trigger([ i ]);
            }
        }
        this.clearTriggerQueues();
    }, i.prototype.next = function(e) {
        this.waypoints.sort(t);
        var i = n.Adapter.inArray(e, this.waypoints), o = i === this.waypoints.length - 1;
        return o ? null : this.waypoints[i + 1];
    }, i.prototype.previous = function(e) {
        this.waypoints.sort(t);
        var i = n.Adapter.inArray(e, this.waypoints);
        return i ? this.waypoints[i - 1] : null;
    }, i.prototype.queueTrigger = function(t, e) {
        this.triggerQueues[e].push(t);
    }, i.prototype.remove = function(t) {
        var e = n.Adapter.inArray(t, this.waypoints);
        e > -1 && this.waypoints.splice(e, 1);
    }, i.prototype.first = function() {
        return this.waypoints[0];
    }, i.prototype.last = function() {
        return this.waypoints[this.waypoints.length - 1];
    }, i.findOrCreate = function(t) {
        return o[t.axis][t.name] || new i(t);
    }, n.Group = i;
}(), function() {
    "use strict";
    function t(t) {
        this.$element = e(t);
    }
    var e = window.jQuery, i = window.Waypoint;
    e.each([ "innerHeight", "innerWidth", "off", "offset", "on", "outerHeight", "outerWidth", "scrollLeft", "scrollTop" ], function(e, i) {
        t.prototype[i] = function() {
            var t = Array.prototype.slice.call(arguments);
            return this.$element[i].apply(this.$element, t);
        };
    }), e.each([ "extend", "inArray", "isEmptyObject" ], function(i, o) {
        t[o] = e[o];
    }), i.adapters.push({
        name: "jquery",
        Adapter: t
    }), i.Adapter = t;
}(), function() {
    "use strict";
    function t(t) {
        return function() {
            var i = [], o = arguments[0];
            return t.isFunction(arguments[0]) && (o = t.extend({}, arguments[1]), o.handler = arguments[0]), 
            this.each(function() {
                var n = t.extend({}, o, {
                    element: this
                });
                "string" == typeof n.context && (n.context = t(this).closest(n.context)[0]), i.push(new e(n));
            }), i;
        };
    }
    var e = window.Waypoint;
    window.jQuery && (window.jQuery.fn.waypoint = t(window.jQuery)), window.Zepto && (window.Zepto.fn.waypoint = t(window.Zepto));
}();

(function($) {
    var d = $(document);
    var h = $("head");
    var drag = null;
    var tables = {};
    var count = 0;
    var ID = "id";
    var PX = "px";
    var SIGNATURE = "JColResizer";
    var FLEX = "JCLRFlex";
    var I = parseInt;
    var M = Math;
    var ie = navigator.userAgent.indexOf("Trident/4.0") > 0;
    var S;
    var pad = "";
    try {
        S = sessionStorage;
    } catch (e) {}
    h.append("<style type='text/css'>  .JColResizer{table-layout:fixed;} .JColResizer > tbody > tr > td, .JColResizer > tbody > tr > th{overflow:hidden}  .JPadding > tbody > tr > td, .JPadding > tbody > tr > th{padding-left:0!important; padding-right:0!important;} .JCLRgrips{ height:0px; position:relative;} .JCLRgrip{margin-left:-5px; position:absolute; z-index:5; } .JCLRgrip .JColResizer{position:absolute;background-color:red;filter:alpha(opacity=1);opacity:0;width:10px;height:100%;cursor: col-resize;top:0px} .JCLRLastGrip{position:absolute; width:1px; } .JCLRgripDrag{ border-left:1px dotted black;\t} .JCLRFlex{width:auto!important;} .JCLRgrip.JCLRdisabledGrip .JColResizer{cursor:default; display:none;}</style>");
    var init = function(tb, options) {
        var t = $(tb);
        t.opt = options;
        t.mode = options.resizeMode;
        t.dc = t.opt.disabledColumns;
        if (t.opt.removePadding) t.addClass("JPadding");
        if (t.opt.disable) return destroy(t);
        var id = t.id = t.attr(ID) || SIGNATURE + count++;
        t.p = t.opt.postbackSafe;
        if (!t.is("table") || tables[id] && !t.opt.partialRefresh) return;
        if (t.opt.hoverCursor !== "col-resize") h.append("<style type='text/css'>.JCLRgrip .JColResizer:hover{cursor:" + t.opt.hoverCursor + "!important}</style>");
        t.addClass(SIGNATURE).attr(ID, id).before('<div class="JCLRgrips"/>');
        t.g = [];
        t.c = [];
        t.w = t.width();
        t.gc = t.prev();
        t.f = t.opt.fixed;
        if (options.marginLeft) t.gc.css("marginLeft", options.marginLeft);
        if (options.marginRight) t.gc.css("marginRight", options.marginRight);
        t.cs = I(ie ? tb.cellSpacing || tb.currentStyle.borderSpacing : t.css("border-spacing")) || 2;
        t.b = I(ie ? tb.border || tb.currentStyle.borderLeftWidth : t.css("border-left-width")) || 1;
        tables[id] = t;
        createGrips(t);
    };
    var destroy = function(t) {
        var id = t.attr(ID), t = tables[id];
        if (!t || !t.is("table")) return;
        t.removeClass(SIGNATURE + " " + FLEX).gc.remove();
        delete tables[id];
    };
    var createGrips = function(t) {
        var th = t.find(">thead>tr:first>th,>thead>tr:first>td");
        if (!th.length) th = t.find(">tbody>tr:first>th,>tr:first>th,>tbody>tr:first>td, >tr:first>td");
        th = th.filter(":visible");
        t.cg = t.find("col");
        t.ln = th.length;
        if (t.p && S && S[t.id]) memento(t, th);
        th.each(function(i) {
            var c = $(this);
            var dc = t.dc.indexOf(i) != -1;
            var g = $(t.gc.append('<div class="JCLRgrip"></div>')[0].lastChild);
            g.append(dc ? "" : t.opt.gripInnerHtml).append('<div class="' + SIGNATURE + '"></div>');
            if (i == t.ln - 1) {
                g.addClass("JCLRLastGrip");
                if (t.f) g.html("");
            }
            g.bind("touchstart mousedown", onGripMouseDown);
            if (!dc) {
                g.removeClass("JCLRdisabledGrip").bind("touchstart mousedown", onGripMouseDown);
            } else {
                g.addClass("JCLRdisabledGrip");
            }
            g.t = t;
            g.i = i;
            g.c = c;
            c.w = c.width();
            t.g.push(g);
            t.c.push(c);
            c.width(c.w).removeAttr("width");
            g.data(SIGNATURE, {
                i: i,
                t: t.attr(ID),
                last: i == t.ln - 1
            });
        });
        t.cg.removeAttr("width");
        t.find("td, th").not(th).not("table th, table td").each(function() {
            $(this).removeAttr("width");
        });
        if (!t.f) {
            t.removeAttr("width").addClass(FLEX);
        }
        syncGrips(t);
    };
    var memento = function(t, th) {
        var w, m = 0, i = 0, aux = [], tw;
        if (th) {
            t.cg.removeAttr("width");
            if (t.opt.flush) {
                S[t.id] = "";
                return;
            }
            w = S[t.id].split(";");
            tw = w[t.ln + 1];
            if (!t.f && tw) {
                t.width(tw *= 1);
                if (t.opt.overflow) {
                    t.css("min-width", tw + PX);
                    t.w = tw;
                }
            }
            for (;i < t.ln; i++) {
                aux.push(100 * w[i] / w[t.ln] + "%");
                th.eq(i).css("width", aux[i]);
            }
            for (i = 0; i < t.ln; i++) t.cg.eq(i).css("width", aux[i]);
        } else {
            S[t.id] = "";
            for (;i < t.c.length; i++) {
                w = t.c[i].width();
                S[t.id] += w + ";";
                m += w;
            }
            S[t.id] += m;
            if (!t.f) S[t.id] += ";" + t.width();
        }
    };
    var syncGrips = function(t) {
        t.gc.width(t.w);
        for (var i = 0; i < t.ln; i++) {
            var c = t.c[i];
            t.g[i].css({
                left: c.offset().left - t.offset().left + c.outerWidth(false) + t.cs / 2 + PX,
                height: t.opt.headerOnly ? t.c[0].outerHeight(false) : t.outerHeight(false)
            });
        }
    };
    var syncCols = function(t, i, isOver) {
        var inc = drag.x - drag.l, c = t.c[i], c2 = t.c[i + 1];
        var w = c.w + inc;
        var w2 = c2.w - inc;
        c.width(w + PX);
        t.cg.eq(i).width(w + PX);
        if (t.f) {
            c2.width(w2 + PX);
            t.cg.eq(i + 1).width(w2 + PX);
        } else if (t.opt.overflow) {
            t.css("min-width", t.w + inc);
        }
        if (isOver) {
            c.w = w;
            c2.w = t.f ? w2 : c2.w;
        }
    };
    var applyBounds = function(t) {
        var w = $.map(t.c, function(c) {
            return c.width();
        });
        t.width(t.w = t.width()).removeClass(FLEX);
        $.each(t.c, function(i, c) {
            c.width(w[i]).w = w[i];
        });
        t.addClass(FLEX);
    };
    var onGripDrag = function(e) {
        if (!drag) return;
        var t = drag.t;
        var oe = e.originalEvent.touches;
        var ox = oe ? oe[0].pageX : e.pageX;
        var x = ox - drag.ox + drag.l;
        var mw = t.opt.minWidth, i = drag.i;
        var l = t.cs * 1.5 + mw + t.b;
        var last = i == t.ln - 1;
        var min = i ? t.g[i - 1].position().left + t.cs + mw : l;
        var max = t.f ? i == t.ln - 1 ? t.w - l : t.g[i + 1].position().left - t.cs - mw : Infinity;
        x = M.max(min, M.min(max, x));
        drag.x = x;
        drag.css("left", x + PX);
        if (last) {
            var c = t.c[drag.i];
            drag.w = c.w + x - drag.l;
        }
        if (t.opt.liveDrag) {
            if (last) {
                c.width(drag.w);
                if (!t.f && t.opt.overflow) {
                    t.css("min-width", t.w + x - drag.l);
                } else {
                    t.w = t.width();
                }
            } else {
                syncCols(t, i);
            }
            syncGrips(t);
            var cb = t.opt.onDrag;
            if (cb) {
                e.currentTarget = t[0];
                cb(e);
            }
        }
        return false;
    };
    var onGripDragOver = function(e) {
        d.unbind("touchend." + SIGNATURE + " mouseup." + SIGNATURE).unbind("touchmove." + SIGNATURE + " mousemove." + SIGNATURE);
        $("head :last-child").remove();
        if (!drag) return;
        drag.removeClass(drag.t.opt.draggingClass);
        if (!(drag.x - drag.l == 0)) {
            var t = drag.t;
            var cb = t.opt.onResize;
            var i = drag.i;
            var last = i == t.ln - 1;
            var c = t.g[i].c;
            if (last) {
                c.width(drag.w);
                c.w = drag.w;
            } else {
                syncCols(t, i, true);
            }
            if (!t.f) applyBounds(t);
            syncGrips(t);
            if (cb) {
                e.currentTarget = t[0];
                cb(e);
            }
            if (t.p && S) memento(t);
        }
        drag = null;
    };
    var onGripMouseDown = function(e) {
        var o = $(this).data(SIGNATURE);
        var t = tables[o.t], g = t.g[o.i];
        var oe = e.originalEvent.touches;
        g.ox = oe ? oe[0].pageX : e.pageX;
        g.l = g.position().left;
        g.x = g.l;
        d.bind("touchmove." + SIGNATURE + " mousemove." + SIGNATURE, onGripDrag).bind("touchend." + SIGNATURE + " mouseup." + SIGNATURE, onGripDragOver);
        h.append("<style type='text/css'>*{cursor:" + t.opt.dragCursor + "!important}</style>");
        g.addClass(t.opt.draggingClass);
        drag = g;
        if (t.c[o.i].l) for (var i = 0, c; i < t.ln; i++) {
            c = t.c[i];
            c.l = false;
            c.w = c.width();
        }
        return false;
    };
    var onResize = function() {
        for (var t in tables) {
            if (tables.hasOwnProperty(t)) {
                t = tables[t];
                var i, mw = 0;
                t.removeClass(SIGNATURE);
                if (t.f) {
                    t.w = t.width();
                    for (i = 0; i < t.ln; i++) mw += t.c[i].w;
                    for (i = 0; i < t.ln; i++) t.c[i].css("width", M.round(1e3 * t.c[i].w / mw) / 10 + "%").l = true;
                } else {
                    applyBounds(t);
                    if (t.mode == "flex" && t.p && S) {
                        memento(t);
                    }
                }
                syncGrips(t.addClass(SIGNATURE));
            }
        }
    };
    $(window).bind("resize." + SIGNATURE, onResize);
    $.fn.extend({
        colResizable: function(options) {
            var defaults = {
                resizeMode: "fit",
                draggingClass: "JCLRgripDrag",
                gripInnerHtml: "",
                liveDrag: false,
                minWidth: 15,
                headerOnly: false,
                hoverCursor: "col-resize",
                dragCursor: "col-resize",
                postbackSafe: false,
                flush: false,
                marginLeft: null,
                marginRight: null,
                disable: false,
                partialRefresh: false,
                disabledColumns: [],
                removePadding: true,
                onDrag: null,
                onResize: null
            };
            var options = $.extend(defaults, options);
            options.fixed = true;
            options.overflow = false;
            switch (options.resizeMode) {
              case "flex":
                options.fixed = false;
                break;

              case "overflow":
                options.fixed = false;
                options.overflow = true;
                break;
            }
            return this.each(function() {
                init(this, options);
            });
        }
    });
})(jQuery);

var app = app || {};

app.charts = app.charts || {};

app.charts.tree = {};

app.charts.tree.draw = function(input, settings, refreshWithData, titlebar) {
    settings.input = input;
    app.chartCommons.calculateFields(input.series, settings.calculatedFields);
    var title = input.title;
    var chartInfo = input.chartInfo;
    var seriesLabels = typeof input.series != "undefined" ? input.series.labels : [];
    var kpisLabels = typeof input.kpis != "undefined" ? input.kpis.labels : [];
    var yAxeLable = settings.LabelY;
    var selector = "#" + settings.id;
    var margin = {
        top: 10,
        right: 20,
        bottom: 0,
        left: 20
    };
    var width = $(selector).width();
    var divHeight = $(selector).height();
    var barHeight = settings.chartProp.info.chartSize == "small" ? 150 : settings.chartProp.info.chartSize == "medium" ? 200 : settings.chartProp.info.chartSize == "large" ? 250 : settings.chartProp.info.chartSize == "veryLarge" ? 400 : 130;
    settings.width = width;
    var showPersian = typeof input.lang == "undefined" ? true : +input.lang == 0 ? true : false;
    var isProgress = titlebar.isProgress;
    var showProgress = titlebar.showProgress;
    var title = titlebar.title;
    if (settings.editMode) {
        $(selector).trigger("chartproperty", [ kpisLabels.concat(seriesLabels) ]);
    }
    if (!input.result) {
        $("#" + settings.id).append(app.chartCommons.getError(input));
        return;
    }
    $(selector).addClass("tree-chart");
    $(selector).css({
        "overflow-y": "auto",
        "overflow-x": "hidden",
        "margin-left": "-1rem"
    });
    var titleHeight = $(selector + " .title").outerHeight();
    var height = $(selector).outerHeight() - titleHeight - 2;
    var root = d3.select(selector).append("ul").attr("class", "root-node temporal tree").text("");
    root.style("height", height + "px");
    var createNode = function(parent, input) {
        parent.select(".loading").remove();
        $(parent.node()).data("vals", input.vals);
        var glyph = $(parent.node()).find(".tree-caret");
        var show = glyph.length == 0 || glyph.hasClass("rotate");
        var root = d3.select($("<ul></ul>").get(0)).attr("class", "tree-element collapse fade " + (show ? "in" : ""));
        input.data = input.data.map(function(d) {
            return {
                id: d[0],
                parent: d[1],
                name: d[2] || d[0],
                type: input.hasType ? d[3] : null,
                childs: d[d.length - 1]
            };
        });
        var li = root.selectAll("li").data(input.data).enter().append("li").attr("class", "node tree-element");
        li.append("span").text(function(d, i) {
            return d.name;
        }).attr("class", "value pointer").on("click", function(d) {
            var selectable = settings.chartProp.info.selectable;
            if (typeof selectable == "undefined" || selectable == "none") return;
            if (selectable == "one") {
                $(this).closest(".tree-chart").find(".value.active").removeClass("active");
            }
            $(this).toggleClass("active");
            var vals = d3.select(selector).selectAll(".active").data().map(function(d) {
                return d.id;
            });
            var newV = _.filter(input.vals, function(d) {
                return d[0] === vals[0];
            }).map(function(d) {
                return d[1];
            });
            if (newV.length === 0) newV = vals;
            ajaxCall({
                Id: -1,
                Values: newV,
                VariableType: 0
            });
        });
        li.each(function(d) {
            if (+d.childs == 0) return;
            d3.select(this).append("i").attr("class", function() {
                return "icon angle left icon-animate large  tree-caret pointer";
            }).text(" ").on("click", function(d, i) {
                if (+d.childs == 0) return;
                var rotateClass = "rotate-90";
                var glyph = $(this);
                var isOpen = glyph.hasClass(rotateClass);
                if (isOpen) glyph.removeClass(rotateClass); else glyph.addClass(rotateClass);
                var loaded = $(this).data("loaded");
                if (loaded) {
                    var ul = $(this).parent().find(" > ul");
                    ul.transition(isOpen ? "out scale right" : "in  scale left");
                    return;
                }
                $(this).data("loaded", true);
                var parameters = {
                    parent: d.id,
                    chartId: settings.chartId,
                    ChartInPageId: settings.ChartInPageId,
                    notEditMode: !settings.editMode
                };
                if (settings.editMode) {
                    parameters.ChartInfo = $("#divChart").data("chartInfo");
                }
                var node = d3.select(this).node().parentElement;
                d3.select(node).append("ul").attr("class", "loading collapse fade in").html('<div class="ui active inline loader mini"></div>');
                var dataUrl = app.urlPrefix + "Charts/BarChart/getTreeData";
                var caller = app.mobileMode ? proxy.ajax : $.ajax;
                var data = JSON.stringify(parameters);
                var ajaxRequest = caller({
                    url: dataUrl,
                    type: "POST",
                    dataType: "json",
                    contentType: "application/json",
                    data: data,
                    async: settings.async,
                    requestId: settings.requestId,
                    success: function(input, isOnline, date) {
                        settings.mobileModeData = {
                            isOnline: isOnline,
                            date: date
                        };
                        createNode(d3.select(node), input);
                    },
                    error: function() {}
                });
            });
        });
        root.style("display", "none");
        $(parent._groups[0][0]).append($(root._groups[0][0]));
        $(parent._groups[0][0]).find("> ul").transition("in scale ");
    };
    createNode(root, input);
    $(selector).trigger("heightChange");
    function ajaxCall(data) {
        data.dimensionName = input.dimensionName;
        data.datasourceId = input.DataSourceId;
        data.chartId = settings.editMode ? -1 : input.chartId;
        if (!settings.editMode && data.Id === -1) {
            app.chartCommons.userFilter.setFilter({
                id: data.Id,
                values: data.Values,
                variableType: data.VariableType,
                dimensionName: data.dimensionName,
                chartInPageId: settings.ChartInPageId,
                datasourceId: data.datasourceId
            });
        }
        if (+data.Id === -1) {
            app.moderation.dashboadpage.refreshRelatedDatasources(input.RefreshDatasource, [ +settings.ChartInPageId ]);
            app.filterBox.refresh();
            return;
        }
        $.ajax({
            type: "POST",
            url: app.urlPrefix + "Moderation/GlobalVariable/SetValueForUser",
            dataType: "json",
            contentType: "application/json;charset=utf-8",
            traditional: true,
            data: JSON.stringify(data),
            success: function(data) {
                if (data.result) {
                    app.moderation.dashboadpage.refreshRelatedDatasources(data.relatedDatasource, [ +settings.ChartInPageId ]);
                    app.filterBox.refresh();
                } else {
                    alert(data.Message);
                }
            }
        });
    }
};

var app = app || {};

app.charts = app.charts || {};

app.charts.text = {};

app.charts.text.draw = function(input, settings, refreshWithData, titlebar) {
    settings.input = input;
    app.chartCommons.calculateFields(input.series, settings.calculatedFields);
    var title = input.title;
    var chartInfo = input.chartInfo;
    var seriesLabels = typeof input.series != "undefined" ? input.series.labels : [];
    var kpisLabels = typeof input.kpis != "undefined" ? input.kpis.labels : [];
    var yAxeLable = settings.LabelY;
    var selector = "#" + settings.id;
    var margin = {
        top: 10,
        right: 20,
        bottom: 0,
        left: 20
    };
    var width = $(selector).width();
    var divHeight = $(selector).height();
    var barHeight = settings.chartProp.info.chartSize == "small" ? 150 : settings.chartProp.info.chartSize == "medium" ? 200 : settings.chartProp.info.chartSize == "large" ? 250 : settings.chartProp.info.chartSize == "veryLarge" ? 400 : 130;
    settings.width = width;
    var showPersian = typeof input.lang == "undefined" ? true : +input.lang == 0 ? true : false;
    var isProgress = titlebar.isProgress;
    var showProgress = titlebar.showProgress;
    var title = titlebar.title;
    if (settings.editMode) {
        $(selector).trigger("chartproperty", [ kpisLabels.concat(seriesLabels) ]);
    }
    if (!input.result) {
        $("#" + settings.id).append(app.chartCommons.getError(input));
        return;
    }
    $(selector).addClass("tree-chart").css("text-align", "right");
    var titleHeight = $(selector + " .title").outerHeight();
    var height = $(selector).outerHeight() - titleHeight - 2;
    var root = d3.select(selector).append("ul").attr("class", "root-node temporal tree").text("");
    root.style("height", height + "px");
    $(selector).append(settings.chartProp.info.html);
    function ajaxCall(data) {
        data.dimensionName = input.dimensionName;
        data.datasourceId = input.DataSourceId;
        data.chartId = settings.editMode ? -1 : input.chartId;
        if (!settings.editMode && data.Id == -1) app.chartCommons.userFilter.setFilter({
            id: data.Id,
            values: data.Values,
            variableType: data.VariableType,
            dimensionName: data.dimensionName,
            chartInPageId: settings.ChartInPageId,
            datasourceId: data.datasourceId
        });
        $.ajax({
            type: "POST",
            url: app.urlPrefix + "Moderation/GlobalVariable/SetValueForUser",
            dataType: "json",
            contentType: "application/json;charset=utf-8",
            traditional: true,
            data: JSON.stringify(data),
            success: function(data) {
                if (data.result) {
                    app.moderation.dashboadpage.refreshRelatedDatasources(data.relatedDatasource, [ +settings.ChartInPageId ]);
                    app.filterBox.refresh();
                } else {
                    alert(data.Message);
                }
            }
        });
    }
};

var app = app || {};

app.charts = app.charts || {};

app.charts.userControl = {};

String.prototype.deentitize = function() {
    var ret = this.replace(/&gt;/g, ">");
    ret = ret.replace(/&amp;/g, "&");
    ret = ret.replace(/&lt;/g, "<");
    ret = ret.replace(/&quot;/g, '"');
    ret = ret.replace(/&apos;/g, "'");
    ret = ret.replace(/<br r >/g, "\r");
    ret = ret.replace(/<br n >/g, "\n");
    return ret;
};

String.prototype.entitize = function() {
    var ret = this;
    var rr = this;
    ret = ret.replace(/&/g, "&amp;");
    ret = ret.replace(/>/g, "&gt;");
    ret = ret.replace(/</g, "&lt;");
    ret = ret.replace(/"/g, "&quot;");
    ret = ret.replace(/'/g, "&apos;");
    ret = ret.replace(/\r/g, "<br r >");
    ret = ret.replace(/\n/g, "<br n >");
    return ret;
};

app.charts.userControl.draw = function(input, settings, refreshWithData, titlebar) {
    app.dashboardLayoutVersion = app.dashboardLayoutVersion || 2;
    settings.input = input;
    app.chartCommons.calculateFields(input.series, settings.calculatedFields);
    var selector = "#" + settings.id;
    var width = $(selector).width();
    settings.width = width;
    var showPersian = typeof input.lang == "undefined" ? true : +input.lang == 0 ? true : false;
    var isProgress = titlebar.isProgress;
    var showProgress = titlebar.showProgress;
    var title = titlebar.title;
    if (settings.chartProp.info.variableDefaultFunction == "NONE") {
        settings.chartProp.info.variableDefaultType = "NONE";
    }
    if (!input.result && !(settings.chartProp.info.type == "datepicker" || settings.chartProp.info.type == "datepicker-range")) {
        $("#" + settings.id).append(app.chartCommons.getError(input));
        return;
    }
    var isVariableRelated = settings.chartProp.info.variableId != -1;
    setGlobalFilter();
    switch (settings.chartProp.info.type) {
      case "combo":
        drawCombo();
        break;

      case "multi":
        drawCombo(true);
        break;

      case "datepicker":
        drawDatepicker(false);
        break;

      case "datepicker-range":
        drawDatepicker(true);
        break;

      case "multi-filter":
        drawMultiSelectWithFilter();
        break;

      case "slider":
        drawNumericRange();
        break;

      case "text":
        drawText();
        break;

      default:    }
    $(selector).trigger("heightChange");
    function drawText() {
        var t = '<div class="ui form temporal">    <div class=" field ui search">        <div class="ui icon input">            <input type="text" placeholder="جستجو...">            <i class="search icon"></i>        </div>        <div class="results"></div>    </div></div> ';
        t = '<div class="temporal ui search">                  <div class="ui icon fluid input">                    <input class="prompt" type="text" placeholder="جستجو...">                    <i class="search icon"></i>                  </div>                  <div class="results"></div>                </div>';
        $(selector).append(t);
        function change(value) {
            var v = [ value ];
            var op = settings.chartProp.info.textOperand || "or";
            var useLike = typeof settings.chartProp.info.useLike == "undefined" ? true : settings.chartProp.info.useLike;
            var useNormal = typeof settings.chartProp.info.useNormal == "undefined" ? true : settings.chartProp.info.useNormal;
            v.push(JSON.stringify({
                op: op,
                useLike: useLike,
                useNormal: useNormal
            }));
            var name = settings.chartProp.info.dimensions.map(function(d) {
                return d.Name;
            }).join(", ");
            v.push(name);
            settings.chartProp.info.dimensions.forEach(function(d) {
                v.push(d.formula);
            });
            if (!settings.editMode) {
                var data = {
                    Id: settings.chartProp.info.variableId || -1,
                    Values: v,
                    VariableType: 5
                };
                ajaxCall(data);
            } else {
                $(selector).trigger("default-value", [ true, v, 5 ]);
            }
        }
        $.fn.search.settings.templates.message = function(message, type) {
            return "";
        };
        $(selector + " .ui.search").search({
            fullTextSearch: true,
            filterRemoteData: false,
            apiSettings: {
                url: app.urlPrefix + "api/chartdata/GetColumnMembers",
                cache: false,
                method: "post",
                beforeSend: function(s) {
                    var o = getFilters();
                    s.data = {
                        chartId: settings.chartId,
                        chartInPageId: settings.ChartInPageId,
                        userVariable: o.userVariable,
                        userControlFilter: o.userControlFilter,
                        otherFilters: o.otherFilters,
                        query: s.urlData.query,
                        chartInfo: $("#divChart").data("chartInfo"),
                        top: 10
                    };
                    return s;
                },
                onResponse: function(res) {
                    res.fields = res.fields.map(function(d) {
                        return {
                            title: d.Key.entitize(),
                            Value: d.Value.entitize()
                        };
                    });
                    console.log(res.fields);
                    return {
                        results: res.fields
                    };
                },
                dataType: "json"
            },
            onSelect: function(result, response) {
                change(result.Value);
            }
        });
        $(selector + " input").on("keydown", function(e) {
            var v = $(this).val();
            if (e.keyCode === 13) {
                change(v);
                return;
            }
        });
        var dv = [];
        if (input.GloablFilterDefaultValue) {
            dv = input.GloablFilterDefaultValue.Value;
        } else if (input.DefaultValue != null && input.DefaultValue.length > 0 && settings.chartProp.info.variableId != -1) {
            dv = input.DefaultValue;
        } else if (settings.chartProp.info.variableDefault && settings.chartProp.info.variableDefault.values && settings.chartProp.info.variableDefaultType == "NONE" && settings.chartProp.info.variableId != -1) {
            dv = settings.chartProp.info.variableDefault.values;
        } else {
            dv = [ "", "" ];
        }
        $(selector + " input").val(dv[0]);
    }
    function setGlobalFilter() {
        if (!settings.editMode) {
            var filter = app.chartCommons.userFilter.getFilterValue(settings.ChartInPageId);
            if (!_.isNull(filter)) {
                input.GloablFilterDefaultValue = input.GloablFilterDefaultValue || {};
                input.GloablFilterDefaultValue.ValuesType = filter.variableType;
                input.GloablFilterDefaultValue.Value = +filter.variableType == 3 ? filter.defaultValue : filter.values;
            }
        }
    }
    function drawMultiSelectWithFilter() {
        var values = input.fields.map(function(d) {
            return d.Value;
        });
        var names = input.fields.map(function(d) {
            return d.Key;
        });
        if (names.length != values.length) {
            $("#" + settings.id).append(app.chartCommons.getError(input));
        }
        var members = [];
        for (var i = 0; i < values.length; i++) {
            members.push({
                Caption: names[i],
                Uniquename: values[i],
                IsChecked: false
            });
        }
        var onChangeFun = function(data) {
            var vals = data.filter(function(d) {
                return d.IsChecked;
            }).map(function(d) {
                return d.Uniquename;
            });
            var names = data.filter(function(d) {
                return d.IsChecked;
            }).map(function(d) {
                return d.Caption;
            });
            var h = '<div style="text-align: right; font-size: 0.9em; margin-top: 7px;"><b>انتخاب‌ها:</b><ul>' + names.map(function(d) {
                return '<li style="  float:right; display:inline; width:33%;">' + d + "</li>";
            }).join("") + "</ul></div>";
            $(selector + " .selected-item").html(filterXSS(h));
            input.DefaultValue = vals;
            if (settings.editMode) {
                $(selector).trigger("default-value", [ true, vals, 0 ]);
            } else {
                ajaxCall({
                    Id: settings.chartProp.info.variableId || -1,
                    Values: vals
                });
            }
        };
        select = '<div class="container-fluid temporal" style="margin: 15px 0px 10px;"><div class="row"><a  class=" btn btn-primary pointer filter-member btn-block"> ' + (settings.chartProp.info.label || "انتخاب") + ' <span class="glyphicon glyphicon-list-alt"></span></a></div><div class="row selected-item col-sm-12"></div></div>';
        $(selector).append(select);
        $(selector + " .filter-member").on("click", function() {
            app.helper.filterMemberDialog(members, onChangeFun);
        });
        if (input.DefaultValue != null && input.DefaultValue.length > 0) {
            members.filter(function(d) {
                return input.DefaultValue.indexOf(d.Uniquename) != -1;
            }).forEach(function(d, i) {
                d.IsChecked = true;
            });
            var h = '<div style="text-align: right; font-size: 0.9em; margin-top: 7px;"><b>انتخاب‌ها:</b><ul>' + members.filter(function(d) {
                return d.IsChecked;
            }).map(function(d) {
                return '<li style="  float:right; display:inline; width:33%;">' + d.Caption + "</li>";
            }).join("") + "</ul></div>";
            $(selector + " .selected-item").html(filterXSS(h));
        } else if (settings.chartProp.info.variableDefault && settings.chartProp.info.variableDefault.values) {
            var dv = settings.chartProp.info.variableDefault.values;
            members.filter(function(d) {
                return dv.indexOf(d.Uniquename) != -1;
            }).forEach(function(d, i) {
                d.IsChecked = true;
            });
            var h = '<div style="text-align: right; font-size: 0.9em; margin-top: 7px;"><b>انتخاب‌ها:</b><ul>' + members.filter(function(d) {
                return d.IsChecked;
            }).map(function(d) {
                return '<li style="  float:right; display:inline; width:33%;">' + d.Caption + "</li>";
            }).join("") + "</ul></div>";
            $(selector + " .selected-item").html(filterXSS(h));
        }
        if (settings.editMode) {
            var selectEl = $(selector).find("select");
            $(selector).trigger("default-value", [ false, [ members[0].UniqueName ], 0 ]);
        }
        if (refreshWithData) onChangeFun(members);
    }
    function drawDatepicker(isMulti) {
        var select = '<div class="ui form temporal"><div class=" field"><div class="ui input">                        <input autocomplete="off" type="text" id=""  class="form-control from" placeholder="تاریخ" /><input id="from-value" type="hidden"/>                      </div></div></div>';
        if (isMulti) {
            select = '<div class="ui grid temporal form-content" ><div class="row">                        <div class="five wide column ui input">                            <input autocomplete="off" type="text" class="datepicker form-control from" placeholder="تاریخ شروع" />                            <input id="from-value" type="hidden"/>                        </div>                        <div class="two wide column">تا</div>                        <div class="five wide column ui input">                            <input autocomplete="off" type="text" class="datepicker form-control to" placeholder="تاریخ پایان"/>                            <input id="to-value" type="hidden"/>                        </div>                      </div></div>';
        }
        select = $(select);
        $(selector).append(select);
        var beforeShow = function() {
            setTimeout(function() {
                $(".ui-datepicker").css("z-index", 4);
            }, 0);
        };
        if (!isMulti) {
            select.find(" .from").datepicker({
                changeMonth: true,
                changeYear: true,
                dateFormat: settings.chartProp.info.dateFormatShow + "",
                altFormat: settings.chartProp.info.dateFormatValue + "",
                altField: select.find("#from-value"),
                onClose: function(selectedDate) {
                    if (!selectedDate) return;
                    changeValue(select, isMulti, select.find("#from-value").val(), null, true);
                },
                yearRange: "-30:+30",
                beforeShow: beforeShow
            });
        } else {
            select.find(".from").datepicker({
                defaultDate: "+1w",
                changeYear: true,
                changeMonth: true,
                dateFormat: settings.chartProp.info.dateFormatShow + "",
                altFormat: settings.chartProp.info.dateFormatValue + "",
                altField: select.find("#from-value"),
                onClose: function(selectedDate) {
                    if (!selectedDate) return;
                    select.find(".to").datepicker("option", "minDate", selectedDate);
                    changeValue(select, isMulti, select.find("#from-value").val(), select.find("#to-value").val(), true);
                },
                yearRange: "-30:+30",
                beforeShow: beforeShow
            });
            select.find(".to").datepicker({
                defaultDate: "+1w",
                changeYear: true,
                changeMonth: true,
                dateFormat: settings.chartProp.info.dateFormatShow + "",
                altFormat: settings.chartProp.info.dateFormatValue + "",
                altField: select.find("#to-value"),
                onClose: function(selectedDate) {
                    if (!selectedDate) return;
                    select.find(".from").datepicker("option", "maxDate", selectedDate);
                    changeValue(select, isMulti, select.find("#from-value").val(), select.find("#to-value").val(), true);
                },
                yearRange: "-30:+30",
                beforeShow: beforeShow
            });
        }
        var dateLimit = settings.chartProp.info.dateLimit || {
            enable: false
        };
        if (dateLimit.enable) {
            if (dateLimit.minDate) {
                select.find(".from").datepicker("option", "minDate", dateLimit.minDate);
                select.find(".to").datepicker("option", "minDate", dateLimit.minDate);
            }
            if (dateLimit.maxDate) {
                select.find(".from").datepicker("option", "maxDate", dateLimit.maxDate);
                select.find(".to").datepicker("option", "maxDate", dateLimit.maxDate);
            }
            if (dateLimit.useDataMinMax && input.dataMinMax) {
                select.find(".from").datepicker("option", "maxDate", input.dataMinMax.max);
                select.find(".to").datepicker("option", "maxDate", input.dataMinMax.max);
                select.find(".from").datepicker("option", "minDate", input.dataMinMax.min);
                select.find(".to").datepicker("option", "minDate", input.dataMinMax.min);
            }
        }
        var lastFrom, lastTo;
        var isToday = false;
        if (typeof input.DefaultValue == "undefined" || !input.DefaultValue) {
            var gregorianDate = new Date();
            function gregorian_to_jalali(d) {
                return jd_to_persian(gregorian_to_jd(d[0], d[1] + 1, d[2]));
            }
            var jalaliDate = gregorian_to_jalali([ gregorianDate.getFullYear(), gregorianDate.getMonth(), gregorianDate.getDate() ]);
            function pad(num, size) {
                var s = "000000000" + num;
                return s.substr(s.length - size);
            }
            var today = jalaliDate[0] + "/" + pad(jalaliDate[1], 2) + "/" + pad(jalaliDate[2], 2);
            select.find(".from").datepicker("option", "dateFormat", "yy/mm/dd");
            select.find(".from").datepicker("setDate", today);
            select.find(".from").datepicker("option", "dateFormat", settings.chartProp.info.dateFormatValue);
            today = select.find(".from").val();
            input.DefaultValue = [ today, today ];
            isToday = true;
        }
        var dv = [];
        if (input.GloablFilterDefaultValue) {
            dv = input.GloablFilterDefaultValue.Value;
        } else if (input.DefaultValue != null && input.DefaultValue.length > 0 && settings.chartProp.info.variableId != -1) {
            dv = input.DefaultValue;
        }
        dv = dv.map(function(d) {
            return d.replace(/\[[^\]]+\]/, "");
        });
        select.find(".from").datepicker("option", "dateFormat", settings.chartProp.info.dateFormatValue + "");
        select.find(".to").datepicker("option", "dateFormat", settings.chartProp.info.dateFormatValue + "");
        lastFrom = isToday ? "" : dv[0];
        select.find(".from").datepicker("setDate", dv[0]);
        if (isMulti) {
            select.find(".to").datepicker("setDate", dv[1]);
            lastTo = isToday ? "" : dv[1];
        }
        changeValue(select, isMulti, select.find("#from-value").val(), select.find("#to-value").val(), false);
        function changeValue(select, isMulti, from, to, callFromUi) {
            if (isMulti && !(from && to)) return;
            if (!isMulti && !from) return;
            if (!settings.editMode && (isMulti && lastFrom == from && lastTo == to || !isMulti && lastFrom == from)) {
                return;
            }
            lastFrom = from;
            lastTo = to;
            var value = isMulti ? [ from, to ] : [ from, settings.chartProp.info.dateOp ];
            settings.input.DefaultValue = value;
            if (!settings.editMode && callFromUi) {
                var data = {
                    Id: settings.chartProp.info.variableId || -1,
                    Values: value,
                    VariableType: isMulti ? 2 : 4
                };
                ajaxCall(data);
            } else {
                var selectEl = $(selector).find("select");
                $(selector).trigger("default-value", [ true, value, isMulti ? 2 : 4 ]);
            }
            $(selector).data("user-value", value);
        }
    }
    function drawNumericRange(isMulti) {
        var values = input.fields.map(function(d) {
            return d.Value;
        });
        var names = input.fields.map(function(d) {
            return d.Key;
        });
        var max = settings.chartProp.info.sliderMax != "" && typeof settings.chartProp.info.sliderMax != "undefined" ? +settings.chartProp.info.sliderMax : d3.max(values, function(d) {
            return +d.replace(/\[[^\]]+\]/, "");
        }) || 100;
        var min = settings.chartProp.info.sliderMin != "" && typeof settings.chartProp.info.sliderMin != "undefined" ? +settings.chartProp.info.sliderMin : d3.min(values, function(d) {
            return +d.replace(/\[[^\]]+\]/, "");
        }) || 0;
        var select = '<div class="temporal" style="padding-left: 15px; padding-right: 15px; padding-top:5px">                        <div class="slider"></div>                        <div class="slider-value ltr" style="margin-top:5px"> </div>                        <input id="from-value" type="hidden"/>                      </div>';
        select = $(select);
        $(selector).append(select);
        settings.chartProp.info.sliderFont = _.extend({
            bold: false,
            color: "#333333",
            italic: false,
            fontSize: "10px",
            fontName: "IRANSans",
            formatString: settings.chartProp.info.sliderFormat || ",.2f",
            formatStringCustom: ",.2f"
        }, settings.chartProp.info.sliderFont);
        var isRange = settings.chartProp.info.sliderRange == "min-max";
        var showLabel = function(p) {
            var format = settings.chartProp.info.sliderFont.formatString || ",.2f";
            if (Array.isArray(p)) {
                return '<div class="inline">' + persian(d3.format(format)(p[0]), showPersian) + '</div> <div class="inline"> تا </div> <div class="inline">' + persian(d3.format(format)(p[1]), showPersian) + "</div>";
            } else {
                return persian(d3.format(format)(p), showPersian);
            }
        };
        select.find(".slider").slider({
            range: isRange ? true : settings.chartProp.info.sliderRange,
            min: min,
            max: max,
            slide: function(event, ui) {
                select.find(".slider-value").html(showLabel(isRange ? ui.values : ui.value));
            },
            stop: function(event, ui) {
                changeValue(isRange, isRange ? ui.values : [ ui.value ]);
            }
        });
        select.find(".slider .ui-slider-range").css("background-color", "#ddd");
        select.find(".slider.ui-widget-content").css("box-shadow", "none");
        select.find(".slider .ui-slider-handle").css("background-color", "#337ab7");
        var dv = [];
        if (input.GloablFilterDefaultValue) {
            dv = input.GloablFilterDefaultValue.Value;
        } else if (input.DefaultValue != null && input.DefaultValue.length > 0 && settings.chartProp.info.variableId != -1) {
            dv = input.DefaultValue;
        } else {
            dv = [ min, max ];
        }
        dv = dv.map(function(d) {
            return +d.toString().replace(/\[[^\]]+\]/, "") || 0;
        });
        if (dv.length == 1) dv.splice(0, 0, 0);
        if (dv[1] < dv[0]) dv[1] = dv[0];
        select.find(".slider-value").html(showLabel(isRange ? dv : dv[0]));
        select.find(".slider-value").css({
            "font-size": settings.chartProp.info.sliderFont.fontSize,
            "font-family": settings.chartProp.info.sliderFont.fontName,
            color: settings.chartProp.info.sliderFont.color,
            "font-weight": settings.chartProp.info.sliderFont.bold ? "bold" : "normal",
            "font-style": settings.chartProp.info.sliderFont.italic ? "italic" : "normal"
        });
        if (isRange) select.find(".slider").slider("values", dv); else select.find(".slider").slider("value", dv[0]);
        $(selector).data("user-value", dv);
        function changeValue(isMulti, value) {
            if (!isMulti) value.push(settings.chartProp.info.sliderRange);
            settings.input.DefaultValue = value;
            if (!settings.editMode) {
                var data = {
                    Id: settings.chartProp.info.variableId || -1,
                    Values: value,
                    VariableType: 1
                };
                $(selector).data("user-value", value);
                ajaxCall(data);
            } else {
                $(selector).trigger("default-value", [ true, value, 1 ]);
            }
        }
    }
    function drawCombo(isMulti) {
        var style = settings.chartProp.info.comboStyle;
        if (app.mobile || settings.editMode) style = "default";
        var values = input.fields.map(function(d) {
            return d.Value.entitize();
        });
        var names = input.fields.map(function(d) {
            return d.Key.entitize();
        });
        if (names.length != values.length) {
            $("#" + settings.id).append(app.chartCommons.getError(input));
        }
        var select = '<div class="dp-container temporal inline"><select class="temporal ui fluid ' + (isMulti ? "multiple" : "") + ' search selection dropdown" ' + (isMulti ? "multiple" : "") + " >";
        select += '  <option value="">' + settings.chartProp.info.label + "</option>";
        for (var i = 0; i < names.length; i++) select += '  <option value="' + values[i] + '">' + names[i] + "</option>";
        select += "</select></div>";
        $(selector).append(select);
        if (settings.chartProp.info.showExclude) {
            var tag = '<div class="temporal ui checkbox" style="display:inline-block; width:70px;text-align: left;padding: 10px;"><input type="checkbox" id="exclude"/><label> نقیض </label></div>';
            $(selector).append(tag);
            $(selector).find(".checkbox").checkbox();
            $(selector).find(".dp-container").css({
                width: "calc(100% - 70px)"
            });
        } else {
            $(selector).find(".dp-container").css("width", "100%");
        }
        function selectValue(val) {
            var returnVal;
            if (val) {
                $(selector + " .ui.dropdown").dropdown("set selected", val);
                returnVal = val;
            } else {
                if (isMulti) {
                    var r = $(selector + " .ui.dropdown").dropdown("get item");
                    returnVal = r ? r.toArray().map(function(d) {
                        return $(d).attr("data-value");
                    }) : [];
                } else {
                    returnVal = $(selector + " .ui.dropdown").dropdown("get value");
                }
            }
            $(selector).data("user-value", returnVal);
            return returnVal;
        }
        var selectEl = $(selector).find("select");
        selectEl.on("change", function() {
            app.lang.setLang({
                selector: selector
            });
        });
        var changeCallback = null;
        var silentChange = false;
        var process = function() {
            var exclude = $(selector).find("#exclude").is(":checked");
            if (!isMulti) {
                var op = settings.chartProp.info.dateOp;
                if (exclude) {
                    var ex = {
                        eq: "nteq",
                        nteq: "eq",
                        gr: "eqls",
                        eqgr: "ls",
                        ls: "eqgr",
                        eqls: "gr"
                    };
                    op = ex[op];
                }
                input.DefaultValue.push(op);
            }
            if (exclude && isMulti) {
                input.DefaultValue.push("exclude=1");
            }
        };
        if (settings.editMode) {
            changeCallback = function(v) {
                input.DefaultValue = v;
                process();
                $(selector).trigger("default-value", [ true, input.DefaultValue, isMulti ? 0 : 4 ]);
            };
        } else {
            changeCallback = function(v) {
                if (settings.chartProp.info.disableClear && (!v || !v.length)) {
                    $(selector + " .ui.dropdown").dropdown("set selected", input.DefaultValue);
                    return;
                }
                input.DefaultValue = v;
                process();
                ajaxCall({
                    Id: settings.chartProp.info.variableId || -1,
                    Values: input.DefaultValue,
                    VariableType: isMulti ? 0 : 4
                });
            };
        }
        var dv = [];
        if (input.GloablFilterDefaultValue && settings.chartProp.info.variableId == -1) {
            dv = input.GloablFilterDefaultValue.Value;
        } else if (input.DefaultValue != null && input.DefaultValue.length > 0) {
            dv = input.DefaultValue;
        }
        if (!isMulti) {
            dv = [].concat(dv);
            dv.splice(dv.length - 1, 1);
        }
        input.DefaultValue = dv;
        var silent = true;
        var lastT;
        function getDropdownValue() {
            var value = $(selector + " .ui.dropdown").dropdown("get value");
            if (!_.isArray(value)) value = [ value ];
            value = _.filter(value, null);
            return value;
        }
        function change() {
            if (silent) return;
            clearTimeout(lastT);
            lastT = setTimeout(function() {
                var value = getDropdownValue();
                changeCallback(_.map(value, function(d) {
                    return d.deentitize();
                }));
            }, 200);
        }
        $(selector + " #exclude").on("change", function() {
            var value = getDropdownValue();
            if (!value.length) return;
            change();
        });
        $(selector + " .ui.dropdown").dropdown({
            onChange: function(value, text, $selectedItem) {
                if (!isMulti) change();
            },
            onRemove: function(removedValue, removedText, $removedChoice) {
                change();
            },
            onAdd: function(addedValue, addedText, $addedChoice) {
                change();
            },
            apiSettings: {
                url: app.urlPrefix + "api/chartdata/GetColumnMembers",
                cache: false,
                method: "post",
                beforeSend: function(s) {
                    var o = getFilters();
                    s.data = {
                        chartId: settings.chartId,
                        chartInPageId: settings.ChartInPageId,
                        userVariable: o.userVariable,
                        userControlFilter: o.userControlFilter,
                        otherFilters: o.otherFilters,
                        query: s.urlData.query,
                        chartInfo: $("#divChart").data("chartInfo")
                    };
                    return s;
                },
                onResponse: function(res) {
                    res.fields = res.fields.map(function(d) {
                        return {
                            Key: d.Key.entitize(),
                            Value: d.Value.entitize()
                        };
                    });
                    var values = $(selector + " .ui.dropdown").dropdown("get value");
                    if (!values) values = [];
                    if (!_.isArray(values)) values = [ values ];
                    res.fields = res.fields.filter(function(d) {
                        return values.indexOf(d.Value) == -1;
                    });
                    return res;
                },
                dataType: "json"
            },
            message: {
                noResults: app.lang.translate("No results found.")
            },
            fields: {
                remoteValues: "fields",
                name: "Key",
                value: "Value"
            },
            saveRemoteData: false,
            forceSelection: false
        });
        $(selector + " .ui.dropdown .dropdown.icon").on("click", function(e) {
            e.preventDefault();
            e.stopPropagation();
            $(selector + " .ui.dropdown input").focus();
        });
        $(selector + " .ui.dropdown").dropdown("set selected", dv);
        silent = false;
    }
    function getFilters() {
        var otherFilters = _.filter(app.chartCommons.drillDown.filters, function(d) {
            if (!settings.input || !settings.input.RefreshDatasource) return false;
            var refresh = settings.input.RefreshDatasource.indexOf(d.datasourceId) != -1;
            return refresh && d.chartInPageId != settings.ChartInPageId;
        });
        var userControlFilter = $.extend([], _.filter(app.chartCommons.userFilter.filters, function(d) {
            if (!settings.input || !settings.input.RefreshDatasource) return false;
            var refresh = settings.input.RefreshDatasource.indexOf(d.datasourceId) != -1;
            return refresh;
        }));
        _.remove(userControlFilter, {
            chartInPageId: settings.ChartInPageId
        });
        var userVariable = JSON.parse(localStorage.getItem("userVariable")) || [];
        return {
            otherFilters: otherFilters,
            userControlFilter: userControlFilter,
            userVariable: userVariable
        };
    }
    function drawTextbox() {
        var label = settings.chartProp.info.label == "" ? "" : '<label class="col-sm-4" style="text-align:right">' + settings.chartProp.info.label + "</label>";
        var textbox = '<div class="container-fluid" style="margin: 15px 0px 10px;"> <div class="row">            ' + label + '<div class="col-sm-' + (label == "" ? "12" : "8") + '">                <input type="text" class="form-control" placeholder="برچسب" />            </div>            </div>        </div>';
        $(selector).append(textbox);
    }
    function changeHieght(settings, requiredHeight) {
        if (typeof dashboard == "undefined") return;
        var wg = $("#" + settings.id).parent(".chart-widget") || $();
        settings.widgetSize = settings.widgetSize || {
            size_y: 3
        };
        var dif = (settings.widgetSize.size_y - (+wg.attr("data-sizey") || 3)) * dashboard.baseDimantion.y;
        requiredHeight += dif;
        var extY = 0;
        if (requiredHeight < 0) extY = Math.floor((-requiredHeight - 1) / dashboard.baseDimantion.y) + 1;
        if (!settings.editMode && extY > 0) dashboard.gs.resize_widget(wg, settings.widgetSize.size_x, +settings.widgetSize.size_y + +extY);
    }
    function ajaxCall(data) {
        var caller = app.mobileMode ? proxy.ajax : $.ajax;
        data.disableClear = settings.chartProp.info.disableClear;
        if (!settings.editMode && !isVariableRelated) {
            var filter = function(ds, dname) {
                var x = {
                    id: data.Id,
                    values: data.Values,
                    variableType: data.VariableType,
                    dimensionName: dname,
                    chartInPageId: settings.ChartInPageId,
                    datasourceId: ds,
                    disableClear: data.disableClear
                };
                app.chartCommons.userFilter.setFilter(x);
                caller({
                    url: app.urlPrefix + "api/chartdata/logUserControl",
                    type: "POST",
                    dataType: "json",
                    contentType: "application/json",
                    data: JSON.stringify(x)
                });
            };
            if (input.datasources && settings.chartProp.info.type !== "text") {
                _.each(input.datasources, function(item) {
                    filter(item.datasourceId, item.name);
                });
            } else {
                filter(input.DataSourceId, input.dimensionName);
            }
        }
        if (+data.Id == -1) {
            app.moderation.dashboadpage.refreshRelatedDatasources(input.RefreshDatasource, [ +settings.ChartInPageId ]);
            app.filterBox.refresh();
            return;
        }
        data.dimensionName = input.dimensionName;
        data.datasourceId = input.DataSourceId;
        data.chartId = input.chartId;
        var d = app.mobileMode ? data : JSON.stringify(data);
        console.log("### user control ajaxCall init *****************");
        caller({
            type: "POST",
            url: app.urlPrefix + "api/GlobalVariable/SetValueForUser",
            dataType: "json",
            contentType: "application/json;charset=utf-8",
            traditional: true,
            data: d,
            success: function(data) {
                debugger;
                if (data.result) {
                    if (typeof settings.chartProp.info.variableId != "undefined" && settings.chartProp.info.variableId != -1) {
                        $(".bar-chart").each(function() {
                            var s = $(this).data("settings");
                            if (typeof s.input.GlobalVariables != "undefined" && s.input.GlobalVariables.indexOf(settings.chartProp.info.variableId) != -1) {
                                s.titlebar.showProgress(true);
                                $(this).charts(s.type, "refreshWithData", s, {
                                    refreshRelatedDatasources: false
                                });
                            }
                        });
                    } else {
                        if (app.mobileMode) {
                            app.mobile.filterChanged(data.RefreshDatasource, [ +settings.ChartInPageId ]);
                        } else {
                            app.moderation.dashboadpage.refreshRelatedDatasources(data.RefreshDatasource, [ +settings.ChartInPageId ]);
                            app.filterBox.refresh();
                        }
                    }
                } else {
                    alert(data.Message);
                }
            },
            error: function(res) {
                if (app.mobileMode) {
                    app.mobile.showToastMessage(res);
                }
            }
        });
    }
};