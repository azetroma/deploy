/* داشبورد مدیریت صدف 
 sadafdashboard.ir 


*/
// داشبورد مدیریتی صدف info@sadafdashboard.ir 

var manageApp=angular.module("services",["ngMaterial","ngAnimate","ui.sortable","uibCollapseCat"]),ngApp=angular.module("services");ngApp.service("datasources",["$http","$mdMedia","$mdDialog",function(a,b,c){function d(){return h||(h=a.get(app.urlPrefix+"api/menus/get")),h}function e(){j={name:"همه",open:!0},k={name:"همه",open:!0}}function f(d,e){var f={type:["charts"],search:["content"],selectableDir:!1,justDir:!1,multipleChart:!0,multipleDatasource:!1};return e=angular.extend({},f,e),c.show({controller:["$scope","$mdDialog","$timeout",function(b,c,d){function f(c){return c?(b.searchProgressChart=!0,a.get(app.urlPrefix+"api/charts/getlist?q="+c).then(function(a){b.searchProgressChart=!1,n&&o?b.searchResultChart=a.data.list:n?b.searchResultChart=_.filter(a.data.list,{type:2}):b.searchResultChart=_.filter(a.data.list,{type:1})}),b.searchProgressDatasource=!0,void a.get(app.urlPrefix+"api/datasources/get?q="+c).then(function(a){b.searchProgressDatasource=!1,n&&o?b.searchResultDatasource=a.data.list:n?b.searchResultDatasource=_.filter(a.data.list,{type:2}):searchResultDatasource=_.filter(a.data.list,{type:1})})):(b.searchResultDatasource=null,void(b.searchResultChart=null))}function g(a,b){b(a),a.nodes&&(_.forEach(a.nodes,function(a){g(a,b)}),_.forEach(a.contents,function(a){g(a,b)}))}b.showCharts=-1!=e.type.indexOf("charts"),b.showDatasources=-1!=e.type.indexOf("datasources"),b.cancel=function(){c.cancel()},b.select=function(){var a,d;b.showCharts&&b.showDatasources?(a=0==b.selectedIndex?b.datasources:b.charts,d=0==b.selectedIndex?"datasources":"charts"):b.showDatasources?(a=b.datasources,d="datasources"):(a=b.charts,d="charts");var e=[];b.searchResultDatasource?(e=_.filter("charts"==d?b.searchResultChart:b.searchResultDatasource,{check:!0}),i.charts=e):(g(a,function(a){a.active&&e.push(a)}),i.charts=e),c.hide({selected:e,type:d})};var h=function(b){if(!b.nodes){var c=app.urlPrefix+"api/charts/getlist?packageId="+b.id;a.get(c).then(function(a){b.loaded=!0,b.nodes=_.filter(a.data.list,{type:1}),b.contents=_.filter(a.data.list,{type:2})})}},l=function(b){if(!b.nodes){var c=app.urlPrefix+"api/datasources/get?packageId="+b.id;a.get(c).then(function(a){b.loaded=!0,b.nodes=_.filter(a.data.list,{type:1}),b.contents=_.filter(a.data.list,{type:2})})}};b.optDatasource={urlPrefix:app.urlPrefix+"api/datasources/get?packageId=",multiple:e.multipleDatasource,selectableDir:e.selectableDir,url:l,justDir:e.justDir},b.optChart={urlPrefix:app.urlPrefix+"api/charts/getlist?packageId=",multiple:e.multipleChart,selectableDir:e.selectableDir,url:h,justDir:e.justDir},b.datasources=j,b.charts=k,g(b.datasources,function(a){a.active=!1}),g(b.charts,function(a){a.active=!1}),h(b.charts),l(b.datasources);var m;b.$watch("query",function(a,b){d.cancel(m),m=d(function(){f(a)},400)});var n=-1!=e.search.indexOf("content"),o=-1!=e.search.indexOf("dir")}],parent:angular.element(document.body),targetEvent:d,clickOutsideToClose:!0,fullscreen:b("sm")||b("xs"),template:'<md-dialog aria-label="{{\'choose\' | translate}}" >                                                                                                                                 <md-toolbar md-theme="default">                                                                                                                                                                              <div class ="md-toolbar-tools">                                                                                                                                                           <h2>{{\'choose\' | translate}}</h2>                                                                                                                                                   <span flex></span>                                                                                                                                                                    <input class ="toolbar-input" ng-model="query" placeholder="{{\'جستجو\' | translate}}" md-autofocus />                                                                                             <span class ="material-icons small" ng-click="query=null" ng-show="query" title="{{\'clear\' | translate}}">close</span>                                                              <span class ="material-icons">search</span>                                                                                                                                       </div>                                                                                                                                                                            </md-toolbar>                                                                                                                                                                         <md-dialog-content>                                                                                                                                                                       <div class ="xmd-dialog-content" flex>                                                                                                                                                    <md-tabs md-border-bottom md-dynamic-height md-selected="selectedIndex" >                                                                                                                 <md-tab label="{{ \'datasources\' | translate }}" ng-if="showDatasources">                                                                                                                                         <div layout="row" layout-align="center center" ng-show="searchProgressDatasource"style="padding:0 18px; font-size:0.8em">                                                                 <md-progress-circular  md-mode=\'indeterminate\' md-diameter="20" ></md-progress-circular>                                                                                              {{\'searching\' | translate}}                                                                                                                                                   </div>                                                                                                                                                                                <div class ="md-caption" layout-padding ng-show="searchResultDatasource && !searchResultDatasource.length">{{\'search_no_result\' | translate}}</div>                                 <tree ng-show="!searchResultDatasource" ng-model="datasources" option="optDatasource" class ="block"></tree>                                                                          <div ng-show="searchResultDatasource" layout-margin >                                                                                                                                     <div ng-repeat="i in searchResultDatasource">                                                                                                                                             <md-checkbox ng-model="i.check">{{i.name}}</md-checkbox>                                                                                                                          </div>                                                                                                                                                                            </div>                                                                                                                                                                                                                                                                                                                                                                  </md-tab>                                                                                                                                                                                                                                                                                                                                                                   <md-tab label="{{ \'charts\' | translate }}" ng-if="showCharts">                                                                                                                                                <div layout="row" layout-align="center center" ng-show="searchProgressChart"style="padding:0 18px; font-size:0.8em">                                                                      <md-progress-circular  md-mode=\'indeterminate\' md-diameter="20" ></md-progress-circular>                                                                                             {{\'searching\' | translate}}                                                                                                                                                    </div>                                                                                                                                                                                <div class ="md-caption" layout-padding ng-show="searchResultChart && !searchResultChart.length">{{\'search_no_result\' | translate}}</div>                                           <tree ng-show="!searchResultChart" ng-model="charts" option="optChart" class ="block"></tree>                                                                                         <div ng-show="searchResultChart" layout-margin >                                                                                                                                          <div ng-repeat="i in searchResultChart">                                                                                                                                                  <md-checkbox ng-model="i.check">{{i.name}}</md-checkbox>                                                                                                                          </div>                                                                                                                                                                            </div>                                                                                                                                                                            </md-tab>                                                                                                                                                                         </md-tabs>                                                                                                                                                                        </div>                                                                                                                                                                            </md-dialog-content>                                                                                                                                                                  <md-dialog-actions layout="row">                                                                                                                                                          <md-button ng-click="select()">                                                                                                                                                           {{\'choose\' | translate}}                                                                                                                                                        </md-button>                                                                                                                                                                          <md-button ng-click="cancel()">                                                                                                                                                           {{\'cancel\' | translate}}                                                                                                                                                        </md-button>                                                                                                                                                                      </md-dialog-actions>                                                                                                                                                          </md-dialog>'})}function g(b){var c=app.urlPrefix+"Moderation/OlapChartDesign/CubeInformation?DataSourceId="+b;return a.get(c).then(function(a){return a.data})}var h,i={},j={name:"همه",open:!0},k={name:"همه",open:!0};return{get:d,select:f,lastSelected:i,reset:e,getColumns:g}}]),ngApp.service("chartComments",["$http",function(a){function b(b,c){return a.post(app.urlPrefix+"api/ChartComments/save/"+b,c).then(function(a){return a.data})}return{save:b}}]);
// داشبورد مدیریتی صدف info@sadafdashboard.ir 

var cal=angular.module("calendar",[]);cal.directive("sadafCalendar",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel"},template:'<div><input type="text" id=""  class="form-control from" placeholder="تاریخ" /><input id="from-value" type="hidden"/></div>',link:function(a,b,c){b.find(" .from").datepicker({changeMonth:!0,changeYear:!0,dateFormat:"yy/mm/dd",altFormat:"yy/mm/dd",altField:b.find("#from-value"),onClose:function(b){a.model=b,a.$apply()}}),a.$watch("model",function(c){null==c&&b.find(".from").datepicker("setDate",a.model)}),b.find(".from").datepicker("setDate",a.model)}}});var ngApp=angular.module("sadafForms",["ng-sortable","services","calendar","semantic-ui","ngRoute","ui.sortable","pascalprecht.translate","ngSanitize","uibCollapseCat"]);ngApp.config(["$translateProvider",function(a){a.useStaticFilesLoader({prefix:app.urlPrefix+"dist/locales/locale-",suffix:".js"}),a.preferredLanguage("fa"),a.useSanitizeValueStrategy("sanitizeParameters")}]),ngApp.config(["$routeProvider","$locationProvider",function(a,b){a.when("/forms/list",{templateUrl:app.urlPrefix+"dist/partial/forms/editor/form-generator-list.html?v="+app.version,controller:"fromsCtrl",controllerAs:"c"}).when("/forms/:id?",{templateUrl:app.urlPrefix+"dist/partial/forms/editor/form-generator-editor.html?v="+app.version,controller:"fromGeneratorCtrl",controllerAs:"c"}).otherwise({redirectTo:"datasources"})}]);var ngApp=angular.module("sadafForms");ngApp.directive("sadafForm",function(){return{scope:{id:"@",rowId:"@?",onCancel:"&?",onFinish:"&?"},controller:["$scope","$http","$sce","$routeParams","$timeout","$q","formsService","formsSubmitService","$attrs",function($scope,$http,$sce,$routeParams,$timeout,$q,formsService,formsSubmitService,$attrs){function getFormData(){c.clearForm(),c.rowId&&0!=+c.id&&(c.formLoading=!0,formsSubmitService.get(c.id,c.rowId).then(function(a){function b(a,c){_.each(a,function(a){c(a),13==a.type&&_.each(a.multiRowForm.rows,function(a){b(a,c)})})}c.formLoading=!1,_.each(a.model.pages,function(a){b(a.controls,function(a){12==a.type,2==a.type&&(a.value=+a.value)})}),c.data=a.model,c.editPermission=a.editPermission,c.deletePermission=a.deletePermission,c.allControl=[],runOnAllControll(c.data,function(a){c.allControl.push(a)})},function(){c.formLoading=!1}))}function getFormEmptyData(){c.clearForm(),c.formLoading=!0,formsService.get(c.id).then(function(a){c.formLoading=!1,c.data=a.model,c.editPermission=a.editPermission,c.deletePermission=a.deletePermission,c.allControl=[],runOnAllControll(c.data,function(a){c.allControl.push(a)})},function(){c.formLoading=!1})}function clearIfFilterHasControl(a,b){if(b.useFilter&&b.filters&&b.filters.length){var c=_.some(b.filters,{control:a,type:2});c&&(b.value=null)}}function findControl(a,b){var c=null;return runOnAllControll(b,function(b){return b.name===a?(c=b,!1):void 0}),c}function runOnAllControll(a,b,c){if(a){var d=[];_.each(a.pages,function(a){c&&c(a),a&&_.isArray(a.controls)&&(d=d.concat(a.controls))}),_.each(d,function(a){13==a.type&&_.each(a.multiRowForm.rows,function(a){_.each(a,function(c){var d=b(c,a);return d===!1?!1:void 0})});var c=b(a,d);return c===!1?!1:void 0})}}function GetMultiRowControlBaseOnChildName(a){var b;return runOnAllControll(c.data,function(c){if(13==c.type){var d=_.findIndex(c.multiRowForm.rows[0],{name:a});-1!=d&&(b={control:c,index:d})}}),b}function calcFlatFormula(f,rowControls){var params=[],r=f.replace(/\[(field-\d+)\]/gi,function(a,b,c){var d=_.find(rowControls,{name:b});if(8==d.type){var e="00:00";d.value&&(e=d.value.substring(0,5)),params.push({type:"millisecond",value:moment.duration(e).asMilliseconds()})}if(9==d.type){var e="1300/0/01";d.value&&(e=d.value),params.push({type:"millisecond",value:1e3*moment(e,"jYYYY/jMM/jDD").utc().unix()})}return(2==d.type||5==d.type&&"digit"==d.calcType||16==d.type&&"digit"==d.calcType)&&params.push({type:"digit",value:+d.value||0}),(5==d.type&&"millisecond"==d.calcType||16==d.type&&"millisecond"==d.calcType)&&params.push({type:"millisecond",value:d.calculate.calculatedValue}),"{"+(params.length-1)+"}"}),newR=r.replace(/\{(\d+)\}/gi,function(a,b,c){return" "+params[+b].value+" "}),haveDate=_.filter(params,function(a){return"millisecond"==a.type||"millisecond"==a.type||"millisecond"==a.type}).length>0,haveDigit=_.some(params,{type:"digit"});if(haveDate){var v=moment.duration(+eval(newR)).format("d روز و h ساعت و m دقیقه");return{value:v,calculatedValue:+eval(newR),type:"millisecond"}}var v=+eval(newR);return{value:v,calculatedValue:+eval(newR),type:"digit"}}function updateCalculated(newVal,oldVal){var filteredBaseOnField=[];runOnAllControll(c.data,function(a){a.useFilter&&_.each(a.filters,function(b){2==b.type&&b.control&&filteredBaseOnField.push({name:a.name,source:a,filter:b.control})})}),runOnAllControll(c.data,function(control,rowControls){if(5==control.type){var o=calcFlatFormula(control.calculate.expression,rowControls);control.value=o.value,control.formula=o.formula,control.calcType=o.type,control.calculate.calculatedValue=o.calculatedValue}if(16==control.type){var regex=/\s*(sum|avg|var)\s*\(([^\)]+)\)\s*/gi,hasDurationFormat=!1,r=control.calculate.expression.replace(regex,function(a,b,c){var d=[],e=c.replace(/.*\[(field-\d+)\].*/gi,"$1"),f=GetMultiRowControlBaseOnChildName(e);if(!f)return"از فیلدهای مربوط به فرم چند ردیفه باید استفاده شود";_.each(f.control.multiRowForm.rows,function(a){var b=calcFlatFormula(c,a);"digit"!=b.type?(hasDurationFormat=!0,d.push(b.calculatedValue||0)):d.push(b.value||0)});var g=0;return"sum"===b&&(g=d3.sum(d)),"avg"===b&&(g=d3.mean(d)),"var"===b&&(g=d3.variance(d))," "+g+" "});if(hasDurationFormat){var v=moment.duration(+eval(r)).format("d روز و h ساعت و m دقیقه");control.value=v,control.calculate.calculatedValue=+eval(r),control.calcType="millisecond"}else try{control.value=+eval(r).toFixed(5),control.calculate.calculatedValue=+eval(r)}catch(e){control.value=r}}if(control.useFilter&&control.filters&&control.filters.length){var controlValue=null;_.map(control.filters,function(a){if(2==a.type){var b=_.find(rowControls,{name:a.control});a.controlValue=b.value}})}})}var c=this,id=c.id;c.submittedStatus=0,c.isValid=function(){var a=!1;if(c.data&&c.data.pages)a:for(var b=0;b<c.data.pages.length;b++)for(var d=0;d<c.data.pages[b].controls.length;d++){var e=c.data.pages[b].controls[d];if(12==e.type&&!e.isValid){a=!0;break a}}return a},c.submit=function(){c.loading=!0,c.clearAllErrors(),formsSubmitService.submit(c.id,c.data).then(function(a){c.loading=!1,c.submittedStatus=1,!a.result&&a.messages&&(c.pagesContainError=c.pagesContainError||[],c.submittedStatus=0,_.each(c.data.pages,function(b){_.each(a.messages,function(a){var d=_.find(b.controls,{name:a.name});d&&(d.error=a.error,-1==_.findIndex(c.pagesContainError,b)&&c.pagesContainError.push(b))})})),!a.result&&a.pageMessages&&(c.submittedStatus=0,_.each(a.pageMessages,function(a){var b=_.find(c.data.pages,{name:a.name});b&&(b.error=a.error)})),a.result&&(c.onFinish&&c.onFinish(),c.clearForm())},function(a){a.data.title&&a.data.desc?c.error={title:a.data.title,desc:a.data.desc}:c.error=null,c.loading=!1,c.submittedStatus=2})},c.clearAllErrors=function(){c.pagesContainError=[],runOnAllControll(c.data,function(a){a.error=null},function(a){a.error=null})},c.clearForm=function(){c.submittedStatus=0,c.activePage=0,runOnAllControll(c.data,function(a){a.value=null,a.dropdown&&(a.dropdown.listValue=null),13==a.type&&a.multiRowForm.rows.splice(0,a.multiRowForm.rows.length-1)})};var timer,observe=function(a){$timeout.cancel(timer),timer=$timeout(function(){0!=+c.id&&(c.allControl=null,c.rowId?getFormData():getFormEmptyData())},100)};$attrs.$observe("rowId",observe),$attrs.$observe("id",observe),c.cancel=function(){c.onCancel()},c.remove=function(){var a=confirm("آیا برای حذف اطلاعات جاری فرم اطمینان دارید؟");a&&formsSubmitService.remove(c.id,c.rowId).then(function(){c.onCancel()},function(a){a.data.title&&a.data.desc&&alert(a.data.desc)})},$scope.$watch(angular.bind(this,function(){return this.allControl}),function(a,b){a&&b&&_.each(a,function(a){var d=_.find(b,{name:a.name});a.value!=d.value&&12==a.type&&_.each(c.allControl,function(b){a.name!=b.name&&clearIfFilterHasControl(a.name,b)})})},!0),$scope.$watch(angular.bind(this,function(){return this.data}),function(a,b){updateCalculated(a,b)},!0)}],restrict:"AE",controllerAs:"c",bindToController:!0,templateUrl:app.urlPrefix+"dist/partial/forms/form-render.html?v="+app.version}}),ngApp.service("formsSubmitService",["$http","updateModel",function(a,b){var c=function(c,d){return a.get(app.urlPrefix+"api/formsSubmit/getData/"+c+"?rowId="+d).then(function(a){var c=a.data;return b.updateValuesForGet(c.model.pages),c})},d=function(c,d){return b.updateValuesForSave(d.pages),a.post(app.urlPrefix+"api/formssubmit/submit/"+c,d).then(function(a){return app.moderation.dashboadpage.refreshRelatedDatasources(a.data.RefreshDatasource),a.data})},e=function(b,c){return a.post(app.urlPrefix+"api/formssubmit/delete/"+b,c).then(function(a){return app.moderation.dashboadpage.refreshRelatedDatasources(a.data.RefreshDatasource),a.data})};return{submit:d,remove:e,get:c}}]),ngApp.directive("selectForm",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{onSelect:"&",settings:"=?"},controller:["$scope","$http","formsService",function(a,b,c){a.model=a.model||[],a.settings=a.settings||{},c.get().then(function(b){a.forms=b}),a.opt={closable:!1,onApprove:function(){return a.model&&a.model.length?(a.onSelect({forms:a.model,settings:a.settings}),!1):(alert("حداقل یک مورد باید انتخاب شود"),!1)}}}],template:'<div>                   <sm-modal visible="settings.visible" settings="opt">                        <div class="header">انتخاب فرم</div>                        <div class="content">                            <p>لطفا فرم‌های مورد نظر خود را انتخاب کنید</p>                            <div class="ui form">                                <div class="field">                                    <label>انتخاب فرم</label>                                    <sm-dropdown class="selection search multiple"  settings="{fullTextSearch: true}" model="model" items="forms" label="item.name" value="item" ></sm-dropdown>                                </div>                            </div>                        </div>                        <div class="actions">                            <div class="ui black deny button">لغو</div>                            <div class="ui positive button" ng-class="{loading: settings.loaging}" >اضافه کردن</div>                        </div>                    </sm-modal>                    </div>',link:function(a,b,c){}}}),function(){function a(a,b){b.show({template:'<md-toast class="md-toast error"> <span class="md-toast-text" flex>'+a+"</span></md-toast>",hideDelay:3e3,position:"bottom left"})}function b(a,b,c){var d=[];_.each(a,function(a){c&&c(a),a&&_.isArray(a.controls)&&(d=d.concat(a.controls))}),_.each(d,function(a){13==a.type&&a.multiRowForm&&_.each(a.multiRowForm.rows,function(a){_.each(a,function(c){b(c,a)})}),b(a,d)})}var c=angular.module("sadafForms");c.controller("fromGeneratorCtrl",["$scope","$http","$sce","$timeout","$mdToast","$routeParams","formsService","controlPropertyService",function(c,d,e,f,g,h,i,j){c.saveProgress=!1;var k=this;k.id=h.id||0;var l=k.id>0;k.app=app,k.items=[{columnClass:"three",key:"متن کوتاه",label:"نام",icon:"text cursor",type:0,showUniqueProp:!0,"default":!0,require:!0,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{columnClass:"three",key:"متن بلند",label:"متن بلند",icon:"text cursor",type:1,showUniqueProp:!0,"default":!0,require:!0,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{columnClass:"three",key:"عدد",label:"عدد",icon:"hashtag",type:2,showUniqueProp:!0,"default":!0,require:!0,format:"#,#",accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{columnClass:"three",key:"برچسب",label:"برچسب",icon:"font",type:3,showUniqueProp:!1,"default":!1,require:!1,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{columnClass:"three",key:"چند گزینه",icon:"caret down",label:"چند گزینه",type:4,showUniqueProp:!0,"default":!0,require:!0,dropdown:{useRemoteData:!1},accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{columnClass:"three",key:"چند گزینه ریموت",icon:"caret down",label:"چند گزینه ریموت",type:4,showUniqueProp:!0,"default":!0,require:!0,accessControlEdit:!1,accessControlView:!1,dropdown:{useRemoteData:!0},accessControlEditRoles:[],accessControlViewRoles:[]},{columnClass:"three",key:"تایید",icon:"checkmark box",type:6,label:"انتخاب مقدار",showUniqueProp:!1,"default":!0,require:!1,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{columnClass:"three",key:"زمان",icon:"wait",label:"زمان",type:8,showUniqueProp:!0,"default":!0,require:!0,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{columnClass:"three",key:"تاریخ",label:"تاریخ",icon:"calendar",type:9,showUniqueProp:!0,"default":!0,require:!0,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{columnClass:"three",key:"ارجاع به فرم",label:"ارجاع به فرم",icon:"pointing right",type:12,formLookup:{form:-1,keyControls:[]},showUniqueProp:!0,"default":!0,require:!0,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{columnClass:"twelve",key:"گروه تکرار شونده",label:"لیست",icon:"table",type:13,showUniqueProp:!1,"default":!1,require:!1,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[],multiRowForm:{addKeyText:"ردیف جدید",rows:[[]],controlSize:"mini"}},{columnClass:"three",key:"کلید",label:"کلید",icon:"square",type:15,showUniqueProp:!1,"default":!1,require:!1,button:{type:1,openLinkType:0,colorClass:"black",size:"tiny"},accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{columnClass:"three",key:"محاسباتی",icon:"calculator",label:"فیلد محاسباتی",type:5,showUniqueProp:!1,"default":!1,require:!1,format:"#,#",calculate:{expression:""},accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{columnClass:"three",key:"محاسباتی - جمع",label:"محاسباتی - جمع",icon:"calculator",type:16,showUniqueProp:!1,"default":!1,require:!1,format:"#,#",calculate:{expression:"",func:"sum"},accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]}],k.controlProperty=function(a){return a?_.find(k.items,{type:a.type}):{showUniqueProp:!1,"default":!1,require:!1}},k.sortableOptions={"ui-floating":!0},k.compConf={sort:!1,group:{name:"form",pull:"clone",put:!1},animation:150,onEnd:function(a){a.model.name=k.pages.naming.getName(),a.model.canView=!0,a.model.canEdit=!0}},k.drags=k.items.map(function(a){return[a]});var m=!1;k.draggableOptions={connectWith:".drop-target",placeholder:"form-control-highlight",helper:"clone",stop:function(a,b){if(b.item.sortable.source.hasClass("draggable-element")&&b.item.sortable.droptarget&&b.item.sortable.droptarget!=b.item.sortable.source&&b.item.sortable.droptarget.hasClass("drop-target")){var c=b.item.sortable.droptargetModel[b.item.sortable.dropindex];c.name=k.pages.naming.getName(),c.columnClass=c.columnClass||"twelve",c.formLookup=_.extend({},b.item.sortable.model.formLookup),c.dropdown=_.extend({},b.item.sortable.model.dropdown),c.canView=!0,c.canEdit=!0;var d=JSON.parse(JSON.stringify(b.item.sortable.model));b.item.sortable.sourceModel.push(d)}}},k.control=j.get(),k.formLookupSourceFields=[],console.log("niit c.formLookupSourceFields",k.formLookupSourceFields),c.$watch("c.control.active.formLookup",function(a){a&&a.form&&i.get(a.form).then(function(a){for(;k.formLookupSourceFields.length;)k.formLookupSourceFields.splice(0,k.formLookupSourceFields.length);_.each(a.model.pages,function(a){_.each(a.controls,function(a){k.formLookupSourceFields.push(a)})}),console.log("change c.formLookupSourceFields",k.formLookupSourceFields)})}),k.pages={data:[],add:function(a){var b={name:"صفحه "+(k.pages.data.length+1),type:0,controls:[],rowValidation:{uniqueMultiField:!1,uniques:[]},size:"tiny"};k.pages.data.push(b),k.pages.setActive(b)},removeControl:function(a,b){var c=confirm("در صورت پاک کردن این کنترل تمامی داده‌هایی که قبلا در فرم برای این کنترل ذخیره شده است نیز پاک خواهد شد. آیا برای حذف این کنترل اطمینان دارید؟");c&&(m=!0,k.pages.activePage.controls.splice(a,1))},copy:function(a,b){m=!0;var c=_.extend({},b);k.pages.activePage.controls.splice(a,0,c)},remove:function(a){if(k.pages){var b=!0;if(k.pages.data[a].controls.length&&(b=confirm(" در صورت پاک کردن صفحه تمام کنترل‌های موجود در آن به همراه داده‌هایی که قبلا در فرم ذخیره شده است پاک خواهد شد. آیا برای حذف این صفحه اطمینان دارید؟")),b){k.pages.data[a].controls.length&&(m=!0);var c=k.pages.data.splice(a,1);c[0]===k.pages.activePage&&k.pages.setActive()}}},setActive:function(a){_.each(k.pages.data,function(a){a.active=!1}),!a&&k.pages.data.length&&(a=k.pages.data[0]),k.pages.activePage=a,k.pages.activePage.active=!0,k.control.active&&(k.control.active.isActive=!1,k.control.active=null)},getControlForRowValidation:function(){var a=k.pages.activePage.controls;return a},naming:{getName:function(){return"field-"+k.pages.naming.getMaxId()},exist:function(a){if("_id"==a)return!0;var b=!1;return _.each(k.pages.data,function(c){_.each(c.controls,function(c){var d=c.name||"";return d==a?(b=!0,!1):void 0})}),b},getMaxId:function(){return k.maxFieldNumber=+k.maxFieldNumber||0,k.maxFieldNumber++,k.maxFieldNumber}}},k.controlList=[],c.$watch("c.pages",function(){k.controlList=[],b(k.pages.data,function(a){13!=a.type&&k.controlList.push(a)})},!0),k.saveProgress=!1,k.save=function(){var b=!1;b=m?confirm("در صورت ذخیره به دلیل اینکه تغییراتی در فرم ایجاد شده است در صورت حذف یک کنترل داده‌های مربوط به آن نیز حذف می‌شود. آیا برای ذخیره اطمینان دارید؟‌"):!0,b&&(m=!1,k.saveProgress=!0,i.save(k.id,{pages:k.pages.data,name:k.name,maxFieldNumber:k.maxFieldNumber}).then(function(a){k.saveProgress=!1,k.id=a,location.replace(app.hashUrlPrefix+"#/forms/"+a);var b=g.simple().textContent("فرم شما با موفقیت ذخیره شد");g.show(b)},function(b){k.saveProgress=!1;var c="مشکلی در روند ذخیره‌سازی به وجود آمده است";b.data.desc&&(c=b.data.desc),a(c,g)}))},l||(k.name="فرم جدید",k.pages.add()),l&&i.get(k.id,!0).then(function(a){k.pages.data=a.model.pages,k.name=a.model.name,k.maxFieldNumber=a.model.maxFieldNumber,k.pages.setActive(),_.each(k.pages.data,function(a){_.each(a.controls,function(a){a.dropdown&&a.dropdown.items&&(a.dropdown.itemsTemp=a.dropdown.items.map(function(a){return a.label}).join("\n"))})})}),k.getSiblingControl=function(a){var c={};return b(k.pages.data,function(b,d){a===b.name&&(c.row=d,c.index=_.findIndex(d,{name:a}))}),c},c.$watch("c.control.active",function(a){a&&a.name&&(k.activeSibling=k.getSiblingControl(a.name))})}]),c.directive("formControl",["$compile",function(a){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",settingsClick:"&?",remove:"&?",id:"@",edit:"@",settings:"=?",copy:"&?"},controller:["$scope","$translate","$timeout",function(a,b,c){a.dropdownSettings={apiSettings:{url:app.urlPrefix+"api/forms/getdropdowndata",cache:!1,method:"get",dataType:"json",beforeSend:function(b){return b.data={id:a.id,name:a.model.name,query:b.urlData.query},a.edit&&(b.data={datasourceId:a.model.dropdown.remoteDatasource.value,remoteColumnKey:a.model.dropdown.remoteColumnKey,remoteColumnLabel:a.model.dropdown.remoteColumnLabel,query:b.urlData.query}),b},onResponse:function(a){return a.fields=a.fields.map(function(a){return{value:a.value.entitize(),label:a.label.entitize()}}),a}},message:{noResults:app.lang.translate("No results found.")},fields:{remoteValues:"fields",name:"label",value:"value"},saveRemoteData:!1,fullTextSearch:!0},a.onAdd=function(b){c(function(){a.model.dropdown.listValue=a.model.dropdown.listValue||[],-1==a.model.dropdown.listValue.indexOf(b)&&a.model.dropdown.listValue.push(b)},0)},a.onRemove=function(b){c(function(){a.model.dropdown.listValue=a.model.dropdown.listValue||[];var c=a.model.dropdown.listValue.indexOf(b);-1!=c&&a.model.dropdown.listValue.splice(c,1)},0)},a.change=function(b){c(function(){a.model.dropdown.multiSelectDropdown||(a.model.value=b)},0)},a.randomId=Math.floor(1e5*Math.random())+1,a.model.randomId=a.randomId,a.$watch("model.value",function(b){null==b&&$(".form-"+a.randomId+" .dropdown").dropdown("clear")}),a.simpleDropdownsettings={message:{noResults:app.lang.translate("No results found.")},fullTextSearch:!0,forceSelection:!1},a.$watch("model.dropdown.listValue",function(b){null==b&&$(".form-"+a.randomId+" .dropdown").dropdown("clear")}),a.model.dropdown&&a.model.dropdown.multiSelectDropdown&&a.model.dropdown.useRemoteData&&(a.model.items=a.model.dropdown.listValue),a.initDropdown=function(b){a.model.dropdown&&a.model.dropdown.multiSelectDropdown&&a.model.dropdown.useRemoteData&&c(function(){$(b).dropdown("set selected",a.model.dropdown.listValue)},100)},a.buttonClick=function(){if(!a.edit&&(1==a.model.button.type&&(a.model.button.showModal=!0),0==a.model.button.type)){if(!+a.model.button.dashboardId)return;var b=0==+a.model.button.openLinkType?"_blank":"_self";window.open(app.urlPrefix+"#/dashboard/"+a.model.button.dashboardId,b)}},a.getFilteredDropdonItems=function(b,c,d){if(!a.model.useFilter||!a.model.filters)return!1;var e=!1;return _.each(a.model.filters,function(a){return a&&a.staticValue&&b&&b.value?1==a.type?(e=-1!=a.staticValue.trim().indexOf(b.value.trim())||-1!=b.value.trim().indexOf(a.staticValue.trim()),!1):void 0:!1}),e}}],templateUrl:app.urlPrefix+"dist/partial/forms/editor/form-generator-control.directive.html?v="+app.version}}]),c.directive("multiRowForm",["$compile",function(a){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",settings:"=?",id:"@",edit:"@"},controller:["$scope","$http","formsService","controlPropertyService","$timeout",function(a,b,c,d,e){a.model=a.model||{},a.firstRow=a.model.multiRowForm.rows[0],a.$watch("firstRow",function(){_.each(a.firstRow,function(a){a.childOfMultiRow=!0})},!0),a.sortableOptions={placeholder:"form-control-highlight",handle:".drag-handle"},a.control=d.get(),a.setProp=function(b){a.control.setActive(b)},a.remove=function(b,c){var d=confirm("در صورت پاک کردن این کنترل تمامی داده‌هایی که قبلا در فرم برای این کنترل ذخیره شده است نیز پاک خواهد شد. آیا برای حذف این کنترل اطمینان دارید؟");d&&a.model.multiRowForm.rows[0].splice(c,1)},a.addRow=function(){if(!a.edit){var b=[];_.each(a.model.multiRowForm.rows[0],function(a){var c=JSON.parse(JSON.stringify(a));b.push(c)}),a.model.multiRowForm.rows.push(b),_.each(b,function(a){a.rowId=0,a.value=null,a.dropdown&&(a.dropdown.listValue=null)}),setTimeout(function(){$(".edit-form-modal").modal("refresh")},100)}},a.removeRow=function(b,c){var d=b.splice(c,1);a.model.multiRowForm.deletedIds=a.model.multiRowForm.deletedIds||[],a.model.multiRowForm.deletedIds.push(d[0][0].rowId)}}],template:' <div class="ui form field" ng-class="model.multiRowForm.controlSize">                        <div class="ui secondary pointing tiny menu">                            <div class="active item">{{model.label}}</div>                            <div class="ui right item" طng-show="!edit">                                <div class="pointer" ng-click="addRow()">{{model.multiRowForm.addKeyText}}<i class="icon plus square outline large"></i></div>                            </div>                        </div>                            <div ng-hide="model.multiRowForm.rows[0].length" class="gray center aligned twelve wide column"><small>یک کنترل را به اینجا بکشید</small></div>                        <div class="ui grid content-form " >                        </div>                    </div>',link:function(b,c,d){function e(){b.model.multiRowForm.columns=b.model.multiRowForm.columns||3;var a=1==b.model.multiRowForm.columns?"one":2==b.model.multiRowForm.columns?"two":3==b.model.multiRowForm.columns?"three":4==b.model.multiRowForm.columns?"four":5==b.model.multiRowForm.columns?"five":6==b.model.multiRowForm.columns?"six":"eight";return a}function f(){var d;d=b.edit?angular.element('<div class="drop-target doubling '+e()+' column row {{model.multiRowForm.separator? \'separator\':\'\'}}" xui-sortable="sortableOptions"  xng-model="model.multiRowForm.rows[0]"                                                         ng-sortable="{group: {name: \'form\', pull:true, put:true}, animation:150}" style="min-height:100px;">                                                                                                        <div class="column"                                                              ng-repeat="component in model.multiRowForm.rows[0] track by $index"                                                             ng-click="setProp(component);$event.stopPropagation();">                                                                <form-control ng-class="{active: component.isActive}" class="column" remove="remove(component, $index)" edit="true" ng-model="component" id="{{id}}" settings="{fromMultiRow:true}"></form-control>                                                    </div>                                                </div>'):angular.element('<div ng-repeat="row in model.multiRowForm.rows" class="doubling '+e()+' column row no-padding {{model.multiRowForm.separator? \'separator\':\'\'}}">                                                    <div class="column no-padding"                                                          ng-repeat="component in row track by $index">                                                            <div class="ui grid" ng-if="!edit && model.multiRowForm.rows.length > 1 && $last" style="margin:0;">                                                                <form-control class="ten wide column field" remove="remove(component, $index)" ng-model="component" id="{{id}}"  settings="{showLabel:$parent.$parent.$index == 0, fromMultiRow:true}"></form-control>                                                                <div class="two wide column field" >                                                                    <label ng-show="$parent.$parent.$index == 0">&nbsp;</label>                                                                    <div class="ui icon mini xbutton pointer gray" ng-click="removeRow(model.multiRowForm.rows, $parent.$parent.$index)"><i class="icon remove"></i></div>                                                                </div>                                                            </div>                                                            <form-control ng-if="edit || model.multiRowForm.rows.length == 1 || !$last" class="column" remove="remove(component, $index)" ng-model="component" id="{{id}}" settings="{showLabel:$parent.$parent.$index == 0, fromMultiRow:true}"></form-control>                                                    </div>                                                </div>'),a(d)(b),angular.element(c[0].querySelector(".content-form")).html(d)}b.$watch("model.multiRowForm.columns",function(a,b){f()})}}}]),c.directive("newFormModal",["$compile",function(a){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",show:"=?"},template:' <div >                          <div class="xcontent" >                        </div>                    </div>',link:function(b,c,d){function e(){var d=angular.element('<sm-modal visible="model.showModal" settings="{closable: true}" xng-if="model.type==1">                                                <div class="content">                                                    <div sadaf-form id="{{model.formInfo.form}}" on-finish="hideModal()"></div>                                                </div>                                            </sm-modal>');a(d)(b),angular.element(c[0].querySelector(".xcontent")).html(d)}b.hideModal=function(){b.model.showModal=!1},e()}}}]),c.directive("formLookupProperty",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",settings:"=?"},controller:["$scope","$http","formsService",function(a,b,c){a.model=a.model||{},a.settings=angular.merge({selectableColumns:!0},a.settings||{}),c.get().then(function(b){a.forms=b}),a.$watch("model.form",function(b){-1==b&&(a.model.form=a.forms[0].id),b&&c.get(b).then(function(b){a.formControls=[],_.each(b.model.pages,function(b){_.each(b.controls,function(b){a.formControls.push(b)})})})})}],template:' <div class="field">                        <div class="field">                            <label>انتخاب فرم</label>                            <sm-dropdown class="selection search fluid"  settings="{fullTextSearch: true, forceSelection: false}" model="model.form" items="forms" label="item.name" value="item.id" ></sm-dropdown>                        </div>                        <div class="field" ng-show=settings.selectableColumns>                            <label>انتخاب ستون‌های کلیدی</label>                            <sm-dropdown class="selection search multiple fluid" settings="{fullTextSearch: true, forceSelection: false}" model="model.keyControls" items="formControls" label="item.label" value="item.name" ></sm-dropdown>                        </div>                    </div>',link:function(a,b,c){}}}),c.directive("formLookupGetId",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",id:"@"},controller:["$scope","$http","formsService","$timeout",function(a,b,c,d){function e(){a.model.formLookup.keyControls=a.model.formLookup.keyControls||[],a.keys=a.model.formLookup.keyControls.map(function(b){var c={name:b,dropdownSettings:j(b),change:function(a){c.value!==a&&(c.value=a,i())},defaultText:a.model.label};return c})}function f(){if(a.model.formLookup.keyControlsBindedValue&&a.keys)for(var b=0;b<a.model.formLookup.keyControlsBindedValue.length;b++){var c=a.model.formLookup.keyControlsBindedValue[b];null!=a.model.value&&(a.keys[b].defaultText=c,a.keys[b].boldText=!0)}}function g(){a.model.useFilter&&a.model.filters.length&&_.map(a.model.filters,function(a){})}function h(){$(".form-"+a.model.randomId+" .dropdown").dropdown("clear")}function i(){var c=a.keys.map(function(a){return{label:a.name,value:a.value}}),d=_.some(c,function(a){return _.isUndefined(a.value)||null==a.value});d||(a.model.isValid=!1,b.post(app.urlPrefix+"api/forms/getFormLookupIds/"+a.model.formLookup.form,c).then(function(b){a.model.isValid=!0,_.isArray(b.data)&&b.data.length&&(a.model.value=b.data[0])}))}a.model.formLookup=a.model.formLookup||{};var j=function(b){return{apiSettings:{url:app.urlPrefix+"api/forms/getFormColumnData",cache:!1,method:"get",dataType:"json",beforeSend:function(c){return c.data={id:a.model.formLookup.form,name:b,query:c.urlData.query,others:a.keys.map(function(a){return{label:a.name,value:a.value}}),filters:a.model.useFilter?a.model.filters:[]},c},onResponse:function(a){return a.fields=a.fields.map(function(a){return{value:a.value.entitize(),label:a.label.entitize()}}),a}},message:{noResults:app.lang.translate("No results found.")},fields:{remoteValues:"fields",name:"label",value:"value"},saveRemoteData:!1,fullTextSearch:!0,forceSelection:!1}};a.$watch("model.formLookup.keyControlsBindedValue",function(a){f()},!0),a.$watch("model.filters",function(a){g()},!0),a.$watch("model.formLookup.keyControls",function(a){e(),f()},!0);var k=!1,l=!1;a.$watch("model.value",function(b){a.model;null==b&&(l=!0,h())}),a.init=function(a){k=!0,l&&h()},a.model.isValid=!0}],template:' <div class="">                        <div class="field" ng-repeat="f in keys">                            <sm-dropdown settings="f.dropdownSettings" on-init="init"ng-class="{\'bold-text\':f.boldText}" class="selection search {{f.name}} fluid" label="item.label" on-change="f.change" value="item.value" default-text="f.defaultText" ></sm-dropdown>                        </div>                    </div>'
}}),c.directive("selectMenu",function(){return{restrict:"E",replace:!0,transclude:!1,scope:{model:"=ngModel",multiple:"@?"},controller:["$scope","$http","$timeout",function(a,b,c){b.get(app.urlPrefix+"api/menus/get").then(function(b){a.menus=b.data})}],template:'<div><sm-dropdown items="menus" model="model" class="selection search fluid {{multiple}}" settings="{forceSelection: false}" label="item.name" value="item.id" ></sm-dropdown></div>'}}),c.directive("selectDatasourceColumns",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel"},controller:["$scope","$http","datasources",function(a,b,c){function d(){c.getColumns(a.model.remoteDatasource.value).then(function(b){a.datasourceColumns=b.CubeInfo.Dimensions[0].Hierarchies,a.userProperties=b.UsersProperty})}a.select=function(){c.select(null,{type:["datasources"]}).then(function(b){b.selected&&b.selected.length&&(a.model.remoteDatasource={value:b.selected[0].id,label:b.selected[0].name},d(),a.model.remoteColumnKey=null,a.model.remoteColumnLabel=null)})},a.model=a.model||{},a.model.remoteDatasource&&d()}],template:' <div class="ui form">                        <div class="field">                            <label>انتخاب منبع داده</label>                            <button class="ui tiny button" ng-click="select()">                                <span ng-show="!model.remoteDatasource">انتخاب</span>                                <span ng-show="model.remoteDatasource">{{model.remoteDatasource.label}}</span>                            </button>                        </div>                        <div class="field" ng-show="datasourceColumns">                            <label>ستون مقدار</label>                            <sm-dropdown class="selection search fluid" settings="{fullTextSearch: true}" model="model.remoteColumnKey" items="datasourceColumns" label="item.Name" value="item.Name" ></sm-dropdown>                        </div>                        <div class="field" ng-show="datasourceColumns">                            <label>ستون برچسب</label>                            <sm-dropdown class="selection search fluid" settings="{fullTextSearch: true}" model="model.remoteColumnLabel" items="datasourceColumns" label="item.Name" value="item.Name" ></sm-dropdown>                        </div>                    </div>',link:function(a,b,c){}}}),c.service("updateModel",["$http",function(a){function b(a){}function c(a){}return{updateValuesForSave:c,updateValuesForGet:b}}]),c.service("formsService",["$http","updateModel",function(a,b){var c=0,d={},e=function(e,f){e||(e="");var g="";return f&&(g="?fromEditor=true"),d[e||"all"]||(d[e||"all"]=a.get(app.urlPrefix+"api/forms/get/"+e+g).then(function(a){return e?(b.updateValuesForGet(a.data.model.pages),a.data):(c=a.data.formsModule,a.data.list)})),d[e||"all"]},f=function(b,c){return d={},a.post(app.urlPrefix+"api/forms/save/"+b,c).then(function(a){return a.data})},g=function(b){return d={},a.get(app.urlPrefix+"api/forms/delete/"+b).then(function(a){return a.data})},h=function(b,c){return d={},a.post(app.urlPrefix+"api/forms/addFormToDashboard/"+b,c).then(function(a){return a.data})},i=function(b,c){return a.post(app.urlPrefix+"api/forms/deleteFormFromDashboard/"+b,c).then(function(a){return a.data})};return{save:f,get:e,remove:g,addFormToDashboard:h,deleteFormFromDashboard:i,getFormsModule:function(){return c}}}]),c.controller("fromsCtrl",["$scope","$http","$sce","$timeout","$mdToast","$routeParams","formsService","$mdDialog","utils",function(a,b,c,d,e,f,g,h,i){var j=this;j.progress=!0,j.app=app,j.utils=i,g.get().then(function(a){j.progress=!1,j.data=a,j.formsModule=g.getFormsModule()}),j["delete"]=function(a,b,c){var d=h.confirm().title("حذف برای همیشه؟").textContent("آیا فرم "+b.name+" حذف شود؟").ariaLabel("حذف").targetEvent(a).ok("حذف!").cancel("لغو");h.show(d).then(function(){g.remove(b.id).then(function(a){var b=j.data.splice(c,1),d=e.simple().textContent("فرم "+b[0].name+" با موفقیت حذف شد");e.show(d)})})}}]),c.service("controlPropertyService",function(){function a(){return b.control}var b={};return b.control={active:null,setActive:function(a){a&&(b.control.active&&(b.control.active.isActive=!1),b.control.active=a,b.control.active.isActive=!0)},remove:function(a,c){var d=confirm("در صورت پاک کردن این کنترل تمامی داده‌هایی که قبلا در فرم برای این کنترل ذخیره شده است نیز پاک خواهد شد. آیا برای حذف این کنترل اطمینان دارید؟");d&&(dangerChangeOccured=!0,b.pages.activePage.controls.splice(a,1))},createItems:function(a){if(a.dropdown.itemsTemp){var b=a.dropdown.itemsTemp.split(/[\r\n]/);a.dropdown.items=[],_.each(b,function(b){var c=b.trim();a&&""!=c&&a.dropdown.items.push({label:c,value:c})})}},resetListValue:function(){b.control.active.dropdown.listValue=[]}},{setActive:b.control.setActive,remove:b.control.remove,getActive:b.control.active,createItems:b.control.createItems,get:a}}),c.directive("sadafDropdwon",["$compile","$timeout",function(a,b){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",formId:"@",edit:"@?"},controller:["$scope","$http","formsService","controlPropertyService",function(a,b,c,d){}],template:"<div></div>",link:function(a,c,d){function e(){clearTimeout(j),j=setTimeout(function(){var c=$(".form-"+a.model.randomId+" .ui.dropdown").dropdown("get value");_.isArray(c)||(c=[c]),c=_.filter(c,null),b(function(){a.model.dropdown.listValue=c},0)},200)}var f=$(c).hasClass("multiple");a.$watch("model.dropdown.listValue",function(a){console.log("change dropdown ",a)},!0);for(var g=f?a.model.dropdown.listValue:[a.model.value||""],h='<select class="temporal ui fluid '+(f?"multiple":"")+' search selection dropdown" '+(f?"multiple":"")+" >",i=0;i<g.length;i++)h+='  <option value="'+g[i]+'">'+g[i]+"</option>";h+="</select>",h=$(h);var j,k={onChange:function(c,d,e){f||b(function(){a.model.value=c},0)},onRemove:function(a,b,c){e()},onAdd:function(a,b,c){e()},apiSettings:{url:app.urlPrefix+"api/forms/getdropdowndata",cache:!1,method:"get",dataType:"json",beforeSend:function(b){return b.data={id:a.formId,name:a.model.name,query:b.urlData.query},a.edit&&(b.data={datasourceId:a.model.dropdown.remoteDatasource.value,remoteColumnKey:a.model.dropdown.remoteColumnKey,remoteColumnLabel:a.model.dropdown.remoteColumnLabel,query:b.urlData.query}),b},onResponse:function(a){return a.fields=a.fields.map(function(a){return{value:a.value.entitize(),label:a.label.entitize()}}),a}},message:{noResults:app.lang.translate("No results found.")},fields:{remoteValues:"fields",name:"label",value:"value"},saveRemoteData:!1,fullTextSearch:!0,forceSelection:!1};if($(c).append(h),$(h).dropdown(k),a.model.dropdown.listValue){var l=a.model.dropdown.multiSelectDropdown?a.model.dropdown.listValue:a.model.value;null!=l&&$(h).dropdown("set selected",l)}}}}]),c.directive("controlSize",["$compile","$timeout",function(a,b){return{restrict:"E",transclude:!0,scope:{model:"=ngModel"},template:"<sm-dropdown items=\"[{label:'خیلی کوچک', value:'mini'}, {label:'کوچک', value:'tiny'}, {label:'معمولی', value:''}]\" model=\"model\" label=\"item.label\" value=\"item.value\"></sm-dropdown> "}}]),c.filter("formatNumber",function(){return function(a,b){var c=b;return isNaN(a)?a:c?d3.format(c)(a):a}}),c.filter("persian",function(){return function(a){return app.lang&&0==+app.lang.langType?persian(a,!0):a}}),c.directive("sadafCheckbox",["$compile","$timeout",function(a,b){return{restrict:"E",transclude:!0,replace:!0,scope:{model:"=ngModel",change:"&?ngChange"},template:'<div class="ui checkbox"><input type="checkbox" ng-model="model" /><label ng-transclude></label></div>',link:function(a,c,d){a.model===!0||a.model&&a.model.match(/(true)/gi)?a.model=!0:a.model=!1,$(c).checkbox({onChange:function(d,e){b(function(){a.model=$(c).find("input").is(":checked"),a.change&&a.change()})}})}}}]),c.directive("filterProperty",["$compile","$timeout",function(a,b){return{restrict:"E",transclude:!0,replace:!0,scope:{model:"=ngModel",controls:"=",sourceFields:"=?"},controller:["$scope",function(a){var b={type:2};a.add=function(){a.model.push(_.extend({},b))},a.$watch("model",function(c){c||(a.model=a.model||[b])})}],template:'<div class="inner-section">                          <div class="field" ng-repeat="f in model track by $index">                            <div class="inline fields" >                                <label class="three wide field">نوع</label>                                <div class="six wide field">                                    <sm-dropdown model="f.type" class="" settings="{fullTextSearch: true, forceSelection: false}" items="[{type: 1, name:\'مقدار ثابت\'},{type: 2, name:\'مقدار کنترل\'}]" label="item.name" value="item.type"></sm-dropdown>                                </div>                                <div class="three wide field">                                    <i class="gray pointer icon plus" ng-click="add()"></i>                                    <i class="gray pointer icon delete" ng-click="model.splice($index, 1)" ng-hide="model.length==1"></i>                                </div>                            </div>                            <div class="inline fields" ng-show="f.type == 1">                                <label class="three wide field">مقدار</label>                                <input ng-model="f.staticValue" />                            </div>                            <div class="field" ng-show="f.type == 2">                                <div class="inline fields">                                    <label class="three wide field">کنترل</label>                                    <sm-dropdown model="f.control" class="selection fluid" settings="{fullTextSearch: true, forceSelection: false}" items="controls.row" label="item.label" value="item.name"></sm-dropdown>                                </div>                            </div>                            <div class="inline fields" ng-show="sourceFields">                                <label class="three wide field">ستون</label>                                <sm-dropdown model="f.sourceField" class="selection fluid" settings="{fullTextSearch: true, forceSelection: false}" items="sourceFields" label="item.label" value="item.name"></sm-dropdown>                            </div>                        </div>                   </div>',link:function(a,b,c){}}}]),c.directive("sadafDraggable",["$timeout",function(a){return function(a,b,c){function d(){$("[sadaf-draggable]").draggable({connectToSortable:"[sadaf-sortable]",helper:"clone",revert:"invalid",start:function(a,b){$(b.helper).css("width",$(b.helper).width()+"px")},stop:function(a,b){$(b.helper).css("width","100%")}}),$("[sadaf-draggable]").disableSelection()}a.$last&&d()}}]),c.directive("sadafSortable",["$timeout",function(a){return function(a,b,c){function d(){$("[sadaf-sortable]").sortable({revert:!0}),$("[sadaf-sortable]").disableSelection()}d()}}]),c.directive("sadafTime",["$compile","$timeout",function(a,b){return{restrict:"E",replace:!0,scope:{model:"=ngModel",change:"&?ngChange"},template:'<div class="">                        <input list="timeList" type="time" ng-model="model.timeValue" ng-change="change()"/>                        <datalist id="timeList">                            <option value="01:00">                            <option value="02:00">                            <option value="03:00">                            <option value="04:00">                            <option value="05:00">                            <option value="06:00">                            <option value="07:00">                            <option value="08:00">                            <option value="09:00">                            <option value="10:00">                            <option value="11:00">                            <option value="12:00">                            <option value="13:00">                            <option value="14:00">                            <option value="15:00">                            <option value="16:00">                            <option value="17:00">                            <option value="18:00">                            <option value="19:00">                            <option value="20:00">                            <option value="21:00">                            <option value="22:00">                            <option value="23:00">                            <option value="24:00">                        </datalist>                   </div>',link:function(a,b,c){a.$watch("model.timeValue",function(b,c){b&&(a.model.value=a.model.timeValue.toTimeString().split(" ")[0].substring(0,5))}),a.$watch("model.value",function(b,c){return b?void(a.model.timeValue=new Date("Thu Jan 01 1970 "+a.model.value.substring(0,5)+" GMT+0330 (Iran Standard Time)")):void(a.model.timeValue=null)})}}}])}();
// داشبورد مدیریتی صدف info@sadafdashboard.ir 

var app=app||{};app.contentSegment=$("#content_segment"),app.contentSegmentModal=$("#content_segmentModal"),console||(console={},console.log=function(){}),app.chartLoadDelay=120,app.absoluteUrl="/",app.setAboluteUrl=function(a){app.absoluteUrl=a},app.loadContent=function(a){app.showLoadingProgress(),$("#content_segment").load(app.urlPrefix+a,function(){app.hideLoadingProgress(),app.lang.setLang()})},app.setContent=function(a){$("#content_segment").html(a),app.hideLoadingProgress(),app.lang.setLang()},app.setLocation=function(a){app.router.navigate(a,{trigger:!0})},app.urlPrefix="/",app.setUrlPrefix=function(a){app.urlPrefix=a.replace(/Moderation.*/g,"")},app.showInfo=function(a){$("#app-info-text").html(a),$("#app-info-text").fadeIn(),$("#app-loading-text").hide(),app.showInfoHolder.show(),setTimeout(function(){app.showInfoHolder.hide(),$("#app-info-text").fadeOut(400,function(){$("#app-loading-text").show()})},4e3)},app.showLoadingProgress=function(){app.showInfoHolder.show()},app.hideLoadingProgress=function(){app.showInfoHolder.hide()},app.showInfoHolder={holderCount:0,timeout:{},hide:function(){if(app.showInfoHolder.holderCount>0&&--app.showInfoHolder.holderCount,0==app.showInfoHolder.holderCount){var a=(new Date).getTime()-app.showInfoHolder.ticks;clearTimeout(app.showInfoHolder.timeout),setTimeout(function(){$("#app-loading").parent("div").animate({top:"0",opacity:0},400)},1e3>a?1e3:0)}},show:function(){var a=$("#app-loading").parent("div");a.css("left",$(window).width()/2-a.outerWidth()/2),++app.showInfoHolder.holderCount,app.showInfoHolder.ticks=(new Date).getTime(),app.showInfoHolder.timeout=setTimeout(function(){$("#app-loading").parent("div").animate({top:"50",opacity:1},400)},1e3)}},app.encodeHTML=function(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},app.convertOldPropObject=function(a,b){if(a){if(a.chartProp&&a.chartProp.info)return a;var c={};if(c.chartProp={},+b==chartTypes.TABLE){c.chartProp.info={chartSize:a.chartProp.chartSize,pivotTable:a.chartProp.pivotTable},c.chartProp.series={};for(var d in a.seriesProp)a.seriesProp.hasOwnProperty(d)&&(c.chartProp.series[""+d]={name:a.seriesProp[""+d].table.headerName,numberFactor:"1",textAlign:a.seriesProp[""+d].table.textAlign,formatString:a.seriesProp[""+d].table.formatString,fontSize:a.seriesProp[""+d].table.fontSize,textBold:!1,textItalic:!1,color:a.seriesProp[""+d].table.fontColor}),c.chartProp.series["default"]={name:"",numberFactor:"1",textAlign:"right",formatString:"A",fontSize:"1m",textBold:!1,textItalic:!1,color:"#000000"}}if(+b==chartTypes.BAR){c.chartProp.info={chartSize:a.chartProp.chartSize,horizontalLines:a.chartProp.horizontalLine,formatString:a.chartProp.formatString},c.chartProp.series={};for(var d in a.seriesProp)a.seriesProp.hasOwnProperty(d)&&(c.chartProp.series[""+d]={name:"",numberFactor:a.seriesProp[""+d].barlineChartProp.numberFactor,seriesType:a.seriesProp[""+d].barlineChartProp.barlineChartType,seriesColor:a.seriesProp[""+d].barlineChartProp.barlineChartColor,lineType:a.seriesProp[""+d].barlineChartProp.barlineChartTypeLineProp.lineChartStyle,lineStyle:a.seriesProp[""+d].barlineChartProp.barlineChartTypeLineProp.lineChartLineStyle,lineWeight:a.seriesProp[""+d].barlineChartProp.barlineChartTypeLineProp.lineChartLineWeight,lineFace:a.seriesProp[""+d].barlineChartProp.barlineChartTypeLineProp.lineChartLineDashes});c.chartProp.series["default"]={name:"",numberFactor:"1",seriesType:"bar",seriesColor:"#1f77b4",lineType:"line-dot-area",lineStyle:"linear",lineWeight:"2",lineFace:"5,0"}}return+b==chartTypes.PIE&&(c.chartProp.info={horizontalLines:a.chartProp.horizontalLine,chartSize:a.chartProp.chartSize,formatString:a.chartProp.formatString,pieStyle:a.chartProp.pieStyle,hole:"65"},c.chartProp.series={},c.chartProp.series["default"]={numberFactor:"1"}),+b==chartTypes.GAUGE&&(c.chartProp.info={chartSize:a.chartProp.chartSize,style:a.chartProp.gaugeStyle,height:"medium",color:"#333333",fontSize:"3em",formatString:",.2f",status:"",target:"",textBold:!0,textItalic:!1,trend:"",value:"",segmentType:"singleSegment",min:"",yellow:"",green:"",max:""},c.chartProp.series={},c.chartProp.series["default"]={numberFactor:"1",type:"value",typeMs:"value"}),c.dataUrl=a.chartProp.DataUrl,c.editMode=a.chartProp.editMode,c}},app.autoPlayTimer=app.autoPlayTimer||{counter:0},app.autoPlay=function(a,b){if(a&&"start"==a){var c=$("#side-navigation2 .simple-link");b=b||10,$(".sadaf-circular-preogress").progressbar(10,1e3*+b),app.autoPlayTimer.timer=setTimeout(function(){var a=$(c[app.autoPlayTimer.counter++%c.length]);document.location.href=a.attr("href"),a.parents(".panel-collapse").collapse("show"),$(".sadaf-circular-preogress").progressbar("stop"),app.autoPlay("start",b)},1e3*+b)}a&&"stop"==a&&($(".sadaf-circular-preogress").progressbar("stop"),clearTimeout(app.autoPlayTimer.timer))};var resizeTimer;app.lestenWindowResize=function(a){function b(){clearTimeout(resizeTimer),resizeTimer=setTimeout(function(){a()},400)}var c=$(window).width();$(window).resize(function(){$(window).width();$(window).width()!=c&&(c=$(this).width(),b())})};var designMenuTimer,printMenuTimer;app.onMenusClick=function(a,b){return"showPrintMenu"==a||"hidePrintMenu"==a?(clearTimeout(printMenuTimer),void(printMenuTimer=setTimeout(function(){"showPrintMenu"==a?$(".navbar .print-toggle").fadeIn():"hidePrintMenu"==a&&$(".navbar .print-toggle").fadeOut()},800))):(clearTimeout(designMenuTimer),designMenuTimer=setTimeout(function(){"showDesignMenu"==a?$(".navbar .design-toggle").fadeIn():"hideDesignMenu"==a&&$(".navbar .design-toggle").fadeOut(),b&&"showfullScreenMenu"==b?$(".navbar .fullscreen-toggle").parents(".pull-right").fadeIn():$(".navbar .fullscreen-toggle").parents(".pull-right").fadeOut()},800),void $("html,body").animate({scrollTop:0},"slow",function(){$(".side-menu").hasClass("open")&&$("#side-menu-toggle").click()}))},app.print={printSingle:function(a,b){var c=this.getWidgetHtml(a);app.print.print(c,b)},getWidgetHtml:function(a){var b=$(a).height(),c=$(a).width(),d=$(a).clone();d.width(c),d.height(b);var e=d.find(".title.over-show .desc").html();d.find(".title.over-show *:not(.title-move)").remove();var f=$("<div>").append(d).html(),g=$('<div style="margin-top:10px;">'+e+"</div>").width(c),h=$("<div>").html(f).append(g);h.css({"page-break-inside":"avoid",margin:"0 50px 50px 50px"}),h.addClass("pull-left");var i=$("<div>").append(h).html();return i},printPage:function(){var a="";$(".chart-widget").each(function(){var b=$(this).find(".chart-layout").attr("id");a+=app.print.getWidgetHtml("#"+b)});var b=$(".dashboard-page.active > a").text();app.print.print(a,b)},print:function(a,b){var c='<link href="'+app.absoluteUrl+'Content/custom-rtl.css" rel="stylesheet"  type="text/css"/>               <link href="'+app.absoluteUrl+'Areas/Charts/Content/barChart-rtl.css" rel="stylesheet"  type="text/css"/>               <link href="'+app.absoluteUrl+'Content/bootstrap-select.css" rel="stylesheet"  type="text/css"/>               <link href="'+app.absoluteUrl+'Content/bootstrap-rtl.css" rel="stylesheet"  type="text/css"/>               <link href="'+app.absoluteUrl+'Areas/Charts/Content/dashboardPage-rtl.css" rel="stylesheet"  type="text/css"/>               <style  type="text/css">@page {                            margin: 1.5cm;                            @top-center {                                    content: "sapam";                                }                            }                </style>',d=window.open();d.document.write('<html><head><meta charset="utf-8"><title>'+b+"</title>"+c),d.document.write("</head><body>"),d.document.write(a),d.document.write("</body></html>"),d.document.close(),d.focus(),setTimeout(function(){d.print()},400)}},app.post=function(a,b,c){$.ajax({url:a,type:"POST",data:JSON.stringify(b),dataType:"json",contentType:"application/json; charset=utf-8",traditional:!0,success:c})},app.lang={langType:0,setLangTyle:function(a){this.langType=+(a||0)},isRtl:function(){return 0==app.lang.langType},translate:function(a){return app.lang.lang?app.lang.lang[a]||a:a},q:[],translateAsync:function(a,b){app.lang.lang?b&&b(app.lang.lang[a]||a):this.q.push({key:a,callback:b})},setLang:function(a){if(a&&a.data&&(this.lang=a.data),this.lang||!this.inProgress)if(this.lang||this.inProgress){var b;b=a&&a.selector?$(a.selector).find("*[data-trans-key]"):$("*[data-trans-key]"),b.each(function(){var a=$(this),b=a.data("translated");if(!b){var c=app.lang.lang[a.data("trans-key")],d=a.data("trans-attr");d?a.attr(d,c):a.text(c),a.data("translated",!0)}})}else{var c=0==app.lang.langType?"fa":"en";for(this.inProgress=!0,$.getJSON(app.urlPrefix+"dist/locales/locale-"+c+".js?v="+app.version,null,function(a){app.lang.setLang({data:a})});this.q.length>0;){var d=this.q.pop();d.callback&&callback(app.lang.lang[d.key]||d.key)}}}},angular.module("uibCollapseCat",[]).directive("uibCollapse",["$animate","$q","$parse","$injector",function(a,b,c,d){var e=d.has("$animateCss")?d.get("$animateCss"):null;return{link:function(d,f,g){function h(){f.hasClass("collapse")&&f.hasClass("in")||b.resolve(l(d)).then(function(){f.removeClass("collapse").addClass("collapsing").attr("aria-expanded",!0).attr("aria-hidden",!1),e?e(f,{addClass:"in",easing:"ease",to:{height:f[0].scrollHeight+"px"}}).start()["finally"](i):a.addClass(f,"in",{to:{height:f[0].scrollHeight+"px"}}).then(i)})}function i(){f.removeClass("collapsing").addClass("collapse").css({height:"auto"}),m(d)}function j(){return f.hasClass("collapse")||f.hasClass("in")?void b.resolve(n(d)).then(function(){f.css({height:f[0].scrollHeight+"px"}).removeClass("collapse").addClass("collapsing").attr("aria-expanded",!1).attr("aria-hidden",!0),e?e(f,{removeClass:"in",to:{height:"0"}}).start()["finally"](k):a.removeClass(f,"in",{to:{height:"0"}}).then(k)}):k()}function k(){f.css({height:"0"}),f.removeClass("collapsing").addClass("collapse"),o(d)}var l=c(g.expanding),m=c(g.expanded),n=c(g.collapsing),o=c(g.collapsed);d.$eval(g.uibCollapse)||f.addClass("in").addClass("collapse").attr("aria-expanded",!0).attr("aria-hidden",!1).css({height:"auto"}),d.$watch(g.uibCollapse,function(a){a?j():h()})}}}]);var manageApp=angular.module("management",["sadafForms","ngRoute","ngMaterial","ngAnimate","ngMessages","datasourceScheduleCat","datasourcePartitionExpressionCat","pascalprecht.translate","ngSanitize","mdColorPicker","ui.ace","ui.sortable","uibCollapseCat","textAngular"]);manageApp.config(["$provide",function(a){}]),manageApp.config(["$mdThemingProvider",function(a){a.theme("default").primaryPalette("blue").accentPalette("indigo").warnPalette("red").backgroundPalette("grey"),a.theme("t1").primaryPalette("grey").accentPalette("red").warnPalette("red").backgroundPalette("grey")}]),manageApp.config(["$translateProvider",function(a){a.useStaticFilesLoader({prefix:app.urlPrefix+"dist/locales/locale-",suffix:".js?v="+app.version}),a.preferredLanguage("fa"),a.useSanitizeValueStrategy("sanitizeParameters")}]),manageApp.config(["$httpProvider",function(a){}]),manageApp.config(["$provide",function(a){a.decorator("taOptions",["$delegate",function(a){return a.forceTextAngularSanitize=!0,a.toolbar=[["h1","h2","h3","h4","h5","h6","p","pre","quote"],["bold","italics","underline","ul","ol","redo","undo","clear"],["justifyLeft","justifyCenter","justifyRight","justifyFull"]],a.classes={focussed:"focussed",toolbar:"btn-toolbar",toolbarGroup:"btn-group",toolbarButton:"btn btn-default",toolbarButtonActive:"active",disabled:"disabled",textEditor:"form-control",htmlEditor:"form-control"},a}])}]);var service=["$http","$interval",function(a,b){var c;return{start:function(){var d=function(){a.get(app.urlPrefix+"api/onlineusers/heartbeat").then(null,function(a){a&&a.data&&a.data.forceSignout&&(alert("شما از برنامه خارج شده‌اید. ممکن است کاربر دیگری با نام کاربری شما وارد سیستم شده باشد."),window.location.href=app.urlPrefix)})};d(),c=b(d,3e4)},stop:function(){b.cancel(c)}}}];try{var sadaf=angular.module("sadaf");sadaf.factory("heartBeat",service),sadaf.run(["heartBeat",function(a){a.start()}])}catch(e){}try{var management=angular.module("management");management.factory("heartBeat",service),management.run(["heartBeat",function(a){a.start()}])}catch(e){}angular.module("ui.mask",[]).value("uiMaskConfig",{maskDefinitions:{2:/[0,1,2]/,6:/[0,1,2,3,4,5,6]/,9:/\d/,A:/[a-zA-Z]/,"*":/[a-zA-Z0-9]/},clearOnBlur:!0}).directive("uiMask",["uiMaskConfig","$parse",function(a,b){"use strict";return{priority:100,require:"ngModel",restrict:"A",compile:function(){var c=a;return function(a,d,e,f){function g(a){return angular.isDefined(a)?(t(a),O?(l(),m(),!0):k()):k()}function h(a){angular.isDefined(a)&&(E=a,O&&x())}function i(a){return O?(H=p(a||""),J=o(H),f.$setValidity("mask",J),J&&H.length?q(H):void 0):a}function j(a){return O?(H=p(a||""),J=o(H),f.$viewValue=H.length?q(H):"",f.$setValidity("mask",J),""===H&&e.required&&f.$setValidity("required",!f.$error.required),J?H:void 0):a}function k(){return O=!1,n(),angular.isDefined(Q)?d.attr("placeholder",Q):d.removeAttr("placeholder"),angular.isDefined(R)?d.attr("maxlength",R):d.removeAttr("maxlength"),d.val(f.$modelValue),f.$viewValue=f.$modelValue,!1}function l(){H=L=p(f.$viewValue||""),I=K=q(H),J=o(H);var a=J&&H.length?I:"";e.maxlength&&d.attr("maxlength",2*C[C.length-1]),d.attr("placeholder",E),d.val(a),f.$viewValue=a}function m(){P||(d.bind("blur",u),d.bind("mousedown mouseup",v),d.bind("input keyup click focus",x),P=!0)}function n(){P&&(d.unbind("blur",u),d.unbind("mousedown",v),d.unbind("mouseup",v),d.unbind("input",x),d.unbind("keyup",x),d.unbind("click",x),d.unbind("focus",x),P=!1)}function o(a){return a.length?a.length>=G:!0}function p(a){var b="",c=D.slice();return a=a.toString(),angular.forEach(F,function(b){a=a.replace(b,"")}),angular.forEach(a.split(""),function(a){c.length&&c[0].test(a)&&(b+=a,c.shift())}),b}function q(a){var b="",c=C.slice();return angular.forEach(E.split(""),function(d,e){a.length&&e===c[0]?(b+=a.charAt(0)||"_",a=a.substr(1),c.shift()):b+=d}),b}function r(a){var b=e.placeholder;return"undefined"!=typeof b&&b[a]?b[a]:"_"}function s(){return E.replace(/[_]+/g,"_").replace(/([^_]+)([a-zA-Z0-9])([^_])/g,"$1$2_$3").split("_")}function t(a){var b=0;if(C=[],D=[],E="","string"==typeof a){G=0;var c=!1,d=0,e=a.split("");angular.forEach(e,function(a,e){S.maskDefinitions[a]?(C.push(b),E+=r(e-d),D.push(S.maskDefinitions[a]),b++,c||G++):"?"===a?(c=!0,d++):(E+=a,b++)})}C.push(C.slice().pop()+1),F=s(),O=C.length>1}function u(){S.clearOnBlur&&(M=0,N=0,J&&0!==H.length||(I="",d.val(""),a.$apply(function(){f.$setViewValue("")})))}function v(a){"mousedown"===a.type?d.bind("mouseout",w):d.unbind("mouseout",w)}function w(){N=B(this),d.unbind("mouseout",w)}function x(b){b=b||{};var c=b.which,e=b.type;if(16!==c&&91!==c){var g,h=d.val(),i=K,j=p(h),k=L,l=!1,m=z(this)||0,n=M||0,o=m-n,r=C[0],s=C[j.length]||C.slice().shift(),t=N||0,u=B(this)>0,v=t>0,w=h.length>i.length||t&&h.length>i.length-t,x=h.length<i.length||t&&h.length===i.length-t,D=c>=37&&40>=c&&b.shiftKey,E=37===c,F=8===c||"keyup"!==e&&x&&-1===o,G=46===c||"keyup"!==e&&x&&0===o&&!v,H=(E||F||"click"===e)&&m>r;if(N=B(this),!D&&(!u||"click"!==e&&"keyup"!==e)){if("input"===e&&x&&!v&&j===k){for(;F&&m>r&&!y(m);)m--;for(;G&&s>m&&-1===C.indexOf(m);)m++;var I=C.indexOf(m);j=j.substring(0,I)+j.substring(I+1),l=!0}for(g=q(j),K=g,L=j,d.val(g),l&&a.$apply(function(){f.$setViewValue(j)}),w&&r>=m&&(m=r+1),H&&m--,m=m>s?s:r>m?r:m;!y(m)&&m>r&&s>m;)m+=H?-1:1;(H&&s>m||w&&!y(n))&&m++,M=m,A(this,m)}}}function y(a){return C.indexOf(a)>-1}function z(a){if(!a)return 0;if(void 0!==a.selectionStart)return a.selectionStart;if(document.selection){a.focus();var b=document.selection.createRange();return b.moveStart("character",a.value?-a.value.length:0),b.text.length}return 0}function A(a,b){if(!a)return 0;if(0!==a.offsetWidth&&0!==a.offsetHeight)if(a.setSelectionRange)a.focus(),a.setSelectionRange(b,b);else if(a.createTextRange){var c=a.createTextRange();c.collapse(!0),c.moveEnd("character",b),c.moveStart("character",b),c.select()}}function B(a){return a?void 0!==a.selectionStart?a.selectionEnd-a.selectionStart:document.selection?document.selection.createRange().text.length:0:0}var C,D,E,F,G,H,I,J,K,L,M,N,O=!1,P=!1,Q=e.placeholder,R=e.maxlength,S={};e.uiOptions?(S=a.$eval("["+e.uiOptions+"]"),angular.isObject(S[0])&&(S=function(a,b){for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&(void 0===b[c]?b[c]=angular.copy(a[c]):angular.extend(b[c],a[c]));return b}(c,S[0]))):S=c,e.$observe("uiMask",g),e.$observe("placeholder",h);var T=!1;e.$observe("modelViewValue",function(a){"true"===a&&(T=!0)}),a.$watch(e.ngModel,function(c){if(T&&c){var d=b(e.ngModel);d.assign(a,f.$viewValue)}}),f.$formatters.push(i),f.$parsers.push(j),d.bind("mousedown mouseup",v),Array.prototype.indexOf||(Array.prototype.indexOf=function(a){if(null===this)throw new TypeError;var b=Object(this),c=b.length>>>0;if(0===c)return-1;var d=0;if(arguments.length>1&&(d=Number(arguments[1]),d!==d?d=0:0!==d&&d!==1/0&&d!==-(1/0)&&(d=(d>0||-1)*Math.floor(Math.abs(d)))),d>=c)return-1;for(var e=d>=0?d:Math.max(c-Math.abs(d),0);c>e;e++)if(e in b&&b[e]===a)return e;return-1})}}}}]);var ngApp=angular.module("management");ngApp.directive("menuContainer",function(){return{restrict:"E",transclude:!0,scope:{openMenuName:"="},controller:["$scope",function(a){var b=a.menus=[];a.openMenuName&&(a.openMenuName.set=function(a){_.forEach(b,function(b){console.log(b.name,a),b.name==a&&b.header.click(!0)})}),a.select=function(a){angular.forEach(b,function(a){a.selected=!1}),a.selected=!0},this.addMenu=function(a){a.header.click=function(c){var d=a.header.isOpen;c&&(d=!1),_.forEach(b,function(a){a.header.isOpen=!1,a.body.isOpen=!1}),a.header.isOpen=!d,a.body.isOpen=!d},b.push(a)}}],template:"<div ng-transclude ></div>"}}).directive("menuItem",function(){return{require:"^^menuContainer",restrict:"E",transclude:!0,scope:{name:"@"},link:function(a,b,c,d){d.addMenu(a)},controller:["$scope",function(a){a.select=function(){},this.addHeader=function(b){a.header=b},this.addBody=function(b){a.body=b}}],template:"<div ng-transclude></div><md-divider></md-divider>"}}).directive("menuHeader",function(){return{require:"^^menuItem",restrict:"E",transclude:!0,scope:{},link:function(a,b,c,d){d.addHeader(a)},controller:["$scope",function(a){}],template:'<md-list-item class="md-no-sticky pointer header" ng-click="click()" ng-class="{active: isOpen}">               <div layout="row" flex layout-align="start center">                                                                  <div ng-transclude style="display:inline-block"> </div>                                                          <span flex></span>                                                                                               <span class="material-icons icon-animate " ng-click="click()" ng-class="{rotate : isOpen}">keyboard_arrow_down</span>             </div>                                                                                                       </md-list-item>'}}).directive("menuBody",function(){return{restrict:"E",require:"^^menuItem",transclude:!0,scope:{},link:function(a,b,c,d){d.addBody(a)},template:'<div uib-collapse="!isOpen"><div class="menu-body-container" ng-transclude></div></div>'}}).directive("switchButton",function(){return{restrict:"E",transclude:!0,scope:{ngModel:"="},template:'<div style="display:inline-block" class="switch-button" ng-click="ngModel = !ngModel" ng-class="{ active : ngModel}"><div ng-transclude style="display:inline-block"></div></div>'}}).directive("sadafIndicator",function(){return{restrict:"E",transclude:!0,scope:{model:"=ngModel",series:"=",onChange:"&ngChange",hideThen:"@"},controller:["$scope","$translate",function(a,b){var c=a.model;a.hideThen;a.icons=["add to calendar icon","address book icon","address book outline icon","address card icon","address card outline icon","alarm icon","alarm mute icon","alarm mute outline icon","alarm outline icon","at icon","browser icon","bug icon","calendar icon","calendar outline icon","checked calendar icon","cloud icon","code icon","comment icon","comment outline icon","comments icon","comments icon","comments outline icon","copyright icon","creative commons icon","dashboard icon","delete calendar icon","external icon","external icon","external square icon","eyedropper icon","feed icon","find icon","hand pointer icon","handshake icon","hashtag icon","heartbeat icon","history icon","home icon","hourglass empty icon","hourglass end icon","hourglass full icon","hourglass half icon","hourglass start icon","id badge icon","id card icon","id card outline icon","idea icon","image icon","inbox icon","industry icon","lab icon","mail icon","mail outline icon","mail square icon","mouse pointer icon","open envelope icon","open envelope outline icon","options icon","paint brush icon","payment icon","percent icon","podcast icon","privacy icon","protect icon","registered icon","remove from calendar icon","search icon","setting icon","settings icon","shop icon","shopping bag icon","shopping basket icon","sidebar icon","signal icon","sitemap icon","tag icon","tags icon","tasks icon","terminal icon","text telephone icon","ticket icon","trademark icon","trophy icon","window close icon","window close outline icon","window maximize icon","window minimize icon","window restore icon","add to cart icon","add user icon","adjust icon","archive icon","ban icon","bookmark icon","call icon","call square icon","clone icon","cloud download icon","cloud upload icon","talk icon","talk outline icon","compress icon","configure icon","download icon","edit icon","erase icon","exchange icon","expand icon","external share icon","filter icon","hide icon","in cart icon","lock icon","mail forward icon","object group icon","object ungroup icon","pin icon","print icon","random icon","recycle icon","refresh icon","remove bookmark icon","remove user icon","repeat icon","reply all icon","reply icon","retweet icon","send icon","send outline icon","share alternate icon","share alternate square icon","share icon","share square icon","sign in icon","sign out icon","theme icon","translate icon","undo icon","unhide icon","unlock alternate icon","unlock icon","upload icon","wait icon","wizard icon","write icon","write square icon","announcement icon","birthday icon","help circle icon","help icon","info circle icon","info icon","warning circle icon","warning icon","warning sign icon","child icon","doctor icon","handicap icon","spy icon","student icon","user icon","user circle","user circle outline","user outline","users icon","female icon","gay icon","genderless icon","heterosexual icon","intergender icon","lesbian icon","male icon","man icon","neuter icon","non binary transgender icon","other gender horizontal icon","other gender icon","other gender vertical icon","transgender icon","woman icon","block layout icon","crop icon","grid layout icon","list layout icon","maximize icon","resize horizontal icon","resize vertical icon","zoom icon","zoom out icon","anchor icon","bar icon","bathtub icon","bomb icon","book icon","bullseye icon","calculator icon","cocktail icon","diamond icon","fax icon","fire extinguisher icon","fire icon","flag checkered icon","flag icon","flag outline icon","gift icon","hand lizard icon","hand peace icon","hand paper icon","hand rock icon","hand scissors icon","hand spock icon","law icon","leaf icon","legal icon","lemon icon","life ring icon","lightning icon","magnet icon","money icon","moon icon","plane icon","puzzle icon","road icon","rocket icon","shipping icon","shower icon","snowflake icon","soccer icon","sticky note icon","sticky note outline icon","suitcase icon","sun icon","thermometer empty icon","thermometer quarter icon","thermometer half icon","thermometer three quarters icon","thermometer full icon","travel icon","treatment icon","tv icon","umbrella icon","world icon","asterisk icon","certificate icon","circle icon","circle notched icon","circle thin icon","crosshairs icon","cube icon","cubes icon","ellipsis horizontal icon","ellipsis vertical icon","quote left icon","quote right icon","spinner icon","square icon","square outline icon","add circle icon","add square icon","check circle icon","check circle outline icon","check square icon","checkmark box icon","checkmark icon","minus circle icon","minus icon","minus square icon","minus square outline icon","move icon","plus icon","plus square outline icon","radio icon","remove circle icon","remove circle outline icon","remove icon","selected radio icon","toggle off icon","toggle on icon","area chart icon","bar chart icon","camera retro icon","film icon","line chart icon","newspaper icon","photo icon","pie chart icon","sound icon","angle double down icon","angle double left icon","angle double right icon","angle double up icon","angle down icon","angle left icon","angle right icon","angle up icon","arrow circle down icon","arrow circle left icon","arrow circle outline down icon","arrow circle outline left icon","arrow circle outline right icon","arrow circle outline up icon","arrow circle right icon","arrow circle up icon","arrow down icon","arrow left icon","arrow right icon","arrow up icon","caret down icon","caret left icon","caret right icon","caret up icon","chevron circle down icon","chevron circle left icon","chevron circle right icon","chevron circle up icon","chevron down icon","chevron left icon","chevron right icon","chevron up icon","long arrow down icon","long arrow left icon","long arrow right icon","long arrow up icon","pointing down icon","pointing left icon","pointing right icon","pointing up icon","toggle down icon","toggle left icon","toggle right icon","toggle up icon","mobile icon","tablet icon","battery empty icon","battery low icon","battery medium icon","battery high icon","battery full icon","desktop icon","disk outline icon","game icon","keyboard icon","laptop icon","plug icon","power icon","file archive outline icon","file audio outline icon","file code outline icon","file excel outline icon","file icon","file image outline icon","file outline icon","file pdf outline icon","file powerpoint outline icon","file text icon","file text outline icon","file video outline icon","file word outline icon","folder icon","folder open icon","folder open outline icon","folder outline icon","level down icon","level up icon","trash icon","trash outline icon","barcode icon","bluetooth alternative icon","bluetooth icon","css3 icon","database icon","fork icon","html5 icon","microchip icon","openid icon","qrcode icon","rss icon","rss square icon","server icon","usb icon","empty heart icon","empty star icon","frown icon","heart icon","meh icon","smile icon","star half empty icon","star half icon","star icon","thumbs down icon","thumbs outline down icon","thumbs outline up icon","thumbs up icon","backward icon","closed captioning icon","eject icon","fast backward icon","fast forward icon","forward icon","music icon","mute icon","pause circle icon","pause circle outline icon","pause icon","play icon","record icon","step backward icon","step forward icon","stop circle icon","stop circle outline icon","stop icon","unmute icon","video play icon","video play outline icon","volume down icon","volume off icon","volume up icon","bicycle icon","building icon","building outline icon","bus icon","car icon","coffee icon","compass icon","emergency icon","first aid icon","food icon","h icon","hospital icon","hotel icon","location arrow icon","map icon","map outline icon","map pin icon","map signs icon","marker icon","military icon","motorcycle icon","paw icon","ship icon","space shuttle icon","spoon icon","street view icon","subway icon","taxi icon","train icon","television icon","tree icon","university icon","columns icon","sort alphabet ascending icon","sort alphabet descending icon","sort ascending icon","sort content ascending icon","sort content descending icon","sort descending icon","sort icon","sort numeric ascending icon","sort numeric descending icon","table icon","bitcoin icon","dollar icon","euro icon","lira icon","pound icon","ruble icon","rupee icon","shekel icon","won icon","yen icon","wheelchair icon","asl interpreting icon","assistive listening systems icon","audio description icon","blind icon","braille icon","deafness icon","low vision icon","sign language icon","universal access icon","volume control phone icon","align center icon","align justify icon","align left icon","align right icon","attach icon","bold icon","copy icon","cut icon","font icon","header icon","indent icon","italic icon","linkify icon","list icon","ordered list icon","outdent icon","paragraph icon","paste icon","save icon","strikethrough icon","subscript icon","superscript icon","text cursor icon","text height icon","text width icon","underline icon","unlinkify icon","unordered list icon"],c.ifRow=c.ifRow||[{}],c.thenRow=c.thenRow||[{}],a.ops=[{value:"1",name:"equal"},{value:"2",name:"not_equal"},{value:"3",name:"greater_than"},{value:"4",name:"greater_equal_than"},{value:"5",name:"less_than"},{value:"6",name:"less_equla_than"},{value:"7",name:"contain"},{value:"8",name:"not_contain"}],a.thenOps=[{value:"1",name:"change_color"},{value:"2",name:"add_icon"},{value:"3",name:"change_back_color"},{value:"4",name:"change_style"},{value:"5",name:"replace"}]}],template:'<div>                                                                                                                                                 <div ng-repeat="i in model.ifRow" class="form-row" >                                                                                                                      <span ng-show="model.ifRow.length > 1 && !$first">{{ \'and\' | translate }}</span>                                                                                   <span>{{ \'if\' | translate }}</span>                                                                                                                                <select style="max-width:60px" ng-model="i.firstField" ng-options="s as s for s in series" ng-change="onChange()"></select>                                                                 <select style="max-width:60px" ng-model="i.operand" ng-options="s.value as (s.name | translate) for s in ops" ng-change="onChange()"></select>                                                <md-switch ng-model="i.secondFieldIsText" style="margin: 0 0px -13px 8px;display:inline-block;line-height: 1.5;"><span style="padding: 0 8px">{{ \'istext\' | translate }}</span></md-switch>                                                                                                 <select ng-model="i.secondFieldSelect" ng-options="s as s for s in series" ng-show="!i.secondFieldIsText" ng-change="onChange()"></select>                           <input ng-model="i.secondFieldInput" type="text" ng-show="i.secondFieldIsText"  ng-change="onChange()"/>                                                             <span class="ui mini basic compact icon button" ng-click="model.ifRow.splice( $index+1, 0, {})"><i class="icon plus"></i></span>                                                                                                     <span class="ui mini basic compact icon button" ng-click="model.ifRow.splice($index, 1); onChange()" ng-show="model.ifRow.length > 1"><i class="icon minus"></i></span>                             </div>                                                                                                                                                               <div ng-repeat="i in model.thenRow" ng-hide="hideThen" class="form-row" layout="row" layout-align="start center">                                                                           <span ng-show="model.thenRow.length > 1 && !$first">{{ \'and\' | translate }}</span>                                                                                 <span>{{ \'then\' | translate }}</span>                                                                                                                              <select style="max-width:60px" ng-model="i.firstField" ng-options="s as s for s in series" ng-change="onChange()"></select>                                                                 <select style="max-width:60px" ng-model="i.operand" ng-options="s.value as (s.name | translate) for s in thenOps" ng-change="onChange()"></select>                                                                                                                                                                                                                 <span md-color-picker ng-model="i.secondFieldColor" ng-show="i.operand == 1" md-color-default-tab="\'genericPalette\'"  on-change="onChange()"></span>               <span md-color-picker ng-model="i.secondFieldBackColor" ng-show="i.operand == 3" md-color-default-tab="\'genericPalette\'" on-change="onChange()"></span>            <select ng-show="i.operand == 4" ng-model="i.secondFieldStyle" ng-change="onChange()">                                                                                   <option value="1">{{ \'normal\' | translate }}</option>                                                                                                              <option value="2">{{ \'bold\' | translate }}</option>                                                                                                                <option value="3">{{ \'italic\' | translate }}</option>                                                                                                              <option value="4">{{ \'bold_italic\' | translate }}</option>                                                                                                         <option value="5">{{ \'underline\' | translate }}</option>                                                                                                       </select>                                                                                                                                                            <input ng-model="i.secondFieldReplace" type="text" ng-show="i.operand == 5" />                                                                                                                                                                                                                                                            <div ng-show="i.operand == 2">             <md-menu>                <span class="ui mini compact  icon button" ng-click="$mdMenu.open($event)"><i class="{{i.secondFieldIcon}}" ng-init="i.secondFieldIcon = i.secondFieldIcon || \'icon warning\'"></i></span>                <md-menu-content>                    <div style="max-width:500px; overflow:auto;">                        <i ng-repeat="ic in icons track by $index" ng-click="$mdMenu.hide;i.secondFieldIcon = ic; onChange()" class="pointer menu-icon {{ic}}"></i>                    </div>                </md-menu-content >             </md-menu>        </div>                                                                                                                                                                             <span class="ui mini basic compact icon button" ng-click="model.thenRow.splice( $index+1, 0, {})"><i class="icon plus"></i></span>                                                                                                     <span class="ui mini basic compact icon button" ng-click="model.thenRow.splice($index, 1); onChange()" ng-show="model.thenRow.length > 1"><i class="icon minus"></i></span>                              </div>                                                                                                                                                           </div>'
}}).directive("sadafContactList",function(){return{restrict:"E",transclude:!0,scope:{model:"=ngModel"},controller:["$scope",function(a){a.model=a.model||[{}]}],template:'<div>                                                                                                     <div ng-repeat="i in model" class="form-row">                                                              <span>{{$index}}</span>                                                                                <input ng-model="i.phone" type="text"  placeholder="{{\'phone\' | translate}}"/>                       <input ng-model="i.email" type="text"  placeholder="{{\'email\' | translate}}"/>                       <span ng-click="model.splice( $index+1, 0, {})">+</span>                                               <span ng-click="model.splice($index, 1)" ng-show="model.length > 1">حذف</span>                    </div>                                                                                             </div>'}}).directive("sadafRemovable",function(){return{restrict:"E",transclude:!0,scope:{onDelete:"&onDelete"},controller:["$scope",function(a){a.model=a.model||[{}]}],template:'<div layout="row" layout-align="start center">                <span class ="material-icons small" ng-click="onDelete()">close</span>                <div ng-transclude></div>            </div>'}}).directive("fileread",[function(){return{scope:{fileread:"="},link:function(a,b,c){b.bind("change",function(b){a.$apply(function(){a.fileread=a.fileread||{},a.fileread=b.target.files[0]})})}}}]).directive("collapse",function(){return{restrict:"E",transclude:!0,scope:{title:"@",hideIcon:"@",onTitleClick:"&",model:"=?ngModel",selectableDir:"=?"},controller:["$scope",function(a){var b,c;a.model=a.model||{},this.addHeader=function(d){b=d,b.show=a.model.open,b.click=function(){c&&(a.model.open=!c.show,c.show=!c.show),a.onTitleClick()}},this.addBody=function(b){c=b,c.show=a.model.open},"true"==a.hideIcon&&b&&(b.hideIcon=!0),a.$watch("hideIcon",function(c){"true"==a.hideIcon&&b&&(b.hideIcon=!0)})}],template:"<div ng-transclude><div>"}}).directive("collapseHeader",function(){return{restrict:"E",transclude:!0,require:"^^collapse",scope:{},link:function(a,b,c,d){d.addHeader(a)},template:'<div ng-click="show = !show; click()" layout="row" layout-align="start center" class="pointer title">                        <span class ="material-icons icon-animate right-arrow" ng-class ="{\'rotate-90\' : show}" ng-hide="hideIcon">keyboard_arrow_right</span>                        <div ng-transclude><div>                 </div>'}}).directive("collapseBody",function(){return{restrict:"E",transclude:!0,require:"^^collapse",scope:{},link:function(a,b,c,d){d.addBody(a)},template:'<div class="body" uib-collapse="!show" ng-transclude></div>'}}).directive("tree",function(){return{restrict:"E",transclude:!0,scope:{root:"=ngModel",option:"=",url:"&"},controller:["$scope","$http","$translate",function(a,b,c){function d(a,b){b(a),a.nodes&&(_.forEach(a.nodes,function(a){d(a,b)}),_.forEach(a.contents,function(a){d(a,b)}))}a.root=a.root||{name:"root",open:!0},a.active=function(b){var c=b.active;a.option.multiple||d(a.root,function(a){a.active=!1}),b.active=c},a.selectAll=function(a,b){_.each(a.contents,function(a){a.active=b})}}],template:'<div class ="sadaf-tree">                                                                                                                                    <div style="list-style:none" class ="tree-element ul">                                                                                                       <div ng-repeat="data in [root]" class ="tree-element li" ng-include="\'tree_item_renderer.html\'"></div>                                             </div>                                                                                                                                               </div>                                                                                                                                                                                                                                                                                                            <script type="text/ng-template" id="tree_item_renderer.html">                                                                                                <collapse class ="block" selectable-dir="option.selectableDir" ng-model="data"                                                                               hide-icon="{{(!data.nodes || !data.nodes.length ) && ( option.justDir || ( !data.contents || !data.contents.length) ) && data.loaded }}">                                                                                                                                                                         <collapse-header class ="block" ng-click="$event.stopPropagation(); option.url(data)">                                                                       <md-checkbox ng-show="option.selectableDir" ng-model="data.active"ng-change="active(data)" ng-click="$event.stopPropagation()"                                       style="margin:0">{{data.name}}</md-checkbox>                                                                                                 <span ng-show="!option.selectableDir">{{data.name}}</span>                                                                                           </collapse-header>                                                                                                                                                                                                                                                                                                <collapse-body class ="block">                                                                                                                               <div class ="tree-element ul" style="list-style:none" >                                                                                                      <div layout="row" layout-align="start center" ng-hide="data.loaded" style="padding:0 18px; font-size:0.8em">                                                     <md-progress-circular  md-mode=\'indeterminate\' md-diameter="20" ></md-progress-circular>                                                               {{\'form_loading\' | translate}}                                                                                                                 </div>                                                                                                                                                   <div class ="tree-element li"><md-checkbox ng-show="option.multiple" ng-click="$event.stopPropagation()" ng-model="data.selectAll" ng-change="selectAll(data, data.selectAll)"><small> {{"select_all" | translate}} </small></md-checkbox></div>                                                                                                                                               <div ng-repeat="data in data.nodes" class ="tree-element li" ng-include="\'tree_item_renderer.html\'"></div>                                             <div ng-repeat="u in data.contents" class ="tree-element li" ng-class ="{active : u.active}" ng-hide="option.justDir">                                       <md-checkbox ng-model="u.active" ng-change="active(u)" style="margin-bottom:0">{{u.name}}</md-checkbox>                                              </div>                                                                                                                                               </div>                                                                                                                                               </collapse-body>                                                                                                                                                                                                                                                                                              </collapse>                                                                                                                                                                                                                                                                                                   </script>'}}).directive("menuPermission",function(){return{restrict:"E",transclude:!0,scope:{menus:"=",roles:"="},controller:["$scope","$http","$translate",function(a,b,c){}],template:'            <menu-item class="panel ">                <menu-header>{{ \'menus\' | translate }}</menu-header>                <menu-body>                    <div style="margin:0 20px">                                                              {{menus}}<collapse ng-repeat="(k,v) in menus">                                                                   <div layout="row">                                                                                             <collapse-header>                                                                                              {{k}}                                                                                                  </collapse-header>                                                                                         <span flex></span>                                                                                     </div>                                                                                                     <collapse-body>                                                                                                <div style="margin:0 20px">                                                                                <div ng-repeat="r in v" layout="row" layout-align="start center">                                              <md-checkbox ng-model="r.check">{{r.name}}</md-checkbox>                                                   <span flex></span>                                                                                                                                                                                                 </div>                                                                                                 </div>                                                                                                 </collapse-body>                                                                                       </collapse>                                                                                            </div>                                                                                         </menu-body>            </menu-item>            <menu-item class="panel ">                <menu-header>{{ \'datasources\' | translate }}</menu-header>                <menu-body>                    <datasource-permission ng-model="roles" class="block" type="chart" id="{{parent.id}}"></datasource-permission>                </menu-body>            </menu-item>'}});var ngApp=angular.module("management");ngApp.controller("menusCtrl",["$scope","$http","$sce","$routeParams","$location","$mdSidenav","toolbar","$timeout","$translate","$mdMedia",function(a,b,c,d,e,f,g,h,i,j){a.lock=j("gt-md"),a.toolbar=g,a.app=app,a.mainMenuType=1,a.toggle=function(){console.log("### locl",a.lock,j("gt-md")),j("gt-md")?a.lock=!a.lock:(f("r").toggle(),console.log("### call toggle"))},b.get(app.urlPrefix+"menu/MenuCategories/3").then(function(b){function c(){a.closeAll();var b=e.path();_.each(a.menuCategories.data,function(a){_.each(a.menus,function(c){c.active=!1,b.replace(/^\/(.*)/i,"$1")==c.menu.Link.replace(/^\/(.*)/i,"$1")&&(c.active=!0,a.isOpen=!0)})})}a.menuCategories=b.data;try{a.menuCategories.data[4].menus.splice(0,1)}catch(d){}var f={"Account/UsersList":"/users","Account/RolesList":"/roles","Moderation/DataSource/index/":"/datasources","Moderation/Charts/index/":"/charts","Moderation/GlobalVariable/index/":"/variables","Moderation/DatasourceInterRelation/index/":"/datasourceJoin","Moderation/AutoUpdate/index/":"/settings/update","Moderation/Settings/Mail/":"/settings/mail","Moderation/Settings/GeneralSettings/":"/settings",onlineUsers:"/onlineUsers",licence:"/licence"},g={"Account/UsersList":"person","Account/RolesList":"group","Moderation/DataSource/index/":"storage","Moderation/Charts/index/":"timeline","Moderation/GlobalVariable/index/":"space_bar","Moderation/DatasourceInterRelation/index/":"linear_scale","Moderation/AutoUpdate/index/":"update","Moderation/Settings/Mail/":"mail","Moderation/Settings/GeneralSettings/":"settings",onlineUsers:"rowing",licence:"card_membership",syncUserVariablesList:"sync","forms/list":"assignment"};_.each(a.menuCategories.data,function(a){_.each(a.menus,function(a){a.menu.icon=g[a.menu.Link]||"code",a.menu.Link=f[a.menu.Link]||a.menu.Link})}),c(),a.$on("$locationChangeStart",function(a,b,d){c()})}),a.setLink=function(a){f("r").toggle(),h(function(){e.path(a.menu.Link)},400)},a.closeNav=function(){f("r").toggle()},a.closeAll=function(b){_.each(a.menuCategories.data,function(a){b?a.category.Id!==b.category.Id&&(a.isOpen=!1):a.isOpen=!1})},a.gotoDashboard=function(){e.path()},0==+$("#lang").val()?i.use("fa"):i.use("en")}]),ngApp.service("toolbar",[function(){function a(a){f=a}function b(){return f}function c(a){e=a}function d(){e&&e.toggle()}var e,f=[{name:"",click:function(){}}];return{setTitles:a,getTitles:b,setSideNave:c,toggleSideNave:d}}]);var ngApp=angular.module("management");ngApp.config(["$routeProvider","$locationProvider",function(a,b){a.when("/datasources/add/mssql/:type/:packageId?/:id?",{templateUrl:app.urlPrefix+"dist/partial/management/datasource/mssql.html?v="+app.version,controller:"datasourceMssqlCtrl"}).when("/datasources/add/file/:packageId?/:id?",{templateUrl:app.urlPrefix+"dist/partial/management/datasource/file.html?v="+app.version,controller:"datasourcefileCtrl"}).when("/datasources/add/web/:packageId?/:id?",{templateUrl:app.urlPrefix+"dist/partial/management/datasource/web.html?v="+app.version,controller:"datasourceWebCtrl"}).when("/datasources/add/join/:packageId?/:id?",{templateUrl:app.urlPrefix+"dist/partial/management/datasource/join.html?v="+app.version,controller:"datasourceJoinCtrl"}).when("/datasources/new/:id?",{templateUrl:app.urlPrefix+"dist/partial/management/datasource/new.html?v="+app.version,controller:"datasourceNewCtrl"}).when("/datasources/:id?",{templateUrl:app.urlPrefix+"dist/partial/management/datasource/list.html?v="+app.version,controller:"datasourceListCtrl"}).when("/datasourceJoin",{templateUrl:app.urlPrefix+"dist/partial/management/datasource/interRelation.html?v="+app.version,controller:"interRelationCtrl"}).when("/charts/:id?",{templateUrl:app.urlPrefix+"dist/partial/management/charts/list.html?v="+app.version,controller:"chartsListCtrl"}).when("/charts/edit/:packageId?/:id?",{templateUrl:app.urlPrefix+"dist/partial/management/charts/editor.html?v="+app.version,controller:"chartsEditorCtrl"}).when("/charts/new/:type/:packageId/:datasourceId?",{templateUrl:app.urlPrefix+"dist/partial/management/charts/editor.html?v="+app.version,controller:"chartsEditorCtrl"}).when("/variables",{templateUrl:app.urlPrefix+"dist/partial/management/datasource/list.html?v="+app.version,controller:"datasourceCtrl"}).when("/users",{templateUrl:app.urlPrefix+"dist/partial/management/account/userList.html?v="+app.version,controller:"usersListCtrl"}).when("/users/edit/:id?",{templateUrl:app.urlPrefix+"dist/partial/management/account/userEdit.html?v="+app.version,controller:"userEditCtrl"}).when("/roles",{templateUrl:app.urlPrefix+"dist/partial/management/account/roleList.html?v="+app.version,controller:"rolesListCtrl"}).when("/roles/edit/:id?",{templateUrl:app.urlPrefix+"dist/partial/management/account/roleEdit.html?v="+app.version,controller:"roleEditCtrl"}).when("/variables",{templateUrl:app.urlPrefix+"dist/partial/management/account/variables.html?v="+app.version,controller:"variablesCtrl"}).when("/settings/update",{templateUrl:app.urlPrefix+"dist/partial/management/account/update.html?v="+app.version,controller:"updateCtrl"}).when("/settings/mail",{templateUrl:app.urlPrefix+"dist/partial/management/account/mail.html?v="+app.version,controller:"mailCtrl"}).when("/settings",{templateUrl:app.urlPrefix+"dist/partial/management/account/settings.html?v="+app.version,controller:"settingsCtrl"}).when("/onlineUsers",{templateUrl:app.urlPrefix+"dist/partial/management/account/onlineUsers.html?v="+app.version,controller:"onlineUsersCtrl"}).when("/licence",{templateUrl:app.urlPrefix+"dist/partial/management/account/licence.html?v="+app.version,controller:"licenceCtrl"}).when("/activeDirectory",{templateUrl:app.urlPrefix+"dist/partial/management/account/activeDirectory.html?v="+app.version,controller:"activeDirectoryCtrl",controllerAs:"ad"}).when("/syncUserVariablesList",{templateUrl:app.urlPrefix+"dist/partial/management/account/syncUserVariablesList.html?v="+app.version,controller:"syncUserVariablesListCtrl",controllerAs:"cnl"}).when("/syncUserVariablesDetail/:id?",{templateUrl:app.urlPrefix+"dist/partial/management/account/syncUserVariablesDetail.html?v="+app.version,controller:"syncUserVariablesDetailCtrl",controllerAs:"cnl"}).otherwise({redirectTo:"datasources"})}]);var ngApp=angular.module("management");ngApp.service("templates",[function(){var a={package_dialog:app.urlPrefix+"dist/partial/management/packages/select-package.html"};return{tmpl:a}}]);var ngApp=angular.module("management");ngApp.controller("activeDirectoryCtrl",["$scope","$http","$sce","$timeout","$mdToast","toolbar","$translate","utils","roles",function(a,b,c,d,e,f,g,h,i){var j=this;a.utils=h,a.app=app,g("Active Directory Integration").then(function(b){a.listTranslate=b,f.setTitles([{name:b,onclick:function(){}}])}),j.bindOption=2,i.get().then(function(a){j.roles=a.data.list}),this.getList=function(){j.progress=!0,b.post(app.urlPrefix+"api/activedirectory/GetUserList",JSON.stringify({server:j.server,user:j.user,pass:j.pass,container:j.container,bindOption:j.bindOption})).then(function(a){j.progress=!1,j.data=a.data},function(a){h.showErrorToast(a.data.desc),j.progress=!1})},this.selectAll=function(a){_.forEach(j.data,function(b){b.select=a})},this.saveSelectedUsers=function(){j.saveProgress=!0;var a=_.filter(j.data,{select:!0}).map(function(a){return{server:a.server,user:a.SamAccountName,pass:a.DisplayName,container:j.container,bindOption:j.bindOption}}),d=_.filter(j.roles,{check:!0});b.post(app.urlPrefix+"api/activedirectory/SaveUsers",JSON.stringify({users:a,roles:d})).then(function(a){if(j.saveProgress=!1,a.data&&a.data.length)j.error=c.trustAsHtml("<ul><li>"+a.data.map(function(a){return a.user+", "}).join("</li><li>")+"</li></ul>");else{var b=e.simple().textContent("کاربرهای انتخاب شده با موفقیت به سیستم اضافه شدند");e.show(b)}j.data=null},function(a){h.showErrorToast(a.data.desc),j.saveProgress=!1})}}]);var ngApp=angular.module("management");ngApp.controller("syncUserVariablesListCtrl",["$scope","$http","$sce","$timeout","$mdToast","toolbar","$translate","utils","roles","$mdDialog",function(a,b,c,d,e,f,g,h,i,j){function k(a){e.show({template:'<md-toast class="md-toast error"> <span class="md-toast-text" flex>'+a+"</span></md-toast>",hideDelay:3e3,position:"bottom left"})}var l=this;l.utils=h,l.app=app;g("User Variable Sync").then(function(b){a.listTranslate=b,f.setTitles([{name:b,onclick:function(){}}])}),l.progress=!0,b.get(app.urlPrefix+"api/syncUserVariables/get").then(function(a){l.progress=!1,l.data=a.data},function(){l.progress=!1,k("خطایی در دریافت اطلاعات رخ داده است")}),l.sync=function(a,c){c.progress=!0,b.get(app.urlPrefix+"api/syncUserVariables/sync?id="+c.Id).then(function(a){c.progress=!1,c.LastRefresh=a.data.LastRefresh,e.show(e.simple().textContent(" منبع داده "+c.DatasourceName+"  و متغیر "+c.VariableName+" با موفقیت همگام شدند"))},function(){c.progress=!1,k("خطایی در همگام‌سازی رخ داده است")})},l["delete"]=function(a,c){var d=j.confirm().title("حذف برای همیشه؟").textContent("آیا ارتباط بین منبع داده "+c.DatasourceName+"  و متغیر "+c.VariableName+" حذف شود؟").ariaLabel("حذف").targetEvent(a).ok("حذف!").cancel("لغو");j.show(d).then(function(){b.get(app.urlPrefix+"api/syncUserVariables/delete?id="+c.Id).then(function(a){e.show(e.simple().textContent("عملیات با موفقیت به اتمام رسید")),_.remove(l.data,{Id:c.Id})},function(){k("خطایی در حذف رخ داده است")})})}}]),ngApp.controller("syncUserVariablesDetailCtrl",["$scope","$http","$sce","$timeout","$mdToast","toolbar","$translate","utils","datasources","$routeParams",function(a,b,c,d,e,f,g,h,i,j){function k(a){n.getInfoProgress=!1,n.error=a.data.desc}function l(){n.error=null}function m(a){e.show({template:'<md-toast class="md-toast error"> <span class="md-toast-text" flex>'+a+"</span></md-toast>",hideDelay:3e3,position:"bottom left"})}var n=this;a.utils=h,a.app=app;var o="undefined"!=typeof j.id?j.id:0;if(g("User Variable Sync").then(function(b){a.listTranslate=b,f.setTitles([{name:b,onclick:function(){}}])}),o>0){n.getInfoProgress=!0;var p=app.urlPrefix+"api/syncUserVariables/get?id="+o;b.get(p).then(function(a){n.userProperties=[],n.selectedDatasource={id:a.data.DatasourceId,name:a.data.DatasourceName},n.usernameColumn=a.data.UsernameColumn,n.variableValueColumn=a.data.VariableValueColumn,n.variableName=a.data.VariableName,n.getColumns()},function(a){k(a)})}n.selectDatasource=function(a){i.select(a,{type:["datasources"]}).then(function(a){l(),n.selectedDatasource=a.selected[0],n.getColumns()})},n.getColumns=function(){i.getColumns(n.selectedDatasource.id).then(function(a){n.getInfoProgress=!1,n.datasourceColumns=a.CubeInfo.Dimensions[0].Hierarchies,n.userProperties=a.UsersProperty},function a(b){a(b)})},n.saveAndSync=function(c){return a.syncForm.$valid?(n.syncProgress=!0,n.syncError=null,n.effectedUsers=null,void b.post(app.urlPrefix+"api/syncUserVariables/saveAndSync",{id:o,datasourceId:n.selectedDatasource.id,usernameColumn:n.usernameColumn,variableValueColumn:n.variableValueColumn,variableName:n.variableName}).then(function(a){n.syncProgress=!1,n.effectedUsers=a.data.effected,o=a.data.id,e.show(e.simple().textContent("عملیات با موفقیت به اتمام رسید"))},function(a){n.syncProgress=!1,n.syncError=a.data.desc,m("خطایی در روند همگام سازی به وجود آمده است")})):void m("فیلدهای ضروری باید پر شوند")}}]);var ngApp=angular.module("management");ngApp.controller("licenceCtrl",["$scope","$http","$sce","$timeout","$mdToast","toolbar","$translate","utils",function(a,b,c,d,e,f,g,h){a.utils=h,g("licence_manager").then(function(b){a.listTranslate=b,f.setTitles([{name:b,onclick:function(){}}])}),a.progress=!0,b.get(app.urlPrefix+"api/licence/get").then(function(b){a.progress=!1,a.data=b.data}),a.clear=function(){b.get(app.urlPrefix+"api/licence/clear").then(function(a){window.location=app.urlPrefix+"Account/LogOff"})}}]);var ngApp=angular.module("management");ngApp.controller("mailCtrl",["$scope","$http","$sce","$timeout","$mdToast",function(a,b,c,d,e){a.save=function(d){a.progress=!0,a.message=null,a.error=null,b.post(app.urlPrefix+"Moderation/Settings/Mail",JSON.stringify({port:a.port,host:a.host,ssl:a.ssl,timeout:a.timeout,username:a.username,password:a.password}),{headers:{"Content-Type":"application/json; charset=utf-8"}}).then(function(b){if(a.progress=!1,b.data.result){window.history.back();var d=e.simple().textContent("تغییرات ثبت شد");e.show(d)}else a.message=null,a.error=c.trustAsHtml(b.data.error)},function(b){a.progress=!1,a.message=null,a.error=c.trustAsHtml(b.data.desc)})},a.test=function(d){a.error=null,a.message=null,a.progress=!0,b.post(app.urlPrefix+"Moderation/Settings/Test",JSON.stringify({port:a.port,host:a.host,ssl:a.ssl,timeout:a.timeout,username:a.username,password:a.password}),{headers:{"Content-Type":"application/json; charset=utf-8"}}).then(function(b){if(a.progress=!1,b.data.result){a.message=c.trustAsHtml("ارسال پست الکترونیک با اطلاعات وارد درست است");var d=e.simple().textContent("ارسال پست الکترونیک با اطلاعات وارد درست است");e.show(d)}else a.message=null,a.error=c.trustAsHtml(b.data.error)},function(b){a.progress=!1,a.message=null,a.error=c.trustAsHtml(b.data.desc)})},a.infoProgress=!0,b.get(app.urlPrefix+"api/settings/getMailInfo").then(function(b){a.infoProgress=!1;var c=b.data;a.port=c.port,a.host=c.host,a.ssl=c.ssl,a.timeout=c.timeout,a.username=c.username,a.password=c.password},function(b){a.infoProgress=!1,a.error=c.trustAsHtml(b.data.desc)})}]);var ngApp=angular.module("management");ngApp.controller("onlineUsersCtrl",["$scope","$http","$sce","$timeout","$mdToast","toolbar","$translate","utils",function(a,b,c,d,e,f,g,h){a.utils=h,g("online_users").then(function(b){a.listTranslate=b,f.setTitles([{name:b,onclick:function(){}}])}),a.kick=function(a){b.get(app.urlPrefix+"api/onlineusers/kick/"+a.id).then(function(a){})},a.progress=!0,b.get(app.urlPrefix+"api/onlineusers/get").then(function(b){a.progress=!1,a.data=b.data})}]);var ngApp=angular.module("management");ngApp.controller("roleEditCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$translate","$sce","roles","menus","utils","datasources",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){function o(b){a.error=j.trustAsHtml("<b>"+b.data.title+"</b> <br/>"+b.data.desc)}function p(){a.model&&a.users&&a.menus&&(a.model.FirstMenuId=a.model.FirstMenuId+"",a.model.FunctionalActions&&_.forEach(a.actions,function(b){_.forEach(b.childes,function(b){b.check=-1!=a.model.FunctionalActions.indexOf(b.id)})}),_.forEach(a.users,function(b){b.check=-1!=a.model.Users.indexOf(b.id)}),_.forEach(a.model.MenuActions,function(b){var c=b.split("-").map(function(a){return+a}),d=c[0],e=c[1];_.forEach(a.menus,function(a,b){var c=_.find(a,{id:e});return c?(c.action=d,c.check=!0,!1):void 0})}),a.datasources=a.model.DatasourceActions.map(function(a){return JSON.parse(a)}),a.charts=a.model.ChartActions.map(function(a){return JSON.parse(a)}),_.forEach(a.model.MenuCategoryActions,function(b){var c=b.split("-").map(function(a){return+a}),d=c[0],e=c[1];a.menuCategoriesAction[e]=d}),a.forms=a.model.forms)}function q(a){c.show({template:'<md-toast class="md-toast error"> <span class="md-toast-text" flex>'+a+"</span></md-toast>",hideDelay:3e3,position:"bottom left"})}var r={ChartAdd:1,ChartView:2,ChartEdit:3,ChartDelete:4,MenuAdd:5,MenuView:6,MenuEdit:7,MenuDelete:8,DataSourceAdd:9,DataSourceView:10,DataSourceEdit:11,DataSourceDelete:12,FormAdd:22,FormView:23,FormEdit:24,FormDelete:25,AdminAccessOnCharts:13,AdminAccessOnMenus:14,AdminAccessOnDataSources:15,AdminAccessOnForms:21,DashboardAddDeleteArragneCharts:16,ManageAllUsersAndRoles:17,ViewManageMainMenu:18,ArrangeMenus:19};a.actions=[{title:"مدیریت نمودارها",childes:[{id:r.ChartAdd,name:"ساخت نمودار جدید"},{id:r.ChartView,name:"مشاهده نمودار"},{id:r.ChartEdit,name:"ویرایش نمودار"},{id:r.ChartDelete,name:"حذف نمودار"}]},{title:"مدیریت منوها",childes:[{id:r.MenuAdd,name:"ساخت منوی جدید"},{id:r.MenuView,name:"مشاهده منو"},{id:r.MenuEdit,name:"ویرایش منو"},{id:r.MenuDelete,name:"حذف منو"}]},{title:"مدیریت فرم‌ها",childes:[{id:r.FormAdd,name:"ساخت فرم جدید"},{id:r.FormView,name:"مشاهده فرم"},{id:r.FormEdit,name:"ویرایش فرم"},{id:r.FormDelete,name:"حذف فرم"}]},{title:"مدیریت منابع داده",childes:[{id:r.DataSourceAdd,name:"ساخت منبع داده‌ی جدید"},{id:r.DataSourceView,name:"مشاهده منبع داده"},{id:r.DataSourceEdit,name:"ویرایش منبع داده"},{id:r.DataSourceDelete,name:"حذف منبع داده"}]},{title:"مدیریت صفحات داشبوردی و کاربران و نقش‌ها",childes:[{type:"input",id:r.ArrangeMenus,name:"تغییر ترتیب منوها"},{type:"input",id:r.ManageAllUsersAndRoles,name:"مدیریت کاربران و نقش‌ها"}]},{title:"دسترسی کامل",childes:[{type:"input",id:r.AdminAccessOnCharts,name:"دسترسی کامل به تمام نمودارها"},{type:"input",id:r.AdminAccessOnMenus,name:"دسترسی کامل به تمام منوها"},{type:"input",id:r.AdminAccessOnDataSources,name:"دسترسی کامل به تمام منابع داده"},{type:"input",id:r.AdminAccessOnForms,name:"دسترسی کامل به تمام فرم‌ها"}]}];var s="undefined"!=typeof e.id?e.id:0,t=s>0;a.id=s,a.isEdit=t,l.get().then(function(b){_.forEach(b.data,function(a){a.check=!1}),a.menus=_.groupBy(b.data,function(a){return JSON.stringify({name:a.parent,id:a.parentId})}),_.forEach(a.menus,function(a){_.forEach(a,function(a){a.action=1})}),a.menuCategoriesAction={},p()}),a.jsonParse=function(a){return JSON.parse(a)},a.setViewPermission=function(b,c){var d=JSON.parse(b).id;_.some(c,{check:!0})?a.menuCategoriesAction[d]=a.menuCategoriesAction[d]||1:delete a.menuCategoriesAction[d]},b.get(app.urlPrefix+"api/users/get").then(function(b){a.progress=!1,a.users=b.data,p()},m.error),a.datasources=[],a.addDatasource=function(b){n.select(b,{type:["datasources"],multipleDatasource:!0}).then(function(b){var c=_.filter(b.selected,function(b){return!_.some(a.datasources,{id:b.id})});a.datasources=a.datasources.concat(c.map(function(a){return{id:a.id,name:a.name,action:1}}))})},a.clearDatasources=function(){a.datasources=[]},a.charts=[],a.addChart=function(b){n.select(b,{type:["charts"]}).then(function(b){var c=_.filter(b.selected,function(b){return!_.some(a.charts,{id:b.id})});a.charts=a.charts.concat(c.map(function(a){return{id:a.id,name:a.name,action:1}}))})},a.clearCharts=function(){a.charts=[]},a.datasourceActionAll=1,a.chartActionAll=1,a.actionAll=function(b,c){var d="datasource"==b?a.datasources:a.charts;"datasource"==b?a.datasourceActionAll:a.chartActionAll;_.forEach(d,function(a){a.action=+c})},t&&b.get(app.urlPrefix+"api/roles/get?id="+s).then(function(b){a.model=b.data,p()},o),a.saveProgress=!1,a.save=function(){return a.error=null,a.testResult=null,a.roleForm.$valid?(a.model.DatasourceActions=a.datasources.map(function(a){return a.action+"-"+a.id}),a.model.ChartActions=a.charts.map(function(a){return a.action+"-"+a.id}),a.model.Users=_.filter(a.users,{check:!0}).map(function(a){return a.id}),a.model.forms=a.forms?a.forms.map(function(a){return{id:a.id,action:a.action,recordPermission:a.recordPermission}}):[],a.model.MenuActions=[],_.forEach(a.menus,function(b){var c=_.filter(b,{check:!0});_.forEach(c,function(b){a.model.MenuActions.push(b.action+"-"+b.id)})}),a.model.MenuCategoryActions=[],_.forEach(a.menuCategoriesAction,function(b,c){+b&&a.model.MenuCategoryActions.push(b+"-"+c)}),a.model.FunctionalActions=[],_.forEach(a.actions,function(b){var c=_.filter(b.childes,{check:!0});_.forEach(c,function(b){a.model.FunctionalActions.push(b.id)})}),a.saveProgress=!0,void b.post(app.urlPrefix+"api/roles/edit",a.model).then(function(b){a.saveProgress=!1,k.reset(),i(["new_role_created","edit_complete"]).then(function(a){var b=c.simple().textContent(t?a.edit_complete:a.new_role_created);c.show(b)}),f.path("/roles")},function(b){a.saveProgress=!1,a.error=j.trustAsHtml("<b>"+b.data.title+"</b> <br/>"+b.data.desc)})):(a.roleForm.$setSubmitted(),void i("form_invalid").then(function(a){q(a)}))},a.checkAll=function(a){_.forEach(a.childes,function(b){b.check=a.checkAll})},a.addFormSettings={},a.onFormSelect=function(b,c){a.forms=a.forms||[],_.each(b,function(b){_.some(a.forms,{id:b.id})||a.forms.push({id:b.id,name:b.name,action:1})}),h(function(){c.visible=!1},0)}}]),ngApp.directive("formPremission",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel"},controller:["$scope","$http","formsService",function(a,b,c){}],template:'<div class="ui mini input">                        <sm-dropdown model="model" class="multiple selection" items="[                                                            {k:\'رکورد جدید \', v:5},                                                            {k:\'ویرایش رکورد\', v:6},                                                            {k:\'حذف رکورد\', v:7},                                                          ]" label="item.k" value="item.v" default-text="asdasd"></sm-dropdwon>                    </div>',link:function(a,b,c){}}});var ngApp=angular.module("management");
ngApp.controller("rolesListCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$translate","utils","roles","toolbar",function(a,b,c,d,e,f,g,h,i,j,k,l){a.utils=j,i("لیست نقش‌ها").then(function(a){l.setTitles([{name:a,click:function(){f.path("/roles")}}])}),a.progress=!0,k.get().then(function(b){a.progress=!1,a.data=b.data.list}),a.isSelected=function(){return _.some(a.data,{select:!0})},a["new"]=function(a){f.path("roles/edit")},a["delete"]=function(e){var f=app.urlPrefix+"api/roles/delete",g=_.filter(a.data,{select:!0}).map(function(a){return a.id}),h=d.confirm().title("حذف برای همیشه؟").textContent(g.length+" مورد برای حذف انتخاب شده است").ariaLabel("حذف").targetEvent(e).ok("حذف!").cancel("لغو");d.show(h).then(function(){b.post(f,g).then(function(b){a.data=_.filter(a.data,function(a){return-1==b.data.indexOf(a.id)});var d=c.simple().textContent("حذف انجام شد");c.show(d)},function(a){j.showErrorToast(a.data.desc)})})},a["goto"]=function(a,b){f.path("roles/edit/"+a.id)};var m;a.$watch("search",function(){h.cancel(m),m=h(function(){"undefined"!=typeof a.search&&(a.progress=!0,b.get(app.urlPrefix+"api/roles/get?query="+a.search).then(function(b){a.progress=!1,a.data=b.data.list}))},400)}),a.selectAll=function(){a.data&&_.forEach(a.data,function(b){b.select=a.selectAllCheckbox})}}]);var ngApp=angular.module("management");ngApp.controller("settingsCtrl",["$scope","$http","$sce","$timeout","$mdToast",function(a,b,c,d,e){a.saveProgress=!1,a.langs=[{key:0,value:"فارسی"},{key:1,value:"English"}],a.save=function(d){a.saveProgress=!0,b.post(app.urlPrefix+"Moderation/Settings/GeneralSettings",JSON.stringify({Brand:a.brand,Language:a.language}),{headers:{"Content-Type":"application/json; charset=utf-8"}}).success(function(b){if(a.saveProgress=!1,b.result){var d=e.simple().textContent("تغییرات ثبت شد");e.show(d)}else a.error=c.trustAsHtml(b.error)})},b.get(app.urlPrefix+"api/settings/getGeneralInfo").then(function(b){var c=b.data.model;c&&(a.brand=c.Brand,a.language=c.Language)})}]);var ngApp=angular.module("management");ngApp.controller("updateCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$translate","utils","datasources",function(a,b,c,d,e,f,g,h,i,j,k){a.progress=!0,b.get(app.urlPrefix+"api/users/get").then(function(b){a.progress=!1,a.data=b.data},j.error),j.onError(function(b){a.error=b,a.progress=!1}),a.isSelected=function(){return _.some(a.data,{select:!0})},a["new"]=function(a){f.path("users/edit")},a["delete"]=function(e){var f=app.urlPrefix+"api/users/delete",g=_.filter(a.data,{select:!0}).map(function(a){return a.id}),h=d.confirm().title("حذف برای همیشه؟").textContent(g.length+" مورد برای حذف انتخاب شده است").ariaLabel("حذف").targetEvent(e).ok("حذف!").cancel("لغو");d.show(h).then(function(){b.post(f,g).then(function(b){a.data=_.filter(a.data,function(a){return-1==b.data.indexOf(a.id)});var d=c.simple().textContent("حذف انجام شد");c.show(d)},function(a){j.showErrorToast(a.data.desc)})})},a["goto"]=function(a,b){f.path("users/edit/"+a.id)};var l;a.$watch("search",function(){h.cancel(l),l=h(function(){"undefined"!=typeof a.search&&(a.progress=!0,b.get(app.urlPrefix+"api/users/get?query="+a.search).then(function(b){a.progress=!1,a.data=b.data}))},400)}),a.selectAll=function(){a.data&&_.forEach(a.data,function(b){b.select=a.selectAllCheckbox})}}]);var ngApp=angular.module("management");ngApp.controller("userEditCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$translate","$sce","roles",function(a,b,c,d,e,f,g,h,i,j,k){function l(b){a.error=j.trustAsHtml("<b>"+b.data.title+"</b> <br/>"+b.data.desc)}function m(){a.model&&a.roles&&_.forEach(a.roles,function(b){-1!=a.model.Roles.indexOf(b.id)&&(b.check=!0)})}function n(a){c.show({template:'<md-toast class="md-toast error"> <span class="md-toast-text" flex>'+a+"</span></md-toast>",hideDelay:3e3,position:"bottom left"})}var o="undefined"!=typeof e.id?e.id:0,p=o>0;a.id=o,a.isEdit=p,a.app=app,k.get().then(function(b){a.roles=angular.merge({},b.data.list),_.forEach(a.roles,function(a){a.action=1,a.check=!1}),m()}),a.props=[],p&&b.get(app.urlPrefix+"api/users/get?id="+o).then(function(b){a.model=b.data,a.model.Properties&&(a.props=JSON.parse(a.model.Properties)),m()},l),b.get(app.urlPrefix+"api/users/getPropertyAutoCompleteEntries").then(function(b){a.auto=b.data,a.auto.flatValues=[],_.each(a.auto.values,function(b){_.each(b.values,function(b){-1==a.auto.flatValues.indexOf(b)&&a.auto.flatValues.push(b)})})},l),a.saveProgress=!1,a.save=function(){return a.error=null,a.testResult=null,a.userForm.$valid?(a.model.Roles=_.filter(a.roles,{check:!0}).map(function(a){return a.id}),a.model.Properties=JSON.stringify(_.map(a.props,function(a){return{Key:a.Key,Value:a.Value}})),a.saveProgress=!0,void b.post(app.urlPrefix+"api/users/edit",a.model).then(function(b){a.saveProgress=!1;var d=c.simple().textContent(p?"تغییرات ثبت شد":"منبع داده جدید ایجاد شد");c.show(d),f.path("/users")},function(b){a.saveProgress=!1,a.error=j.trustAsHtml("<b>"+b.data.title+"</b> <br/>"+b.data.desc)})):void i("form_invalid").then(function(a){n(a)})},$("#user-expire-time").datepicker({changeMonth:!0,changeYear:!0,dateFormat:"yy/mm/dd",onClose:function(a,b){}})}]);var ngApp=angular.module("management");ngApp.controller("usersListCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$translate","utils","datasources","toolbar",function(a,b,c,d,e,f,g,h,i,j,k,l){a.utils=j,i("لیست کاربران").then(function(a){l.setTitles([{name:a,click:null}])}),a.progress=!0,b.get(app.urlPrefix+"api/users/get").then(function(b){a.progress=!1,a.data=b.data},j.error),j.onError(function(b){a.error=b,a.progress=!1}),a.isSelected=function(){return _.some(a.data,{select:!0})},a["new"]=function(a){f.path("users/edit")},a["delete"]=function(e){var f=app.urlPrefix+"api/users/delete",g=_.filter(a.data,{select:!0}).map(function(a){return a.id}),h=d.confirm().title("حذف برای همیشه؟").textContent(g.length+" مورد برای حذف انتخاب شده است").ariaLabel("حذف").targetEvent(e).ok("حذف!").cancel("لغو");d.show(h).then(function(){b.post(f,g).then(function(b){a.data=_.filter(a.data,function(a){return-1==b.data.indexOf(a.id)});var d=c.simple().textContent("حذف انجام شد");c.show(d)},function(a){j.showErrorToast(a.data.desc)})})},a["goto"]=function(a,b){f.path("users/edit/"+a.id)};var m;a.$watch("search",function(){h.cancel(m),m=h(function(){"undefined"!=typeof a.search&&(a.progress=!0,b.get(app.urlPrefix+"api/users/get?query="+a.search).then(function(b){a.progress=!1,a.data=b.data}))},400)}),a.selectAll=function(){a.data&&_.forEach(a.data,function(b){b.select=a.selectAllCheckbox})}}]);var ngApp=angular.module("management");ngApp.controller("variablesCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$translate","utils","datasources","$mdMedia","toolbar",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(a){return a.DefaultValue=JSON.parse(a.DefaultValue),a.DefaultValue&&(a.DefaultValue=a.DefaultValue.map(function(a){return a.replace(/\[(index|calc)-\d+\]/gim,"")})),a}function o(a,b){return d.show({controller:["$scope","$mdDialog","$timeout",function(a,c,d){a.cancel=function(){c.cancel()},a.select=function(){return a.gbForm.$valid?void c.hide(a.model):void a.gbForm.$setSubmitted()},a.model={Name:"",Scope:0,DefaultValue:[]},b&&(a.model=angular.merge({},b))}],parent:angular.element(document.body),targetEvent:a,clickOutsideToClose:!0,fullscreen:l("sm")||l("xs"),template:'<md-dialog aria-label="{{\'choose\' | translate}}" ng-cloak >                                                                               <md-toolbar md-theme="default">                                                                                                                            <div class ="md-toolbar-tools">                                                                                                         <h2>{{\'choose\' | translate}}</h2>                                                                                                 <span flex></span>                                                                                                                  <span class ="material-icons" ng-click="cancel()">close</span>                                                                  </div>                                                                                                                          </md-toolbar>                                                                                                                       <md-dialog-content>                                                                                                                     <div class ="md-dialog-content" flex>                                                                                               <form name="gbForm">                                                                                                                   <div layout="row" layout-align="start center">                                                                                           <md-input-container flex="50" >                                                                                                         <label>{{\'name\' | translate}}</label>                                                                                             <input required name="name" ng-model="model.Name" md-autofocus>                                                                     <div ng-messages="gbForm.name.$error" ng-if=\'gbForm.$submitted || gbForm.name.$touched\'>                                            <div ng-message="required">{{\'form_username_required\' | translate}}</div>                                                       </div>                                                                                                                          </md-input-container>                                                                                                               <md-input-container flex="50">                                                                                                          <label>{{\'scope\' | translate}}</label>                                                                                            <md-select  ng-model="model.Scope">                                                                                                     <md-option value="0">{{\'scope_all_page\' | translate}}</md-option>                                                                 <md-option value="1">{{\'scope_current_page\' | translate}}</md-option>                                                         </md-select>                                                                                                                    </md-input-container>                                                                                                       </form>                                                                                                                             </div>                                                                                                                                                                                                                                                                     <md-chips flex ng-model="model.DefaultValue"                                                                                             ng-click=" $event.stopPropagation()"                                                                                                ng-change="row"                                                                                                                     placeholder="{{\'insert_user_prop_value\' | translate}}"                                                                            delete-button-label="{{\'delete_user_prop_value\' | translate}}"                                                                    delete-hint="{{\'press_delete_user_prop_value\' | translate}}"                                                                      secondary-placeholder="{{\'add_user_prop_value\' | translate}}"></md-chips>                                                                                                                                                                                     </div>                                                                                                                          </md-dialog-content>                                                                                                                <md-dialog-actions layout="row">                                                                                                        <md-button ng-click="select()" >                                                                                                        {{\'choose\' | translate}}                                                                                                      </md-button>                                                                                                                        <md-button ng-click="cancel()">                                                                                                         {{\'cancel\' | translate}}                                                                                                      </md-button>                                                                                                                    </md-dialog-actions>                                                                                                        </md-dialog>'})}a.utils=j,i("متغیرهای سراسری").then(function(a){m.setTitles([{name:a,click:null}])}),a.progress=!0,b.get(app.urlPrefix+"moderation/globalvariable/getlist").then(function(b){a.progress=!1,a.data=b.data,a.data=a.data.map(function(a){return n(a)})},j.error),j.onError(function(b){a.error=b,a.progress=!1}),a.isSelected=function(){return _.some(a.data,{select:!0})},a["new"]=function(d){o(d).then(function(d){b.post(app.urlPrefix+"moderation/globalvariable/add",d).then(function(b){a.data=a.data||[],a.data.push(n(b.data)),i("new_variable_created").then(function(a){var b=c.simple().textContent(a);c.show(b)})})})},a["delete"]=function(e){var f=app.urlPrefix+"moderation/globalvariable/deleteAll",g=_.filter(a.data,{select:!0}).map(function(a){return a.Id}),h=d.confirm().title("حذف برای همیشه؟").textContent(g.length+" مورد برای حذف انتخاب شده است").ariaLabel("حذف").targetEvent(e).ok("حذف!").cancel("لغو");d.show(h).then(function(){b.post(f,g).then(function(b){a.data=_.filter(a.data,function(a){return-1==b.data.indexOf(a.Id)}),i("delete_complete").then(function(a){var b=c.simple().textContent(a);c.show(b)})},function(a){j.showErrorToast(a.data.desc)})})},a["goto"]=function(a,d){o(d,a).then(function(d){b.post(app.urlPrefix+"moderation/globalvariable/add",d).then(function(b){a.DefaultValue=n(b.data).DefaultValue,i("edit_complete").then(function(a){var b=c.simple().textContent(a);c.show(b)})})})};var p;a.$watch("search",function(){h.cancel(p),p=h(function(){"undefined"!=typeof a.search&&(a.progress=!0,b.get(app.urlPrefix+"api/users/get?query="+a.search).then(function(b){a.progress=!1,a.data=b.data}))},400)}),a.selectAll=function(){a.data&&_.forEach(a.data,function(b){b.select=a.selectAllCheckbox})}}]),function(){function a(a,b){var c=1,d=b.map(function(a){return a.toLowerCase()});if(-1==d.indexOf(a.toLowerCase()))return a;for(;-1!=d.indexOf(a.toLowerCase()+c);)c++;return a+c}function b(a,b){return a.filter(function(a){return!a.type||"kpi"!=a.type&&"measure"!=a.type}).map(function(a){return{Name:a.Name,UniqueName:a.UniqueName,Top:a.Top,sortOrder:a.sortOrder,sortKey:a.sortKey,sortFormula:a.sortFormula,formula:a.formula,aggregation:a.aggregation,Members:a.members&&a.members.list?a.members.list.filter(function(a){return a.Checked}).map(function(a){return b?a.UniqueName:a.Name}):[],UserProperties:a.userProperty?a.userProperty.filter(function(a){return a.Checked}).map(function(a){return a.Name}):[],GlobalViariable:a.globalVariable?a.globalVariable.filter(function(a){return a.Checked}).map(function(a){return a.Id}):[],NumericFilter:a.members?JSON.stringify(a.members.numericFilter):"",IsNumeric:a.members?a.members.isNumeric:!1}})}function c(a,b){for(var c in a)try{var d=a[c].series;if("undefined"==typeof d||!d||!a.hasOwnProperty(c))continue;if(c!=j[b]){delete a[c];continue}for(var e in d)d.hasOwnProperty(e)&&-1==a.series.indexOf(e)&&delete d[e]}catch(f){}}function d(a,b,c,d,e){_.isUndefined(a.tree)||_.remove(a.tree.dimensions,function(a){return _.isUndefined(_.find(c,{Name:a.name}))});var f=j[+b];return a[f]||(a[f]=i[f]),a[f]}function e(b,c,d,e){var f="SUM("+b.UniqueName+")",g="SUM";if(!b.IsNumeric&&(f=""+b.UniqueName,g="NONE",!e.measures.length))var f="COUNT("+b.UniqueName+")",g="COUNT";b.Top={IsTop:!1,Top:10,IsPercent:!1,TopOrder:"DESC"};var h=$.extend({},b,{formula:f,aggregation:g});return-1==d.info.aggregation&&(h.formula=b.UniqueName,h.aggregation="NONE"),h.Name=a(b.Name,c.map(function(a){return a.Name})),h}function f(b,c){var d=$.extend({},b,{sortOrder:"ASC",sortKey:"NONE",sortFormula:b.UniqueName,formula:b.UniqueName});return d.Name=a(b.Name,c.map(function(a){return a.Name})),d}function g(b,c){var d=$.extend({},b,{sortOrder:"ASC",sortKey:"NONE",formula:b.UniqueName});return d.Name=a(b.Name,c.map(function(a){return a.Name})),d}function h(a){var b=a.chartType,c=a.chartProp[j[+b]];switch(+b){case chartTypes.UserControl:return"datepicker"==c.info.type||"datepicker-range"==c.info.type||"text"==c.info.type?{needDim:!0,needMeasure:!1,needServerData:!1}:{needDim:!0,needMeasure:!1,needServerData:!0};case chartTypes.Tree:return{needDim:!0,needMeasure:!1,needServerData:!0};case chartTypes.TABLE:return-1==+c.info.aggregation?{needDim:!0,needMeasure:!1,needServerData:!0}:{needDim:!0,needMeasure:!0,needServerData:!0};default:return{needDim:!0,needMeasure:!0,needServerData:!0}}}var i={bar:{info:{aggregation:"1",canExportXlsx:!0,refreshPeriod:"0",horizontalLines:!0,sortMeasures:!1,showSortBox:!0,formatString:",.0f",stackedBar:"1",stackedLine:"1",tooltip:"2",tooltipHeader:"{{set.key}}",tooltipFormat:'{{point.label}}: <span class="ltr inline" style="padding:0; margin:0;"><b>{{point.data}}</b></span>',xAxisLen:20,font:{bold:!1,color:"#333333",italic:!1,fontSize:"12px",fontName:"IRANSans",formatString:",.0f",formatStringCustom:",.0f"}}},map:{info:{aggregation:"1",canExportXlsx:!0,refreshPeriod:"0",borderColor:"#666666",tooltip:"3",tooltipFormat:'{{point.label}}: <span class="ltr inline" style="padding:0; margin:0;"><b>{{point.data}}</b></span>',tooltipHeader:"{{set.key}}",map:{selectedMap:"1"},showLegend:!0}},pie:{info:{aggregation:"1",canExportXlsx:!0,tooltip:"3",hole:"50",refreshPeriod:"0",formatString:",.0f",colorType:1,tooltipHeader:"{{set.key}}",tooltipFormat:"{{point.label}}: {{point.data}} :: {{point.percentage}}%"}},tree:{info:{selectable:"one",aggregation:"1",canExportXlsx:!0,tooltip:"3",refreshPeriod:"0",formatString:",.0f",tooltipHeader:"{{set.key}}",tooltipFormat:"{{point.label}}: {{point.data}} :: {{point.percentage}}%"}},gauge:{info:{font:{bold:!0,color:"#333333",italic:!1,fontSize:"34px",fontName:"IRANSans",formatString:",.0f",formatStringCustom:",.0f"},aggregation:"1",canExportXlsx:!0,textBold:!0,textItalic:!1,refreshPeriod:"0",segmentType:"singleSegment",style:"arc",height:"medium",formatString:",.2f",fontSize:"3em",color:"#333333",colorAriaThree:"#e14d57",colorAriaTwo:"#FBEE58",colorAriaOne:"#71b37c"}},radar:{info:{aggregation:"1",canExportXlsx:!0,refreshPeriod:"0",formatString:",.0f"}},table:{info:{aggregation:"1",canExportXlsx:!0,refreshPeriod:"0",sortMeasures:!1,condensed:!1,bordered:!1,stripped:!0,hover:!0,showHeader:!0,showRowNumber:!1,rowAsKey:!1,selectable:"multi"}},userControl:{info:{aggregation:"1",canExportXlsx:!1,showFilterIcon:"0",type:"combo",comboStyle:"bootstrap",label:"",sliderRange:"min-max",dateFormatShow:"yy/mm/dd",dateOp:"eq",sliderFormat:",.0f",variableId:"-1",variableDefaultFunction:"NONE",functionDateFormat:"yy/mm/dd",functionUnitAgo:1,functionUnitAgoTwo:0,functionUnitAgoOffset:1,functionUnitAgoTwoOffset:1,dateFormatValue:"yy/mm/dd",textOperand:"or"}},text:{info:{aggregation:"1",canExportXlsx:!1,formatString:",.0f",refreshPeriod:"0",showFilterIcon:"0",html:""}}},j={1:"bar",2:"pie",4:"gauge",8:"radar",5:"table",6:"map",7:"userControl",9:"tree",10:"text"},k=angular.module("management");k.directive("draggableItems",["$timeout",function(a){return function(a,b,c){function h(){$("#columnList .datasource-field").draggable({appendTo:".chart-editor",helper:"clone",start:function(a,b){$(b.helper).addClass("ui-helper"),$(b.helper).width($(a.currentTarget).width())}}),$("#divX, #divY, #divProv").droppable({activeClass:"ui-state-default",hoverClass:"ui-state-hover",accept:":not(.ui-sortable-helper)",drop:function(b,c){var h=$(this).attr("id");if(a.$parent.isOlap){var i=c.draggable.attr("type"),j=null;if("measure"==i||"kpi"==i){if("divY"!=h)return;j="measure"==i?_.find(a.$parent.olapCubes[+a.$parent.selectedOlapCube||0].Measures,{UniqueName:c.draggable.data("name")}):_.find(a.$parent.olapCubes[+a.$parent.selectedOlapCube||0].Kpis,{UniqueName:c.draggable.data("name")}),j.type=i,a.$apply(function(){var b="divX"==h?a.dimensions:"divY"==h?a.measures:a.where;b.push($.extend({},j))})}if("dimension"==i){var k=c.draggable.attr("group-name");j=a.$parent.olapCubes[+a.$parent.selectedOlapCube||0].Dimensions[+c.draggable.attr("DimIndex")].group[k][+c.draggable.attr("index")],j.type="dimension";var l="divX"==h?a.dimensions:"divY"==h?a.measures:a.where;a.$apply(function(){l.push($.extend({},j))})}a.$parent.$parent.$parent.$parent.$parent.$parent.$parent.refreshChart()}else a.$apply(function(){var b=d(a.$parent.chartProp,a.$parent.chartType),i=a.dimensions.concat(a.measures).concat(a.where),j="divX"==h?a.dimensions:"divY"==h?a.measures:a.where,k="divX"==h?f:"divY"==h?e:g;j.push($.extend({},k(a.datasource.CubeInfo.Dimensions[+c.draggable.attr("DimIndex")].Hierarchies[+c.draggable.attr("index")],i,b,a)))}),a.$parent.$parent.refreshChart()}})}a.$last&&h()}}]),k.controller("chartsEditorCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$translate","utils","$compile","$mdSidenav","$mdMedia","menus","datasources","roles",function(a,e,f,g,k,l,m,n,o,p,q,r,s,t,u,v){function w(a){_.forEach(a.Dimensions,function(a){a.group=_.groupBy(a.Hierarchies,"DisplayFolder")}),a.measureGroup=_.groupBy(a.Measures,"GroupName"),a.pkiGroup=_.groupBy(a.Kpis,"GroupName")}function x(){return"combo-kpi"==a.type}function y(){a.rolePermissions&&a.roles&&(a.rolePermissionLoaded=!0,_.forEach(a.roles,function(b){var c=_.find(a.rolePermissions,{roleId:b.id});c&&(b.action=1==c.actionSum?1:3==c.actionSum?2:4,b.check=!0)}))}function z(){a.menusSelected&&a.menus&&_.forEach(a.menus,function(b){_.forEach(b,function(b){-1!=a.menusSelected.indexOf(b.id)&&(b.check=!0)})})}function A(){if("undefined"!=typeof Storage){var a=localStorage.getItem("returnUrl");if(localStorage.removeItem("returnUrl"),!_.isUndefined(a)&&!_.isEmpty(a))return void(window.location.href=a)}window.history.length<=2?l.path("charts"):window.history.back()}function B(){var b=345;$("#tdChart").css("height",$(window).height()-b+"px").css("overfolw","auto"),$("#menu").css("height",$(".panel-body.chart-design").height()+"px").css("overfolw","auto"),$("#chrt-prop").css("height",$(".panel-body.chart-design").height()+"px").css("overfolw","auto"),"combo-kpi"==a.type&&$("#tdChart").css("height",$(window).height()-b+140+"px").css("overfolw","auto")}a.app=app;var C="undefined"!=typeof k.packageId?k.packageId:0,D="undefined"!=typeof k.id?k.id:0,E=(k.type,D>0);a.isEdit=E,a.id=D;var F,G,H=D,I=app.urlPrefix+"moderation/olapchartdesign/SaveChart",J=E;a.olapData={measures:[],kpis:[]},a.dimensions=[],a.measures=[],a.where=[],a.chartDimensions=[],a.chartMeasures=[],a.chartType=1,a.chartProp=$.extend({},i),a.relatedDatasource=[],a.filterException={},a.calculatedFields={},a.selectedTab=0,a.showRelatedDatasource=function(b){g.show({controller:["$scope","$mdDialog",function(b,c){b.$scope=a,a.relatedDatasourceList||e.get(app.urlPrefix+"Moderation/OlapChartDesign/GetRelatedDatasource?DataSourceId="+F).success(function(b){a.relatedDatasourceList=b.filter(function(b){return-1==a.datasource.CubeInfo.Dimensions.map(function(a){return+a.UniqueName}).indexOf(+b.Id)})}),b.cancel=function(){c.cancel()}}],templateUrl:"chart-editor/related-datasource.html",parent:angular.element(document.body),targetEvent:b,clickOutsideToClose:!0,fullscreen:s("sm")||s("xs")})},a.removeRelatedDatasource=function(b,c){a.relatedDatasource.splice(a.relatedDatasource.indexOf(+c.UniqueName),1);var d=a.datasource.CubeInfo.Dimensions.splice(b,1);d[0].Hierarchies.forEach(function(b){function c(a){var c=a.map(function(a){return a.UniqueName}).indexOf(b.UniqueName);-1!=c&&a.splice(c,1)}c(a.dimensions),c(a.measures),c(a.where)}),a.refreshChart()},a.addRelatedDatasource=function(b){e.get(app.urlPrefix+"Moderation/OlapChartDesign/GetDatasourceDimension?DataSourceId="+b).then(function(c){a.finishedJob++,a.finishedJob==a.maxJob&&a.$broadcast("finishJobs"),a.datasource.CubeInfo.Dimensions.push(c.data),-1==a.relatedDatasource.indexOf(b)&&a.relatedDatasource.push(b)},function(){-1!=a.relatedDatasource.indexOf(b)&&a.relatedDatasource.splice(a.relatedDatasource.indexOf(b),1),a.finishedJob++,a.finishedJob==a.maxJob&&a.$broadcast("finishJobs"),a.refreshChart()})},a.filterRelatedDatasource=function(b){return-1==a.relatedDatasource.indexOf(+b.Id)},a.menu={name:"salam"},a.$watch("chartType",function(b,c){function d(){return angular.element("#divProp div")?(angular.element("#divProp div").remove(),angular.element("#divProp").append(e),void q(angular.element("#divProp"))(a)):void n(d,100)}var e={};switch(a.cntrName="chartsEditorCtrl",+b){case 1:e='<div ng-chart-properties open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="bar" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>';break;case 2:e='<div ng-chart-properties open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="pie" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>';break;case 4:e='<div ng-chart-properties open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="gauge" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>';break;case 5:e='<div ng-chart-properties open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="table" dimensions="dimensions" measures="measures" where="where" datasource="datasource"  filter-exception="filterException" calculated-fields="calculatedFields"></div>';break;case 6:e='<div ng-chart-properties open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="map" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>';break;case 7:e='<div ng-chart-properties open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="userControl" dimensions="dimensions" measures="measures" where="where" datasource="datasource"  filter-exception="filterException" calculated-fields="calculatedFields"></div>';break;case 8:e='<div ng-chart-properties open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="radar" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>';break;case 9:e='<div ng-chart-properties open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="tree" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>';break;case 10:e='<div ng-chart-properties open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="text" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>';break;default:e='<div ng-chart-properties ng-model="chartProp" is-olap="isOlap" data-type="bar" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>'}n(d,0)}),a.$watch("measures",function(b){a.tableInfo=null},!0),a.$watch("where",function(b){a.tableInfo=null},!0),a.gettingData=!0,a.collapseAll=function(b){_.each(a.olapCubes[+a.selectedOlapCube].Dimensions,function(a){a.expand=b}),a.measureExp=b,a.kpiExp=b},a.changeCube=function(){var b=a.olapCubes[a.selectedOlapCube];b.Dimensions||e.get(app.urlPrefix+"Moderation/OlapChartDesign/GetCubeInnerData?CubeName="+b.Name+"&DataSourceId="+F).success(function(b){a.olapCubes[a.selectedOlapCube]=b.CubeInfo,w(a.olapCubes[a.selectedOlapCube])})},a.gr=function(a,b,c){return _.groupBy(a,b)},a.getColumnList=function(){a.datasource||e.get(app.urlPrefix+"Moderation/OlapChartDesign/CubeInformation?DataSourceId="+F).success(function(b){a.gettingData=!1,a.isOlap=b.isOlap,a.datasource=b,b.isOlap&&(a.olapCubes=b.olapCubes,a.selectedOlapCube="0",w(a.olapCubes[0])),a.$broadcast("datasourceReady")})},a.gotoDatasource=function(a){var b={MsOlap:1,MSSQL:2,MySQL:3,File:4,WebResource:5,JoinDatasource:6},c=0;switch(a.DatasourceType){case b.MySQL:l.path("datasources/add/mssql/"+b.MySQL+"/"+c+"/"+a.UniqueName);break;case b.MsOlap:l.path("datasources/add/mssql/"+b.MsOlap+"/"+c+"/"+a.UniqueName);break;case b.MSSQL:l.path("datasources/add/mssql/"+b.MSSQL+"/"+c+"/"+a.UniqueName);break;case b.File:l.path("datasources/add/file/"+c+"/"+a.UniqueName);break;case b.WebResource:l.path("datasources/add/web/"+c+"/"+a.UniqueName);break;case b.JoinDatasource:l.path("datasources/add/join/"+c+"/"+a.UniqueName)}},a.gotoChart=function(a){l.path("charts/edit/0/"+a.Id)};var K=function(b){g.show({controller:["$scope","$mdDialog",function(b,c){b.parent=a,b.cancel=function(){c.cancel()},b.save=function(){b.parent.refreshChart(),c.cancel()}}],templateUrl:"editor/filterMember.html",parent:angular.element(document.body),targetEvent:b,clickOutsideToClose:!0,fullscreen:s("sm")||s("xs")})};a.filterMember=function(b,c,d){a.members=null,c||K();var f=b.members&&!b.members.list;!b.members||f?e.post(app.urlPrefix+"Moderation/OlapChartDesign/GetMember",JSON.stringify({CubeName:a.isOlap?a.olapCubes[+a.selectedOlapCube||0].Name:"",Uniquename:a.isOlap?b.UniqueName:b.formula,DataSourceId:F,calculatedFields:[]}),{headers:{"Content-Type":"application/json; charset=utf-8"}}).success(function(c){c.result&&(b.members={name:b.Name,isNumeric:c.isNumeric,list:c.data,numericFilter:{type:"condition",conditions:[{condition:"none",parameter:"0"},{condition:"none",parameter:""}],conditionType:"and",func:"aboveAvg"},aggregation:b.aggregation}),a.members=b.members,d&&d()}):a.members=b.members,b.userProperty=a.datasource.UsersProperty.map(function(a){var c={Name:a};return b.userProperty&&(c.Checked=_.some(b.userProperty,{Name:a,Checked:!0})),c}).slice(0),b.globalVariable=a.datasource.GlobalVariable.map(function(a){var c={Name:a.Name,Id:a.Id};return b.globalVariable&&(c.Checked=_.some(b.globalVariable,{Id:a.Id,Checked:!0})),c}).slice(0),a.globalVariable=b.globalVariable,a.userProperty=b.userProperty},a.checkAll=function(a,b){a&&a.forEach(function(a){a.Checked=b})},a.sortableOptions={stop:function(){n(function(){a.refreshChart()},0)},receive:function(a,b){$(a.target).attr("id"),$(b.sender).attr("id");
}},a.refreshChart=function(c){app.chartCommons.drillDown.clearAll();var e=$.extend({needDim:!0,needMeasure:!0,needServerData:!0},h(a));if(a.chartRenderError=null,!x()&&e.needDim&&0==a.dimensions.length)return $("#divChart").empty(),void o("chart_editor_need_dimention").then(function(b){a.chartRenderError=b});if(!x()&&e.needMeasure&&0==a.measures.length)return $("#divChart").empty(),void o("chart_editor_need_measure").then(function(b){a.chartRenderError=b});if(x()&&!a.combo.selectedChart.length)return $("#divChart").empty(),void o("chart_editor_need_chart").then(function(b){a.chartRenderError=b});if(c&&!$("#divChart").data("isChart")&&(c=null),c&&$("#divChart").data("isChart")){var f=$("#divChart").data("settings");if("undefined"==typeof f.input)return;f.input.result||(c=null),x()||!e.needServerData||f.input.fields||(c="refreshWithData")}var g={Title:"",CubeName:a.isOlap?a.olapCubes[+a.selectedOlapCube||0].Name:"xxx",Description:"",Hierarchies:b(a.dimensions,a.isOlap),Where:b(a.where,a.isOlap),SeriesLevel:b(a.measures,a.isOlap),DataSourceId:F,Detail:JSON.stringify({chartProp:d(a.chartProp,a.chartType,a.dimensions,a.measures,a.where),needServerData:e.needServerData,tableInfo:a.tableInfo,relatedDatasource:a.relatedDatasource,filterException:a.filterException,calculatedFields:a.calculatedFields,dataType:a.type,combo:a.combo})};a.isOlap&&(g.Measurs=_.map(_.filter(a.measures,["type","measure"]),"UniqueName"),g.Kpis=_.map(_.filter(a.measures,["type","kpi"]),"UniqueName"));var i={ChartInfo:g,notEditMode:!1},j={chartProp:d(a.chartProp,a.chartType,a.dimensions,a.measures,a.where),parameters:i,editMode:!0,needServerData:e.needServerData,tableInfo:a.tableInfo,relatedDatasource:a.relatedDatasource,calculatedFields:a.calculatedFields,dataType:a.type,combo:a.combo};$("#divChart").data("chartInfo",g),app.chartCommons.drillDown.clear(-1),clearTimeout(a.lastRefreshTimeout),a.lastRefreshTimeout=setTimeout(function(){c?$("#divChart").charts(a.chartType,c,j):o("در حال بارگذاری...").then(function(b){$("#divChart").empty(),$("#divChart").append('<div><img style="width:18px; height:18px; display: inline-block;" src="'+app.urlPrefix+'Images/progress.gif"/>'+b+"</div>"),$("#divChart").height($("#chart-content").height()+"px"),$("#divChart").charts(a.chartType,j)})},400),$("#divChart").off("legendClick"),$("#divChart").on("legendClick",function(b,c,d,e){n(function(){a.menu.set("series"),a.chartProp.selectedSeries=e.key},20)})},a.gotoDimentionSettings=function(b,c){a.menu.set("dimension"),a.menu.selectedDimension=c+""},a.gotoMeasureSettings=function(b,c){a.menu.set("measure"),a.menu.selectedMeasure=c+""},a.gotoWhereSettings=function(b,c){a.menu.set("where"),a.menu.selectedwhere=c+""},$("#divChart").bind("tableInfo",null,function(b,c){n(function(){var b=a.tableInfo?a.tableInfo.Limit||10:10;a.tableInfo=c.TableInfo,a.tableInfo.Limit=b},0)}),$("#divChart").bind("chartproperty",null,function(b,c){d3.scale.category10();n(function(){a.chartProp.series=c},0)}),t.get().then(function(b){_.forEach(b.data,function(a){a.check=!1}),a.menus=_.groupBy(angular.merge([],b.data),"parent"),z()}),E&&(e.get(app.urlPrefix+"api/charts/GetChartMenus?id="+D).then(function(b){a.menusSelected=b.data,z()}),v.get().then(function(b){a.roles=angular.merge({},b.data.list),_.forEach(a.roles,function(a){a.action=1,a.check=!1}),y()}),e.get(app.urlPrefix+"api/permissions/getChartPermissions?id="+a.id).then(function(b){a.rolePermissions=b.data.list,y()})),a.showDialog=function(b){g.show({controller:["$scope","$mdDialog",function(b,c){b.parent=a,b.cancel=function(){c.cancel()},b.save=function(){E||b.parent.saveNewChart(),c.cancel()}}],templateUrl:"editor/save-chart.html",parent:angular.element(document.body),targetEvent:b,clickOutsideToClose:!0,fullscreen:s("sm")||s("xs")})},a.save=function(b){return J?void a.saveNewChart():void a.showDialog(b)},a.cancel=function(){A()},a["delete"]=function(b){var c=app.urlPrefix+"Moderation/Charts/DeleteCharts",d=g.confirm().title("حذف برای همیشه؟").textContent("آیا برای حذف نمودار "+a.chartName+" اطمینان دارید؟").ariaLabel("حذف").targetEvent(b).ok("حذف!").cancel("لغو");g.show(d).then(function(){e.post(c,["ChartId-"+a.id]).then(function(a){if(a.data.result){var b=f.simple().textContent("حذف انجام شد");f.show(b),2==window.history.length?l.path("charts"):window.history.back()}},function(){var a=f.simple().textContent("اشکال در حذف!");f.show(a)})})},a.saveNewChart=function(){if(!a.chartName)return o("form_name_required").then(function(a){p.showErrorToast(a)}),!1;var g=_.filter(a.roles,{check:!0}).map(function(a){return a.action+"-"+a.id}),i=[];_.forEach(a.menus,function(a){_.forEach(a,function(a){a.check&&i.push(a.id)})}),c(a.chartProp,a.chartType);var j=$.extend({needDim:!0,needMeasure:!0,needServerData:!0},h(a));a.combo&&!J&&(a.combo.title=$("#chartTitleFarsi").val());var k=d(a.chartProp,a.chartType,a.dimensions,a.measures,a.where),l={datasourceId:F,relatedDatasource:a.relatedDatasource,dimensions:a.dimensions,measures:a.measures,where:a.where,chartType:a.chartType,expandedChartType:a.expandedChartType,chartProp:k,needServerData:j.needServerData,tableInfo:a.tableInfo,filterException:a.filterException,calculatedFields:a.calculatedFields,dataType:a.type,combo:a.combo,isOlap:a.isOlap,selectedOlapCube:a.selectedOlapCube},m={id:H,editMode:J,xChartType:a.chartType,xTitleFarsi:a.chartName,chartUniquename:"",cubeName:a.isOlap?a.olapCubes[+a.selectedOlapCube||0].Name:"xxx",hierarchy:b(a.dimensions,a.isOlap),where:b(a.where,a.isOlap),seriesLevel:b(a.measures,a.isOlap),ChartActions:g,Menus:i,detail:JSON.stringify(l),DataSourceId:F,Desc:a.chartDesc,PackageId:C};return a.isOlap&&(m.measures=_.map(_.filter(a.measures,["type","measure"]),"UniqueName"),m.kpis=_.map(_.filter(a.measures,["type","kpi"]),"UniqueName")),e.post(I,JSON.stringify(m),{headers:{"Content-Type":"application/json; charset=utf-8"}}).success(function(a){o("chart_editor_save_success").then(function(a){f.show(f.simple().textContent(a))}),u.reset(),A()}),!0},a.restore=function(b){var c={datasourceId:-1,dimensions:[],relatedDatasource:[],measures:[],where:[],chartType:1,chartProp:{},tableInfo:null,filterException:{},calculatedFields:{},isOlap:!1},b=$.extend({},c,b);F=b.datasourceId,a.relatedDatasource=b.relatedDatasource,a.where=b.where;var d={};if(d[j[+b.chartType]]=b.chartProp,a.dimensions=b.dimensions,a.measures=b.measures,a.chartProp=_.extend({},i,d),a.chartType=b.chartType,a.expandedChartType=b.expandedChartType,a.tableInfo=b.tableInfo,a.filterException=b.filterException,a.calculatedFields=b.calculatedFields||{},a.maxJob=0,a.finishedJob=-1,a.isOlap=b.isOlap,a.selectedOlapCube=b.selectedOlapCube,a.isOlap&&0!=+b.selectedOlapCube&&a.changeCube(),a.type=b.dataType,a.combo=b.combo||{},a.combo.synonyms=a.combo.synonyms||[],a.combo.aggregation=a.combo.aggregation||0,a.maxJob=a.relatedDatasource?a.relatedDatasource.length:0,a.relatedDatasource.forEach(function(b){a.addRelatedDatasource(b)}),_.each(a.combo.selectedChart,function(b){e.get(app.urlPrefix+"api/charts/get?id="+b.Id).then(function(c){return c.data?void(_.first(a.combo.selectedChart,{Id:b.Id}).Name=c.data.Name):(_.remove(a.combo.selectedChart,{Id:b.Id}),void a.refreshChart())})}),_.isUndefined(a.expandedChartType)){var f=_.findKey(a.chartNameMap,_.find(a.chartNameMap,{type:+a.chartType}));a.expandedChartType=+f}a.refreshChart()},a.chagePivotFormula=function(b){a.measures&&(1==b?a.measures.forEach(function(a){var b="SUM("+a.UniqueName+")",c="SUM";a.IsNumeric||(b="COUNT("+a.UniqueName+")",c="COUNT"),a.formula=b,a.aggregation=c}):a.measures.forEach(function(a){a.formula=a.UniqueName,a.aggregation="NONE"}))},a.setType=function(b){a.type=b,"combo-kpi"!=b?a.getColumnList():a.$broadcast("datasourceReady"),B()},a.charts=[],a.getCharts=function(){e.get(app.urlPrefix+"api/charts/get").then(function(b){b.data.result?a.charts=b.data.list:a.charts=[]},function(){a.charts=[]})},a.showChartsDialog=function(){$("#charts-modal").modal("show"),a.charts&&a.charts.length||a.getCharts()},a.combo={combineType:0,aggregation:0,selectedChart:[],synonyms:[]},a.addChart=function(b){a.combo.selectedChart.push(b),a.refreshChart()},a.selectChart=function(b){u.select(b,["charts"]).then(function(b){"charts"==b.type&&(_.forEach(u.lastSelected.charts,function(b){a.combo.selectedChart.push({Id:b.id,Name:b.name})}),a.refreshChart())})},E?(a.selectedTab=1,e.get(app.urlPrefix+"api/charts/getEditor?id="+D).then(function(b){F=b.data.dataSourceId,G=b.data.type,a.chart=b.data.chart;var c=JSON.parse(b.data.chart.Detail);a.$on("datasourceReady",function(){a.restore(c)}),a.setType(G),a.chartName=a.chart.Name,a.chartDesc=a.chart.Description},function(a){a.data.desc&&alert(a.data.desc),2==window.history.length?l.path("charts"):window.history.back()})):(F=k.datasourceId,G=k.type,"combo-kpi"==G&&_.forEach(u.lastSelected.charts,function(b){a.combo.selectedChart.push({Id:b.id,Name:b.name})}),a.setType(G)),a.existIn=function(a,b){return _.some(b,{UniqueName:a.UniqueName})},a.expandedChartType=1;var L=1;a.changeChartType=function(b){L=a.expandedChartType,a.expandedChartType=b,a.chartType=a.chartNameMap[b].type,14==L&&14!=a.expandedChartType&&a.chagePivotFormula(1),14!=L&&14==a.expandedChartType&&a.chagePivotFormula(-1),app.chartCommons.expandedType=a.expandedChartType,app.chartCommons.changeSeriesPropertyBaseOnExpandedType(a.chartProp[j[+a.chartType]]),a.refreshChart()},a.chartNameMap={1:{name:"میله‌ای",type:1},2:{name:"میله‌ای - پشته",type:1},3:{name:"خطی",type:1},4:{name:"خطی - پشته",type:1},5:{name:"سطح",type:1},6:{name:"سطح - پشته",type:1},7:{name:"دایره‌ای",type:2},8:{name:"دونات",type:2},9:{name:"عقربه‌ای هلالی",type:4},10:{name:"رادار",type:8},11:{name:"نقشه",type:6},12:{name:"درختی",type:9},13:{name:"جدول - تجمیعی",type:5},14:{name:"جدول عادی",type:5},15:{name:"انتخاب تک مقداری",type:7},16:{name:"انتخاب چند مقداری",type:7},17:{name:"انتخاب تاریخ",type:7},18:{name:"انتخاب محدوده تاریخ",type:7},19:{name:"انتخاب محدوده عدد",type:7},20:{name:"جستجو",type:7},21:{name:"میله‌ای - پشته درصدی",type:1},22:{name:"خطی - پشته درصدی",type:1},23:{name:"سطح - پشته درصدی",type:1},24:{name:"عقربه‌ای هلالی - چند بخشی",type:4},25:{name:"عقربه‌ای خطی",type:4},26:{name:"عقربه‌ای خطی - چند بخشی",type:4},27:{name:"عددی",type:4}}}]),k.directive("ngChartProperties",function(){return{restrict:"AE",require:"^ngModel",scope:{ngModel:"=",dimensions:"=",measures:"=",where:"=",datasource:"=",type:"@",isOlap:"=",relatedDatasourceList:"=",calculatedFields:"=",filterException:"=",openMenuName:"="},templateUrl:function(a,b){switch(b.type){case"bar":return app.urlPrefix+"dist/partial/management/charts/directives/types/barLine.html?v="+app.version;case"map":return app.urlPrefix+"dist/partial/management/charts/directives/types/map.html?v="+app.version;case"pie":return app.urlPrefix+"dist/partial/management/charts/directives/types/pie.html?v="+app.version;case"gauge":return app.urlPrefix+"dist/partial/management/charts/directives/types/gauge.html?v="+app.version;case"radar":return app.urlPrefix+"dist/partial/management/charts/directives/types/radar.html?v="+app.version;case"table":return app.urlPrefix+"dist/partial/management/charts/directives/types/table.html?v="+app.version;case"userControl":return app.urlPrefix+"dist/partial/management/charts/directives/types/userControl.html?v="+app.version;case"tree":return app.urlPrefix+"dist/partial/management/charts/directives/types/tree.html?v="+app.version;case"text":return app.urlPrefix+"dist/partial/management/charts/directives/types/text.html?v="+app.version;default:return app.urlPrefix+"dist/partial/management/charts/directives/types/barLine.html?v="+app.version}},controller:["$scope","$timeout",function(a,b){a.cntrName="ngChartProperties",a.changeColor=function(b,c,d){$(b.target).colorSelector(c&&c[d]?c[d]:"#1f77b4",function(e){$(b.target).css("background-color",e),a.$apply(function(){c&&(c[d]=e),a.refreshChart("refresh"),a.changeAllSeries(d,e)})})},a.refreshChart=function(b){a.$parent.refreshChart(b)},a.chagePivotFormula=function(b){a.$parent.chagePivotFormula(b)},a.setTableInfoLimit=function(b,c){a.$parent.tableInfo=a.$parent.tableInfo||{},"undefined"!=typeof b&&null!=b&&(a.$parent.tableInfo.Limit=b),"undefined"!=typeof c&&(a.$parent.tableInfo.useDistinct=c)},a.$parent.dereg&&a.$parent.dereg(),a.$parent.dereg=a.$watch("dimensions",function(b,c){if("undefined"!=typeof b){a.ngModel.tree=a.ngModel.tree||{},a.ngModel.tree.dimensions=a.ngModel.tree.dimensions||[];for(var d=0;d<b.length;d++){var e=b[d],f=_.filter(a.ngModel.tree.dimensions,{name:e.Name}).length;f||a.ngModel.tree.dimensions.push({type:0==d?"id":1==d?"parent":2==d?"name":"type",name:e.Name})}a.tableInfo=null}},!0),a.changeAllSeries=function(b,c){if("{All}"==a.ngModel.selectedSeries){var d=a.ngModel[a.type].series;for(var e in d)d[e][b]=d["{All}"]?d["{All}"][b]:c}}}],link:function(){app.lang.setLang()}}}),k.directive("topMeasure",function(){return{restrict:"E",scope:{model:"=?ngModel",change:"&ngChange",dims:"=?dims"},link:function(a,b,c,d){},controller:["$scope",function(a){a.dims=a.dims||[],a.model&&(a.model.selectedDims=a.model.selectedDims||{})}],template:'                                                                                                                 <div class="form-row" layout="row" layout-align="start center" layout-wrap>                                                                 <md-switch ng-model="model.IsTop" ng-change="change()">                                                                         {{ \'isTop\' | translate }}                                                                                             </md-switch>                                                                                                            </div>                                                                                                                      <div ng-if="model.IsTop">                                                                                                       <div class="form-row" layout="row" layout-align="start center">                                                                 <label>{{ \'top\' | translate }}</label>                                                                                    <span class="form-divider" flex></span>                                                                                     <div>                                                                                                                           <md-switch ng-model="model.IsPercent" ng-change="change()" style="display:inline">                                              {{ \'IsPercent\' | translate }}                                                                                         </md-switch>                                                                                                                                                                                                                                            <input type="number" class="form-control" placeholder="{{ \'top\' | translate }}"                                                  ng-model-options="{ updateOn: \'blur\' }"                                                                                   ng-change="change()"                                                                                                        ng-model="model.Top" />                                                                                                                                                                                                                          <select class="selectpicker form-control"                                                                                           ng-model="model.TopOrder"                                                                                                   ng-change="change()">                                                                                                   <option value="DESC">{{\'نزولی\' | translate}}</option>                                                                     <option value="ASC">{{\'صعودی\' | translate}}</option>                                                                  </select>                                                                                                               </div>                                                                                                                  </div>                                                                                                                      <div class="form-row" layout="row" layout-align="start center">                                                                 <label>{{ \'Applied_to\' | translate }}</label>                                                                             <span class="form-divider" flex></span>                    <div>                                                                                                                           <md-checkbox ng-repeat="d in dims track by $index" ng-model="model.selectedDims[d.Name]" ng-change="change()">{{d.Name}}</md-checkbox>                       </div>                                                                                                                  </div>                                                                                                                  </div>                                                                                                                      '}})}();var ngApp=angular.module("management");ngApp.controller("chartsListCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$translate","utils","datasources","toolbar",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(){return _.map(_.filter(a.data,{select:!0}),function(a){return 2==a.type?"ChartId-"+a.id:"PackageId-"+a.id})}function n(b){var c=_.lastIndexOf(a.data.map(function(a){return a.type}),1);-1==c?a.data=b.concat(a.data):Array.prototype.splice.apply(a.data,[c+1,0].concat(b))}function o(a){j.showErrorToast(a.data.desc)}function p(b){a.data=_.filter(a.data,function(a){var c=2==a.type?"ChartId-"+a.id:"PackageId-"+a.id;return-1==b.indexOf(c)})}a.utils=j;var q="undefined"!=typeof e.id?e.id:0;a.app=app;var r=q?"?packageId="+q:"";a.progress=!0,b.get(app.urlPrefix+"api/charts/getList"+r).then(function(b){a.progress=!1,a.data=b.data.list,i("لیست نمودارها").then(function(c){a.listTranslate=c,b.data.path.unshift({name:c,id:null}),a.path=b.data.path.map(function(b){return b.click=function(){a["goto"]({type:1,id:b.id})},b}),l.setTitles(a.path)})},o),j.onError(function(b){a.error=b,a.progress=!1}),i("لیست نمودارها").then(function(b){a.listTranslate=b});var s=function(){return _.some(a.data,{select:!0})};a.menuInvalidate=function(){var b=s(),c=_.filter(a.data,{select:!0,type:1}).length,d=_.filter(a.data,{select:!0,type:2}).length;a.canCopy=b,a.canDelete=b,a.canForward=b,a.canDirEdit=1==c&&0==d},a.copy=function(){var d=app.urlPrefix+"Moderation/Charts/CloneCharts",e=m();b.post(d,e).then(function(b){if(b.data.result){b.data.inserted&&(a.data=a.data.concat(b.data.inserted)),b.data.packages&&n(b.data.packages);var d=c.simple().textContent("کپی انجام شد");c.show(d)}},o)},a["delete"]=function(e){var f=app.urlPrefix+"Moderation/Charts/DeleteCharts",g=m(),h=d.confirm().title("حذف برای همیشه؟").textContent(g.length+" مورد برای حذف انتخاب شده است").ariaLabel("حذف").targetEvent(e).ok("حذف!").cancel("لغو");d.show(h).then(function(){b.post(f,g).then(function(b){if(b.data.result){b.data.deletedIds&&p(b.data.deletedIds);var d=c.simple().textContent("حذف انجام شد");c.show(d),a.menuInvalidate()}},o)})},a.forward=function(a){k.select(a,{type:["charts"],justDir:!0,selectableDir:!0,multipleChart:!1}).then(function(a){var d=a.selected[0];if(e.id==d.id){var f=c.simple().textContent("موارد انتخاب شده در همین پوشه هستند");return void c.show(f)}var g=m();b.post(app.urlPrefix+"Moderation/Charts/MoveToPackage",{Ids:g,packageId:d.id}).then(function(a){p(a.data.ids);var b=c.simple().textContent("انتقال انجام شد");c.show(b)},o)},o)},a.dirEdit=function(b){var d=m(),e=d[0].replace("PackageId-","");g.edit(b,2,e,function(b){_.find(a.data,{select:!0}).name=b.data.info.Name;var d=c.simple().textContent("نام پوشه تغییر کرد");c.show(d)},o)},a.newPackage=function(a){g.create(a,1,e.id,function(a){n([{id:a.data.info.Id,name:a.data.info.Name,type:1}]);var b=c.simple().textContent("پوشه جدید ایجاد شد");c.show(b),k.reset()})},a["goto"]=function(a,b){1==a.type?f.path("charts"+(a.id?"/"+a.id:"")):2==a.type&&f.path("charts/edit/"+q+"/"+a.id)},a.getTypeName=function(a){var b=1,c=2,d=3,e=5,f=6,g=7,h=8,i=9,j="";switch(+a){case b:j="Bar";break;case c:j="Pie";break;case d:j="Line";break;case e:j="Table";break;case f:j="Map";break;case g:j="User Control";break;case h:j="Radar";break;case i:j="Tree"}return j},a.getChartTypeImage=function(a){var b="",c={};switch(c.BAR=1,c.PIE=2,c.LINE=3,c.GAUGE=4,c.TABLE=5,c.MAP=6,c.USER_CONTROL=7,c.RADAR=8,c.TREE=9,+a){case c.BAR:b=app.urlPrefix+"Images/bar.png";break;case c.GAUGE:b=app.urlPrefix+"Images/guage.png";break;case c.PIE:b=app.urlPrefix+"Images/pie.png";break;case c.LINE:b=app.urlPrefix+"Images/line.png";break;case c.TABLE:b=app.urlPrefix+"Images/table.png";break;case c.MAP:b=app.urlPrefix+"Images/map.png";break;case c.USER_CONTROL:b=app.urlPrefix+"Images/combo_box.png";break;case c.RADAR:b=app.urlPrefix+"Images/radar_plot.png";break;case c.TREE:b=app.urlPrefix+"Images/tree.png"}return b};var t;a.$watch("search",function(){h.cancel(t),t=h(function(){"undefined"!=typeof a.search&&(a.progress=!0,b.get(app.urlPrefix+"api/charts/getList?q="+a.search).then(function(b){a.progress=!1,a.data=b.data.list,a.path=b.data.path,a.path.unshift({name:"لیست منابع داده",id:null})},o))},400)}),a.selectAll=function(){a.data&&_.forEach(a.data,function(b){b.select=a.selectAllCheckbox}),a.menuInvalidate()},a.newChart=function(a){k.select(a,{type:["charts","datasources"]}).then(function(a){"charts"==a.type?f.path("charts/new/combo-kpi/"+(e.id?e.id:"0")):f.path("charts/new/normal/"+(e.id?e.id:"0")+"/"+a.selected[0].id)})},a.sortDetail={},a.sort=function(b){a.sortDetail[b]=a.sortDetail[b]||{},a.sortDetail[b].isDesc=!a.sortDetail[b].isDesc;var c=_.filter(a.data,{type:1}),d=_.filter(a.data,{type:2});d=_.sortBy(d,[b]),c=_.sortBy(c,[b]),a.sortDetail[b].isDesc||(d=_.reverse(d),c=_.reverse(c)),a.data=c.concat(d)}}]),function(a){var b=angular.module("management");b.directive("alert",["$timeout","$http",function(b,c){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/alert.html?v="+app.version,scope:{model:"=prop",config:"="},controller:["$scope",function(d){d.name="ALERT_CONTROLLER",d.contactList=[{phone:"",email:""}],d.roleList=null,d.userList=null,d.schedule={occure:"daily",dailyRecurs:1,weeklyRecurs:1,weeklySat:!1,weeklySun:!1,weeklyMon:!1,weeklyTus:!1,weeklyWen:!1,weeklyThu:!1,weeklyFri:!1,monthlyDayOf:1,monthlyRecurs:1,dailyFrequency:"once",dailyFrequencyAtHour:"1200",dailyFrequencyRecur:1,dailyFrequencyRecurType:"hour",dailyFrequencyStart:"1200",dailyFrequencyStop:"2359"},d.newAlert=function(){d.model[d.config.name].alerts.push({type:"sms",rules:[],schedule:d.schedule,format:"[@{k} :: ][,][@{m}:@{n}]",selectedSeries:[]}),b(function(){app.lang.setLang()},0)},d.formatClock=function(a){var b=a+"";return b.substr(0,2)+":"+b.substr(2)},d.model[d.config.name]&&(d.model[d.config.name].alerts=a.extend([],d.model[d.config.name].alerts)),d.addContact=function(a){a.contactList||(a.contactList=[{email:"",phone:""}]),0==a.contactList.length&&(a.contactList=[{email:"",phone:""}]),d.contactList=a.contactList},d.addSchedule=function(a){a.schedule||(a.schedule={occure:"daily",dailyRecurs:1,weeklyRecurs:1,weeklySat:!1,weeklySun:!1,weeklyMon:!1,weeklyTus:!1,weeklyWen:!1,weeklyThu:!1,weeklyFri:!1,monthlyDayOf:1,monthlyRecurs:1,dailyFrequency:"once",dailyFrequencyAtHour:"1200",dailyFrequencyRecur:1,dailyFrequencyRecurType:"hour",dailyFrequencyStart:"1200",dailyFrequencyStop:"2359"}),d.schedule=a.schedule},d.addUser=function(a){function b(){a.userList&&0!=a.userList.length||(a.userList=d.serverUserList.map(function(a){return{name:a.name,id:a.id,username:a.username}})),d.userList=a.userList}d.serverUserList?b():c.get(app.urlPrefix+"Account/GetUsers").success(function(a){d.serverUserList=a.list,b()})},d.addRole=function(a){function b(){a.roleList&&0!=a.roleList.length||(a.roleList=d.serverRoleList.map(function(a){return{name:a.name,id:a.id}})),d.roleList=a.roleList}d.serverRoleList?b():c.get(app.urlPrefix+"Account/GetRoles").success(function(a){d.serverRoleList=a.list,b()})},d.changeItem=function(c,e){var f=a.extend({},c.rules[e]);app.indicator(d.model.series,f,function(a,d){b(function(){c.rules[e]=a},0)},[])},d.toggleSelectedSeries=function(a,b){a.selectedSeries||(a.selectedSeries=[]);var c=a.selectedSeries.indexOf(b);-1==c?a.selectedSeries.push(b):a.selectedSeries.splice(c,1)},d.persian=function(a){return persian(a)},d.mapOp={1:"برابر باشد با",2:"برابر نباشد با",3:"بزرگتر باشد از",4:"بزرگتر يا مساوي باشد از",5:"کوچکتر باشد از",6:"کوچکتر يا مساوي باشد از",7:"شامل",8:"نباشد شامل"}}],link:function(){app.lang.setLang()}}}])}(jQuery),function(a){var b=angular.module("management");b.filter("filterCalculateFields",function(){return function(a,b){for(var c=[],d=0;d<a.length;d++)b>d&&c.push(a[d]);return c}}),b.directive("calculateFields",function(){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/calculateField.html?v="+Math.random(),scope:{calculatedFields:"="},controller:["$scope","$mdDialog","$mdMedia",function(b,c,d){b.refreshChart=function(a){b.$parent.refreshChart(a)};var e=-1;b.add=function(a){e=-1,b.currentFormula={},b.showDialog(a)},b.edit=function(a,c){e=a,b.currentFormula={name:b.calculatedFields.fields[a].name,formula:b.calculatedFields.fields[a].formula},b.showDialog(c)},b.calculatedFields=b.calculatedFields||{},b.calculatedFields.fields=b.calculatedFields.fields||[],b.save=function(){if(!b.currentFormula.name)return alert("فیلد نام نمی تواند خالی باشد"),!1;var a=_.some(b.calculatedFields.fields,function(a){return a.name.trim()==b.currentFormula.name.trim()})||_.some(b.$parent.ngModel.series,function(a){return a.trim()==b.currentFormula.name.trim()});return!a||-1!=e&&b.calculatedFields.fields[e].name==b.currentFormula.name?(-1==e?b.calculatedFields.fields.push({name:b.currentFormula.name,formula:b.currentFormula.formula}):(b.calculatedFields.fields[e].name=b.currentFormula.name,b.calculatedFields.fields[e].formula=b.currentFormula.formula),!0):(alert("نام انتخابی تکراری است"),!1)},b.showDialog=function(e){c.show({controller:["$scope","$mdDialog",function(c,d){c.parent=b,c.cancel=function(){d.cancel()},c.save=function(){c.parent.save()&&(c.parent.refreshChart(),d.cancel())},c.addColumn=function(b,d){c.parent.currentFormula.formula||(c.parent.currentFormula.formula=""),c.parent.currentFormula.formula+=" {R+0, ["+b+"]} ",a(".formula-input").focus()}}],templateUrl:"editor/calc/calc-fields-modal.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0,fullscreen:d("sm")||d("xs")})}}],link:function(){app.lang.setLang()}}})}(jQuery),function(a){var b=angular.module("management");b.directive("dimMeasWhere",function(){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/dimMeasWhere.html?v="+app.version,scope:{dimensions:"=",measures:"=",where:"=",datasource:"=",model:"=?model"},controller:["$scope","$mdDialog","$mdMedia",function(a,b,c){a.model=a.model||{},a.model.selectedDimension=0,a.model.selectedMeasure=0,a.model.selectedwhere=0,a.changeFormula=function(a){a.members=null},a.refreshChart=function(b){a.$parent.refreshChart(b)},a.changeDimensionName=function(b,c){var d=c.Name,e=a.dimensions.concat(a.measures).concat(a.where).map(function(a){return a.Name})||[],f=e.filter(function(a){return a==d}).length>1;f?(c.Name=b,setTimeout(function(){alert("نام انتخاب شده تکراری است")},0)):a.refreshChart()},a.changeMeasureAggregation=function(b){var c=a.measures[+b].aggregation;"NONE"==c?a.measures[+b].formula=a.measures[+b].UniqueName:a.measures[+b].formula=c+"("+a.measures[+b].UniqueName+")",a.changeFormula(a.measures[+b])},a.showDialog=function(c,d){var e=c;b.show({controller:["$scope","$mdDialog",function(b,d){function f(a,c){a.renderer.setPadding(18),g=a.getSession(),b.insertFormula=function(b){a.insert(b),a.focus()}}switch(b.parent=a,c){case"dimention":b.formula=a.dimensions[a.model.selectedDimension].formula;break;case"measure":b.formula=a.measures[a.model.selectedMeasure].formula;break;case"where":b.formula=a.where[a.model.selectedwhere].formula}b.aceOption={useWrapMode:!0,showGutter:!1,theme:"sqlserver",mode:"sqlserver",maxLines:14,onLoad:f,require:["ace/ext/beautify"]};var g;b.aceOption.onChange=function(a){b.formula=g.getValue()},b.cancel=function(){d.cancel()},b.save=function(){switch(e){case"dimention":a.dimensions[a.model.selectedDimension].formula=b.formula;break;case"measure":a.measures[a.model.selectedMeasure].formula=b.formula;break;case"where":a.where[a.model.selectedwhere].formula=b.formula}d.cancel()}}],templateUrl:"editor/formula/edit.html",parent:angular.element(document.body),targetEvent:d,clickOutsideToClose:!1,fullscreen:!0})}}],link:function(){app.lang.setLang()}}})}(jQuery),function(a){var b=angular.module("management");b.directive("filterExcept",function(){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/filterExcept.html?v="+app.version,scope:{datasource:"=",filterException:"="},controller:["$scope","$mdDialog","$mdMedia",function(a,b,c){a.refreshChart=function(b){a.$parent.refreshChart(b)},a.toggleAllToList=function(b){a.filterException.allFields=a.filterException.allFields||[];var c=a.filterException.allFields.indexOf(b.UniqueName);-1!=c?a.filterException.allFields.splice(c,1):(a.filterException.allFields.push(b.UniqueName),a.filterException.fields=_.reject(a.filterException.fields,function(a){var c="\\[id"+b.UniqueName+"\\]";return new RegExp(c).test(a.UniqueName)}))},a.toggleToList=function(b){a.filterException.fields=a.filterException.fields||[];var c=_.filter(a.filterException.fields,{Name:b.Name,UniqueName:b.UniqueName});c.length?c.forEach(function(b){a.filterException.fields.splice(_.indexOf(a.filterException.fields,b),1)}):a.filterException.fields.push({Name:b.Name,UniqueName:b.UniqueName})},a.isInList=function(b){return _.filter(a.filterException.fields,{UniqueName:b.Name,UniqueName:b.UniqueName}).length},a.getDatasourceName=function(b){var c=_.find(a.datasource.CubeInfo.Dimensions,function(a){return a.UniqueName==b});return c?c.Name.replace(/as id\d+/gi,""):""},a.showDialog=function(d){b.show({controller:["$scope","$mdDialog",function(b,c){b.parent=a,b.cancel=function(){c.cancel()}}],templateUrl:"editor/filter-except/select-except-modal.html",parent:angular.element(document.body),targetEvent:d,clickOutsideToClose:!1,fullscreen:c("sm")||c("xs")})}}],link:function(){app.lang.setLang()}}})}(jQuery),function(a){var b=angular.module("management");b.service("myService",["$http",function(a){var b=null;this.getMenus=function(){return null==b&&(b=a.get(app.urlPrefix+"api/menus/get")),b}}]),b.factory("myFactory",function(){return{sayHello:function(a){return"Hi "+a+"!"}}}),b.directive("generalSettings",["myService","myFactory",function(a,b){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/generalSettings.html?v="+app.version,scope:{model:"=ngModel"},controller:["$scope",function(b){b.menus=[],a.getMenus().then(function(a){var a=a.data;0==a.filter(function(a){return-1==+a.id}).length&&a.push({id:-1,name:"لینک...",parent:"لینک دلخواه"}),b.menus=a},function(){b.error="خطا در دریافت اطلاعات"})}],link:function(){app.lang.setLang()}}}])}(jQuery),function(a){var b=angular.module("management");b.directive("globalVariable",function(){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/globalVariable.html?v="+app.version,
scope:{dimensions:"=",measures:"=",prop:"="},controller:["$scope",function(a){}],link:function(){app.lang.setLang()}}})}(jQuery),function(a){var b=angular.module("management");b.directive("numberFormat",function(){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/numberFormat.html?v="+app.version,scope:{model:"=ngModel"},controller:["$scope",function(b){b.model=a.extend({formatString:",.2f",formatStringCustom:",.2f"},b.model),b.refreshChart=function(a){b.$parent.refreshChart(a)}}],link:function(){app.lang.setLang()}}})}(jQuery),function(a){var b=angular.module("management");b.directive("textEditor",function(){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/textEditor.html?v="+app.version+new Date,scope:{model:"=prop"},controller:["$scope",function(b){b.model=a.extend({bold:!1,color:"#333333",italic:!1,fontSize:"10px",fontName:"IRANSans",formatString:",.2f",formatStringCustom:",.2f"},b.model)}],link:function(b,c,d){app.lang.setLang(),a(c).find(".ui.button").popup({popup:a(c).find(".ui.popup"),on:"click"})}}})}(jQuery),function(a){var b=angular.module("management");b.directive("mapSelector",["$timeout",function(b){return{restrict:"E",scope:{model:"=prop"},controller:["$scope","$http","$mdDialog","$mdMedia",function(b,c,d,e){b.model=a.extend({selectedMap:"1"},b.model),b.refreshList=function(){b.list=null,b.getList()},b.getList=function(){b.list||c.get(app.urlPrefix+"Moderation/Map/GetList").success(function(a){a.result&&(b.list=a.list)})},b.getList(),b.showUploadDialog=function(c){d.show({controller:["$scope","$mdDialog","$timeout","$mdToast",function(c,d,e,f){c.parent=b,c.cancel=function(){d.cancel()},c.selectFile=function(){a("#file-upload[type=file]").click()},c.upload=function(){function a(){e(function(){var a=f.simple().textContent("آپلود ناموفق بود");f.show(a)},0)}if(!c.name||!c.file){var b=f.simple().textContent("نام و فایل نقشه را وارد کنید");return void f.show(b)}var g=new FormData;g.append("file",c.file),g.append("name",c.name);var h=new XMLHttpRequest;h.upload.addEventListener("load",function(){e(function(){d.cancel();var a=f.simple().textContent("آپلود با موفقیت انجام شد");f.show(a)},0)}),h.upload.addEventListener("error",a),h.upload.addEventListener("abort",a),h.open("POST",app.urlPrefix+"Moderation/Map/Upload"),h.send(g)},c.d3=d3}],templateUrl:"editor/map/upload-map.html",parent:angular.element(document.body),targetEvent:c,clickOutsideToClose:!0,fullscreen:e("sm")||e("xs")})}}],templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/types/mapSelector.html?v="+app.version}}])}(jQuery),function(a){var b=angular.module("management");b.directive("tableIndicator",["$timeout",function(a){return{restrict:"E",scope:{prop:"=",dimensions:"=",measures:"=",config:"="},controller:["$scope","$http",function(a,b){a.prop[a.config.name]&&(a.prop[a.config.name].indicator=a.prop[a.config.name].indicator||[],a.model=a.prop[a.config.name].indicator,a.change=function(){a.$parent.refreshChart("refresh")},a.changeItem=function(a){})}],link:function(){app.lang.setLang()},templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/types/tableIndicator.html?v="+app.version}}])}(jQuery),function(a){var b=angular.module("management");b.directive("userControlVariableRelation",["$timeout",function(b){return{restrict:"E",scope:{prop:"=",dimensions:"="},controller:["$scope","$http",function(a,c){a.$watch("dimensions",function(b,c){a.prop.userControl.info.dimensions=a.dimensions,console.log("### chaneg dimension")},!0),a.list||c.get(app.urlPrefix+"Moderation/GlobalVariable/GetList").success(function(b){b.unshift({Id:"-1",Name:"NONE"}),a.list=b}),a.AddGlobalVariables=function(){app.globalVariableHelper.AddGlobalVariables(function(c){b(function(){a.list.push({Id:c.Id,Name:c.Name}),a.prop.userControl.info.variableId=c.Id+""},0)})}}],templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/types/variableRelation.html?v="+app.version,link:function(c,d,e){var f=e.selector;angular.element(a(f)).bind("default-value",function(a,d,e,f){b(function(){c.prop.userControl.info.variableDefault={values:e,type:f}},0)}),app.lang.setLang()}}}])}(jQuery),function(a){var b=angular.module("management");b.directive("datasourcePermission",["$timeout","$http","roles",function(a,b,c){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/datasource/datasourcePermission.html?v="+app.version,scope:{roles:"=ngModel",id:"@",type:"@"},controller:["$scope","$http",function(a,b){function d(){a.permissions&&a.roles&&_.forEach(a.roles,function(b){var c=_.find(a.permissions,{roleId:b.id});c&&(b.action=1==c.actionSum?1:3==c.actionSum?2:4,b.check=!0)})}var e=a.type&&"datasource"!=a.type?"chart"==a.type?"chart":"menu":"datasource";if(a.roles&&a.roles.length||c.get().then(function(b){a.roles=angular.merge({},b.data.list),_.forEach(a.roles,function(a){a.action=1,a.check=!1}),d()}),+a.id)switch(e){case"datasource":b.get(app.urlPrefix+"api/permissions/getDatasourcePermissions?id="+a.id).then(function(b){a.permissions=b.data.list,d()});break;case"chart":b.get(app.urlPrefix+"api/permissions/getChartPermissions?id="+a.id).then(function(b){a.permissions=b.data.list,d()});break;case"menu":b.get(app.urlPrefix+"api/permissions/getMenuPermissions?id="+a.id).then(function(b){a.permissions=b.data.list,d()})}}]}}])}(jQuery);var ngApp=angular.module("management");ngApp.controller("datasourcefileCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$window","$sce","datasources",function(a,b,c,d,e,f,g,h,i,j,k){function l(b){a.error=j.trustAsHtml("<b>"+b.data.title+"</b> <br/>"+b.data.desc)}function m(a){c.show({template:'<md-toast class="md-toast error"> <span class="md-toast-text" flex>'+a+"</span></md-toast>",hideDelay:3e3,position:"bottom left"})}function n(b){a.sheets=b.result,a.sheetName=a.sheets[0],a.changeSheet()}function o(b){var c="",d=_.map(b,function(a,b){return"<tr>"+_.map(a,function(a){return 0==b?"<th>"+a+"</th>":"<td>"+a+"</td>"}).join("")+"</tr>"}).join("");c='<table class="table">'+d+"</table>",a.testResult=j.trustAsHtml(c)}function p(){var a=$("#main-form").width();$("#testResult").css("max-width",a+"px"),$("#testResult").css("overflow","auto")}var q={MsOlap:1,MSSQL:2,MySQL:3,File:4,WebResource:5,JoinDatasource:6},r="undefined"!=typeof e.packageId?e.packageId:0,s="undefined"!=typeof e.id?e.id:0,t=(e.type,s>0);a.isEdit=t,a.id=s;var u=!1;t&&(b.get(app.urlPrefix+"api/datasources/get?type="+q.File+"&id="+s).then(function(b){a.name=b.data.name,a.keepHistory=b.data.keepHistory,u=b.data.keepHistory},l),b.get(app.urlPrefix+"Moderation/Excel/Sample?id="+s).then(function(a){a.data?o(a.data):($("#queryResult").html(""),$("#test-result").removeClass().addClass("alert alert-danger").show().find("span").html("اشکال در دریافت اطلاعات").append('<p style="text-align: left;margin-top:7px;">'+a.error+"</p>"))},l)),a.save=function(){if(a.error=null,!a.fileForm.$valid)return void m("فیلدهای ضروری باید پر شوند");a.testResult=null;var d=_.filter(a.roles,{check:!0}).map(function(a){return a.action+"-"+a.id});if(!a.keepHistory&&u){var e=confirm("در صورت ذخیره منبع داده، با توجه به عدم انتخاب گزینه نگهداری تاریخچه، رکوردهای قبلی پاک می‌شوند. آیا برای ادامه اطمینان دارید؟");if(!e)return}b.post(app.urlPrefix+"Moderation/Excel/save",{SheetName:a.sheetName,DataSourceName:a.name,KeepHistory:a.keepHistory,Id:s,PackageId:r,RolesActions:d,AceProvider:a.aceProvider}).then(function(a){function b(){window.history.length<=2?f.path("/datasources/"+r):window.history.back()}var d=c.simple().textContent(t?"تغییرات ثبت شد":"منبع داده جدید ایجاد شد");c.show(d),b(),k.reset()},l)},a.extention="XLS",a.aceProvider="12",a.progress=-1,a.changeSheet=function(){b.get(app.urlPrefix+"Moderation/Excel/data?sheetName="+encodeURIComponent(a.sheetName)+"&AceProvider="+a.aceProvider).then(function(b){b.data?o(b.data):a.error=j.trustAsHtml("اشکال در دریافت اطلاعات")})},$("#input-file-id").fileupload({dataType:"json",url:app.urlPrefix+"Moderation/Excel/UploadFiles",autoUpload:!1,done:function(a,b){h(function(){switch(b.formData.type){case"XLS":n(b);break;case"CSV":o(b.result);break;case"XML":}},0)},add:function(b,c){h(function(){a.uploadData=c,a.fileName=j.trustAsHtml(c.files[0].name+"<br><sub><b>حجم:</b> "+(c.files[0].size/1024).toFixed(2)+" KB</sub>");var b=c.files[0].name.match(/\.[^.]+$/);if(null!=b){var d=b[0];".xlsx"!=d&&"xls"!=d||(a.extention="XLS"),".csv"==d&&(a.extention="CSV"),".xml"==d&&(a.extention="XML")}},0)},error:function(b,c){h(function(){a.error=j.trustAsHtml('<div class="ltr"><b>'+b.responseJSON.title+"</b> <br/>"+b.responseJSON.desc+"</div>")},0)}}).on("fileuploadprogressall",function(b,c){var d=parseInt(c.loaded/c.total*100,10);h(function(){a.progress=d},0)}),a.uploadData,a.upload=function(){a.error=null,a.testResult=null,a.uploadData.formData={type:a.extention,aceProvider:a.aceProvider},a.uploadData.submit(),a.progress=0,p()}}]);var ngApp=angular.module("management");ngApp.service("interRelation",["$http",function(a){var b,c=function(){return b=a.get(app.urlPrefix+"moderation/datasourceInterRelation/get")};return{get:c,reset:function(){b=null}}}]),ngApp.controller("interRelationCtrl",["$scope","$http","$mdToast","$mdDialog","$translate","interRelation","$mdMedia","utils","toolbar",function(a,b,c,d,e,f,g,h,i){function j(b){d.show({controller:["$scope","$mdDialog","$timeout",function(b,c,d){b.parent=a,b.cancel=function(){c.cancel()}}],parent:angular.element(document.body),targetEvent:b,clickOutsideToClose:!0,fullscreen:g("sm")||g("xs"),templateUrl:"datasourceRelation/add-relation.html"})}a.utils=h,e("interRelation").then(function(a){i.setTitles([{name:a,click:null}])}),a.progress=!0,f.get().then(function(b){a.progress=!1,a.data=b.data.list.map(function(a){var b=JSON.parse(a.data);return b.conditions.forEach(function(a){if("string"==typeof a.left){var b=a.left;a.left={column:b,isText:!1,formula:null},a.op="="}if("string"==typeof a.right){var b=a.right;a.right={column:b,isText:!1,formula:null}}}),b.id=a.id,b}),a.getList(function(){a.modalRelationObject={conditions:[{}],left:-1,right:-1}})}),a.modalRelationObject={conditions:[{}],left:0,right:0};var k=!0;a.getList=function(c){k?(k=!1,b.get(app.urlPrefix+"Moderation/JoinDataSource/GetDatasourceList").success(function(b){a.datasourceList=b,c&&c()})):c&&c()},a.add=function(c){return 0==a.modalRelationObject.conditions.length?(alert("حداقل یک رابطه تعریف کنید"),!1):(a.modalRelationObject.name=a.datasourceList.filter(function(b){return+a.modalRelationObject.left==b.Id})[0].Name+" - "+a.datasourceList.filter(function(b){return+a.modalRelationObject.right==b.Id})[0].Name,void b.post(app.urlPrefix+"Moderation/DatasourceInterRelation/Save",JSON.stringify(a.modalRelationObject),{headers:{"Content-Type":"application/json; charset=utf-8"}}).success(function(b){if(b.result)if(a.modalRelationObject.id){var c=a.data.filter(function(b){return b.id==a.modalRelationObject.id})[0];c=angular.extend({},a.modalRelationObject)}else a.modalRelationObject.id=b.id,a.data.splice(a.data.length,0,a.modalRelationObject);else a.error=$sce.trustAsHtml(b.message)}))},a.cancel=function(){},a["new"]=function(b){a.modalRelationObject={conditions:[{op:"="}],left:0,right:0},j(b)},a.edit=function(b,c){a.modalRelationObject=c,j(b)},a["delete"]=function(e){var f=app.urlPrefix+"Moderation/DatasourceInterRelation/Delete",g=_.filter(a.data,{select:!0}).map(function(a){return a.id}),h=d.confirm().title("حذف برای همیشه؟").textContent(g.length+" مورد برای حذف انتخاب شده است").ariaLabel("حذف").targetEvent(e).ok("حذف!").cancel("لغو");d.show(h).then(function(){b.post(f,g).then(function(b){b.data.deleted&&(a.data=_.filter(a.data,function(a){return-1==b.data.deleted.indexOf(a.id)}));var d=c.simple().textContent("حذف انجام شد");c.show(d)})})},a.selectedCount=function(){return _.filter(a.data,{select:!0}).length},a.selectAll=function(){_.forEach(a.data,function(b){b.select=a.selectAllCheckbox})},a.restore=function(b){a.modalRelationObject=b},a.getLastFocus=function(b){a.lastFocus=b.target;var c=b.target;if(c)if("selectionStart"in c)a.selectionStart=c.selectionStart,a.selectionEnd=c.selectionEnd;else if(document.selection){c.focus();var d=document.selection.createRange(),e=document.selection.createRange().text.length;d.moveStart("character",-c.value.length),a.selectionStart=d.text.length-e}},a.addFormula=function(b,c){$(a.lastFocus).focus();var d=$(a.lastFocus).val(),e="[id"+c+"].["+b+"]",f=0;d=d.substring(0,a.selectionStart)+d.substring(a.selectionEnd,d.length);var g=d.substring(0,a.selectionStart)+e+d.substring(a.selectionStart,d.length);$(a.lastFocus).val(g);var h=$(a.lastFocus).get(0);h.setSelectionRange(a.selectionStart+f,a.selectionStart+f),a.selectionStart=a.selectionStart+f,a.selectionEnd=a.selectionStart}}]),ngApp.filter("filterColumns",function(){return function(a,b,c,d){if(a){var e=b.map(function(a){return c?a.left:a.right}).filter(function(a,b){return-1!=a&&b!=+d});return a.filter(function(a){return-1==e.indexOf(a)})}}});var ngApp=angular.module("management");ngApp.controller("datasourceJoinCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$window","$sce","$mdMedia","utils","datasources",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(b){a.saveProgress=!1,a.testProgress=!1,a.error=j.trustAsHtml("<b>"+b.data.title+"</b> <br/>"+b.data.desc)}function o(){2==window.history.length?f.path("/datasources/"+s):window.history.back()}function p(){return{id:t,isEdit:u,name:a.name,disable:a.disable,disableMessage:a.disableMessage,selectedDs:a.selectedDatasource.map(function(a){return a.Id}),selectedFields:a.selectedFields,relationsList:a.relationsList.map(function(a){return{left:a.left,right:a.right,includeRight:a.includeRight,includeLeft:a.includeLeft,repeatRows:a.repeatRows,conditions:a.conditions.map(function(a){return{left:a.left,right:a.right,op:a.op}})}}),script:a.script,relationType:a.relationType,aliasArray:JSON.stringify(a.aliasArray),isSchedule:a.isSchedule,schedule:a.schedule,partitions:a.partitions}}function n(b){a.saveProgress=!1,a.testProgress=!1,a.scriptProgress=!1,a.error=j.trustAsHtml("<b>"+b.data.title+"</b> <br/>")}function q(a,b){return d.show({controller:["$scope","$mdDialog","$timeout",function(a,c,d){function e(b,c){b.renderer.setPadding(18),a.insertFormula=function(a){b.insert(a),b.focus()}}a.cancel=function(){c.cancel()},a.save=function(){c.hide(a.formula)},b&&(a.formula=b),a.aceOption={useWrapMode:!0,showGutter:!1,theme:"sqlserver",mode:"sqlserver",maxLines:14,onLoad:e,require:["ace/ext/beautify"]}}],parent:angular.element(document.body),targetEvent:a,clickOutsideToClose:!0,fullscreen:!0,template:'<md-dialog aria-label="{{\'editor\' | translate}}" ng-cloak class="fullscreen-dialog">                                 <md-toolbar>                                                                                                                            <div class="md-toolbar-tools">                                                                                                          <h2>{{\'editor\' | translate}}</h2>                                                                                                   <span flex></span>                                                                                                                  <md-button class="md-icon-button" ng-click="cancel()">                                                                                  <span class="material-icons">close</span>                                                                                       </md-button>                                                                                                                    </div>                                                                                                                          </md-toolbar>                                                                                                                       <md-dialog-content layout-margin flex layout="row" class="md-dialog-contentx">                                                          <style>                                                                                                                                 .ace_editor {                                                                                                                           border: 1px solid #efefef;                                                                                                      }                                                                                                                                                                                                                                                                           .ace_editor, .ace_editor div {                                                                                                          font: 16px/normal \'Courier New\', \'Menlo\', \'Ubuntu Mono\', \'Consolas\', \'source-code-pro\', monospace;                              }                                                                                                                                                                                                                                                                   md-dialog.fullscreen-dialog {                                                                                                           max-width: 100%;                                                                                                                    max-height: 100%;                                                                                                                   width: 100%;                                                                                                                        height: 100%;                                                                                                                       border-radius: 0;                                                                                                               }                                                                                                                               </style>                                                                                                                                                                                                                                                                <div class="ltr" flex="100" ui-ace="aceOption" ng-model="formula">                                                                      select * from tbl_meuns                                                                                                         </div>                                                                                                                                                                                                                                                              </md-dialog-content>                                                                                                                <md-dialog-actions layout="row">                                                                                                        <md-button ng-click="save()">                                                                                                           {{ \'ذخیره\' | translate }}                                                                                                        </md-button>                                                                                                                        <md-button ng-click="cancel()">                                                                                                         {{ \'cancel\' | translate }}                                                                                                      </md-button>                                                                                                                    </md-dialog-actions>                                                                                                            </md-dialog>'})}var r={MsOlap:1,MSSQL:2,MySQL:3,File:4,WebResource:5,JoinDatasource:6};a.utils=l;var s="undefined"!=typeof e.packageId?e.packageId:0,t="undefined"!=typeof e.id?e.id:0,u=(e.type,t>0);a.isEdit=u,a.id=t,a.model={},u&&b.get(app.urlPrefix+"api/datasources/get?type="+r.JoinDatasource+"&id="+t).then(function(b){a.restore(b.data.model,b.data.list)},n);var v=!1;a.isSchedule=!1,a.selectedDatasource=[],a.selectedFields=[],a.relationsList=[],a.relationType="JOIN";var w=function(c){return a.datasourceListPromise||(a.datasourceListPromise=b.get(app.urlPrefix+"Moderation/JoinDataSource/GetDatasourceList")),a.datasourceListPromise};a.select=function(b){d.show({controller:["$scope","$mdDialog",function(b,c){w().then(function(c){a.datasourceList=c.data,b.datasourceList=c.data,_.forEach(b.datasourceList,function(a){a.check=!1})}),b.select=function(){_.filter(b.datasourceList,{check:!0}).forEach(function(b){a.addItemToDatasource(b.Id)}),c.hide()},b.cancel=function(){c.cancel()}}],templateUrl:"join/datasource_select.html",parent:angular.element(document.body),targetEvent:b,clickOutsideToClose:!0,fullscreen:k("sm")||k("xs")})},a.exploreDatasource=function(c,e){d.show({controller:["$scope","$mdDialog",function(d,e){d.exploreError=null,d.explor=null,b.post(app.urlPrefix+"Moderation/JoinDataSource/ExploreDatasource",JSON.stringify({Id:a.selectedDatasource[c].Id}),{headers:{"Content-Type":"application/json; charset=utf-8"}}).then(function(a){d.exploreError=null;var b=_.map(a.data.datasourceExplore,function(a,b){return"<tr>"+_.map(a,function(a){return 0==b?"<th>"+a+"</th>":"<td>"+a+"</td>"}).join("")+"</tr>"}).join("");d.explor=j.trustAsHtml('<table class="table">'+b+"</table>")},function(b){a.exploreError=j.trustAsHtml(b.data.title+"<br/>"+b.data.desc)}),d.cancel=function(){e.cancel()}}],templateUrl:"join/datasource_explor.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0,fullscreen:k("sm")||k("xs")})},a.showRelationDialog=function(b){d.show({controller:["$scope","$mdDialog",function(b,c){b.$scope=a,b.cancel=function(){a.cancelItemtoRelationsList(),c.cancel()},b.ok=function(){a.addItemtoRelationsList(),c.hide()}}],templateUrl:"join/datasource_add_relation.html",parent:angular.element(document.body),targetEvent:b,clickOutsideToClose:!0,fullscreen:k("sm")||k("xs")})},a.addItemToDatasource=function(b){var c=a.selectedDatasource.filter(function(a){return a.Id.replace(/(\d+)-\d+/,"$1")==b}).length,d=a.datasourceList.filter(function(a){return a.Id==b});if(d&&d.length>0){for(var e=[],f=0;f<d[0].PartitionCount;f++)e.push({index:f,check:!0});a.selectedDatasource.push({Id:d[0].Id+"-"+c,Name:d[0].Name+(c>0?" شماره"+c:""),Fields:d[0].Fields,Partitions:e})}},a.removeSelectedDatasource=function(b){var c=a.selectedDatasource[b];a.selectedDatasource.splice(b,1),a.relationsList=a.relationsList.filter(function(a){return a.left!=c.Id&&a.right!=c.Id}),a.selectedFields=a.selectedFields.filter(function(a){var b=a.split(",");return b[0]!=c.Id})},a.persian=function(a){return persian(a)},a.aliasArray={},a.toggleSelectedFields=function(b){var c=a.selectedFields.indexOf(b);c>-1?a.selectedFields.splice(c,1):a.selectedFields.push(b)},a.toggleSelectedFieldsCheckAll=function(b,c){for(var d=$(c.target).prop("checked"),e=0;e<b.Fields.length;e++){var f=b.Id+","+e,g=a.selectedFields.indexOf(f);g>-1&&!d&&a.selectedFields.splice(g,1),-1==g&&d&&a.selectedFields.push(f)}},a.addRelationLimit=function(){a.modalRelationObject.conditions.push({left:0,op:"=",right:0})},a.removeRelationLimit=function(b){a.modalRelationObject.conditions.splice(b,1)},a.addItemtoRelationsList=function(){v||a.relationsList.push(a.modalRelationObject),a.cancelItemtoRelationsList()},a.cancelItemtoRelationsList=function(){v=!1,a.modalRelationObject={conditions:[{left:0,op:"=",right:0}],left:"0",right:"0",includeRight:!0,includeLeft:!0,repeatRows:!1}},a.editRelation=function(b){v=!0,$("#add-relation-modal").modal("show"),a.modalRelationObject=a.relationsList[b]},a.cancel=function(){o()},a.deleteDatasource=function(a){$(a.target).button("loading");var c=$("#datasource-id").val();b.post(app.urlPrefix+"Moderation/JoinDataSource/Delete",JSON.stringify({id:c}),{headers:{"Content-Type":"application/json; charset=utf-8"}}).success(function(b){$(a.target).button("reset"),b.result&&app.router.navigate("Moderation/DataSource/index/",{trigger:!0})})},a.restore=function(b,c){a.isEdit=!0,a.datasourceList=c,b.selectedDs=b.selectedDs||[],c.forEach(function(c){for(var d=b.selectedDs.filter(function(a){return+a.replace(/(\d+)-\d+/,"$1")==+c.Id}),e=0;e<d.length;e++){for(var f=d[e],g=+f.replace(/(\d+)-(\d+)/,"$2"),h=[],e=0;e<c.PartitionCount;e++)h.push({index:e,check:!0});var i={Id:f,Name:c.Name+(g>0?" شماره"+g:""),Fields:c.Fields,Partitions:h};a.selectedDatasource.push(i)}}),a.selectedFields=b.selectedFields||[],a.relationsList=b.relationsList||[],a.name=b.name,a.disable=b.disable,a.disableMessage=b.disableMessage,a.script=b.script,a.relationType=b.relationType,a.aliasArray=JSON.parse(b.aliasArray),a.isSchedule=b.isSchedule,a.schedule=b.schedule,a.partitions=b.partitions||[]},a.saveJoin=function(c){var d=p();d.packageId=s,d.RolesActions=_.filter(a.roles,{check:!0}).map(function(a){return a.action+"-"+a.id}),a.saveProgress=!0,b.post(app.urlPrefix+"Moderation/JoinDataSource/SaveRelation",JSON.stringify(d),{headers:{"Content-Type":"application/json; charset=utf-8"}}).then(function(b){a.saveProgress=!1,a.error=null,o(),m.reset()},n)},a.getScript=function(c){var d=p();a.scriptProgress=!0,b.post(app.urlPrefix+"Moderation/JoinDataSource/GetScript",JSON.stringify(d),{headers:{"Content-Type":"application/json; charset=utf-8"}}).success(function(b){a.scriptProgress=!1,b.result?(a.script=b.script,a.error=null):a.error=j.trustAsHtml(b.message)})},a.test=function(c){var d=p();a.testProgress=!0,b.post(app.urlPrefix+"Moderation/JoinDataSource/Test",JSON.stringify(d),{headers:{"Content-Type":"application/json; charset=utf-8"}}).success(function(b){a.testProgress=!1,b.result?(a.testResult=b.queryResult,a.error=null):a.error=j.trustAsHtml(b.message)})},a.modalRelationObject={conditions:[{left:0,op:"=",right:0}],left:"0",right:"0",includeRight:!0,includeLeft:!0,repeatRows:!1},a.showDialog=function(b){q(b,a.script).then(function(b){a.script=b})}}]);var ngApp=angular.module("management");ngApp.controller("datasourceListCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$translate","datasources","utils","toolbar",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(){return _.map(_.filter(a.data,{select:!0}),function(a){return[a.id,a.type]})}function n(b){var c=_.lastIndexOf(a.data.map(function(a){return a.type}),1);-1==c?a.data=b.concat(a.data):Array.prototype.splice.apply(a.data,[c+1,0].concat(b))}function o(b){a.data=_.filter(a.data,function(a){return!_.some(b,{id:a.id,type:a.type})})}function p(a){k.showErrorToast(a.data.desc)}a.utils=k;var q="undefined"!=typeof e.id?e.id:0;a.app=app;var r=q?"?packageId="+q:"";a.progress=!0,b.get(app.urlPrefix+"api/datasources/get"+r).then(function(b){a.progress=!1,a.data=b.data.list,i("لیست منابع داده").then(function(c){a.listTranslate=c,b.data.path.unshift({name:c,id:null}),a.path=b.data.path.map(function(b){return b.click=function(){a["goto"]({type:1,id:b.id})},b}),l.setTitles(a.path)})},p);var s=function(){return _.some(a.data,{select:!0})};a.menuInvalidate=function(){console.log("#### menuInvalidate");var b=s(),c=_.filter(a.data,{select:!0,type:1}).length,d=_.filter(a.data,{select:!0,type:2}).length;a.canCopy=b,a.canDelete=b,a.canForward=b,a.canDirEdit=1==c&&0==d},a.copy=function(){var d=app.urlPrefix+"Moderation/Datasource/Clone",e=m();b.post(d,e).then(function(b){if(b.data.result){b.data.datasources&&(a.data=a.data.concat(b.data.datasources)),b.data.packages&&n(b.data.packages);var d=c.simple().textContent("کپی انجام شد");c.show(d)}},p)},a["delete"]=function(e){var f=app.urlPrefix+"Moderation/Datasource/Delete",g=m(),h=d.confirm().title("حذف برای همیشه؟").textContent(g.length+" مورد برای حذف انتخاب شده است").ariaLabel("حذف").targetEvent(e).ok("حذف!").cancel("لغو");d.show(h).then(function(){b.post(f,g).then(function(b){if(b.data.result){b.data.deletedIds&&o(b.data.deletedIds);var d=c.simple().textContent("حذف انجام شد");c.show(d),a.menuInvalidate()}},p)},function(){a.status="You decided to keep your debt."})},a.forward=function(a){j.select(a,{type:["datasources"],justDir:!0,selectableDir:!0,multipleChart:!1}).then(function(a){var d=a.selected[0];if(e.id==d.id){var f=c.simple().textContent("موارد انتخاب شده در همین پوشه هستند");return void c.show(f)}var g=m();b.post(app.urlPrefix+"Moderation/Datasource/MoveToPackage",{Ids:g,packageId:d.id}).then(function(a){o(a.data.ids);var b=c.simple().textContent("انتقال انجام شد");c.show(b)},p)})},a.dirEdit=function(b){var d=m();g.edit(b,2,d[0][0],function(b){_.find(a.data,{select:!0}).name=b.data.info.Name;var d=c.simple().textContent("نام پوشه تغییر کرد");c.show(d)},p)},a.newPackage=function(a){g.create(a,2,e.id,function(a){n([{id:a.data.info.Id,name:a.data.info.Name,type:1}]);var b=c.simple().textContent("پوشه جدید ایجاد شد");c.show(b),j.reset()},p)},a.insertChart=function(a,b){f.path("charts/new/normal/0/"+a.id)},a.gotoChart=function(a){f.path("charts/edit/0/"+a.id)},a["goto"]=function(a,b){var c={MsOlap:1,MSSQL:2,MySQL:3,File:4,WebResource:5,JoinDatasource:6};if(1==a.type)f.path("datasources"+(a.id?"/"+a.id:""));else if(2==a.type)switch(a.dsType){case c.MySQL:f.path("datasources/add/mssql/"+c.MySQL+"/"+q+"/"+a.id);break;case c.MsOlap:f.path("datasources/add/mssql/"+c.MsOlap+"/"+q+"/"+a.id);break;case c.MSSQL:f.path("datasources/add/mssql/"+c.MSSQL+"/"+q+"/"+a.id);break;case c.File:f.path("datasources/add/file/"+q+"/"+a.id);break;case c.WebResource:f.path("datasources/add/web/"+q+"/"+a.id);break;case c.JoinDatasource:f.path("datasources/add/join/"+q+"/"+a.id)}},a.getTypeName=function(a){var b=1,c=2,d=3,e=4,f=5,g=6,h="";switch(+a){case b:h="MsOlap";break;case c:h="MSSQL";break;case d:h="MySQL";break;case e:h="File";break;case f:h="WebResource";break;case g:h="JoinDatasource"}return h};var t;a.$watch("search",function(){h.cancel(t),t=h(function(){"undefined"!=typeof a.search&&(a.progress=!0,b.get(app.urlPrefix+"api/datasources/get?q="+a.search).then(function(b){a.progress=!1,a.data=b.data.list,a.path=b.data.path,a.path.unshift({name:"لیست منابع داده",id:null})},p))},400)}),a.selectAll=function(){a.data&&_.forEach(a.data,function(b){b.select=a.selectAllCheckbox}),a.menuInvalidate()},a.newDatasource=function(a){f.path("datasources/new/"+(e.id?e.id:""))},a.addTimeDatasoure=function(c){i(["Create Time Datasource","Enter the datasource name.","name","ok","cancel"]).then(function(e){var f=d.prompt().title(e["Create Time Datasource"]).textContent(e["Enter the datasource name."]).placeholder(e.name).ariaLabel(e.name).targetEvent(c).ok(e.ok).cancel(e.cancel);d.show(f).then(function(c){b.get(app.urlPrefix+"api/datasources/createDatetimeDatasource?name="+c).then(function(b){a.data.push(b.data)},function(){alert("خطایی در ساخت منبع داده رخ داده است")})})})},a.sortDetail={},a.sort=function(b){a.sortDetail[b]=a.sortDetail[b]||{},a.sortDetail[b].isDesc=!a.sortDetail[b].isDesc;var c=_.filter(a.data,{type:1}),d=_.filter(a.data,{type:2});d=_.sortBy(d,[b]),c=_.sortBy(c,[b]),a.sortDetail[b].isDesc||(d=_.reverse(d),c=_.reverse(c)),a.data=c.concat(d)}}]);var ngApp=angular.module("management");ngApp.controller("datasourceMssqlCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$window","$sce","roles","datasources",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(b){a.error=j.trustAsHtml("<b>"+b.data.title+"</b> <br/>")}function n(a){c.show({template:'<md-toast class="md-toast error"> <span class="md-toast-text" flex>'+a+"</span></md-toast>",
hideDelay:3e3,position:"bottom left"})}function o(){2==window.history.length?f.path("/datasources/"+s):window.history.back()}function p(){$("md-content").animate({scrollTop:4e3},500)}function q(a,b){return d.show({controller:["$scope","$mdDialog","$timeout",function(a,c,d){function e(b,c){b.renderer.setPadding(18),a.insertFormula=function(a){b.insert(a),b.focus()}}a.cancel=function(){c.cancel()},a.save=function(){c.hide(a.formula)},b&&(a.formula=b),a.aceOption={useWrapMode:!0,showGutter:!1,theme:"sqlserver",mode:"sqlserver",maxLines:14,onLoad:e,require:["ace/ext/beautify"]}}],parent:angular.element(document.body),targetEvent:a,clickOutsideToClose:!0,fullscreen:!0,template:'<md-dialog aria-label="{{\'editor\' | translate}}" ng-cloak class="fullscreen-dialog">                                 <md-toolbar>                                                                                                                            <div class="md-toolbar-tools">                                                                                                          <h2>{{\'editor\' | translate}}</h2>                                                                                                   <span flex></span>                                                                                                                  <md-button class="md-icon-button" ng-click="cancel()">                                                                                  <span class="material-icons">close</span>                                                                                       </md-button>                                                                                                                    </div>                                                                                                                          </md-toolbar>                                                                                                                       <md-dialog-content layout-margin flex layout="row" class="md-dialog-contentx">                                                          <style>                                                                                                                                 .ace_editor {                                                                                                                           border: 1px solid #efefef;                                                                                                      }                                                                                                                                                                                                                                                                           .ace_editor, .ace_editor div {                                                                                                          font: 16px/normal \'Courier New\', \'Menlo\', \'Ubuntu Mono\', \'Consolas\', \'source-code-pro\', monospace;                              }                                                                                                                                                                                                                                                                   md-dialog.fullscreen-dialog {                                                                                                           max-width: 100%;                                                                                                                    max-height: 100%;                                                                                                                   width: 100%;                                                                                                                        height: 100%;                                                                                                                       border-radius: 0;                                                                                                               }                                                                                                                               </style>                                                                                                                                                                                                                                                                <div class="ltr" flex="100" ui-ace="aceOption" ng-model="formula">                                                                      select * from tbl_meuns                                                                                                         </div>                                                                                                                                                                                                                                                              </md-dialog-content>                                                                                                                <md-dialog-actions layout="row">                                                                                                        <md-button ng-click="save()">                                                                                                           {{ \'ذخیره\' | translate }}                                                                                                        </md-button>                                                                                                                        <md-button ng-click="cancel()">                                                                                                         {{ \'cancel\' | translate }}                                                                                                      </md-button>                                                                                                                    </md-dialog-actions>                                                                                                            </md-dialog>'})}var r={MsOlap:1,MSSQL:2,MySQL:3,File:4,WebResource:5,JoinDatasource:6},s="undefined"!=typeof e.packageId?e.packageId:0,t="undefined"!=typeof e.id?e.id:0,u=e.type,v=t>0;a.id=t,a.isEdit=v,a.type=u,a.schedule={},a.schedulePartition=[],v?b.get(app.urlPrefix+"api/datasources/get?type="+u+"&id="+t).then(function(b){a.model=b.data.model,a.model.Schedule&&(a.schedule=JSON.parse(a.model.Schedule)),a.model.schedulePartition&&(a.schedulePartition=JSON.parse(a.model.schedulePartition)),a.model.Type=u},m):a.model={Authentication:0,CollationDefault:1,AutoRefresh:15,Type:u},a.saveProgress=!1,a.cancel=function(){o()},a.save=function(){return a.error=null,a.testResult=null,a.mssql.$valid?(a.model.Schedule=JSON.stringify(a.schedule),a.model.schedulePartition=JSON.stringify(a.schedulePartition),a.model.RolesActions=_.filter(a.roles,{check:!0}).map(function(a){return a.action+"-"+a.id}),a.saveProgress=!0,void b.post(app.urlPrefix+"Moderation/Datasource/AddMsOlap",{model:a.model,Type:u,IsEdit:v,PackageId:s}).then(function(b){a.saveProgress=!1;var d=c.simple().textContent(v?"تغییرات ثبت شد":"منبع داده جدید ایجاد شد");c.show(d),o(),l.reset()},function(b){a.saveProgress=!1,a.error=j.trustAsHtml("<b>"+b.data.title+"</b> <br/>"),p()})):void n("فیلدهای ضروری باید پر شوند")},a.testProgress=!1,a.test=function(){return a.error=null,a.testResult=null,a.mssql.$valid?(a.model.Schedule=JSON.stringify(a.schedule),a.model.schedulePartition=JSON.stringify(a.schedulePartition),a.testProgress=!0,void b.post(app.urlPrefix+"Moderation/Datasource/TestMsOlap",{model:a.model}).then(function(b){a.testProgress=!1;var c="";if(u!=r.MsOlap||a.model.Query){var d=_.map(b.data.queryResult,function(a,b){return"<tr>"+_.map(a,function(a){return 0==b?"<th>"+a+"</th>":"<td>"+a+"</td>"}).join("")+"</tr>"}).join("");c='<table class="table">'+d+"</table>"}u!=r.MsOlap||a.model.Query||(c='<div style="background-color:#dff0d8" flex>اتصال با موفقیت برقرار شد</div>'),a.testResult=j.trustAsHtml(c)},function(b){a.testProgress=!1,a.error=j.trustAsHtml("<b>"+b.data.title+"</b> <br/>"),p()})):void n("فیلدهای ضروری باید پر شوند")},a.showDialog=function(b){q(b,a.model.Query).then(function(b){a.model.Query=b})}}]);var ngApp=angular.module("management");ngApp.controller("datasourceNewCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout",function(a,b,c,d,e,f,g,h){var i={MsOlap:1,MSSQL:2,MySQL:3,File:4,WebResource:5,JoinDatasource:6},j="undefined"==typeof e.id?0:e.id;a.list=[{href:"datasources/add/mssql/"+i.MSSQL+"/"+j,icon:app.urlPrefix+"Images/ds-type-db.png",title:"پایگاه داده Microsoft SQL Server",desc:"در این قسمت می‌توانید به پایگاه داده‌ MSSQL متصل شوید"},{href:"datasources/add/mssql/"+i.MsOlap+"/"+j,icon:app.urlPrefix+"Images/ds-type-xmla.png",title:"Microsoft Analysis Service ",desc:"در این قسمت می‌توانید به سرویس آنالیز مایکروسافت متصل شوید"},{href:"datasources/add/file/"+j,icon:app.urlPrefix+"Images/ds-type-upload.png",title:"آپلود کردن فایل",desc:"آپلود کردن فایل‌های Excel یا CSV "},{href:"datasources/add/web/"+j,icon:app.urlPrefix+"Images/ds-type-point.png",title:"منابع روی وب",desc:"دسترسی به منابع داده‌ای مثل XML, CSV, JSON از طریق وب. برای دسترسی به این منابع داده باید آدرس URL مربوط به منبع داده را در اختیار داشته باشید"},{href:"datasources/add/join/"+j,icon:app.urlPrefix+"Images/join-datasource.png",title:"یکی کردن منابع داده",desc:"یکپارچه کردن منابع داده موجود. ارتباط منابع داده خود را در این قسمت تعریف کنید."}],a["goto"]=function(a){console.log(a),f.path(a.href)}}]),function(a){var b=angular.module("datasourcePartitionExpressionCat",["ngAnimate","ui.mask","datasourceScheduleCat"]);b.directive("partitionExpression",["$timeout","$http",function(b,c){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/datasource/PartitionExprission.html",scope:{type:"=?",datasources:"=?",partition:"=ngModel"},controller:["$scope","$http",function(c,d){c.type||(c.type=1),c.partition||(c.partition=[]),c.newPartition=function(){c.partition.push({formulas:[{}],datasources:[],autoRefresh:60,schedule:{}}),b(function(){app.lang.setLang()},0)},c.getPartitionName=function(a){var b={0:"اول",1:"دوم",2:"سوم",3:"چهارم",4:"‍‍‍پنجم",5:"ششم",6:"هفتم",7:"هشتم",8:"نهم",9:"دهم"};return 10>+a?b[+a]:"اضافه"},c.addDatasourceToPartition=function(d){var e=c.datasources.filter(function(a){return a.Id==d.id});e.length>0?d.partitions=a.extend(!0,[],e[0].Partitions):d.partitions=[],b(function(){app.lang.setLang()},0)},app.lang.setLang()}],link:function(){app.lang.setLang()}}}])}(jQuery),function(a){var b=angular.module("datasourceScheduleCat",["ngAnimate","ui.mask","ngMaterial"]);b.directive("datasourceSchedule",["$timeout","$http",function(a,b){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/datasource/Schedule.html?v="+app.version,scope:{model:"=?ngModel"},controller:["$scope","$http","$element","$mdMedia","$mdDialog",function(a,b,c,d,e){function f(b,c){b.model=a.model,b.cancel=function(){c.cancel()},b.checkValue=function(){"second"==b.model.dailyFrequencyRecurType&&+b.model.dailyFrequencyRecur<10&&(b.model.dailyFrequencyRecur=10)},b.save=function(){c.hide(b.model)}}a.model&&a.model.occure||(a.model={occure:"daily",dailyRecurs:1,weeklyRecurs:1,weeklySat:!0,weeklySun:!1,weeklyMon:!1,weeklyTus:!1,weeklyWen:!1,weeklyThu:!1,weeklyFri:!1,monthlyDayOf:1,monthlyRecurs:1,dailyFrequency:"once",dailyFrequencyAtHour:"0600",dailyFrequencyRecur:1,dailyFrequencyRecurType:"hour",dailyFrequencyStart:"0001",dailyFrequencyStop:"2359"}),a.formatClock=function(a){var b=a+"";return b.substr(0,2)+":"+b.substr(2)},a.edit=function(a){function b(a){}var c=d("sm")||d("xs");e.show({controller:["$scope","$mdDialog",f],templateUrl:app.urlPrefix+"dist/partial/management/datasource/scheduleDialog.html?v="+Math.random(),parent:angular.element(document.body),targetEvent:a,clickOutsideToClose:!0,fullscreen:c}).then(b)}}]}}])}(jQuery);var ngApp=angular.module("management");ngApp.controller("datasourceWebCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$window","$sce","datasources",function(a,b,c,d,e,f,g,h,i,j,k){function l(b){a.saveProgress=!1,a.testProgress=!1,a.error=j.trustAsHtml("<b>"+b.data.title+"</b> <br/>"+b.data.desc)}function m(b){a.model.isEdit=s,a.model.isTest=b,a.model.id=r,a.model.parameters=a.parameters.filter(function(a){return a.name}).map(function(a){return[a.name,a.value,a.type]}),a.model.Schedule=JSON.stringify(a.schedule),a.model.RolesActions=_.filter(a.roles,{check:!0}).map(function(a){return a.action+"-"+a.id})}function n(){2==window.history.length?f.path("/datasources/"+q):window.history.back()}function o(a){c.show({template:'<md-toast class="md-toast error"> <span class="md-toast-text" flex>'+a+"</span></md-toast>",hideDelay:3e3,position:"bottom left"})}var p={MsOlap:1,MSSQL:2,MySQL:3,File:4,WebResource:5,JoinDatasource:6},q="undefined"!=typeof e.packageId?e.packageId:0,r="undefined"!=typeof e.id?e.id:0,s=(e.type,r>0);a.isEdit=s,a.id=r,a.model={contentType:"1"},s&&b.get(app.urlPrefix+"api/datasources/get?type="+p.WebResource+"&id="+r).then(function(b){a.model=b.data.model,a.model.Schedule&&(a.schedule=JSON.parse(a.model.Schedule)),a.model.parameters&&(a.parameters=a.model.parameters.map(function(a){return{name:a[0],value:a[1],select:a[2]||"Query"}}))},l),a.schedule={},a.parameters=[{select:"Query"}],a.saveProgress=!1,a.save=function(){return a.error=null,a.testResult=null,a.webForm.$valid?(m(!1),link=app.urlPrefix+"Moderation/WebResource/Add",a.saveProgress=!0,void b.post(link,a.model).then(function(b){a.saveProgress=!1;var d=c.simple().textContent(s?"تغییرات ثبت شد":"منبع داده جدید ایجاد شد");c.show(d),n(),k.reset()},l)):void o("فیلدهای ضروری باید پر شوند")},a.testProgress=!1,a.test=function(){return a.error=null,a.testResult=null,a.webForm.$valid?(m(!0),link=app.urlPrefix+"Moderation/WebResource/Add",a.testProgress=!0,void b.post(link,a.model).then(function(b){a.testProgress=!1;var c="",d=_.map(b.data.list,function(a,b){return"<tr>"+_.map(a,function(a){return 0==b?"<th>"+a+"</th>":"<td>"+a+"</td>"}).join("")+"</tr>"}).join("");c='<table class="table">'+d+"</table>",a.testResult=j.trustAsHtml(c)},l)):void o("فیلدهای ضروری باید پر شوند")}}]);var ngApp=angular.module("management");ngApp.service("indicator",["$mdDialog","$mdMedia","$rootScope","templates","$http",function(a,b,c,d,e){var f=function(c,e){function f(a,b){a.cancel=function(){b.cancel()}}var g=b("sm")||b("xs");return a.show({controller:["$scope","$mdDialog",f],parent:angular.element(document.body),targetEvent:c,clickOutsideToClose:!0,fullscreen:g,templateUrl:d.tmpl.package_dialog})};return{get:f}}]);var ngApp=angular.module("management");ngApp.service("packages",["$mdDialog","$mdMedia","$rootScope","$http",function(a,b,c,d){function e(a,b){return f||(f=d.post(app.urlPrefix+"Moderation/Package/GetPackagesObject",{scope:a,withContent:b})),f}var f,g=function(c,d,f,g,h){function i(a,b){function c(a,b){b(a),a.subPackages&&_.forEach(a.subPackages,function(a){c(a,b)})}e(d,f).then(function(b){a.root=b.data.root,console.log("set root in package service ",a.root)}),a.clearSelect=function(){c(a.root,function(a){a.select=!1})},a.cancel=function(){b.cancel()},a.select=function(){var d=null;c(a.root,function(a){a.select&&(d=a)}),b.hide(d)}}var j=b("sm")||b("xs");a.show({controller:i,templateUrl:app.urlPrefix+"dist/partial/management/packages/select-package.html",parent:angular.element(document.body),targetEvent:c,clickOutsideToClose:!0,fullscreen:j}).then(g,h)},h=function(b,c,e,g,h,i){var j=a.prompt().title("ایجاد پوشه جدید").textContent("نام پوشه جدید را وارد کنید").placeholder("نام پوشه").ariaLabel("نام پوشه").targetEvent(b).ok("ایجاد").cancel("لغو");a.show(j).then(function(a){f=null,d.post(app.urlPrefix+"Moderation/Package/Create",{name:a,scope:c,parentId:e}).then(g,h)},i)},i=function(b,c,e,g,h,i){var j=a.prompt().title("تغییر نام پوشه").textContent("نام جدید را وارد کنید").placeholder("نام پوشه").ariaLabel("نام پوشه").targetEvent(b).ok("تغییر").cancel("لغو");a.show(j).then(function(a){f=null,d.post(app.urlPrefix+"Moderation/Package/Edit",{id:e,name:a}).then(g,h)},i)};return{name:"packages",select:g,create:h,edit:i}}]);var ngApp=angular.module("management");ngApp.service("menus",["$http",function(a){function b(b){return c||(c=a.get(app.urlPrefix+"api/menus/get"+(b?"?JusetEdit=true":""))),c}var c;return{get:b,getEditable:function(){return b(!0)}}}]);var ngApp=angular.module("services");ngApp.service("roles",["$http",function(a){function b(){return console.log("role service"),d||(d=a.get(app.urlPrefix+"api/roles/get")),d}function c(){d=null}var d;return{get:b,reset:c}}]),ngApp.directive("selectRoles",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",settings:"=?"},controller:["$scope","$http","roles",function(a,b,c){a.model=a.model||[],a.settings=a.settings||{},c.get().then(function(b){a.roles=_.extend([],b.data.list)})}],template:'<div>                     <sm-dropdown class="selection search multiple fluid"  settings="{fullTextSearch: true}" model="model" items="roles" label="item.name" value="item.id" ></sm-dropdown>                   </div>',link:function(a,b,c){}}});var ngApp=angular.module("management");ngApp.service("utils",["$http","$translate","$sce","$mdToast",function(a,b,c,d){function e(a,b){var c={0:"۰",1:"۱",2:"۲",3:"۳",4:"۴",5:"۵",6:"۶",7:"۷",8:"۸",9:"۹"};return a+="",a.replace(/(\d)/g,function(a,b){return c[b]||a})}function f(a){var b={"۰":0,"۱":1,"۲":2,"۳":3,"۴":4,"۵":5,"۶":6,"۷":7,"۸":8,"۹":9};return a+="",a.replace(/([۰۱۲۳۴۵۶۷۸۹])/g,function(a,c){return"undefined"!=typeof b[c]?b[c]:a})}function g(a){var b={"ي":"ی","إ":"ا","ؤ":"و","أ":"ا","ک":"ك"};return a+="",a.replace(/(.)/g,function(a,c){return b[c]||a})}function h(a){var b=c.trustAsHtml("<b>"+a.data.title+"</b> <br/>"+a.data.desc);j&&j(b)}function i(a){d.show({template:'<md-toast class="md-toast error"> <span class="md-toast-text" flex>'+a+"</span></md-toast>",hideDelay:3e3,position:"bottom left"})}var j,k=function(a){j=a};return{persian:e,depersian:f,normilize:g,error:h,onError:k,showErrorToast:i}}]);var cat=angular.module("settingsCat",["ngAnimate"]);cat.controller("myController",["$scope","$http","$sce","$timeout",function(a,b,c,d){a.langs=[{key:0,value:"فارسی"},{key:1,value:"English"}],a.save=function(d){$(d.target).button("loading"),b.post(app.urlPrefix+"Moderation/Settings/GeneralSettings",JSON.stringify({Brand:a.brand,Language:a.language}),{headers:{"Content-Type":"application/json; charset=utf-8"}}).success(function(b){$(d.target).button("reset"),b.result?($("a.navbar-brand").text(b.brand),window.history.back()):a.error=c.trustAsHtml(b.error)})},a.restore=function(b){b&&d(function(){var c=JSON.parse(b);console.log(c),a.brand=c.Brand,a.language=c.Language},0)}}]);var cat=angular.module("settingsCat",["ngAnimate"]);cat.controller("myController",["$scope","$http","$sce","$timeout",function(a,b,c,d){a.save=function(d){debugger;b.post(app.urlPrefix+"Moderation/Settings/Mail",JSON.stringify({port:a.port,host:a.host,ssl:a.ssl,timeout:a.timeout,username:a.username,password:a.password}),{headers:{"Content-Type":"application/json; charset=utf-8"}}).success(function(b){b.result?window.history.back():a.error=c.trustAsHtml(b.error)})},a.restore=function(b){b&&d(function(){var c=JSON.parse(b);console.log("[settingsCat] "),console.log(c),a.port=c.port,a.host=c.host,a.ssl=c.ssl,a.timeout=c.timeout,a.username=c.username,a.password=c.password},0)}}]);
// داشبورد مدیریتی صدف info@sadafdashboard.ir 

function prepareData(a,b){for(var c=[],d=(a.matrix||[],0);d<a.matrix.length;d++){var e={};e.index=a.matrix[d][0],e.label=a.matrix[d][1],e.onClickVal=a.matrix[d][2],e.value=a.matrix[d][3],e.kpis=a.kpis.data[d],e.series=a.series.data[d];var f=[];if(e.kpis)for(var g=0;g<e.kpis.length;g++){for(var h=[],i=0;i<e.kpis[g].length;i++)h.push(parseFloat(e.kpis[g][i])||0);f.push(h)}e.kpis=f,f=[];for(var g=0;g<e.series.length;g++)isNaN(e.series[g])?f.push(e.series[g]||0):f.push(parseFloat(e.series[g])||0);e.series=f,c.push(e)}return c}function persian(a,b){if(!b)return a;var c={0:"۰",1:"۱",2:"۲",3:"۳",4:"۴",5:"۵",6:"۶",7:"۷",8:"۸",9:"۹"};return a+="",a.replace(/(\d)/g,function(a,b){return c[b]||a})}function depersian(a){var b={"۰":0,"۱":1,"۲":2,"۳":3,"۴":4,"۵":5,"۶":6,"۷":7,"۸":8,"۹":9};return a+="",a.replace(/([۰۱۲۳۴۵۶۷۸۹])/g,function(a,c){return"undefined"!=typeof b[c]?b[c]:a})}function normilize(a){var b={"ي":"ی","إ":"ا","ؤ":"و","أ":"ا","ک":"ك"};return a+="",a.replace(/(.)/g,function(a,c){return b[c]||a})}var app=app||{};app.chartCommons={},app.chartCommons.tooltip={tooltipFormatter:function(set,fh,f,showPersain){var body=set.points.map(function(point){var bodyFormat=f||'{{point.label}}: <p class="ltr inline" style="padding:0; margin:0;" ><b>{{point.data}}</b></p>';return bodyFormat.replace(/{{([^(}})]+)}}/gm,function(i,p1){if(!p1.match(/point\.(data|label|color|format|percentage)/))return p1;var e=eval(p1);return"NaN"===e&&(e="تعریف نشده"),isNaN(e)?e:persian(d3.format(point.format)(e),showPersain)})}).join("<br/>"),headerFormat=fh||"",header=headerFormat.replace(/{{([^(}})]+)}}/gm,function(i,p1){var e=eval(p1);return isNaN(e)||"set.key"==p1?e:persian(d3.format(set.format)(e),showPersain)});return header&&body.trim()&&(header+="<BR/>"),r='<div style="margin:0;text-align: right; padding:0;direction: rtl;">'+header+body+"</div>",r}},app.chartCommons.highchartSetTheme=function(){var a=d3.scale.category10();Highcharts.setOptions({lang:{loading:"در حال بارگذاری...",months:["January","February","March","April","May","June","July","August","September","October","November","December"],shortMonths:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],weekdays:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],decimalPoint:".",numericSymbols:["k","M","G","T","P","E"],resetZoom:"حالت اولیه",resetZoomTitle:"حالت اولیه 1:1",thousandsSep:","},global:{useUTC:!0,canvasToolsURL:"http://code.highcharts.com/4.1.4/modules/canvas-tools.js",VMLRadialGradientURL:"http://code.highcharts.com/4.1.4/gfx/vml-radial-gradient.png"}}),Highcharts.theme={chart:{},xAxis:{title:{text:null,align:"middle"}},yAxis:{endOnTick:!1,title:{text:null,align:"middle"},labels:{formatter:function(){return persian(d3.format(",")(this.value))}},lineWidth:2,lineColor:"#D8D8D8",tickWidth:1},tooltip:{valueSuffix:"",useHTML:!0,formatter:function(){return"<b>"+this.x+"</b>: <b>"+this.series.tooltipOptions.pointFormatter(this)+"</b>"},headerFormat:"",style:{"text-align":"right"}},plotOptions:{bar:{dataLabels:{enabled:!0}},series:{animation:{duration:800,easing:"easeInCubic"},allowPointSelect:!0,fillOpacity:.1,marker:{fillColor:"#FFFFFF",lineWidth:2,lineColor:null}}},credits:{enabled:!1},colors:[1,2,3,4,5,6,7,8,9,10].map(function(b,c){return a(c)}),chart:{animation:{duration:400,easing:"linear"},panning:!0,panKey:"shift"},title:{text:null,style:{color:"#000",font:"bold 16px Droid, Tahoma, Arial"}},subtitle:{style:{color:"#666666",font:"bold 12px Droid, Tahoma, Arial"}},legend:{itemStyle:{font:"9pt Droid, Tahoma, Arial",color:"black"},itemHoverStyle:{color:"gray"}}},Highcharts.setOptions(Highcharts.theme)},app.chartCommons.getError=function(a){if(!a.result){var b=0==+a.errorType?"منبع داده غیر فعال است":"اشکال در پرس و جو";return"<div class='temporal error'> <h4>"+b+"</h4><p>"+a.errorMessage+"</p></div>"}return"<div class='temporal error'> مشکلی در روند برنام ایجاد شده است</div>"},app.chartCommons.openLink=function(a){if(-1!=a.dashboardId)location.hash="/dashboard/"+a.dashboardId;else{var b=window.open(a.link,"_blank");b?b.focus():alert("Please allow popups for this site")}},app.chartCommons.calculateFields=function(series,calcFormulas,columnIsNumeric){function calc(item,series,columnIsNumeric){function getCell(a,b,c){return b=0>b?0:b>=a.length?a.length-1:b,c=0>c?0:c>=a[0].length?a[0].length-1:c,a[b][c]}if(-1==series.labels.indexOf(item.name)&&series.data instanceof Array){var isValid=/^({\s*r?([+-]?\d*)\s*,?\s*c?(\d*)}|[\d\s\+-\/\)\(\*]*|'[^']*')*$/gim.test(item.formula);if(!isValid)return void alert("### Not valid "+item.formula);for(var indexes=[],repFormula=item.formula.replace(/{\s*r?([\+-]?\d*)\s*,?\s*c?(\d*)}/gim,function(a,b,c){return indexes.push({row:+b,col:+c}),"$"+(indexes.length-1)}),i=0;i<series.data.length;i++){var rowFormula=repFormula.replace(/\$(\d+)/gim,function(a,b){var c=indexes[+b],d=getCell(series.data,c.row+i,c.col);return columnIsNumeric&&!columnIsNumeric[c.col]?"'"+d+"'":d||0});series.data[i].push(eval(rowFormula))}series.labels.push(item.name)}}return;var formulas},app.chartCommons.drillDown={filters:[],add:function(a,b,c,d){var e=_.find(this.filters,{chartInPageId:a});if(_.isUndefined(e)){var f={chartInPageId:a,datasourceId:b,drillDown:[{key:c,value:d}]};return this.filters.push(f),f.drillDown}var g=_.find(e.drillDown,{key:c});return _.isUndefined(g)||_.remove(e.drillDown,{key:c}),e.drillDown.push({key:c,value:d}),e.drillDown},up:function(a,b){var c=_.find(this.filters,{chartInPageId:a});if(_.isUndefined(c))return[];_.isUndefined(b)&&(b=1);for(var d=0;b>d;d++)c.drillDown.length>0&&c.drillDown.pop();return c.drillDown},get:function(a){return _.find(this.filters,{chartInPageId:a})},clear:function(a){return _.remove(this.filters,{chartInPageId:a})},clearAll:function(){this.filters=[]}},app.chartCommons.getFilterHierarchy=function(a,b){function c(a){if(_.isArray(a)){for(var b=0;b<a.length;b++){var c=a[b];"undefined"!=typeof c.Members&&c.Members&&(c.Members=c.Members.filter(function(a,b){return a.IsChecked}),c.FilteredMemberByUser=!0)}return a}}var b=$(".cid"+a+" .chart-dimentions-content").data("data");return _.isUndefined(b)?null:{Hierarchies:c(b.Hierarchies),Where:c(b.Where),SeriesLevel:c(b.SeriesLevel)}},app.chartCommons.userFilter={filters:[],setUserControlFilters:function(a){this.filters=[],_.isArray(a)&&(this.filters=a)},setFilter:function(a){if(0==this.filters.length)return void this.filters.push(a);var b=_.find(this.filters,{chartInPageId:a.chartInPageId,dimensionName:a.dimensionName});_.isUndefined(b)||_.remove(this.filters,{chartInPageId:a.chartInPageId,dimensionName:a.dimensionName}),this.filters.push(a)},setFilterIfNotExist:function(a){if(!(_.isEmpty(a.values)||_.isArray(a.values)&&0==a.values.length)){if(0==this.filters.length)return void this.filters.push(a);var b=_.find(this.filters,{chartInPageId:a.chartInPageId});_.isUndefined(b)&&this.filters.push(a)}},getFilterValue:function(a){var b=_.find(this.filters,{chartInPageId:a});return _.isUndefined(b)?null:b}},app.chartCommons.lastRefreshDateFormat=function(a){if(!a)return"";if(0!=app.lang.langType)return a.D+"/"+a.M+"/"+a.Y+" - "+a.h+":"+a.m+":"+a.s+" ";var b="";a.Diff&&a.Diff<86400&&(b+=" - <b>",b+=a.Diff<60?Math.floor(a.Diff)+" ثانیه پیش":a.Diff<3600?Math.floor(a.Diff/60)+" دقیقه پیش":Math.floor(a.Diff/3600)+" ساعت پیش",b+="</b>");var c=1==+a.M?"فروردین":2==+a.M?"اردیبهشت":3==+a.M?"خرداد":4==+a.M?"تیر":5==+a.M?"مرداد":6==+a.M?"شهریور":7==+a.M?"مهر":8==+a.M?"آبان":9==+a.M?"آذر":10==+a.M?"دی":11==+a.M?"بهمن":"اسفند";return persian(a.D+" "+c+" ماه "+a.Y+" ساعت "+a.h+":"+a.m+":"+a.s+" "+b,!0)},app.chartCommons.setFilterParameter=function(a){var b=a.input&&a.input.RefreshDatasource?a.input.RefreshDatasource:null,c=app.chartCommons.getFilterParameter(a.ChartInPageId,b);a.parameters.drillDown=c.drillDown,a.editMode||(a.parameters.otherFilters=c.otherFilters,a.parameters.userControlFilter=c.userControlFilter,a.parameters.userVariable=c.userVariable)},app.chartCommons.getFilterParameter=function(a,b){var c={drillDown:null},d=_.find(app.chartCommons.drillDown.filters,{chartInPageId:a});_.isUndefined(d)||(c.drillDown=d.drillDown),c.otherFilters=_.filter(app.chartCommons.drillDown.filters,function(c){if(!b)return!1;var d=-1!=b.indexOf(c.datasourceId);return d&&c.chartInPageId!=a}),c.userControlFilter=$.extend([],_.filter(app.chartCommons.userFilter.filters,function(a){if(!b)return!1;var c=-1!=b.indexOf(a.datasourceId);return c}));var e=JSON.parse(localStorage.getItem("userVariable"));return c.userVariable=e,c},app.chartCommons.expandedType=1,app.chartCommons.changeSeriesPropertyBaseOnExpandedType=function(a,b){var c=app.chartCommons.expandedType;1==c&&(_.each(a.series,function(a,c){b&&c!=b||(a.seriesType="bar",a.areaOpacity=.1)}),a.info.stackedBar="1",a.info.stackedLine="1"),2==c&&(_.each(a.series,function(a,c){b&&c!=b||(a.seriesType="bar",a.areaOpacity=.1)}),a.info.stackedBar="2",a.info.stackedLine="1"),21==c&&(_.each(a.series,function(a,c){b&&c!=b||(a.seriesType="bar",a.areaOpacity=.1)}),a.info.stackedBar="3",a.info.stackedLine="1"),3==c&&(_.each(a.series,function(a,c){b&&c!=b||(a.seriesType="line",a.lineType="line-dot-area",a.areaOpacity=.1)}),a.info.stackedBar="1",a.info.stackedLine="1"),4==c&&(_.each(a.series,function(a,c){b&&c!=b||(a.areaOpacity=.1,a.lineType="line-dot-area",a.seriesType="line")}),a.info.stackedBar="1",a.info.stackedLine="2"),22==c&&(_.each(a.series,function(a,c){b&&c!=b||(a.areaOpacity=.1,a.seriesType="line",a.lineType="line-dot-area")}),a.info.stackedBar="1",a.info.stackedLine="3"),5==c&&(_.each(a.series,function(a,c){b&&c!=b||(a.seriesType="line",a.lineType="line-area",a.areaOpacity=.4)}),a.info.stackedBar="1",a.info.stackedLine="1"),6==c&&(_.each(a.series,function(a,c){b&&c!=b||(a.seriesType="line",a.lineType="line-area",a.areaOpacity=.4)}),a.info.stackedBar="1",a.info.stackedLine="2"),23==c&&(_.each(a.series,function(a,c){b&&c!=b||(a.seriesType="line",a.lineType="line-area",a.areaOpacity=.4)}),a.info.stackedBar="1",a.info.stackedLine="3"),7==c&&(a.info.hole="0"),8==c&&(a.info.hole="50"),14==c&&(a.info.aggregation="-1"),13==c&&(a.info.aggregation="1"),15==c&&(a.info.type="combo"),16==c&&(a.info.type="multi"),17==c&&(a.info.type="datepicker"),18==c&&(a.info.type="datepicker-range"),19==c&&(a.info.type="slider"),20==c&&(a.info.type="text"),9==c&&(a.info.segmentType="singleSegment",a.info.style="arc"),24==c&&(a.info.segmentType="multiSegment",a.info.style="arc"),25==c&&(a.info.segmentType="singleSegment",a.info.style="horizontal"),26==c&&(a.info.segmentType="multiSegment",a.info.style="horizontal"),27==c&&(a.info.style="number",a.info.icons=a.info.icons||["user icon","edit icon"])},app.chartCommons.setDefault=function(a,b,c){var d=d3.scale.category10();_.isUndefined(b)||_.each(b,function(b,e){var f=d(e),g=c;a.series=a.series||{};var h={bar:{seriesColor:f,seriesType:"bar",formatString:",.0f",numberFactor:"1",showValues:!1,hidden:!1,cumulative:!1,cumulative_formula:"sum",lineFace:"5,0",lineWeight:"2",lineStyle:"linear",lineType:"line-dot-area",showValueColor:"#333333",areaOpacity:.1,formatStringCustom:",.0f",font:{bold:!1,color:"#333333",italic:!1,fontSize:"11px",fontName:"IRANSans",formatString:",.3s",formatStringCustom:",.0f"},top:{IsTop:!1,Top:10,IsPercent:!1,TopOrder:"DESC"}},map:{hidden:!1,formatString:",.0f",colorStart:"#31a354",colorEnd:"#c7e9c0",top:{IsTop:!1,Top:10,IsPercent:!1,TopOrder:"DESC"}},pie:{main:!0,numberFactor:"1",top:{IsTop:!1,Top:10,IsPercent:!1,TopOrder:"DESC"}},gauge:{type:"value",typeMs:"value",numberFactor:"1",top:{IsTop:!1,Top:10,IsPercent:!1,TopOrder:"DESC"}},radar:{numberFactor:"1",seriesColor:f,top:{IsTop:!1,Top:10,IsPercent:!1,TopOrder:"DESC"}},table:{numberFactor:"1",textAlign:"right",formatString:",.0f",fontSize:"1em",textItalic:!1,textBold:!1,color:"#000000",rowResult:"0",isHidden:!1,top:{IsTop:!1,Top:10,IsPercent:!1,TopOrder:"DESC"}},userControl:{numberFactor:"1",type:"value"},text:{}},i=!1;_.isUndefined(a.series[b])&&(i=!0),a.series[b]=$.extend({},h[g],a.series[b]),i&&app.chartCommons.changeSeriesPropertyBaseOnExpandedType(a,b)})},app.chartCommons.commentUtils={getLabelsMeasures:function(a){var b=[],c=[];return a.matrix?(_.each(a.matrix,function(a){b.push(a[1])}),_.each(a.series.labels,function(a){c.push(a)})):b=a.headers,{labels:b,measures:c}},getCommentCount:function(a,b,c){return a.filter(function(a){return b==a.label&&a.measure==c}).length},getChartSelector:function(a){return".cid"+a},clickOnCommentIcon:function(a,b){$(app.chartCommons.commentUtils.getChartSelector(b)).trigger("new-comment",a);try{d3.event.preventDefault(),d3.event.stopPropagation()}catch(c){}},highlight:function(a,b){var c=!1;_.each(a,function(a){a instanceof jQuery?a.removeClass("selected"):a.classed("selected",!1)}),_.each(a,function(a){if(c)return!1;if(a instanceof jQuery){var d=$(a[0]).data("table-data");return void a.each(function(a,e){var f=$(e).data("xrow"),g=$(e).data("xcol"),a=d.rows[f][g];return b.category==a.category&&b.seriesLable==a.seriesLable?(d3.select(this).classed("selected",!0),c=!0,!1):void 0})}a.each(function(a){return b.category==a.category&&b.seriesLable==a.seriesLable?(d3.select(this).classed("selected",!0),c=!0,!1):void 0})})},setOnHighlightListener:function(a,b){var c=$(app.chartCommons.commentUtils.getChartSelector(b)).data("collections")||[];c.push(a),$(app.chartCommons.commentUtils.getChartSelector(b)).data("collections",c),$(app.chartCommons.commentUtils.getChartSelector(b)).off("highlight-element"),$(app.chartCommons.commentUtils.getChartSelector(b)).on("highlight-element",function(a,c){if(c){var d=$(app.chartCommons.commentUtils.getChartSelector(b)).data("collections")||[];app.chartCommons.commentUtils.highlight(d,c)}})},destroyListener:function(a){$(app.chartCommons.commentUtils.getChartSelector(a)).data("collections",null)},addCommentIcon:function(a,b,c,d){var e=b.append("g").attr("transform",function(a,b){return"translate("+c(a,b)+","+d(a,b)+")scale(0.38)"}).attr("class",function(a){return"comment"+(a.commentCount?" show":"")}).on("click",function(b){app.chartCommons.commentUtils.clickOnCommentIcon(b,a)});e.append("rect").attr({width:50,height:24,"class":"comment-background"}),e.append("path").attr("d","M10.718,18.561l6.78,5.311C17.609,23.957,17.677,24,17.743,24  c0.188,0,0.244-0.127,0.244-0.338v-5.023c0-0.355,0.233-0.637,0.548-0.637L21,18c2.219,0,3-1.094,3-2s0-13,0-14s-0.748-2-3.014-2  H2.989C0.802,0,0,0.969,0,2s0,13.031,0,14s0.828,2,3,2h6C9,18,10.255,18.035,10.718,18.561z"),e.append("text").text(function(a){return a.commentCount?persian(a.commentCount,!0):""}).attr({x:34,y:"0.7em"}).style({"font-size":"20px"})},updateIconCommentCount:function(a,b,c){function d(a){a.each(function(a){a.seriesLable==b.measure&&a.category==b.label&&(d3.select(this).select("text").text(c?persian(c,!0):""),d3.select(this).classed("show",c>0))})}var e=$(app.chartCommons.commentUtils.getChartSelector(a)).data("collections")[0];if(e instanceof jQuery){var f=$(e[0]).data("table-data");return void e.each(function(){var d=$(this).data("xrow"),e=$(this).data("xcol"),g=f.rows[d][e];if(g.seriesLable==b.measure&&g.category==b.label){var h=$(app.chartCommons.commentUtils.getChartSelector(a)+" td[data-xcol="+e+"][data-xrow="+d+"]"),i=$(this).find(".comment"),j=h.find("svg:not(.td-comment) .comment");if(0==i.length){var k=$(app.chartCommons.commentUtils.getChartSelector(a)+" svg");i=k.clone().removeClass("td-comment"),j=k.clone().removeClass("td-comment"),$(this).append(i),h.append(j)}i.find(".comment").attr("class","comment show"),i.find("text").text(c?persian(c,!0):""),j.find(".comment").attr("class","comment show"),j.find("text").text(c?persian(c,!0):"")}})}var g=d3.selectAll(app.chartCommons.commentUtils.getChartSelector(a)+" .comment"),h=d3.selectAll("#"+app.chartCommons.commentUtils.getChartInModalSelector(a)+" .comment");d(h),d(g)},getChartInModalSelector:function(a){return"modal-chart-container-"+a},showLastVersionChart:function(){}},app.chartCommons.renderComments=function(a,b){function c(){var a='<div class="ui fuild modal '+v.substring(1,1e3)+' rtl"  style="cursor: initial;">     <i class="close icon"></i>     <div class="header">نسخه قبلی نمودار</div>     <div class="content" id="'+v.substring(1,1e3)+'" style="height:350px">         <div class="ui active inverted dimmer"><div class="ui text loader">آماده‌سازی نمودار</div></div>     </div></div>';if(0==$(v).length){var b=$(a);$("body").append(b),b.modal({allowMultiple:!0,onVisible:function(){app.chartCommons.commentUtils.showLastVersionChart()},onHidden:function(){$(v+" .content").html('<div class="ui active inverted dimmer"><div class="ui text loader">آماده‌سازی نمودار</div></div>')}})}}function d(a){return'<div class="ui mini label value comment-value" data-label="'+a.label+'" data-measure="'+a.measure+'" data-value="'+a.value+'" style="">  '+a.measure+" در "+a.label+": "+persian(d3.format(",.2f")(a.value),!0)+"</div>"}function e(a){var c="";return+a.chartVersion!=+b.version&&(c=persian(" نسخه "+a.chartVersion+" نمودار ",!0),c='            <span class="version pointer" style="color:red;" data-version="'+a.chartVersion+'">'+c+"</span>"),'<div class="comment" data-id="'+a.id+'">    <div class="content">        <span class="author">'+a.username+'</span>        <span class="value-string">'+d(a)+'</span>        <div class="metadata">            <span class="date">'+moment(a.time).fromNow()+"</span>"+c+'        </div>        <div class="text">            <span class="comment-text">'+a.comment+'            </span>            <span class="auto-hide animated ">            <a class="reply pointer metadata"> پاسخ </a>'+(a.userId==app.userId?'            <a class="edit pointer metadata"> ویرایش </a>':"")+(a.userId==app.userId?'            <a class="remove pointer metadata"> حذف </a>':"")+'            </span>        </div>        <div class="actions">        </div>    </div>'+(a.childs&&a.childs.length?f(a.childs):"")+"</div>"}function f(a,b){var c=(a||[]).map(e,b).join("");return'<div class="ui tiny relaxed threaded comments '+(b?" root":"")+'" '+(b?'style=" '+(w?"":"min-height:"+t+"px; overflow:auto;")+'   flex-grow: 1;flex-shrink: 1;flex-basis: 0px;"':"")+">"+c+"</div>"}function g(c){var d=b.FinalWhereList.map(function(a){var b='<div class="ui orange mini label"><span>'+a.Key.replace(/\[id\d+\].\[(.*)\]/,"$1")+': </span><span style="font-weight:200;">'+a.Value.join(",")+"</span></div>";return b}).join(""),e=f(c,!0),g='<form class="ui tiny form">  <div class="final-where">'+d+'</div>  <div class="comment-modal-value"><span class="measure-value"></span> در <span class="label-value"></span>  <span class="value-value"></span></div>  <div class="field">    <textarea type="text"  rows="1" placeholder=" نظر شما چیست؟ خط جدید با Cntl + Enter"></textarea>  </div></form>';return'<div class="ui modal comment-modal comment-section rtl modal'+a.ChartInPageId+'" style="cursor: initial;">     <i class="close icon"></i>     <div class="header">کامنت گذاری</div>     <div class="content '+(w?"scrolling":"")+'" style="padding:0">         <div class="ui mobile reversed stackable padded grid">             <div class="six wide column" '+(w?"":'style="border-left: 1px solid #dcddde;display: flex;flex-direction: column;justify-content: flex-end;"')+">"+e+'     <div class="header" style="flex"></div>'+g+'             </div>             <div class="six wide column chart-container" id="'+r+'" >                   <div class="ui active inverted dimmer"><div class="ui text loader">آماده‌سازی نمودار</div></div>             </div>         </div>     </div></div>'}function h(){A.find(".selected-comment").remove(),A.find(".selected-comment-edit").remove(),B.val(null)}function i(a,c){if(!a||!c)return"";var d=y.indexOf(a),e=z.indexOf(c),f=b.series.data[d][e];return f}function j(a){B.val(a.comment),!a.seriesLable;var b=i(a.seriesLable,a.measure);F.data("v",a.seriesLable),E.data("v",a.measure),B.focus(),D.hide(),a.seriesLable&&(D.show(),F.text(a.seriesLable),E.text(a.measure),G.text(persian(d3.format(",.2f")(b),!0)))}function k(c){c.find(".version").on("click",function(){var b=$(this).data("version");app.chartCommons.commentUtils.showLastVersionChart=function(){$(v+" .content").charts(a.type,{id:v.substring(1,1e3),parameters:{type:a.dataType,fromCommentDialog:!0,lastVersionInfo:{version:b,lastVersionChartId:a.chartId}}})},$(v).modal("show")}),c.find(".reply").on("click",function(){var a=$(this).parents(".comment").data("id");h(),$selectedComment=$('<div class="ui mini label selected-comment field" data-id="'+a+'">پاسخ به '+a+' <i class="icon close" style="margin:0;"/>  </div>'),A.find(".ui.form").prepend($selectedComment),$selectedComment.find(".icon").on("click",h),B.focus()}),c.find(".edit").on("click",function(){var a=$(this).parents(".comment").data("id"),b=$(this).parents(".comment").first();h(),$selectedComment=$('<div class="ui mini label selected-comment-edit field" data-id="'+a+'"> ویرایش '+a+' <i class="icon close" style="margin:0;"/>  </div>'),A.find(".ui.form").prepend($selectedComment),$selectedComment.find(".icon").on("click",h),j({comment:b.find(".comment-text").first().text().trim(),label:b.find(".value").first().data("label"),measure:b.find(".value").first().data("measure")})}),c.find(".remove").on("click",function(){var c=$(this).parents(".comment").data("id"),d=$(this).parents(".comment").first(),e=confirm("در صورت حذف کامنت تمام پاسخ‌ها نیز حذف می‌شوند. آیا برای حذف اطمینان دارید؟");if(e){var f=app.urlPrefix+"api/chartComments/Delete?id="+c;$.post(f).done(function(e){d.transition("scale");var f=null;if(_.each(u,function(a){a.id==c&&(f=a)}),l(b.comment,c,function(a,b,d){b.id==c&&a.splice(d,1)}),f){var g=app.chartCommons.commentUtils.getCommentCount(u,e.label,e.measure);app.chartCommons.commentUtils.updateIconCommentCount(a.ChartInPageId,e,g)}})}})}function l(a,b,c){var d=null,e=0;return _.each(a,function(f){if(c&&c(a,f,e),f.id==b)return d=f,!1;var g=l(f.childs,b);return g?(d=g,!1):void e++}),d}function m(a){A.find(" .root.comments > .comment").hide(),_.each(a,function(a){A.find(" .root.comments > .comment[data-id="+a.id+"]").show()})}function n(a){return u.filter(function(b){return a.category==b.label&&a.seriesLable==b.measure})}function o(){var c=_.extend({},a);c.id=r,c.fromCommentDialog=!0,$("#"+c.id).empty(),app.chartCommons.commentUtils.destroyListener(c.ChartInPageId),app.chartCommons.draw(c.type,b,c,!1),$("#"+r).on("select-series",function(a,b){j({comment:"",label:b.category,measure:b.seriesLable}),m(n(b))})}function p(){function b(b){C.removeClass("loading"),B.val(null),h(),u=u||[];var c=l(u,o);if(c)c.childs=c.childs||[],c.childs.push(b);else{u.push(b);var d=app.chartCommons.commentUtils.getCommentCount(u,b.label,b.measure);app.chartCommons.commentUtils.updateIconCommentCount(a.ChartInPageId,b,d)}var g=A.find(".comments.root");if(o){if($parentComment=A.find(".comment[data-id="+o+"] .comments"),0==$parentComment.length){$parentComment=A.find(".comment[data-id="+o+"]");var i=$(f());$parentComment.append(i),$parentComment=i}g=$parentComment}var j=$(e(b));g.append(j),k(j),setTimeout(function(){var a=A.find(".root.comments [data-id="+b.id+"]"),c=A.find(".root.comments");c.animate({scrollTop:c.scrollTop()+a.offset().top-c.height()+a.height()},400),setTimeout(function(){a.transition("pulse")},400)},400)}var c=F.data("v"),g=E.data("v");if(_.isArray(c)&&(c=c[0]),_.isArray(g)&&(g=g[0]),_.isEmpty(B.val()))return void alert("کامنت خود را بنویسید");if(_.isEmpty(c))return void alert("یکی از ردیف‌های اطلاعاتی را انتخاب کنید");if(_.isEmpty(g))return void alert("یکی از داده‌ها را انتخاب کنید");var j=i(c,g),m=$(q+" .chart-data").data("settings"),n=app.chartCommons.getFilterParameter(m.ChartInPageId,m.input.RefreshDatasource),o=A.find(".selected-comment").data("id"),p=A.find(".selected-comment-edit").data("id"),r={where:m.input.FinalWhereList,chartId:m.chartId,dashboardId:dashboard.pageId,datasourceId:m.input.DataSourceId,dimention:m.input.CurrentDimName,input:JSON.stringify(m.input),drillDown:n.drillDown,otherFilters:n.otherFilters,userControlFilter:n.userControlFilter,userVariable:n.userVariable,comment:B.val().trim(),parentId:o,label:c,measure:g,value:j};return C.addClass("loading"),p?void $.post(app.urlPrefix+"api/ChartComments/edit?id="+p+"&text="+B.val().trim()+"&label="+c+"&measure="+g+"&value="+j).done(function(a){C.removeClass("loading"),h(),B.val(null);var b=A.find(".comment[data-id="+p+"]").first(),c=A.find(".comment[data-id="+p+"] .comment-text").first(),e=A.find(".comment[data-id="+p+"] .value-string").first();c.text(a.comment),e.html(d(a)),setTimeout(function(){b.transition("pulse")},400)}).fail(function(a){C.removeClass("loading")}):void $.ajax({type:"POST",url:app.urlPrefix+"api/ChartComments/save/0",data:JSON.stringify(r),contentType:"application/json; charset=utf-8",dataType:"json",success:b,error:function(a){C.removeClass("loading")}})}if(b.FinalWhereList){var q=app.chartCommons.commentUtils.getChartSelector(a.ChartInPageId),r=app.chartCommons.commentUtils.getChartInModalSelector(a.ChartInPageId),s=$(q+" .show-chart-comments"),t=300;$(q+" .comment-section").remove();var u=b.comment;if(!a.fromCommentDialog){var v=".last-version-modal";$(".comment-modal.modal"+a.ChartInPageId).remove(),$(q).off("new-comment"),s.off("click"),c();var w=$(window).width()<768;if(u){moment.locale("fa"),$(q).data("init-befor",!0);var x=app.chartCommons.commentUtils.getLabelsMeasures(b),y=x.labels,z=x.measures,A=$(g(u)),B=A.find("textarea"),C=A.find(".button"),D=(A.find(".chart-container"),A.find(".comment-modal-value")),E=A.find(".measure-value"),F=A.find(".label-value"),G=A.find(".value-value"),H={type:"modal",render:function(){$(q).append(A),k(A),B.on("keyup",function(a){return 13==a.keyCode&&a.ctrlKey?void B.val(B.val()+"\n"):void(13==a.keyCode&&p())}),"modal"==this.type&&(A.modal({allowMultiple:!0,onVisible:function(){o(),$(app.chartCommons.commentUtils.getChartSelector(a.ChartInPageId)).trigger("highlight-element",[H.highlightedValue])}}),s.on("click",function(){var a={category:y[0],seriesLable:z[1]};$(q).trigger("new-comment",a)})),"popup"==this.type&&s.popup({popup:$(q+" .popup.ui"),target:$(q+" .ui.card .content"),title:"کامنت‌ها",position:"top right",boundary:$(".main-container"),on:"click",lastResort:!0,prefer:"opposite",onShow:function(a,b){$(q+" .menu-bar").addClass("show-dropdown")},onVisible:function(){$parentDiv=$(".main-container.full-height-container"),$innerListItem=A,$parentDiv.animate({scrollTop:$parentDiv.scrollTop()-$parentDiv.height()+$innerListItem.offset().top+$innerListItem.height()+40},400)},onHide:function(a,b){$(q+" .menu-bar").removeClass("show-dropdown")}})},show:function(){"modal"==this.type&&A.modal("show"),"popup"==this.type&&s.popup("show")}};H.render(),$(q).on("new-comment",function(a,b){j({comment:"",seriesLable:b.category,measure:b.seriesLable}),m(n(b)),H.highlightedValue=b,H.show(),$(q).trigger("highlight-element",[H.highlightedValue])})}}}},jQuery.fn.extend({lazyDropdown:function(a){return this.each(function(){var b=$(this);b.on("click",function(c){b.data("init-dd")||(c.stopPropagation(),c.preventDefault(),b.data("init-dd",!0),b.dropdown(a),b.click())})})}}),app.chartCommons.indicator={checkRow:function(a,b,c){var d=c.indexOf(a.firstField),e=b[d],f=a.secondFieldIsText?a.secondFieldInput:b[c.indexOf(a.secondFieldSelect)];switch(e=depersian(e),f=depersian(f),isNaN(f)||(f=+f),isNaN(e)||(e=+e),+a.operand){case 1:return e==f;case 2:return e!=f;case 3:return e>f;case 4:return e>=f;case 5:return f>e;case 6:return f>=e;case 7:return e.indexOf(f)>-1;case 8:return e.indexOf(f)<=-1}},getIndicator:function(a,b,c){var d=[],e=b;return c&&c.forEach(function(b){var c=!0;$.each(b.ifRow,function(b,d){return app.chartCommons.indicator.checkRow(d,a,e)?void 0:(c=!1,!1)}),c&&d.push(b.thenRow)}),d}},d3.selection.prototype.settingsIcon=function(a){return},d3.selection.prototype.legend=function(a,b){a.font=a.font||{};var c=this.append("div").attr("class","legend-div temporal").append("div").attr("class","list-inline").style("margin-bottom","12px");return c.selectAll("nothingd").data(a.data).enter().append("span").text(function(a){return persian(a.label,b)}).style("font-size",a.font.fontSize||"9px").style("font-family",a.font.fontName||"IRANSans").style("font-weight",a.font.bold?"bold":"200").style("font-style",a.font.italic?"italic":"inherit").style("color",a.font.italic?"italic":"inherit").attr("class","pointer legend-item").on("click",function(b,c){console.log(b),a.selector&&$(a.selector).trigger("legendClick",[b.label,c,b])}).append("span").attr("class","legend-color").style("background-color",function(a){return a.color}),c},d3.selection.prototype.breadcrumb=function(a,b,c,d){var e=a.slice(0);"undefined"!=typeof e[0]&&null!==e[0]&&e.unshift(app.lang.translate("پاک کردن"));var f=e[e.length-1];if(e.splice(e.length-1,1),e.length>0){var g=function(a,d){var f=$("#"+b.id).hasClass("fromCommentDialog");if(!f){var g=c.isProgress,h=c.showProgress;if(!g()){h(!0);var i=app.chartCommons.drillDown.up(b.ChartInPageId,e.length-d);b.parameters={drillDown:i,isUp:!0,upLevel:e.length-d,chartId:b.chartId,ChartInPageId:b.ChartInPageId},b.drill="up",$("#"+b.id).charts(b.type,"refreshWithData",b)}}},h='<div class="ui mini breadcrumb floated right temporal">'+e.map(function(a){return'<a class="section clickable">'+a+"</a>"}).join('<i class="left arrow icon divider"></i>')+'<i class="left arrow icon divider"></i><div class="section active">'+f+"</div></div>";return $(this[0][0]).append(h),void $(this[0][0]).find(".breadcrumb .clickable").each(function(a,b){$(this).on("click",function(){g(0,a)})})}},d3.selection.prototype.titlebar=function(a){var b,c=d3.select(this[0][0]),d=function(){return"visible"==$(c[0][0]).find(".myprogress").css("visibility")},e=$(c[0][0]).parents(".ui.card").find(".progress-overall"),f=function(a){a?($(c[0][0]).find("*").attr("disabled",!0),$(c[0][0]).find(".myprogress").css("visibility","visible"),e.fadeIn()):($(c[0][0]).find("*").attr("disabled",!1),$(c[0][0]).find(".myprogress").css("visibility","hidden"),e.fadeOut())};return{title:b,showProgress:f,isProgress:d}};var d3Utils={prepareDataForBarChart:function(a,b,c,d,e,f){var g=d3.scale.category10();$.each(a,function(a,h){if(!h.kpis)return!0;var i=[];return $.each(h.kpis,function(a,c){var e=b.chartProp.series[d[a]]||b.chartProp.series["default"];g(a);"undefined"==typeof e&&"undefined"!=typeof model&&(e=$.extend(!0,{},"undefined"!=typeof model.seriesProp[d[a]]?model.seriesProp[d[a]]:model.seriesProp["default"]),e.seriesColor=g(a)),i.push({data:c,prop:e,key:d[a],label:f&&f.length>a?f[a]:d[a],type:"kpi",seriesLable:f&&f.length>a?f[a]:d[a],type:"kpi",category:h.label})}),h.series?($.each(h.series,function(a,d){var f=b.chartProp.series[c[a]],g={type:"series",data:isNaN(d)?d:d*parseFloat(f.numberFactor),prop:f,key:c[a],label:e&&e.length>a?e[a]:c[a],seriesLable:e&&e.length>a?e[a]:c[a],category:h.label};g.commentCount=app.chartCommons.commentUtils.getCommentCount(b.input.comment,g.category,g.label),i.push(g)}),void(h.series=i)):!0})},convertToKeyValue:function(a){var b=_.map(a.series.labels,function(b,c){var d=a.seriesLablesCaptions&&a.seriesLablesCaptions.length>c;return{key:b,value:d?a.seriesLablesCaptions[c]:b}}),c=_.map(a.kpis.labels,function(b,c){var d=a.kpisLablesCaptions&&a.kpisLablesCaptions.length>c;return{key:b,value:d?a.kpisLablesCaptions[c]:b}});return{seriesLabels:b,kpiLabels:c}}},app=app||{};app.helper=app.helper||{},function(){function a(a){for(var d=0;d<a.length;d++)for(var e=0;e<b.length;e++)a.charAt(d)===b[e]&&(a=a.replace(a.charAt(d),c[e]));return a}var b=["ي","إ","ؤ","أ","ي","ك"],c=["ی","ا","و","ا","ی","ک"];app.helper.filterMemberDialogOk=function(){var a=$("#filter-member-dialog").data("data");$("#filter-member-dialog .li ").each(function(b,c){var d=$(this).find("input"),e=$.grep(a.members,function(a){return a.Uniquename==d.attr("value")})[0];e.IsChecked=d.prop("checked")}),a.onfinish(a.members),$("#filter-member-dialog").modal("hide")},app.helper.filterMemberDialog=function(b,c,d){function e(a,b,c){
var d='<div class=" " style="height:50vh; overflow:auto;"> '+b.map(function(a,b){return'<div class="li"><input value="'+a.Uniquename+'" type="checkbox" id="member-'+b+'" '+(a.IsChecked?" checked ":"")+' /> <label class="unstyled-lable" for="member-'+b+'">'+a.Caption+"</label></div>"}).join("")+"</div>";c.find(".member-list").html(d),$("#filter-member-dialog").modal("refresh")}var f=function(d){var f=window.innerHeight,g=$("#filter-member-dialog").outerHeight(),h=f-g-50;body='<div class="ui form"><input type="text" class="form-control" id="filter-member-search" placeholder="جستجو"></div>                    <input id="select-all-member-filter" type="checkbox" style="margin-top:10px"/><label style="margin-right:5px;" for="select-all-member-filter"> همه </label>                    <div class="member-list"></div>';var i=$("#filter-member-dialog #filter-member-dialog-content");i.html(body),$("#select-all-member-filter").change(function(){var a=this.checked;$("#filter-member-dialog ul li input").filter(function(){return $(this).is(":visible")}).prop("checked",a)}),e(h,b,i);var j;$("#filter-member-dialog #filter-member-search").keyup(function(){var b=$(this).val().toLowerCase();if(b=a(b),c){if(b&&1==b.length)return;clearTimeout(j),j=setTimeout(function(){$.ajax(c+"&query="+b).done(function(a){var b=$("#filter-member-dialog").data("data");b.members=a,e(h,a,i)})},400)}else $("#filter-member-dialog li").show(),$("#filter-member-dialog li").filter(function(){var c=$(this).text().toLowerCase();return c=a(c),-1==c.indexOf(b.toLowerCase())}).hide()})};$("#filter-member-dialog").modal({onVisible:f}).modal("show"),$("#filter-member-dialog").data("data",{members:b,onfinish:d}),$("#filter-member-dialog").modal("show")}}($),function(a){function b(a,b){return"function"==typeof a?a.call(b):a}function c(b,c){this.$element=a(b),this.options=c,this.enabled=!0,this.fixTitle()}c.prototype={show:function(){var c=this.getTitle();if(c&&this.enabled){var d=this.tip();d.find(".tipsy-inner")[this.options.html?"html":"text"](c),d[0].className="tipsy",d.remove().css({top:0,left:0,visibility:"hidden",display:"block"}).prependTo(document.body);var e=a.extend({},this.$element.offset(),{width:this.$element[0].offsetWidth||0,height:this.$element[0].offsetHeight||0});if("object"==typeof this.$element[0].nearestViewportElement){var f=this.$element[0],g=f.getBoundingClientRect();e.width=g.width,e.height=g.height}var h,i=d[0].offsetWidth,j=d[0].offsetHeight,k=b(this.options.gravity,this.$element[0]);switch(k.charAt(0)){case"n":h={top:e.top+e.height+this.options.offset,left:e.left+e.width/2-i/2};break;case"s":h={top:e.top-j-this.options.offset,left:e.left+e.width/2-i/2};break;case"e":h={top:e.top+e.height/2-j/2,left:e.left-i-this.options.offset};break;case"w":h={top:e.top+e.height/2-j/2,left:e.left+e.width+this.options.offset};break;case"c":h={top:e.top+e.height/2-j/2,left:e.left+e.width/2-i/2}}2==k.length&&("w"==k.charAt(1)?h.left=e.left+e.width/2-15:h.left=e.left+e.width/2-i+15),d.css(h).addClass("tipsy-"+k),d.find(".tipsy-arrow")[0].className="tipsy-arrow tipsy-arrow-"+k.charAt(0),this.options.className&&d.addClass(b(this.options.className,this.$element[0])),this.options.fade?d.stop().css({opacity:0,display:"block",visibility:"visible"}).animate({opacity:this.options.opacity}):d.css({visibility:"visible",opacity:this.options.opacity});var l=this,m=function(a){return function(){l.$tip.stop(),l.tipHovered=a,a||(0===l.options.delayOut?l.hide():setTimeout(function(){"out"==l.hoverState&&l.hide()},l.options.delayOut))}};d.hover(m(!0),m(!1))}},hide:function(){this.options.fade?this.tip().stop().fadeOut(function(){a(this).remove()}):this.tip().remove()},fixTitle:function(){var a=this.$element;(a.attr("title")||"string"!=typeof a.attr("original-title"))&&a.attr("original-title",a.attr("title")||"").removeAttr("title"),"object"==typeof a.context.nearestViewportElement&&a.children("title").length&&a.append("<original-title>"+(a.children("title").text()||"")+"</original-title>").children("title").remove()},getTitle:function(){var a,b=this.$element,c=this.options;if(this.fixTitle(),"string"==typeof c.title){var d="title"==c.title?"original-title":c.title;a=b.children(d).length?b.children(d).html():b.attr(d)}else"function"==typeof c.title&&(a=c.title.call(b[0]));return a=(""+a).replace(/(^\s*|\s*$)/,""),a||c.fallback},tip:function(){return this.$tip||(this.$tip=a('<div class="tipsy"></div>').html('<div class="tipsy-arrow"></div><div class="tipsy-inner"></div>')),this.$tip},validate:function(){this.$element[0].parentNode||(this.hide(),this.$element=null,this.options=null)},enable:function(){this.enabled=!0},disable:function(){this.enabled=!1},toggleEnabled:function(){this.enabled=!this.enabled}},a.fn.tipsy=function(b){function d(d){var e=a.data(d,"tipsy");return e||(e=new c(d,a.fn.tipsy.elementOptions(d,b)),a.data(d,"tipsy",e)),e}function e(){var a=d(this);a.hoverState="in",0===b.delayIn?a.show():(a.fixTitle(),setTimeout(function(){"in"==a.hoverState&&a.show()},b.delayIn))}function f(){var a=d(this);if(a.hoverState="out",0===b.delayOut)a.hide();else{var c=function(){a.tipHovered&&b.hoverlock||"out"==a.hoverState&&a.hide()};setTimeout(c,b.delayOut)}}if(b===!0)return this.data("tipsy");if("string"==typeof b){var g=this.data("tipsy");return g&&g[b](),this}if(b=a.extend({},a.fn.tipsy.defaults,b),b.hoverlock&&0===b.delayOut&&(b.delayOut=100),"manual"!=b.trigger){var h=b.live?"live":"bind",i="hover"==b.trigger?"mouseenter":"focus",j="hover"==b.trigger?"click":"blur",k="hover"==b.trigger?"mouseleave":"blur";this[h](i,e)[h](k,f)[h](j,f)}return this},a.fn.tipsy.defaults={className:null,delayIn:0,delayOut:0,fade:!1,fallback:"",gravity:"n",html:!1,live:!1,offset:0,opacity:.8,title:"title",trigger:"hover",hoverlock:!1},a.fn.tipsy.elementOptions=function(b,c){return a.metadata?a.extend({},c,a(b).metadata()):c},a.fn.tipsy.autoNS=function(){return a(this).offset().top>a(document).scrollTop()+a(window).height()/2?"s":"n"},a.fn.tipsy.autoWE=function(){return a(this).offset().left>a(document).scrollLeft()+a(window).width()/2?"e":"w"},a.fn.tipsy.autoBounds=function(b,c){return function(){var d={ns:c[0],ew:c.length>1?c[1]:!1},e=a(document).scrollTop()+b,f=a(document).scrollLeft()+b,g=a(this);return g.offset().top<e&&(d.ns="n"),g.offset().left<f&&(d.ew="w"),a(window).width()+a(document).scrollLeft()-g.offset().left<b&&(d.ew="e"),a(window).height()+a(document).scrollTop()-g.offset().top<b&&(d.ns="s"),d.ns+(d.ew?d.ew:"")}}}(jQuery);var app=app||{};app.charts=app.charts||{},app.charts.bar={},app.charts.bar.draw=function(a,b,c,d){function e(a,b,c){var d=c.indexOf(a.firstField),e=b[d],f=a.secondFieldIsText?a.secondFieldInput:b[c.indexOf(a.secondFieldSelect)];switch(e=depersian(e),f=depersian(f),isNaN(f)||(f=+f),isNaN(e)||(e=+e),+a.operand){case 1:return e==f;case 2:return e!=f;case 3:return e>f;case 4:return e>=f;case 5:return f>e;case 6:return f>=e;case 7:return e.indexOf(f)>-1;case 8:return e.indexOf(f)<=-1}}function f(a,c,d){b.chartProp.indicator&&b.chartProp.indicator.forEach(function(b){var f=!0;$.each(b.ifRow,function(a,b){return e(b,c,d)?void 0:(f=!1,!1)}),f&&a.map(function(a){return a.thenRows=a.thenRows||[],a.thenRows.push(b.thenRow),a})})}function g(a,c,d,e){var f=G[a].series;return 1==c&&d&&"undefined"!=typeof e&&(f=f.filter(function(a){return a.prop.seriesType==d&&!a.prop.hidden}),f=[f[e]]),2==c&&(f=f.filter(function(a){return!a.prop.hidden})),f=f.map(function(a){return{data:a.data,label:a.prop.name||a.label,format:z(a.prop),color:a.prop.seriesColor}}),app.chartCommons.tooltip.tooltipFormatter({points:f,key:G[a].label,sum:d3.sum(f,function(a){return a.data}),avg:d3.sum(f,function(a){return a.data})/f.length,format:f.length>0?f[0].format:",.2f"},b.chartProp.info.tooltipHeader,b.chartProp.info.tooltipFormat,u)}function h(a){var b=a[0].series.filter(function(a,b){return"line"==a.prop.seriesType&&!a.prop.hidden}),c=b.map(function(b,c){var d={label:b.label,prop:b.prop,values:a.map(function(a,c){var d={label:a.label+"#"+a.index,value:a.series.filter(function(a,c){return a.label==b.label})[0].data,valueLabel:a.series.filter(function(a,c){return a.label==b.label})[0].data,prop:a.series.filter(function(a,c){return a.label==b.label})[0].prop,onClickVal:a.onClickVal,primv:a.value,category:a.label,commentCount:a.series.filter(function(a,c){return a.label==b.label})[0].commentCount,seriesLable:b.label};return d}),valueStacked:a.map(function(a,c){return{label:a.label+"#"+a.index,valueLabel:a.series.filter(function(a,c){return a.label==b.label})[0].data,value:a.series.filter(function(a,c){return a.label==b.label})[0].data,prop:a.series.filter(function(a,c){return a.label==b.label})[0].prop,onClickVal:a.onClickVal,primv:a.value}})};return d}),d=0==c.length?[]:c[0].valueStacked.map(function(a){return Math.abs(a.value)});return c.forEach(function(a,b){if(0!=b){var e=c[b-1];a.valueStacked.forEach(function(a,b){d[b]+=Math.abs(a.value),a.value+=e.valueStacked[b].value})}}),F&&c.forEach(function(a,b){a.valueStacked.forEach(function(a,b){a.value=a.value/d[b]*100})}),c.forEach(function(a,b){a.prop.dontShowZeroValue&&(a.values=a.values.filter(function(a){return a.value>0}),a.valueStacked=a.valueStacked.filter(function(a){return a.value>0}))}),c}function i(){clearTimeout(bb),bol=P.property("checked"),b.isSort=bol;var a=Q[0][0].selectedIndex,c=Q[0][0].value,d=(Q[0][0],!0);a>=k.length&&(d=!1),ya.domain(b.isSort?G.sort(function(a,b){return na=a.series.filter(function(a){return a.label==c}),nb=b.series.filter(function(a){return a.label==c}),na instanceof Array?(na=na[0],nb=nb[0],"series"==na.type?nb.data-na.data:nb.data[0]-na.data[0]):0}).map(function(a){return a.label+"#"+a.index}):G.sort(function(a,b){return a.index-b.index}).map(function(a){return a.label+"#"+a.index})),Aa.domain(b.isSort?G.filter(da).sort(function(a,b){return na=a.series.filter(function(a){return a.label==c}),nb=b.series.filter(function(a){return a.label==c}),na instanceof Array?(na=na[0],nb=nb[0],"series"==na.type?nb.data-na.data:nb.data[0]-na.data[0]):0}).map(function(a){return a.label+"#"+a.index}):G.filter(da).sort(function(a,b){return a.index-b.index}).map(function(a){return a.label+"#"+a.index}));var e=Z.transition().duration(b.animationDuration),g=function(a,b){return H?50*b:0};e.selectAll(".gd").delay(g).attr("transform",function(a){return"translate("+ya(a.label+"#"+a.index)+",0)"}),e.selectAll(".gd-text").delay(g).attr("transform",function(a){return"translate("+ya(a.label+"#"+a.index)+",0)"});var i=h(G);Z.selectAll(".area").data(i).datum(function(a){var b=a.prop.lineType;return"line-dot-area"==b||"line-area"==b?E?a.valueStacked:a.values:0}).transition().duration(b.animationDuration).attr("d",function(a){return 0===a?Wa:Wa.interpolate(a[0].prop.lineStyle)(a)}),Z.selectAll(".line").data(i).datum(function(a){var b=a.prop.lineType;return"line-dot-area"==b||"line-dot"==b||"line-area"==b||"line"==b?E?a.valueStacked:a.values:0}).transition().duration(b.animationDuration).attr("d",function(a){return 0===a?Ya:Ya.interpolate(a[0].prop.lineStyle)(a)}),Z.selectAll(".circle-group").data(i).selectAll(".circle").data(function(a){var b=a.prop.lineType;return"line-dot-area"==b||"line-dot"==b||"dot"==b?E?a.valueStacked:a.values:0}).transition().duration(b.animationDuration).attr("stroke",function(a,b){var c=[a],d=d3.select(this.parentNode).datum().label,e=G[b].series.map(function(a){return a.label}),g=G[b].series.map(function(a){return a.data});f(c,g,e),a=c[0];var h=a.prop.seriesColor;return a.thenRows&&$.each(a.thenRows,function(a,b){$.each(b,function(a,b){if(d!=b.firstField)return!0;switch(+b.operand){case 1:h=b.secondFieldColor}})}),h}).attr("cx",function(a){return Ya.interpolate(a.prop.lineStyle).x()(a)}).attr("cy",function(a){return Ya.interpolate(a.prop.lineStyle).y()(a)}),Z.selectAll(".text-vals").data(i).selectAll(".text-value").data(function(a){var b=a.prop.lineType;return"line-dot-area"==b||"line-dot"==b||"dot"==b?E?a.valueStacked:a.values:0}).transition().duration(b.animationDuration).attr("x",function(a){var b=d3.select(this).node().getBBox().width;return Ya.interpolate(a.prop.lineStyle).x()(a)-b/2}).text(function(a){return persian(d3.format(z(a.prop.font,a.prop))(a.valueLabel),u)}).attr("dy","-10").attr("y",function(a){return Ya.interpolate(a.prop.lineStyle).y()(a)}),Z.selectAll(".colorStepGroup").data(i).selectAll("stop").data(function(a){var b=[],c=1/(2*(a.values.length-1)),d=-1*c;return a.values.map(function(e,g){var h={value:e.value,label:a.label,color:a.prop.seriesColor},i=[h],j=G[g].series.map(function(a){return a.label}),k=G[g].series.map(function(a){return a.data});f(i,k,j),h=i[0],h.offset=0>d?0:d,b.push(h),h=$.extend({},h),d+=2*c,h.offset=d>1?d-c:d,b.push(h)}),b}).transition().attr("stop-color",function(a,b){var c=a.color;return a.thenRows&&$.each(a.thenRows,function(b,d){$.each(d,function(b,d){if(a.label!=d.firstField)return!0;switch(+d.operand){case 1:c=d.secondFieldColor}})}),c}).attr("offset",function(a){return a.offset}),e.select(".x.axis").call(ga).selectAll("g").delay(g),e.select(".x.axis").selectAll("g text").attr("transform",function(){return Fa?"rotate(-90)":"rotate(0)"}).attr("class","axes-x-label").attr("x","-1em").attr("dy","0.1em").attr("y","0").delay(g),Z.select(".x.axis").selectAll("g text").attr("transform",function(){return Fa?"rotate(-90)":"rotate(0)"}).style("font-family",b.chartProp.info.font.fontName).style("font-size",b.chartProp.info.font.fontSize).attr("fill",b.chartProp.info.font.color).style("font-weight",b.chartProp.info.font.bold?"bold":"normal").style("font-style",b.chartProp.info.font.italic?"italic":"normal").style("text-anchor","end").attr("x","-1em").attr("dy","0.1em").attr("y","0").append("title").text(function(a){return persian(a.replace(new RegExp("#\\d+$"),""),u)})}b.input=a;a.title,a.chartInfo;app.chartCommons.calculateFields(a.series,b.calculatedFields);var j="undefined"!=typeof a.series?a.series.labels:[],k="undefined"!=typeof a.kpis?a.kpis.labels:[],l=a.seriesLablesCaptions,m=a.kpisLablesCaptions,n="#"+b.id,o=$(n).hasClass("fromCommentDialog"),p={top:0,right:20,bottom:0,left:20},q=$(n).width(),r="small"==b.chartProp.info.chartSize?80:"medium"==b.chartProp.info.chartSize?130:"large"==b.chartProp.info.chartSize?160:"veryLarge"==b.chartProp.info.chartSize?200:130,s=!app.mobileMode,t=b.chartProp.info.openDashboard&&b.chartProp.info.openDashboard.checked,u="undefined"==typeof a.lang?!0:0==+a.lang,v=r+p.top+p.bottom,w=d3.scale.category10();b.width=q;var x=d.isProgress,y=d.showProgress,z=(d.title,function(a,b){if(!a)return",.2f";var c=a;if(!a.formatString){if(!b)return",.2f";c=b}return"custom"!=c.formatString?c.formatString:c.formatStringCustom}),A=+b.chartProp.info.stackedBar,B=3==A||2==A,C=3==A,D=+b.chartProp.info.stackedLine,E=3==D||2==D,F=3==D;if(app.chartCommons.setDefault(b.chartProp,k.concat(j),"bar"),b.editMode&&$(n).trigger("chartproperty",[k.concat(j)]),!a.result)return void $("#"+b.id).append(app.chartCommons.getError(a));for(var G=prepareData(a,b.chartProp),H=G.length<25,I=d3.scale.category10(),J=[],K=0;K<j.length;K++){var L=b.chartProp.series[j[K]];if("undefined"==typeof L){L=0==b.chartProp.series.length?{seriesColor:"#1F77B4",seriesType:"bar",formatStringCustom:",.2f",formatString:",.2f",numberFactor:"1",showValues:!1,hidden:!1,cumulative:!1,lineFace:"5,0",lineWeight:"2",lineStyle:"linear",lineType:"line-dot-area",showValueColor:"#333333"}:$.extend({},b.chartProp.series[Object.keys(b.chartProp.series)[0]]);for(var M="#1F77B4",K=0;10>K&&(M=I(K)||"#1f77b4",-1!=J.indexOf(M.toLowerCase()));K++);L.seriesColor=M,L.name=null,b.chartProp.series[j[K]]=L}L.font&&!L.datasourceType||(L.font={bold:!1,color:L.showValueColor||"#333333",italic:!1,fontSize:L.showValueFontSize||"12px",fontName:"Droid"}),J.push(L.seriesColor.toLowerCase())}d3Utils.prepareDataForBarChart(G,b,j,k,l,m);for(var N=null,K=0;K<G.length;K++){N||(N=new Array(G.length));for(var O=0;O<G[K].series.length;O++)N[K]||(N[K]=new Array(G[K].series.length)),N[K][O]=N[K][O]||{sum:null,avg:null,"var":null},G[K].series[O].prop&&G[K].series[O].prop.cumulative&&("undefined"!=typeof G[K].series[O].prop.cumulative_formula&&"sum"!=G[K].series[O].prop.cumulative_formula||(N[K][O].sum=d3.sum(G.filter(function(a,b){return K>=b}),function(a,b){return a.series[O].data})),"avg"==G[K].series[O].prop.cumulative_formula&&(N[K][O].avg=d3.mean(G.filter(function(a,b){return K>=b}),function(a,b){return a.series[O].data})),"var"==G[K].series[O].prop.cumulative_formula&&(N[K][O]["var"]=d3.variance(G.filter(function(a,b){return K>=b}),function(a,b){return a.series[O].data})))}for(var K=0;K<G.length;K++)for(var O=0;O<G[K].series.length;O++)G[K].series[O].prop&&G[K].series[O].prop.cumulative&&(G[K].series[O].data=N[K][O]["var"]||N[K][O].sum||N[K][O].avg);C&&G.forEach(function(a){var b=a.series.filter(function(a,b){return!a.prop.hidden&&"bar"==a.prop.seriesType}),c=d3.sum(b.map(function(a){return Math.abs(a.data)}));b.forEach(function(a){a.data=a.data/c*100})}),$(n).addClass("bar-line-chart");var P,Q,R=d3.select(n).append("div").attr("class","legend-bar temporal");if(P=d3.select(n).select("#sort_checkbox_btn"),Q=d3.select(n).select("#sort_checkbox select"),!P[0][0]&&G.length>0){var S=R.append("div").attr("id","sort_checkbox").attr("class","sort-checkbox");P=S.append("label").append("input").attr("type","checkbox").attr("id","sort_checkbox_btn"),S.select("label").append("span"),app.lang.translateAsync("sort",function(a){var b=$(S[0][0]).find("span");b.html(" "+a)});var Q=S.append("select").on("change",function(){var a=P.property("checked");b.isSort=a,P.property("checked")&&i()}).style("margin","0 7px");k.length+j.length==1&&Q.style("visibility","hidden").style("width","1px"),Q.selectAll("nothings").data(G[0].series.filter(function(a,b){return!a.prop.hidden}).map(function(a){return{name:(a.prop.name||a.label).replace(/^\[measure\]/,""),value:a.label}})).enter().append("option").text(function(a){return persian(a.name,u)}).attr("value",function(a){return a.value})}if("undefined"==typeof b.chartProp.info.showSortBox||b.chartProp.info.showSortBox||$(n+" #sort_checkbox").hide(),R.breadcrumb(a.levels,b,d,u),!a.matrix||0==a.matrix.length)return void R.append("div").attr("class","temporal").style("font-size","0.8em").style("margin","15px").append("span").attr("class","translate").attr("data-trans-key","داده‌ای برای نمایش وجود ندارد").text("داده‌ای برای نمایش وجود ندارد");R.legend({width:q,selector:n,data:G[0].series.filter(function(a,b){return!a.prop.hidden}).map(function(a){return{label:(a.prop.name||a.label).replace(/^\[measure\]/,""),color:a.prop.seriesColor,key:a.key}})},u);var T=d3.max(G,function(a){return d3.max(a.series.filter(function(a,b){return!a.prop.hidden}),function(a){return"kpi"==a.type?d3.max(a.data):"series"==a.type?+a.data||0:void 0})}),U=d3.min(G,function(a){return d3.min(a.series.filter(function(a,b){return!a.prop.hidden}),function(a){return"kpi"==a.type?d3.min(a.data):"series"==a.type?+a.data||0:void 0})});if(B){var V=d3.max(G,function(a){return d3.sum(a.series.filter(function(a,b){return!a.prop.hidden&&"bar"==a.prop.seriesType}),function(a){return"kpi"==a.type?d3.max(a.data):"series"==a.type?a.data>0?a.data:0:void 0})});T=V>T?V:T;var W=d3.min(G,function(a){return d3.sum(a.series.filter(function(a,b){return!a.prop.hidden}),function(a){return"kpi"==a.type?d3.min(a.data):"series"==a.type?a.data<0?a.data:0:void 0})});U=U>W?W:U}if(E){var V=d3.max(G,function(a){return d3.sum(a.series.filter(function(a,b){return!a.prop.hidden&&"line"==a.prop.seriesType}),function(a){return"kpi"==a.type?d3.max(a.data):"series"==a.type?a.data>0?a.data:0:void 0})});T=V>T?V:T;var W=d3.min(G,function(a){return d3.sum(a.series.filter(function(a,b){return!a.prop.hidden}),function(a){return"kpi"==a.type?d3.min(a.data):"series"==a.type?a.data<0?a.data:0:void 0})});U=U>W?W:U}T=Math.max(T||0,0),U=Math.min(U||0,0),U-=Math.abs(.1*U),T+=Math.abs(.1*T);var X=G[0].series.filter(function(a){return"series"==a.type&&"bar"==a.prop.seriesType&&!a.prop.hidden}).length,Y=G[0].series.filter(function(a){return"series"==a.type&&"line"==a.prop.seriesType&&!a.prop.hidden}).length;(F&&Y>0||C&&X>0)&&(T=100,U=0>U?-100:0),b.chartProp.info.yAxisMax&&(T=+b.chartProp.info.yAxisMax),b.chartProp.info.yAxisMin&&(U=+b.chartProp.info.yAxisMin);var Z=d3.select(n).append("svg").attr("class","temporal line-chart"),aa=+b.chartProp.info.xAxisLen||20;b.chartProp.info.font||(b.chartProp.info.font={bold:!1,color:"#333333",italic:!1,fontSize:"12px",fontName:"Droid"});var ba=50,ca=G.length/ba,da=function(a,b){return G.length<=ba?!0:(0==b&&(this.meter=0),b>=this.meter?(this.meter+=ca,!0):!1)},ea=30;if(app.dashboardLayoutVersion=app.dashboardLayoutVersion||2,2==app.dashboardLayoutVersion&&!b.editMode){var fa=d3.scale.ordinal().rangeRoundBands([q-400,q],.1);fa.domain(G.map(function(a){return a.label+"#"+a.index}).filter(da));var ga=d3.svg.axis().scale(fa).orient("bottom").tickFormat(function(a){var b=a.replace(new RegExp("#\\d+$"),"");return(b.length>aa?"...":"")+persian(b.substring(0,aa),u)}),ha=d3.select(n).append("svg");ha.append("g").attr("class","x axis").call(ga),ha.selectAll("g text").attr("transform","rotate(-90)").attr("x","-1em").attr("dy","0.1em").attr("y","0").attr("fill",b.chartProp.info.font.color).attr("class","axes-x-label").style("font-family",b.chartProp.info.font.fontName).style("font-size",b.chartProp.info.font.fontSize).style("font-weight",b.chartProp.info.font.bold?"bold":"normal").style("font-style",b.chartProp.info.font.italic?"italic":"normal").append("title").text(function(a){return persian(a.replace(new RegExp("#\\d+$"),""),u)});var ia=ha.node(),ja=ia.getBBox();try{ea=ha.selectAll("text")[0][1].getBBox().height}catch(ka){}var la=$(n+" .title").outerHeight(),ma=$(n+" .legend-bar"),oa="undefined"==typeof ma?0:ma.height()+ +ma.css("margin-top").replace("px","");ha.remove(),r=$(n).height()-la-oa-ja.height-15,50>r&&(r=50),Z.attr("width",q).attr("height",r+ja.height+15)}var pa=d3.scale.linear().range([r+p.top,p.top]).domain([U,T]),qa=d3.svg.axis().scale(pa).orient("left").tickFormat(function(a){var c=d3.format(b.chartProp.info.formatString);return persian(c(a),u)+""});qa.ticks(Math.floor(r/22)+1);var ra=Z.append("g").attr("class","y axis").attr("transform","translate(-10,0)");ra.call(qa);var sa=ra[0][0].getBBox(),ta=q-sa.width-p.left;G=G.filter(function(a,b){return ta-2-.1*ta>b});var ua=[q-ta+10,q-10],va=.1,wa=G.length<10?1:0;ra.attr("transform","translate("+(sa.width+p.left)+",0)");var xa=$.grep(G[0].series,function(a,b){return"bar"==a.prop.seriesType&&!a.prop.hidden}),ya=($.grep(G[0].series,function(a,b){return"line"==a.prop.seriesType&&!a.prop.hidden}),d3.scale.ordinal().rangeBands(ua,va,wa));ya.domain(G.map(function(a){return a.label+"#"+a.index}));var za=d3.scale.ordinal().rangeBands([0,ya.rangeBand()]).domain($.map(xa,function(a){return a.label})),Aa=d3.scale.ordinal().rangeBands(ua,va,wa);ba=Math.abs(ua[0]-ua[1])/ea,ca=G.length/ba,Aa.domain(G.map(function(a){return a.label+"#"+a.index}).filter(da));var ga=d3.svg.axis().scale(Aa).orient("bottom").tickFormat(function(a){var b=a.replace(new RegExp("#\\d+$"),"");return(b.length>aa?"...":"")+persian(b.substring(0,aa),u)});Z.append("svg:rect").attr("class","background").style("fill","white").style("opacity","0").attr("width",ta).attr("height",+Z.attr("height")).attr("transform","translate("+(q-ta)+",0)").on("click",function(c,d){o||""!=a.levels&&(x()||(y(!0),b.isSort=P.property("checked"),app.chartCommons.drillDown.up(b.ChartInPageId),b.parameters={isUp:!0,chartId:b.chartId,ChartInPageId:b.ChartInPageId,notEditMode:!b.editMode},$(n).charts(chartTypes.BAR,"refreshWithData",b)))}),b.chartProp.info.horizontalLines&&Z.select(".y.axis").selectAll("g line").attr("x2",ta).attr("x1","-6").style("opacity","0.1"),Z.select(".y.axis").append("text").attr("transform","translate(0,"+p.top+") rotate(-90)").attr("y",6).attr("dy",".71em").attr("class","axes-x-label").text("");var Ba=(d3.scale.ordinal().domain([0,1,2]).range(["#eee","#ddd","#ccc"]),b.chartProp.globalvariable&&b.chartProp.globalvariable.length>0&&!b.editMode&&b.chartProp.globalvariable.filter(function(b){return b.field==a.CurrentDimName}).length>0);Z.append("g").attr("class","x axis").attr("transform","translate(0,"+(r+p.top)+")").call(ga);var Ca=Z.select(".x.axis").selectAll("g text").attr("class","axes-x-label").attr("x","-1em").attr("dy","0.1em").attr("y","0").style("font-family",b.chartProp.info.font.fontName).style("font-size",b.chartProp.info.font.fontSize).attr("fill",b.chartProp.info.font.color).style("font-weight",b.chartProp.info.font.bold?"bold":"normal").style("font-style",b.chartProp.info.font.italic?"italic":"normal"),Da=d3.max(Ca[0],function(a){return a.getBBox().width}),Ea=Ca[0].length*Da,Fa=Ea>ta;Fa=!0,Fa&&Ca.attr("transform","rotate(-90)"),Ca.append("title").text(function(a){return persian(a.replace(new RegExp("#\\d+$"),""),u)});var Ga=function(c,d){if(!o){if(b.chartProp.globalvariable&&b.chartProp.globalvariable.length>0&&!b.editMode&&(app.globalVariableHelper.updateGlobalVariables([a.CurrentDimName],[c.value],b.chartProp.globalvariable),$(n+" .gd.selected-item").attr("class",$(this).attr("class").replace("selected-item","")),$(n+" .circle.selected-item").attr("class",$(this).attr("class").replace("selected-item","")),$(this).attr("class",$(this).attr("class")+" selected-item")),""==c.onClickVal)return void(t&&!b.editMode&&app.chartCommons.openLink(b.chartProp.info.openDashboard));if(!x()){y(!0);var e=P.property("checked");b.isSort=e,app.chartCommons.drillDown.add(b.ChartInPageId,b.input.DataSourceId,b.input.CurrentDimName,c.onClickVal),b.parameters={selectedItem:c.onClickVal,chartId:b.chartId,ChartInPageId:b.ChartInPageId,notEditMode:!b.editMode},$(n).charts(chartTypes.BAR,"refreshWithData",b)}}},Ha=Z.append("g").attr("class","charts"),Ia=Ha.selectAll(".gd").data(G).enter().append("g").attr("transform","translate("+ya(G[0].label+"#"+G[0].index)+",0)").attr("class",function(a){return"gd "+(""!=a.onClickVal||Ba||t?" pointer":"")}).on("click",Ga),Ja={lastTexts:[],clear:function(){this.lastTexts=[]},noConfilict:function(a,b,c,d){for(var e=!0,f=0;f<this.lastTexts.length;f++){var g=this.lastTexts[f];if(e=c+ya.rangeBand()/2-a/2>g.x+3||g.y-g.h-3>d||g.y<d-b-3,!e)break}return e&&(this.lastTexts.length>=5&&this.lastTexts.shift(),this.lastTexts.push({x:c+a/2,y:d,h:b})),e}};if(B){var Ka=G.map(function(a){return a.label+"#"+a.index}),La=Ia.selectAll("nothings").data(function(a){var b=a.series.filter(function(a){return"series"==a.type&&"bar"==a.prop.seriesType&&!a.prop.hidden}),c=a.series.map(function(a){return a.label}),d=a.series.map(function(a){return a.data});return f(b,d,c),_.reverse(b)}).enter().append("g").attr("class","series").attr("transform",function(a,b){return"translate(0,0)"});pa(U)-pa(0);La.append("rect").attr("width",ya.rangeBand()).attr("fill",function(a,b){var c=a.prop.seriesColor;return a.thenRows&&$.each(a.thenRows,function(b,d){$.each(d,function(b,d){if(a.label!=d.firstField)return!0;switch(+d.operand){case 1:c=d.secondFieldColor}})}),c}).attr("y",function(a){return pa(a.data>=0?a.data>T?T:a.data:0)}).attr("height",function(a){return a.data>0?pa(Math.max(0,U))-pa(a.data>T?T:a.data):pa(a.data<U?U:a.data)-pa(0)}).on("click",function(a){o&&app.chartCommons.commentUtils.clickOnCommentIcon(a,b.ChartInPageId)});var Ma=[[]],Ma=La.append("text").text(function(a,b){return a.prop.showValues?0==a.data?"":persian(d3.format(z(a.prop.font,a.prop))(a.data),u):""}).attr("dy","0.3em").style("font-family",function(a){return a.prop.font.fontName}).style("font-size",function(a){return a.prop.font.fontSize}).attr("fill",function(a){return a.prop.font.color}).style("font-weight",function(a){return a.prop.font.bold?"bold":"normal"}).style("font-style",function(a){return a.prop.font.italic?"italic":"normal"}).attr("x",function(a){var b=d3.select(this).node().getBBox().width;return ya.rangeBand()/2-b/2}).attr("y",function(a){var b=a.data>0?pa(Math.max(0,U))-pa(a.data>T?T:a.data):pa(a.data<U?U:a.data)-pa(0),c=pa(a.data>=0?a.data>T?T:a.data:0);return c+b/2});app.chartCommons.commentUtils.addCommentIcon(b.ChartInPageId,La,function(a){return ya.rangeBand()/2-5},function(a){var b=a.data>0?pa(Math.max(0,U))-pa(a.data>T?T:a.data):pa(a.data<U?U:a.data)-pa(0),c=pa(a.data>=0?a.data>T?T:a.data:0);return c+b/2-24}),o&&app.chartCommons.commentUtils.setOnHighlightListener(Ia.selectAll(".series"),b.ChartInPageId);La.selectAll(".comment");La.forEach(function(a,b){var c=Ma[b]||[],d=0,e=0;a=_.reverse(a),c=_.reverse(c),a.forEach(function(a,b){var f=(c[b]||null,a.__data__.data),g=d3.select(a).select("rect").attr("height");f>=0?(d3.select(a).attr("transform",function(a,b){return"translate(0,"+d+")"}),d-=+g):(d3.select(a).attr("transform",function(a,b){return"translate(0,"+e+")"}),e+=+g)})})}else{var La=Ia.selectAll("nothings").data(function(a){var b=a.series.filter(function(a){return"series"==a.type&&"bar"==a.prop.seriesType&&!a.prop.hidden}),c=a.series.map(function(a){return a.label}),d=a.series.map(function(a){return a.data});return f(b,d,c),b}).enter().append("g").attr("class","series").attr("transform",function(a,b){return"translate("+za(a.label)+",0)"});pa(U)-pa(0);La.append("rect").attr("width",za.rangeBand()).attr("fill",function(a,b){var c=a.prop.seriesColor;return a.thenRows&&$.each(a.thenRows,function(b,d){$.each(d,function(b,d){if(a.label!=d.firstField)return!0;switch(+d.operand){case 1:c=d.secondFieldColor}})}),c}).attr("y",function(a){return pa(a.data>=0?a.data>T?T:a.data:0)}).attr("height",function(a){return a.data>0?pa(Math.max(0,U))-pa(a.data>T?T:a.data):pa(a.data<U?U:a.data)-pa(0)}).on("click",function(a){o&&app.chartCommons.commentUtils.clickOnCommentIcon(a,b.ChartInPageId)}),app.chartCommons.commentUtils.addCommentIcon(b.ChartInPageId,La,function(a){return za.rangeBand()/2-5},function(a){return pa(a.data>=0?a.data>T?T:a.data:0)-24}),o&&app.chartCommons.commentUtils.setOnHighlightListener(Ia.selectAll(".series"),b.ChartInPageId);var Na=Ha.selectAll(".gd-text").data(G).enter().append("g").attr("transform","translate("+ya(G[0].label+"#"+G[0].index)+",0)").attr("class",function(a){return"gd-text"+(""!=a.onClickVal||Ba?" pointer":"")}).on("click",Ga),Ma=Na.selectAll("nothings").data(function(a){return a.series.filter(function(a){return"series"==a.type&&"bar"==a.prop.seriesType&&!a.prop.hidden})}).enter().append("text").text(function(a){return a.prop.showValues?persian(d3.format(z(a.prop.font,a.prop))(a.data),u):""}).style("font-family",function(a){return a.prop.font.fontName}).style("font-size",function(a){return a.prop.font.fontSize}).attr("fill",function(a){return a.prop.font.color}).style("font-weight",function(a){return a.prop.font.bold?"bold":"normal"}).style("font-style",function(a){return a.prop.font.italic?"italic":"normal"}).style("text-anchor",app.lang.isRtl()?"start":"end").attr("x","0.3em").attr("dy","-0.3em").attr("transform",function(a,b){return"translate("+za(a.label)+",0)"}).attr("y",function(a){return pa(a.data>=0?a.data>T?T:a.data:0)}).attr("y",function(a){return pa(a.data>=0?a.data>T?T:a.data:0)}).on("click",function(a){o&&app.chartCommons.commentUtils.clickOnCommentIcon(a,b.ChartInPageId)}),Ka=G.map(function(a){return a.label+"#"+a.index});Ma.forEach(function(a,b){a.forEach(function(a,c){var d=a.getBBox().width,e=a.getBBox().height,f=za.rangeBand(),g=f/2-d/2;d3.select(a).attr("x",g),Ja.noConfilict(d,e,ya(Ka[b]),d3.select(a).attr("y"))||$(a).remove()})}),Ja.clear()}if(1==app.dashboardLayoutVersion||b.editMode){var Ca=Z.select(".x.axis").selectAll("g text").attr("class","axes-x-label").attr("x","-1em").attr("transform",function(){return Fa?"rotate(-90)":"rotate(0)"}).attr("dy","0.1em").attr("y","0").style("font-family",b.chartProp.info.font.fontName).style("font-size",b.chartProp.info.font.fontSize).attr("fill",b.chartProp.info.font.color).style("font-weight",b.chartProp.info.font.bold?"bold":"normal").style("font-style",b.chartProp.info.font.italic?"italic":"normal"),ia=$(n).find(".x").first().get(0),ja=ia.getBBox();ja.height-p.bottom;Z.attr("width",q).attr("height",v+ja.height);
}var La=Ia.selectAll("nothing").data(function(a){return a.series.filter(function(a){return"kpi"==a.type&&"bar"==a.prop.seriesType&&!a.prop.hidden})}).enter().append("g").attr("class","kpi").attr("transform",function(a,b){return"translate("+za(a.label)+",0)"});La.append("rect").attr("width",za.rangeBand()).attr("y",function(a){return pa(1.1*a.data[1])}).attr("height",function(a){return r+p.top-pa(1.1*a.data[1])}).attr("fill","#eee"),La.append("rect").attr("width",za.rangeBand()).attr("y",function(a){return pa(a.data[0])}).attr("height",function(a){return r+p.top-pa(a.data[0])}).attr("fill",function(a,b){return w(b)}),La.append("rect").attr("width",za.rangeBand()).attr("y",function(a){return pa(1*a.data[1])}).attr("height",function(a){return 0==a.data[1]?0:2}).attr("fill","#333");var Oa=function(a){return a>0?"#71b37c":0==a?"#8d8d8d":"#e14d57"};La.append("circle").attr("r",function(a){return 0==a.data[1]?0:za.rangeBand()/2<5?za.rangeBand()/2:5}).attr("fill",function(a){return Oa(a.data[1])}).attr("cx",za.rangeBand()/2).attr("cy",function(a){return pa(1.1*a.data[1])-(za.rangeBand()/2<5?za.rangeBand()/2:5)}),$(n+" .kpi").tipsy({gravity:"w",html:!0,title:function(){var a=+b.chartProp.info.tooltip||1,c=G.map(function(a){return a.index}).indexOf($(this).parent(".gd").get(0).__data__.index);return g(c,a,"bar",$(this).index())}}),$(n+" .series").tipsy({gravity:"w",html:!0,title:function(){var a=+b.chartProp.info.tooltip||1,c=G.map(function(a){return a.index}).indexOf($(this).parent(".gd").get(0).__data__.index),d=g(c,a,"bar",$(this).index());return d}}),$(n+" .gd-text text").tipsy({gravity:"w",html:!0,title:function(){var a=+b.chartProp.info.tooltip||1,c=G.map(function(a){return a.index}).indexOf($(this).parent(".gd-text").get(0).__data__.index);return g(c,a,"bar",$(this).index())}});var Pa=Ha.append("g"),Qa=Ha.append("g"),Ra=Ha.append("g"),Sa=Ha.append("g"),Ta=h(G),Ua="linear",Va=d3.svg.area().x(function(a){return ya(a.label)+ya.rangeBand()/2}).y0(r+p.top).y1(pa(U)).interpolate(Ua),Wa=d3.svg.area().x(function(a){return ya(a.label)+ya.rangeBand()/2}).y0(r+p.top).y1(function(a){return pa(a.value>T?T:a.value<U?U:a.value)}).interpolate(Ua),Xa=d3.svg.line().x(function(a){return ya(a.label)+ya.rangeBand()/2}).y(function(a){return pa(U)}).interpolate(Ua),Ya=d3.svg.line().x(function(a){return ya(a.label)+ya.rangeBand()/2}).y(function(a){return pa(a.value>T?T:a.value<U?U:a.value)}).interpolate(Ua),Za=Qa.selectAll("nothings").data(Ta).enter().append("path").attr("class","area").attr("id",function(a,b){return"area"+b}).attr("fill",function(a,c){return b.chartProp.indicator&&b.chartProp.indicator.length?"url(#"+b.id+"-"+c+")":a.prop.seriesColor}).attr("z-index","-1").style("opacity",function(a){return a.prop.areaOpacity||.1}).datum(function(a){var b=a.prop.lineType;return"line-dot-area"==b||"line-area"==b?E?a.valueStacked:a.values:0});s?Za.attr("d",function(a){return 0===a?Va:Va.interpolate(a[0].prop.lineStyle)(a)}).transition().duration(b.animationDuration).attr("d",function(a){return 0===a?Wa:Wa.interpolate(a[0].prop.lineStyle)(a)}):Za.attr("d",function(a){return 0===a?Wa:Wa.interpolate(a[0].prop.lineStyle)(a)}),Za=Ra.selectAll("nothings").data(Ta).enter().append("path").attr("class","line").attr("id",function(a,b){return"line"+b}).attr("stroke",function(a,c){return b.chartProp.indicator&&b.chartProp.indicator.length?"url(#"+b.id+"-"+c+")":a.prop.seriesColor}).attr("stroke-width",function(a,b){return a.prop.lineWeight}).attr("stroke-dasharray",function(a,b){return a.prop.lineFace}).datum(function(a){var b=a.prop.lineType;return"line-dot-area"==b||"line-dot"==b||"line-area"==b||"line"==b?E?a.valueStacked:a.values:0}),s?Za.attr("d",function(a){return 0===a?Xa:Xa.interpolate(a[0].prop.lineStyle)(a)}).transition().duration(b.animationDuration).attr("d",function(a){return 0===a?Ya:Ya.interpolate(a[0].prop.lineStyle)(a)}):Za.attr("d",function(a){return 0===a?Ya:Ya.interpolate(a[0].prop.lineStyle)(a)});var Ba=b.chartProp.globalvariable&&b.chartProp.globalvariable.length>0&&!b.editMode&&b.chartProp.globalvariable.filter(function(b){return b.field==a.CurrentDimName}).length>0,$a=function(c,d){if(o)return void app.chartCommons.commentUtils.clickOnCommentIcon(c,b.ChartInPageId);if(b.chartProp.globalvariable&&b.chartProp.globalvariable.length>0&&!b.editMode&&(app.globalVariableHelper.updateGlobalVariables([a.CurrentDimName],[c.primv],b.chartProp.globalvariable),$(n+" .circle.selected-item").attr("class",$(this).attr("class").replace("selected-item","")),$(n+" .gd.selected-item").attr("class",$(this).attr("class").replace("selected-item","")),$(this).attr("class",$(this).attr("class")+" selected-item")),""==c.onClickVal)return void(t&&!b.editMode&&app.chartCommons.openLink(b.chartProp.info.openDashboard));if(!x()){y(!0),b.isSort=e,app.chartCommons.drillDown.add(b.ChartInPageId,b.input.DataSourceId,b.input.CurrentDimName,c.onClickVal),b.parameters={selectedItem:c.onClickVal,chartId:b.chartId,ChartInPageId:b.ChartInPageId,notEditMode:!b.editMode},$(n).charts(chartTypes.BAR,"refreshWithData",b);var e=P.property("checked")}};tempG=Sa.selectAll("nothings").data(Ta).enter().append("g").attr("class",function(a){return"circle-group "+(""!=a.onClickVal||Ba?" pointer":"")});var _a=tempG.selectAll(".entry").data(function(a){return E?a.valueStacked:a.values}).enter().append("g").attr("class","entry"),Za=_a.append("circle").attr("class","circle").attr("stroke",function(a,b){var c=[a],d=d3.select(this.parentNode).datum().label,e=G[b].series.map(function(a){return a.label}),g=G[b].series.map(function(a){return a.data});f(c,g,e),a=c[0];var h=a.prop.seriesColor;return a.thenRows&&$.each(a.thenRows,function(a,b){$.each(b,function(a,b){if(d!=b.firstField)return!0;switch(+b.operand){case 1:h=b.secondFieldColor}})}),h}).attr("stroke-width",function(a,b){return a.prop.lineWeight}).on("click",$a).on("mouseover",function(a){d3.select(this).attr("stroke-width",parseInt(a.prop.lineWeight)+3)}).on("mouseout",function(a){d3.select(this).attr("stroke-width",a.prop.lineWeight)}).attr("cx",function(a){return Ya.interpolate(a.prop.lineStyle).x()(a)}).style("opacity",function(){var a=d3.select(this.parentNode).datum().prop.lineType;return"line-area"==a||"line"==a?0:1}).attr("r","4");if(s?Za.attr("cy",pa(U)).transition().duration(b.animationDuration).attr("cy",function(a){return Ya.interpolate(a.prop.lineStyle).y()(a)}):Za.attr("cy",function(a){return Ya.interpolate(a.prop.lineStyle).y()(a)}),app.chartCommons.commentUtils.addCommentIcon(b.ChartInPageId,_a,function(a){return Ya.interpolate(a.prop.lineStyle).x()(a)-5},function(a){return Ya.interpolate(a.prop.lineStyle).y()(a)-24}),o){var Ca=tempG.selectAll(".entry");app.chartCommons.commentUtils.setOnHighlightListener(tempG.selectAll(".entry"),b.ChartInPageId)}Pa.attr("class","colorStepGroups").selectAll(".colorStepGroup").data(Ta).enter().append("linearGradient").attr("id",function(a,c){return b.id+"-"+c}).attr("class","colorStepGroup").selectAll("stop-color").data(function(a){var b=[],c=1/(2*(a.values.length-1)),d=-1*c;return a.values.map(function(e,g){var h={value:e.value,label:a.label,color:a.prop.seriesColor},i=[h],j=G[g].series.map(function(a){return a.label}),k=G[g].series.map(function(a){return a.data});f(i,k,j),h=i[0],h.offset=0>d?0:d,b.push(h),h=$.extend({},h),d+=2*c,h.offset=d>1?d-c:d,b.push(h)}),b}).enter().append("stop").attr("stop-color",function(a,b){var c=a.color;return a.thenRows&&$.each(a.thenRows,function(b,d){$.each(d,function(b,d){if(a.label!=d.firstField)return!0;switch(+d.operand){case 1:c=d.secondFieldColor}})}),c}).attr("offset",function(a){return a.offset}),Za=Sa.selectAll("nothings").data(Ta).enter().append("g").attr("class",function(a){return"text-vals"}).selectAll("text").data(function(a){return a.prop.showValues?E?a.valueStacked:a.values:0}).enter().append("text").text(function(a){return persian(d3.format(z(a.prop.font,a.prop))(a.valueLabel),u)}).attr("class","text-value pointer xxx").style("font-family",function(a){return a.prop.font.fontName}).style("font-size",function(a){return a.prop.font.fontSize}).attr("fill",function(a){return a.prop.font.color}).style("font-weight",function(a){return a.prop.font.bold?"bold":"normal"}).style("font-style",function(a){return a.prop.font.italic?"italic":"normal"}).style("text-anchor",app.lang.isRtl()?"start":"end").attr("dy","-10").attr("dy","-10").attr("x",function(a,b){var c=d3.select(this).node().getBBox().width,d=d3.select(this).node().getBBox().height,e=(ya(Ka[b]),Ya.interpolate(a.prop.lineStyle).y()(a));return Ja.noConfilict(c,d,ya(Ka[b]),e)||d3.select(this).style("display","none"),Ya.interpolate(a.prop.lineStyle).x()(a)-c/2}).on("click",$a),s?Za.attr("y",pa(U)).transition().duration(b.animationDuration).attr("y",function(a){return Ya.interpolate(a.prop.lineStyle).y()(a)}):Za.attr("y",function(a){return Ya.interpolate(a.prop.lineStyle).y()(a)}),$(n+" .circle").tipsy({gravity:"w",html:!0,title:function(){var a=+b.chartProp.info.tooltip||1,c="",d=$(this).parent("g.entry").index(),e=$(this).parent("g.circle-group").index();return c=g(d,a,"line",e)}}),$(n+" .text-value").tipsy({gravity:"w",html:!0,title:function(){var a=+b.chartProp.info.tooltip||1,c="",d=$(this).index(),e=$(this).parent("g.text-vals").index()-$(this).parent("g.text-vals").parent().children().length/2;return c=g(d,a,"line",e)}}),P.on("change",i),Q.on("change",i);var ab=!0,bb=setTimeout(function(){b.isSort?P.property("checked",!0).each(i):P.each(i),ab=!1},0);$(n).trigger("heightChange")};var chartTypes={BAR:1,PIE:2,LINE:3,GAUGE:4,TABLE:5,MAP:6,UserControl:7,Radar:8,Tree:9,Text:10,CE_MAP:{1:"barLine",2:"pie",4:"gauge",5:"table",6:"map",7:"userControl",8:"radar",9:"tree",10:"text"},NAMES:{1:"نمودار خطی-میله‌ای",2:"نمودار دایره‌ای",4:"نمودار عقربه‌ای",5:"جدول",7:"کنترل کاربری",8:"نمودار رادار",9:"نمودار درختی",10:"متن"}};!function(a){function b(b,c,d){var e=a(this).data("settings");if("undefined"!=typeof e)return e.isRefresh=!0,e=a.extend(e,c),setTimeout(function(){g(b,e.input,e,!0,d),e.parameters.selectedItem=null,e.parameters.isUp=!1},0),this}function c(b){var c=a(this).data("ajaxRequest");return null!=c&&c.abort(),this}function d(b,c,d){d=a.extend({refreshRelatedDatasources:!0},d);var e=(a(this),a(this).data("settings"));if(e=a.extend(e,c),e.isRefresh=!1,"undefined"!=typeof e.chartProp){app.chartCommons.setFilterParameter(e),e.parameters.filterHierarchy=app.chartCommons.getFilterHierarchy(e.ChartInPageId),e.editMode&&(e.parameters.ChartInfo=a("#divChart").data("chartInfo"));var h=[];if(b==chartTypes.TABLE)for(var i in e.chartProp.series)e.chartProp.series.hasOwnProperty(i)&&h.push({Name:i,Type:e.chartProp.series[i].rowResult});e.dataUrl=f(b);var j=app.mobileMode?proxy.ajax:a.ajax,k=a.extend(e.parameters,{resultRows:h,type:e.dataType}),l=app.mobileMode&&!app.mobileModeTest?k:JSON.stringify(k);d.refreshRelatedDatasources&&e.ChartInPageId&&(app.moderation.dashboadpage.refreshRelatedDatasources(e.input.RefreshDatasource,[+e.ChartInPageId]),app.filterBox&&app.filterBox.refresh&&app.filterBox.refresh());var m=j({url:e.dataUrl,type:"POST",dataType:"json",contentType:"application/json",data:l,async:e.async,requestId:e.requestId,success:function(a){g(b,a,e,!0),e.parameters.selectedItem=null,e.parameters.isUp=!1}});return a(this).data("ajaxRequest",m),this}}function e(b,c){var d=a.extend({},h,c),e=a(this);d.id=e.attr("id"),d.type=b,e.data("isChart",!0),e.data("settings",d),app.chartCommons.setFilterParameter(d);var i=[];if(b==chartTypes.TABLE)for(var j in d.chartProp.series)d.chartProp.series.hasOwnProperty(j)&&i.push({Name:j,Type:d.chartProp.series[j].rowResult});d.dataUrl=f(b);var k=app.mobileMode?proxy.ajax:a.ajax;app.mobileMode&&(a.ajax=proxy.ajax);var l=a.extend(d.parameters,{resultRows:i,type:d.dataType}),m=app.mobileMode&&!app.mobileModeTest?l:JSON.stringify(l),n=k({url:d.dataUrl,type:"POST",dataType:"json",data:m,success:function(c,e,f){d.mobileModeData={isOnline:e,date:f},"undefined"==typeof d.chartProp&&c.detail&&(d=a.extend(d,JSON.parse(c.detail))),g(b,c,d,!1),d.parameters.selectedItem=null,d.parameters.isUp=!1},cache:!1,contentType:"application/json",error:function(b){b&&b.responseJSON&&b.responseJSON.forceSignout&&(alert("شما از برنامه خارج شده‌اید. ممکن است کاربر دیگری با نام کاربری شما وارد سیستم شده باشد."),window.location.href=app.urlPrefix);var c="#"+d.id;a(c).addClass("bar-chart").empty(),b&&b.responseJSON&&b.responseJSON.desc?a(c).addClass("bar-chart").html("<b>"+b.responseJSON.title+' </b>  <span class="glyphicon glyphicon-info-sign"> </span> <br/ > <p style="direction:ltr;">'+b.responseJSON.desc+"</p>"):a(c).addClass("bar-chart").html('خطا در دریافت اطلاعات <span class="glyphicon glyphicon-info-sign"> </span>')},requestId:d.requestId});return a(this).data("ajaxRequest",n),e}function f(a){switch(parseInt(a)){case chartTypes.UserControl:return app.urlPrefix+"api/chartdata/GetColumnMembers";case chartTypes.Tree:return app.urlPrefix+"Charts/BarChart/getTreeData";default:return app.urlPrefix+"api/chartdata/getdata"}}function g(b,c,d,e,f){if(d.editMode||dashboard.setLastRefresh(d.ChartInPageId,c.LastRefresh),d.input=c,arguments.length<4)return void a.error("تعداد پارامترها باید حداقل چهار تا باشد");if("undefined"!=typeof d.chartProp){if(d.chartProp.info.refreshPeriod&&+d.chartProp.info.refreshPeriod>0){var g=a("#"+d.id).data("timeout");g&&clearTimeout(g);var h=setTimeout(function(){a("#"+d.id).charts(b,"refreshWithData")},1e3*+d.chartProp.info.refreshPeriod);a("#"+d.id).data("timeout",h)}a("#dashboard-chart-panel").trigger("chartComplete",[d,c]);var i="#"+d.id;e&&!f?a(i).find(".temporal").remove():a(i).addClass("bar-chart").empty(),d.fromCommentDialog&&a(i).addClass("fromCommentDialog"),c=a.extend({EditPermission:!1,Description:"",LastRefresh:0,isFresh:!0,title:""},c);var j={title:null,showProgress:function(){},isProgress:function(){}};switch(j=d3.select(i).titlebar({EditPermission:c.EditPermission,editLink:d.editLink,RemoveFromPage:d.RemoveFromPage,deleteLink:d.removeLink,desc:c.Description,LastRefresh:c.LastRefresh,isFresh:c.isFresh,title:c.title,chartId:d.chartId,ChartInPageId:d.ChartInPageId,type:b,editMode:d.editMode,refreshWithData:e,redrowAll:f,settings:d,showFilterIcon:"undefined"==typeof d.chartProp.info.showFilterIcon?1:+d.chartProp.info.showFilterIcon}),d.titlebar=j,j.showProgress(!1),parseInt(b)){case chartTypes.BAR:app.charts.bar.draw(c,d,e,j);break;case chartTypes.GAUGE:app.charts.gauge.draw(c,d,e,j);break;case chartTypes.PIE:app.charts.pie.draw(c,d,e,j);break;case chartTypes.TABLE:app.charts.table.draw(c,d,e,j);break;case chartTypes.MAP:app.charts.map.draw(c,d,e,j);break;case chartTypes.UserControl:app.charts.userControl.draw(c,d,e,j);break;case chartTypes.Radar:app.charts.radar.draw(c,d,e,j);break;case chartTypes.Tree:app.charts.tree.draw(c,d,e,j);break;case chartTypes.Text:app.charts.text.draw(c,d,e,j)}app.lang.setLang({selector:i}),d.finishDraw&&d.finishDraw(d),app.chartCommons.renderComments(d,c)}}var h={isSort:!1,fadeSpeed:200,fadeinEasing:"easeInOutCubic",chartId:-1,animationDuration:1e3,animationEase:"cubic-out"};jQuery.fn.charts=function(f,g){var h={init:e,refresh:b,refreshWithData:d,abort:c};if(h[g]){var i=Array.prototype.slice.call(arguments,0),g=i.splice(1,1);return h[g].apply(this,i)}return"object"!=typeof method&&"undefined"!=typeof method&&g?void a.Error("Method "+g+" does not exist on jQuery.sitBarChart: you must specify type"):h.init.apply(this,arguments)},app.chartCommons.draw=g}(jQuery);var app=app||{};app.charts=app.charts||{},app.charts.gauge={},app.charts.gauge.draw=function(a,b,c,d){function e(a,b){return"undefined"==typeof a?null:a[b]}function f(a,b){return isNaN(a)?b?-99999:99999:parseFloat(a)}function g(a,b,c,d){var e="arc"==d?200:150,f="arc"==d?200:"number"==d?100:60;if(a>=c*e)return{w:a/c,h:Math.max(b,f)};if(b>=c*f)return{w:Math.max(a,e),h:b/c};var g=Math.ceil(1*a/e),h=Math.ceil(1*c/g);return{w:Math.max(a/g,e),h:Math.max(b/h,f)}}function h(a,c,d,e,f){var g=5;f-=48;var h=d3.select(a).selectAll("nothings").data(function(a){return a.kpis}).enter().append("div").style({width:f+"px","margin-left":"10px","margin-right":"10px"}).append("div");if(b.chartProp.info.showLabels){h.append("div").text(function(a,b){var d=p[b];return persian(c.label+(d?" - "+d:""),n)})}var i=h.append("div"),j=i.append("div").style("text-align","left").style("position","relative");ua=$(i[0][0]).width();var k=i.append("svg").attr("width",ua).attr("class","line-svg").attr("height",v+2*g),l=0,m=0;if(ia>=0&&ha>=0)l=0,m=1.2*ha;else{var o=Math.max(Math.abs(ha),Math.abs(ia));l=-1.2*o,m=1.2*o}var q=d3.scale.linear().range([0,ua]).domain([l,m]);k.append("rect").attr("height",v).attr("y",g).attr("fill",ja(0)).attr("width",ua),k.append("rect").attr("height",v).attr("y",g).attr("fill",function(a,b){return na(a[2])}).attr("width",0).transition().duration(b.animationDuration).attr("width",function(a){return q(a[0])}),k.append("rect").attr("width","5").attr("x","0").attr("y","0").attr("height",v+g).attr("fill","#333").transition().duration(b.animationDuration).attr("x",function(a){return q(a[0])-5<l?l:q(a[0])-5}),k.filter(function(a){return!isNaN(a[1])}).append("path").attr("transform",function(a){return"translate("+(q(a[1])-5<l?l:q(a[1])-5)+",0)"}).attr("d","M0 "+g+" 0 "+(v+2*g)).attr("stroke-dasharray","2,2").attr("stroke-width","2").attr("stroke","black").attr("fill","none").attr("class","target-pointer").style("display",function(a){return isNaN(a[1])?"none":"auto"});var r=i.append("div").style("text-align","left").style("position","relative");j.append("div").attr("class","gauge-value").style("color",G.color).style("font-family",G.fontName).style("font-size",G.fontSize).style("font-weight",G.bold?"bold":"normal").style("font-style",G.italic?"italic":"normal").text(function(a){return persian(d3.format(G.formatString)(a[0]),n)}).style("left","0").transition().duration(b.animationDuration).style("left",function(a){var b=$(this).outerWidth(),c=q(a[0])-5-b/2;return 0>c&&(c=0),c+b>ua&&(c=ua-b),c+"px"}).tween("text",function(a){var b=oa("0",a[0]);return function(a){this.textContent=b(a)}});var s=(r.filter(function(a){return!isNaN(a[1])}).append("div").attr("class","gauge-target").text(function(a){return persian(d3.format(G.formatString+"s")(a[1]),n)}).style("left",function(a){var b=$(this).outerWidth(),c=q(a[1])-5-b/2;return 0>c&&(c=0),c+b>ua&&(c=ua-b),c+"px"}).style("display",function(a){return isNaN(a[1])?"none":"auto"}),$(j[0][0]).find(".gauge-value").outerHeight()),t=$(r[0][0]).find(".gauge-target").outerHeight();j.style("height",s+"px"),$(j[0][0]).find(".gauge-value").css("height",s+"px"),$(j[0][0]).find(".gauge-value").css("position","absolute"),r.style("height",t+"px"),$(r[0][0]).find(".gauge-target").css("height",t+"px"),$(r[0][0]).find(".gauge-target").css("position","absolute")}function i(a,c,d,e,f){var g=d3.select(a).selectAll("nothings").data(function(a){return a.kpis}).enter().append("div").style({"margin-top":"5px",width:f+"px"}),h="small"==b.chartProp.info.height?"mini":"medium"==b.chartProp.info.height?"tiny":"large"==b.chartProp.info.height?"":"large";g.append("div").attr("class","ui statistic "+h).call(function(a){var c=_.reduce(app.chartCommons.indicator.getIndicator(H[d].series,o,b.chartProp.indicator),function(a,b){return a=a||[],a.push(b),a}),e=_.filter(c,{firstField:o[0]});a.append("div").classed("value",!0).append("span").attr("class","text").style({color:G.color,"font-family":G.fontName,"font-size":G.fontSize,"font-weight":G.bold?"bold":"normal","font-style":G.italic?"italic":"normal"}).text(function(a){return persian(d3.format(G.formatString)(a[0]),n)}),a.select(".value").append("i").attr("class",function(a){var b=_.filter(e,{operand:"2"}),c="";return b.length&&(c=b[b.length-1].secondFieldIcon),c}).style("color",function(a){var b=_.filter(e,{operand:"1"}),c=G.color;return b.length&&(c=b.pop().secondFieldColor),c}).style("font-size",G.fontSize)}).call(function(a){a.append("div").classed("label",!0).text(function(a,b){var d=p[b];return console.log(b,d),persian(c.label+(d?" - "+d:""),n)}).style("font-family",G.fontName)})}function j(a,c,d,e,f){var g=5;f-=48;var h=d3.select(a).selectAll("nothings").data(function(a){return a.kpis}).enter().append("div").style({"margin-left":"10px","margin-right":"10px",width:f+"px"}).append("div"),i="12";if(b.chartProp.info.showLabels){h.append("div").text(function(a,b){var d=p[b];return persian(c.label+(d?" - "+d:""),n)});var i="9"}var j=h.append("div").attr("class","col-md-"+i),k=j.append("div").style("text-align","left").style("position","relative");ua=$(j[0][0]).width();var l=j.append("svg").attr("width",ua).attr("height",v+2*g),m=[];l.forEach(function(a,b){var c=a[0].__data__;m.push(d3.scale.linear().range([0,ua]).domain([c[3],c[6]]))}),l.append("rect").attr("height",v).attr("y",g).attr("fill",ma).attr("width",ua),l.append("rect").attr("height",v).attr("y",g).attr("fill",la).attr("width",function(a,b){return m[b](a[5])}),l.append("rect").attr("height",v).attr("y",g).attr("fill",ka).attr("width",function(a,b){return m[b](a[4])}),l.append("path").attr("transform",function(a,b){var c=m[b](a[3]<a[6]?a[3]:a[6]);return"translate("+(c<m[b](a[3])?m[b](a[3]):c)+",0)"}).attr("d","M0 "+g+" 0 "+(v+2*g)).attr("stroke-dasharray","2,2").attr("stroke-width","1").attr("stroke","black").attr("fill","none").attr("class","none"),l.append("path").attr("transform",function(a,b){var c=m[b](a[6]<a[6]?a[6]:a[6]);return"translate("+(c<m[b](a[3])?m[b](a[3]):c)+",0)"}).attr("d","M0 "+g+" 0 "+(v+2*g)).attr("stroke-dasharray","2,2").attr("stroke-width","1").attr("stroke","black").attr("fill","none").attr("class","none"),l.append("path").attr("transform",function(a,b){var c=m[b](a[5]<a[6]?a[5]:a[6]);return"translate("+(c<m[b](a[3])?m[b](a[3]):c)+",0)"}).attr("d","M0 "+g+" 0 "+(v+2*g)).attr("stroke-dasharray","2,2").attr("stroke-width","1").attr("stroke","black").attr("fill","none").attr("class","none"),l.append("path").attr("transform",function(a,b){var c=m[b](a[4]<a[6]?a[4]:a[6]);return"translate("+(c<m[b](a[3])?m[b](a[3]):c)+",0)"}).attr("d","M0 "+g+" 0 "+(v+2*g)).attr("stroke-dasharray","2,2").attr("stroke-width","1").attr("stroke","black").attr("fill","none"),l.append("rect").attr("width","5").attr("x","0").attr("y","0").attr("height",v+g).attr("fill","#333").transition().duration(b.animationDuration).attr("x",function(a,b){var c=m[b](a[0]<a[6]?a[0]:a[6])-5;return c<m[b](a[3])?m[b](a[3]):c}),l.filter(function(a){return!isNaN(a[1])}).append("path").attr("transform",function(a,b){var c=m[b](a[1]<a[6]?a[1]:a[6])-5;return"translate("+(c<m[b](a[3])?m[b](a[3]):c)+",0)"}).attr("d","M0 "+g+" 0 "+(v+2*g)).attr("stroke-dasharray","2,2").attr("stroke-width","2").attr("stroke","black").attr("fill","none");var o=j.append("div").style("text-align","left").style("position","relative").style("margin-top","-10px");k.append("span").attr("class","gauge-value").style("color",G.color).style("font-family",G.fontName).style("font-size",G.fontSize).style("font-weight",G.bold?"bold":"normal").style("font-style",G.italic?"italic":"normal").text(function(a){return persian(d3.format(G.formatString)(a[0]),n)}).style("left","0").transition().duration(b.animationDuration).style("left",function(a,b){var c=$(this).outerWidth(),d=m[b](a[0])-5-c/2;return 0>d&&(d=0),d+c>ua&&(d=ua-c),d+"px"}).tween("text",function(a){var b=oa(a[3],a[0]);return function(a){this.textContent=b(a)}}),o.filter(function(a){return!isNaN(a[1])}).append("span").attr("class","gauge-target").text(function(a){return persian(d3.format(G.formatString+"s")(a[1]),n)}).style("left",function(a,b){var c=$(this).outerWidth(),d=m[b](a[1])-5-c/2;return 0>d&&(d=0),d+c>ua&&(d=ua-c),d+"px"}),o.append("span").attr("class","gauge-target").text(function(a){return persian(d3.format(G.formatString+"s")(a[3]),n)}).style("left",function(a,b){var c=$(this).outerWidth(),d=m[b](a[3])-c/2;return 0>d&&(d=0),d+c>ua&&(d=ua-c),d+"px"}),o.append("span").attr("class","gauge-target").text(function(a){return persian(d3.format(G.formatString+"s")(a[6]),n)}).style("left",function(a,b){var c=$(this).outerWidth(),d=m[b](a[6])-c/2;return 0>d&&(d=0),d+c>ua&&(d=ua-c),d+"px"}),o.append("span").attr("class","gauge-target").text(function(a){return persian(d3.format(G.formatString+"s")(a[4]),n)}).style("left",function(a,b){var c=$(this).outerWidth(),d=m[b](a[4])-c/2;return 0>d&&(d=0),d+c>ua&&(d=ua-c),d+"px"}),o.append("span").attr("class","gauge-target").text(function(a){return persian(d3.format(G.formatString+"s")(a[5]),n)}).style("left",function(a,b){var c=$(this).outerWidth(),d=m[b](a[5])-c/2;return 0>d&&(d=0),d+c>ua&&(d=ua-c),d+"px"});var q=$(k[0][0]).find(".gauge-value").outerHeight();k.style("height",q+"px"),$(k[0][0]).find(".gauge-value").css("height",q+"px"),$(k[0][0]).find(".gauge-value").css("position","absolute");var r=$(o[0][0]).find(".gauge-target").outerHeight();o.style("height",r+"px"),$(o[0][0]).find(".gauge-target").css("height",r+"px"),$(o[0][0]).find(".gauge-target").css("position","absolute")}function k(a,c,d,e,f){m(a,c,d,e,f,function(a,d,e,f,g,h,i,j,k,l,m,o){var r=0,s=0;if(ia>=0&&ha>=0)r=0,s=1.2*ha;else{var t=Math.max(Math.abs(ha),Math.abs(ia));r=-1.2*t,s=1.2*t}var u=d3.scale.linear().range([f,g]).domain([r,s]),w=d3.svg.arc().innerRadius(h).outerRadius(i).startAngle(f).endAngle(g),x=d3.svg.arc().innerRadius(h).outerRadius(i).startAngle(f).endAngle(function(a){return u(a)}),y=a.append("div").style("margin-bottom","0").append("svg").attr("width",2*h).attr("height",o).append("g").attr("transform","translate("+h+","+h+")");b.chartProp.info.showLabels&&a.append("div").style("margin-bottom","10px").text(function(a,b){var d=p[b];return persian(c.label+(d?" - "+d:""),n)});var z=y.append("path").attr("d",w).attr("transform","translate("+d+","+d+")").attr("fill",ja(0)),A=(z.node().getBBox().height,y.append("path").attr("fill",function(a,b){return na(a[2])}).attr("transform","translate("+d+","+d+")").transition().duration(b.animationDuration).attrTween("d",function(a){var b=d3.interpolate(r,a[0]);return function(a){return x(b(a))}}),y.append("g"));A.append("rect").attr("width","5").attr("transform","translate("+(d-2.5)+","+d+")").attr("height",h+e).attr("fill","#333"),A.attr("transform","rotate("+(f*(180/Math.PI)+180)+" "+d+" "+d+" )"),A.append("circle").attr("r","5").attr("cx",d).attr("cy",d),A.transition().duration(b.animationDuration).attrTween("transform",function(a){var b=u(a[0]),c=f*(180/Math.PI)+180;if(isNaN(b))e=c;else var e=u(a[0])*(180/Math.PI)+180;var g=d3.interpolate(c,e);return function(a){return"rotate("+g(a)+" "+d+" "+d+" )"}}),y.filter(function(a){return!isNaN(a[1])}).append("path").attr("d","M"+d+" "+d+" "+d+" "+(v+d+e)).attr("stroke-dasharray","2,2").attr("stroke-width","2").attr("stroke","black").attr("fill","none").attr("transform",function(a){return"rotate("+u(a[1])*(180/Math.PI)+" "+d+" "+d+")translate(0,"+(-h-e)+")"}),y.filter(function(a){return!isNaN(a[1])}).append("text").attr("class","gauge-target").attr("text-anchor","middle").attr("dy","-0.3em").text(function(a){return persian(d3.format(G.formatString)(a[1]),n)}).attr("transform",function(a){return"rotate("+u(a[1])*(180/Math.PI)+" "+d+" "+d+" )translate("+d+","+(-h+d-e)+")"});$(q+" svg > g").get(0).getBBox(),y.append("text").attr("class","gauge-value").attr("text-anchor","middle").style("fill",G.color).style("font-family",G.fontName).attr("dy","1em").style("font-size",G.fontSize).style("font-weight",G.bold?"bold":"normal").style("font-style",G.italic?"italic":"normal").text(function(a){return persian(d3.format(G.formatString)(a[0]),n)}).attr("transform","translate("+d+","+m+")").transition().duration(b.animationDuration).tween("text",function(a){var b=oa(a[3],a[0]);return function(a){this.textContent=b(a)}})})}function l(a,c,d,e,f){m(a,c,d,e,f,function(a,d,e,f,g,h,i,j,k,l,m,o){function q(a,b,c,d){w.append("path").attr("d",function(c,d){var e=c.map(function(a,b){return t[d](a)});return u({start:e[a],end:e[b]})}).attr("fill",c).attr("transform","translate("+d+","+d+")")}function r(a){w.append("path").attr("d","M"+d+" "+d+" "+d+" "+(v+e+d)).attr("stroke-dasharray","2,2").attr("stroke-width","2").attr("stroke","black").attr("fill","none").attr("transform",function(b,c){return"rotate("+a(b,c)+" "+d+" "+d+")translate(0,"+(-h-e)+")"})}function s(a,b){w.append("text").attr("class","gauge-target").attr("text-anchor","middle").attr("dy","-0.3em").text(function(a){return persian(d3.format(G.formatString)(a[b]),n)}).attr("transform",function(b,c){return"rotate("+t[c](a(b))*(180/Math.PI)+" "+d+" "+d+")translate("+d+","+(-h+d-e)+")"})}var t=[];a.forEach(function(a,b){var c=a[0].__data__;t.push(d3.scale.linear().range([f,g]).domain([c[3],c[6]]))});var u=(d3.svg.arc().innerRadius(h).outerRadius(i).startAngle(f).endAngle(g),d3.svg.arc().innerRadius(h).outerRadius(i).startAngle(function(a){return a.start}).endAngle(function(a){return a.end})),w=(d3.svg.arc().innerRadius(h).outerRadius(i).startAngle(f).endAngle(g),a.append("div").style("margin-bottom","0").append("svg").attr("width",2*h+2*d).attr("height",o).append("g").attr("transform","translate("+h+","+h+")"));b.chartProp.info.showLabels&&a.append("div").style("margin-bottom","10px").text(function(a,b){var d=p[b];return persian(c.label+(d?" - "+d:""),n)}),q(3,4,ka,d),q(4,5,la,d),q(5,6,ma,d);var x=w.append("g");x.append("rect").attr("width","5").attr("transform","translate("+(d-2.5)+","+d+")").attr("height",h+e).attr("fill","#333"),x.attr("transform","rotate("+(f*(180/Math.PI)+180)+" "+d+" "+d+")"),x.append("circle").attr("r","5").attr("cx",d).attr("cy",d),x.transition().duration(b.animationDuration).attrTween("transform",function(a,b){var c=t[b](a[0]<a[6]?a[0]:a[6]),e=f*(180/Math.PI)+180;if(isNaN(c))g=e;else var g=t[0](a[0]<a[6]?a[0]:a[6])*(180/Math.PI)+180;var b=d3.interpolate(e,g);return function(a){return"rotate("+b(a)+" "+d+" "+d+")"}}),e=0,r(function(a,b){return t[b](a[3])*(180/Math.PI)}),r(function(a,b){return t[b](a[6])*(180/Math.PI)}),r(function(a,b){return t[b](a[4])*(180/Math.PI)}),r(function(a,b){return t[b](a[5])*(180/Math.PI)}),s(function(a){return a[3]},3),s(function(a){return a[6]},6),s(function(a){return a[4]},4),s(function(a){return a[5]},5);w.append("text").attr("class","gauge-value").attr("text-anchor","middle").style("fill",G.color).style("font-family",G.fontName).attr("dy","1em").style("font-size",G.fontSize).style("font-weight",G.bold?"bold":"normal").style("font-style",G.italic?"italic":"normal").text(function(a){return persian(d3.format(G.formatString)(a[0]),n)}).attr("transform","translate("+d+","+m+")").transition().duration(b.animationDuration).tween("text",function(a){var b=oa(a[3],a[0]);return function(a){this.textContent=b(a)}});d3.select(w.node().parentNode).attr("height",o)})}function m(a,c,d,e,f,g){var h=d3.select(a).selectAll("nothings").data(function(a){return a.kpis}).enter().append("div").style("text-align","center"),i=0,j=10,k=0,l="small"==b.chartProp.info.chartSize?2*-Math.PI/5:"medium"==b.chartProp.info.chartSize?2*-Math.PI/4:2*-Math.PI/3,m=-1*l,o=Math.abs(Math.sin(l)),p=h.append("div").attr("class","gauge-value").style("color",G.color).style("font-family",G.fontName).style("font-size",G.fontSize).style("font-weight",G.bold?"bold":"normal").style("font-style",G.italic?"italic":"normal").text(function(a){return persian(d3.format(G.formatString)(a[0]),n)}),q=h.append("svg").append("text").attr("class","gauge-target").attr("text-anchor","middle").attr("dy","-0.3em").text(function(a){return persian(d3.format(G.formatString)("80"),n)}),r=$(p.node()).height(),s={width:$(p.node()).width(),height:$(p.node()).height()};p.remove();q.node().getBBox().height,q.node().getBBox();h.select("svg").remove();var t=b.chartProp.info.showLabels?45:0,u=Math.min(f,e)-r-t-2*k,w=u/2,x=w,y=x-v,z=2*w*o,A=2*y*o,B=(Math.abs(Math.cos(l))+Math.abs(Math.cos(m)))*w,C=(B>=s.width,Math.abs(Math.sin(l))*w-r),D=u;D=Math.max(D,u),g&&g(h,i,j,l,m,x,y,o,z,A,C,D)}b.input=a,app.chartCommons.calculateFields(a.series,b.calculatedFields);var n=(a.title,a.chartInfo,"undefined"==typeof a.lang?!0:0==+a.lang),o="undefined"!=typeof a.series?a.series.labels:[],p="undefined"!=typeof a.kpis?a.kpis.labels:[],q=(a.seriesLablesCaptions,
a.kpisLablesCaptions,b.LabelY,"#"+b.id),r={top:95,right:20,bottom:0,left:20},s=$(q).width(),t=$(q).hasClass("fromCommentDialog"),u="small"==b.chartProp.info.chartSize?220:"medium"==b.chartProp.info.chartSize?250:"large"==b.chartProp.info.chartSize?280:"veryLarge"==b.chartProp.info.chartSize?330:250,v="small"==b.chartProp.info.height?20:"medium"==b.chartProp.info.height?30:"large"==b.chartProp.info.height?40:"veryLarge"==b.chartProp.info.height?50:30,w=b.chartProp.info.openDashboard&&b.chartProp.info.openDashboard.checked;u+r.top+r.bottom,d3.scale.category10();b.width=s;var x=d.isProgress,y=d.showProgress,z=(d.title,e(b.chartProp.info.font,"formatString")||b.chartProp.info.formatString||",.2f"),A=e(b.chartProp.info.font,"formatStringCustom")||b.chartProp.info.formatString||",.2f",B=e(b.chartProp.info.font,"fontName")||"Droid",C=e(b.chartProp.info.font,"fontSize")||b.chartProp.info.fontSize||"46px",D=null!=e(b.chartProp.info.font,"italic")?e(b.chartProp.info.font,"italic"):b.chartProp.info.textItalic||!1,E=e(b.chartProp.info.font,"color")||b.chartProp.info.color||"#333333",F=null!=e(b.chartProp.info.font,"bold")?e(b.chartProp.info.font,"bold"):b.chartProp.info.textBold||!1,G={};if(G.formatString=z,G.formatStringCustom=A,G.fontName=B,G.fontSize=C,G.italic=D,G.color=E,G.bold=F,G.formatString="custom"!=G.formatString?G.formatString:G.formatStringCustom,app.chartCommons.setDefault(b.chartProp,p.concat(o),"gauge"),b.editMode&&$(q).trigger("chartproperty",[o.concat(p)]),!a.result)return void $("#"+b.id).append(app.chartCommons.getError(a));var H=prepareData(a);b.chartProp.info.segmentType=b.chartProp.info.segmentType||"singleSegment";var I="singleSegment"==b.chartProp.info.segmentType,J=b.chartProp.info.value,K=b.chartProp.info.target,L=b.chartProp.info.trend,M=b.chartProp.info.status,N=b.chartProp.info.min,O=b.chartProp.info.max,P=b.chartProp.info.yellow,Q=b.chartProp.info.green;""==K&&(K=void 0);var R=!isNaN(J||"nan"),S=!isNaN(K||"nan"),T=!isNaN(M||"nan"),U=!isNaN(L||"nan"),V=!isNaN(N||"nan"),W=!isNaN(O||"nan"),X=!isNaN(P||"nan"),Y=!isNaN(Q||"nan");$(q).css({overflow:"auto",margin:"0 -14px",padding:"0"}),_.isArray(a.levels)&&0!=a.levels.length||b.editMode||$(q).css({overflow:"hidden"});for(var Z=0;Z<H.length;Z++){var aa=H[Z],ba=[];ba=I?[+J,+K,+M,+L]:[+J,+K,+L,+N,+P,+Q,+O];for(var ca=!1,da=0;da<aa.series.length;da++){var ea=b.chartProp.series[o[da]],fa=-1;fa=I?"value"!=ea.type||R?"target"!=ea.type||S?"status"!=ea.type||T?"trend"!=ea.type||U?-1:3:2:1:0:"value"!=ea.typeMs||R?"target"!=ea.typeMs||S?"trend"!=ea.typeMs||U?"min"!=ea.typeMs||V?"yellow"!=ea.typeMs||X?"green"!=ea.typeMs||Y?"max"!=ea.typeMs||W?-1:6:5:4:3:2:1:0,-1!=fa&&(ba[fa]=aa.series[da]*+ea.numberFactor,ca=!0)}(ca||0==aa.kpis.length)&&aa.kpis.push(ba),I?(("undefined"==typeof ba[0]||isNaN(ba[0]))&&(ba[0]=0),("undefined"==typeof ba[2]||isNaN(ba[2]))&&(ba[2]=1),("undefined"==typeof ba[3]||isNaN(ba[3]))&&(ba[3]=1)):(("undefined"==typeof ba[0]||isNaN(ba[0]))&&(ba[0]=0),("undefined"==typeof ba[2]||isNaN(ba[2]))&&(ba[2]=1),("undefined"==typeof ba[3]||isNaN(ba[3]))&&(ba[3]=0),("undefined"==typeof ba[4]||isNaN(ba[4]))&&(ba[4]=ba[0]>0?.3*ba[0]:30),("undefined"==typeof ba[5]||isNaN(ba[5]))&&(ba[5]=ba[0]>0?.7*ba[0]:70),("undefined"==typeof ba[6]||isNaN(ba[6]))&&(ba[6]=ba[0]>0?1.2*ba[0]:100))}var ga=d3.select(q).append("div").attr("class","legend-bar temporal");if(ga.breadcrumb(a.levels,b,d,n),!a.matrix||0==a.matrix.length)return void d3.select(q).append("div").attr("class","temporal").style("font-size","0.8em").style("margin","15px").append("span").attr("class","translate").attr("data-trans-key","داده‌ای برای نمایش وجود ندارد").text("داده‌ای برای نمایش وجود ندارد");var ha=d3.max(H,function(a){return d3.max(a.kpis,function(a){return Math.max(f(a[0],!0),f(a[1],!0))})}),ia=d3.min(H,function(a){return d3.min(a.kpis,function(a){return Math.min(f(a[0],!1),f(a[1],!1))})}),ja=d3.scale.ordinal().domain([0,1,2]).range(["#eee","#ddd","#ccc"]),ka=b.chartProp.info.colorAriaOne||"#e14d57",la=b.chartProp.info.colorAriaTwo||"#FBEE58",ma=b.chartProp.info.colorAriaThree||"#71b37c",na=function(a){return a>0?ma:0==a?la:ka},oa=function(a,b){var c,d,e=/^([0-9,.-]+)$/,f=d3.format(G.formatString);return c=e.exec(a),d=e.exec(b),c&&d?(a=parseFloat(c[1]),b=parseFloat(d[1])-a,function(c){var d=a+b*c;return persian(f(d),n)}):function(b){return a}};2==app.dashboardLayoutVersion;var pa=$(q).width(),qa=$(q).height(),ra=H.length,sa=g(pa,qa,ra,b.chartProp.info.style),ta=d3.select(q).append("div").attr("class","temporal gauge-container").selectAll("nothings").data(H).enter().append("div").attr("class",function(a,b){return""!=a.onClickVal||w?"gauge-item temporal pointer":"gauge-item temporal"}).style("margin","14px").on("click",function(a,c){return t?void app.chartCommons.commentUtils.clickOnCommentIcon(a,b.ChartInPageId):""==a.onClickVal?void(w&&!b.editMode&&app.chartCommons.openLink(b.chartProp.info.openDashboard)):void(x()||(y(!0),b.drill="down",app.chartCommons.drillDown.add(b.ChartInPageId,b.input.DataSourceId,b.input.CurrentDimName,a.onClickVal),b.parameters={selectedItem:a.onClickVal,chartId:b.chartId,ChartInPageId:b.ChartInPageId},$(q).charts(chartTypes.GAUGE,"refreshWithData",b)))}),ua=s;_.isArray(a.levels)&&0!=a.levels.length||b.editMode||1!=ra||$(q).css({overflow:"hidden"}),ta.each(function(a,c){switch(b.chartProp.info.style){case"arc":I?k(this,a,c,sa.h,sa.w):l(this,a,c,sa.h,sa.w);break;case"horizontal":I?h(this,a,c,sa.h,sa.w):j(this,a,c,sa.h,sa.w);break;case"circle":I?k(this,a,c,sa.h,sa.w):l(this,a,c,sa.h,sa.w);break;case"semiCircle":I?k(this,a,c,sa.h,sa.w):l(this,a,c,sa.h,sa.w);break;case"verical":I?h(this,a,c,sa.h,sa.w):j(this,a,c,sa.h,sa.w);break;case"number":i(this,a,c,sa.h,sa.w)}})};var app=app||{};app.charts=app.charts||{},app.charts.map={},app.charts.map.draw=function(a,b,c,d){function e(c){function d(a,b){var c=I.indexOf(a.properties.Code);coordinates=d3.mouse(d3.select(m).select(".map-container").node());var d=coordinates[0]+7,e=coordinates[1]+7;d3.select(m+" #map-tooltip ").transition().duration(200).style("opacity",.9),d3.select(m+" #map-tooltip ").html(i(c,n,a.properties.Name)).style("left",d+"px").style("top",e+"px")}function e(){d3.select(m+" #map-tooltip ").transition().duration(500).style("opacity",0)}function k(a){if(o&&!b.editMode)return void app.chartCommons.openLink(b.chartProp.info.openDashboard);var c,d,e;if(a&&Q!==a){var f=E.centroid(a);c=f[0],d=f[1],e=4,Q=a}else c=B/2,d=A/2,e=1,Q=null;J.selectAll("path").classed("active",Q&&function(a){return a===Q}),J.transition().duration(750).attr("transform","translate("+B/2+","+A/2+")scale("+e+")translate("+-c+","+-d+")").style("stroke-width",1.5/e+"px")}var c=JSON.parse(c);$(m+" .temporal").remove();for(var l={},p=0,q=0;q<a.matrix.length;q++){var r=+a.series.data[q][0];l[a.matrix[q][1]]=r,p+=r}b.chartProp.info.colorStart=b.chartProp.info.colorStart||"#31a354",b.chartProp.info.colorEnd=b.chartProp.info.colorEnd||"#c7e9c0";var s=$.extend({formatString:",.0f",colorStart:"#31a354",colorEnd:"#c7e9c0"},b.chartProp.series[a.series.labels[0]]),t=d3.max(a.series.data,function(a){return+a[0]}),u=d3.min(a.series.data,function(a){return+a[0]}),v=d3.interpolate(b.chartProp.info.colorEnd,b.chartProp.info.colorStart),w="pointer";b.editMode||(w="");var x=d3.select(m).append("div").attr("class","legend temporal "+w).style({"text-align":"left",position:"absolute","background-color":"#fff","z-index":"2","border-radius":"4px"});b.chartProp.info.legendPosition=b.chartProp.info.legendPosition||"top left";var y={"top right":{top:0,right:0},"top left":{top:0,left:0},"top center":{top:0,right:"50%"},"bottom right":{bottom:0,right:0},"bottom left":{bottom:0,left:0},"bottom center":{bottom:0,right:"50%"},"center right":{top:"50%",right:0},"center left":{top:"50%",left:0}};if(x.style(y[b.chartProp.info.legendPosition]),g(m,b.chartProp.info.colorStart,b.chartProp.info.colorEnd,u,t,s,x),b.chartProp.info.showChart&&b.chartProp.info.showChartLegend){var z=_.map(a.series.labels,function(a,b){return{name:a,prop:h(b)}});x.legend({font:b.chartProp.info.legendFont,width:$(m).width(),selector:m,data:z.filter(function(a,b){return!a.prop.hidden}).map(function(a){return{label:(a.prop.name||a.name).replace(/^\[measure\]/,""),color:a.prop.color,key:a.name}})},j)}var A=$(m).height(),B=$(m).width();150>A&&(A=150);var C=topojson.feature(c,c.objects.map),D=d3.geo.mercator().scale(1).translate([0,0]),E=d3.geo.path().projection(D),F=E.bounds(C),G=.95/Math.max((F[1][0]-F[0][0])/B,(F[1][1]-F[0][1])/A),H=[(B-G*(F[1][0]+F[0][0]))/2,(A-G*(F[1][1]+F[0][1]))/2];D.scale(G).translate(H),E=E.projection(D);var I=a.matrix.map(function(a){return a[1]}),J=d3.select(m).append("div").style("overflow","hidden").style("position","relative").attr("class","map-container temporal").append("svg").attr("class","temporal").attr("width",B).attr("height",A).append("g");d3.select(m).append("div").attr("id","map-tooltip").attr("class","temporal"),J.selectAll("path").data(C.features).enter().append("path").attr("d",E).style("fill",function(c,d){var e=a.series.labels,g=a.series.labels.map(function(){return l[c.properties.Code]}),h=[];if(b.chartProp.indicator&&b.chartProp.indicator.forEach(function(a){var b=!0;$.each(a.ifRow,function(a,c){return f(c,g,e)?void 0:(b=!1,!1)}),b&&h.push(a.thenRow)}),h.length>0)return h[0][0].secondFieldColor;var i=l[c.properties.Code];return"undefined"==typeof i?"#eee":v((i-u)/(t-u))}).on("click",k).on("mousemove",d).on("mouseout",e),J.append("path").datum(topojson.mesh(c,c.objects.map,function(a,b){return!0})).attr("id","state-borders").attr("stroke",b.chartProp.info.borderColor||"#666").attr("d",E);var K=d3.scale.category10(),L=.05*A,M=5,N=8;if(_.each(a.series.labels,function(a,b){var c=h(b);c.color=c.color||K(b)}),b.chartProp.info.showChart&&"bar"==b.chartProp.info.chartType&&J.selectAll("g.bar").data(C.features).enter().append("g").classed("bar",!0).attr("transform",function(b){var c=I.indexOf(b.properties.Code),d=a.series.data[c];return b.childes=_.map(d,function(a,b){return{index:b,data:a}}),b.childes=_.filter(b.childes,function(a){return!h(a.index).hidden}),"translate("+(E.centroid(b)[0]-b.childes.length*M/2)+", "+E.centroid(b)[1]+")"}).on("click",k).on("mousemove",d).on("mouseout",e).selectAll("rect").data(function(a){return a.childes}).enter().append("rect").attr("width",M+"px").attr("fill",function(a,b){return h(a.index).color||K(b)}).attr("height",function(a){var b=a.data/t;return b*L+"px"}).attr("transform",function(a,b){var c=a.data/t;return"translate("+b*M+", -"+c*L+")"}),b.chartProp.info.showChart&&"pie"==b.chartProp.info.chartType){var O=d3.layout.pie().value(function(a){return a.data}),P=d3.max(a.series.data,function(a){return d3.max(a,function(a){return a})});J.selectAll("g.pie").data(C.features).enter().append("g").classed("pie",!0).attr("transform",function(b){var c=I.indexOf(b.properties.Code),d=a.series.data[c];b.childes=_.map(d,function(a,b){return{index:b,data:a}}),b.childes=_.filter(b.childes,function(a){return!h(a.index).hidden});var e=d3.max(b.childes,function(a){return a.data}),f=e/P*L*.65,g=d3.svg.arc().innerRadius(0).outerRadius(f);return _.each(b.childes,function(a){a.arc=g}),"translate("+(E.centroid(b)[0]-b.childes.length*M/2)+", "+E.centroid(b)[1]+")"}).on("click",k).on("mousemove",d).on("mouseout",e).selectAll("path").data(function(a){return O(a.childes)}).enter().append("path").attr("d",function(a){return a.data.arc(a)}).attr("fill",function(a,b){return h(a.data.index).color||K(b)})}b.chartProp.info.showName&&J.selectAll("text").data(C.features).enter().append("svg:text").text(function(a){return a.properties.Name}).attr("x",function(a){return E.centroid(a)[0]}).attr("y",function(a){return E.centroid(a)[1]+N}).attr("text-anchor","middle").attr("fill",b.chartProp.info.nameEditor.color||"#333").style("font-size",b.chartProp.info.nameEditor.fontSize||"9px").style("font-family",b.chartProp.info.nameEditor.fontName||"IRANSans").style("font-weight",b.chartProp.info.nameEditor.bold?"bold":"200").style("font-style",b.chartProp.info.nameEditor.italic?"italic":"inherit").on("click",k).on("mousemove",d).on("mouseout",e);var Q}function f(a,b,c){var d=c.indexOf(a.firstField),e=b[d],f=a.secondFieldIsText?a.secondFieldInput:b[c.indexOf(a.secondFieldSelect)];switch(e=depersian(e),f=depersian(f),isNaN(f)||(f=+f),isNaN(e)||(e=+e),+a.operand){case 1:return e==f;case 2:return e!=f;case 3:return e>f;case 4:return e>=f;case 5:return f>e;case 6:return f>=e;case 7:return e.indexOf(f)>-1;case 8:return e.indexOf(f)<=-1}}function g(c,d,e,f,g,h,i){if(!b.chartProp.info.showLegend)return d3.select(c).append("div");var k=h.name||a.series.labels[0],l=.05*$(c).width();return i.append("span").text(k).style("margin","0 7px"),i.append("span").text(persian(d3.format(h.formatString)(f||0),j)),i.append("div").style("background","-webkit-linear-gradient(to right, "+e+", "+d+")").style("background","-o-linear-gradient(to right, "+e+", "+d+")").style("background","-moz-linear-gradient(to right, "+e+", "+d+")").style("background","linear-gradient(to right, "+e+", "+d+")").style("display","inline-block").style("height","7px").style("width",l+"px").style("margin","0 7px"),i.append("span").text(persian(d3.format(h.formatString)(g||100),j)),i.on("click",function(){c&&$(c).trigger("legendClick",[k,0,{key:a.series.labels[0]}])}),i}function h(c){return b.chartProp.series[a.series.labels[c]]}function i(c,d,e){if(-1==c)return app.chartCommons.tooltip.tooltipFormatter({points:a.series.labels.map(function(b,c){return{data:"NaN",label:h(c).name||a.series.labels[c],format:h(c).formatString}}),key:e,sum:"NaN",avg:"NaN",format:",.2f"},b.chartProp.info.tooltipHeader,b.chartProp.info.tooltipFormat,j);var f=a.series.data[c];if(1==d)f=[f[0]];else if(2==d)var f=f.filter(function(a,b){return!h(b).hidden});return f=f.map(function(b,c){return{data:b,label:h(c).name||a.series.labels[c],format:h(c).formatString}}),app.chartCommons.tooltip.tooltipFormatter({points:f,key:e,sum:d3.sum(f,function(a){return a.data}),avg:d3.sum(f,function(a){return a.data})/f.length,format:f.length>0?f[0].format:",.2f"},b.chartProp.info.tooltipHeader,b.chartProp.info.tooltipFormat)}b.input=a,app.chartCommons.calculateFields(a.series,b.calculatedFields);var j=(a.title,a.chartInfo,"undefined"==typeof a.lang?!0:0==+a.lang),k="undefined"!=typeof a.series?a.series.labels:[],l="undefined"!=typeof a.kpis?a.kpis.labels:[],m="#"+b.id,n=+b.chartProp.info.tooltip||1,o=(d3.scale.category10(),d.isProgress,d.showProgress,d.title,b.chartProp.info.openDashboard&&b.chartProp.info.openDashboard.checked);if(app.chartCommons.setDefault(b.chartProp,l.concat(k),"map"),b.editMode&&$(m).trigger("chartproperty",[l.concat(k)]),!a.result)return void $("#"+b.id).append(app.chartCommons.getError(a));if(!a.matrix||0==a.matrix.length)return void d3.select(m).append("div").attr("class","temporal").style("font-size","0.8em").style("margin","15px").append("span").attr("class","translate").attr("data-trans-key","داده‌ای برای نمایش وجود ندارد").text("داده‌ای برای نمایش وجود ندارد");var p=b.chartProp.info.map.selectedMap;"undefined"!=typeof b.map&&p==b.map.id?e(b.map.data):(d3.select(m+"").append("div").style("padding","15px").attr("class","temporal info").text("در حال بارگذاری نقشه ..."),$.get(app.urlPrefix+"Moderation/Map/Get?Id="+p,null,function(a){a.result?(b.map=a.map,b.map.id=p,e(a.map.data)):d3.select(m+" .info").text("نقشه انتخاب شده معتبر نیست. در منوی تنظیمات یک نقشه را انتخاب کنید یا نقشه‌ی مورد نظر خود را بارگذاری نمایید.")}))};var app=app||{};app.charts=app.charts||{},app.charts.pie={},app.charts.pie.draw=function(a,b,c,d){function e(){var a=Math.min(o,B)/2,c=+b.chartProp.info.hole/100*a,d=d3.svg.arc().innerRadius(c).outerRadius(a),e=d3.svg.arc().innerRadius(1.1*a).outerRadius(1.1*a);return{radius:a,arc:d,arcText:e}}function f(a){return a.startAngle+(a.endAngle-a.startAngle)/2}function g(c,d){return U?void app.chartCommons.commentUtils.clickOnCommentIcon(c,b.ChartInPageId):(b.chartProp.globalvariable&&b.chartProp.globalvariable.length>0&&!b.editMode&&(app.globalVariableHelper.updateGlobalVariables([a.CurrentDimName],[c.data.value],b.chartProp.globalvariable),$(n+" path.selected-item").attr("class",$(this).attr("class").replace("selected-item","")),$(this).attr("class",$(this).attr("class")+" selected-item")),""==c.data.onClickVal?void(t&&!b.editMode&&app.chartCommons.openLink(b.chartProp.info.openDashboard)):void(r()||(s(!0),app.chartCommons.drillDown.add(b.ChartInPageId,b.input.DataSourceId,b.input.CurrentDimName,c.data.onClickVal),b.parameters={selectedItem:c.data.onClickVal,chartId:b.chartId,ChartInPageId:b.ChartInPageId,notEditMode:!b.editMode},$(n).charts(chartTypes.PIE,"refreshWithData",b))))}function h(a){var b=document.createElementNS("http://www.w3.org/2000/svg","g");b.setAttributeNS(null,"transform",a);var c,d,e,f=b.transform.baseVal.consolidate().matrix,g=f.a,h=f.b,i=f.c,j=f.d,k=f.e,l=f.f;return(c=Math.sqrt(g*g+h*h))&&(g/=c,h/=c),(e=g*i+h*j)&&(i-=g*e,j-=h*e),(d=Math.sqrt(i*i+j*j))&&(i/=d,j/=d,e/=d),h*i>g*j&&(g=-g,h=-h,e=-e,c=-c),{translateX:k,translateY:l,rotate:Math.atan2(h,g)*Math.PI/180,skewX:Math.atan(e)*Math.PI/180,scaleX:c,scaleY:d}}function i(a){var c=[0,0];c=d3.mouse(F.node());var d=c[0]+7,e=c[1]+7,f=(J.centroid(a),a.data.series),g=+b.chartProp.info.tooltip||1;1==g&&(f=[f[0]]),2==g&&(f=f.filter(function(a){return!a.prop.hidden})),f=f.map(function(a,c){return{data:a.data,label:a.prop.name||a.label,format:b.chartProp.info.formatString,color:a.prop.seriesColor,percentage:100*a.data/x[c]}});var h=app.chartCommons.tooltip.tooltipFormatter({points:f,key:a.data.label,sum:d3.sum(a,function(a){return a.data}),avg:d3.sum(a,function(a){return a.data})/a.length,format:a.length>0?a[0].format:",.2f"},b.chartProp.info.tooltipHeader,b.chartProp.info.tooltipFormat,q);W.html(h),W.style("opacity",1).style("left",d+"px").style("top",e+"px")}function j(a){W.transition().duration(500).style("opacity",1e-6).each("end",function(){W.style("left","0px").style("top","0px")})}b.input=a,app.chartCommons.calculateFields(a.series,b.calculatedFields);var k=(a.title,a.chartInfo,"undefined"!=typeof a.series?a.series.labels:[]),l="undefined"!=typeof a.kpis?a.kpis.labels:[],m=b.chartProp.info.showLabels,n=(b.LabelY,"#"+b.id),o=$(n).width(),p=($(n).height(),"small"==b.chartProp.info.chartSize?150:"medium"==b.chartProp.info.chartSize?200:"large"==b.chartProp.info.chartSize?250:"veryLarge"==b.chartProp.info.chartSize?400:130);b.width=o;var q="undefined"==typeof a.lang?!0:0==+a.lang,r=d.isProgress,s=d.showProgress,t=(d.title,b.chartProp.info.openDashboard&&b.chartProp.info.openDashboard.checked);if(app.chartCommons.setDefault(b.chartProp,l.concat(k),"pie"),b.editMode&&$(n).trigger("chartproperty",[l.concat(k)]),!a.result)return void $("#"+b.id).append(app.chartCommons.getError(a));$(n).addClass("pie-chart");var u=prepareData(a),v=a.seriesLablesCaptions,w=a.kpisLablesCaptions;d3Utils.prepareDataForBarChart(u,b,k,l,v,w);var x=0==u.length?[1]:u[0].series.map(function(a,b){return d3.sum(u.map(function(a){return a.series[b].data}))}),y=d3.scale.category10();switch(+b.chartProp.info.colorType){case 2:y=d3.scale.category20();break;case 3:y=d3.scale.category20b();break;case 4:y=d3.scale.category20c()}var z=function(a){var b=a.series.filter(function(a){return"series"==a.type&&a.prop.main});return b.length>0?b[0].data:a.series.filter(function(a){return"series"==a.type})[0].data},A=d3.select(n).append("div").attr("class","legend-bar temporal");A.breadcrumb(a.levels,b,d,q),m?A.append("div").attr("class","legendBar"):A.legend({width:o,selector:n,data:u.map(function(a,b){var c=a.series.filter(function(a){return"series"==a.type&&a.prop.main}),d=null;d=c.length>0?c[0]:a.series.filter(function(a){return"series"==a.type})[0];var e={label:a.label.replace(/^\[measure\]/,""),color:y(b)};return e})},q);var B=0;if(app.dashboardLayoutVersion=app.dashboardLayoutVersion||2,2==app.dashboardLayoutVersion){var C=$(n+" .title").outerHeight(),D=$(n+" .legend-bar"),E="undefined"==typeof D?0:D.height()+ +D.css("margin-top").replace("px","");B=$(n).height()-C-E}else 1==app.dashboardLayoutVersion&&(o=p,o>300&&(o=300));var F=d3.select(n).append("div").attr("class","temporal").style("position","relative"),G=F.append("svg").attr("class","temporal").attr("width",o).attr("height",B),H=e(),I=H.radius,J=H.arc,K=H.arcText;G.append("svg:rect").attr("class","background").style("fill","white").style("opacity","0").attr("width",o).attr("height",B).on("click",function(c,d){""!=a.levels&&(r()||(s(!0),b.parameters={isUp:!0,chartId:b.chartId,ChartInPageId:b.ChartInPageId,notEditMode:!b.editMode},app.chartCommons.drillDown.up(b.ChartInPageId),$(n).charts(chartTypes.PIE,"refreshWithData",b)))}).on("mouseout",j);var L=G.append("g").attr("transform","translate("+o/2+","+B/2+")"),M=d3.layout.pie().value(z).sort(null),N=L.datum(u).selectAll("path").data(M).enter();if(_.each(N[0],function(a){a.__data__.category=a.__data__.data.series[0].category,a.__data__.seriesLable=a.__data__.data.series[0].seriesLable,a.__data__.commentCount=a.__data__.data.series[0].commentCount}),m){var O,P=0,Q=0;L.append("g").attr("class","labels");var R=L.select(".labels").selectAll("text").data(M);R.enter().append("text").attr("class",function(a,b){return""!=a.data.onClickVal||S||t?"label pointer":" label"}).attr("id",function(a,b){return"l-"+b}).attr("dy",".35em").text(function(a,c){return b.chartProp.info.showValues?persian(a.data.label,q)+" "+persian(d3.format(",.2f")(100*a.value/x),q)+"%":a.data.label}).style({"font-size":"11px",direction:"rtl"}).on("click",g).on("mouseover",i).on("mousemove",i).each(function(a){var b=f(a)>=Math.PI?"left":"right",c=this.getBBox();O=c.height,"left"==b?P<c.width&&(P=c.width):Q<c.width&&(Q=c.width)}),o=o-Q-P-20,70>o&&(o=70),B-=2*O,H=e(),I=H.radius,J=H.arc,K=H.arcText}var S=b.chartProp.globalvariable&&b.chartProp.globalvariable.length>0&&!b.editMode&&b.chartProp.globalvariable.filter(function(b){return b.field==a.CurrentDimName}).length>0,T=N.append("g").classed("part",!0);T.append("path").attr("class",function(a,b){return""!=a.data.onClickVal||S||t?"arc pointer":" arc"}).attr("title","").attr("fill",function(a,b){return y(b)}).attr("d",J).each(function(a){this._current=a.data.series[0].data}).on("click",g).on("mouseover",i).on("mousemove",i);var U=$(n).hasClass("fromCommentDialog");if(app.chartCommons.commentUtils.addCommentIcon(b.ChartInPageId,T,function(a){return J.centroid(a)[0]},function(a){return J.centroid(a)[1]}),U&&app.chartCommons.commentUtils.setOnHighlightListener(T,b.ChartInPageId),m){R.attr("transform",function(a){var b=K.centroid(a);return b[0]=1.1*I*(f(a)<Math.PI?1:-1),"translate("+b+")"}).style("text-anchor",function(a){return f(a)>=Math.PI?"start":"end"}).style("display",function(a){var b=d3.select(this),c=(h(b.attr("transform")),"start"==b.style("text-anchor")?1:-1,this.getBBox(),"auto");return c}),L.append("g").attr("class","lines");var V=L.select(".lines").selectAll("polyline").data(M);V.enter().append("polyline"),V.attr("points",function(a,b){this._current=this._current||a;var c=d3.interpolate(this._current,a);this._current=c(0);var d=K.centroid(a);return d[0]=1*I*(f(a)<Math.PI?1:-1),[J.centroid(a),K.centroid(a),d]}).style("display",function(a,b){return $(n+" #l-"+b).css("display")})}var W=F.append("div").style("position","absolute").style("color","#fff").style("-moz-border-radius","5px").style("-webkit-border-radius","5px").style("border-radius","5px").style("padding","7px 15px").style("text-align","right").style("z-index","10").style("opacity","0").style("background-color","#000");$(n).trigger("heightChange")};var app=app||{};app.charts=app.charts||{},app.charts.radar={},app.charts.radar.draw=function(a,b,c,d){b.input=a,app.chartCommons.calculateFields(a.series,b.calculatedFields);var e=(a.title,a.chartInfo,"undefined"==typeof a.lang?!0:0==+a.lang),f="undefined"!=typeof a.series?a.series.labels:[],g="undefined"!=typeof a.kpis?a.kpis.labels:[],h="#"+b.id,i={top:10,right:20,bottom:0,left:20},j=("small"==b.chartProp.info.chartSize?180:"medium"==b.chartProp.info.chartSize?250:"large"==b.chartProp.info.chartSize?400:"veryLarge"==b.chartProp.info.chartSize?600:130,b.chartProp.info.openDashboard&&b.chartProp.info.openDashboard.checked),k=$(h).width(),l=$(h).height()-i.top-i.bottom;d3.scale.category10();b.width=k;var m=d.isProgress,n=d.showProgress;d.title;if($(h).addClass("radar-chart"),app.chartCommons.setDefault(b.chartProp,g.concat(f),"radar"),b.editMode&&$(h).trigger("chartproperty",[g.concat(f)]),!a.result)return void $("#"+b.id).append(app.chartCommons.getError(a));for(var o=prepareData(a),p=0;p<o.length;p++)for(var q=0;q<o[p].series.length;q++)b.chartProp.series[f[q]].cumulative&&(o[p].series[q]+=o[p-1]?o[p-1].series[q]:0);var r=d3.select(h).append("div").attr("class","legend-bar temporal");if(r.breadcrumb(a.levels,b,d,e),!a.matrix||0==a.matrix.length)return void d3.select(h).append("div").attr("class","temporal").style("font-size","0.8em").style("margin","15px").append("span").attr("class","translate").attr("data-trans-key","داده‌ای برای نمایش وجود ندارد").text("داده‌ای برای نمایش وجود ندارد");var s=a.seriesLablesCaptions,t=a.kpisLablesCaptions;d3Utils.prepareDataForBarChart(o,b,f,g,s,t),r.legend({width:k,selector:h,data:o[0].series.filter(function(a){return!a.prop.hidden}).map(function(a){return{label:(a.prop.name||a.label).replace(/^\[measure\]/,""),color:a.prop.seriesColor,key:a.key}})},e);var u=$(h+" .title").outerHeight(),v=$(h+" .legend-bar"),w="undefined"==typeof v?0:v.height()+ +v.css("margin-top").replace("px","");l=$(h).height()-u-w,150>l&&(l=150);var x=function(){var c={radius:4,w:600,h:600,factor:1,factorLegend:.85,levels:6,maxValue:0,radians:2*Math.PI,opacityArea:.5,ToRight:5,TranslateX:0,TranslateY:0,ExtraWidthX:0,ExtraWidthY:0,color:d3.scale.category10()},d=d3.select(h).append("div").attr("class","temporal").style("position","relative").style("margin","0 auto").style("text-align","left"),f=o.map(function(a,b){return a.label}),g=f.length,i=0,p=d.selectAll(".axis-label").data(f).enter().append("div").text(function(a){return persian(a,e)}).attr("class","axis-label").style("width","100px").style("font-size","11px").style("padding","5px").style("text-overflow","ellipsis").style("white-space","nowrap").style("text-align",function(a,b){return i=$(this).outerHeight(),"right"});p.remove(),c.h=Math.min(l-2*i,k-200),c.w=c.h,c.maxValue=Math.max(c.maxValue,d3.max(o,function(a){return d3.max(a.series.filter(function(a,b){return!a.prop.hidden}).map(function(a){return a.data}))}));var q=c.factor*Math.min(c.w/2,c.h/2);d3.format("%");d.style("height",c.h+2*i+"px"),d.style("width",c.w+200+"px");var r=d.append("svg"),s=d.selectAll(".axis-label").data(f).enter().append("div").text(function(a){return persian(a,e)}).attr("title",function(a){return a}).attr("class","axis-label").style("position","absolute").style("width","100px").style("font-size","11px").style("padding","5px").style("text-overflow","ellipsis").style("white-space","nowrap").style("overflow","hidden").style("text-align",function(a,b){var d=c.w/2*(1-c.factor*Math.sin(b*c.radians/g)),e="right";return d>=c.w/2&&(e="left"),e}),i=0;s.style("left",function(a,b){var d=c.w/2*(1-c.factor*Math.sin(b*c.radians/g));return d>=c.w/2&&(d+=100),d+"px"}).style("top",function(a,b){var d=$(d3.select(this).node()).outerHeight();i=d;var e=c.h/2*(1-c.factor*Math.cos(b*c.radians/g));return e+=d/2,0==b&&(e=0),e+"px"});for(var t,u=i,v=r.attr("width",c.w).attr("height",c.h).style("position","absolute").style("left","100px").style("top",u+"px").append("g").attr("transform","translate("+c.TranslateX+","+c.TranslateY+")"),w=0;w<c.levels-1;w++){var x=c.factor*q*((w+1)/c.levels);v.selectAll(".levels").data(f).enter().append("svg:line").attr("x1",function(a,b){return x*(1-c.factor*Math.sin(b*c.radians/g))}).attr("y1",function(a,b){return x*(1-c.factor*Math.cos(b*c.radians/g))}).attr("x2",function(a,b){return x*(1-c.factor*Math.sin((b+1)*c.radians/g))}).attr("y2",function(a,b){return x*(1-c.factor*Math.cos((b+1)*c.radians/g))}).attr("class","line").style("stroke","grey").style("stroke-opacity","0.75").style("stroke-width","0.3px").attr("transform","translate("+(c.w/2-x)+", "+(c.h/2-x)+")")}for(var w=0;w<c.levels;w++){var x=c.factor*q*((w+1)/c.levels);v.selectAll(".levels").data([1]).enter().append("svg:text").attr("x",function(a){return x*(1-c.factor*Math.sin(0))}).attr("y",function(a){return x*(1-c.factor*Math.cos(0))}).attr("class","legend").style("font-size","10px").attr("dy","1em").attr("transform","translate("+(c.w/2-x+c.ToRight)+", "+(c.h/2-x)+")").attr("fill","#737373").text(persian(d3.format(b.chartProp.info.formatString)((w+1)*c.maxValue/c.levels),e))}var y=v.selectAll(".axis").data(f).enter().append("g").attr("class","axis");y.append("line").attr("x1",c.w/2).attr("y1",c.h/2).attr("x2",function(a,b){return c.w/2*(1-c.factor*Math.sin(b*c.radians/g))}).attr("y2",function(a,b){return c.h/2*(1-c.factor*Math.cos(b*c.radians/g))}).attr("class","line").style("stroke","grey").style("stroke-width","1px"),series=0,o[0].series.forEach(function(a,b){a.prop.hidden||(dataValues=[],v.selectAll(".nodes").data(o,function(a,d){dataValues.push([c.w/2*(1-parseFloat(Math.max(a.series[b].data,0))/c.maxValue*c.factor*Math.sin(d*c.radians/g)),c.h/2*(1-parseFloat(Math.max(a.series[b].data,0))/c.maxValue*c.factor*Math.cos(d*c.radians/g))])}),dataValues.push(dataValues[0]),v.selectAll(".area").data([dataValues]).enter().append("polygon").attr("class","radar-chart-serie"+series).style("stroke-width","2px").style("stroke",o[0].series[b].prop.seriesColor).attr("points",function(a){for(var b="",d=0;d<a.length;d++)b=b+c.w/2+","+c.h/2+" ";return b}).style("fill",function(a,c){return o[0].series[b].prop.seriesColor}).style("fill-opacity",c.opacityArea).on("mouseover",function(a){z="polygon."+d3.select(this).attr("class"),v.selectAll("polygon").transition(200).style("fill-opacity",.1),v.selectAll(z).transition(200).style("fill-opacity",.7)}).on("mouseout",function(){v.selectAll("polygon").transition(200).style("fill-opacity",c.opacityArea)}).transition(500).attr("points",function(a){for(var b="",c=0;c<a.length;c++)b=b+a[c][0]+","+a[c][1]+" ";return b}),series++)}),series=0;var A=b.chartProp.globalvariable&&b.chartProp.globalvariable.length>0&&!b.editMode&&b.chartProp.globalvariable.filter(function(b){return b.field==a.CurrentDimName}).length>0;_.each(o,function(a){});var B=o[0].series.map(function(a,b){return o.map(function(a){var c=a.series[b];return c.onClickVal=a.onClickVal,c})}),C=v.selectAll(".entry-group").data(B).enter().append("g").classed("entry-group",!0),D=C.selectAll(".entry-group").data(function(a){return a}).enter().append("g").classed("entry",!0),E=$(h).hasClass("fromCommentDialog");D.append("svg:circle").attr("class",function(a,b){return"radar-chart-serie"+b+" "+(""!=a.onClickVal||A||j?" pointer":"")}).classed("circle",!0).attr("r",c.radius).attr("alt",function(a){return d3.format(b.chartProp.info.formatString)(a.data)}).attr("cx",function(a,b){return c.w/2}).attr("cy",function(a,b){return c.h/2}).attr("data-id",function(a){return a.axis}).style("fill","#fff").style("stroke",function(a){return a.prop.seriesColor}).style("stroke-width","2px").on("click",function(c,d){return E?void app.chartCommons.commentUtils.clickOnCommentIcon(c,b.ChartInPageId):(b.chartProp.globalvariable&&b.chartProp.globalvariable.length>0&&!b.editMode&&(app.globalVariableHelper.updateGlobalVariables([a.CurrentDimName],[c.value],b.chartProp.globalvariable),$(h+" circle.selected-item").attr("class",$(this).attr("class").replace("selected-item","")),$(this).attr("class",$(this).attr("class")+" selected-item")),""==c.onClickVal?void(j&&!b.editMode&&app.chartCommons.openLink(b.chartProp.info.openDashboard)):void(m()||(n(!0),b.parameters={selectedItem:c.onClickVal,chartId:b.chartId,ChartInPageId:b.ChartInPageId,notEditMode:!b.editMode},app.chartCommons.drillDown.add(b.ChartInPageId,b.input.DataSourceId,b.input.CurrentDimName,c.onClickVal),$(h).charts(chartTypes.Radar,"refreshWithData",b))));
}).on("mouseover",function(a){newX=parseFloat(d3.select(this).attr("cx")),newY=parseFloat(d3.select(this).attr("cy")),t.style("left",newX+105+"px").style("top",newY-5+"px").html(a.label+"<br/><b>"+a.label+": </b>"+persian(d3.format(b.chartProp.info.formatString)(a.data),e)).transition(200).style("opacity",1);var c=($(t[0][0]).width(),$(t[0][0]).height());t.style("top",newY+c/2+"px"),z="polygon."+d3.select(this).attr("class"),v.selectAll("polygon").transition(200).style("fill-opacity",.1),v.selectAll(z).transition(200).style("fill-opacity",.7)}).on("mouseout",function(){t.transition(200).style("opacity",0).each("end",function(){t.style("left",0).style("top",0)}),v.selectAll("polygon").transition(200).style("fill-opacity",c.opacityArea)}).transition(500).attr("cx",function(a,b){return c.w/2*(1-Math.max(a.data,0)/c.maxValue*c.factor*Math.sin(b*c.radians/g))}).attr("cy",function(a,b){return c.h/2*(1-Math.max(a.data,0)/c.maxValue*c.factor*Math.cos(b*c.radians/g))}),app.chartCommons.commentUtils.addCommentIcon(b.ChartInPageId,D,function(a,b){return c.w/2*(1-Math.max(a.data,0)/c.maxValue*c.factor*Math.sin(b*c.radians/g))-5},function(a,b){return c.h/2*(1-Math.max(a.data,0)/c.maxValue*c.factor*Math.cos(b*c.radians/g))-24}),E&&app.chartCommons.commentUtils.setOnHighlightListener(D,b.ChartInPageId),t=d.append("div").attr("class","tooltip").style("position","absolute").style("color","#fff").style("-moz-border-radius","5px").style("-webkit-border-radius","5px").style("border-radius","5px").style("padding","7px 15px").style("text-align","right").style("z-index","1000").style("opacity","0").style("background-color","#000").style("max-width","200px").style("opacity",0).style("font-size","13px")};x(),$(h).trigger("heightChange")};var app=app||{};app.charts=app.charts||{},app.charts.table={},app.charts.table.draw=function(a,b,c,d){function e(a){var c={numberFactor:"1",textAlign:"right",formatString:",.2f",fontSize:"1em",textItalic:!1,textBold:!1,color:"#000000",rowResult:"0",isHidden:!1};try{return b.chartProp.series[a]||b.chartProp.series["default"]||c}catch(d){return c}}function f(){for(var a=[],b=$(j+" table thead th input"),c=0;c<b.length;c++){if(value=$(j+" #filterbox-"+c+" input").val(),type=$(j+" #filterbox-"+c+" select").val()||1,null==type)return;"undefined"!=typeof value&&null!=value&&""!=value&&($(j+" #filterbox-"+c+" .glyphicon-filter").addClass("show"),d3.select(j+" #filterbox-"+c+" select").on("click",function(a){d3.event.stopPropagation()}),d3.select(j+" #filterbox-"+c+" input").on("click",function(a){d3.event.stopPropagation()}),$(j+" #filterbox-"+c+" input").mousedown(function(a){3==a.which&&(a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation())})),a.push({value:value,type:type})}return $(j).data("filterbox",a),a}function g(){var a=f();"undefined"!=typeof K&&K.style("display",function(b){"undefined"!=typeof b.label&&(b=[b.label].concat(b.series));var c=i(b,a);return c?null:"none"}),b.editMode&&$(j).trigger("tableInfo",[{TableInfo:s}])}function h(a,b){if("undefined"!=typeof a){for(var c=!1,d=0;d<a.length;d++)"undefined"!=typeof a[d].value&&""!=a[d].value&&(c=!0),$(j+" #filterbox-"+d+" input").val(a[d].value),_.isEmpty(a[d].value)||$(j+" #filterbox-"+d+" .table-filter-icon").addClass("fill"),$(j+" #filterbox-"+d+" select").val(a[d].type);c&&!b&&g()}}function i(a,b){for(var c=!0,d=0;d<b.length;d++)if(parameter=b[d].value,parameter=depersian(parameter),parameter=RegExp(/^[\d,\s]+$/).test(parameter)?+parameter.replace(/,/g,""):parameter,type=b[d].type,"undefined"!=typeof parameter&&""!=parameter)switch(+type){case 1:a[d];c=c&&-1!=a[d].indexOf(parameter);break;case 6:a[d];c=c&&-1==a[d].indexOf(parameter);break;case 2:c=c&&(parseFloat(a[d])||0)==parameter;break;case 3:c=c&&(parseFloat(a[d])||0)>parameter;break;case 4:c=c&&(parseFloat(a[d])||0)<parameter;break;case 5:var e=parameter.split(",");"undefined"!=e&&(c=c&&(parseFloat(a[d])||0)>e[0]&&(parseFloat(a[d])||0)<e[1])}return c}var j="#"+b.id,k={top:10,right:20,bottom:0,left:20},l=$(j).width(),m="small"==b.chartProp.info.chartSize?170:"medium"==b.chartProp.info.chartSize?300:"large"==b.chartProp.info.chartSize?400:"veryLarge"==b.chartProp.info.chartSize?500:250;m+k.top+k.bottom;b.width=l;var n=d.isProgress,o=d.showProgress,p=(d.title,"undefined"==typeof a.lang?!0:0==+a.lang),q=b.chartProp.info.openDashboard&&b.chartProp.info.openDashboard.checked,r=$(j).data("table-info"),s=r||b.tableInfo||{};$(j).data("table-info",s);"undefined"!=typeof b.chartProp.info.showHeader?b.chartProp.info.showHeader:!0;if($(j).addClass("table-chart-container table-chart"),$(j).parents(".content").addClass("hidden-overflow"),b.editMode&&$(j).addClass("edit-mode"),2==app.dashboardLayoutVersion&&!b.editMode){var t=$(j+" .title").outerHeight(),u=$(j).height()-t;m=u}"undefined"==typeof b.chartProp.info.stripped&&(b.chartProp.info.stripped=!0),"undefined"==typeof b.chartProp.info.hover&&(b.chartProp.info.hover=!0);var v=((b.chartProp.info.bordered?" table-bordered":"")+(b.chartProp.info.stripped?" table-striped":"")+(b.chartProp.info.hover?" table-hover":"")+" ",{option:{},headerTemplate:function(a){this.filteredHeaders=_.filter(a,function(a){return!a.prop.isHidden});var b=_.map(this.filteredHeaders,function(a,b){var c=a.prop.name||a.key;v.option.page=v.option.page||{};var d=_.find(v.option.page.Order,{Index:b}),e="";return d&&(e='<i class="icon sort '+(1==d.DescType?"ascending":"descending")+'"></i>'),'<th title="'+c+'"><span class="resize"></span>'+c+e+"</th>"}).join("");return"<tr>"+b+"</tr>"},getFooterTemplate:function(){if(!_.some(v.option.resultRows,function(a){return+a.Type>0}))return"";var a=_.map(_.filter(v.option.tableData.headers,function(a,b){return!a.prop.isHidden}),function(a){var b=_.find(v.option.resultRows,{Name:a.key});if(!b||0==+b.Type)return"<td></td>";var c={data:b.Value},d=_.findIndex(v.option.tableData.headers,{key:a.key}),e=v.getStyle(c,d);return'<td style="'+e+'" title="'+v.getText(c,d)+'">'+v.getText(c,d)+"</td>"}).join(""),b='  <table class="ui celled table unstackable small  footer-table" style="margin:0;border-left: none;border-right: none;">                                                      <tbody>                                                <tr>'+a+"</tr>    </tbody>                                                 </table>                                                 ";return b},svg:'<svg  class="td-comment" width="24" height="24" style="position: absolute; left: 6px; fill-opacity: 0.5;"><g transform="translate(0,0)scale(0.38)" class="comment"><rect width="24" height="24" class="comment-background"></rect><path d="M10.718,18.561l6.78,5.311C17.609,23.957,17.677,24,17.743,24  c0.188,0,0.244-0.127,0.244-0.338v-5.023c0-0.355,0.233-0.637,0.548-0.637L21,18c2.219,0,3-1.094,3-2s0-13,0-14s-0.748-2-3.014-2  H2.989C0.802,0,0,0.969,0,2s0,13.031,0,14s0.828,2,3,2h6C9,18,10.255,18.035,10.718,18.561z"></path><text x="34" y="0.7em" style="font-size: 20px;"></text></g></svg>',svgShow:'<svg  class="" width="24" height="24" style="position: absolute; left: 6px; fill-opacity: 0.5;"><g transform="translate(0,0)scale(0.38)" class="comment show"><rect width="24" height="24" class="comment-background"></rect><path d="M10.718,18.561l6.78,5.311C17.609,23.957,17.677,24,17.743,24  c0.188,0,0.244-0.127,0.244-0.338v-5.023c0-0.355,0.233-0.637,0.548-0.637L21,18c2.219,0,3-1.094,3-2s0-13,0-14s-0.748-2-3.014-2  H2.989C0.802,0,0,0.969,0,2s0,13.031,0,14s0.828,2,3,2h6C9,18,10.255,18.035,10.718,18.561z"></path><text x="34" y="0.7em" style="font-size: 20px;"></text></g></svg>',bodyTemplate:function(a){var c="";if(this.option.remoteData){var d=this.option.page.Page;c=this.paging(d)}var e='<div class="clusterize temporal" style="overflow: hidden;">                                     <table class="ui celled table unstackable small  header-table" style="margin-bottom:0;border-left: none;border-right: none;">                                                      <thead>                                                '+v.headerTemplate(a.headers)+'    </thead>                                                 </table>                                                   <div id="scrollArea'+b.id+'" class="clusterize-scroll" style="xdisplay: flex;max-height:200px; overflow:auto;">              <table class="ui celled table unstackable  small body-table" style="margin:0;border: none; border-bottom: 1px solid #eaeaea;">                                                      <tbody id="contentArea'+b.id+'" class="clusterize-content">          <tr class="clusterize-no-data">                              <td>Loading data…</td>                                   </tr>                                                    </tbody>                                                 </table>                                               '+v.svg+"  </div>                                                   "+v.getFooterTemplate(a.headers)+c+"</div>                                                     ";return e},getStyle:function(a,b){var c=["font-weight:"+(v.option.tableData.headers[b].prop.textBold?"bold":"normal"),"italic","font-size:"+v.option.tableData.headers[b].prop.fontSize,"text-align:"+v.option.tableData.headers[b].prop.textAlign,"color:"+v.option.tableData.headers[b].prop.color,"position:relative","display:"+(v.option.tableData.headers[b].prop.isHidden?"none":"auto")];return c.join(";")},getThenStyle:function(a){var b=[];a&&_.each(a,function(a){switch(+a.operand){case 1:b.push("color:"+a.secondFieldColor);break;case 3:b.push("background-color:"+a.secondFieldBackColor);break;case 4:var c=+a.secondFieldStyle;1==c&&(b.push("font-weight: normal"),b.push("font-style: normal")),2!=c&&4!=c||b.push("font-weight: bold"),3!=c&&4!=c||b.push("font-style: italic"),5==c&&b.push("text-decoration: underline")}});var c=_.head(_.filter(a,{operand:"2"}));c&&(c='<i class="icon '+c.secondFieldIcon+'"></i>');var d=_.head(_.filter(a,{operand:"5"}));return d&&(d=d.secondFieldReplace),{style:b.join(";"),icon:c,replace:d}},getText:function(a,b){var c=a.data,d=isNaN(c);return d?persian(c,p):persian(d3.format(v.option.tableData.headers[b].prop.formatString)(c),p)},render:function(b){function c(){var b=$(this).data("xrow"),c=$(this).data("xcol");if(v.option.pivoteMode){var d=g.rows[b][0];if(h)return;if(f.chartProp.globalvariable&&f.chartProp.globalvariable.length>0&&!f.editMode){var i=a.series.labels.concat([a.CurrentDimName]),j=d.series.concat(d.label);app.globalVariableHelper.updateGlobalVariables(i,j,f.chartProp.globalvariable),$(e+" .selected-item").removeClass("selected-item"),$(this).addClass("selected-item")}if(""==d.onClickVal)return void(q&&!f.editMode&&app.chartCommons.openLink(f.chartProp.info.openDashboard));if(n())return;o(!0),f.parameters={selectedItem:d.onClickVal,chartId:f.chartId,ChartInPageId:f.ChartInPageId,notEditMode:!f.editMode},app.chartCommons.drillDown.add(f.ChartInPageId,f.input.DataSourceId,f.input.CurrentDimName,d.onClickVal),$(e).charts(chartTypes.TABLE,"refreshWithData",f)}v.option.pivoteMode||v.onTdClick(b,c,$(this))}function d(){var a=$(w).scrollLeft();$(e+" .header-table").css("-ms-transform","translate3d("+(-x+a)+"px,0px,0px)"),$(e+" .footer-table").css("-ms-transform","translate3d("+(-x+a)+"px,0px,0px)"),$(e+" .header-table").css("-webkit-transform","translate3d("+(x-a)+"px,0px,0px)"),$(e+" .footer-table").css("-webkit-transform","translate3d("+(x-a)+"px,0px,0px)"),$(e+" .header-table").css("-moz-transform","translate3d("+-a+"px,0px,0px)"),$(e+" .footer-table").css("-moz-transform","translate3d("+-a+"px,0px,0px)")}v.option=b;var e=b.selector,f=b.settings,g=b.tableData,h=(b.resultRows,$(e).hasClass("fromCommentDialog"));$(e).append(v.bodyTemplate(g));var i=_.map(g.headers,"key");v.dataset=g.rows.map(function(a,b){var c=_.reduce(app.chartCommons.indicator.getIndicator(_.map(a,"data"),i,f.chartProp.indicator),function(a,b){return a=a||[],a.push(b),a}),d=[],e=a.map(function(a,e){var h=_.filter(c,{firstField:v.option.tableData.headers[e].key}),i=v.getStyle(a,e),j=v.getThenStyle(h);v.option.tableData.headers[e].prop.isHidden||d.push(a.data);if(v.option.pivoteMode){var k=g.rows[b][0];onClickVal=k.onClickVal}var l="";("none"!=f.chartProp.info.selectable||""!=onClickVal||q||_.size(f.chartProp.globalvariable)>0)&&(l="pointer");var m="";return a.commentCount>0&&(m=v.svgShow.replace("</text>",persian(a.commentCount,p)+"</text>")),'<td class="entry '+l+'" data-xrow="'+b+'" data-xcol="'+e+'" style="'+i+";"+j.style+'">'+(j.replace||v.getText(a,e))+(j.icon||"")+m+"</td>"}).filter(function(a,b){return!v.option.tableData.headers[b].prop.isHidden});return{markup:"<tr>"+e.join("")+"</tr>",row:d}});var j=($("#scrollArea"+f.id),$("#contentArea"+f.id)),k=$(e+" .header-table"),l=function(){var a=[],b=!0;return function(){var c=j.find("tr:not(.clusterize-extra-row):first"),d=c.children(),f=$(e+" .footer-table tr:first-child td"),g=0,h=$(e+" .body-table").height(),i=$(e).height()-$(e+" .legend-bar").height()-$(e+" .header-table").height()-$(e+" .footer-table").height()-$(e+" .ui.pagination").height()-4;g=h>i?7:0;var l=$(e).data("columnsWidth");l&&(a=l,a[a.length-1]-=g),0==_.size(a)&&(d=k.find("tr").children(),c.children().each(function(b){var c=$(this).outerWidth(),e=$(d.get(b)).outerWidth();60>c&&e>c&&(c=60),a.push(c)})),k.find("tr").children().each(function(b){var c=0;d.length-1==b&&(c=g),$(this).css({width:a[b]+c+"px","max-width":a[b]+c+"px","min-width":a[b]+c+"px"})}),d.each(function(b){var c=0;d.length-1==b&&(c=g),$(f.get(b)).css({width:a[b]+c+"px","max-width":a[b]+c+"px","min-width":a[b]+c+"px"}),j.find("tr:not(.clusterize-extra-row)").each(function(){$(this).children().each(function(b){$(this).css({width:a[b]+"px","max-width":a[b]+"px","min-width":a[b]+"px"})})})}),b=!1}}(),m=v.dataset;if(!v.option.remoteData&&v.option.page&&v.option.page&&v.option.page.Order&&v.option.page.Order.length>0)for(var r=0;r<v.option.page.Order.length;r++){var s=v.option.page.Order[r];m=_.orderBy(m,function(a){return a.row[r]},1==s.DescType?"asc":"desc")}var t;v.clusterize=new Clusterize({rows:m.map(function(a){return a.markup}),rows_in_block:9,scrollId:"scrollArea"+f.id,contentId:"contentArea"+f.id,callbacks:{clusterChanged:function(){if(l(),v.option.remoteData||j.find("tr:not(.clusterize-extra-row) td").on("mouseover",function(a,b){$(this).append(t)}),j.find("tr:not(.clusterize-extra-row) td").on("click",c),h){var a=j.find("tr:not(.clusterize-extra-row) td");$(a[0]).data("table-data",v.option.tableData),app.chartCommons.commentUtils.setOnHighlightListener(j.find("tr:not(.clusterize-extra-row) td"),f.ChartInPageId)}}}}),t=$(e+" .td-comment"),t.on("click",function(a){var b=$(this).parent().data("xrow"),c=$(this).parent().data("xcol"),d=v.option.tableData.rows[b][c];return app.chartCommons.commentUtils.clickOnCommentIcon(d,f.ChartInPageId),a.preventDefault(),!1});var u=$(e).height()-$(e+" .legend-bar").height()-$(e+" .header-table").height()-$(e+" .footer-table").height()-$(e+" .ui.pagination").height()-4;$(e+" .clusterize-scroll").css({"max-height":u+"px","min-height":u+"px"});var w="#scrollArea"+f.id,x=$(w).scrollLeft();$(function(){var a,b,c=!1,d=void 0;$(e+" .header-table th .resize").on("click",function(a){return a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation(),!1}),$(e+" .header-table th .resize").mousedown(function(e){d=$(this).parent(),c=!0,a=e.pageX,b=$(this).parent().outerWidth(),$(d).addClass("resizing")}),$(document).mousemove(function(e){c&&$(d).css({width:b+(a-e.pageX)+"px","max-width":b+(a-e.pageX)+"px","min-width":b+(a-e.pageX)+"px"})}),$(document).mouseup(function(a){if(c){$(d).removeClass("resizing"),c=!1;var b=[];$(e+" .header-table th").each(function(){b.push($(this).outerWidth())}),$(e).data("columnsWidth",b),l(),x=$(w).scrollLeft()}})}),$(w).on("scroll",d),d(),$(e+" .ui.pagination a").on("click",function(){var a=$(this).attr("value");v.gotoPage(parseInt(a))}),$(e+" .header-table th").on("click",function(a,b){var c=+$(this).index();v.option.page=v.option.page||{},v.option.page.Order=v.option.page.Order||[];var d=_.find(v.option.page.Order,{Index:c});d||(d={Index:c,DescType:2}),_.remove(v.option.page.Order,d),v.option.page.Order.push(d),d.DescType=1==d.DescType?2:1,$(this).find(".icon").remove(),$(this).append('<i class="icon sort '+(1==d.DescType?"ascending":"descending")+'"></i>'),v.option.remoteData||v.clusterize.update(_.map(_.orderBy(v.dataset,function(a){return a.row[c]},1==d.DescType?"asc":"desc"),"markup")),v.option.remoteData&&v.sortRemote(c),f.editMode&&(console.log("#### trigger",[{TableInfo:v.option.page}]),$(e).trigger("tableInfo",[{TableInfo:v.option.page}]))})},sortRemote:function(a){n()||(o(!0),$.extend(b.parameters,{TableInfo:v.option.page,notEditMode:!b.editMode}),$(j).charts(chartTypes.TABLE,"refreshWithData",b,{refreshRelatedDatasources:!1}))},paging:function(a){var b=Math.ceil(v.option.totalRows/v.option.page.Limit),c=5;if(1!=b){c>b&&(c=b);for(var d=a-Math.ceil(c/2)>0,e=a+Math.ceil(c/2)<b,f=d?e?a-Math.ceil(c/2)+1:b-c+1:1,g="",h=0;c>h;h++)g+="<a  "+(f+h==a?'class="active item"':'class="item"')+' value="'+(f+h)+'">'+persian(f+h,p)+"</a>";var i="";return""!=g&&(i='<div  class="ui borderless pagination menu attached  " style="">                                <a  '+(d?'class="item"':'class="disabled item"')+' value="1" style="border-right:1px solid #d4d4d5; border-radius:0;">&laquo;</a>                                '+g+"                                <a  "+(e?'class="item"':'class="disabled item"')+' value="'+b+'">&raquo;</a>                                <div class="item" style="font-size: 0.8em;color: #9E9E9E;"> تعداد کل ردیف‌ها: '+persian(this.option.totalRows,p)+"</div>                            </div>"),i}},gotoPage:function(a){n()||(o(!0),s.Page=a,s.IsPageValid=!0,$.extend(b.parameters,{TableInfo:s,notEditMode:!b.editMode}),$(j).charts(chartTypes.TABLE,"refreshWithData",b,{refreshRelatedDatasources:!1}),b.parameters.TableInfo.IsPageValid=!1)},onTdClick:function(c,d,e){if("undefined"==typeof b.chartProp.info.selectable&&(b.chartProp.info.selectable="multi"),"none"!=b.chartProp.info.selectable){if("edit"==b.chartProp.info.selectable)return void $("body").trigger("open-form",[a.form,a.formIds[c],j]);var f=e.hasClass("selected-item"),g=d+1+(b.chartProp.info.showRowNumber?1:0);if(b.chartProp.info.rowAsKey&&b.chartProp.info.rowKey){var h=_.findIndex(this.filteredHeaders,{key:b.chartProp.info.rowKey});if(-1==h)return;"one"==b.chartProp.info.selectable&&$(j+" .selected-item").removeClass("selected-item"),f?e.parents("tr").find("td").removeClass("selected-item"):e.parents("tr").find("td").addClass("selected-item")}else"one"==b.chartProp.info.selectable&&$(j+" td:nth-child("+g+").selected-item").removeClass("selected-item"),f?e.removeClass("selected-item"):e.addClass("selected-item");if(!b.editMode){var i=$(j+" td.selected-item").map(function(){var a=+$(this).data("xrow"),b=+$(this).data("xcol");return b!=d?null:v.option.tableData.rows[a][b].data}).filter(function(a){return null!=a}).toArray(),k=this.filteredHeaders[d].key,l={Id:-1,Values:i,VariableType:0,dimensionName:k,datasourceId:a.DataSourceId,chartInPageId:b.ChartInPageId,chartId:a.chartId};app.moderation.dashboadpage.selectValueOnChart(l,a.RefreshDatasource)}}}});if(+a.isPivot>-1){b.input=a,app.chartCommons.calculateFields(a.series,b.calculatedFields);var w=a.chartInfo,x="undefined"!=typeof a.series?a.series.labels:[],y="undefined"!=typeof a.kpis?a.kpis.labels:[],z=d3Utils.convertToKeyValue(a);z.seriesLabels=z.seriesLabels.map(function(a){return a.prop=e(a.key),a});var A=z.seriesLabels.map(function(a){return a.key});z.seriesLabels.map(function(a){return a.value}),b.LabelY,d3.scale.category10();if(app.chartCommons.setDefault(b.chartProp,A.concat(w.hierarchyLabels),"table"),b.editMode&&$(j).trigger("chartproperty",[A.concat(w.hierarchyLabels)]),!a.result)return void $("#"+b.id).append(app.chartCommons.getError(a));var B=prepareData(a,null,!0),C=a.seriesLablesCaptions,D=a.kpisLablesCaptions;if(d3Utils.prepareDataForBarChart(B,b,x,y,C,D),a.levels&&a.levels.length>0){var E=d3.select(j).append("div").attr("class","legend-bar temporal");E.breadcrumb(a.levels,b,d,p)}if(2==app.dashboardLayoutVersion&&!b.editMode){var F=$(j+" .legend-bar"),G=F.css("margin-top"),H=(G?+F.css("margin-top").replace("px",""):0,"undefined"==typeof F?0:F.height()+0);m-=H}if(!a.matrix||0==a.matrix.length)return void d3.select(j).append("div").attr("class","temporal").style("font-size","0.8em").style("margin","15px").append("span").attr("class","translate").attr("data-trans-key","داده‌ای برای نمایش وجود ندارد").text("داده‌ای برای نمایش وجود ندارد");var I=z.seriesLabels.map(function(a){return{key:a.key,value:a.value,prop:e(a.key)}});I.unshift({key:a.CurrentDimName,value:a.CurrentDimName,prop:e(a.CurrentDimName)});var J={rows:B.map(function(a){var b=a.series;return b.unshift({data:a.label,prop:I[0].prop,key:I[0].key,label:I[0].value,onClickVal:a.onClickVal}),b}),headers:I};return void v.render({selector:j,settings:b,tableData:J,resultRows:a.resultRows,pivoteMode:!0,page:b.tableInfo});var K}else{if(b.input=a,app.chartCommons.setDefault(b.chartProp,a.headers,"table"),b.editMode&&$(j).trigger("chartproperty",[a.headers]),!a.result)return void $("#"+b.id).append(app.chartCommons.getError(a));var L=a.nonPivotMatrix,M=a.Dimentions.Hierarchies.concat(a.Dimentions.SeriesLevel||[]),I=a.headers.map(function(a,b){return{key:M[b],value:a,prop:e(a)}}),J={rows:L.map(function(a){var b=a.map(function(a){return{data:a}});return b}),headers:I};return void v.render({selector:j,settings:b,tableData:J,resultRows:a.resultRows,page:a.TableInfo,totalRows:a.nonPivotMatrixLength,remoteData:!0})}if(a.TableInfo&&a.TableInfo.Filter){var N=a.TableInfo.Filter.map(function(a){return{value:a.FilterParameter,type:a.FilterType}});h(N)}var N=$(j).data("filterbox");h(N)},function(a,b){"undefined"!=typeof module?module.exports=b():"function"==typeof define&&"object"==typeof define.amd?define(b):this[a]=b()}("Clusterize",function(){"use strict";function a(a,b,c){return b.addEventListener?b.addEventListener(a,c,!1):b.attachEvent("on"+a,c)}function b(a,b,c){return b.removeEventListener?b.removeEventListener(a,c,!1):b.detachEvent("on"+a,c)}function c(a){return"[object Array]"===Object.prototype.toString.call(a)}function d(a,b){return window.getComputedStyle?window.getComputedStyle(b)[a]:b.currentStyle[a]}var e=function(){for(var a=3,b=document.createElement("b"),c=b.all||[];b.innerHTML="<!--[if gt IE "+ ++a+"]><i><![endif]-->",c[0];);return a>4?a:document.documentMode}(),f=navigator.platform.toLowerCase().indexOf("mac")+1,g=function(d){if(!(this instanceof g))return new g(d);var e=this,h={rows_in_block:50,blocks_in_cluster:4,tag:null,show_no_data_row:!0,no_data_class:"clusterize-no-data",no_data_text:"No data",keep_parity:!0,callbacks:{}};e.options={};for(var i,j=["rows_in_block","blocks_in_cluster","show_no_data_row","no_data_class","no_data_text","keep_parity","tag","callbacks"],k=0;i=j[k];k++)e.options[i]="undefined"!=typeof d[i]&&null!=d[i]?d[i]:h[i];for(var l,m=["scroll","content"],k=0;l=m[k];k++)if(e[l+"_elem"]=d[l+"Id"]?document.getElementById(d[l+"Id"]):d[l+"Elem"],!e[l+"_elem"])throw new Error("Error! Could not find "+l+" element");e.content_elem.hasAttribute("tabindex")||e.content_elem.setAttribute("tabindex",0);var n=c(d.rows)?d.rows:e.fetchMarkup(),o={},p=e.scroll_elem.scrollTop;e.insertToDOM(n,o),e.scroll_elem.scrollTop=p;var q=!1,r=0,s=!1,t=function(){f&&(s||(e.content_elem.style.pointerEvents="none"),s=!0,clearTimeout(r),r=setTimeout(function(){e.content_elem.style.pointerEvents="auto",s=!1},50)),q!=(q=e.getClusterNum())&&e.insertToDOM(n,o),e.options.callbacks.scrollingProgress&&e.options.callbacks.scrollingProgress(e.getScrollProgress())},u=0,v=function(){clearTimeout(u),u=setTimeout(e.refresh,100)};a("scroll",e.scroll_elem,t),a("resize",window,v),e.destroy=function(a){b("scroll",e.scroll_elem,t),b("resize",window,v),e.html((a?e.generateEmptyRow():n).join(""))},e.refresh=function(a){(e.getRowsHeight(n)||a)&&e.update(n)},e.update=function(a){n=c(a)?a:[];var b=e.scroll_elem.scrollTop;n.length*e.options.item_height<b&&(e.scroll_elem.scrollTop=0,q=0),e.insertToDOM(n,o),e.scroll_elem.scrollTop=b},e.clear=function(){e.update([])},e.getRowsAmount=function(){return n.length},e.getScrollProgress=function(){return this.options.scroll_top/(n.length*this.options.item_height)*100||0};var w=function(a,b){var d=c(b)?b:[];d.length&&(n="append"==a?n.concat(d):d.concat(n),e.insertToDOM(n,o))};e.append=function(a){w("append",a)},e.prepend=function(a){w("prepend",a)}};return g.prototype={constructor:g,fetchMarkup:function(){for(var a=[],b=this.getChildNodes(this.content_elem);b.length;)a.push(b.shift().outerHTML);return a},exploreEnvironment:function(a,b){var c=this.options;c.content_tag=this.content_elem.tagName.toLowerCase(),a.length&&(e&&9>=e&&!c.tag&&(c.tag=a[0].match(/<([^>\s/]*)/)[1].toLowerCase()),this.content_elem.children.length<=1&&(b.data=this.html(a[0]+a[0]+a[0])),c.tag||(c.tag=this.content_elem.children[0].tagName.toLowerCase()),this.getRowsHeight(a))},getRowsHeight:function(a){var b=this.options,c=b.item_height;if(b.cluster_height=0,a.length){var e=this.content_elem.children,f=e[Math.floor(e.length/2)];if(b.item_height=f.offsetHeight,"tr"==b.tag&&"collapse"!=d("borderCollapse",this.content_elem)&&(b.item_height+=parseInt(d("borderSpacing",this.content_elem),10)||0),"tr"!=b.tag){var g=parseInt(d("marginTop",f),10)||0,h=parseInt(d("marginBottom",f),10)||0;b.item_height+=Math.max(g,h)}return b.block_height=b.item_height*b.rows_in_block,b.rows_in_cluster=b.blocks_in_cluster*b.rows_in_block,b.cluster_height=b.blocks_in_cluster*b.block_height,c!=b.item_height}},getClusterNum:function(){return this.options.scroll_top=this.scroll_elem.scrollTop,Math.floor(this.options.scroll_top/(this.options.cluster_height-this.options.block_height))||0},generateEmptyRow:function(){var a=this.options;if(!a.tag||!a.show_no_data_row)return[];var b,c=document.createElement(a.tag),d=document.createTextNode(a.no_data_text);return c.className=a.no_data_class,"tr"==a.tag&&(b=document.createElement("td"),b.colSpan=100,b.appendChild(d)),c.appendChild(b||d),[c.outerHTML]},generate:function(a,b){var c=this.options,d=a.length;if(d<c.rows_in_block)return{top_offset:0,bottom_offset:0,rows_above:0,rows:d?a:this.generateEmptyRow()};var e=Math.max((c.rows_in_cluster-c.rows_in_block)*b,0),f=e+c.rows_in_cluster,g=Math.max(e*c.item_height,0),h=Math.max((d-f)*c.item_height,0),i=[],j=e;1>g&&j++;for(var k=e;f>k;k++)a[k]&&i.push(a[k]);return{top_offset:g,bottom_offset:h,rows_above:j,rows:i}},renderExtraTag:function(a,b){var c=document.createElement(this.options.tag),d="clusterize-";return c.className=[d+"extra-row",d+a].join(" "),b&&(c.style.height=b+"px"),c.outerHTML},insertToDOM:function(a,b){this.options.cluster_height||this.exploreEnvironment(a,b);var c=this.generate(a,this.getClusterNum()),d=c.rows.join(""),e=this.checkChanges("data",d,b),f=this.checkChanges("top",c.top_offset,b),g=this.checkChanges("bottom",c.bottom_offset,b),h=this.options.callbacks,i=[];e||f?(c.top_offset&&(this.options.keep_parity&&i.push(this.renderExtraTag("keep-parity")),i.push(this.renderExtraTag("top-space",c.top_offset))),i.push(d),c.bottom_offset&&i.push(this.renderExtraTag("bottom-space",c.bottom_offset)),h.clusterWillChange&&h.clusterWillChange(),this.html(i.join("")),"ol"==this.options.content_tag&&this.content_elem.setAttribute("start",c.rows_above),h.clusterChanged&&h.clusterChanged()):g&&(this.content_elem.lastChild.style.height=c.bottom_offset+"px")},html:function(a){var b=this.content_elem;if(e&&9>=e&&"tr"==this.options.tag){var c,d=document.createElement("div");for(d.innerHTML="<table><tbody>"+a+"</tbody></table>";c=b.lastChild;)b.removeChild(c);for(var f=this.getChildNodes(d.firstChild.firstChild);f.length;)b.appendChild(f.shift())}else b.innerHTML=a},getChildNodes:function(a){for(var b=a.children,c=[],d=0,e=b.length;e>d;d++)c.push(b[d]);return c},checkChanges:function(a,b,c){var d=b!=c[a];return c[a]=b,d}},g}),!function(){"use strict";function a(d){if(!d)throw new Error("No options passed to Waypoint constructor");if(!d.element)throw new Error("No element option passed to Waypoint constructor");if(!d.handler)throw new Error("No handler option passed to Waypoint constructor");this.key="waypoint-"+b,this.options=a.Adapter.extend({},a.defaults,d),this.element=this.options.element,this.adapter=new a.Adapter(this.element),this.callback=d.handler,this.axis=this.options.horizontal?"horizontal":"vertical",this.enabled=this.options.enabled,this.triggerPoint=null,this.group=a.Group.findOrCreate({name:this.options.group,axis:this.axis}),this.context=a.Context.findOrCreateByElement(this.options.context),a.offsetAliases[this.options.offset]&&(this.options.offset=a.offsetAliases[this.options.offset]),this.group.add(this),this.context.add(this),c[this.key]=this,b+=1}var b=0,c={};a.prototype.queueTrigger=function(a){this.group.queueTrigger(this,a)},a.prototype.trigger=function(a){this.enabled&&this.callback&&this.callback.apply(this,a)},a.prototype.destroy=function(){this.context.remove(this),this.group.remove(this),delete c[this.key]},a.prototype.disable=function(){return this.enabled=!1,this},a.prototype.enable=function(){return this.context.refresh(),this.enabled=!0,this},a.prototype.next=function(){return this.group.next(this)},a.prototype.previous=function(){return this.group.previous(this)},a.invokeAll=function(a){var b=[];for(var d in c)b.push(c[d]);for(var e=0,f=b.length;f>e;e++)b[e][a]()},a.destroyAll=function(){a.invokeAll("destroy")},a.disableAll=function(){a.invokeAll("disable")},a.enableAll=function(){a.Context.refreshAll();for(var b in c)c[b].enabled=!0;return this},a.refreshAll=function(){a.Context.refreshAll()},a.viewportHeight=function(){return window.innerHeight||document.documentElement.clientHeight},a.viewportWidth=function(){return document.documentElement.clientWidth},a.adapters=[],a.defaults={context:window,continuous:!0,enabled:!0,group:"default",horizontal:!1,offset:0},a.offsetAliases={"bottom-in-view":function(){return this.context.innerHeight()-this.adapter.outerHeight()},"right-in-view":function(){return this.context.innerWidth()-this.adapter.outerWidth()}},window.Waypoint=a}(),function(){"use strict";function a(a){window.setTimeout(a,1e3/60)}function b(a){this.element=a,this.Adapter=e.Adapter,this.adapter=new this.Adapter(a),this.key="waypoint-context-"+c,this.didScroll=!1,this.didResize=!1,this.oldScroll={x:this.adapter.scrollLeft(),y:this.adapter.scrollTop()},this.waypoints={vertical:{},horizontal:{}},a.waypointContextKey=this.key,d[a.waypointContextKey]=this,c+=1,e.windowContext||(e.windowContext=!0,e.windowContext=new b(window)),this.createThrottledScrollHandler(),this.createThrottledResizeHandler()}var c=0,d={},e=window.Waypoint,f=window.onload;b.prototype.add=function(a){var b=a.options.horizontal?"horizontal":"vertical";this.waypoints[b][a.key]=a,this.refresh()},b.prototype.checkEmpty=function(){var a=this.Adapter.isEmptyObject(this.waypoints.horizontal),b=this.Adapter.isEmptyObject(this.waypoints.vertical),c=this.element==this.element.window;a&&b&&!c&&(this.adapter.off(".waypoints"),delete d[this.key])},b.prototype.createThrottledResizeHandler=function(){function a(){b.handleResize(),b.didResize=!1}var b=this;this.adapter.on("resize.waypoints",function(){b.didResize||(b.didResize=!0,e.requestAnimationFrame(a))})},b.prototype.createThrottledScrollHandler=function(){function a(){b.handleScroll(),b.didScroll=!1}var b=this;this.adapter.on("scroll.waypoints",function(){(!b.didScroll||e.isTouch)&&(b.didScroll=!0,e.requestAnimationFrame(a))})},b.prototype.handleResize=function(){e.Context.refreshAll()},b.prototype.handleScroll=function(){var a={},b={horizontal:{newScroll:this.adapter.scrollLeft(),oldScroll:this.oldScroll.x,forward:"right",backward:"left"},vertical:{newScroll:this.adapter.scrollTop(),oldScroll:this.oldScroll.y,forward:"down",backward:"up"}};for(var c in b){var d=b[c],e=d.newScroll>d.oldScroll,f=e?d.forward:d.backward;
for(var g in this.waypoints[c]){var h=this.waypoints[c][g];if(null!==h.triggerPoint){var i=d.oldScroll<h.triggerPoint,j=d.newScroll>=h.triggerPoint,k=i&&j,l=!i&&!j;(k||l)&&(h.queueTrigger(f),a[h.group.id]=h.group)}}}for(var m in a)a[m].flushTriggers();this.oldScroll={x:b.horizontal.newScroll,y:b.vertical.newScroll}},b.prototype.innerHeight=function(){return this.element==this.element.window?e.viewportHeight():this.adapter.innerHeight()},b.prototype.remove=function(a){delete this.waypoints[a.axis][a.key],this.checkEmpty()},b.prototype.innerWidth=function(){return this.element==this.element.window?e.viewportWidth():this.adapter.innerWidth()},b.prototype.destroy=function(){var a=[];for(var b in this.waypoints)for(var c in this.waypoints[b])a.push(this.waypoints[b][c]);for(var d=0,e=a.length;e>d;d++)a[d].destroy()},b.prototype.refresh=function(){var a,b=this.element==this.element.window,c=b?void 0:this.adapter.offset(),d={};this.handleScroll(),a={horizontal:{contextOffset:b?0:c.left,contextScroll:b?0:this.oldScroll.x,contextDimension:this.innerWidth(),oldScroll:this.oldScroll.x,forward:"right",backward:"left",offsetProp:"left"},vertical:{contextOffset:b?0:c.top,contextScroll:b?0:this.oldScroll.y,contextDimension:this.innerHeight(),oldScroll:this.oldScroll.y,forward:"down",backward:"up",offsetProp:"top"}};for(var f in a){var g=a[f];for(var h in this.waypoints[f]){var i,j,k,l,m,n=this.waypoints[f][h],o=n.options.offset,p=n.triggerPoint,q=0,r=null==p;n.element!==n.element.window&&(q=n.adapter.offset()[g.offsetProp]),"function"==typeof o?o=o.apply(n):"string"==typeof o&&(o=parseFloat(o),n.options.offset.indexOf("%")>-1&&(o=Math.ceil(g.contextDimension*o/100))),i=g.contextScroll-g.contextOffset,n.triggerPoint=Math.floor(q+i-o),j=p<g.oldScroll,k=n.triggerPoint>=g.oldScroll,l=j&&k,m=!j&&!k,!r&&l?(n.queueTrigger(g.backward),d[n.group.id]=n.group):!r&&m?(n.queueTrigger(g.forward),d[n.group.id]=n.group):r&&g.oldScroll>=n.triggerPoint&&(n.queueTrigger(g.forward),d[n.group.id]=n.group)}}return e.requestAnimationFrame(function(){for(var a in d)d[a].flushTriggers()}),this},b.findOrCreateByElement=function(a){return b.findByElement(a)||new b(a)},b.refreshAll=function(){for(var a in d)d[a].refresh()},b.findByElement=function(a){return d[a.waypointContextKey]},window.onload=function(){f&&f(),b.refreshAll()},e.requestAnimationFrame=function(b){var c=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||a;c.call(window,b)},e.Context=b}(),function(){"use strict";function a(a,b){return a.triggerPoint-b.triggerPoint}function b(a,b){return b.triggerPoint-a.triggerPoint}function c(a){this.name=a.name,this.axis=a.axis,this.id=this.name+"-"+this.axis,this.waypoints=[],this.clearTriggerQueues(),d[this.axis][this.name]=this}var d={vertical:{},horizontal:{}},e=window.Waypoint;c.prototype.add=function(a){this.waypoints.push(a)},c.prototype.clearTriggerQueues=function(){this.triggerQueues={up:[],down:[],left:[],right:[]}},c.prototype.flushTriggers=function(){for(var c in this.triggerQueues){var d=this.triggerQueues[c],e="up"===c||"left"===c;d.sort(e?b:a);for(var f=0,g=d.length;g>f;f+=1){var h=d[f];(h.options.continuous||f===d.length-1)&&h.trigger([c])}}this.clearTriggerQueues()},c.prototype.next=function(b){this.waypoints.sort(a);var c=e.Adapter.inArray(b,this.waypoints),d=c===this.waypoints.length-1;return d?null:this.waypoints[c+1]},c.prototype.previous=function(b){this.waypoints.sort(a);var c=e.Adapter.inArray(b,this.waypoints);return c?this.waypoints[c-1]:null},c.prototype.queueTrigger=function(a,b){this.triggerQueues[b].push(a)},c.prototype.remove=function(a){var b=e.Adapter.inArray(a,this.waypoints);b>-1&&this.waypoints.splice(b,1)},c.prototype.first=function(){return this.waypoints[0]},c.prototype.last=function(){return this.waypoints[this.waypoints.length-1]},c.findOrCreate=function(a){return d[a.axis][a.name]||new c(a)},e.Group=c}(),function(){"use strict";function a(a){this.$element=b(a)}var b=window.jQuery,c=window.Waypoint;b.each(["innerHeight","innerWidth","off","offset","on","outerHeight","outerWidth","scrollLeft","scrollTop"],function(b,c){a.prototype[c]=function(){var a=Array.prototype.slice.call(arguments);return this.$element[c].apply(this.$element,a)}}),b.each(["extend","inArray","isEmptyObject"],function(c,d){a[d]=b[d]}),c.adapters.push({name:"jquery",Adapter:a}),c.Adapter=a}(),function(){"use strict";function a(a){return function(){var c=[],d=arguments[0];return a.isFunction(arguments[0])&&(d=a.extend({},arguments[1]),d.handler=arguments[0]),this.each(function(){var e=a.extend({},d,{element:this});"string"==typeof e.context&&(e.context=a(this).closest(e.context)[0]),c.push(new b(e))}),c}}var b=window.Waypoint;window.jQuery&&(window.jQuery.fn.waypoint=a(window.jQuery)),window.Zepto&&(window.Zepto.fn.waypoint=a(window.Zepto))}(),function(a){var b,c=a(document),d=a("head"),e=null,f={},g=0,h="id",i="px",j="JColResizer",k="JCLRFlex",l=parseInt,m=Math,n=navigator.userAgent.indexOf("Trident/4.0")>0;try{b=sessionStorage}catch(o){}d.append("<style type='text/css'>  .JColResizer{table-layout:fixed;} .JColResizer > tbody > tr > td, .JColResizer > tbody > tr > th{overflow:hidden}  .JPadding > tbody > tr > td, .JPadding > tbody > tr > th{padding-left:0!important; padding-right:0!important;} .JCLRgrips{ height:0px; position:relative;} .JCLRgrip{margin-left:-5px; position:absolute; z-index:5; } .JCLRgrip .JColResizer{position:absolute;background-color:red;filter:alpha(opacity=1);opacity:0;width:10px;height:100%;cursor: col-resize;top:0px} .JCLRLastGrip{position:absolute; width:1px; } .JCLRgripDrag{ border-left:1px dotted black;	} .JCLRFlex{width:auto!important;} .JCLRgrip.JCLRdisabledGrip .JColResizer{cursor:default; display:none;}</style>");var p=function(b,c){var e=a(b);if(e.opt=c,e.mode=c.resizeMode,e.dc=e.opt.disabledColumns,e.opt.removePadding&&e.addClass("JPadding"),e.opt.disable)return q(e);var i=e.id=e.attr(h)||j+g++;e.p=e.opt.postbackSafe,!e.is("table")||f[i]&&!e.opt.partialRefresh||("col-resize"!==e.opt.hoverCursor&&d.append("<style type='text/css'>.JCLRgrip .JColResizer:hover{cursor:"+e.opt.hoverCursor+"!important}</style>"),e.addClass(j).attr(h,i).before('<div class="JCLRgrips"/>'),e.g=[],e.c=[],e.w=e.width(),e.gc=e.prev(),e.f=e.opt.fixed,c.marginLeft&&e.gc.css("marginLeft",c.marginLeft),c.marginRight&&e.gc.css("marginRight",c.marginRight),e.cs=l(n?b.cellSpacing||b.currentStyle.borderSpacing:e.css("border-spacing"))||2,e.b=l(n?b.border||b.currentStyle.borderLeftWidth:e.css("border-left-width"))||1,f[i]=e,r(e))},q=function(a){var b=a.attr(h),a=f[b];a&&a.is("table")&&(a.removeClass(j+" "+k).gc.remove(),delete f[b])},r=function(c){var d=c.find(">thead>tr:first>th,>thead>tr:first>td");d.length||(d=c.find(">tbody>tr:first>th,>tr:first>th,>tbody>tr:first>td, >tr:first>td")),d=d.filter(":visible"),c.cg=c.find("col"),c.ln=d.length,c.p&&b&&b[c.id]&&s(c,d),d.each(function(b){var d=a(this),e=-1!=c.dc.indexOf(b),f=a(c.gc.append('<div class="JCLRgrip"></div>')[0].lastChild);f.append(e?"":c.opt.gripInnerHtml).append('<div class="'+j+'"></div>'),b==c.ln-1&&(f.addClass("JCLRLastGrip"),c.f&&f.html("")),f.bind("touchstart mousedown",y),e?f.addClass("JCLRdisabledGrip"):f.removeClass("JCLRdisabledGrip").bind("touchstart mousedown",y),f.t=c,f.i=b,f.c=d,d.w=d.width(),c.g.push(f),c.c.push(d),d.width(d.w).removeAttr("width"),f.data(j,{i:b,t:c.attr(h),last:b==c.ln-1})}),c.cg.removeAttr("width"),c.find("td, th").not(d).not("table th, table td").each(function(){a(this).removeAttr("width")}),c.f||c.removeAttr("width").addClass(k),t(c)},s=function(a,c){var d,e,f=0,g=0,h=[];if(c){if(a.cg.removeAttr("width"),a.opt.flush)return void(b[a.id]="");for(d=b[a.id].split(";"),e=d[a.ln+1],!a.f&&e&&(a.width(e*=1),a.opt.overflow&&(a.css("min-width",e+i),a.w=e));g<a.ln;g++)h.push(100*d[g]/d[a.ln]+"%"),c.eq(g).css("width",h[g]);for(g=0;g<a.ln;g++)a.cg.eq(g).css("width",h[g])}else{for(b[a.id]="";g<a.c.length;g++)d=a.c[g].width(),b[a.id]+=d+";",f+=d;b[a.id]+=f,a.f||(b[a.id]+=";"+a.width())}},t=function(a){a.gc.width(a.w);for(var b=0;b<a.ln;b++){var c=a.c[b];a.g[b].css({left:c.offset().left-a.offset().left+c.outerWidth(!1)+a.cs/2+i,height:a.opt.headerOnly?a.c[0].outerHeight(!1):a.outerHeight(!1)})}},u=function(a,b,c){var d=e.x-e.l,f=a.c[b],g=a.c[b+1],h=f.w+d,j=g.w-d;f.width(h+i),a.cg.eq(b).width(h+i),a.f?(g.width(j+i),a.cg.eq(b+1).width(j+i)):a.opt.overflow&&a.css("min-width",a.w+d),c&&(f.w=h,g.w=a.f?j:g.w)},v=function(b){var c=a.map(b.c,function(a){return a.width()});b.width(b.w=b.width()).removeClass(k),a.each(b.c,function(a,b){b.width(c[a]).w=c[a]}),b.addClass(k)},w=function(a){if(e){var b=e.t,c=a.originalEvent.touches,d=c?c[0].pageX:a.pageX,f=d-e.ox+e.l,g=b.opt.minWidth,h=e.i,j=1.5*b.cs+g+b.b,k=h==b.ln-1,l=h?b.g[h-1].position().left+b.cs+g:j,n=b.f?h==b.ln-1?b.w-j:b.g[h+1].position().left-b.cs-g:1/0;if(f=m.max(l,m.min(n,f)),e.x=f,e.css("left",f+i),k){var o=b.c[e.i];e.w=o.w+f-e.l}if(b.opt.liveDrag){k?(o.width(e.w),!b.f&&b.opt.overflow?b.css("min-width",b.w+f-e.l):b.w=b.width()):u(b,h),t(b);var p=b.opt.onDrag;p&&(a.currentTarget=b[0],p(a))}return!1}},x=function(d){if(c.unbind("touchend."+j+" mouseup."+j).unbind("touchmove."+j+" mousemove."+j),a("head :last-child").remove(),e){if(e.removeClass(e.t.opt.draggingClass),e.x-e.l!=0){var f=e.t,g=f.opt.onResize,h=e.i,i=h==f.ln-1,k=f.g[h].c;i?(k.width(e.w),k.w=e.w):u(f,h,!0),f.f||v(f),t(f),g&&(d.currentTarget=f[0],g(d)),f.p&&b&&s(f)}e=null}},y=function(b){var g=a(this).data(j),h=f[g.t],i=h.g[g.i],k=b.originalEvent.touches;if(i.ox=k?k[0].pageX:b.pageX,i.l=i.position().left,i.x=i.l,c.bind("touchmove."+j+" mousemove."+j,w).bind("touchend."+j+" mouseup."+j,x),d.append("<style type='text/css'>*{cursor:"+h.opt.dragCursor+"!important}</style>"),i.addClass(h.opt.draggingClass),e=i,h.c[g.i].l)for(var l,m=0;m<h.ln;m++)l=h.c[m],l.l=!1,l.w=l.width();return!1},z=function(){for(var a in f)if(f.hasOwnProperty(a)){a=f[a];var c,d=0;if(a.removeClass(j),a.f){for(a.w=a.width(),c=0;c<a.ln;c++)d+=a.c[c].w;for(c=0;c<a.ln;c++)a.c[c].css("width",m.round(1e3*a.c[c].w/d)/10+"%").l=!0}else v(a),"flex"==a.mode&&a.p&&b&&s(a);t(a.addClass(j))}};a(window).bind("resize."+j,z),a.fn.extend({colResizable:function(b){var c={resizeMode:"fit",draggingClass:"JCLRgripDrag",gripInnerHtml:"",liveDrag:!1,minWidth:15,headerOnly:!1,hoverCursor:"col-resize",dragCursor:"col-resize",postbackSafe:!1,flush:!1,marginLeft:null,marginRight:null,disable:!1,partialRefresh:!1,disabledColumns:[],removePadding:!0,onDrag:null,onResize:null},b=a.extend(c,b);switch(b.fixed=!0,b.overflow=!1,b.resizeMode){case"flex":b.fixed=!1;break;case"overflow":b.fixed=!1,b.overflow=!0}return this.each(function(){p(this,b)})}})}(jQuery);var app=app||{};app.charts=app.charts||{},app.charts.tree={},app.charts.tree.draw=function(a,b,c,d){function e(c){return c.dimensionName=a.dimensionName,c.datasourceId=a.DataSourceId,c.chartId=b.editMode?-1:a.chartId,b.editMode||-1!=c.Id||app.chartCommons.userFilter.setFilter({id:c.Id,values:c.Values,variableType:c.VariableType,dimensionName:c.dimensionName,chartInPageId:b.ChartInPageId,datasourceId:c.datasourceId}),-1==+c.Id?(app.moderation.dashboadpage.refreshRelatedDatasources(a.RefreshDatasource,[+b.ChartInPageId]),void app.filterBox.refresh()):void $.ajax({type:"POST",url:app.urlPrefix+"Moderation/GlobalVariable/SetValueForUser",dataType:"json",contentType:"application/json;charset=utf-8",traditional:!0,data:JSON.stringify(c),success:function(a){a.result?(app.moderation.dashboadpage.refreshRelatedDatasources(a.relatedDatasource,[+b.ChartInPageId]),app.filterBox.refresh()):alert(a.Message)}})}b.input=a,app.chartCommons.calculateFields(a.series,b.calculatedFields);var f=(a.title,a.chartInfo,"undefined"!=typeof a.series?a.series.labels:[]),g="undefined"!=typeof a.kpis?a.kpis.labels:[],h=(b.LabelY,"#"+b.id),i=$(h).width();$(h).height(),"small"==b.chartProp.info.chartSize?150:"medium"==b.chartProp.info.chartSize?200:"large"==b.chartProp.info.chartSize?250:"veryLarge"==b.chartProp.info.chartSize?400:130;b.width=i;"undefined"==typeof a.lang?!0:0==+a.lang,d.isProgress,d.showProgress,d.title;if(b.editMode&&$(h).trigger("chartproperty",[g.concat(f)]),!a.result)return void $("#"+b.id).append(app.chartCommons.getError(a));$(h).addClass("tree-chart").css("text-align","right");var j=$(h+" .title").outerHeight(),k=$(h).outerHeight()-j-2,l=d3.select(h).append("ul").attr("class","root-node temporal tree").text("");l.style("height",k+"px");var m=function(a,c){a.select(".loading").remove(),$(a.node()).data("vals",c.vals);var d=$(a.node()).find(".tree-caret"),f=0==d.length||d.hasClass("rotate"),g=d3.select($("<ul></ul>").get(0)).attr("class","tree-element collapse fade "+(f?"in":""));c.data=c.data.map(function(a){return{id:a[0],parent:a[1],name:a[2]||a[0],type:c.hasType?a[3]:null,childs:a[a.length-1]}});var i=g.selectAll("li").data(c.data).enter().append("li").attr("class","node tree-element");i.append("span").text(function(a,b){return a.name}).attr("class","value pointer").on("click",function(a){var d=b.chartProp.info.selectable;if("undefined"!=typeof d&&"none"!=d){"one"==d&&$(this).closest(".tree-chart").find(".value.active").removeClass("active"),$(this).toggleClass("active");var f=d3.select(h).selectAll(".active").data().map(function(a){return a.id}),g=_.filter(c.vals,function(a){return a[0]==f}).map(function(a){return a[1]});e({Id:-1,Values:g,VariableType:0})}}),i.each(function(a){0!=+a.childs&&d3.select(this).append(b.editMode?"span":"i").attr("class",function(){return b.editMode?"glyphicon-chevron-left glyphicon tree-caret pointer":"icon angle down icon-animate large  tree-caret pointer"}).text(" ").on("click",function(a,c){if(0!=+a.childs){var d=$(this),e=d.hasClass("rotate");e?d.removeClass("rotate"):d.addClass("rotate");var f=$(this).data("loaded");if(f){var g=$(this).parent().find(" > ul");return void(b.editMode?g.collapse(d.hasClass("rotate")?"hide":"show"):g.transition(e?"out scale right":"in  scale left"))}$(this).data("loaded",!0);var h=app.urlPrefix+"Charts/BarChart/getTreeData",i={parent:a.id,chartId:b.chartId,ChartInPageId:b.ChartInPageId,notEditMode:!b.editMode};b.editMode&&(i.ChartInfo=$("#divChart").data("chartInfo"));var j=d3.select(this).node().parentElement;d3.select(j).append("ul").attr("class","loading collapse fade in").html('<div class="ui active inline loader mini"></div>');var k=app.mobileMode?proxy.ajax:$.ajax,l=app.mobileMode&&!app.mobileModeTest?i:JSON.stringify(i);k({url:h,type:"POST",dataType:"json",data:l,success:function(a,c,d){b.mobileModeData={isOnline:c,date:d},m(d3.select(j),a)},contentType:"application/json",error:function(){}})}})}),b.editMode||g.style("display","none"),$(a[0][0]).append($(g[0][0])),b.editMode||$(a[0][0]).find("> ul").transition("in scale ")};m(l,a),$(h).trigger("heightChange")};var app=app||{};app.charts=app.charts||{},app.charts.text={},app.charts.text.draw=function(a,b,c,d){b.input=a,app.chartCommons.calculateFields(a.series,b.calculatedFields);var e=(a.title,a.chartInfo,"undefined"!=typeof a.series?a.series.labels:[]),f="undefined"!=typeof a.kpis?a.kpis.labels:[],g=(b.LabelY,"#"+b.id),h=$(g).width();$(g).height(),"small"==b.chartProp.info.chartSize?150:"medium"==b.chartProp.info.chartSize?200:"large"==b.chartProp.info.chartSize?250:"veryLarge"==b.chartProp.info.chartSize?400:130;b.width=h;"undefined"==typeof a.lang?!0:0==+a.lang,d.isProgress,d.showProgress,d.title;if(b.editMode&&$(g).trigger("chartproperty",[f.concat(e)]),!a.result)return void $("#"+b.id).append(app.chartCommons.getError(a));$(g).addClass("tree-chart").css("text-align","right");var i=$(g+" .title").outerHeight(),j=$(g).outerHeight()-i-2,k=d3.select(g).append("ul").attr("class","root-node temporal tree").text("");k.style("height",j+"px"),$(g).append(b.chartProp.info.html)};var app=app||{};app.charts=app.charts||{},app.charts.userControl={},String.prototype.deentitize=function(){var a=this.replace(/&gt;/g,">");return a=a.replace(/&lt;/g,"<"),a=a.replace(/&quot;/g,'"'),a=a.replace(/&apos;/g,"'"),a=a.replace(/&amp;/g,"&")},String.prototype.entitize=function(){var a=this.replace(/>/g,"&gt;");return a=a.replace(/&/g,"&amp;"),a=a.replace(/</g,"&lt;"),a=a.replace(/"/g,"&quot;"),a=a.replace(/'/g,"&apos;")},app.charts.userControl.draw=function(a,b,c,d){function e(){function c(a){var c=[a],d=b.chartProp.info.textOperand||"or";c.push(d);var e=b.chartProp.info.dimensions.map(function(a){return a.Name}).join(", ");if(c.push(e),b.chartProp.info.dimensions.forEach(function(a){c.push(a.formula)}),b.editMode)$(l).trigger("default-value",[!0,c,5]);else{var f={Id:b.chartProp.info.variableId||-1,Values:c,VariableType:5};k(f)}}var d='<div class="input-group temporal" style="margin-top:10px">                   <span class="input-group-btn">                     <button type="button" class="btn btn-default">                     <span style="font-size:13px" class="glyphicon glyphicon-search"> </span>                     </button>                   </span>                   <input type="text" placeholder="جستجو..." class="form-control">                 </div>';d='<div class="ui form temporal"><div class=" field"><div class="ui icon input">  <input type="text" placeholder="جستجو...">  <i class="search icon"></i></div></div></div>',$(l).append(d),$(l+" input").on("keydown",function(a){if(13==a.keyCode){var b=$(this).val();c(b)}}),$(l+" button").on("click",function(){var a=$(l+" input").val();c(a)});var e=[];e=a.GloablFilterDefaultValue?a.GloablFilterDefaultValue.Value:null!=a.DefaultValue&&a.DefaultValue.length>0&&-1!=b.chartProp.info.variableId?a.DefaultValue:b.chartProp.info.variableDefault&&b.chartProp.info.variableDefault.values&&"NONE"==b.chartProp.info.variableDefaultFunction&&-1!=b.chartProp.info.variableId?b.chartProp.info.variableDefault.values:["",""],$(l+" input").val(e[0])}function f(){if(!b.editMode){var c=app.chartCommons.userFilter.getFilterValue(b.ChartInPageId);_.isNull(c)||(a.GloablFilterDefaultValue=a.GloablFilterDefaultValue||{},a.GloablFilterDefaultValue.ValuesType=c.variableType,a.GloablFilterDefaultValue.Value=3==+c.variableType?c.defaultValue:c.values)}}function g(){var d=a.fields.map(function(a){return a.Value}),e=a.fields.map(function(a){return a.Key});e.length!=d.length&&$("#"+b.id).append(app.chartCommons.getError(a));for(var f=[],g=0;g<d.length;g++)f.push({Caption:e[g],Uniquename:d[g],IsChecked:!1});var h=function(c){var d=c.filter(function(a){return a.IsChecked}).map(function(a){return a.Uniquename}),e=c.filter(function(a){return a.IsChecked}).map(function(a){return a.Caption}),f='<div style="text-align: right; font-size: 0.9em; margin-top: 7px;"><b>انتخاب‌ها:</b><ul>'+e.map(function(a){return'<li style="  float:right; display:inline; width:33%;">'+a+"</li>"}).join("")+"</ul></div>";$(l+" .selected-item").html(f),a.DefaultValue=d,b.editMode?$(l).trigger("default-value",[!0,d,0]):k({Id:b.chartProp.info.variableId||-1,Values:d})};if(select='<div class="container-fluid temporal" style="margin: 15px 0px 10px;"><div class="row"><a  class=" btn btn-primary pointer filter-member btn-block"> '+(b.chartProp.info.label||"انتخاب")+' <span class="glyphicon glyphicon-list-alt"></span></a></div><div class="row selected-item col-sm-12"></div></div>',$(l).append(select),$(l+" .filter-member").on("click",function(){app.helper.filterMemberDialog(f,h)}),null!=a.DefaultValue&&a.DefaultValue.length>0){f.filter(function(b){return-1!=a.DefaultValue.indexOf(b.Uniquename)}).forEach(function(a,b){a.IsChecked=!0});var i='<div style="text-align: right; font-size: 0.9em; margin-top: 7px;"><b>انتخاب‌ها:</b><ul>'+f.filter(function(a){return a.IsChecked}).map(function(a){return'<li style="  float:right; display:inline; width:33%;">'+a.Caption+"</li>"}).join("")+"</ul></div>";$(l+" .selected-item").html(i)}else if(b.chartProp.info.variableDefault&&b.chartProp.info.variableDefault.values){var j=b.chartProp.info.variableDefault.values;f.filter(function(a){return-1!=j.indexOf(a.Uniquename)}).forEach(function(a,b){a.IsChecked=!0});var i='<div style="text-align: right; font-size: 0.9em; margin-top: 7px;"><b>انتخاب‌ها:</b><ul>'+f.filter(function(a){return a.IsChecked}).map(function(a){return'<li style="  float:right; display:inline; width:33%;">'+a.Caption+"</li>"}).join("")+"</ul></div>";$(l+" .selected-item").html(i)}if(b.editMode){$(l).find("select");$(l).trigger("default-value",[!1,[f[0].UniqueName],0])}c&&h(f)}function h(c){function d(a){return jd_to_persian(gregorian_to_jd(a[0],a[1]+1,a[2]))}function e(a,b){var c="000000000"+a;return c.substr(c.length-b)}function f(a,c,d,e,f){if((!c||d&&e)&&(c||d)&&(b.editMode||!(c&&h==d&&i==e||!c&&h==d))){h=d,i=e;var g=c?[d,e]:[d,b.chartProp.info.dateOp];if(b.input.DefaultValue=g,!b.editMode&&f){var j={Id:b.chartProp.info.variableId||-1,Values:g,VariableType:c?2:4};k(j)}else{$(l).find("select");$(l).trigger("default-value",[!0,g,c?2:4])}$(l).data("user-value",g)}}var g='<div class="ui form temporal"><div class=" field"><div class="ui input">                        <input type="text" id=""  class="form-control from" placeholder="تاریخ" /><input id="from-value" type="hidden"/>                      </div></div></div>';c&&(g='<div class="ui grid temporal form-content" ><div class="row">                        <div class="five wide column ui input">                            <input id="" type="text" class="datepicker form-control from" placeholder="تاریخ شروع" />                            <input id="from-value" type="hidden"/>                        </div>                        <div class="two wide column">تا</div>                        <div class="five wide column ui input">                            <input id="" type="text" class="datepicker form-control to" placeholder="تاریخ پایان"/>                            <input id="to-value" type="hidden"/>                        </div>                      </div></div>'),g=$(g),$(l).append(g),c?(g.find(".from").datepicker({defaultDate:"+1w",changeYear:!0,changeMonth:!0,dateFormat:b.chartProp.info.dateFormatShow+"",altFormat:b.chartProp.info.dateFormatValue+"",altField:g.find("#from-value"),onClose:function(a){a&&(g.find(".to").datepicker("option","minDate",a),f(g,c,g.find("#from-value").val(),g.find("#to-value").val(),!0))}}),g.find(".to").datepicker({defaultDate:"+1w",changeYear:!0,changeMonth:!0,dateFormat:b.chartProp.info.dateFormatShow+"",altFormat:b.chartProp.info.dateFormatValue+"",altField:g.find("#to-value"),onClose:function(a){a&&(g.find(".from").datepicker("option","maxDate",a),f(g,c,g.find("#from-value").val(),g.find("#to-value").val(),!0))}})):g.find(" .from").datepicker({changeMonth:!0,changeYear:!0,dateFormat:b.chartProp.info.dateFormatShow+"",altFormat:b.chartProp.info.dateFormatValue+"",altField:g.find("#from-value"),onClose:function(a){a&&f(g,c,g.find("#from-value").val(),null,!0)}});var h,i,j=!1;if("undefined"==typeof a.DefaultValue||!a.DefaultValue){var m=new Date,n=d([m.getFullYear(),m.getMonth(),m.getDate()]),o=n[0]+"/"+e(n[1],2)+"/"+e(n[2],2);g.find(".from").datepicker("option","dateFormat","yy/mm/dd"),g.find(".from").datepicker("setDate",o),g.find(".from").datepicker("option","dateFormat",b.chartProp.info.dateFormatValue),o=g.find(".from").val(),a.DefaultValue=[o,o],j=!0}var p=[];a.GloablFilterDefaultValue?p=a.GloablFilterDefaultValue.Value:null!=a.DefaultValue&&a.DefaultValue.length>0&&-1!=b.chartProp.info.variableId&&(p=a.DefaultValue),p=p.map(function(a){return a.replace(/\[[^\]]+\]/,"")}),g.find(".from").datepicker("option","dateFormat",b.chartProp.info.dateFormatValue+""),g.find(".to").datepicker("option","dateFormat",b.chartProp.info.dateFormatValue+""),h=j?"":p[0],g.find(".from").datepicker("setDate",p[0]),c&&(g.find(".to").datepicker("setDate",p[1]),i=j?"":p[1]),f(g,c,g.find("#from-value").val(),g.find("#to-value").val(),!1)}function i(c){function d(a,c){if(a||c.push(b.chartProp.info.sliderRange),b.input.DefaultValue=c,b.editMode)$(l).trigger("default-value",[!0,c,1]);else{var d={Id:b.chartProp.info.variableId||-1,Values:c,VariableType:1};$(l).data("user-value",c),k(d)}}var e=a.fields.map(function(a){return a.Value}),f=(a.fields.map(function(a){return a.Key}),""!=b.chartProp.info.sliderMax&&"undefined"!=typeof b.chartProp.info.sliderMax?+b.chartProp.info.sliderMax:d3.max(e,function(a){return+a.replace(/\[[^\]]+\]/,"")})||100),g=""!=b.chartProp.info.sliderMin&&"undefined"!=typeof b.chartProp.info.sliderMin?+b.chartProp.info.sliderMin:d3.min(e,function(a){return+a.replace(/\[[^\]]+\]/,"")})||0,h='<div class="temporal" style="padding-left: 15px; padding-right: 15px; padding-top:5px">                        <div class="slider"></div>                        <div class="slider-value ltr" style="margin-top:5px"> </div>                        <input id="from-value" type="hidden"/>                      </div>';h=$(h),$(l).append(h);var i="min-max"==b.chartProp.info.sliderRange,j=function(a){var c=b.chartProp.info.sliderFormat||",.2f";return Array.isArray(a)?'<div class="inline">'+persian(d3.format(c)(a[0]),n)+'</div> <div class="inline"> تا </div> <div class="inline">'+persian(d3.format(c)(a[1]),n)+"</div>":persian(d3.format(c)(a),n)};h.find(".slider").slider({range:i?!0:b.chartProp.info.sliderRange,min:g,max:f,slide:function(a,b){h.find(".slider-value").html(j(i?b.values:b.value))},stop:function(a,b){d(i,i?b.values:[b.value])}}),h.find(".slider .ui-slider-range").css("background-color","#ddd"),h.find(".slider.ui-widget-content").css("box-shadow","none"),h.find(".slider .ui-slider-handle").css("background-color","#337ab7");var m=[];m=a.GloablFilterDefaultValue?a.GloablFilterDefaultValue.Value:null!=a.DefaultValue&&a.DefaultValue.length>0&&-1!=b.chartProp.info.variableId?a.DefaultValue:[g,f],m=m.map(function(a){return+a.toString().replace(/\[[^\]]+\]/,"")||0}),1==m.length&&m.splice(0,0,0),m[1]<m[0]&&(m[1]=m[0]),h.find(".slider-value").html(j(i?m:m[0])),i?h.find(".slider").slider("values",m):h.find(".slider").slider("value",m[0]),$(l).data("user-value",m)}function j(c){function d(){p||(clearTimeout(o),o=setTimeout(function(){var a=$(l+" .ui.dropdown").dropdown("get value");_.isArray(a)||(a=[a]),a=_.filter(a,null),m(a)},200))}var e=b.chartProp.info.comboStyle;(app.mobile||b.editMode)&&(e="default");var f=a.fields.map(function(a){return a.Value.entitize()}),g=a.fields.map(function(a){return a.Key.entitize()});g.length!=f.length&&$("#"+b.id).append(app.chartCommons.getError(a));var h='<select class="temporal ui fluid '+(c?"multiple":"")+' search selection dropdown" '+(c?"multiple":"")+" >";h+='  <option value="">'+b.chartProp.info.label+"</option>";for(var i=0;i<g.length;i++)h+='  <option value="'+f[i]+'">'+g[i]+"</option>";h+="</select>",$(l).append(h);var j=$(l).find("select");j.on("change",function(){app.lang.setLang({selector:l})});var m=null;m=b.editMode?function(b){a.DefaultValue=b,$(l).trigger("default-value",[!0,a.DefaultValue,0])}:function(c){return!b.chartProp.info.disableClear||c&&c.length?(a.DefaultValue=c,void k({Id:b.chartProp.info.variableId||-1,Values:a.DefaultValue,VariableType:0,disableClear:b.chartProp.info.disableClear})):void $(l+" .ui.dropdown").dropdown("set selected",a.DefaultValue)};var n=[];a.GloablFilterDefaultValue&&-1==b.chartProp.info.variableId?n=a.GloablFilterDefaultValue.Value:null!=a.DefaultValue&&a.DefaultValue.length>0&&(n=a.DefaultValue),a.DefaultValue=n;var o,p=!0;$(l+" .ui.dropdown").dropdown({onChange:function(a,b,e){c||d()},onRemove:function(a,b,c){d()},onAdd:function(a,b,c){d()},apiSettings:{url:app.urlPrefix+"api/chartdata/GetColumnMembers",cache:!1,method:"post",beforeSend:function(a){var c=_.filter(app.chartCommons.drillDown.filters,function(a){if(!b.input||!b.input.RefreshDatasource)return!1;var c=-1!=b.input.RefreshDatasource.indexOf(a.datasourceId);return c&&a.chartInPageId!=b.ChartInPageId}),d=$.extend([],_.filter(app.chartCommons.userFilter.filters,function(a){if(!b.input||!b.input.RefreshDatasource)return!1;var c=-1!=b.input.RefreshDatasource.indexOf(a.datasourceId);return c}));_.remove(d,{chartInPageId:b.ChartInPageId});var e=JSON.parse(localStorage.getItem("userVariable"))||[];return a.data={chartId:b.chartId,userVariable:e,userControlFilter:d,otherFilters:c,query:a.urlData.query,chartInfo:$("#divChart").data("chartInfo")},a},onResponse:function(a){a.fields=a.fields.map(function(a){return{Key:a.Key.entitize(),Value:a.Value.entitize()}});var b=$(l+" .ui.dropdown").dropdown("get value");return b||(b=[]),_.isArray(b)||(b=[b]),a.fields=a.fields.filter(function(a){return-1==b.indexOf(a.Value)}),a},dataType:"json"},message:{noResults:app.lang.translate("No results found.")},fields:{remoteValues:"fields",name:"Key",value:"Value"},saveRemoteData:!1,forceSelection:!1}),$(l+" .ui.dropdown").dropdown("set selected",n),p=!1}function k(c){if(b.editMode||o||app.chartCommons.userFilter.setFilter({id:c.Id,values:c.Values,variableType:c.VariableType,dimensionName:a.dimensionName,chartInPageId:b.ChartInPageId,datasourceId:a.DataSourceId,disableClear:c.disableClear}),-1==+c.Id)return app.moderation.dashboadpage.refreshRelatedDatasources(a.RefreshDatasource,[+b.ChartInPageId]),void app.filterBox.refresh();c.dimensionName=a.dimensionName,c.datasourceId=a.DataSourceId,c.chartId=a.chartId;var d=app.mobileMode?proxy.ajax:$.ajax,e=app.mobileMode?c:JSON.stringify(c);console.log("### user control ajaxCall init *****************"),d({type:"POST",url:app.urlPrefix+"api/GlobalVariable/SetValueForUser",dataType:"json",contentType:"application/json;charset=utf-8",traditional:!0,data:e,success:function(a){console.log("### user control ajaxCall *****************"),a.result?"undefined"!=typeof b.chartProp.info.variableId&&-1!=b.chartProp.info.variableId?$(".bar-chart").each(function(){var a=$(this).data("settings");"undefined"!=typeof a.input.GlobalVariables&&-1!=a.input.GlobalVariables.indexOf(b.chartProp.info.variableId)&&(a.titlebar.showProgress(!0),$(this).charts(a.type,"refreshWithData",a,{refreshRelatedDatasources:!1}))}):app.mobileMode?app.mobile.filterChanged(a.RefreshDatasource,[+b.ChartInPageId]):(app.moderation.dashboadpage.refreshRelatedDatasources(a.RefreshDatasource,[+b.ChartInPageId]),app.filterBox.refresh()):alert(a.Message)},error:function(a){app.mobileMode&&app.mobile.showToastMessage(a)}})}app.dashboardLayoutVersion=app.dashboardLayoutVersion||2,b.input=a,app.chartCommons.calculateFields(a.series,b.calculatedFields);var l="#"+b.id,m=$(l).width();b.width=m;var n="undefined"==typeof a.lang?!0:0==+a.lang;d.isProgress,d.showProgress,d.title;if(!a.result&&"datepicker"!=b.chartProp.info.type&&"datepicker-range"!=b.chartProp.info.type)return void $("#"+b.id).append(app.chartCommons.getError(a));var o=-1!=b.chartProp.info.variableId;switch(f(),b.chartProp.info.type){case"combo":j();break;case"multi":j(!0);break;case"datepicker":h(!1);break;case"datepicker-range":h(!0);break;case"multi-filter":g();break;case"slider":i();break;case"text":e()}$(l).trigger("heightChange")};