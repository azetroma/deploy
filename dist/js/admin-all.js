/* داشبورد مدیریت صدف 
 sadafdashboard.ir 


*/
// داشبورد مدیریتی صدف info@sadafdashboard.ir 

var manageApp=angular.module("services",["ngMaterial","ngAnimate","ui.sortable","uibCollapseCat"]),ngApp=angular.module("services");ngApp.service("datasources",["$http","$mdMedia","$mdDialog","$compile","$rootScope","$q","$timeout",function(a,b,c,d,e,f,g){function h(){return l||(l=a.get(app.urlPrefix+"api/menus/get")),l}function i(){o={name:"همه",open:!0},p={name:"همه",open:!0}}function j(a,b){var c={type:["charts"],search:["content"],selectableDir:!1,justDir:!1,multipleChart:!0,multipleDatasource:!1};b=angular.extend({},c,b);var h=f.defer();b.deferred=h;var i=$("#asset-picker");if(!i.length){m=e.$new(),m.options=b;var j=d('<select-asset-dialog ng-model="options" ></select-asset-dialog>')(m);angular.element("div[ng-app]").append(j)}return g(function(){i=$("#asset-picker"),m.options=b,m.options.setLastSelect=function(a){n.charts=a.charts},i.modal("show")},1),h.promise}function k(b){var c=app.urlPrefix+"api/OlapChartDesign/CubeInformation?DataSourceId="+b;return a.get(c).then(function(a){return a.data})}var l,m,n={},o={name:"همه",open:!0},p={name:"همه",open:!0};return{get:h,select:j,lastSelected:n,reset:i,getColumns:k}}]),ngApp.directive("selectAssetDialog",[function(){return{scope:{ngModel:"="},controller:["$scope","$mdDialog","$timeout","$http",function(a,b,c,d){function e(b){function e(c){return console.log("search ",c),c?(a.showCharts&&(a.searchProgressChart=!0,d.get(app.urlPrefix+"api/charts/getlist?q="+c+"&parentRole="+b.parentRole).then(function(b){a.searchProgressChart=!1,l&&m?a.searchResultChart=b.data.list:l?a.searchResultChart=_.filter(b.data.list,{type:2}):a.searchResultChart=_.filter(b.data.list,{type:1})})),void(a.showDatasources&&(a.searchProgressDatasource=!0,d.get(app.urlPrefix+"api/datasources/get?q="+c).then(function(b){a.searchProgressDatasource=!1,l&&m?a.searchResultDatasource=b.data.list:l?a.searchResultDatasource=_.filter(b.data.list,{type:2}):searchResultDatasource=_.filter(b.data.list,{type:1})})))):(a.searchResultDatasource=null,void(a.searchResultChart=null))}function f(a,b){b(a),a.nodes&&(_.forEach(a.nodes,function(a){f(a,b)}),_.forEach(a.contents,function(a){f(a,b)}))}var g={name:"همه",open:!0},h={name:"همه",open:!0};a.query=null,a.searchResultDatasource=null,a.searchResultChart=null,a.showCharts=b.type.indexOf("charts")!=-1,a.showDatasources=b.type.indexOf("datasources")!=-1,a.selectedIndex=a.showDatasources?0:1;var i;a.search=function(b,d){c.cancel(i),i=c(function(){e(a.query)},400)},a.cancel=function(){$("#asset-picker").modal("hide")},a.select=function(){var c,d;a.showCharts&&a.showDatasources?(c=0==a.selectedIndex?a.datasources:a.charts,d=0==a.selectedIndex?"datasources":"charts"):a.showDatasources?(c=a.datasources,d="datasources"):(c=a.charts,d="charts");var e=[];a.searchResultDatasource||a.searchResultChart?(e=_.filter("charts"==d?a.searchResultChart:a.searchResultDatasource,{check:!0}),b.setLastSelect({charts:e})):f(c,function(a){a.active&&e.push(a)}),b.deferred.resolve({selected:e,type:d}),$("#asset-picker").modal("hide")};var j=function(a){if(!a.nodes){var c=app.urlPrefix+"api/charts/getlist?packageId="+(a.id||0)+"&parentRole="+(b.parentRole||0);d.get(c).then(function(b){a.loaded=!0,a.nodes=_.filter(b.data.list,{type:1}),a.contents=_.filter(b.data.list,{type:2})})}},k=function(a){if(!a.nodes){var c=app.urlPrefix+"api/datasources/get?packageId="+a.id+"&parentRole="+b.parentRole+"&showSubForms="+b.showSubForms;d.get(c).then(function(b){a.loaded=!0,a.nodes=_.filter(b.data.list,{type:1}),a.contents=_.filter(b.data.list,{type:2})})}};a.optDatasource={urlPrefix:app.urlPrefix+"api/datasources/get?packageId=",multiple:b.multipleDatasource,selectableDir:b.selectableDir,url:k,justDir:b.justDir},a.optChart={urlPrefix:app.urlPrefix+"api/charts/getlist?packageId=",multiple:b.multipleChart,selectableDir:b.selectableDir,url:j,justDir:b.justDir},a.datasources=g,a.charts=h,f(a.datasources,function(a){a.active=!1}),f(a.charts,function(a){a.active=!1}),a.showCharts&&j(a.charts),a.showDatasources&&k(a.datasources);var l=b.search.indexOf("content")!=-1,m=b.search.indexOf("dir")!=-1}a.$watch("ngModel",function(a,b){e(a)})}],template:'<div class="ui modal" id="asset-picker" aria-label="{{\'choose\' | translate}}" >                                                                                                                                 <div class="header">                                                                                                                                                                              <div class="ui form" >                <div class="field icon ui input fluid">                    <input type="text" ng-model="query" ng-change="search()" placeholder="{{\'جستجو\' | translate}}" />                    <i class="icon" title="{{\'clear\' | translate}}" ng-class="{remove: query.length, search: !query}" ng-click="query = null;search();" style="cursor:pointer !important; pointer-events:all !important"></i>                </div>            </div>        </div>                                                                                                                                                                         <div class="content scrolling">                                                                                                                                                                       <div class ="" >                                                                                                                                                    <div class="ui menu secondary pointing" ng-show="showDatasources&&showCharts">                    <div class="pointer item" ng-class="{active: selectedIndex==0}" ng-click="selectedIndex = 0">{{ \'datasources\' | translate }}</div>                    <div class="pointer item" ng-class="{active: selectedIndex==1}" ng-click="selectedIndex=1">{{ \'charts\' | translate }}</div>                </div>                <div >                    <div ng-if="showDatasources" ng-show="selectedIndex==0" >                                                                                                                                         <div class="ui active dimmer inverted" style="position:inherit;" ng-show="searchProgressDatasource">                            <div class="ui active centered inline text loader">                                                                       {{\'searching\' | translate}}                                                                                                                                                       </div>                                                                                                                                                                                </div>                                                                                                                                                                                <div ng-show="searchResultDatasource && !searchResultDatasource.length && !searchProgressDatasource">{{\'search_no_result\' | translate}}</div>                                 <tree ng-show="!searchResultDatasource" ng-model="datasources" option="optDatasource" class ="block"></tree>                                                                          <div ng-show="searchResultDatasource" layout-margin >                                                                                                                                     <div ng-repeat="i in searchResultDatasource">                                                                                                                                             <label><input type="checkbox" ng-model="i.check"/> {{i.name}}</label>                                                                                                                          </div>                                                                                                                                                                            </div>                                                                                                                                                                            </div>                                                                                                                                                                                                                                                                                                                                                                   <div  ng-if="showCharts" ng-show="selectedIndex==1">                                                                                                                                                <div class="ui active dimmer inverted" style="position:inherit;" ng-show="searchProgressChart">                            <div class="ui active centered inline text loader">                                  {{\'searching\' | translate}}                                                                                                                                                       </div>                                                                                                                                                                                </div>                                                                                                                                                                                <div class ="md-caption" layout-padding ng-show="searchResultChart && !searchResultChart.length && !searchProgressChart">{{\'search_no_result\' | translate}}</div>                                           <tree ng-show="!searchResultChart" ng-model="charts" option="optChart" class ="block"></tree>                                                                                         <div ng-show="searchResultChart" layout-margin >                                                                                                                                          <div ng-repeat="i in searchResultChart">                                                                                                                                                  <label><input type="checkbox" ng-model="i.check"/> {{i.name}}</label>                                                                                                                          </div>                                                                                                                                                                            </div>                                                                                                                                                                            </div>                                                                                                                                                                         </div>                                                                                                                                                                        </div>                                                                                                                                                                            </div>                                                                                                                                                                  <div class="actions">                                                                                                                                                          <div class="ui button green" ng-click="select()"> {{\'choose\' | translate}} </div>            <div class="ui button" ng-click="cancel()"> {{\'cancel\' | translate}} </div>        </div>                                                                                                                                                          </div>'}}]),ngApp.directive("collapse",function(){return{restrict:"E",transclude:!0,scope:{title:"@",hideIcon:"@",onTitleClick:"&",model:"=?ngModel",selectableDir:"=?"},controller:["$scope",function(a){var b,c;a.model=a.model||{},this.addHeader=function(d){b=d,b.show=a.model.open,b.click=function(){c&&(a.model.open=!c.show,c.show=!c.show),a.onTitleClick()}},this.addBody=function(b){c=b,c.show=a.model.open},"true"==a.hideIcon&&b&&(b.hideIcon=!0),a.$watch("hideIcon",function(c){"true"==a.hideIcon&&b&&(b.hideIcon=!0)})}],template:"<div ng-transclude><div>"}}).directive("collapseHeader",function(){return{restrict:"E",transclude:!0,require:"^^collapse",scope:{},link:function(a,b,c,d){d.addHeader(a)},template:'<div ng-click="show = !show; click()" class="pointer title">                        <i style="width:30px;" class="ui icon angle left icon-animate" ng-class ="{\'rotate-90\' : show}" ng-style="{\'visibility\': !hideIcon ? \'visible\' : \'hidden\'}" xng-hide="hideIcon"></i>                        <div ng-transclude style="width: calc(100% - 40px); display:inline-block;" ><div>                 </div>'}}).directive("collapseBody",function(){return{restrict:"E",transclude:!0,require:"^^collapse",scope:{},link:function(a,b,c,d){d.addBody(a),a.ready=!1,a.$watch("show",function(b){b&&(a.ready=!0)})},template:'<div class="body" uib-collapse="!show" ng-if="show || ready" style="min-height:unset;" ng-transclude></div>'}}).directive("tree",function(){return{restrict:"E",transclude:!0,scope:{root:"=ngModel",option:"=",url:"&"},controller:["$scope","$http","$translate",function(a,b,c){function d(a,b){b(a),a.nodes&&(_.forEach(a.nodes,function(a){d(a,b)}),_.forEach(a.contents,function(a){d(a,b)}))}a.root=a.root||{name:"root",open:!0},a.active=function(b){var c=b.active;a.option.multiple||d(a.root,function(a){a.active=!1}),b.active=c},a.selectAll=function(a,b){_.each(a.contents,function(a){a.active=b})}}],template:'<div class ="sadaf-tree">    <div style="list-style:none" class ="tree-element ul">        <div ng-repeat="data in [root]" class ="tree-element li" ng-include="\'tree_item_renderer.html\'"></div>    </div></div><script type="text/ng-template" id="tree_item_renderer.html">    <collapse class ="block" selectable-dir="option.selectableDir" ng-model="data"        hide-icon="{{(!data.nodes || !data.nodes.length ) && ( option.justDir || ( !data.contents || !data.contents.length) ) && data.loaded }}">        <collapse-header class ="block" ng-click="$event.stopPropagation(); option.url(data)">            <label ng-show="option.selectableDir" style="margin:0">                 <input type="checkbox" ng-model="data.active"ng-change="active(data)" ng-click="$event.stopPropagation()"/> {{data.name}}</label>            <span ng-show="!option.selectableDir">{{data.name}}</span>        </collapse-header>        <collapse-body class ="block">            <div class ="tree-element ul" style="list-style:none" >                <div class="ui active dimmer inverted" style="position:inherit; display:inline" ng-show="!data.loaded">                     <div class="ui active mini inline text loader">                    </div>                </div>                <div ng-show="data.loaded" class ="tree-element li">                    <label ng-show="option.multiple && data.contents.length" >                         <input type="checkbox" ng-click="$event.stopPropagation()" ng-model="data.selectAll" ng-change="selectAll(data, data.selectAll)"/> <small> {{"select_all" | translate}} </small></label></div>                <div ng-repeat="data in data.nodes" class ="tree-element li" ng-include="\'tree_item_renderer.html\'"></div>                <div ng-repeat="u in data.contents" class ="tree-element li" ng-class ="{active : u.active}" ng-hide="option.justDir">                    <label  style="margin-bottom:0"> <input ng-model="u.active" ng-change="active(u)"type="checkbox" /> {{u.name}}</label>                </div>            </div>        </collapse-body>    </collapse></script>'}}),ngApp.service("chartComments",["$http",function(a){function b(b,c){return a.post(app.urlPrefix+"api/ChartComments/save/"+b,c).then(function(a){return a.data})}return{save:b}}]);var sApp=angular.module("services");sApp.service("menus",["$http",function(a){function b(b){return f||(f=a.get(app.urlPrefix+"api/menus/get"+(b?"?JustEdit=true":""))),f}function c(b){return a.get(app.urlPrefix+"api/menus/getMenu/"+b)}function d(b){return a.post(app.urlPrefix+"api/menus/save/",b)}function e(c){return c?a.get(app.urlPrefix+"api/menus/get?ParentId="+c):b()}var f;return{get:b,save:d,getMenu:c,getParentMenu:e,getEditable:function(){return b(!0)}}}]),sApp.service("mainmenus",["$http",function(a){function b(b){_.isNaN(+b)&&(b=0);var c=a.get(app.urlPrefix+"api/mainmenus/get/"+b);return c}function c(b){return a.post(app.urlPrefix+"api/mainmenus/save",b)}function d(b){return a.post(app.urlPrefix+"api/mainmenus/delete/"+b)}function e(b){return a.get(app.urlPrefix+"api/mainmenus/search/"+b)}function f(b,c){return a.post(app.urlPrefix+"api/mainmenus/savePermissions/"+b,c)}return{get:b,save:c,remove:d,search:e,savePermissions:f}}]),sApp.service("menuCategories",["$http",function(a){function b(){return f||(f=a.get(app.urlPrefix+"api/menuCategories/get")),f}function c(b){return a.post(app.urlPrefix+"api/mainmenus/save",b)}function d(b){return a.post(app.urlPrefix+"api/mainmenus/delete/"+b)}function e(b){return a.get(app.urlPrefix+"api/mainmenus/search/"+b)}var f;return{get:b,save:c,remove:d,search:e}}]),sApp.service("mostRecentMenus",["$http",function(a){function b(){var b=a.get(app.urlPrefix+"api/mostRecentMenus/get");return b}function c(b){return a.post(app.urlPrefix+"api/mainmenus/delete/"+b)}return{get:b,remove:c}}]),sApp.service("favoriteMenus",["$http",function(a){function b(){var b=a.get(app.urlPrefix+"api/favoriteMenus/get");return b}function c(b){return a.post(app.urlPrefix+"api/mainmenus/delete/"+b)}return{get:b,remove:c}}]);var ngApp=angular.module("services");ngApp.service("roles",["$http",function(a){function b(){return e||(e=a.get(app.urlPrefix+"api/roles/get")),e}function c(){e=null}function d(a){function b(a,c){if(a.id==c.id)return a;if(_.isArray(a.nodes))for(var d=0;d<a.nodes.length;d++){var e=b(a.nodes[d],c);if(null!=e)return e}return null}var c=performance.now(),d={name:"root",nodes:[],contents:[]};_.each(a,function(b){var c=_.find(a,{id:b.parent});c||(b.parent=0)});var e=[].concat(a);_.each(e,function(a){a.nodes=[]});for(var f=0,g=e.length*e.length;e.length&&(f++,!(f>g));){var h=e.pop();if(h.parent){var i=b(d,{id:h.parent});i?(i.nodes=i.nodes||[],i.nodes.push(h)):e.unshift(h)}else d.nodes.push(h)}return console.log("time",performance.now()-c),d.open=!0,d}var e;return{get:b,reset:c,createTree:d}}]),ngApp.directive("selectRoles",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",settings:"=?"},controller:["$scope","$http","roles",function(a,b,c){a.model=a.model||[],a.settings=a.settings||{},c.get().then(function(b){a.roles=_.extend([],b.data.list)})}],template:'<div>                     <sm-dropdown class="selection search multiple fluid"  settings="{fullTextSearch: true}" model="model" items="roles" label="item.name" value="item.id" ></sm-dropdown>                   </div>',link:function(a,b,c){}}}),function(a){function b(a,c){a&&(a.check&&c.push({id:a.id,action:a.action}),_.each(a.nodes,function(a){b(a,c)}))}var c=angular.module("services");c.directive("datasourcePermission",["$timeout","$http","roles",function(a,c,d){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/datasource/datasourcePermission.html?v="+app.version,scope:{roles:"=ngModel",conf:"=?conf",id:"@",type:"@"},controller:["$scope","$http",function(a,c){function e(b,d){var e=app.urlPrefix+"api/permissions/getDatasourcePermissions?id="+b;switch(d){case"datasource":e=app.urlPrefix+"api/permissions/getDatasourcePermissions?id="+b;break;case"chart":e=app.urlPrefix+"api/permissions/getChartPermissions?id="+b;break;case"menu":e=app.urlPrefix+"api/permissions/getMenuPermissions?id="+b;break;case"mainmenu":e=app.urlPrefix+"api/permissions/getMainmenuPermissions?id="+b}a.getPermissionProgress=!0,c.get(e).then(function(b){a.getPermissionProgress=!1,a.permissions=b.data.list,f()})["catch"](function(){a.getPermissionProgress=!1})}function f(){a.permissions&&a.roles&&_.forEach(a.roles,function(b){b.check=!1;var c=_.find(a.permissions,{roleId:b.id});c&&(b.action=1==c.actionSum?1:3==c.actionSum?2:4,b.check=!0,_.isArray(c.extra)&&(b.extra=c.extra.slice()))})}var g=a.type&&"datasource"!==a.type?"chart"===a.type?"chart":"mainmenu"===a.type?"mainmenu":"menu":"datasource";a.roles&&a.roles.length||(d.get().then(function(b){a.roles=angular.merge({},b.data.list),_.forEach(a.roles,function(a){a.action=1,a.check=!1}),f();var c=_.filter(a.roles,null);a.root=d.createTree(c)}),a.$watch("root",function(c){var d=[];b(a.root,d),_.each(a.roles,function(a){var b=_.find(d,{id:a.id});a.check=null!=b,a.check&&(a.action=b.action)})},!0)),+a.id&&e(+a.id,g),a.$watch("conf.id",function(a,b){a&&e(a,g)})}]}}])}(jQuery);
// داشبورد مدیریتی صدف info@sadafdashboard.ir 

var cal=angular.module("calendar",[]),ngApp=angular.module("sadafForms",["iframeCommunicate","ng-sortable","services","calendar","semantic-ui","ngRoute","ui.sortable","pascalprecht.translate","ngSanitize","uibCollapseCat","ngFileUpload","ngQuill","vs-repeat"]);ngApp.config(["$translateProvider",function(a){a.useStaticFilesLoader({prefix:app.urlPrefix+"dist/locales/locale-",suffix:".js"}),a.preferredLanguage("fa"),a.useSanitizeValueStrategy("sanitizeParameters")}]),ngApp.config(["$compileProvider",function(a){a.debugInfoEnabled(!1),a.commentDirectivesEnabled(!1),a.cssClassDirectivesEnabled(!1)}]),ngApp.config(["ngQuillConfigProvider",function(a){var b=Quill["import"]("attributors/style/size");b.whitelist=["12px","14px","16px","18px","20px","24px","28px","32px","38px","48px","72px"],Quill.register(b,!0),a.set({placeholder:"متن را وارد کنید",theme:"snow"})}]),ngApp.config(["$routeProvider","$locationProvider",function(a,b){a.when("/forms/list",{templateUrl:app.urlPrefix+"dist/partial/forms/editor/form-generator-list.html?v="+app.version,controller:"fromsCtrl",controllerAs:"c"}).when("/forms/:id?",{templateUrl:app.urlPrefix+"dist/partial/forms/editor/form-generator-editor.html?v="+app.version,controller:"fromGeneratorCtrl",controllerAs:"c"})}]);var iframeCommunicate=angular.module("iframeCommunicate",[]);iframeCommunicate.service("iframeService",["$location","$http",function(a,b){return{setPath:function(a){window.location.href=app.urlPrefix+a,console.log("### [iframeService] window.location.href ",app.urlPrefix+a)},handleMessage:function(a){console.log("handleMessage",a),$this=this,"route"===a.type&&this.setPath(a.param),"action-call"===a.type&&b.get(a.param),"set-variable"===a.type&&(_.isArray(a.param.userVariables)&&localStorage.setItem("userVariable",JSON.stringify(a.param.userVariables)),$this.setPath(a.param.url))}}}]);var ngApp=angular.module("sadafForms");ngApp.directive("versions",function(){return{restrict:"E",scope:{id:"@id",subId:"@?subId",type:"@type",justRestore:"@",onRestore:"&",onDetail:"&?","class":"@"},controller:["$scope","versionsSvr",function(a,b){a.app=app,a.moment=moment,b.get(a.id,a.type,a.subId||0).then(function(b){a.list=b.data.list,_.each(a.list,function(a){a.time=0===a.updateDate?"":moment.utc(a.timestamp).format("jYYYY/jMM/jDD HH:mm:ss")})})["catch"](function(a){}),a.inlineRestore="undefined"!=typeof a.justRestore,a.showDetail=function(c){b.detail(c.id).then(function(b){if(a.onDetail){var c=b.data;return _.isString(c)&&(c=JSON.parse(c)),void a.onDetail({model:c})}a.showDetailFlag=!0,a.detail=JSON.parse(b.data)})["catch"](function(a){alert("دریافت با خطا مواجه شده است"),console.log(a)})},a.remove=function(c,d){var e=confirm("آیا برای حذف این رکورد اطمینان دارید؟");e&&b.remove(c.id).then(function(b){a.list.splice(d,1)})["catch"](function(){alert("عملیات با خطا مواجه شده است")})},a.restore2=function(c){if(a.onRestore){var d=confirm("آیا برای بازگردانی اطمینان دارید؟");if(!d)return;b.detail(c.id).then(function(b){a.detail=JSON.parse(b.data),a.onRestore({model:a.detail})})["catch"](function(a){alert("دریافت با خطا مواجه شده است"),console.log(a)})}},a.restore=function(){if(a.onRestore){var b=confirm("آیا برای بازگردانی اطمینان دارید؟");if(!b)return;a.onRestore({model:a.detail})}},a.cancelDetail=function(){a.showDetailFlag=!1}}],templateUrl:app.urlPrefix+"dist/partial/management/directives/versions.html?v="+app.version}}),angular.module("services").service("versionsSvr",["$http",function(a){function b(b,c,d){return a.get(app.urlPrefix+"api/versions/get?id="+b+"&type="+c+"&subId="+d)}function c(b){return a.get(app.urlPrefix+"api/versions/detail/"+b)}function d(b){return a.get(app.urlPrefix+"api/versions/remove/"+b)}return{get:b,detail:c,remove:d}}]);var ngApp=angular.module("sadafForms");ngApp.directive("sadafForm",function(){return{scope:{id:"@",rowId:"@?",onCancel:"&?",onFinish:"&?",onSave:"&?",option:"=?",settings:"=?"},controller:["$scope","$http","$sce","$routeParams","$timeout","$q","formsService","formsSubmitService","$attrs","taskExecutor",function($scope,$http,$sce,$routeParams,$timeout,$q,formsService,formsSubmitService,$attrs,taskExecutor){function executeTask(a){}function changeDigitType(a){_.each(a,function(a){rec(a.controls,function(a){2==a.type&&null!=a.value&&a.value&&(a.value=+a.value)})})}function rec(a,b){_.each(a,function(a){b(a),13==a.type&&_.each(a.multiRowForm.rows,function(a){rec(a,b)})})}function getFormData(){$scope.clearForm(),$scope.rowId&&0!==+$scope.id&&($scope.formLoading=!0,$scope.showVersion=!0,formsSubmitService.get($scope.id,$scope.rowId).then(function(a){changeDigitType(a.model.pages),$scope.editPermission=a.editPermission,$scope.addPermission=a.addPermission,$scope.deletePermission=a.deletePermission,$timeout(function(){$scope.data&&$scope.data.pages&&($scope.data.pages=[])},0),$timeout(function(){$scope.data=a.model,$scope.baseData=JSON.parse(JSON.stringify(a.model)),$scope.data.id=a.id,$scope.data.rowId=$scope.rowId,$scope.modelId=a.id,$scope.allControl=[],$scope.allControlMap={},runOnAllControll($scope.data,function(a,b,c,b,d){a.uiConfig=JSON.parse(a.uiConfigSerialized||"{}"),$scope.allControl.push(a),d||($scope.allControlMap[a.name]=a),2==a.type&&null!=a.value&&(a.value=+a.value)},initPageRun),console.log("##### all control",$scope.allControlMap),serverDataProcess()},250),$timeout(function(){$scope.formLoading=!1},1500)},function(){$scope.formLoading=!1}))}function serverDataProcess(){updateCalculated()}function setDefaultFunction(a){"today"===a.defaultFunction&&9===a.type&&(a.value=depersian(moment().format("jYYYY/jMM/jDD"))),"today"===a.defaultFunction&&14===a.type&&(a.value=depersian(moment().format("jYYYY/jMM/jDD")+" 00:00:00"))}function initPageRun(a){a.canView=!0,a.canEdit=!0}function getFormEmptyData(){$scope.clearForm(),$scope.formLoading=!0,formsService.get($scope.id).then(function(a){$timeout(function(){$scope.formLoading=!1},1500),$scope.data=_.merge({},a.model),$scope.editPermission=a.editPermission,$scope.deletePermission=a.deletePermission,$scope.addPermission=a.addPermission,changeDigitType(a.model.pages),$scope.allControl=[],$scope.allControlMap={},runOnAllControll($scope.data,function(a,b,c,d,e){setDefaultFunction(a),a.uiConfig=JSON.parse(a.uiConfigSerialized||"{}"),$scope.allControl.push(a),e||($scope.allControlMap[a.name]=a),a&&2==a.type&&a.validations&&a.validations.autoIncrement&&(autoIncMap[a.name]=autoIncMap[a.name]||+a.value)},initPageRun),serverDataProcess()},function(){$scope.formLoading=!1})}function findControl(a,b){var c=null;return runOnAllControll(b,function(b){if(b.name===a||b.columnName===a)return c=b,!1}),c}function runOnAllControll(a,b,c){function d(a){_.each(a,function(c){13===c.type&&_.each(c.multiRowForm.rows,function(a,c){var f=[];_.each(a,function(a){22==a.type&&a.controlGroup&&(f=f.concat(a.controlGroup.controls||[]))}),f=f.concat(a),_.each(f,function(a){var d=!0;try{"field-449"==a.name,d=b(a,f,c,e,!0)}catch(g){console.log(g)}if(d===!1)return!1}),d(f)});try{var f=b(c,a,void 0,e,!1);if(f===!1)return!1}catch(g){console.log(g)}})}if(a){var e=[];_.each(a.pages,function(a){try{c&&c(a)}catch(b){console.log(b)}a&&_.isArray(a.controls)&&(e=e.concat(a.controls))});var f=[];_.each(e,function(a){22==a.type&&a.controlGroup&&(f=f.concat(a.controlGroup.controls||[]))}),e=e.concat(f),d(e)}}function GetMultiRowControlBaseOnChildName(a){var b;return runOnAllControll($scope.data,function(c){if(13==c.type){var d=_.findIndex(c.multiRowForm.rows[0],{name:a});d!=-1&&(b={control:c,index:d})}}),b}function calcFlatFormula(f,rowControls,rowIndex,pagesControls,dataType){function handleControl(a,b,c){var d=!1;if(a||(d=!0,b.push({isnull:null,type:"digit",value:0}),a={}),8==a.type){d=!0;var e="00:00";a.value&&(e=a.value.substring(0,5)),b.push({isnull:null===a.value,type:"millisecond",value:moment.duration(e).asMilliseconds()})}if(9==a.type&&"string"!=c){d=!0;var e="1300/0/01";a.value&&(e=a.value),b.push({isnull:null===a.value,type:"millisecond",value:1e3*moment(e,"jYYYY/jMM/jDD").utc().unix()})}if(14==a.type){d=!0;var e="1300/0/01 00:00:00";a.value&&(e=a.value),b.push({isnull:null===a.value,type:"millisecond",value:1e3*moment(e,"jYYYY/jMM/jDD HH:mm:ss").utc().unix()})}(2==a.type||5==a.type&&"digit"==a.calcType||16==a.type&&"digit"==a.calcType)&&(d=!0,b.push({isnull:null===a.value,type:"digit",value:+a.value||0})),4==a.type&&(d=!0,b.push({isnull:null===a.value,type:"text",value:"'"+a.value+"'"})),(5==a.type&&"millisecond"==a.calcType||16==a.type&&"millisecond"==a.calcType)&&(d=!0,b.push({isnull:null===a.value,type:"millisecond",value:a.calculate.calculatedValue})),d||b.push({isnull:null===a.value,type:"text",value:"'"+a.value+"'"})}var params=[],r=f.replace(/\[(field-\d+)\]\[(.*?)\]\[(field-\d+)\]/gi,function(a,b,c,d){var e=GetMultiRowControlBaseOnChildName(d);if(e){"index"==c&&(c=rowIndex);var f=null;return e.control.multiRowForm.rows.length>c&&(f=e.control.multiRowForm.rows[c][e.index]),handleControl(f,params,dataType),"{"+(params.length-1)+"}"}return""}),r=r.replace(/\[(field-\d+)\]/gi,function(a,b,c){var d=_.find(rowControls,{name:b});return d||(d=_.find(pagesControls,{name:b})),handleControl(d,params,dataType),"{"+(params.length-1)+"}"}),newR=r.replace(/\{(\d+)\}/gi,function(a,b,c){return" "+params[+b].value+" "}),haveDate=_.filter(params,function(a){return"millisecond"==a.type||"millisecond"==a.type||"millisecond"==a.type}).length>0,haveDigit=_.some(params,{type:"digit"}),isnull=!1;if(_.find(params,{isnull:!0})&&(isnull=!0),haveDate){var v=moment.duration(+eval(newR)).format("d روز و h ساعت و m دقیقه");return{value:isnull?null:v,calculatedValue:isnull?null:+eval(newR),type:"millisecond"}}var v=eval(newR),type="text";return _.isNaN(+v)||(v=+v,type="digit"),{value:isnull?null:v,calculatedValue:isnull?null:v,type:type}}function checkAccessRule(a,b,c){if(1==a.baseon){var d=$scope.allControlMap[a.control];d||(d=_.find(b,{name:a.control}));var e=checkSameRow(d,c);d&&e&&(a.result=_.trim(d.value)==_.trim(a.value))}2==a.baseon}function checkAccessOfControl(a,b,c){_.each(a.access,function(a){checkAccessRule(a,b,c)});var d=_.filter(a.access,{type:1}),e=(_.filter(a.access,{type:2}),_.filter(a.access,{result:!0,type:1}));_.filter(a.access,{result:!0,type:2});"undefined"==typeof a.canViewOrg&&(a.canViewOrg=a.canView),"undefined"==typeof a.canEditOrg&&(a.canEditOrg=a.canEdit),a.canView=!0,d.length&&(a.canView=!1),e.length&&(a.canView=!0)}function checkSameRow(a,b){var c=!0;return!a||!b||("undefined"==typeof a.rowIndex&&"undefined"==typeof b.rowIndex||(c=!1,a.rowIndex==b.rowIndex&&(c=!0)),c)}function updateCalculated(changedControl){function pageRun(a){a.access&&a.access.length&&checkAccessOfControl(a)}console.log("#### [updateCalculated]"),runOnAllControll($scope.data,function(control,rowControls,rowIndex,pagesControls){if(13!=control.type||control.setDefaultFunction||(control.setDefaultFunction=setDefaultFunction),control.access&&control.access.length&&checkAccessOfControl(control,rowControls,changedControl),5==control.type)try{var o=calcFlatFormula(control.calculate.expression,rowControls,rowIndex,pagesControls,control.dataType);control.value=o.value,control.formula=o.formula,control.calcType=o.type,control.calculate.calculatedValue=o.calculatedValue}catch(e){control.value="Error!",console.error("#### Error calcFlatFormula",control.name,control.label,o),console.log(e)}if(4==control.type&&control.dropdown.useFormula)try{var c=GetMultiRowControlBaseOnChildName(control.dropdown.formula);if(c){var items=_.map(c.control.multiRowForm.rows,function(a){var b=a[c.index].value;return{value:b,label:b}});items=_.filter(items,function(a){return""!=a.value&&null!=a.value}),items=_.uniqBy(items,"value"),items.length&&(control.dropdown.items=items)}else{var o=calcFlatFormula("["+control.dropdown.formula+"]",rowControls,rowIndex,pagesControls);control.dropdown.items=[{value:o.value,label:o.value}]}}catch(e){control.value="Error!",console.error("#### Error calcFlatFormula",control.name,control.label,o),console.log(e)}if(16==control.type){var regex=/\s*(sum|avg|max|min|var)\s*\(([^\)]+)\)\s*/gi,hasDurationFormat=!1,r=control.calculate.expression.replace(regex,function(a,b,c){var d=[],e=c.replace(/.*\[(field-\d+)\].*/gi,"$1"),f=GetMultiRowControlBaseOnChildName(e);if(!f)return"از فیلدهای مربوط به فرم چند ردیفه باید استفاده شود";_.each(f.control.multiRowForm.rows,function(a){var b=calcFlatFormula(c,a);"digit"!=b.type?(hasDurationFormat=!0,d.push(b.calculatedValue||0)):d.push(b.value||0)});var g=0;return"min"===b&&(g=d3.min(d)),"max"===b&&(g=d3.max(d)),"sum"===b&&(g=d3.sum(d)),"avg"===b&&(g=d3.mean(d)),"var"===b&&(g=d3.variance(d))," "+g+" "});if(hasDurationFormat){var v=moment.duration(+eval(r)).format("d روز و h ساعت و m دقیقه");control.value=v,control.calculate.calculatedValue=+eval(r),control.calcType="millisecond"}else try{control.value=+eval(r).toFixed(5),control.calculate.calculatedValue=+eval(r)}catch(e){control.value=r}}if(17==control.type){var forwatch=_.find(rowControls,{name:control.tableLookup.controlName});if(!forwatch)return void(model.value=null);var v=[];if(forwatch.dropdown&&forwatch.dropdown.listValue&&forwatch.dropdown.listValue.length?v.concat(forwatch.dropdown.listValue):forwatch.value&&v.push(forwatch.value),control.tableLookup.lastV&&v.length==control.tableLookup.lastV.length&&0==_.difference(v,control.tableLookup.lastV).length)return;control.tableLookup.lastV=v,control.inProgress=!0,formsService.tableLookup(control.tableLookup,v).then(function(a){control.inProgress=!1,a&&a.length&&(control.value=a[0].value,control.tableLookup.label=a[0].label)})}control.useFilter&&control.filters&&control.filters.length&&_.map(control.filters,function(a){if(2===a.type){if(changedControl&&changedControl.name==a.control){var b=checkSameRow(changedControl,control);console.log("### changedControl ",b,changedControl.rowIndex,changedControl.name,changedControl.value),b&&(control.value=null,control.listValue=null)}"field-6"==control.name;var c=_.find(rowControls,{name:a.control});c||(c=findControl(a.control,$scope.data)),c&&(12===c.type?a.controlValue=c.value:a.controlValue!==c.value&&(a.controlValue=c.value))}})},pageRun)}var c=this;$scope.selector="selector-"+Math.floor(999999*Math.random()+1e6),$scope.option=$scope.option||{},$scope.onCancel=$scope.onCancel||function(){};var id=$scope.id;$scope.submittedStatus=0,$scope.formLoading=!0,$scope.activePage=0,$scope.app=app,$scope.changeValue=function(a){a&&(console.log("### change value ",a.name,a.label,a.value,a.rowIndex,a),updateCalculated(a))},$scope.print=function(){function getControlValue(a,b){if(!a)return"";if(12===a.type&&_.isArray(a.formLookup.keyControlsBindedValue)){var c=a.formLookup.keyControlsBindedValue[0];return a.formLookup.keyControlsBindedText&&(c=a.formLookup.keyControlsBindedText[0]),c}var d=a.value;if(17===a.type&&(d=a.tableLookup.label),6===a.type&&(d=a.value?"بله":"خیر"),4===a.type&&(_.isArray(a.dropdown.selected)?d=a.dropdown.selected.join(", "):_.isArray(a.dropdown.listValue)&&(d=a.dropdown.listValue.join(", "))),"undefined"==typeof d)return"";if(a.format&&!_.isNaN(+d)&&b){var e=a.format;"custom"===e&&(e=a.customFormat),d=d3.format(e)(d)}return 20!==a.type&&b&&(d=persian(d,!0)),null===d?"":d}function getValue(a,b){return a=a.replace(/\[(.*?)\]/gi,function(a,c){var d=findControl(c,$scope.data);return d?getControlValue(d,b):a}),a.replace(/@(field-\d+)/gi,function(a,c){var d=findControl(c,$scope.data);return getControlValue(d,b)})}function replaceCalcExp(content){return content=content.replace(/calc\{\{((.|[\r\n])*?)\}\}/gim,function(match,p1){var c=getValue(p1,!1);try{return persian(eval(c),!0)}catch(e){return console.log(e),console.log(c),"Error: "+e.message}}),content=content.replace(/each\(@(.*?)\)\{\{((.|[\r\n])*?)\}\}/gim,function(a,b,c){var d=findControl(b,$scope.data),e=_.map(d.multiRowForm.rows,function(a){return c.replace(/@(field-\d+)/gi,function(b,c){var d=_.find(a,{name:c});return getControlValue(d,!1)})});return e.join("")})}var content=replaceCalcExp($scope.data.printLayout);content=getValue(content,!0),app.print.print(content,getValue($scope.data.printFileName||$scope.data.name),$scope.data.printOrientation,$scope.data.printPage)},$scope.setActivePage=function(a){$scope.activePage=a},$scope.isValid=function(){var a=!1;if($scope.data&&$scope.data.pages)a:for(var b=0;b<$scope.data.pages.length;b++)for(var c=0;c<$scope.data.pages[b].controls.length;c++){var d=$scope.data.pages[b].controls[c];if(12==d.type&&!d.isValid){a=!0;break a}}return a},$scope.submit=function(a){$scope.loading!==!0&&($scope.loading=!0,$scope.clearAllErrors(),$scope.batch&&$scope.batch.command&&($scope.data.filters={command:$scope.batch.command,chartInPageId:$scope.batch.settings.ChartInPageId,otherFilters:$scope.batch.settings.parameters.otherFilters,userControlFilter:$scope.batch.settings.parameters.userControlFilter}),formsSubmitService.submit($scope.id,$scope.data).then(function(b){if($scope.loading=!1,$scope.submittedStatus=0,!b.result&&b.messages&&($scope.pagesContainError=$scope.pagesContainError||[],$scope.pagesContainError=_.map(b.messages,function(a){return a.error}),_.each(b.messages,function(a){var b=findControl(a.name,$scope.data);b&&(b.error=a.error)})),!b.result&&b.pageMessages&&_.each(b.pageMessages,function(a){var b=_.find($scope.data.pages,{name:a.name});b&&(b.error=a.error)}),b.result){0==+$scope.rowId,$scope.data;_.each(autoIncMap,function(a,b){autoIncMap[b]=a+1}),$timeout(function(){$("#"+$scope.selector+" .close-btn").focus()},0),a?($scope.saveAndCopy=!0,$timeout(function(){$scope.saveAndCopy=!1},2e3),_.each($scope.data.pages,function(a){_.each(a.controls,function(a){19===a.type&&(a.attachment=null),a.rowId=null})})):$scope.data.showSubmitedInfo?($scope.submittedStatus=1,runOnAllControll($scope.data,function(a){a.readonly=!0})):$scope.submitNewInfo(),$scope.onSave&&$scope.onSave({data:b});var c=$("#"+$scope.selector).data("callback");c&&c.result(b)}},function(a){a.data.title&&a.data.desc?$scope.error={title:a.data.title,desc:a.data.desc}:$scope.error=null,$scope.loading=!1,$scope.submittedStatus=2}))},$scope.submitAndCopy=function(){$scope.submit(!0)},$scope.submitNewInfo=function(){$scope.submittedStatus=0,runOnAllControll($scope.data,function(a){a.readonly=!1}),$scope.onFinish&&$scope.onFinish(),$scope.clearForm(),formsService.clearCache($scope.id)},$scope.clearAllErrors=function(){$scope.pagesContainError=[],runOnAllControll($scope.data,function(a){a.error=null},function(a){a.error=null})};var autoIncMap={};$scope.clearForm=function(){$scope.submittedStatus=0,$scope.activePage=0,$scope.showVersion=!1,runOnAllControll($scope.data,function(a){return a&&2==a.type&&a.validations&&a.validations.autoIncrement?void(a.value=autoIncMap[a.name]):(a.value=null,a.dropdown&&(a.dropdown.listValue=null),a.value=null,a.dropdown&&(a.dropdown.listValue=null),13==a.type&&a.multiRowForm.rows.splice(0,a.multiRowForm.rows.length-1),void setDefaultFunction(a))})},$scope.cancel=function(){$scope.submitNewInfo()},$scope.remove=function(){var a=confirm("آیا برای حذف اطلاعات جاری فرم اطمینان دارید؟");a&&formsSubmitService.remove($scope.id,$scope.rowId).then(function(){$scope.onCancel(),$scope.submitNewInfo()},function(a){a.data.title&&a.data.desc&&alert(a.data.desc)})},!$scope.rowId&&$scope.id&&getFormEmptyData(),$scope.settings&&($scope.settings.notify=function(a,b,c,d){if($scope.rowId=b,$scope.id=a,$scope.batch={command:c,settings:d},"delete-all"===c){var e=confirm("با تایید این گزینه تمامی رکوردهایی که در جدول مشاهده میکنید حذف خواهند شد. آیا برای حذف اطمینان دارید؟");e&&$http.post(app.urlPrefix+"api/formssubmit/DeleteAll/"+a,{filters:{command:$scope.batch.command,chartInPageId:$scope.batch.settings.ChartInPageId,otherFilters:$scope.batch.settings.parameters.otherFilters,userControlFilter:$scope.batch.settings.parameters.userControlFilter}}).then(function(a){app.moderation.dashboadpage.refreshRelatedDatasources(a.data.RefreshDatasource)})}else{if(0===+$scope.id)return;$scope.allControl=null,$scope.rowId?getFormData():getFormEmptyData()}}),$scope.colseBtn=function(a){(a.ctrlKey&&13===a.keyCode||27===a.keyCode)&&$scope.submitNewInfo()},$scope.backToBaseVersion=function(){$scope.setValue($scope.baseData),$scope.versionRestore=!1,runOnAllControll($scope.data,function(a){a.readonly=!1,a.highlight=!1})},$scope.setValue=function(a){$scope.versionRestore=!0,runOnAllControll($scope.data,function(a){a.readonly=!0}),runOnAllControll(a,function(a){var b=findControl(a.name,$scope.data);if(b&&(b.value!=a.value&&(b.highlight=!0),b.value=a.value,b.dropdown&&a.dropdown&&(b.dropdown.listValue!=a.dropdown.listValue&&(b.highlight=!0),b.dropdown.listValue=a.dropdown.listValue,$scope.$broadcast("dropdown-getonline-default",b)),b.formLookup&&a.formLookup&&(b.formLookup.keyControlsBindedValue!=a.formLookup.keyControlsBindedValue&&(b.highlight=!0),b.formLookup.keyControlsBindedValue=a.formLookup.keyControlsBindedValue,$scope.$broadcast("formLookup-set-default",b)),13===b.type&&b.multiRowForm&&a.multiRowForm)){b.reversionDeletedIds||(b.reversionDeletedIds=b.multiRowForm.rows.map(function(a){return a[0].rowId})),b.multiRowForm.deletedIds=b.reversionDeletedIds;var c=_.merge([],b.multiRowForm.rows[0]);b.multiRowForm.rows=[],_.each(a.multiRowForm.rows,function(a){var d=_.merge([],c);_.each(d,function(b,c){var d=a[c];b.value=d.value,b.rowId=0,b.dropdown&&d.dropdown&&(b.dropdown.listValue!=d.dropdown.listValue&&(b.highlight=!0),b.dropdown.listValue=d.dropdown.listValue,$scope.$broadcast("dropdown-getonline-default",b)),b.formLookup&&d.formLookup&&(b.formLookup.keyControlsBindedValue!=d.formLookup.keyControlsBindedValue&&(b.highlight=!0),b.formLookup.keyControlsBindedValue=d.formLookup.keyControlsBindedValue,$scope.$broadcast("formLookup-set-default",b))}),b.multiRowForm.rows.push(d)})}})}}],restrict:"AE",templateUrl:app.urlPrefix+"dist/partial/forms/form-render.html?v="+app.version}}),ngApp.service("formsSubmitService",["$http",function(a){var b=function(b,c){return a.get(app.urlPrefix+"api/formsSubmit/getData/"+b+"?rowId="+c).then(function(a){a.data.model.modalSize||(a.data.model.modalSize="large");var b=a.data;return a.data.editPermission||_.each(b.model.pages,function(a){_.each(a.controls,function(a){a.readonly=!0})}),b})},c={};c.CONTROL_TYPE_TEXT_SINGLE_LINE=0,c.CONTROL_TYPE_TEXT_MULTI_LINE=1,c.CONTROL_TYPE_NUMBER=2,c.CONTROL_TYPE_TEXT_LABEL=3,c.CONTROL_TYPE_DROP_DOWN=4,c.CONTROL_TYPE_CALCULATE=5,c.CONTROL_TYPE_CHECKBOX=6,c.CONTROL_TYPE_MULTI_CHOISE=7,c.CONTROL_TYPE_TIME=8,c.CONTROL_TYPE_DATE=9,c.CONTROL_TYPE_PHOTO=10,c.CONTROL_TYPE_LINK=11,c.CONTROL_TYPE_FORM_LOOKUP=12,c.CONTROL_TYPE_MULTI_ROW=13,c.CONTROL_TYPE_DATE_TIME=14,c.CONTROL_TYPE_BUTTON=15,c.CONTROL_TYPE_CALCULATE_SUM=16,c.CONTROL_TYPE_FILE_ATTACHMENT=19;var d=function(b,c){return a.post(app.urlPrefix+"api/formssubmit/submit/"+b,c).then(function(a){return app.moderation.dashboadpage.refreshRelatedDatasources(a.data.RefreshDatasource),a.data})},e=function(b,c){return a.post(app.urlPrefix+"api/formssubmit/delete/"+b,c).then(function(a){return app.moderation.dashboadpage.refreshRelatedDatasources(a.data.RefreshDatasource),a.data})};return{submit:d,remove:e,get:b}}]),ngApp.directive("selectForm",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{onSelect:"&",settings:"=?"},controller:["$scope","$http","formsService",function(a,b,c){a.model=a.model||[],a.settings=a.settings||{},c.get().then(function(b){a.forms=b}),a.opt={closable:!1,onApprove:function(){return a.model&&a.model.length?(a.onSelect({forms:a.model,settings:a.settings}),!1):(alert("حداقل یک مورد باید انتخاب شود"),!1)}}}],template:'<div>                   <sm-modal visible="settings.visible" settings="opt">                        <div class="header">انتخاب فرم</div>                        <div class="content">                            <p>لطفا فرم‌های مورد نظر خود را انتخاب کنید</p>                            <div class="ui form">                                <div class="field">                                    <label>انتخاب فرم</label>                                    <sm-dropdown class="selection search multiple"  settings="{fullTextSearch: true}" model="model" items="forms" label="item.name" value="item" ></sm-dropdown>                                </div>                            </div>                        </div>                        <div class="actions">                            <div class="ui black deny button">لغو</div>                            <div class="ui positive button" ng-class="{loading: settings.loaging}" >اضافه کردن</div>                        </div>                    </sm-modal>                    </div>',link:function(a,b,c){}}}),function(){function getFormat(a){var b=a.format;return"custom"===a.format&&(b=a.customFormat||""),b}function getDatasourceColumns(a,b){if(a)return b.getColumns(a).then(function(a){return a.CubeInfo.Dimensions[0].Hierarchies})}function stringToUnix(a,b){return b?1e3*moment(a,"YYYY/MM/DD").unix():1e3*moment(a,"jYYYY/jMM/jDD").unix()}function unixToString(a,b,c){var d;return d=c?moment.unix(a/1e3).format(b):new persianDate(a).format(b||"YYYY/MM/DD"),depersian(d)}function findControl(a,b){var c=null;return runOnAllControll(b,function(b){if(b.name===a)return c=b,!1}),c}function runOnAllControll(a,b,c){console.log("### runOnAllControll");var d=[];_.each(a,function(a){c&&c(a),a&&_.isArray(a.controls)&&(d=d.concat(a.controls))});var e=[];_.each(d,function(a){22==a.type&&(a.controlGroup.controls=a.controlGroup.controls||[],e=e.concat(a.controlGroup.controls||[]))}),d=d.concat(e),_.each(d,function(a,c){13===a.type&&a.multiRowForm&&_.each(a.multiRowForm.rows,function(a,c){_.each(a,function(d){b(d,a,c),13===d.type&&d.multiRowForm&&_.each(d.multiRowForm.rows,function(a,c){_.each(a,function(d){b(d,a,c)})})})}),b(a,d,c)})}function showErrorToast(a,b){b.show({template:'<md-toast class="md-toast error"> <span class="md-toast-text" flex>'+a+"</span></md-toast>",hideDelay:3e3,position:"bottom left"})}function getFormLookupFields(a,b,c){if(console.log("### call getFormLookupFields ",a),a&&a.form)return a.formLookupSourceFields&&a.formLookupSourceFields.length?void(c&&c()):void b.get(a.form).then(function(b){a.formLookupSourceFields=[],_.each(b.model.pages,function(b){_.each(b.controls,function(b){a.formLookupSourceFields.push(b)})}),a.formLookupSourceFields.push({name:"_id",label:app.lang.translate("identity")}),c&&c()})}var ngApp=angular.module("sadafForms");ngApp.controller("fromGeneratorCtrl",["$scope","$http","$sce","$timeout","$mdToast","$routeParams","formsService","controlPropertyService","$translate","$mdDialog",function(a,b,c,d,e,f,g,h,i,j){function k(){p=[],runOnAllControll(m.pages.data,function(a){console.log("setCurrentTableColumns"),p.push(a.columnName)})}function l(a,b){return j.show({controller:["$scope","$mdDialog","$timeout",function(a,c,d){function e(b,c){b.renderer.setPadding(18),b.commands.addCommand({name:"myCommand",bindKey:{win:"Ctrl-S",mac:"Command-S"},exec:function(b){d(function(){a.justsave()},0)}}),a.insertFormula=function(a){b.insert(a),b.focus()}}a.cancel=function(){c.cancel()},a.save=function(){c.hide(a.formula)},b&&(a.formula=b),a.justsave=function(){m.printLayout=a.formula,m.save()},a.aceOption={useWrapMode:!0,showGutter:!1,theme:"sqlserver",mode:"sqlserver",maxLines:14,onLoad:e,require:["ace/ext/beautify"]}}],parent:angular.element(document.body),targetEvent:a,clickOutsideToClose:!1,escapeToClose:!1,fullscreen:!0,template:'<md-dialog aria-label="{{\'editor\' | translate}}" ng-cloak class="fullscreen-dialog">                                 <md-toolbar>                                                                                                                            <div class="md-toolbar-tools">                                                                                                          <h2>{{\'editor\' | translate}}</h2>                                                                                                   <span flex></span>                                                                                                                  <md-button class="md-icon-button" ng-click="cancel()">                                                                                  <span class="material-icons">close</span>                                                                                       </md-button>                                                                                                                    </div>                                                                                                                          </md-toolbar>                                                                                                                       <md-dialog-content layout-margin flex layout="row" class="md-dialog-contentx">                                                          <style>                                                                                                                                 .ace_editor {                                                                                                                           border: 1px solid #efefef;                                                                                                      }                                                                                                                                                                                                                                                                           .ace_editor, .ace_editor div {                                                                                                          font: 16px/normal \'Courier New\', \'Menlo\', \'Ubuntu Mono\', \'Consolas\', \'source-code-pro\', monospace;                              }                                                                                                                                                                                                                                                                   md-dialog.fullscreen-dialog {                                                                                                           max-width: 100%;                                                                                                                    max-height: 100%;                                                                                                                   width: 100%;                                                                                                                        height: 100%;                                                                                                                       border-radius: 0;                                                                                                               }                                                                                                                               </style>                                                                                                                                                                                                                                                                <div class="ltr" flex="100" ui-ace="aceOption" ng-model="formula">                                                                                                                                                                               </div>                                                                                                                                                                                                                                                              </md-dialog-content>                                                                                                                <md-dialog-actions layout="row">                                                                                                        <md-button ng-click="save()">                                                                                                           {{ \'ذخیره و بستن\' | translate }}                                                                                                        </md-button>                                                                                                                        <md-button ng-click="justsave()">                                                                                                            ذخیره                                                                                                          </md-button>                                                                                                                        <md-button ng-click="cancel()">                                                                                                         {{ \'cancel\' | translate }}                                                                                                      </md-button>                                                                                                                    </md-dialog-actions>                                                                                                            </md-dialog>'
})}a.saveProgress=!1;var m=this;m.id=f.id||0;var n=m.id>0;m.app=app,m.items=[{order:1,columnClass:"four",key:"متن کوتاه",label:"نام",icon:"text cursor",type:0,showUniqueProp:!0,"default":!0,require:!0,disable:!0,regex:!0,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{order:2,columnClass:"four",key:"متن بلند",label:"متن بلند",icon:"text cursor",type:1,showUniqueProp:!0,"default":!0,require:!0,disable:!0,regex:!0,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{order:3,columnClass:"four",key:"عدد",label:"عدد",icon:"hashtag",type:2,showUniqueProp:!0,"default":!0,require:!0,disable:!0,regex:!0,format:",.0f",accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[],validations:{autoIncrementSeed:1}},{order:4,columnClass:"four",key:"برچسب",label:"برچسب",icon:"font",type:3,showUniqueProp:!1,"default":!1,require:!1,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{order:5,columnClass:"four",key:"چند گزینه",icon:"caret square down outline",label:"چند گزینه",type:4,showUniqueProp:!0,"default":!0,require:!0,disable:!0,dropdown:{useRemoteData:!1,theme:"combo"},accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{order:6.1,columnClass:"four",key:"چند گزینه رادیویی",icon:"dot circle outline",label:"چند گزینه رادیویی",type:4,showUniqueProp:!0,"default":!0,require:!0,disable:!0,dropdown:{useRemoteData:!1,theme:"radio"},accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{order:6,columnClass:"four",key:"چند گزینه ریموت",icon:"caret square down outline",label:"چند گزینه ریموت",type:4,showUniqueProp:!0,"default":!0,require:!0,disable:!0,accessControlEdit:!1,accessControlView:!1,dropdown:{useRemoteData:!0,theme:"combo"},accessControlEditRoles:[],accessControlViewRoles:[]},{columnClass:"four",key:"تایید",icon:"check square outline",type:6,label:"انتخاب مقدار",showUniqueProp:!1,"default":!0,require:!1,disable:!0,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[],order:7},{columnClass:"four",key:"زمان",icon:"clock outline icon",label:"زمان",type:8,showUniqueProp:!0,"default":!0,require:!0,disable:!0,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[],order:8},{columnClass:"four",key:"تاریخ",label:"تاریخ",icon:"calendar alternate outline",type:9,showUniqueProp:!0,"default":!0,disable:!0,require:!0,dataType:"shamsi",accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[],order:9},{type:14,columnClass:"four",key:" زمان - تاریخ",label:" زمان - تاریخ",icon:"calendar alternate outline",showUniqueProp:!0,"default":!0,disable:!0,dataType:"shamsi",require:!0,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[],order:9},{type:12,columnClass:"four",key:"ارجاع به فرم",label:"ارجاع به فرم",icon:"pointing right",formLookup:{form:-1,keyControls:[],showAddButton:!0},showUniqueProp:!0,"default":!0,disable:!0,require:!0,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[],order:10},{columnClass:"twelve",key:"گروه تکرار شونده",label:"لیست",dontShowAccessControl:!0,icon:"table",type:13,showUniqueProp:!1,"default":!1,disable:!0,require:!1,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[],multiRowForm:{addKeyText:"ردیف جدید",rows:[[]],controlSize:"mini"},uiConfig:{theme:"simple"},order:11},{columnClass:"four",key:"کلید",label:"کلید",icon:"square",type:15,showUniqueProp:!1,"default":!1,disable:!1,require:!1,button:{type:1,openLinkType:0,colorClass:"black",size:"tiny",tasks:[{type:0,openLinkType:0}]},accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[],order:12},{columnClass:"four",key:"محاسباتی",icon:"calculator",label:"فیلد محاسباتی",type:5,showUniqueProp:!1,"default":!1,disable:!1,require:!1,dataType:"string",format:"#,#",calculate:{expression:""},accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[],order:13},{columnClass:"four",key:"محاسباتی - جمع",label:"محاسباتی - جمع",icon:"calculator",type:16,showUniqueProp:!1,"default":!1,require:!1,format:"#,#",calculate:{expression:"",func:"sum"},accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[],order:14},{columnClass:"four",key:"اطلاعات اضافه ارجاع به فرم",label:"اطلاعات اضافه ارجاع به فرم",dontShowAccessControl:!0,icon:"info",type:17,showUniqueProp:!1,"default":!1,require:!1,format:"#,#",accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],columnClass:"four",key:"اطلاعات اضافه ارجاع به فرم",label:"اطلاعات اضافه ارجاع به فرم",dontShowAccessControl:!0,icon:"info",type:17,showUniqueProp:!1,"default":!1,require:!1,format:"#,#",accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[],tableLookup:{},order:15},{columnClass:"twelve",dontShowColumnSize:!0,dontShowHide:!0,dontShowAccessControl:!0,key:"تیتر",label:"تیتر",icon:"heading",type:18,showUniqueProp:!1,"default":!1,require:!1,format:"#,#",accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[],order:16},{columnClass:"twelve",dontShowColumnSize:!0,dontShowHide:!0,dontShowAccessControl:!0,key:"پیوست کردن فایل",label:"لیست فایل‌ها",icon:"file outline",type:19,showUniqueProp:!1,"default":!1,require:!0,format:"#,#",accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[],order:17},{order:18,columnClass:"four",key:"انتخاب کاربر",icon:"user outline",label:"انتخاب کاربر",type:4,showUniqueProp:!0,"default":!0,require:!0,dropdown:{useRemoteData:!0,isUser:!0,preventRelation:!0},accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{order:19,columnClass:"twelve",key:"متن بلند با فرمت",icon:"edit",label:"متن بلند با فرمت",type:20,showUniqueProp:!1,"default":!0,uiConfig:{minHeight:150,font:{fontSize:"16px",fontName:"IRANSans"}},require:!0,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{order:20,columnClass:"four",key:"انتخاب نقش",icon:"users",label:"انتخاب نقش",type:4,showUniqueProp:!0,"default":!0,require:!0,dropdown:{useRemoteData:!0,isUser:!1,isRole:!0,preventRelation:!0},accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{order:21,columnClass:"four",key:"نهایی کردن فرم",icon:"lock",label:"نهایی کردن فرم",type:21,showUniqueProp:!1,"default":!1,require:!1,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[],description:"در صورت فعال بودن فرم تنها برای نقش‌های مجاز قابل ویرایش خواهد بود"},{order:22,columnClass:"twelve",key:"گروه",label:"گروه‌بندی",icon:"square outline",type:22,controlGroup:{controls:[],color:"#fefefe"},showUniqueProp:!0,"default":!0,require:!0,disable:!0,regex:!0,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{order:23,columnClass:"twelve",key:"کامنت",label:"کامنت",icon:"comments outline",type:23,showUniqueProp:!1,"default":!1,require:!0,disable:!0,regex:!1,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]}],i(["short text","long text","number","label","combo","remote combo","checkbox","time","date","date time","refer to form","iterator","calculator","calculator sum","extra info","header","key","file list"]).then(function(a){function b(a,b,c,d){var e=_.find(m.items,null===b?{type:a}:b);e.key=c,e.label=d}b(0,null,a["short text"],a["short text"]),b(1,null,a["long text"],a["long text"]),b(2,null,a.number,a.number),b(3,null,a.label,a.label),b(4,function(a){return 4==a.type&&0==a.dropdown.useRemoteData},a.combo,a.combo),b(4,function(a){return 4==a.type&&1==a.dropdown.useRemoteData},a["remote combo"],a["remote combo"]),b(6,null,a.checkbox,a.checkbox),b(8,null,a.time,a.time),b(9,null,a.date,a.date),b(14,null,a["date time"],a["date time"]),b(12,null,a["refer to form"],a["refer to form"]),b(13,null,a.iterator,a.iterator),b(15,null,a.key,a.key),b(5,null,a.calculator,a.calculator),b(16,null,a["calculator sum"],a["calculator sum"]),b(17,null,a["extra info"],a["extra info"]),b(18,null,a.header,a.header),b(19,null,a["file list"],a["file list"])}),m.publishFrom=function(a){m.publishProgress=!0,g.publish(m.id,m.name,a).then(function(a){m.publishProgress=!1,m.url=a.url,m.publish=a.publish})},m.controlProperty=function(a){return a?_.find(m.items,{type:a.type}):{showUniqueProp:!1,"default":!1,require:!1}},m.sortableOptions={"ui-floating":!0},m.compConf={sort:!1,group:{name:"form",pull:"clone",put:!1},animation:150,onEnd:function(a){console.log("### onEnd compConf",a),a.model.name=m.pages.naming.getName(),a.model.columnName=a.model.name,a.model.canView=!0,a.model.canEdit=!0}},m.checkColumnName=function(a,b){var c=!1;return runOnAllControll(m.pages.data,function(b){if(console.log("checkColumnName"),b.name!==a.name&&b.columnName===a.columnName)return c=!0,!0}),c?(i("duplicate name").then(function(a){alert(a)}),void(a.columnName=b)):void(p.indexOf(a.columnName)!==-1&&(a.columnName=b,i("duplicate name").then(function(a){alert(a)})))},m.drags=m.items.map(function(a){return[a]});var o=!1;m.control=h.get(),m.formLookupSourceFields=[],m.pages={data:[],add:function(a){var b={name:app.lang.translate("page")+" "+(m.pages.data.length+1),type:0,controls:[],rowValidation:{uniqueMultiField:!1,uniques:[]},size:""};m.pages.data.push(b),m.pages.setActive(b)},removeControl:function(a,b){var c=app.lang.translate("delete control message"),d=confirm(c);d&&(o=!0,m.pages.activePage.controls.splice(a,1))},copy:function(a,b){o=!0;var c=_.extend({},b);c.name=m.pages.naming.getName(),c.columnName=c.columnName+"-copy",m.pages.activePage.controls.splice(a+1,0,c)},remove:function(a){if(m.pages){var b=!0;if(m.pages.data[a].controls.length&&(b=confirm("delete page message")),b){m.pages.data[a].controls.length&&(o=!0);var c=m.pages.data.splice(a,1);c[0]===m.pages.activePage&&m.pages.setActive()}}},setActive:function(a){_.each(m.pages.data,function(a){a.active=!1}),!a&&m.pages.data.length&&(a=m.pages.data[0]),m.pages.activePage=a,m.pages.activePage.active=!0,m.control.active&&(m.control.active.isActive=!1,m.control.active=null)},getControlForRowValidation:function(){var a=m.pages.activePage.controls;return a},naming:{getName:function(){return"field-"+m.pages.naming.getMaxId()},exist:function(a){if("_id"==a)return!0;var b=!1;return _.each(m.pages.data,function(c){_.each(c.controls,function(c){var d=c.name||"";if(d==a)return b=!0,!1})}),b},getMaxId:function(){return m.maxFieldNumber=+m.maxFieldNumber||0,m.maxFieldNumber++,m.maxFieldNumber}}},m.controlList=[],a.$watch("c.pages",function(){m.controlList=[],runOnAllControll(m.pages.data,function(a){console.log("pages"),13!=a.type&&m.controlList.push(a)})},!0),m.saveProgress=!1,m.save=function(){var a=!1;a=!o||confirm("edit form message‌"),a&&(o=!1,m.saveProgress=!0,_.isObject(m.mapTable.columnId)&&(m.mapTable.columnId=null),runOnAllControll(m.pages.data,function(a){console.log("flag"),a.uiConfigSerialized=JSON.stringify(a.uiConfig||{})}),g.save(m.id,{pages:m.pages.data,name:m.name,maxFieldNumber:m.maxFieldNumber,triggers:m.triggers,showSubmitedInfo:m.showSubmitedInfo,modalSize:m.modalSize,printLayout:m.printLayout,printOrientation:m.printOrientation,printPage:m.printPage,formInfo:m.formInfo,printFileName:m.printFileName,dynamicAcl:m.dynamicAcl,dynamicAclDatasource:m.dynamicAclDatasource,dynamicAclColumn:m.dynamicAclColumn,userVariables:m.userVariables||[],userVariablesInEdit:m.userVariablesInEdit,mapTable:m.mapTable||{}}).then(function(a){m.saveProgress=!1,m.id=a,location.replace(app.hashUrlPrefix+"#/forms/"+a),k();var b=e.simple().textContent(app.lang.translate("saving successfully"));e.show(b)},function(a){m.saveProgress=!1;var b=app.lang.translate("error in saving");a.data.desc&&(b=a.data.desc),showErrorToast(b,e)}))},n||(m.name=app.lang.translate("new form"),m.showSubmitedInfo=!1,m.modalSize="large",m.pages.add());var p=[];m.userVariables=[],m.mapTable={},m.formInfo={concurrentSave:"prevent-save"},n&&g.get(m.id,!0).then(function(a){m.sign=a.sign,m.pages.data=a.model.pages,m.name=a.model.name,m.showSubmitedInfo=a.model.showSubmitedInfo,m.modalSize=a.model.modalSize,m.triggers=a.model.triggers,m.url=a.url,m.publish=a.publish,m.maxFieldNumber=a.model.maxFieldNumber,m.dynamicAcl=a.model.dynamicAcl,m.printLayout=a.model.printLayout,m.printOrientation=a.model.printOrientation,m.printPage=a.model.printPage,m.formInfo=a.model.formInfo,m.formInfo.concurrentSave||(m.formInfo.concurrentSave="prevent-save"),m.printFileName=a.model.printFileName,m.dynamicAclDatasource=a.model.dynamicAclDatasource,m.dynamicAclColumn=a.model.dynamicAclColumn,m.userVariables=a.model.userVariables||[],m.userVariablesInEdit=a.model.userVariablesInEdit,m.mapTable=a.model.mapTable||{},m.dynamicAcl&&m.getAllRelatedDatasource(),m.pages.setActive(),k(),runOnAllControll(m.pages.data,function(a){console.log("isEdit"),a.uiConfig=JSON.parse(a.uiConfigSerialized||"{}"),"today"===a.defaultFunction&&(a.defaultFunctionToday=!0),a.dropdown&&a.dropdown.items&&(a.dropdown.itemsTemp=a.dropdown.items.map(function(a){return a.label}).join("\n"))})}),m.getSiblingControl=function(a){var b={};return runOnAllControll(m.pages.data,function(c,d){a===c.name&&(b.row=d,b.index=_.findIndex(d,{name:a}))}),b},a.$watch("c.control.active",function(a){if(a&&a.name){var b=[];runOnAllControll(m.pages.data,function(a,c,d){b.push(a)}),m.activeSibling={rootControls:b,row:b}}}),m.getAllRelatedDatasource=function(){m.relatedDatasources||m.relatedDsProgress||(m.relatedDsProgress=!0,b.get(app.urlPrefix+"api/datasources/getAllRelated/"+m.id).then(function(a){m.relatedDsProgress=!1,m.relatedDatasources=a.data.list})["catch"](function(a){m.relatedDsProgress=!1}))},a.showDialog=function(b){l(b,a.c.printLayout).then(function(b){a.c.printLayout=b,m.save()})["catch"](function(){})},m.clearValue=function(){m.control.active.value=null,m.control.active.dropdown.listValue=null;for(var a in m.control.active)/chbx\d+/.test(a)&&(m.control.active[a]={check:!1})}}]),ngApp.directive("formControl",["$compile",function(a){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",editContext:"=?",settingsClick:"&?",remove:"&?",id:"@",edit:"@",settings:"=?",copy:"&?",sdSubmit:"&",change:"&?"},controller:["$scope","$translate","$timeout","$http","taskExecutor",function(a,b,c,d,e){if(a._=_,a.randomId=Math.floor(1e5*Math.random())+1,a.model.randomId=a.randomId,a.$watch("model.value",function(b){null==b&&$(".form-"+a.randomId+" .dropdown").dropdown("clear")}),a.simpleDropdownsettings={message:{noResults:app.lang.translate("No results found.")},fullTextSearch:!0,forceSelection:!1},a.$watch("model.dropdown.listValue",function(b){null==b&&$(".form-"+a.randomId+" .dropdown").dropdown("clear")}),a.model.dropdown&&a.model.dropdown.multiSelectDropdown&&a.model.dropdown.useRemoteData&&(a.model.items=a.model.dropdown.listValue),a.initDropdown=function(b){a.model.dropdown&&a.model.dropdown.multiSelectDropdown&&a.model.dropdown.useRemoteData&&c(function(){$(b).dropdown("set selected",a.model.dropdown.listValue)},100)},a.buttonClick=function(){a.edit||_.each(a.model.button.tasks,function(b){e.exec(b,a.$parent.$parent.$parent.data,a)})},a.getFilteredDropdonItems=function(b,c,d){if(!a.model.useFilter||!a.model.filters)return!1;var e=!1;return _.each(a.model.filters,function(a){return!!(a&&a.staticValue&&b&&b.value)&&(1==a.type?(e=a.staticValue.trim().indexOf(b.value.trim())!=-1||b.value.trim().indexOf(a.staticValue.trim())!=-1,!1):void 0)}),e},12===a.model.type&&(a.model.formDialogInfo={formInfo:{form:a.model.formLookup.form},showModal:!1},a.model.formDialogInfo.formInfo.render=!0,a.showFormInModal=function(){a.model.formDialogInfo.formInfo.rowId=0,c(function(){a.model.formDialogInfo.showModalFunc();var b=a.model.formDialogInfo.formSettings.notify;b(a.model.formLookup.form,0,null,a.model.formDialogInfo.formSettings)},0)},a.editFormInModal=function(b){a.model.formDialogInfo.formInfo.rowId=+b.value,c(function(){a.model.formDialogInfo.showModalFunc();var b=a.model.formDialogInfo.formSettings.notify;b(a.model.formLookup.form,a.model.formDialogInfo.formInfo.rowId,null,a.model.formDialogInfo.formSettings)},0)}),a.keyup=function(b){b&&b.ctrlKey&&13==b.keyCode&&a.sdSubmit()},a.model.dropdown&&"radio"==a.model.dropdown.theme&&a.model.dropdown.multiSelectDropdown&&!a.model.dropdown.useRemoteData)for(var f=0;f<a.model.dropdown.items.length;f++){a.model.dropdown.listValue=a.model.dropdown.listValue||[];var g=a.model.dropdown.listValue.indexOf(a.model.dropdown.items[f].value);a.model["chbx"+f]={check:g!=-1}}a.multiselectChange=function(b,c,d,e,f){if(a.model.dropdown.listValue=a.model.dropdown.listValue||[],b){var g=a.model.dropdown.listValue.indexOf(e.value);g==-1&&b.check&&a.model.dropdown.listValue.push(e.value),g==-1||b.check||a.model.dropdown.listValue.splice(g,1)}a.changeValue()},a.changeValue=function(b){a.change&&a.change({model:b||a.model})}}],templateUrl:app.urlPrefix+"dist/partial/forms/editor/form-generator-control.directive.html?v="+app.version}}]),$.fn.dropdown.settings.message&&($.fn.dropdown.settings.message.noResults="موردی برای نمایش وجود ندارد"),ngApp.directive("newFormModal",["$compile","$timeout",function(a,b){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",show:"=?",control:"=?"},template:'<div>                            <div class="xcontent" ></div>                       </div>',link:function(b,c,d){function e(){b.id||(b.id=Math.floor(999999*Math.random())+1e6,$($(c).find(".modal")[0]).addClass("id"+b.id)),$(".id"+b.id).data("callback",{result:function(a){var c=findControl(b.control.formLookup.keyControls[0],a.model.pages);b.control.value=c.rowId,b.control.formLookup.keyControlsBindedValue=[c.value],b.$parent.$parent.$parent.$parent.$parent.$broadcast("formLookup-set-default",b.control)}}),b.modal=$(".id"+b.id).jqmodal(b.option)}function f(){var d=angular.element('<div                                                          <div sadaf-form row-id={{model.formInfo.rowId}} id="{{model.formInfo.form}}" on-finish="hideModal()" on-save="saveFinish(data)" option="{showCancel:true}" settings="formSettings" on-cancel="hideModal()"></div>                                                    </div></div>');a(d)(b),angular.element(c[0].querySelector(".xcontent")).html(d)}b.hideModal=function(a){b.model.showModal=!1,$.jqmodal.close()},b.saveFinish=function(a){},b.option={escapeClose:!1,clickClose:!1,showClose:!1,fadeDuration:0,closeExisting:!1},b.formSettings={modal:!0},b.model.showModalFunc=e,b.model.formSettings=b.formSettings,f()}}}]),ngApp.directive("formLookupProperty",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",settings:"=?",control:"=",rootForm:"@"},controller:["$scope","$http","formsService",function(a,b,c){a.model=a.model||{},a.settings=angular.merge({selectableColumns:!0},a.settings||{}),c.get().then(function(b){a.forms=_.filter(b,function(b){return b.id!=+a.rootForm})}),a.$watch(["model.keyControls","model.formLookupSourceFields"],function(b,c){b!=c&&c&&b&&0!=b.length&&0!=c.length&&(console.log("#### formula",b,c),a.model.formLookupSourceFields&&(a.model.keyLabels=_.map(b,function(b){return _.find(a.model.formLookupSourceFields,{name:b}).label})),a.model.keyFormula=_.map(b,function(b){return"["+_.find(a.model.formLookupSourceFields,{name:b}).columnName+"]"}).join(" + "))},[]),a.$watch("model.form",function(b){b==-1&&(a.model.form=a.forms[0].id),b&&c.get(b).then(function(b){a.formControls=[],_.each(b.model.pages,function(b){_.each(b.controls,function(b){a.formControls.push(b)})})})}),a.calcFormula=function(){if(12==a.control.type){var b=a.control.formLookup.form;if(!b||b<=0)return;console.log(a.control.formLookup.formLookupSourceFields),a.control.formLookup.formLookupSourceFields=null,getFormLookupFields(a.control.formLookup,c,function(){a.model.keyFormula=_.map(a.model.keyControls,function(b){return"["+_.find(a.model.formLookupSourceFields,{name:b}).columnName+"]"}).join(" + ")})}}}],template:'<form> <div class="field">                        <div class="field">                            <label>{{\'select form\' | translate}}</label>                            <sm-dropdown class="selection search fluid"  settings="{fullTextSearch: true, forceSelection: false}" xon-change="change()" model="model.form" items="forms" label="item.name" value="item.id" ></sm-dropdown>                        </div>                        <div class="field" ng-show=settings.selectableColumns>                            <label> {{\'key columns\' | translate}}</label>                            <sm-dropdown class="selection search multiple fluid" settings="{fullTextSearch: true, forceSelection: false}" model="model.keyControls" items="formControls" label="item.label" value="item.name" ></sm-dropdown>                        </div>                        <div class="field" ng-show=settings.selectableColumns>                            <label>{{\'فرمول جستجوی منوی آبشاری\' | translate}}  <small class="pointer" ng-click="calcFormula()">دریافت کد</small></label>                            <input class="selection search multiple fluid" ng-model="model.keyFormula" />                        </div>                        </div></form>',link:function(a,b,c){}}}),ngApp.directive("formLookupGetId",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",id:"@",ngChange:"&?"},controller:["$scope","$http","formsService","$timeout",function(a,b,c,d){function e(){a.model.formLookup.keyControls=a.model.formLookup.keyControls||[],a.keys=a.model.formLookup.keyControls.map(function(b,c){var d={name:b,dropdownSettings:i(b),change:function(b,c){d.value!==c&&(d.value=c,a.model.value=b,console.log("### change form lookup"),a.ngChange&&a.ngChange())},defaultText:a.model.label};return d})}function f(){if(a.model.formLookup.keyControlsBindedValue&&a.keys&&a.keys.length){for(var b=0;b<a.model.formLookup.keyControlsBindedValue.length;b++){var c=a.model.formLookup.keyControlsBindedValue[b];null===a.model.value||_.isEmpty(c)||(!a.model.format||_.isNaN(+c)||_.isEmpty(c)||(c=d3.format(getFormat(a.model))(+c)),a.keys[b].defaultText=c,a.keys[b].boldText=!0)}a.keys[0].defaultText=a.model.formLookup.keyControlsBindedValue.join(" ")}}function g(){a.model.useFilter&&a.model.filters.length&&_.map(a.model.filters,function(a){})}function h(){$(".form-"+a.model.randomId+" .dropdown").dropdown("clear")}a.model.formLookup=a.model.formLookup||{};var i=function(b){return{apiSettings:{url:app.urlPrefix+"api/forms/getFormColumnData",cache:!1,method:"get",dataType:"json",beforeSend:function(b){return b.data={id:a.id,name:a.model.name,query:b.urlData.query,others:a.keys.map(function(a){return{label:a.name,value:a.value}}),filters:a.model.useFilter?a.model.filters:[]},b},onResponse:function(b){b.fields=b.fields.map(function(a){return{value:a.value,label:a.label,id:a.id}}),a.model.format&&_.each(b.fields,function(b){_.isEmpty(b.label)||_.isNaN(+b.label)||(b.label=d3.format(getFormat(a.model))(+b.label))});try{_.each(a.$parent.$parent.$parent.$parent.data.pages,function(b){_.each(b.controls,function(b){if(12==b.type&&b.name!=a.model.name){var c=_.filter(b.filters,{control:a.model.name});_.each(c,function(a){b.value=null})}})})}catch(c){}return b}},onChange:function(b,c,d){a.model.formLookup.keyControlsBindedValue=[b],a.model.formLookup.keyControlsBindedText=[c]},message:{noResults:app.lang.translate("No results found.")},fields:{remoteValues:"fields",name:"label",value:"id"},saveRemoteData:!1,fullTextSearch:!0,forceSelection:!1}};a.render=!0,a.$on("formLookup-set-default",function(b,c){if(a.model.name===c.name){var e=_.merge([],a.keys);a.keys=[],a.render=!1,d(function(){a.keys=e,f(),a.render=!0},0)}}),a.$watch("model.formLookup.keyControlsBindedValue",function(a){f()},!0),a.$watch("model.filters",function(a){g()},!0),a.$watch("model.formLookup.keyControls",function(a){e(),f()},!0);var j=!1,k=!1;a.$watch("model.value",function(b){a.model;null==b&&(k=!0,h())}),a.init=function(a){j=!0,k&&h()},a.model.isValid=!0}],template:' <div class="">                            <div ng-if="render" class="xfield" xng-repeat="f in keys">                                <sm-dropdown settings="keys[0].dropdownSettings" on-init="init" ng-class="{\'bold-text\':keys[0].boldText}" class="selection search {{keys[0].name}} fluid" on-change="keys[0].change" default-text="keys[0].defaultText" ></sm-dropdown>                            </div>                        </div>'}}),ngApp.directive("selectMenu",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",multiple:"@?"},controller:["$scope","$http","$timeout",function(a,b,c){b.get(app.urlPrefix+"api/menus/get").then(function(b){a.menus=b.data})}],template:'<div><sm-dropdown style="width:100%;"items="menus" model="model" class="selection search {{multiple}}" settings="{forceSelection: false}" label="item.name" value="item.id" ></sm-dropdown></div>'}}),ngApp.directive("selectDatasourceColumns",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel"},controller:["$scope","$http","datasources",function(a,b,c){function d(){a.model.datasourceColumns&&a.model.datasourceColumns.length||c.getColumns(a.model.remoteDatasource.value).then(function(b){a.model.datasourceColumns=b.CubeInfo.Dimensions[0].Hierarchies,a.model.userProperties=b.UsersProperty})}a.select=function(){c.select(null,{type:["datasources"],showSubForms:!0}).then(function(b){b.selected&&b.selected.length&&(a.model.remoteDatasource&&b.selected[0].id!=a.model.remoteDatasource.value&&(a.model.datasourceColumns=null),a.model.remoteDatasource={value:b.selected[0].id,label:b.selected[0].name},d(),a.model.remoteColumnKey=null,a.model.remoteColumnLabel=null)})},a.model=a.model||{},a.$watch("model",function(a){console.log("### watch [selectDatasourceColumns]"),a&&d()})}],template:' <div class="ui form">                        <div class="field">                            <label>{{\'انتخاب منبع داده\'| translate}}</label>                            <button class="ui tiny button" ng-click="select()">                                <span ng-show="!model.remoteDatasource">{{\'select\'| translate}}</span>                                <span ng-show="model.remoteDatasource">{{model.remoteDatasource.label}}</span>                            </button>                        </div>                        <div class="field" ng-show="model.datasourceColumns">                            <label>{{\'value column\'| translate}}</label>                            <sm-dropdown class="selection search fluid" settings="{fullTextSearch: true}" model="model.remoteColumnKey" items="model.datasourceColumns" label="item.Name" value="item.Name" ></sm-dropdown>                        </div>                    </div>',link:function(a,b,c){}}}),ngApp.directive("selectDatasource",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel"},controller:["$scope","$http","datasources",function(a,b,c){a.model=a.model||{},a.select=function(){c.select(null,{type:["datasources"]}).then(function(b){b.selected&&b.selected.length&&(a.model={value:b.selected[0].id,label:b.selected[0].name})})}}],template:' <div class="">                            <div class="field inline-form">                                <label>{{\'انتخاب منبع داده\'| translate}}</label>                                <span style="color:#424242" class="pointer" ng-show="model.value" ng-click="select()">{{model.label}}</span>                                <i ng-show="model.value" class="ui icon edit link" ng-click="select()"/>                                <button ng-show="!model.value" class="ui tiny button" ng-click="select()">                                    <span >{{\'select\'| translate}}</span>                                </button>                            </div>                        </div>'}}),ngApp.directive("selectColumn",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{id:"=",model:"=ngModel"},controller:["$scope","$http","datasources",function(a,b,c){a.model=a.model||{},a.$watch("id",function(){a.id&&getDatasourceColumns(a.id,c).then(function(b){a.datasourceColumns=b})})}],template:' <div class="">                            <div class="field inline-form">                                <label>{{\'ستون شناسه\'| translate}}</label>                                <sm-dropdown style="width: 70%" class="selection search" settings="{fullTextSearch: true}" model="model" items="datasourceColumns" label="item.Name" value="item.Name" ></sm-dropdown>                            </div>                        </div>'}}),ngApp.controller("fromsCtrl",["$scope","$http","$sce","$timeout","$mdToast","$routeParams","formsService","$mdDialog","utils","$translate",function(a,b,c,d,e,f,g,h,i,j){var k=this;k.progress=!0,k.app=app,k.utils=i,g.get().then(function(a){k.progress=!1,k.data=a,k.formsModule=g.getFormsModule(),k.securityCertPatch=g.securityCertPatch()}),k["delete"]=function(a,b,c){j(["remove","remove_form_desc","cancel"]).then(function(d){var f=h.confirm().title(d.remove).textContent(d.remove_form_desc+" "+b.name).ariaLabel(d.remove).targetEvent(a).ok(d.remove).cancel(d.cancel);h.show(f).then(function(){g.remove(b.id).then(function(a){var b=k.data.splice(c,1),d=e.simple().textContent("فرم "+b[0].name+" با موفقیت حذف شد");e.show(d)})})})},k.copy=function(a,b,c){g.copy(b.id).then(function(){})["catch"](function(){alert("اشکال در روند اجرای برنامه")})}}]),ngApp.directive("sadafUserVariables",["$compile","$timeout","$http",function(a,b,c){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel"},template:'<div><sm-dropdown class="selection fluid search" items="items" model="model" label="item" value="item"></sm-dropdown></div>',controller:["$scope","$http",function(a,b){b.get(app.urlPrefix+"api/users/getPropertyAutoCompleteEntries").then(function(b){a.items=b.data.keys})["catch"](function(){})}]}}]),ngApp.directive("controlSize",["$compile","$timeout",function(a,b){return{restrict:"E",transclude:!0,scope:{model:"=ngModel"},template:"<sm-dropdown items=\"[{label:('خیلی کوچک' | translate), value:'mini'}, {label:('کوچک' | translate), value:'tiny'}, {label:('normal' | translate), value:''}]\" model=\"model\" label=\"item.label\" value=\"item.value\"></sm-dropdown> "}}]),ngApp.filter("formatNumber",function(){return function(a,b){var c=b.format;return isNaN(a)||!c?a:("custom"===c&&(c=b.customFormat),d3.format(c)(a))}}),ngApp.filter("d3format",function(){return function(a,b){return"#,#"==b&&(b=",.0f"),"undefined"==typeof a||null==a?a:d3.format(b)(a)}}),ngApp.filter("persian",function(){return function(a){return app.lang&&0==+app.lang.langType?persian(a,!0):a}}),ngApp.directive("sadafCheckbox",["$compile","$timeout",function(a,b){return{restrict:"E",transclude:!0,replace:!0,scope:{model:"=ngModel",change:"&?ngChange"},template:'<div class="ui checkbox"><input type="checkbox" ng-model="model" ng-change="change"/><label ng-transclude></label></div>',link:function(a,c,d){a.model===!0||a.model&&a.model.match(/(true)/gi)?a.model=!0:a.model=null,a.$watch("model",function(a,b){if(a&&_.isString(a)){var d=a.match(/(true)/gi);$(c).checkbox(d?"set checked":"set unchecked")}}),$(c).checkbox({onChange:function(d,e){b(function(){a.model=$(c).find("input").is(":checked"),a.change&&a.change()})}})}}}]),ngApp.directive("filterProperty",["$compile","$timeout","datasources","formsService",function(a,b,c,d){return{restrict:"E",transclude:!0,replace:!0,scope:{model:"=ngModel",controls:"=",sourceFields:"=?",name:"=?",active:"=?",justValue:"@?"},controller:["$scope",function(a){a.justValue=JSON.parse(a.justValue||"false");var b={type:2};a.add=function(){
a.model.push(_.extend({},b))},a.$watch("model",function(c){c||(a.model=a.model||[b])}),a.$watch("sourceFields",function(b){b&&a.justValue&&_.each(b,function(a){a.label=a.Name,a.name=a.UniqueName}),!b&&a.active&&12==a.active.type&&getFormLookupFields(a.active.formLookup,d,function(){})}),a.$watch("controls",function(b){if(b){a.cnts=[],a.cnts=a.cnts.concat(b.row),a.cnts=a.cnts.concat(b.rootControls);var c=a.justValue?{type:4}:{type:12};a.cnts=_.filter(a.cnts,c),a.cnts=_.filter(a.cnts,function(b){return b.name!==a.name}),a.cnts=_.uniqBy(a.cnts,"name")}})}],template:'<div class="inner-section">                          <div class="field" ng-repeat="f in model track by $index">                            <div class="inline fields" >                                <label class="three wide field">{{\'type\' | translate}}</label>                                <div class="six wide field" >                                    <sm-dropdown model="f.type" class="" settings="{fullTextSearch: true, forceSelection: false}" items="[{type: 1, name:(\'fix value\' | translate)},{type: 2, name:(\'control value\' | translate)},{type: 3, name:(\'متغیر کاربری\' | translate)}]" label="item.name" value="item.type"></sm-dropdown>                                </div>                                <div class="three wide field">                                    <i class="gray pointer icon plus" ng-click="add()"></i>                                    <i class="gray pointer icon delete" ng-click="model.splice($index, 1)" ng-hide="model.length==1"></i>                                </div>                            </div>                            <div class="inline fields" ng-show="f.type == 1">                                <label class="three wide field">{{\'value\' | translate}}</label>                                <input ng-model="f.staticValue" />                            </div>                            <div class="inline fields" ng-show="f.type == 3">                                <label class="three wide field">{{\'value\' | translate}}</label>                                <sadaf-user-variables ng-model="f.staticValue" style="width:100%" ></sadaf-user-variables>                            </div>                                                        <small ng-show="f.type == 2">{{\'control base filter desc\' | translate}}</small>                            <div class="field" >                                <div class="inline fields" ng-show="f.type == 2">                                    <label class="three wide field">{{\'control\' | translate}}</label>                                    <sm-dropdown model="f.control" class="selection fluid" settings="{fullTextSearch: true, forceSelection: false}" items="cnts" label="item.label" value="item.name"></sm-dropdown>                                </div>                            </div>                                                        <small ng-show="f.type == 2">{{\'control base filter desc 2\' | translate}}</small>                            <div class="inline fields" ng-show="sourceFields" ng-show="f.type == 2">                                <label class="three wide field">{{\'column\' | translate}}</label>                                <sm-dropdown model="f.sourceField" class="selection fluid" settings="{fullTextSearch: true, forceSelection: false}" items="sourceFields" label="item.label" value="item.name"></sm-dropdown>                            </div>                        </div>                   </div>'}}]),ngApp.directive("tableLookup",["$compile","$timeout","formsService",function(a,b,c){return{restrict:"E",transclude:!0,replace:!0,scope:{model:"=ngModel",controls:"="},controller:["$scope","formsService","datasources",function(a,b,c){function d(){function d(){a.fields=_.map(e.dropdown.datasourceColumns,function(a){return{name:a.Name,value:a.UniqueName}})}if(a.model.tableLookup){var e=_.find(a.cnts,{name:a.model.tableLookup.controlName});12==e.type&&(a.model.tableLookup.lookupField=e.formLookup.keyControls[0],a.model.tableLookup.id=e.formLookup.form,a.model.tableLookup.type="form",getFormLookupFields(e.formLookup,b,function(){a.fields=_.map(e.formLookup.formLookupSourceFields,function(a){return{name:a.label,value:a.columnName}})})),4==e.type&&(a.model.tableLookup.type="datasource",a.model.tableLookup.id=+e.dropdown.remoteDatasource.value,a.model.tableLookup.lookupField=e.dropdown.remoteColumnLabel,e.dropdown.datasourceColumns?d():getDatasourceColumns(e.dropdown.remoteDatasource.value,c).then(function(a){e.dropdown.datasourceColumns=a,d()}))}}a.$watch("model",function(b){b||null==a.model||(a.model.tableLookup=a.model.tableLookup||{})}),a.$watch("controls",function(b){b&&(a.cnts=[],a.cnts=a.cnts.concat(b.row),a.cnts=a.cnts.concat(b.rootControls),a.cnts=_.filter(a.cnts,function(a){return 12==a.type||4==a.type&&a.dropdown.useRemoteData}),a.cnts=_.filter(a.cnts,function(b){return b.name!=a.name}),a.cnts=_.uniqBy(a.cnts,"name"))}),a.$watch("model.tableLookup.controlName",function(a,b){a&&d()}),d()}],template:'<div class="">                          <div class="field">                            <small>{{\'extra info desc\' | translate}}</small>                            <div class="inline fields">                                <label class="three wide field">{{\'control\' | translate}}</label>                                <sm-dropdown model="model.tableLookup.controlName" class="selection fluid" settings="{fullTextSearch: true, forceSelection: false}" items="cnts" label="item.label" value="item.name"></sm-dropdown>                            </div>                            <div class="inline fields">                                <label class="three wide field">{{\'column\' | translate}}</label>                                <sm-dropdown model="model.tableLookup.resultField" class="selection search fluid" settings="{fullTextSearch: true, forceSelection: false}"                                              items="fields" label="item.name" value="item.value"></sm-dropdown>                            </div>                        </div>                   </div>',link:function(a,b,c){}}}]),ngApp.directive("sadafDraggable",["$timeout",function(a){return function(a,b,c){function d(){$("[sadaf-draggable]").draggable({connectToSortable:"[sadaf-sortable]",helper:"clone",revert:"invalid",start:function(a,b){$(b.helper).css("width",$(b.helper).width()+"px")},stop:function(a,b){$(b.helper).css("width","100%")}}),$("[sadaf-draggable]").disableSelection()}a.$last&&d()}}]),ngApp.directive("sadafSortable",["$timeout",function(a){return function(a,b,c){function d(){$("[sadaf-sortable]").sortable({revert:!0}),$("[sadaf-sortable]").disableSelection()}d()}}]),ngApp.directive("sadafCalendar",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",control:"=?",ngChange:"&?",sdKeyup:"&"},template:'<div style="display:inline-block;width:100%;"><input type="text" id=""  class="form-control from" placeholder="{{\'date\' | translate}}" /><input id="from-value" type="hidden"/></div>',link:function(a,b,c){function d(){function c(b){a.$apply(function(){a.model=unixToString(b,f,"miladi"===a.control.dataType)}),a.ngChange&&a.$apply(function(){a.ngChange()})}var d=!1;try{d=a.$parent.$parent.$parent.component.justMonth}catch(e){}var f=d?"YYYY/MM":"YYYY/MM/DD",g=b.find(" .from"),h=g.pDatepicker({autoClose:!0,calendarType:"miladi"===a.control.dataType?"gregorian":"persian",format:f,toolbox:{calendarSwitch:{enabled:!1}},initialValue:!1,onSelect:function(a){d&&c(a)},dayPicker:{enabled:!d,onSelect:function(a){c(a)}}});g.change(function(b){var c=$(b.target).val();return _.isEmpty(c)?void(a.model=null):(c=depersian(c),h.setDate(stringToUnix(c,"miladi"===a.control.dataType)),a.$apply(function(){a.model=unixToString(stringToUnix(c,"miladi"===a.control.dataType),f,"miladi"===a.control.dataType)}),void(a.ngChange&&a.$apply(function(){a.ngChange()})))}),g.keyup(function(b){a.sdKeyup({$event:b})}),a.$watch("model",function(c){c||b.find(" .pwt-datepicker-input-element").val(""),a.model&&h.setDate(stringToUnix(a.model,"miladi"===a.control.dataType))}),a.model&&h.setDate(stringToUnix(a.model,"miladi"===a.control.dataType))}a.control=a.control||{},b.find("input").val(persian(a.model,!0)),b.find("input").focus(function(){$(this).data("handle")||($(this).data("handle",!0),d())})}}}),ngApp.directive("sadafCalendarRange",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",sdKeyup:"&"},template:'<div class="" style="display:flex; flex-direction:row;">                        <div class="" style="flex-grow:1;">                            <input id="" type="text" class="datepicker from" placeholder="تاریخ شروع" />                            <input id="from-value" type="hidden"/>                        </div>                        <div class="" style="padding: 8px;">تا</div>                        <div class="" style="flex-grow:1;">                            <input id="" type="text" class="datepicker to" placeholder="تاریخ پایان"/>                            <input id="to-value" type="hidden"/>                        </div>                      </div>',link:function(a,b,c){b.find(" .from").datepicker({changeMonth:!0,changeYear:!0,dateFormat:"yy/mm/dd",yearRange:"-100:+100",altFormat:"yy/mm/dd",altField:b.find("#from-value"),onClose:function(c){return a.model=a.model||{},c?(b.find(".to").datepicker("option","minDate",c),a.model.from=c,void a.$apply()):void(a.model.from=null)}}),b.find(".to").datepicker({defaultDate:"+1w",changeYear:!0,changeMonth:!0,dateFormat:"yy/mm/dd",altFormat:"yy/mm/dd",yearRange:"-100:+100",altField:b.find("#to-value"),onClose:function(c){return a.model=a.model||{},c?(b.find(".from").datepicker("option","maxDate",c),a.model.to=c,void a.$apply()):void(a.model.to=null)}}),a.$watch("model",function(c){a.model&&(b.find(".from").datepicker("setDate",a.model.from),b.find(".to").datepicker("setDate",a.model.to))})}}}),ngApp.directive("sadafTime",["$compile","$timeout",function(a,b){return{restrict:"E",replace:!0,scope:{model:"=ngModel",change:"&?ngChange"},template:'<div class="" >                        <input list="timeList" type="time" ng-model="timeValue" ng-change="change()"/>                        <datalist id="timeList">                            <option value="01:00">                            <option value="02:00">                            <option value="03:00">                            <option value="04:00">                            <option value="05:00">                            <option value="06:00">                            <option value="07:00">                            <option value="08:00">                            <option value="09:00">                            <option value="10:00">                            <option value="11:00">                            <option value="12:00">                            <option value="13:00">                            <option value="14:00">                            <option value="15:00">                            <option value="16:00">                            <option value="17:00">                            <option value="18:00">                            <option value="19:00">                            <option value="20:00">                            <option value="21:00">                            <option value="22:00">                            <option value="23:00">                            <option value="24:00">                        </datalist>                   </div>',link:function(a,c,d){a.silent=!1,a.timeValue,a.$watch("timeValue",function(c,d){c&&(a.silent=!0,a.model=a.timeValue.toTimeString().split(" ")[0].substring(0,5),b(function(){a.silent=!1}))}),a.$watch("model",function(b,c){if(!a.silent)return b?void(a.timeValue=new Date("1969-12-31 "+a.model)):void(a.timeValue=null)})}}}]),ngApp.directive("sadafTimeRange",["$compile","$timeout",function(a,b){return{restrict:"E",replace:!0,scope:{model:"=ngModel",change:"&?ngChange"},template:'<div class="" style="display:flex; flex-direction:row;">                        <div class="" style="flex-grow:1;">                        <input list="timeListFrom" type="time" ng-model="timeFrom" ng-change="change()"/>                        <datalist id="timeListFrom">                            <option value="01:00">                            <option value="02:00">                            <option value="03:00">                            <option value="04:00">                            <option value="05:00">                            <option value="06:00">                            <option value="07:00">                            <option value="08:00">                            <option value="09:00">                            <option value="10:00">                            <option value="11:00">                            <option value="12:00">                            <option value="13:00">                            <option value="14:00">                            <option value="15:00">                            <option value="16:00">                            <option value="17:00">                            <option value="18:00">                            <option value="19:00">                            <option value="20:00">                            <option value="21:00">                            <option value="22:00">                            <option value="23:00">                            <option value="24:00">                        </datalist>                        </div>                        <div class="" style="padding: 8px ;">تا</div>                        <div class="" style="flex-grow:1;">                        <input list="timeListTo" type="time" ng-model="timeTo" ng-change="change()" />                        <datalist id="timeListTo">                            <option value="01:00">                            <option value="02:00">                            <option value="03:00">                            <option value="04:00">                            <option value="05:00">                            <option value="06:00">                            <option value="07:00">                            <option value="08:00">                            <option value="09:00">                            <option value="10:00">                            <option value="11:00">                            <option value="12:00">                            <option value="13:00">                            <option value="14:00">                            <option value="15:00">                            <option value="16:00">                            <option value="17:00">                            <option value="18:00">                            <option value="19:00">                            <option value="20:00">                            <option value="21:00">                            <option value="22:00">                            <option value="23:00">                            <option value="24:00">                        </datalist>                        </div>                      </div>',link:function(a,c,d){a.silent=!1,a.timeFrom,a.timeTo,a.model=a.model||{},a.$watch("timeFrom",function(c,d){c&&(a.silent=!0,a.model=a.model||{},a.model.from=a.timeFrom.toTimeString().split(" ")[0].substring(0,5),"Inval"==a.model.from&&(a.model.from=null),b(function(){a.silent=!1}))}),a.$watch("timeTo",function(c,d){c&&(a.silent=!0,a.model=a.model||{},a.model.to=a.timeTo.toTimeString().split(" ")[0].substring(0,5),"Inval"==a.model.to&&(a.model.to=null),b(function(){a.silent=!1}))}),a.$watch("model",function(c,d){if(!a.silent)return c?void b(function(){a.timeFrom=new Date("1969-12-31 "+a.model.from),a.timeTo=new Date("1969-12-31 "+a.model.to)}):(a.timeFrom={},void(a.timeTo={}))}),a.model||(a.timeFrom=new Date("1969-12-31 "+a.model.from),a.timeTo=new Date("1969-12-31 "+a.model.to))}}}]),ngApp.directive("sadafDateTime",["$compile","$timeout",function(a,b){return{restrict:"E",replace:!0,scope:{model:"=ngModel",change:"&?ngChange"},template:'<div class="two column fields" style="padding: 0 !important;">                           <sadaf-calendar class="wide column" ng-model="innerModel.date" style="padding: 0 !important;"></sadaf-calendar>                           <sadaf-time class="wide column" ng-model="innerModel.time"  style="padding: 0 1rem !important;"></sadaf-time>                       </div>',link:function(a,c,d){function e(){b(function(){a.silent=!1},0)}function f(a){return a<10?"0"+a:a}a.innerModel={},a.silent=!1,a.$watch("innerModel",function(b,c){if(b&&(b.time||b.date)&&!a.silent){var d=b.time||"00:00",f=b.date||"1397/01/01";a.silent=!0,a.model=f+" "+d+":00",e()}},!0),a.$watch("model",function(b,c){if(!b)return a.innerModel.date=null,void(a.innerModel.time=null);if(!a.silent){var d=b.split(/[\/: ]/).map(function(a){return+a});a.silent=!0,a.innerModel.date=d[0]+"/"+f(d[1])+"/"+f(d[2]),a.innerModel.time=f(d[3])+":"+f(d[4]),e()}},!0)}}}]),ngApp.directive("sadafFile",["$compile","$timeout",function(a,b){return{restrict:"E",transclude:!0,replace:!0,scope:{model:"=ngModel"},controller:["$scope","Upload",function(a,b){function c(){_.each(a.model.attachment.uploadList,function(a){a.added||(a.added=!0,e(a))})}function d(a){var b={docx:"word",doc:"word",pptx:"powerpoint",ppt:"powerpoint",pdf:"pdf",xlsx:"excel",xls:"excel",mp4:"video",mp3:"audio",wma:"audio"},c=a.name.split(".").pop().toLowerCase();a.icon=b[c]}function e(a){d(a),b.upload({url:app.urlPrefix+"api/Upload/PostFile",data:{file:a}}).then(function(b){a.serverPath=b.data[0].path,a.fileName=b.data[0].name,a.success=!0},function(a){},function(b){var c=parseInt(100*b.loaded/b.total);a.progress=c,b.loaded==b.total&&(a.uploadFinish=!0)})}a.files,a.progress=null,a.model.attachment=a.model.attachment||{},a.model.attachment.uploadList=a.model.attachment.uploadList||[],_.each(a.model.attachment.uploadList,function(a){a.added=!0,a.name=a.fileName,a.uploadFinish=!0,a.success=!0,d(a)}),a.upload=function(b,d,e){b&&b.length&&(_.each(b,function(b){a.model.attachment.uploadList.push(b)}),c())},a.getLink=function(a){return a.serverDbId?app.urlPrefix+"api/upload/get/"+a.serverDbId:app.urlPrefix+"api/upload/get?path="+a.serverPath+"&name="+encodeURI(a.name)},a.getSrc=function(a){return app.urlPrefix+"images/file_word.png"}}],template:'<div class="file-uplaod ">                            <div class="ui secondary pointing tiny menu">                                <div class="active item">{{model.label}} <span ng-show="model.validations.isRequire" style="color:#db2828">&nbsp;*&nbsp;</span></div>                                <div class="ui right item" ng-hide="model.readonly">                                    <div class="pointer" ngf-select ngf-change="upload($files, $event, $rejectedFiles)" ngf-multiple="true"  ngf-allow-dir="false" ngf-accept="\'*\'">{{\'add file\' | translate}}<i class="icon plus square outline large"></i></div>                                </div>                            </div>                                                              <div ng-hide="model.attachment.uploadList.length" class="gray center aligned twelve wide column"><small>{{\'no file selected\' | translate}}</small></div>                            <div class="">                                <div ng-repeat="file in model.attachment.uploadList" class="file-item" >                                    <div class="">                                        <div class="">                                            <span class="ui img"><i class="icon file outline large" ng-class="file.icon"></i></span>                                            <span ng-hide="file.serverDbId || file.serverPath">{{file.name}} </span>                                            <a ng-show="file.serverDbId || file.serverPath"class="file-link" target="_blank" href="{{getLink(file)}}">{{file.name}} </a>                                            <span ng-show="file.uploadFinish && file.success && !model.readonly" class="pointer" ng-click="model.attachment.uploadList.splice($index,1)"><i class="icon remove small grey"></i></span>                                            <span ng-show="file.uploadFinish && !file.success" class="ui tiny"><span class="ui text tiny active inline center loader" ></span></span>                                            <sm-progress class="blue tiny" model="file.progress" ng-show="file.progress != null && !file.uploadFinish" style="margin-top:4px;"></sm-progress>                                        </div>                                    <div>                                </div>                             </div>                        </div>'}}]),ngApp.service("controlPropertyService",["formsService",function(a){function b(){return c.control}var c={};return c.control={active:null,setActive:function(a){a&&(c.control.active&&(c.control.active.isActive=!1),c.control.active=a,c.control.active.isActive=!0)},remove:function(a,b){var d=confirm(app.lang.translate("delete control message"));d&&(dangerChangeOccured=!0,c.pages.activePage.controls.splice(a,1))},createItems:function(a){if(a.dropdown.itemsTemp){var b=a.dropdown.itemsTemp.split(/[\r\n]/);a.dropdown.items=[],_.each(b,function(b){var c=b.trim();a&&""!=c&&a.dropdown.items.push({label:c,value:c})})}},resetListValue:function(){c.control.active.dropdown&&(c.control.active.dropdown.listValue=[])}},{setActive:c.control.setActive,remove:c.control.remove,getActive:c.control.active,createItems:c.control.createItems,get:b}}]),ngApp.service("updateModel",["$http",function(a){function b(a){}function c(a){}return{updateValuesForSave:c,updateValuesForGet:b}}]),ngApp.service("formsService",["$http","updateModel",function(a,b){var c=0,d=!1,e={},f=function(a){a&&(e[a]=null)},g=function(f,g){f||(f="");var h="";return g&&(h="?fromEditor=true"),e[f||"all"]||(e[f||"all"]=a.get(app.urlPrefix+"api/forms/get/"+f+h).then(function(a){return f?(b.updateValuesForGet(a.data.model.pages),a.data.model.modalSize||(a.data.model.modalSize="large"),a.data):(c=a.data.formsModule,d=a.data.securityCertPatch,a.data.list)})),e[f||"all"]},h=function(b,c){return e={},a.post(app.urlPrefix+"api/forms/save/"+b,c).then(function(a){return a.data})},i=function(b){return e={},a.post(app.urlPrefix+"api/forms/delete/"+b).then(function(a){return a.data})},j=function(b){return e={},a.post(app.urlPrefix+"api/forms/copy/"+b).then(function(a){return a.data})},k=function(b,c){return e={},a.post(app.urlPrefix+"api/forms/addFormToDashboard/"+b,c).then(function(a){return a.data})},l=function(b,c){return a.post(app.urlPrefix+"api/forms/deleteFormFromDashboard/"+b,c).then(function(a){return a.data})},m=function(b,c){var d={values:c,tableLookup:b};return a.post(app.urlPrefix+"api/forms/getTableLookup",d).then(function(a){return a.data})},n=function(b,c,d){return a.post(app.urlPrefix+"api/forms/publish",{name:c,id:b,publish:d}).then(function(a){return a.data})};return{save:h,copy:j,get:g,remove:i,addFormToDashboard:k,deleteFormFromDashboard:l,getFormsModule:function(){return c},securityCertPatch:function(){return d},clearCache:f,tableLookup:m,publish:n}}]),ngApp.directive("sadafTasks",["$compile","$timeout",function(a,b){return{restrict:"E",transclude:!0,scope:{model:"=ngModel"},controller:["$scope",function(a){function b(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,function(a){return(a^crypto.getRandomValues(new Uint8Array(1))[0]&15>>a/4).toString(16)})}a.add=function(){a.model=a.model||[],a.model.push({type:0,openLinkType:0,uuid:b()})},a.addWebParam=function(a){a.webserviceParameters=a.webserviceParameters||[],a.webserviceParameters.push({})}}],template:'<div class="" style="margin: 30px 0;"><div class="ui mini icon button" ng-click="add()">{{\'add task\' | translate}} <i class="ui icon add"></i></div><div class="ui secondary black segment" style="margin-left: -12px;margin-right: -12px;border-radius: 0;" ng-repeat="task in model" ng-init="model = model || []">        <button ng-click="model.splice($index, 1)" class="ui mini  basic icon button" style="box-shadow: none; position: absolute; top :0; left:0;" ><i class="ui icon close"></i></button>        <div class="inline fields">            <label class="four wide field">{{\'type\' | translate}}</label>            <div class="eight wide field"><sm-dropdown items="[{label:(\'goto dashboard\' | translate), value:0}                         , {label:(\'sms\' | translate), value:4}                         , {label:(\'email\' | translate), value:5}                         , {label:(\'web service\' | translate), value:2}                         , {label:(\'javascript\' | translate), value:3}]"                         style="width: 100%;"                         model="task.type" label="item.label" value="item.value"></sm-dropdown></div>        </div>        <div class="field" ng-show="task.type == 0">                 <label class="">{{\'dashboard\'|translate}}</label>                 <select-menu class="" ng-model="task.dashboardId"></select-menu>        </div>        <div class="inline fields" ng-show="task.type == 0">            <label class="four wide field">{{\'open type\'|translate}}</label>            <div class="eight wide field"><sm-dropdown items="[{label:(\'new page\' | translate), value:0}, {label:(\'current page\' | translate), value:1}]"                         style="width: 100%;"                         model="task.openLinkType" label="item.label" value="item.value"></sm-dropdown></div>        </div>        <div class="field" ng-show="task.type == 1">            <form-lookup-property ng-model="task.formInfo" settings="{selectableColumns:false}"></form-lookup-property>        </div>        <div class="field" ng-show="task.type == 2">            <label>{{\'آدرس\' | translate}}</label>            <input style="direction: ltr;" ng-model="task.webserviceUrl" placeholder="{{\'آدرس\' | translate}}">        </div>        <div class="field" ng-show="task.type == 5">            <label>{{\'موضوع\' | translate}}</label>            <input ng-model="task.subject"/>            <small>برای استفاده از متغیرها از نام متغیر با پیشوند @ استفاده کنید</small>        </div>        <div class="field" ng-show="task.type == 4 ||task.type == 5">            <label>{{\'متن پیام\' | translate}}</label>            <textarea ng-model="task.smsBody"></textarea>            <small>برای استفاده از متغیرها در متن پیام از نام متغیر با پیشوند @ استفاده کنید</small>        </div>        <div class="field" ng-show="task.type == 4 || task.type == 5">            <label>{{\'roles\' | translate}}</label>            <select-roles ng-model="task.smsRoles"></select-roles>        </div>        <div class="field" ng-show="task.type == 4 || task.type == 5">            <sadaf-checkbox ng-model="task.sendOwner" label="">ارسال به ایجاد کننده</sadaf-checkbox>            <sadaf-checkbox ng-model="task.sendEditor" label="">ارسال به ویرایش کننده</sadaf-checkbox>        </div>        <div class="inline fields" ng-show="task.type == 2">            <label class="four wide field">{{\'method\' | translate}}</label>            <div class="eight wide field"><sm-dropdown items="[                         {label:\'GET\' , value:0}                         , {label:\'POST\', value:1}]"                         style="width: 100%;"                         model="task.webserviceMethod" label="item.label" value="item.value"></sm-dropdown></div>            <div><small>در صورت نیاز به ارسال مقدار از کنترل‌های فرم در داده‌ها یا لینک از اسم فیلد مورد نظر به شکل زیر استفاده کنید.                    <span class="ltr ui code">@(field-1)</span></small></div>        </div>        <xdiv class="field" ng-show="task.type == 2">            <label>{{\'parameters\' | translate}}</label>            <div ng-repeat="p in task.webserviceParameters">                <div style="padding-left: 20px;position: relative;">                    <input ng-model="p.key" class="form-flat-input" type="text" placeholder="key">                    <input ng-model="p.value" class="form-flat-input" type="text" placeholder="value">                    <i style="position:absolute; left:0; top:0;" class="ui icon close pointer" ng-click="task.webserviceParameters.splice($index, 1)"></i>                </div>            </div>            <span class="link-button" ng-click="addWebParam(task)">{{\'new row\' | translate}} <i class="ui icon add"></i></span>            <div><small>مقدار خروجی وب سرویس در مدل مربوط به همین فیلد در مسیر زیر ذخیره می‌شود.                    <span class="ltr ui code">model.task.webserviceResult</span></small></div>        </xdiv>        <div class="field" ng-show="task.type == 2">            <label>{{\'parameters\' | translate}}</label>                    <textarea  ng-model="task.webservicePostData" class="ltr" type="text" placeholder="data"/>        </div>        <div class="field" ng-show="task.type == 2">            <label>قرارداد مقدار وب سرویس در فیلد</label>            <sm-dropdown class="selection search" model="task.webserviceResultInField" items="$parent.$parent.c.pages.activePage.controls" label="item.label" value="item.name"/>        </div>        <div class="field" ng-show="task.type == 3">            <label>{{\'javascript\' | translate}}</label>            <textarea ng-model="task.script" style="direction:ltr; font-family:monospace;"placeholder="{{\'javascript\' | translate}}"></textarea>        </div>    </div></div>'}}]),ngApp.service("taskExecutor",["$http","$rootScope",function($http,$rootScope){function exec(task,formModel,scope){function replaceValue(a){return a.replace(/@\((field-\d+)\)/gim,function(a,b){var c=findControl(b,formModel.pages);if(null===c)return"";if(19===c.type){var d=c.attachment.uploadList[0].serverPath;c.attachment.uploadList[0].serverDbId;return d}if(12===c.type){var e=c.formLookup.keyControlsBindedValue[0];return c.formLookup.keyControlsBindedText&&(e=c.formLookup.keyControlsBindedText[0]),e}return c.value})}if(0===task.type){if(!+task.dashboardId)return;var name=0===+task.openLinkType?"_blank":"_self";window.open(app.urlPrefix+"#/dashboard/"+task.dashboardId,name)}if(2===task.type){if(_.isEmpty(task.webserviceUrl))return;var url=replaceValue(task.webserviceUrl);scope.model.progress=!0;var fail=function(){scope.model.progress=!1,alert(app.lang.translate("unsuccessfull run"))},successfull=function(a){scope.model.progress=!1;var b=a.data;_.isString(b)||(b=JSON.stringify(b)),task.webserviceResult=b,formModel.webservicesData=formModel.webservicesData||{},formModel.webservicesData[scope.model.name]=b;var c=findControl(task.webserviceResultInField,formModel.pages);c&&(c.value=b)};if(1===task.webserviceMethod){var data={};task.webserviceParameters&&_.each(task.webserviceParameters,function(a){data[a.key]=a.value});var data=task.webservicePostData;data=replaceValue(data),$http({url:url,method:"POST",data:JSON.parse(data)}).then(successfull)["catch"](fail)}0===task.webserviceMethod&&$http.get(url).then(successfull)["catch"](fail)}if(3==task.type){if(_.isEmpty(replaceValue(task.script)))return;eval(task.script)}}return{exec:exec}}]),ngApp.directive("inlineStyle",["$compile",function(a){return{restrict:"E",link:function(b,c){if(c.html()){var d=a('<style ng-bind-template="'+c.html()+'"></style>');c.replaceWith(d(b))}}}}])}(),function(){var a=angular.module("sadafForms");a.directive("accessProperty",["$compile","$timeout",function(a,b){return{restrict:"E",transclude:!0,replace:!0,scope:{model:"=ngModel",controls:"=",name:"=?"},controller:["$scope","$http",function(a,b){var c={type:1,baseon:1};a.add=function(){a.model=a.model||[],a.model.push(_.extend({},c))},b.get(app.urlPrefix+"api/users/getPropertyAutoCompleteEntries").then(function(a){$scope.variables=a.data.keys})["catch"](function(){})}],templateUrl:app.urlPrefix+"dist/partial/forms/editor/components/access-property.html?v="+app.version}}])}(),function(){var a=angular.module("sadafForms");a.directive("commnetEditor",["$compile","$timeout",function(a,b){
return{restrict:"E",transclude:!0,replace:!0,scope:{model:"=ngModel",onsave:"="},controller:["$scope","$http",function(a,b){var c,d;a.change=function(a,b,d,e,f,g,h){c=f},a.onCreate=function(a){d=a,d.keyboard.addBinding({key:13,ctrlKey:!0},function(){console.log("### Cnrt + Enter")});var b='{"ops":[{"insert":"الا یا ایها الساقی ادر کاسا و ناولها"}]}';d.setContents(JSON.parse(b))},a.save=function(){a.onsave&&a.onsave(a.value,c)}}],templateUrl:app.urlPrefix+"dist/partial/forms/editor/components/comment-editor.html?v="+app.version}}])}(),function(){var a=angular.module("sadafForms");a.directive("formComment",["$compile","$timeout",function(a,b){return{restrict:"E",transclude:!0,replace:!0,scope:{model:"=ngModel"},controller:["$scope","$http",function(a,b){var c,d;a.comments=[{id:"asdfsadklfhsdfkl",userId:10,addUser:"ali",addTime:1e4,editUser:"reza",editTime:1e4,content:"<b>سلام</b> من مدیر این بخش هستم"},{id:"asdfsadklfhsdfkl",userId:10,addUser:"ali",addTime:1e4,editUser:"reza",editTime:1e4,content:"<b>سلام</b> من مدیر این بخش هستم"},{id:"asdfsadklfhsdfkl",userId:10,addUser:"ali",addTime:1e4,editUser:"reza",editTime:1e4,content:"<b>سلام</b> من مدیر این بخش هستم"},{id:"asdfsadklfhsdfkl",userId:10,addUser:"ali",addTime:1e4,editUser:"reza",editTime:1e4,content:"<b>سلام</b> من مدیر این بخش هستم"},{id:"asdfsadklfhsdfkl",userId:10,addUser:"ali",addTime:1e4,editUser:"reza",editTime:1e4,content:"<b>سلام</b> من مدیر این بخش هستم"},{id:"asdfsadklfhsdfkl2",userId:10,addUser:"ali",addTime:1e4,editUser:"reza",editTime:1e4,content:"<b>سلام</b> من مدیر این بخش هستم"}],a.change=function(a,b,d,e,f,g,h){c=f},a.onCreate=function(a){d=a;var b='{"ops":[{"insert":"الا یا ایها الساقی ادر کاسا و ناولها"}]}';d.setContents(JSON.parse(b))},a.setContent=function(){}}],templateUrl:app.urlPrefix+"dist/partial/forms/editor/components/comment.html?v="+app.version}}])}(),function(){var a=angular.module("sadafForms");a.directive("multiRowForm",["$compile","$timeout",function(a,b){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",settings:"=?",id:"@",edit:"@",ngChange:"&?",editContext:"=?"},controller:["$scope","$http","formsService","controlPropertyService","$timeout",function(a,b,c,d,e){function f(){_.each(a.model.multiRowForm.rows,function(a,b){_.each(a,function(a){a.index=b})})}a.model=a.model||{},a.firstRow=a.model.multiRowForm.rows[0],a.sortableOptions={placeholder:"form-control-highlight",handle:".drag-handle"},a.control=d.get(),a.setProp=function(b){a.control.setActive(b)},a.remove=function(b,c){var d=confirm(app.lang.translate("delete control message"));d&&a.model.multiRowForm.rows[0].splice(c,1)},a.copy=function(b,c){var d=_.extend({},b);d.name=a.editContext.pages.naming.getName(),d.columnName=d.columnName+"-copy",a.model.multiRowForm.rows[0].splice(c+1,0,d)};var g={};a.addRow=function(){if(!a.edit){var b=[];_.each(a.model.multiRowForm.emptyRow,function(c){var d=JSON.parse(JSON.stringify(c));return d.uiConfig=JSON.parse(d.uiConfigSerialized||"{}"),d.rowId=0,d&&2==d.type&&d.validations&&d.validations.autoIncrement?(g[d.name]=(g[d.name]||+d.value)+1,void(d.value=g[d.name])):(d.value=null,d.dropdown&&(d.dropdown.listValue=null),d.rowIndex=a.model.multiRowForm.rows.length,void b.push(d))}),_.each(b,function(b){a.model.setDefaultFunction&&a.model.setDefaultFunction(b)}),a.model.multiRowForm.rows.push(b),f(),a.ngChange&&a.ngChange()}},a.removeRow=function(b,c){var d=b.splice(c,1);a.model.multiRowForm.deletedIds=a.model.multiRowForm.deletedIds||[],a.model.multiRowForm.deletedIds.push(d[0][0].rowId),f()},a.model.multiRowForm.rows.length||a.addRow(),a.changeValue=function(b){a.ngChange&&a.ngChange({model:b})},a.textToDigit=function(a){return"four"==a?4:"three"==a?3:"two"==a?2:1},a.persian=persian,a.needGrid="group"!=a.model.uiConfig.theme||a.edit,f()}],template:'<div class="ui form field" ng-class="model.multiRowForm.controlSize">                            <div class="ui secondary pointing tiny menu">                                <div class="active item">{{model.label}} </div>                                <div class="ui right item" ng-hide="model.readonly">                                    <div class="pointer" ng-click="addRow()">{{model.multiRowForm.addKeyText}}<i class="icon plus square outline large"></i></div>                                </div>                            </div>                                <div ng-hide="model.multiRowForm.rows[0].length || !edit" class="gray center aligned twelve wide column"><small>{{\'drag control here\' | translate}}</small></div>                            <div class="ui {{(needGrid?\'grid\':\'\')}} content-form multi-row-container" >                            </div>                       </div>',link:function(b,c,d){function e(){b.model.multiRowForm.columns=b.model.multiRowForm.columns||3;var a=1==b.model.multiRowForm.columns?"one":2==b.model.multiRowForm.columns?"two":3==b.model.multiRowForm.columns?"three":4==b.model.multiRowForm.columns?"four":5==b.model.multiRowForm.columns?"five":6==b.model.multiRowForm.columns?"six":"eight";return a}function f(){var d,f="simple"===b.model.uiConfig.theme?"theme-simple":"normal-theme";if(b.edit)d=angular.element('<div class="drop-target '+f+' doubling column row {{model.multiRowForm.separator? \'separator\':\'\'}}" xui-sortable="sortableOptions"  xng-model="model.multiRowForm.rows[0]"                                                         ng-sortable="{group: {name: \'form\', pull:true}, animation:150}" style="min-height:100px;">                                                                <form-control ng-repeat="component in model.multiRowForm.rows[0] track by $index"                                                             ng-click="setProp(component);$event.stopPropagation();" ng-class="{active: component.isActive}" class="column" remove="remove(component, $index)" copy="copy(component, $index)" edit="true" ng-model="component" id="{{id}}" settings="{fromMultiRow:false}"></form-control>                                                </div>');else{var g='    <div style="display:flex;width:100%;align-items:baseline; padding:4px 14px; font-weight:bold" >                                                <div ng-class="{hide: component.hidden || component.systemType==1}"  style="flex-grow:{{textToDigit(component.columnClass)}};flex-basis:10%;" ng-repeat="component in model.multiRowForm.rows[0]">                                                    <div style="display:flex; padding:2px"><div style="min-width:50px">{{component.label}}</div>                                                        <div style="width:39px" ng-hide="model.readonly" ng-if="model.multiRowForm.rows.length > 1 && $last" >                                                                &nbsp;                                                            </div>                                                        </div>                                                    </div>                                                </div>                                                <div class="overflow-container" style="xheight: 200px; xoverflow: auto; width:100%; display:block;overflow-anchor: none;">                                                    <div style="display:flex;width:100%;xalign-items:baseline;" ng-repeat="row in model.multiRowForm.rows" class="table-row doubling '+e()+' no-padding {{model.multiRowForm.separator? \'separator\':\'\'}}">                                                    <div class="table-cell no-padding"style="flex-grow:{{textToDigit(component.columnClass)}};flex-basis:10%;" ng-class="{hide: component.hidden || component.systemType==1}" ng-repeat="component in row track by $index">                                                            <div style="display:flex;align-items:center;" class="" ng-if="!edit && model.multiRowForm.rows.length > 1 && $last" style="margin:0;">                                                                <form-control  change="changeValue(model)" style="flex-grow:1;" class="column" remove="remove(component, $index)" ng-model="component" id="{{id}}"  settings="{showLabel:component.index==0 && false, fromMultiRow:true}"></form-control>                                                                <div class="" ng-hide="model.readonly" style="width:32px" >                                                                    <div class="ui icon mini pointer gray" ng-click="removeRow(model.multiRowForm.rows, component.index)"><i class="icon remove"></i></div>                                                                </div>                                                            </div>                                                            <form-control change="changeValue(model)" ng-if="edit || model.multiRowForm.rows.length == 1 || !$last" class="column" remove="remove(component, $index)" ng-model="component" id="{{id}}" settings="{showLabel:component.index==0 && false, fromMultiRow:true}"></form-control>                                                    </div>                                                </div></div>';"group"==b.model.uiConfig.theme&&(g='<div class="drop-target theme-group doubling column row {{model.multiRowForm.separator? \'separator\':\'\'}}">                                            <div ng-repeat="row in model.multiRowForm.rows" class="ui segment" style="background:#fefefe;">                                                <i title="حذف کردن ردیف" class="gray pointer icon trash alternate outline" style="position:absolute;left:1rem;z-index:2;" ng-click="removeRow(model.multiRowForm.rows, $index)" xng-click="model.multiRowForm.rows.splice($index, 1)" ></i>                                                <span style="position:absolute;left:3rem;z-index:2;" class="ui tiny label" >ردیف {{persian($index+1, true)}}</span>                                                <div class="ui grid" style="padding:1rem">                                                    <form-control change="changeValue(model)" ng-repeat="component in row track by $index"  ng-model="component" id="{{id}}"></form-control>                                                </div>                                            </div>                                        </div>'),d=angular.element(g)}a(d)(b),angular.element(c[0].querySelector(".content-form")).html(d)}b.model.accessControlJustNewRecord&&_.each(b.model.multiRowForm.rows,function(a){}),b.$watch("model.multiRowForm.columns",function(a,b){f()}),_.each(b.model.multiRowForm.rows,function(a,b){_.each(a,function(a){a.rowIndex=b})})}}}])}(),function(){var a=angular.module("sadafForms");a.directive("sadafDropdownStatic",["$compile","$timeout","$http",function(a,b,c){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",formId:"@",edit:"@?",ngChange:"&",items:"="},template:"<div></div>",link:function(a,c,d){function e(){function d(){clearTimeout(j),j=setTimeout(function(){var c=$(".form-"+a.model.randomId+" .ui.dropdown").dropdown("get value"),d=_.map($(".form-"+a.model.randomId+" .ui.dropdown").dropdown("get item"),function(a){var b=$(a).text();return"undefined"===b&&(b=$(a).data("text")),b});_.isArray(c)||(c=[c]),c=_.filter(c,null),b(function(){a.model.dropdown.listValue=c,a.model.dropdown.selected=d,a.ngChange&&!l&&a.ngChange()},0)},200)}function e(c){if(a.model.dropdown.listValue||a.model.value){var d=a.model.dropdown.multiSelectDropdown?a.model.dropdown.listValue:a.model.value;d&&d.length||(d=c),null!==d&&($(g).dropdown("set selected",d),b(function(){a.model.dropdown.selected=c||d},0))}}for(var f=a.model.dropdown.multiSelectDropdown,g='<select class="temporal ui fluid '+(f?"multiple":"")+' search selection dropdown" '+(f?"multiple":"")+" >",h=a.model.dropdown.items||[],i=0;i<h.length;i++)g+='  <option value="'+h[i].value+'">'+h[i].label+"</option>";g+="</select>",g=$(g);var j,k={clearable:!0,onChange:function(c,d,e){f||b(function(){a.model.dropdown.selected=[d],a.model.value=c,a.ngChange&&!l&&a.ngChange()},0)},onRemove:function(a,b,c){d()},onAdd:function(a,b,c){d()},message:{noResults:app.lang.translate("No results found.")},fields:{remoteValues:"fields",name:"label",value:"value"},fullTextSearch:!0,forceSelection:!1},l=!0;$(c).html(g),$(g).dropdown(k),$(g).dropdown("clear"),e(),setTimeout(function(){l=!1},500)}e();var f=JSON.stringify(a.model.dropdown.items);a.$watch("model.dropdown.items",function(){var b=JSON.stringify(a.model.dropdown.items);"field-524"==a.model.name,b!=f&&(f=b,e())},!0)}}}])}(),function(){var a=angular.module("sadafForms");a.directive("sadafDropdwon",["$compile","$timeout","$http",function(a,b,c){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",formId:"@",edit:"@?",ngChange:"&"},template:"<div></div>",link:function(a,d,e){function f(){clearTimeout(o),o=setTimeout(function(){if($(".form-"+a.model.randomId+" .ui.dropdown").length){var c=$(".form-"+a.model.randomId+" .ui.dropdown").dropdown("get value"),d=_.map($(".form-"+a.model.randomId+" .ui.dropdown").dropdown("get item"),function(a){var b=$(a).text();return"undefined"===b&&(b=$(a).data("text")),b});_.isArray(c)||(c=[c]),c=_.filter(c,null),b(function(){a.model.dropdown.listValue=c,a.model.dropdown.selected=d,a.ngChange&&!r&&a.ngChange()},0)}},200)}function g(c){if(a.model.dropdown.listValue||a.model.value){var d=a.model.dropdown.multiSelectDropdown?a.model.dropdown.listValue:a.model.value;d&&d.length||(d=c),null!==d&&($(m).dropdown("set selected",d),b(function(){a.model.dropdown.selected=c||d},0))}}var h=app.urlPrefix+"api/forms/getdropdowndata",i=a.model.dropdown.isUser;i&&(h=app.urlPrefix+"api/forms/getUsers");var j=a.model.dropdown.isRole;j&&(h=app.urlPrefix+"api/forms/getRoles");for(var k=$(d).hasClass("multiple"),l=k?a.model.dropdown.listValue||[]:[a.model.value||""],m='<select class="temporal ui fluid '+(k?"multiple":"")+' search selection dropdown" '+(k?"multiple":"")+" >",n=0;n<l.length;n++)m+='  <option value="'+l[n]+'">'+l[n]+"</option>";m+="</select>",m=$(m);var o,p={onChange:function(c,d,e){k||b(function(){a.model.dropdown.selected=[d],a.model.value=c,a.ngChange&&!r&&a.ngChange()},0)},onRemove:function(a,b,c){f()},onAdd:function(a,b,c){f()},apiSettings:{url:h,cache:!1,method:"get",dataType:"json",beforeSend:function(b){return b.data={id:a.formId,name:a.model.name,query:b.urlData.query,filters:a.model.useFilter?a.model.filters:[]},!a.edit||a.model.dropdown.isUser||a.model.dropdown.isRole||(b.data={datasourceId:a.model.dropdown.remoteDatasource.value,remoteColumnKey:a.model.dropdown.remoteColumnKey,remoteColumnLabel:a.model.dropdown.remoteColumnLabel,query:b.urlData.query}),b},onResponse:function(b){return b.fields=b.fields.map(function(a){return{value:a.value.entitize(),label:a.label.entitize()}}),a.model.format&&_.each(b.fields,function(b){_.isNaN(+b.label)||_.isEmpty(b.label)||(b.label=d3.format(getFormat(a.model))(+b.label))}),b}},message:{noResults:app.lang.translate("No results found.")},fields:{remoteValues:"fields",name:"label",value:"value"},saveRemoteData:!1,fullTextSearch:!0,forceSelection:!1};$(d).append(m),$(m).dropdown(p);var q=function(){if(a.model.dropdown.listValue&&a.model.dropdown.listValue.length>0||a.model.value){var b=a.model.dropdown.listValue&&a.model.dropdown.listValue.length?a.model.dropdown.listValue:a.model.value?[a.model.value]:null,d=null;i&&(d=c.post(app.urlPrefix+"api/forms/getUsers",b)),j&&(d=c.post(app.urlPrefix+"api/forms/getRoles",b)),i||j||(d=c.get(app.urlPrefix+"api/forms/GetDropDownDataDefault",{params:{id:a.formId,name:a.model.name,values:b}})),null!=s&&clearTimeout(s),r=!0,d.then(function(a){var b=_.map(a.data.fields,function(a){return{value:a.value,name:a.label,text:a.label}}),c=_.map(a.data.fields,function(a){return a.label});$(m).dropdown("setup menu",{values:b}),g(c),s=setTimeout(function(){r=!1},500)})}},r=!0,s=setTimeout(function(){r=!1},500);q(),a.$on("dropdown-getonline-default",function(b,c){c.name===a.model.name&&q()})}}}])}(),function(){var a=angular.module("sadafForms");a.directive("sadafgroup",["$compile",function(a){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",settings:"=?",id:"@",edit:"@",change:"&?",editContext:"=?"},controller:["$scope","$http","formsService","controlPropertyService","$timeout","$mdToast",function(a,b,c,d,e,f){a.model=a.model||{},a.control=d.get(),a.setProp=function(b){a.control.setActive(b)},a.remove=function(b,c){var d=confirm(app.lang.translate("delete control message"));d&&a.model.controlGroup.controls.splice(c,1)},a.copy=function(b,c){var d=_.extend({},b);d.name=a.editContext.pages.naming.getName(),d.columnName=d.columnName+"-copy",a.model.controlGroup.controls.splice(c+1,0,d)},a.op={group:{name:"form",pull:!0},onAdd:function(a){22==a.model.type&&(a.models.splice(a.newIndex,1),showErrorToast("امکان نمایش گروه در گروه وجود ندارد",f))},animation:150},a.changeValue=function(b){a.change&&a.change({model:b})}}],template:'<div class="ui content-form" ></div>',link:function(b,c,d){function e(){var d=angular.element('    <div class="ui segment"  ng-init="model.controlGroup.controls = model.controlGroup.controls || []" ng-style="{\'background-color\':model.controlGroup.color }">        <div class="ui small header">{{model.label}}</div>            <div class="ui grid" '+(b.edit?'ng-sortable="op"':"")+' style="min-height:50px;padding:14px;">                <form-control                 ng-repeat="component in model.controlGroup.controls track by $index"                change="changeValue(model)"                ng-click="setProp(component);$event.stopPropagation();"                ng-class="{active: component.isActive}" class="column" remove="remove(component, $index)" copy="copy(component, $index)" edit="{{edit}}" ng-model="component" id="{{id}}" settings="{fromMultiRow:false}"></form-control>        </div>    </div>');a(d)(b),angular.element(c[0]).html(d)}e()}}}])}();
// داشبورد مدیریتی صدف info@sadafdashboard.ir 

function csrfSafeMethod(a){return/^(GET|HEAD|OPTIONS)$/.test(a)}var app=app||{};app.contentSegment=$("#content_segment"),app.contentSegmentModal=$("#content_segmentModal"),$.ajaxSetup({beforeSend:function(a,b){if(!csrfSafeMethod(b.type)&&!this.crossDomain){var c=$("input[name=__RequestVerificationToken]").val();a.setRequestHeader("__RequestVerificationToken",c)}}}),console||(console={},console.log=function(){}),app.chartLoadDelay=120,app.absoluteUrl="/",app.setAboluteUrl=function(a){app.absoluteUrl=a},app.loadContent=function(a){app.showLoadingProgress(),$("#content_segment").load(app.urlPrefix+a,function(){app.hideLoadingProgress(),app.lang.setLang()})},app.setContent=function(a){$("#content_segment").html(a),app.hideLoadingProgress(),app.lang.setLang()},app.setLocation=function(a){app.router.navigate(a,{trigger:!0})},app.urlPrefix="/",app.setUrlPrefix=function(a){app.urlPrefix=a.replace(/Moderation.*/g,"")},app.showInfo=function(a){$("#app-info-text").html(a),$("#app-info-text").fadeIn(),$("#app-loading-text").hide(),app.showInfoHolder.show(),setTimeout(function(){app.showInfoHolder.hide(),$("#app-info-text").fadeOut(400,function(){$("#app-loading-text").show()})},4e3)},app.showLoadingProgress=function(){app.showInfoHolder.show()},app.hideLoadingProgress=function(){app.showInfoHolder.hide()},app.showInfoHolder={holderCount:0,timeout:{},hide:function(){if(app.showInfoHolder.holderCount>0&&--app.showInfoHolder.holderCount,0==app.showInfoHolder.holderCount){var a=(new Date).getTime()-app.showInfoHolder.ticks;clearTimeout(app.showInfoHolder.timeout),setTimeout(function(){$("#app-loading").parent("div").animate({top:"0",opacity:0},400)},a<1e3?1e3:0)}},show:function(){var a=$("#app-loading").parent("div");a.css("left",$(window).width()/2-a.outerWidth()/2),++app.showInfoHolder.holderCount,app.showInfoHolder.ticks=(new Date).getTime(),app.showInfoHolder.timeout=setTimeout(function(){$("#app-loading").parent("div").animate({top:"50",opacity:1},400)},1e3)}},app.encodeHTML=function(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},app.convertOldPropObject=function(a,b){if(a){if(a.chartProp&&a.chartProp.info)return a;var c={};if(c.chartProp={},+b==chartTypes.TABLE){c.chartProp.info={chartSize:a.chartProp.chartSize,pivotTable:a.chartProp.pivotTable},c.chartProp.series={};for(var d in a.seriesProp)a.seriesProp.hasOwnProperty(d)&&(c.chartProp.series[""+d]={name:a.seriesProp[""+d].table.headerName,numberFactor:"1",textAlign:a.seriesProp[""+d].table.textAlign,formatString:a.seriesProp[""+d].table.formatString,fontSize:a.seriesProp[""+d].table.fontSize,textBold:!1,textItalic:!1,color:a.seriesProp[""+d].table.fontColor}),c.chartProp.series["default"]={name:"",numberFactor:"1",textAlign:"right",formatString:"A",fontSize:"1m",textBold:!1,textItalic:!1,color:"#000000"}}if(+b==chartTypes.BAR){c.chartProp.info={chartSize:a.chartProp.chartSize,horizontalLines:a.chartProp.horizontalLine,formatString:a.chartProp.formatString},c.chartProp.series={};for(var d in a.seriesProp)a.seriesProp.hasOwnProperty(d)&&(c.chartProp.series[""+d]={name:"",numberFactor:a.seriesProp[""+d].barlineChartProp.numberFactor,seriesType:a.seriesProp[""+d].barlineChartProp.barlineChartType,seriesColor:a.seriesProp[""+d].barlineChartProp.barlineChartColor,lineType:a.seriesProp[""+d].barlineChartProp.barlineChartTypeLineProp.lineChartStyle,lineStyle:a.seriesProp[""+d].barlineChartProp.barlineChartTypeLineProp.lineChartLineStyle,lineWeight:a.seriesProp[""+d].barlineChartProp.barlineChartTypeLineProp.lineChartLineWeight,lineFace:a.seriesProp[""+d].barlineChartProp.barlineChartTypeLineProp.lineChartLineDashes});c.chartProp.series["default"]={name:"",numberFactor:"1",seriesType:"bar",seriesColor:"#1f77b4",lineType:"line-dot-area",lineStyle:"linear",lineWeight:"2",lineFace:"5,0"}}return+b==chartTypes.PIE&&(c.chartProp.info={horizontalLines:a.chartProp.horizontalLine,chartSize:a.chartProp.chartSize,formatString:a.chartProp.formatString,pieStyle:a.chartProp.pieStyle,hole:"65"},c.chartProp.series={},c.chartProp.series["default"]={numberFactor:"1"}),+b==chartTypes.GAUGE&&(c.chartProp.info={chartSize:a.chartProp.chartSize,style:a.chartProp.gaugeStyle,height:"medium",color:"#333333",fontSize:"3em",formatString:",.2f",status:"",target:"",textBold:!0,textItalic:!1,trend:"",value:"",segmentType:"singleSegment",min:"",yellow:"",green:"",max:""},c.chartProp.series={},c.chartProp.series["default"]={numberFactor:"1",type:"value",typeMs:"value"}),c.dataUrl=a.chartProp.DataUrl,c.editMode=a.chartProp.editMode,c}},app.autoPlayTimer=app.autoPlayTimer||{counter:0},app.autoPlay=function(a,b){if(a&&"start"==a){var c=function(a){b=b||10,$(".sadaf-circular-preogress").progressbar(10,1e3*+b),app.autoPlayTimer.timer=setTimeout(function(){document.location.href=app.urlPrefix+"#/app/"+a.appId+"/dashboard/"+a.id,$(".sadaf-circular-preogress").progressbar("stop"),app.autoPlay("start",b)},1e3*+b)};app.autoPlayTimer.links?c(app.autoPlayTimer.links[app.autoPlayTimer.counter++%app.autoPlayTimer.links.length]):$.get(app.urlPrefix+"api/menus/get").done(function(a){app.autoPlayTimer.links=a,c(app.autoPlayTimer.links[app.autoPlayTimer.counter++%app.autoPlayTimer.links.length])})}a&&"stop"==a&&($(".sadaf-circular-preogress").progressbar("stop"),clearTimeout(app.autoPlayTimer.timer))};var resizeTimer;app.lestenWindowResize=function(a){function b(){clearTimeout(resizeTimer),resizeTimer=setTimeout(function(){a()},400)}var c=$(window).width();$(window).resize(function(){$(window).width();$(window).width()!=c&&(c=$(this).width(),b())})};var designMenuTimer,printMenuTimer;app.onMenusClick=function(a,b){return"showPrintMenu"==a||"hidePrintMenu"==a?(clearTimeout(printMenuTimer),void(printMenuTimer=setTimeout(function(){"showPrintMenu"==a?$(".navbar .print-toggle").fadeIn():"hidePrintMenu"==a&&$(".navbar .print-toggle").fadeOut()},800))):(clearTimeout(designMenuTimer),designMenuTimer=setTimeout(function(){"showDesignMenu"==a?$(".navbar .design-toggle").fadeIn():"hideDesignMenu"==a&&$(".navbar .design-toggle").fadeOut(),b&&"showfullScreenMenu"==b?$(".navbar .fullscreen-toggle").parents(".pull-right").fadeIn():$(".navbar .fullscreen-toggle").parents(".pull-right").fadeOut()},800),void $("html,body").animate({scrollTop:0},"slow",function(){$(".side-menu").hasClass("open")&&$("#side-menu-toggle").click()}))},app.print={printSingle:function(a,b){var c=this.getWidgetHtml(a);app.print.print(c,b)},getWidgetHtml:function(a){var b=($(a).height(),$(a).width(),$(a).clone());b.find(".ui.dimmer .dimmer-info").html();b.find(".ui.dimmer ").remove(),b.find(".gs-resize-handle").remove(),b.find(" #sort_checkbox").remove(),b.find(" .comment").remove(),b.find(" .menu-bar").remove();var c=$("<div>").append(b).html();return c},printPage:function(){var a="",b=$("<div/>");b.append(a);$(".dashboard-page.active > a").text()},print:function(a,b,c,d){var e=1===c?"width: 297mm; height: 190mm;":"width: 210mm;height: 277mm;";"A5"==d&&(e=1===c?"width: 210mm; height: 148mm;":"width: 148mm;height: 210mm;");var f='<link href="'+app.absoluteUrl+"dist/css/dash-all"+(app.lang.isRtl?"-rtl":"")+".css?v="+app.version+'" rel="stylesheet" />                   <style  type="text/css">@page {                                margin: 1cm;                                size: '+("A5"==d?"A5":"A4")+" "+(1===c?"landscape":"portrait")+';                                @top-center {                                        content: "sadaf";                                    }                                }                                body { display: none;}                                @media print {html, body {'+e+"} body{display: block;}}                                .clusterize-scroll { max-height:initial !important;}                                img { max-width: 100%; display: block; margin: 0 auto;}                                body { overflow-y:auto; }                                .chart-data.bar-chart { display:block !important;}                                .ui.card .content { display:block;}                                .ui.card, .ui.cards >.card { -webkit-box-shadow: none;box-shadow: none;   height: auto;      }                                .chart-widget { width:auto !important;   height: auto !important;      }                    </style>",g=window.open();g.window.onafterprint=function(){g.window.close()},g.document.write('<html><head><meta charset="utf-8"><title>'+b+"</title>"+f),g.document.write("</head><body>"),g.document.write(a),g.document.write("</body></html>"),g.document.close(),g.focus(),setTimeout(function(){g.print(),g.window.onfocus=function(){}},400)},printHeaderFooter:function(a,b,c,d,e,f,g){function h(){return'<html>                                                                                                                        <head>                                                                         <meta http-equiv=Content-Type content="text/html; charset=unicode">    <title>'+b+"</title> "+j+"       <style>                                                                        body, html {                                                                   margin: 0;                                                                 direction: rtl;                                                            width: 21cm;                                                               font-family: IRMitra !important;                                           font-size: 21px;                                                           text-align: justify;                                                       color: black;                                                   }                                                                                                                                                            table.report-container {                                                       page-break-after: always;                                                  font-size:inherit;                                                         text-align: inherit;                                                   }                                                                                                                                                     thead.report-header {                                                          display: table-header-group;                                               background-color: #00000000;                                           }                                                                                                                                                     tfoot.report-footer {                                                          display: table-footer-group;                                               background-color: #00000000;                                           }                                                                                                                                                     .back {                                                                        position: fixed;                                                           top: 0;                                                                    z-index: -1;                                                           }                                                                                                                                                     u {                                                                            text-decoration: unset;                                                    border-bottom: 1px solid black;                                            line-height: 1;                                                            display: inline-block;                                                 }                                                                          .content {                                                                     width: 21cm;                                                               padding: 0 2cm;                                                        }                                                                                                                                                         .content p {                                                                   margin: 0;                                                                 line-height:1.9;                                                           margin-bottom: 10px;                                                   }                                                                                                                                                 @page {                                                                        margin: 0cm;                                                           }                                                                                                                                                                                                                                .center {                                                                      text-align: center;                                                    }                                                                                                                                                     .flex {                                                                        display: flex;                                                             -ms-flex-direction: row;                                                   -webkit-flex-direction: row;                                               flex-direction: row;                                                   }                                                                      </style>                                                               </head>                                                                                                                                               <body>                                                                         "+(e?'<img class="back" src="/api/upload/getPic/'+e+'" />':"")+'                                                                 <table class="report-container">                                                                <thead class="report-header">                                                                   <tr>                                                                                            <th>                                                                                            <div style="height:'+(f||3)+'cm">                                                                                       </div>                                                                                  </th>                                                                                   </tr>                                                                                   </thead>                                                                                    <tfoot class="report-footer">                                                                   <tr>                                                                                            <td>                                                                                            <div style="height:'+(g||3)+'cm">                                                                                       </div>                                                                                  </td>                                                                                   </tr>                                                                                   </tfoot>                                                                                    <tbody class="report-content">                                                                  <tr>                                                                                            <td>                                                                                            <div class="content"> '+a+"</div>                                                                                  </td>                                                                                   </tr>                                                                                   </tbody>                                                                                </table>                                                                                </body>                                                                                     </html>"}var i=1===c?"width: 297mm; height: 190mm;":"width: 210mm;height: 277mm;";"A5"==d&&(i=1===c?"width: 210mm; height: 148mm;":"width: 148mm;height: 210mm;");var j='<link href="'+app.absoluteUrl+"dist/css/dash-all"+(app.lang.isRtl?"-rtl":"")+".css?v="+app.version+'" rel="stylesheet" />                   <style  type="text/css">@page {                                margin: 1cm;                                size: '+("A5"==d?"A5":"A4")+" "+(1===c?"landscape":"portrait")+';                                @top-center {                                        content: "sadaf";                                    }                                }                                body { display: none;}                                @media print {html, body {'+i+"} body{display: block;}}                                .clusterize-scroll { max-height:initial !important;}                                img { max-width: 100%; display: block; margin: 0 auto;}                                body { overflow-y:auto; }                                .chart-data.bar-chart { display:block !important;}                                .ui.card .content { display:block;}                                .ui.card, .ui.cards >.card { -webkit-box-shadow: none;box-shadow: none;   height: auto;      }                                .chart-widget { width:auto !important;   height: auto !important;      }                    </style>",k=window.open();k.window.onafterprint=function(){k.window.close()},k.document.write(h()),k.document.close(),k.focus(),setTimeout(function(){k.print(),k.window.onfocus=function(){}},400)}},app.post=function(a,b,c){$.ajax({url:a,type:"POST",data:JSON.stringify(b),dataType:"json",contentType:"application/json; charset=utf-8",traditional:!0,success:c})},app.lang={langType:0,setLangTyle:function(a){this.langType=+(a||0)},isRtl:function(){return 0==app.lang.langType},translate:function(a){return app.lang.lang?app.lang.lang[a]||a:a},q:[],translateAsync:function(a,b){app.lang.lang?b&&b(app.lang.lang[a]||a):this.q.push({key:a,callback:b})},setLang:function(a){if(a&&a.data&&(this.lang=a.data),this.lang||!this.inProgress){if(!this.lang&&!this.inProgress){var b=0==app.lang.langType?"fa":"en";this.inProgress=!0;var c=app.urlPrefix+"dist/locales/locale-"+b+".js?v="+app.version;return void $.getJSON(c,null,function(a){for(app.lang.setLang({data:a});app.lang.q.length>0;){var b=app.lang.q.pop();b.callback&&b.callback(app.lang.lang[b.key]||b.key)}})}var d;d=a&&a.selector?$(a.selector).find("*[data-trans-key]"):$("*[data-trans-key]"),d.each(function(){var a=$(this),b=a.data("translated");if(!b){var c=app.lang.lang[a.data("trans-key")],d=a.data("trans-attr");d?a.attr(d,c):a.text(c),a.data("translated",!0)}})}}};var app=app||{};app.dashboardLayoutVersion=2;var dashboard={defuals:{maxCols:12},charts:[],pageInfo:{},pageId:-1,arrangePer:!1,minChartSize:{1:[500,250],2:[350,350],3:[300,200],4:[300,300],5:[500,300],6:[300,200],7:[350,50],8:[300,300],9:[300,300]},padding:10,maxCols:12,baseDimantion:{y:30},serialize:function(){dashboard.gs.serialize()},drillDownResize:function(a,b){},setMaxCols:function(){var a=dashboard.getPagePosition();dashboard.maxCols=a?a.maxCol||12:12,$("#dashboard-col").val(dashboard.maxCols)},setInfo:function(a,b,c,d,e){this.arrangePer=d||!1,this.charts=a||[],this.pageInfo=b||{chartsOrder:[],layout:[],pageLayout:"30_30_30"},this.pageId=c||-1,this.forms=e||[],this.charts=this.charts.concat(this.forms),this.setMaxCols()},disable:function(){dashboard.gs.disable(),dashboard.gs.disable_resize()},enable:function(){dashboard.gs.enable(),dashboard.gs.enable_resize()},saveSerialize:function(){dashboard.serializeData=dashboard.gs.serialize();var a=dashboard.serializeData.map(function(a){var b;return b="form"===a.type?a.id:a.data.ChartInPageId,{type:a.type,chartIdPageId:b,col:a.wgd.col,row:a.wgd.row,size_x:a.wgd.size_x,size_y:a.wgd.size_y}}),b={pageId:this.pageId,chartsPosition:a,media:dashboard.media,maxCol:dashboard.maxCols};try{"undefined"==typeof dashboard.pageInfo.layout&&(dashboard.pageInfo.layout=[]);var c=dashboard.pageInfo.layout.filter(function(a){return a.media===dashboard.media});c.length>0?c[0].chartsPosition=a:dashboard.pageInfo.layout.push({media:dashboard.media,chartsPosition:a,maxCol:dashboard.maxCols})}catch(d){}$.ajax({type:"POST",url:app.urlPrefix+"api/DashboardPage/SetChartsOrder",dataType:"json",contentType:"application/json;charset=utf-8",traditional:!0,data:JSON.stringify(b),success:function(a){}})},add:function(a,b,c,d,e){b=b>dashboard.maxCols?dashboard.maxCols:b,d=d>dashboard.maxCols?dashboard.maxCols:d,dashboard.gs.add_widget(a,b,c,d,e)},initGs:function(a){return dashboard.baseDimantion={x:$(".gridster").width()/dashboard.maxCols,y:50},dashboard.gs=$(".gridster>div").gridster({widget_margins:[0,0],widget_base_dimensions:[dashboard.baseDimantion.x,dashboard.baseDimantion.y],max_cols:dashboard.maxCols,min_cols:dashboard.maxCols,min_rows:1e3,resize:{enabled:!0,stop:function(a,b,c){dashboard.saveSerialize();var d=$(c).data("type");if("form"!==d){var e=$(c).find(".chart-data").data("settings");e.isDashboardResize=!0,$(c).find(".chart-data").charts(e.type,"refresh",e),e.widgetSize.size_y=+$(c).attr("data-sizey"),e.widgetSize.size_x=+$(c).attr("data-sizex")}}},serialize_params:function(a,b){var c=a.data("type"),d=a.data("id");return{type:c,id:d,data:a.find(".chart-data").data("settings"),wgd:b}},draggable:{handle:".content > .move, content > .move b, .content .title-content",cancel:".desc",start:function(a,b){},drag:function(a,b){},stop:function(a,b){$(b.$helper).removeClass("player-revert"),dashboard.saveSerialize()}}}).data("gridster"),a||(dashboard.gs.disable(),dashboard.gs.disable_resize()),dashboard.gs},deleteAll:function(){$("#ID0").data("settings");dashboard.gs.remove_widget($("#ID0"))},deleteChartFromGs:function(a,b){var c=$(a).parents(".chart-widget");dashboard.gs.remove_widget(c),b&&b()},getPagePosition:function(){var a=dashboard.pageInfo.layout.filter(function(a){return a.media<=dashboard.media}).sort(function(a,b){return+b.media-+a.media});if(0==a.length){var b=_.map(dashboard.pageInfo.layout,function(a){return a.media}),c=-1,d=1e3;_.each(dashboard.pageInfo.layout,function(a,b){var e=Math.abs(a.media-dashboard.media);e<d&&(d=e,c=b)}),c!=-1&&(a=[dashboard.pageInfo.layout[c]],a[0].media=b,a[0].maxCols=dashboard.maxCols)}return a[0]},getChartPosition:function(a,b,c){var d,e=null,f=1e3;"form"===a.type?(e="form",d=a.id):(d=a.pageId,f=+a.type);var g=dashboard.minChartSize[+f]||[300,300],h={col:1,row:1e3,size_x:Math.floor(g[0]/dashboard.baseDimantion.x)+1,size_y:Math.floor(g[1]/dashboard.baseDimantion.y)+1},i=[];try{var j=dashboard.getPagePosition();i=j.chartsPosition.filter(function(a){return a.chartIdPageId===d&&(!a.type||a.type===e)})}catch(k){}return i[0]||h},sortCharts:function(){try{this.charts.sort(function(a,b){try{var c=dashboard.getChartPosition(a),d=dashboard.getChartPosition(b),e=c.row==d.row?c.col>d.col?1:c.col<d.col?-1:0:c.row>d.row?1:c.row<d.row?-1:0;return e}catch(f){return-1e3}})}catch(a){Error(a)}},addTasks:[],drow:function(a){dashboard.initGs(this.arrangePer),dashboard.sortCharts();var b=0;this.charts.forEach(function(c,d){7!=+c.type&&b++;var e=b,f=setTimeout(function(){dashboard.addChart(c,null,!1,e*app.chartLoadDelay),d==dashboard.charts.length-1&&a&&a()},50*d);dashboard.addTasks.push(f)})},resize:function(){this.setMaxCols();var a=$(".chart-data").map(function(a,b){return $(b).data("settings")}).toArray();$(".gridster").remove(),$("#dashboard-chart-panel").html('<div class="gridster"><div></div></div>'),dashboard.initGs(this.arrangePer),a.forEach(function(a){dashboard.addChart(null,a,!0)}),dashboard.forms&&_.each(dashboard.forms,function(a){dashboard.addChart(a)})},addChart:function(a,b,c,d,e){var f;if(a&&"form"===a.type){var g=dashboard.getChartPosition(a),h=app.absoluteUrl+"sadaf/management/#/forms/"+a.id,i=!1,j="javascript:dashboard.deleteForm("+a.id+")",k=!1,l="";f=$('<div data-type="form" data-id="'+a.id+'" class="chart-widget"></div>');var m=dashboard.getFormTemplate(this.arrangePer,a.permissions.EditPermission,h,j,i,a.name,o,a.lastRefresh,l,k);f.append(m),f.find(".title-content").text(a.name),dashboard.add(f,g.size_x,g.size_y,g.col,g.row),$("body").trigger("form-widget-add",[a.id]),app.lang.setLang({selector:"div[data-type=form][data-id="+a.id+"]"})}else{"undefined"==typeof d&&(d=0),b&&(a={id:b.chartId,pageId:b.ChartInPageId,title:"undefined"!=typeof b.title?b.title:b.input.title,type:b.type.id,isCustom:b.type.isCustom,permissions:b.permissions,lastRefresh:b.lastRefresh,desc:b.desc});var n={chartId:a.id,ChartInPageId:a.pageId},o="ID"+a.pageId,p=b;b||(p=JSON.parse(a.detail));var q=p.chartProp.info||{},r=app.customChart.getConfig({isCustom:a.isCustom,id:+a.type},q),s=r.needServerData!==!1;q.dontShowTitle===!0&&(r.noTitle=!0),r.noTitle&&(q.dontShowTitle=!0),q.noPadding===!0&&(r.noPadding=!0);var k=!(!s||!a.isCustom&&7==+a.type),i=!(!s||!a.isCustom&&7==+a.type),h=app.absoluteUrl+"sadaf/management/#/charts/edit/0/"+n.chartId,j="javascript:dashboard.deleteChart("+n.ChartInPageId+", "+n.chartId+", "+a.permissions.DeletePermission+")",l=$("<p />");_.isEmpty(a.desc)||(l.html("<br/><b>"+app.lang.translate("desc")+":</b> "),l.append($("<span />").text(a.desc)));var t="combo-kpi"==p.dataType,m=dashboard.getChartTemplate(this.arrangePer,a.permissions.EditPermission,h,j,i,a.title,o,a.lastRefresh,l,k,t,r,q);if(f=$("<div class='chart-widget cid"+a.pageId+"'></div>"),e&&c&&e.find(".chart-data").data("isChart")?f=e.find(".chart-widget.cid"+a.pageId):f.append(m),f.find(".title-content").remove(),a.title&&!q.dontShowTitle&&(f.find(".title").append('<span class="title-content"></span>'),f.find(".title-content").text(a.title),f.find(".title-content").attr("title",a.title),f.find(".header.move").remove()),f.find(".desc-content").append(l),app.chartCommons.setBackground(f.find(".ui.card "),q),q.titleFont){var u=q.titleFont.align||"";app.lang.isRtl()||(u="right"===u?"left":"left"===u?"right":u),f.find(".ui.card .title-content").css({"font-size":q.titleFont.fontSize,color:q.titleFont.color,"font-family":q.titleFont.fontName,"font-weight":q.titleFont.bold?"bold":"normal","font-style":q.titleFont.italic?"italic":"normal","text-align":u}),f.find(".ui.card .title").css({"line-height":"1"})}f.find(".ui.card .title").css({"line-height":"1.2"}),r.noPadding&&f.find(".ui.card .title + .description").addClass("chart-fit-to-container"),a.permissions.Filter||f.find(".icon.filter").remove(),a.permissions.Description||f.find(".icon.info").remove(),a.permissions.Comment||f.find(".icon.comments").remove(),a.permissions.ExportExcel||f.find(".item.export-excel").remove(),a.isCustom&&f.find(".export-png").remove();var b=b||$.extend({permissions:a.permissions,parameters:n,chartId:n.chartId,editLink:h,removeLink:j,RemoveFromPage:this.arrangePer,ChartInPageId:a.pageId,input:{RefreshDatasource:a.RefreshDatasource},lastRefresh:a.lastRefresh,desc:a.desc,type:a.type,isCustom:a.isCustom},p);if(g=dashboard.getChartPosition(a),b.widgetSize=g,e)return void(c&&e.find(".chart-data").data("isChart")?e.find(".chart-data").charts(b.type,c,b):(e.append(f),f.find(".menu-bar ").remove(),f.find(".chart-data").charts(b.type,b)));if(dashboard.add(f,g.size_x,g.size_y,g.col,g.row),c&&e&&e.find(".chart-data").data("isChart"))f.find(".bar-chart").data("settings",b),f.find(".chart-data").charts({id:a.type,isCustom:a.isCustom},"refresh",b,!0);else{var v=setTimeout(function(){f.find(".chart-data").charts({id:a.type,isCustom:a.isCustom},b)},a.isCustom||7!==+a.type?d:0);dashboard.addTasks.push(v)}app.lang.setLang({selector:".chart-widget.cid"+a.pageId})}f.find(".show-extra-info").on("click",function(){f.find(".ui.card .ui.dimmer.overflow-auto").dimmer("show")}),f.find(".dimmer-info").on("click",function(){f.find(".ui.card .ui.dimmer").dimmer("hide")}),f.find(".refresh-chart").on("click",function(){f.find(".chart-data").charts({id:a.type,isCustom:a.isCustom},"refreshWithData",b,!0),f.find(".bar-chart").data("settings").titlebar.showProgress(!0)}),f.find(".export-excel").on("click",function(){var a=f.find(".chart-data").data("settings");app.chartCommons.setFilterParameter(a);try{a.parameters.TableInfo.IsPageValid=!0}catch(c){}$.ajax({type:"POST",url:app.urlPrefix+"api/BarChart/ExportToExcel",data:JSON.stringify({ChartId:b.chartId,ChartInPageId:b.ChartInPageId,TableInfo:a.parameters.TableInfo,IsPivot:1===+p.chartProp.info.aggregation,drillDown:a.parameters.drillDown,userControlFilter:a.parameters.userControlFilter,userVariable:a.parameters.userVariable,otherFilters:a.parameters.otherFilters,filterHierarchy:app.chartCommons.getFilterHierarchy(b.ChartInPageId)}),contentType:"application/json; charset=utf-8",dataType:"json",success:function(a){window.location=app.urlPrefix+"api/BarChart/Download?name="+a.id}})}),f.find(".export-png").on("click",function(){var b=f.get(0);html2canvas(b,{background:null,scale:5,useCORS:!0,onclone:function(b){$(b).find(".cid"+a.pageId+" .header").remove(),$(b).find(".cid"+a.pageId+" .menu-bar").remove(),$(b).find(".cid"+a.pageId+" .title-content").css("padding","10px 0"),$(b).find(".cid"+a.pageId+" #sort_checkbox").remove(),$(b).find(".cid"+a.pageId+" .comment").remove(),$(b).find(".cid"+a.pageId+" .ui.card").css("background","none"),$(b).find(".cid"+a.pageId+" rect.background").css("fill","none"),$(b).find(".cid"+a.pageId+" .line-chart .line").css("fill","none"),$(b).find(".cid"+a.pageId+" .line-chart circle").css("fill","#fff"),$(b).find(".cid"+a.pageId+" .pie-chart polyline").css("fill","none"),$(b).find(".cid"+a.pageId+" .pie-chart polyline").css("stroke-width","1px"),$(b).find(".cid"+a.pageId+" .pie-chart polyline").css("stroke","#000"),$(b).find(".cid"+a.pageId+" *").css("font-family","IRANSans,Droid,Tahoma,Arial"),$(b).find(".cid"+a.pageId+" .map-container  #state-borders").css("fill","none")}}).then(function(b){b.fillStyle=null,b.fillRect=null,b.toBlob(function(b){saveAs(b,a.title+".png")})})}),f.find(".export-print").on("click",function(){app.print.printSingle(".cid"+a.pageId,a.title)}),f.find(".clone-chart").on("click",function(){app.post(app.urlPrefix+"api/Charts/CloneChart",{Id:b.chartId,PageId:dashboard.pageId},function(a){if(a.result&&a.insertedId){var b=a.insertedId,c=app.urlPrefix+"api/dashboards/getSingleChartInfo?chartId="+b+"&chartInPageId="+a.chartInPageId;$.get(c,function(a){dashboard.charts.push(a),dashboard.addChart(a,null,!1),$("html, body").animate({scrollTop:$(document).height()-$(window).height()},1e3)})}})}),f.find(".chart-dimentions").on("click",function(){f.find(".chart-dimentions-content").transition("fade up"),f.find(".chart-dimentions").transition("fade")}),f.find(".show-chart-dimensions").on("click",function(){var a=f.find(".chart-dimentions-content");f.find(".chart-dimentions-content").transition("fade up"),f.find(".chart-dimentions").transition("fade"),""==a.html()&&(a.html('<div class="ui text active loader">در حال بارگذاری</div>'),$.ajax(app.urlPrefix+"api/chartdata/GetChart?Id="+b.chartId+"&ChartInPageId="+b.ChartInPageId).done(function(c){function d(a,b){return null!=a?"<ul class='sortable list-unstyled pointer' index='"+b+"'>"+a.map(function(a,b){return a.ShowFilter?'<li value="'+filterXSS(a.Uniquename)+'">  '+filterXSS(a.Caption)+'<i class="icon filter filter-member-dialog" style="float:left; margin-right:5px;"></i></li>':'<li value="'+filterXSS(a.Uniquename)+'"> '+filterXSS(a.Caption)+"</li>";
}).join("")+"</ul>":""}function e(){function d(b,c){var d=b[c],e=[];a.find("ul[index="+c+"] li").each(function(a,b){var c=$(this).attr("value"),f=$.grep(d,function(a){return a.Uniquename==c})[0];f.Members=$(this).data("members"),e.push(f)}),b[c]=e}d(c,"Hierarchies"),d(c,"Where"),d(c,"SeriesLevel");var e=function(a){b.parameters={filterHierarchy:app.chartCommons.getFilterHierarchy(b.ChartInPageId),chartId:b.chartId,ChartInPageId:b.ChartInPageId},$("#ID"+b.ChartInPageId).charts({id:b.type,isCustom:b.isCustom},"refreshWithData",b,{refreshRelatedDatasources:!1})};e(c)}a.data("data",c);var f=null,g=null,h=null;f=d(c.Hierarchies,"Hierarchies"),g=d(c.Where,"Where"),h=d(c.SeriesLevel,"SeriesLevel");var i='<table class="ui single line unstackable table chart-design" xstyle="display:none" xstyle="position:absolute;margin-bottom:0px; background-color:#fff;display:none; border-bottom:1px solid silver">                                           <thead><tr class="">                                             <th style="'+(""==h?"display:none":"")+'"><span data-trans-key="شاخص‌ها (ستون‌های عددی)" > </span> </th>                                             <th style="'+(""==f?"display:none":"")+'"><span data-trans-key="ابعاد (ستون‌های رشته‌ای)" > </span> </th>                                             <th style="'+(""==g?"display:none":"")+'"><span data-trans-key="شرط" > </span></th>                                         </tr></thead>                                         <tr>                                             <td  style="'+(""==h?"display:none":"")+'"id="div-x" class="myc">'+h+'</td>                                             <td  style="'+(""==f?"display:none":"")+'"id="div-y" class="myc">'+f+'</td>                                             <td  style="'+(""==g?"display:none":"")+'"id="div-where" class="myc">'+g+"</td>                                         </tr>                                     </table>";a.html(i),a.find(".filter-member-dialog").on("click",function(){function a(a,b){app.helper.filterMemberDialog(a,b,function(a){d.data("members",a),e()})}var d=$(this).parent(),f=$(this).parent().attr("value"),g=c[$(this).closest("ul").attr("index")],h=($.grep(g,function(a,b){return a.Uniquename==f})[0],$(this).parent().data("members")),i=app.urlPrefix+"api/chartdata/GetMemberOfFilterHierarchy?Uniquename="+f+"&Id="+b.chartId+"&ChartInPageId="+b.ChartInPageId;"undefined"==typeof h?$.ajax(i).done(function(b){$(this).parent().data("members",b),a(b,i)}):a(h,i)}),a.find(".sortable").sortable({start:function(a,b){b.placeholder.addClass("filter-placeholder"),b.placeholder.height(b.item.height()),b.placeholder.width(b.item.width()),b.placeholder.parent().width(b.item.width()),b.placeholder.parent().parent().width(b.item.width())},stop:function(a,b){e()}}),app.lang.setLang({selector:a.selector})}))}),f.find(".dropdown").lazyDropdown({onShow:function(a,b){f.find(".menu-bar").addClass("show-dropdown")},onHide:function(a,b){f.find(".menu-bar").removeClass("show-dropdown")}}),this.showEmptyMessageIfNeed()},showEmptyMessageIfNeed:function(){0==dashboard.charts.length?$("#chart-empty-message").hasClass("hidden")&&$("#chart-empty-message").transition("scale in"):$("#chart-empty-message").hasClass("hidden")||$("#chart-empty-message").transition("scale out")},deleteChart:function(a,b,c){if(a)c?$("#deleteChart .checkbox").show():$("#deleteChart .checkbox").hide(),$("#deleteChart").data("cId",a),$("#deleteChart").data("chartId",b),$("#deleteChart").modal("show");else{var a=$("#deleteChart").data("cId"),b=$("#deleteChart").data("chartId"),d=app.urlPrefix+"api/dashboardPage/removeChartFromPage";$("#deleteChart .action-btn").addClass("loading"),$.post(d,{ChartInPageId:a,pageId:dashboard.pageId},function(b){if(0==b)return void alert("شما مجوز پاک کردن این نمودار را ندارید");for(var c,d=0;d<dashboard.charts.length;d++)if(dashboard.charts[d].pageId==a){c=dashboard.charts[d].pageId,dashboard.charts.splice(d,1)}dashboard.deleteChartFromGs("#ID"+c,function(){$(this).remove(),dashboard.showEmptyMessageIfNeed()}),$("#deleteChart").modal("hide"),$("#deleteChart .action-btn").removeClass("loading")});var e=$("#delete-from-dash").prop("checked");e&&$.post(app.urlPrefix+"api/Charts/DeleteCharts",{Ids:["ChartId-"+b]},function(a){})}},deleteForm:function(a){$("body").trigger("delete-form",[a,dashboard.pageId])},setReturnUrl:function(a){app.mobileMode||(localStorage.setItem("returnUrl",window.location.href),localStorage.setItem("lastEditedChartId",a))},getChartTemplate:function(a,b,c,d,e,f,g,h,i,j,k,l){return'<div class="ui card">  <div class="content" style="">    <div class="header '+(a?"move":"")+'" style="position:absolute; width:50%;z-index:2;">&nbsp;</div>    <div class="title'+(l.noTitle===!0?" no-title ":a?" move":"")+'">            <div class="menu-bar" style="z-index:3;">                <i class="icon titlebar-icon" style="xbackground: #fff;width: 100%;position: absolute;display: block;top: 0;height: 100%;"></i>                '+(app.mobileMode?e?'<i class="info icon chart-setting-icon show-extra-info pointer titlebar-icon"></i>':"":'<div class="ui dropdown" >                        <i class="setting icon chart-setting-icon titlebar-icon"></i>                        <div class=" menu transition hidden" tabindex="-1">                          '+(b?' <a class="item"  href="'+c+'" onclick="dashboard.setReturnUrl(\''+g+'\')"><span data-trans-key="ویرایش" > </span> <i class="edit outline icon"></i></a>':"")+"                          "+(b?' <a class="item clone-chart"><span data-trans-key="تکرار" > </span> <i class="clone outline icon"></i></a>':"")+"                          "+(a?'<a class="item" href="'+d+'"><span data-trans-key="حذف نمودار از صفحه" > </span> <i class="trash alternate outline icon"></i></a>':"")+"                          "+(j?'<a class="item export-excel"><span data-trans-key="خروجی اکسل" > </span> <i class="file excel outline icon"></i></a>':"")+"                          "+(j?'<a class="item export-png"><span data-trans-key="export png"> </span> <i class="camera icon"></i></a>':"")+"                          "+(e?'<a class="item refresh-chart">'+app.lang.translate("data refresh")+' <i class="refresh icon"></i></a>':"")+"                          "+(j?'<a class="item export-print"><span data-trans-key="print" > </span> <i class="print icon"></i></a>':"")+'                        </div>                </div>                <div class=" ">                    '+(e?'<i class="info icon chart-setting-icon show-extra-info pointer titlebar-icon"></i>':"")+"                    "+(!e||k?"":'<i class="filter icon chart-setting-icon show-chart-dimensions pointer titlebar-icon"></i>')+"                    "+(e&&app.commentOnChart?'<i class="comments icon chart-setting-icon show-chart-comments pointer titlebar-icon"></i>':"")+"                </div>")+'            </div>            </div>    <div class="description chart-data bar-chart" id="'+g+'">      <div class="ui active inverted dimmer ">        <div class="ui text loader mini"></div>      </div>    </div>  </div>  <div class="progress-overall"></div>  <div class="chart-dimentions"></div>  <div class="chart-dimentions-content"></div>  <div class="ui dimmer overflow-auto" style="padding:10px;border-radius: '+(app.mobileMode?"0":"4")+'px !important;"><div class="content"><div class="center"><div class="dimmer-info"><b>'+app.lang.translate("lastUpdate")+':</b> <span class="last-refresh"> </span><div class="desc-content"></div></div></div></div></div></div>'},getFormTemplate:function(a,b,c,d,e,f,g,h,i,j){return'<div class="ui card ">  <div class="content" style="background-color:#f4f6f9;">    <div class="header '+(a?"move":"")+'">            <div class="menu-bar ">                '+(a||b?'<div class="ui dropdown" >                        <i class="setting icon chart-setting-icon"></i>                        <div class=" menu transition hidden" tabindex="-1">                          '+(b?' <a class="item"  href="'+c+'" onclick="dashboard.setReturnUrl(\''+g+'\')"><span data-trans-key="ویرایش" > </span> <i class="edit icon"></i></a>':"")+"                          "+(a?'<a class="item" href="'+d+'"><span data-trans-key="حذف" > </span> <i class="trash alternate outline icon"></i></a>':"")+"                                                   </div>                </div>":"")+'                <div class="">                   <i xclass="info icon chart-setting-icon show-extra-info pointer"></i>                </div>            </div>        <span class="title-content"></span>    </div>    <div class="description form-content " id="'+g+'">      <div class="ui active inverted dimmer ">        <div class="ui text loader tiny">'+app.lang.translate("در حال بارگذاری")+'</div>      </div>    </div>  </div>  <div class="progress-overall"></div>  <div class="chart-dimentions"></div>  <div class="chart-dimentions-content"></div>  <div class="ui dimmer overflow-auto" style="padding:10px;border-radius: 4px !important;"><div class="content"><div class="center"><div class="dimmer-info desc-content"></div></div></div></div></div>'},setLastRefresh:function(a,b){var c=$(".cid"+a+" .last-refresh");c.html(app.chartCommons.lastRefreshDateFormat(b))}};angular.module("uibCollapseCat",[]).directive("uibCollapse",["$animate","$q","$parse","$injector",function(a,b,c,d){var e=d.has("$animateCss")?d.get("$animateCss"):null;return{link:function(d,f,g){function h(){f.hasClass("collapse")&&f.hasClass("in")||b.resolve(l(d)).then(function(){f.removeClass("collapse").addClass("collapsing").attr("aria-expanded",!0).attr("aria-hidden",!1),e?e(f,{addClass:"in",easing:"ease",to:{height:f[0].scrollHeight+"px"}}).start()["finally"](i):a.addClass(f,"in",{to:{height:f[0].scrollHeight+"px"}}).then(i)})}function i(){f.removeClass("collapsing").addClass("collapse").css({height:"auto"}),m(d)}function j(){return f.hasClass("collapse")||f.hasClass("in")?void b.resolve(n(d)).then(function(){f.css({height:f[0].scrollHeight+"px"}).removeClass("collapse").addClass("collapsing").attr("aria-expanded",!1).attr("aria-hidden",!0),e?e(f,{removeClass:"in",to:{height:"0"}}).start()["finally"](k):a.removeClass(f,"in",{to:{height:"0"}}).then(k)}):k()}function k(){f.css({height:"0"}),f.removeClass("collapsing").addClass("collapse"),o(d)}var l=c(g.expanding),m=c(g.expanded),n=c(g.collapsing),o=c(g.collapsed);d.$eval(g.uibCollapse)||f.addClass("in").addClass("collapse").attr("aria-expanded",!0).attr("aria-hidden",!1).css({height:"auto"}),d.$watch(g.uibCollapse,function(a){a?j():h()})}}}]);var manageApp=angular.module("management",["sadafForms","ngRoute","ngMaterial","ngAnimate","ngMessages","datasourceScheduleCat","datasourcePartitionExpressionCat","pascalprecht.translate","ngSanitize","mdColorPicker","ui.ace","ui.sortable","uibCollapseCat","textAngular","ngQuill","services"]);manageApp.config(["$locationProvider",function(a){a.hashPrefix("")}]),manageApp.config(["ngQuillConfigProvider",function(a){var b=Quill["import"]("attributors/style/size");b.whitelist=["12px","14px","16px","18px","20px","24px","28px","32px","38px","48px","72px"],Quill.register(b,!0),a.set({modules:{toolbar:[[{header:[1,2,!1]},"bold","italic","underline","strike",{size:["12px","14px","16px","18px","20px","24px","28px","32px","38px","48px","72px"]},{direction:"rtl"},{align:[]},{color:[]},{background:[]},"clean"]]},placeholder:"متن را وارد کنید",theme:"snow"})}]),manageApp.config(["$provide",function(a){}]),manageApp.config(["$mdThemingProvider",function(a){a.theme("default").primaryPalette("blue").accentPalette("indigo").warnPalette("red").backgroundPalette("grey"),a.theme("t1").primaryPalette("grey").accentPalette("red").warnPalette("red").backgroundPalette("grey")}]),manageApp.config(["$translateProvider",function(a){a.useStaticFilesLoader({prefix:app.urlPrefix+"dist/locales/locale-",suffix:".js?v="+app.version}),a.preferredLanguage("fa"),a.useSanitizeValueStrategy("sanitizeParameters")}]);var logout=_.debounce(function(){alert("مهلت اعتبار ارتباط شما با سایت پایان یافته، لطفا دوباره وارد شوید"),document.location="/account/login"},1e3);manageApp.factory("httpResponseInterceptor",["$q","$rootScope","$location",function(a,b,c){return{responseError:function(b){return 401===b.status&&logout(),a.reject(b)}}}]),manageApp.config(["$httpProvider",function(a){a.interceptors.push("httpResponseInterceptor");var b=$("input[name=__RequestVerificationToken]").val();a.defaults.headers.post.__RequestVerificationToken=b,a.defaults.headers.post.RequestVerificationToken=b}]),manageApp.config(["$provide",function(a){a.decorator("taOptions",["$delegate",function(a){return a.forceTextAngularSanitize=!0,a.toolbar=[["h1","h2","h3","h4","h5","h6","p","pre","quote"],["bold","italics","underline","ul","ol","redo","undo","clear"],["justifyLeft","justifyCenter","justifyRight","justifyFull"]],a.classes={focussed:"focussed",toolbar:"btn-toolbar",toolbarGroup:"btn-group",toolbarButton:"btn btn-default",toolbarButtonActive:"active",disabled:"disabled",textEditor:"form-control",htmlEditor:"form-control"},a}])}]);var service=["$http","$interval",function(a,b){var c;return{start:function(){},stop:function(){b.cancel(c)}}}];try{var sadaf=angular.module("sadaf");sadaf.factory("heartBeat",service),sadaf.run(["heartBeat",function(a){app.mobileMode||a.start()}])}catch(e){}try{var management=angular.module("management");management.factory("heartBeat",service),management.run(["heartBeat",function(a){app.mobileMode||a.start()}])}catch(e){}angular.module("ui.mask",[]).value("uiMaskConfig",{maskDefinitions:{2:/[0,1,2]/,6:/[0,1,2,3,4,5,6]/,9:/\d/,A:/[a-zA-Z]/,"*":/[a-zA-Z0-9]/},clearOnBlur:!0}).directive("uiMask",["uiMaskConfig","$parse",function(a,b){"use strict";return{priority:100,require:"ngModel",restrict:"A",compile:function(){var c=a;return function(a,d,e,f){function g(a){return angular.isDefined(a)?(t(a),O?(l(),m(),!0):k()):k()}function h(a){angular.isDefined(a)&&(E=a,O&&x())}function i(a){return O?(H=p(a||""),J=o(H),f.$setValidity("mask",J),J&&H.length?q(H):void 0):a}function j(a){return O?(H=p(a||""),J=o(H),f.$viewValue=H.length?q(H):"",f.$setValidity("mask",J),""===H&&e.required&&f.$setValidity("required",!f.$error.required),J?H:void 0):a}function k(){return O=!1,n(),angular.isDefined(Q)?d.attr("placeholder",Q):d.removeAttr("placeholder"),angular.isDefined(R)?d.attr("maxlength",R):d.removeAttr("maxlength"),d.val(f.$modelValue),f.$viewValue=f.$modelValue,!1}function l(){H=L=p(f.$viewValue||""),I=K=q(H),J=o(H);var a=J&&H.length?I:"";e.maxlength&&d.attr("maxlength",2*C[C.length-1]),d.attr("placeholder",E),d.val(a),f.$viewValue=a}function m(){P||(d.bind("blur",u),d.bind("mousedown mouseup",v),d.bind("input keyup click focus",x),P=!0)}function n(){P&&(d.unbind("blur",u),d.unbind("mousedown",v),d.unbind("mouseup",v),d.unbind("input",x),d.unbind("keyup",x),d.unbind("click",x),d.unbind("focus",x),P=!1)}function o(a){return!a.length||a.length>=G}function p(a){var b="",c=D.slice();return a=a.toString(),angular.forEach(F,function(b){a=a.replace(b,"")}),angular.forEach(a.split(""),function(a){c.length&&c[0].test(a)&&(b+=a,c.shift())}),b}function q(a){var b="",c=C.slice();return angular.forEach(E.split(""),function(d,e){a.length&&e===c[0]?(b+=a.charAt(0)||"_",a=a.substr(1),c.shift()):b+=d}),b}function r(a){var b=e.placeholder;return"undefined"!=typeof b&&b[a]?b[a]:"_"}function s(){return E.replace(/[_]+/g,"_").replace(/([^_]+)([a-zA-Z0-9])([^_])/g,"$1$2_$3").split("_")}function t(a){var b=0;if(C=[],D=[],E="","string"==typeof a){G=0;var c=!1,d=0,e=a.split("");angular.forEach(e,function(a,e){S.maskDefinitions[a]?(C.push(b),E+=r(e-d),D.push(S.maskDefinitions[a]),b++,c||G++):"?"===a?(c=!0,d++):(E+=a,b++)})}C.push(C.slice().pop()+1),F=s(),O=C.length>1}function u(){S.clearOnBlur&&(M=0,N=0,J&&0!==H.length||(I="",d.val(""),a.$apply(function(){f.$setViewValue("")})))}function v(a){"mousedown"===a.type?d.bind("mouseout",w):d.unbind("mouseout",w)}function w(){N=B(this),d.unbind("mouseout",w)}function x(b){b=b||{};var c=b.which,e=b.type;if(16!==c&&91!==c){var g,h=d.val(),i=K,j=p(h),k=L,l=!1,m=z(this)||0,n=M||0,o=m-n,r=C[0],s=C[j.length]||C.slice().shift(),t=N||0,u=B(this)>0,v=t>0,w=h.length>i.length||t&&h.length>i.length-t,x=h.length<i.length||t&&h.length===i.length-t,D=c>=37&&c<=40&&b.shiftKey,E=37===c,F=8===c||"keyup"!==e&&x&&o===-1,G=46===c||"keyup"!==e&&x&&0===o&&!v,H=(E||F||"click"===e)&&m>r;if(N=B(this),!D&&(!u||"click"!==e&&"keyup"!==e)){if("input"===e&&x&&!v&&j===k){for(;F&&m>r&&!y(m);)m--;for(;G&&m<s&&C.indexOf(m)===-1;)m++;var I=C.indexOf(m);j=j.substring(0,I)+j.substring(I+1),l=!0}for(g=q(j),K=g,L=j,d.val(g),l&&a.$apply(function(){f.$setViewValue(j)}),w&&m<=r&&(m=r+1),H&&m--,m=m>s?s:m<r?r:m;!y(m)&&m>r&&m<s;)m+=H?-1:1;(H&&m<s||w&&!y(n))&&m++,M=m,A(this,m)}}}function y(a){return C.indexOf(a)>-1}function z(a){if(!a)return 0;if(void 0!==a.selectionStart)return a.selectionStart;if(document.selection){a.focus();var b=document.selection.createRange();return b.moveStart("character",a.value?-a.value.length:0),b.text.length}return 0}function A(a,b){if(!a)return 0;if(0!==a.offsetWidth&&0!==a.offsetHeight)if(a.setSelectionRange)a.focus(),a.setSelectionRange(b,b);else if(a.createTextRange){var c=a.createTextRange();c.collapse(!0),c.moveEnd("character",b),c.moveStart("character",b),c.select()}}function B(a){return a?void 0!==a.selectionStart?a.selectionEnd-a.selectionStart:document.selection?document.selection.createRange().text.length:0:0}var C,D,E,F,G,H,I,J,K,L,M,N,O=!1,P=!1,Q=e.placeholder,R=e.maxlength,S={};e.uiOptions?(S=a.$eval("["+e.uiOptions+"]"),angular.isObject(S[0])&&(S=function(a,b){for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&(void 0===b[c]?b[c]=angular.copy(a[c]):angular.extend(b[c],a[c]));return b}(c,S[0]))):S=c,e.$observe("uiMask",g),e.$observe("placeholder",h);var T=!1;e.$observe("modelViewValue",function(a){"true"===a&&(T=!0)}),a.$watch(e.ngModel,function(c){if(T&&c){var d=b(e.ngModel);d.assign(a,f.$viewValue)}}),f.$formatters.push(i),f.$parsers.push(j),d.bind("mousedown mouseup",v),Array.prototype.indexOf||(Array.prototype.indexOf=function(a){if(null===this)throw new TypeError;var b=Object(this),c=b.length>>>0;if(0===c)return-1;var d=0;if(arguments.length>1&&(d=Number(arguments[1]),d!==d?d=0:0!==d&&d!==1/0&&d!==-(1/0)&&(d=(d>0||-1)*Math.floor(Math.abs(d)))),d>=c)return-1;for(var e=d>=0?d:Math.max(c-Math.abs(d),0);e<c;e++)if(e in b&&b[e]===a)return e;return-1})}}}}]);var ngApp=angular.module("management");ngApp.directive("menuContainer",function(){return{restrict:"E",transclude:!0,scope:{openMenuName:"="},controller:["$scope",function(a){var b=a.menus=[];a.openMenuName&&(a.openMenuName.set=function(a){_.forEach(b,function(b){b.name===a&&b.header.click(!0)})}),a.select=function(a){angular.forEach(b,function(a){a.selected=!1}),a.selected=!0},this.addMenu=function(a){a.header.click=function(c){var d=a.header.isOpen;c&&(d=!1),_.forEach(b,function(a){a.header.isOpen=!1,a.body.isOpen=!1}),a.header.isOpen=!d,a.body.isOpen=!d},b.push(a)}}],template:"<div ng-transclude ></div>"}}).directive("menuItem",function(){return{require:"^^menuContainer",restrict:"E",transclude:!0,scope:{name:"@"},link:function(a,b,c,d){d.addMenu(a)},controller:["$scope",function(a){a.select=function(){},this.addHeader=function(b){a.header=b},this.addBody=function(b){a.body=b}}],template:"<div ng-transclude></div><md-divider></md-divider>"}}).directive("menuHeader",function(){return{require:"^^menuItem",restrict:"E",transclude:!0,scope:{},link:function(a,b,c,d){d.addHeader(a)},controller:["$scope",function(a){}],template:'<md-list-item class="md-no-sticky pointer header" ng-click="click()" ng-class="{active: isOpen}">               <div layout="row" flex layout-align="start center">                                                                  <div ng-transclude style="display:inline-block"> </div>                                                          <span flex></span>                                                                                               <span class="material-icons icon-animate " ng-click="click()" ng-class="{rotate : isOpen}">keyboard_arrow_down</span>             </div>                                                                                                       </md-list-item>'}}).directive("menuBody",function(){return{restrict:"E",require:"^^menuItem",transclude:!0,scope:{},link:function(a,b,c,d){d.addBody(a)},template:'<div uib-collapse="!isOpen"><div class="menu-body-container" ng-transclude></div></div>'}}).directive("switchButton",function(){return{restrict:"E",transclude:!0,scope:{ngModel:"="},template:'<div style="display:inline-block" class="switch-button" ng-click="ngModel = !ngModel" ng-class="{ active : ngModel}"><div ng-transclude style="display:inline-block"></div></div>'}}).directive("sadafIndicator",function(){return{restrict:"E",transclude:!0,scope:{model:"=ngModel",config:"=?",series:"=",onChange:"&ngChange",hideThen:"@"},controller:["$scope","$translate",function(a,b){var c=a.model;a.hideThen;c.ifRow=c.ifRow||[{}],c.thenRow=c.thenRow||[{}],_.each(c.thenRow,function(a){a.iconModel={name:a.secondFieldIcon||"icon warning",type:"icon"}}),a.ops=[{value:"1",name:"=="},{value:"2",name:"!="},{value:"3",name:"<"},{value:"4",name:"<="},{value:"5",name:">"},{value:"6",name:">="},{value:"7",name:"contain"},{value:"8",name:"not_contain"}],a.thenOps=[{value:"1",name:"change_color"},{value:"2",name:"add_icon"},{value:"3",name:"change_back_color"},{value:"4",name:"change_style"},{value:"5",name:"replace"},{value:"6",name:"chart_background"},{value:"7",name:"رنگ علامت روی نقشه"}],a.config=a.config||{};var d=a.config.show||[1,2,3,4,5];a.thenOps=_.filter(a.thenOps,function(a){return d.indexOf(+a.value)!==-1})}],template:'<div>                                                                                                                                                         <div class="form-row layout-align-start-center layout-row" layout="row" layout-align="start center">                <label class= "col-sm-4" >نام شرط</label>                <span class="form-divider flex" flex=""></span>                <div class="col-sm-8">                    <div ng-click="model.labelIsColumn = !model.labelIsColumn" ng-class="{\'active\' : model.labelIsColumn}" class="ui mini icon basic compact button"><i class="ui icon terminal"></i></div>                    <select class="expression-select"  ng-model="model.labelColumn" ng-options="s as s for s in series" ng-show="model.labelIsColumn" ng-change="onChange()"></select>                    <input ng-hide="model.labelIsColumn" type="text" class="form-control ng-pristine ng-untouched ng-valid ng-not-empty" placeholder="نام شرط" ng-change="onChange()" ng-model-options="{ updateOn: \'blur\' }" ng-model="model.title" aria-invalid="false" style="">                </div></div>    <div ng-repeat="i in model.ifRow track by $index" class="form-row" xlayout="row" xlayout-align="start center">                                                                                                                      <select class="expression-select" ng-model="i.firstField" style="border-bottom: 1px solid silver !important;" ng-options="s as s for s in series" ng-change="onChange()"></select>                                                                 <select class="expression-select" style="direction: ltr;" ng-model="i.operand" ng-options="s.value as (s.name | translate) for s in ops" ng-change="onChange()"></select>                                                <div ng-click="i.secondFieldIsText = !i.secondFieldIsText" ng-class="{\'active\' : i.secondFieldIsText}" class="ui mini icon basic compact button"><i class="ui icon terminal"></i></div>                <select class="expression-select" style="border-bottom: 1px solid silver !important;" ng-model="i.secondFieldSelect" ng-options="s as s for s in series" ng-show="!i.secondFieldIsText" ng-change="onChange()"></select>                           <input ng-model="i.secondFieldInput" type="text" ng-show="i.secondFieldIsText"  ng-change="onChange()"/>                                                             <span xclass="ui mini basic compact icon button" ng-click="model.ifRow.splice( $index+1, 0, {})"><i class="ui tiny icon pointer plus"></i></span>                                                                                                     <span xclass="ui mini basic compact icon button" ng-click="model.ifRow.splice($index, 1); onChange()" ng-show="model.ifRow.length > 1"><i class="ui tiny icon pointer minus"></i></span>                             </div>                                                                                                                                                           <div ng-repeat="i in model.thenRow track by $index" ng-hide="hideThen" class="form-row" layout="row" layout-align="start center">                                                                          <span ng-show="model.thenRow.length > 1 && !$first">{{ \'and\' | translate }}</span>                                                                                 <span>{{ \'then\' | translate }}</span>                                                                                                                              <select style="max-width:60px" ng-model="i.firstField" ng-options="s as s for s in series" ng-change="onChange()"></select>                                                                 <select style="xmax-width:60px" ng-model="i.operand" ng-options="s.value as (s.name | translate) for s in thenOps" ng-change="onChange()"></select>                                            <span style="margin-left:3px;" md-color-picker ng-model="i.secondFieldColor" ng-show="i.operand == 1" md-color-default-tab="\'genericPalette\'"  on-change="onChange()"></span>               <span style="margin-left:3px;"  ng-show="i.operand == 1 && config.stripeEnable" ><label>رنگ به صورت هاشور<input ng-change="onChange()" ng-model="i.isStriped" type="checkbox" /></label></span>               <span style="margin-left:3px;" md-color-picker ng-model="i.symbolColor" ng-show="i.operand == 7" md-color-default-tab="\'genericPalette\'" on-change="onChange()"></span>            <span style="margin-left:3px;" md-color-picker ng-model="i.secondFieldBackColor" ng-show="i.operand == 6" md-color-default-tab="\'genericPalette\'" on-change="onChange()"></span>            <span style="margin-left:3px;" md-color-picker ng-model="i.secondFieldBackColor" ng-show="i.operand == 3" md-color-default-tab="\'genericPalette\'" on-change="onChange()"></span>            <select ng-show="i.operand == 4" ng-model="i.secondFieldStyle" ng-change="onChange()" ng-options="i.name as  i.value for i in [                                    {name:\'1\', value: \'normal\'  },                                     {name:\'2\', value: \'bold\'  },                                      {name:\'3\', value: \'italic\'  },                                     {name:\'4\', value: \'bold_italic\'  },                                     {name:\'5\', value: \'underline\'  },                                 ]">                                                                               </select>                                                                                                                                                            <input ng-model="i.secondFieldReplace" type="text" ng-show="i.operand == 5" />                                                                                                                                                                                                                                                            <div ng-show="i.operand == 2">             <sadaf-icons ng-model="i.secondFieldIcon" ng-change="onChange()"></sadaf-icons>        </div>                      <span class="ui mini basic compact icon button" ng-click="model.thenRow.splice( $index+1, 0, {secondFieldIcon:{name:\'icon warning\', type:\'icon\'}})"><i class="icon plus"></i></span>                                                                                                     <span class="ui mini basic compact icon button" ng-click="model.thenRow.splice($index, 1); onChange()" ng-show="model.thenRow.length > 1"><i class="icon minus"></i></span>                              </div>                                                                                                                                                           </div>'}}).directive("sadafContactList",function(){return{restrict:"E",transclude:!0,scope:{model:"=ngModel"},controller:["$scope",function(a){a.model=a.model||[{}]}],template:'<div class="ui tiny form">                                                                                                     <div ng-repeat="i in model" class="fields" >                                                              <div class="field"><input ng-model="i.phone" type="text"  placeholder="{{\'phone\' | translate}}"/></div>                       <div class="field"><input ng-model="i.email" type="text"  placeholder="{{\'email\' | translate}}"/></div>                       <div class="field">                        <i class="icon tiny plus pointer grey" ng-click="model.splice( $index+1, 0, {})"></i>                                                   <i class="icon tiny minus pointer grey" ng-click="model.splice($index, 1)" ng-show="model.length > 1"></i>                        </div>                </div>                                                                                             </div>'}}).directive("sadafRemovable",function(){return{restrict:"E",transclude:!0,scope:{onDelete:"&onDelete"},controller:["$scope",function(a){a.model=a.model||[{}]}],template:'<div layout="row" layout-align="start center">                <span class ="material-icons small" ng-click="onDelete()">close</span>                <div ng-transclude></div>            </div>'}}).directive("fileread",[function(){return{scope:{fileread:"="},link:function(a,b,c){b.bind("change",function(b){a.$apply(function(){a.fileread=a.fileread||{},a.fileread=b.target.files[0]})})}}}]).directive("xtree",function(){return{restrict:"E",transclude:!0,scope:{root:"=ngModel",option:"=",url:"&"},controller:["$scope","$http","$translate",function(a,b,c){function d(a,b){b(a),a.nodes&&(_.forEach(a.nodes,function(a){d(a,b)}),_.forEach(a.contents,function(a){d(a,b)}))}a.root=a.root||{name:"root",open:!0},a.active=function(b){var c=b.active;a.option.multiple||d(a.root,function(a){a.active=!1}),b.active=c},a.selectAll=function(a,b){_.each(a.contents,function(a){a.active=b})}}],template:'<div class ="sadaf-tree">                                                                                                                                    <div style="list-style:none" class ="tree-element ul">                                                                                                       <div ng-repeat="data in [root]" class ="tree-element li" ng-include="\'tree_item_renderer.html\'"></div>                                             </div>                                                                                                                                               </div>                                                                                                                                                                                                                                                                                                            <script type="text/ng-template" id="tree_item_renderer.html">                                                                                                <collapse class ="block" selectable-dir="option.selectableDir" ng-model="data"                                                                               hide-icon="{{(!data.nodes || !data.nodes.length ) && ( option.justDir || ( !data.contents || !data.contents.length) ) && data.loaded }}">                                                                                                                                                                         <collapse-header class ="block" ng-click="$event.stopPropagation(); option.url(data)">                                                                       <md-checkbox ng-show="option.selectableDir" ng-model="data.active"ng-change="active(data)" ng-click="$event.stopPropagation()"                                       style="margin:0">{{data.name}}</md-checkbox>                                                                                                 <span ng-show="!option.selectableDir">{{data.name}}</span>                                                                                           </collapse-header>                                                                                                                                                                                                                                                                                                <collapse-body class ="block">                                                                                                                               <div class ="tree-element ul" style="list-style:none" >                                                                                                      <div class="ui active dimmer inverted" style="position:inherit; display:inline" ng-show="!data.loaded">                     <div class="ui active mini inline text loader">                                                         </div>                                                                                                                                                                        </div>                                                                                                                                                                        <div ng-show="data.loaded" class ="tree-element li"><md-checkbox ng-show="option.multiple" ng-click="$event.stopPropagation()" ng-model="data.selectAll" ng-change="selectAll(data, data.selectAll)"><small> {{"select_all" | translate}} </small></md-checkbox></div>                                                                                                                                               <div ng-repeat="data in data.nodes" class ="tree-element li" ng-include="\'tree_item_renderer.html\'"></div>                                             <div ng-repeat="u in data.contents" class ="tree-element li" ng-class ="{active : u.active}" ng-hide="option.justDir">                                       <md-checkbox ng-model="u.active" ng-change="active(u)" style="margin-bottom:0">{{u.name}}</md-checkbox>                                              </div>                                                                                                                                               </div>                                                                                                                                               </collapse-body>                                                                                                                                                                                                                                                                                              </collapse>                                                                                                                                                                                                                                                                                                   </script>'
}}).directive("menuPermission",function(){return{restrict:"E",transclude:!0,scope:{menus:"=",roles:"="},controller:["$scope","$http","$translate",function(a,b,c){}],template:'            <menu-item class="panel ">                <menu-header>{{ \'menus\' | translate }}</menu-header>                <menu-body>                    <div style="margin:0 20px">                                                              {{menus}}<collapse ng-repeat="(k,v) in menus">                                                                   <div layout="row">                                                                                             <collapse-header>                                                                                              {{k}}                                                                                                  </collapse-header>                                                                                         <span flex></span>                                                                                     </div>                                                                                                     <collapse-body>                                                                                                <div style="margin:0 20px">                                                                                <div ng-repeat="r in v" layout="row" layout-align="start center">                                              <md-checkbox ng-model="r.check">{{r.name}}</md-checkbox>                                                   <span flex></span>                                                                                                                                                                                                 </div>                                                                                                 </div>                                                                                                 </collapse-body>                                                                                       </collapse>                                                                                            </div>                                                                                         </menu-body>            </menu-item>            <menu-item class="panel ">                <menu-header>{{ \'datasources\' | translate }}</menu-header>                <menu-body>                    <datasource-permission ng-model="roles" class="block" type="chart" id="{{parent.id}}"></datasource-permission>                </menu-body>            </menu-item>'}}).directive("legendPosition",function(){return{restrict:"E",transclude:!0,scope:{model:"=ngModel",change:"&ngChange"},controller:["$scope","$http","$translate",function(a,b,c){a.model=a.model||"top left"}],template:'<div class="position-circles">                                                                                                                                                                                                                 <i ng-click="model=\'top left\';change()" ng-class="{active: model==\'top left\'}" class="icon circle" style="top:0;left:0"></i>                                            <i ng-click="model=\'top right\';change()" ng-class="{active: model==\'top right\'}" class="icon circle" style="top:0;right:0"></i>                                         <i ng-click="model=\'top center\';change()" ng-class="{active: model==\'top center\'}" class="icon circle" style="top:0;left:11px"></i>                                     <i ng-click="model=\'bottom left\';change()" ng-class="{active: model==\'bottom left\'}" class="icon circle" style="bottom:0;left:0"></i>                                   <i ng-click="model=\'bottom right\';change()" ng-class="{active: model==\'bottom right\'}" class="icon circle" style="bottom:0;right:0"></i>                                <i ng-click="model=\'bottom center\';change()" ng-class="{active: model==\'bottom center\'}" class="icon circle" style="bottom:0;left:11px"></i>                            <i ng-click="model=\'center right\';change()" ng-class="{active: model==\'center right\'}" class="icon circle" style="top:11px;right:0"></i>                                <i ng-click="model=\'center left\';change()" ng-class="{active: model==\'center left\'}" class="icon circle" style="top:11px;left:0"></i>                               </div>'}}).directive("sdFormat",function(){return{restrict:"E",transclude:!0,scope:{model:"=ngModel",change:"&ngChange"},controller:["$scope","$http","$translate",function(a,b,c){a.model=a.model||",.0f"}],template:"<select ng-change=\"change()\" ng-model=\"model\"  ng-options=\"i.name as  i.value for i in [                                    {name:'A', value: 'عادی'  },                                                                                                                             {name:'.0%', value:'درصد' },                                                                                                                               {name:',.1%', value:'#,#.0%'},                                                                                                                           {name:',.2%', value:'#,#.00%'},                                                                                                                          {name:',.0f', value:'#,#'},                                                                                                                              {name:',.1f', value:'#,#.0'},                                                                                                                            {name:',.2f', value:'#,#.00'},                                                                                                                           {name:',.3s', value:'#,#K'},                                                                                                                             {name:'(,.0f', value:'(#,#)'},                                                                                                                             {name:'(,.1f', value:'(#,#.0)'},                                                                                                                             {name:'(,.2f', value:'(#,#.00)'},                                                                                                                             {name:'custom', value:'سفارشی' },                                                                                                                   ]\">"}}).directive("sdTimeFunction",function(){return{restrict:"E",transclude:!0,scope:{model:"=ngModel"},controller:["$scope","$http","$translate",function(a,b,c){a.$watch("model",function(b){a.model&&a.model.variableDefaultFunction||(a.model=_.extend({},{variableDefaultFunction:"MonthToDate",functionDateFormat:"yy/mm/dd",functionUnitAgo:1,functionUnitAgoOffset:"1",functionUnitAgoTwo:1,functionUnitAgoTwoOffset:"1"},b))})}],templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/types/timeFunction.html?v="+app.version}}).directive("intervalFetch",function(){return{restrict:"E",transclude:!0,scope:{model:"=ngModel",fields:"=?",datasourceId:"@"},controller:["$scope","$http","$translate","intervalFetchService",function(a,b,c,d){function e(a){a.timex=moment.utc(a.time).fromNow(),a.time=moment.utc(a.time).format("jYYYY/jMM/jDD HH:mm:ss")}function f(){a.loadRequests=!0,a.loadRequestsError=!1,d.get(a.datasourceId,g,h).then(function(b){a.loadRequests=!1,_.each(b,function(a){e(a)}),a.requests=a.requests.concat(b),_.each(a.requests,function(a){a.duration=moment.duration(a.duration).format("h:mm:ss:SSS")}),g+=b.length,b.length<(h||20)&&(a.noMore=!0)},function(b){a.loadRequests=!1,a.loadRequestsError=!0})}var g=0,h=20;a.requests=[],$(".ui.dimmer.modals .interval-fetch-modal").remove(),a.model=a.model||{dateType:"jalali-date"},f(),a.more=function(){f()},a.deleteAll=function(){var b=confirm("با حذف تمام درخواست‌ها، اطلاعات موجود در منبع داده نیز پاک می‌شوند. آیا برای حذف همه اطمینان دارید؟");b&&(a.deleteAllProgress=!0,d.deleteAll(a.datasourceId).then(function(){a.deleteAllProgress=!1,a.requests=null},function(){a.deleteAllProgress=!1}))},a.addModel={},a.addNew=function(){return a.addModel.addFrom&&a.addModel.addTo?(a.addNewProgress=!0,void d.add(a.datasourceId,a.addModel.addFrom,a.addModel.addTo).then(function(b){a.addNewProgress=!1,b.refreshProgress=!1,e(b),a.requests=a.requests||[],a.requests.push(b),$(".ui.interval-fetch-modal").modal("hide")},function(){a.addNewProgress=!1,alert("اجرا با خطا مواجه شد!")})):void alert("مقادیر شروع و پایان باید وارد شود")},a.addModal=function(){$(".ui.interval-fetch-modal").modal("show")},a["delete"]=function(b){var c=confirm("آیا برای حذف اطمینان دارید؟");c&&(b.refreshProgress=!0,d.remove(b.id).then(function(){b.refreshProgress=!0,_.remove(a.requests,{id:b.id})},function(){alert("خطایی در حذف اطلاعات رخ داده است"),b.refreshProgress=!1}))},a.refresh=function(a){a.refreshProgress=!0,d.refresh(a.id).then(function(b){a.refreshProgress=!1,e(b),a.timex=b.timex,a.time=b.time,a.effectedRows=b.effectedRows,a.duration=b.duration},function(){a.refreshProgress=!1})},a.persian=persian,a.d3=d3}],templateUrl:app.urlPrefix+"dist/partial/management/directives/interval-fetch.html?v="+app.version}}).directive("fetchLoop",function(){return{restrict:"E",transclude:!0,scope:{model:"=ngModel"},controller:["$scope","$http","$translate",function(a,b,c){a.persian=persian,a.d3=d3}],templateUrl:app.urlPrefix+"dist/partial/management/directives/fetch-loop.html?v="+app.version}}).directive("rolesTree",function(){return{restrict:"E",transclude:!0,scope:{root:"="},controller:["$scope","$http","$translate","roles","$mdToast","utils",function(a,b,c,d,e,f){a.app=app,a.selected=null,a.deleteOne=function(b){a.selected=b;$(".role-delete-modal").modal("show")},a.deleteRole=function(c){function g(a,b){if(_.isArray(a.nodes))for(var c=0;c<a.nodes.length;c++){if(a.nodes[c].id==b.id)return void a.nodes.splice(c,1);g(a.nodes[c],b)}}a.deleteType=c?"with-child":"";var h=app.urlPrefix+"api/roles/delete"+(c?"?withChild=true":"");null!=a.selected&&(a.deleteProgress=!0,b.post(h,[a.selected.id]).then(function(b){d.reset(),g(a.root,a.selected);var c=e.simple().textContent("حذف انجام شد");e.show(c),$(".role-delete-modal").modal("hide"),console.log($(".role-delete-modal")),a.deleteProgress=!1},function(b){a.deleteProgress=!1,f.showErrorToast(b.data.desc),$(".role-delete-modal").modal("hide")}))},$(".ui.dimmer.modals .role-delete-modal").remove()}],templateUrl:app.urlPrefix+"dist/partial/management/directives/roles-tree.html?v="+app.version}}).directive("printSettings",function(){return{restrict:"E",transclude:!0,scope:{model:"=ngModel"},controller:["$scope","$http","$translate","roles","$mdToast","utils",function(a,b,c,d,e,f){}],templateUrl:app.urlPrefix+"dist/partial/management/directives/print-settings.html?v="+app.version}}).directive("sadafIcons",function(){return{scope:{model:"=ngModel",change:"&ngChange",type:"@"},controller:["$scope","$http","$translate","roles","$timeout","utils","$mdMenu",function(a,b,c,d,e,f,g){a.id=_.random(1e5,999999,!1),a.app=app,a.icons=["add to calendar icon","address book icon","address book outline icon","address card icon","address card outline icon","alarm icon","alarm mute icon","alarm mute outline icon","alarm outline icon","at icon","browser icon","bug icon","calendar icon","calendar outline icon","checked calendar icon","cloud icon","code icon","comment icon","comment outline icon","comments icon","comments icon","comments outline icon","copyright icon","creative commons icon","dashboard icon","delete calendar icon","external icon","external icon","external square icon","eyedropper icon","feed icon","find icon","hand pointer icon","handshake icon","hashtag icon","heartbeat icon","history icon","home icon","hourglass empty icon","hourglass end icon","hourglass full icon","hourglass half icon","hourglass start icon","id badge icon","id card icon","id card outline icon","idea icon","image icon","inbox icon","industry icon","lab icon","mail icon","mail outline icon","mail square icon","mouse pointer icon","open envelope icon","open envelope outline icon","options icon","paint brush icon","payment icon","percent icon","podcast icon","privacy icon","protect icon","registered icon","remove from calendar icon","search icon","setting icon","settings icon","shop icon","shopping bag icon","shopping basket icon","sidebar icon","signal icon","sitemap icon","tag icon","tags icon","tasks icon","terminal icon","text telephone icon","ticket icon","trademark icon","trophy icon","window close icon","window close outline icon","window maximize icon","window minimize icon","window restore icon","add to cart icon","add user icon","adjust icon","archive icon","ban icon","bookmark icon","call icon","call square icon","clone icon","cloud download icon","cloud upload icon","talk icon","talk outline icon","compress icon","configure icon","download icon","edit icon","erase icon","exchange icon","expand icon","external share icon","filter icon","hide icon","in cart icon","lock icon","mail forward icon","object group icon","object ungroup icon","pin icon","print icon","random icon","recycle icon","refresh icon","remove bookmark icon","remove user icon","repeat icon","reply all icon","reply icon","retweet icon","send icon","send outline icon","share alternate icon","share alternate square icon","share icon","share square icon","sign in icon","sign out icon","theme icon","translate icon","undo icon","unhide icon","unlock alternate icon","unlock icon","upload icon","wait icon","wizard icon","write icon","write square icon","announcement icon","birthday icon","help circle icon","help icon","info circle icon","info icon","warning circle icon","warning icon","warning sign icon","child icon","doctor icon","handicap icon","spy icon","student icon","user icon","user circle","user circle outline","user outline","users icon","female icon","gay icon","genderless icon","heterosexual icon","intergender icon","lesbian icon","male icon","man icon","neuter icon","non binary transgender icon","other gender horizontal icon","other gender icon","other gender vertical icon","transgender icon","woman icon","block layout icon","crop icon","grid layout icon","list layout icon","maximize icon","resize horizontal icon","resize vertical icon","zoom icon","zoom out icon","anchor icon","bar icon","bathtub icon","bomb icon","book icon","bullseye icon","calculator icon","cocktail icon","diamond icon","fax icon","fire extinguisher icon","fire icon","flag checkered icon","flag icon","flag outline icon","gift icon","hand lizard icon","hand peace icon","hand paper icon","hand rock icon","hand scissors icon","hand spock icon","law icon","leaf icon","legal icon","lemon icon","life ring icon","lightning icon","magnet icon","money icon","moon icon","plane icon","puzzle icon","road icon","rocket icon","shipping icon","shower icon","snowflake icon","soccer icon","sticky note icon","sticky note outline icon","suitcase icon","sun icon","thermometer empty icon","thermometer quarter icon","thermometer half icon","thermometer three quarters icon","thermometer full icon","travel icon","treatment icon","tv icon","umbrella icon","world icon","asterisk icon","certificate icon","circle icon","circle notched icon","circle thin icon","crosshairs icon","cube icon","cubes icon","ellipsis horizontal icon","ellipsis vertical icon","quote left icon","quote right icon","spinner icon","square icon","square outline icon","add circle icon","add square icon","check circle icon","check circle outline icon","check square icon","checkmark box icon","checkmark icon","minus circle icon","minus icon","minus square icon","minus square outline icon","move icon","plus icon","plus square outline icon","radio icon","remove circle icon","remove circle outline icon","remove icon","selected radio icon","toggle off icon","toggle on icon","area chart icon","bar chart icon","camera retro icon","film icon","line chart icon","newspaper icon","photo icon","pie chart icon","sound icon","angle double down icon","angle double left icon","angle double right icon","angle double up icon","angle down icon","angle left icon","angle right icon","angle up icon","arrow circle down icon","arrow circle left icon","arrow circle outline down icon","arrow circle outline left icon","arrow circle outline right icon","arrow circle outline up icon","arrow circle right icon","arrow circle up icon","arrow down icon","arrow left icon","arrow right icon","arrow up icon","caret down icon","caret left icon","caret right icon","caret up icon","chevron circle down icon","chevron circle left icon","chevron circle right icon","chevron circle up icon","chevron down icon","chevron left icon","chevron right icon","chevron up icon","long arrow down icon","long arrow left icon","long arrow right icon","long arrow up icon","pointing down icon","pointing left icon","pointing right icon","pointing up icon","toggle down icon","toggle left icon","toggle right icon","toggle up icon","mobile icon","tablet icon","battery empty icon","battery low icon","battery medium icon","battery high icon","battery full icon","desktop icon","disk outline icon","game icon","keyboard icon","laptop icon","plug icon","power icon","file archive outline icon","file audio outline icon","file code outline icon","file excel outline icon","file icon","file image outline icon","file outline icon","file pdf outline icon","file powerpoint outline icon","file text icon","file text outline icon","file video outline icon","file word outline icon","folder icon","folder open icon","folder open outline icon","folder outline icon","level down icon","level up icon","trash icon","trash outline icon","barcode icon","bluetooth alternative icon","bluetooth icon","css3 icon","database icon","fork icon","html5 icon","microchip icon","openid icon","qrcode icon","rss icon","rss square icon","server icon","usb icon","empty heart icon","empty star icon","frown icon","heart icon","meh icon","smile icon","star half empty icon","star half icon","star icon","thumbs down icon","thumbs outline down icon","thumbs outline up icon","thumbs up icon","backward icon","closed captioning icon","eject icon","fast backward icon","fast forward icon","forward icon","music icon","mute icon","pause circle icon","pause circle outline icon","pause icon","play icon","record icon","step backward icon","step forward icon","stop circle icon","stop circle outline icon","stop icon","unmute icon","video play icon","video play outline icon","volume down icon","volume off icon","volume up icon","bicycle icon","building icon","building outline icon","bus icon","car icon","coffee icon","compass icon","emergency icon","first aid icon","food icon","h icon","hospital icon","hotel icon","location arrow icon","map icon","map outline icon","map pin icon","map signs icon","marker icon","military icon","motorcycle icon","paw icon","ship icon","space shuttle icon","spoon icon","street view icon","subway icon","taxi icon","train icon","television icon","tree icon","university icon","columns icon","sort alphabet ascending icon","sort alphabet descending icon","sort ascending icon","sort content ascending icon","sort content descending icon","sort descending icon","sort icon","sort numeric ascending icon","sort numeric descending icon","table icon","bitcoin icon","dollar icon","euro icon","lira icon","pound icon","ruble icon","rupee icon","shekel icon","won icon","yen icon","wheelchair icon","asl interpreting icon","assistive listening systems icon","audio description icon","blind icon","braille icon","deafness icon","low vision icon","sign language icon","universal access icon","volume control phone icon","align center icon","align justify icon","align left icon","align right icon","attach icon","bold icon","copy icon","cut icon","font icon","header icon","indent icon","italic icon","linkify icon","list icon","ordered list icon","outdent icon","paragraph icon","paste icon","save icon","strikethrough icon","subscript icon","superscript icon","text cursor icon","text height icon","text width icon","underline icon","unlinkify icon","unordered list icon"],a.faIcons=["abacus","acorn","ad","address-book","address-card","adjust","air-freshener","alarm-clock","alicorn","align-center","align-justify","align-left","align-right","allergies","ambulance","american-sign-language-interpreting","analytics","anchor","angle-double-down","angle-double-left","angle-double-right","angle-double-up","angle-down","angle-left","angle-right","angle-up","angry","ankh","apple-alt","apple-crate","archive","archway","arrow-alt-circle-down","arrow-alt-circle-left","arrow-alt-circle-right","arrow-alt-circle-up","arrow-alt-down","arrow-alt-from-bottom","arrow-alt-from-left","arrow-alt-from-right","arrow-alt-from-top","arrow-alt-left","arrow-alt-right","arrow-alt-square-down","arrow-alt-square-left","arrow-alt-square-right","arrow-alt-square-up","arrow-alt-to-bottom","arrow-alt-to-left","arrow-alt-to-right","arrow-alt-to-top","arrow-alt-up","arrow-circle-down","arrow-circle-left","arrow-circle-right","arrow-circle-up","arrow-down","arrow-from-bottom","arrow-from-left","arrow-from-right","arrow-from-top","arrow-left","arrow-right","arrow-square-down","arrow-square-left","arrow-square-right","arrow-square-up","arrow-to-bottom","arrow-to-left","arrow-to-right","arrow-to-top","arrow-up","arrows-alt-h","arrows-alt-v","arrows-alt","arrows-h","arrows-v","arrows","assistive-listening-systems","asterisk","at","atlas","atom-alt","atom","audio-description","award","axe-battle","axe","backpack","backspace","backward","badge-check","badge-dollar","badge-percent","badge","badger-honey","balance-scale-left","balance-scale-right","balance-scale","ballot-check","ballot","ban","band-aid","barcode-alt","barcode-read","barcode-scan","barcode","bars","baseball-ball","baseball","basketball-ball","basketball-hoop","bat","bath","battery-bolt","battery-empty","battery-full","battery-half","battery-quarter","battery-slash","battery-three-quarters","bed","beer","bell-school-slash","bell-school","bell-slash","bell","bezier-curve","bible","bicycle","binoculars","birthday-cake","blanket","blender-phone","blender","blind","bold","bolt","bomb","bone-break","bone","bong","book-alt","book-dead","book-heart","book-open","book-reader","book-spells","book","bookmark","books","booth-curtain","bow-arrow","bowling-ball","bowling-pins","box-alt","box-ballot","box-check","box-fragile","box-full","box-heart","box-open","box-up","box-usd","box","boxes-alt","boxes","boxing-glove","braille","brain","briefcase-medical","briefcase","broadcast-tower","broom","browser","brush","bug","building","bullhorn","bullseye-arrow","bullseye-pointer","bullseye","burn","bus-alt","bus-school","bus","business-time","cabinet-filing","calculator-alt","calculator","calendar-alt","calendar-check","calendar-edit","calendar-exclamation","calendar-minus","calendar-plus","calendar-star","calendar-times","calendar","camera-alt","camera-retro","camera","campfire","campground","candle-holder","candy-corn","cannabis","capsules","car-alt","car-battery","car-bump","car-crash","car-garage","car-mechanic","car-side","car-tilt","car-wash","car","caret-circle-down","caret-circle-left","caret-circle-right","caret-circle-up","caret-down","caret-left","caret-right","caret-square-down","caret-square-left","caret-square-right","caret-square-up","caret-up","cart-arrow-down","cart-plus","cat","cauldron","certificate","chair-office","chair","chalkboard-teacher","chalkboard","charging-station","chart-area","chart-bar","chart-line-down","chart-line","chart-pie-alt","chart-pie","check-circle","check-double","check-square","check","chess-bishop-alt","chess-bishop","chess-board","chess-clock-alt","chess-clock","chess-king-alt","chess-king","chess-knight-alt","chess-knight","chess-pawn-alt","chess-pawn","chess-queen-alt","chess-queen","chess-rook-alt","chess-rook","chess","chevron-circle-down","chevron-circle-left","chevron-circle-right","chevron-circle-up","chevron-double-down","chevron-double-left","chevron-double-right","chevron-double-up","chevron-down","chevron-left","chevron-right","chevron-square-down","chevron-square-left","chevron-square-right","chevron-square-up","chevron-up","child","church","circle-notch","circle","city","claw-marks","clipboard-check","clipboard-list-check","clipboard-list","clipboard-prescription","clipboard","clock","clone","closed-captioning","cloud-download-alt","cloud-download","cloud-drizzle","cloud-hail-mixed","cloud-hail","cloud-meatball","cloud-moon-rain","cloud-moon","cloud-rain","cloud-rainbow","cloud-showers-heavy","cloud-showers","cloud-sleet","cloud-snow","cloud-sun-rain","cloud-sun","cloud-upload-alt","cloud-upload","cloud","clouds-moon","clouds-sun","clouds","club","cocktail","code-branch","code-commit","code-merge","code","coffee-togo","coffee","coffin","cog","cogs","coins","columns","comment-alt-check","comment-alt-dollar","comment-alt-dots","comment-alt-edit","comment-alt-exclamation","comment-alt-lines","comment-alt-minus","comment-alt-plus","comment-alt-slash","comment-alt-smile","comment-alt-times","comment-alt","comment-check","comment-dollar","comment-dots","comment-edit","comment-exclamation","comment-lines","comment-minus","comment-plus","comment-slash","comment-smile","comment-times","comment","comments-alt-dollar","comments-alt","comments-dollar","comments","compact-disc","compass-slash","compass","compress-alt","compress-wide","compress","concierge-bell","container-storage","conveyor-belt-alt","conveyor-belt","cookie-bite","cookie","copy","copyright","corn","couch","cow","credit-card-blank","credit-card-front","credit-card","cricket","crop-alt","crop","cross","crosshairs","crow","crown","cube","cubes","curling","cut","dagger","database","deaf","democrat","desktop-alt","desktop","dewpoint","dharmachakra","diagnoses","diamond","dice-d10","dice-d12","dice-d20","dice-d4","dice-d6","dice-d8","dice-five","dice-four","dice-one","dice-six","dice-three","dice-two","dice","digital-tachograph","diploma","directions","divide","dizzy","dna","do-not-enter","dog-leashed","dog","dollar-sign","dolly-empty","dolly-flatbed-alt","dolly-flatbed-empty","dolly-flatbed","dolly","donate","door-closed","door-open","dot-circle","dove","download","drafting-compass","dragon","draw-circle","draw-polygon","draw-square","drum-steelpan","drum","drumstick-bite","drumstick","duck","dumbbell","dungeon","ear","eclipse-alt","eclipse","edit","eject","elephant","ellipsis-h-alt","ellipsis-h","ellipsis-v-alt","ellipsis-v","empty-set","engine-warning","envelope-open-dollar","envelope-open-text","envelope-open","envelope-square","envelope","equals","eraser","euro-sign","exchange-alt","exchange","exclamation-circle","exclamation-square","exclamation-triangle","exclamation","expand-alt","expand-arrows-alt","expand-arrows","expand-wide","expand","external-link-alt","external-link-square-alt","external-link-square","external-link","eye-dropper","eye-evil","eye-slash","eye","fast-backward","fast-forward","fax","feather-alt","feather","female","field-hockey","fighter-jet","file-alt","file-archive","file-audio","file-certificate","file-chart-line","file-chart-pie","file-check","file-code","file-contract","file-csv","file-download","file-edit","file-excel","file-exclamation","file-export","file-image","file-import","file-invoice-dollar","file-invoice","file-medical-alt","file-medical","file-minus","file-pdf","file-plus","file-powerpoint","file-prescription","file-signature","file-spreadsheet","file-times","file-upload","file-user","file-video","file-word","file","fill-drip","fill","film-alt","film","filter","fingerprint","fire-extinguisher","fire-smoke","fire","first-aid","fish","fist-raised","flag-alt","flag-checkered","flag-usa","flag","flame","flask-poison","flask-potion","flask","flushed","fog","folder-minus","folder-open","folder-plus","folder-times","folder","folders","font","football-ball","football-helmet","forklift","forward","fragile","frog","frown-open","frown","function","funnel-dollar","futbol","gamepad","gas-pump-slash","gas-pump","gavel","gem","genderless","ghost","gift-card","gift","glass-martini-alt","glass-martini","glasses-alt","glasses","globe-africa","globe-americas","globe-asia","globe-stand","globe","golf-ball","golf-club","gopuram","graduation-cap","greater-than-equal","greater-than","grimace","grin-alt","grin-beam-sweat","grin-beam","grin-hearts","grin-squint-tears","grin-squint","grin-stars","grin-tears","grin-tongue-squint","grin-tongue-wink","grin-tongue","grin-wink","grin","grip-horizontal","grip-vertical","h-square","h1","h2","h3","hammer-war","hammer","hamsa","hand-heart","hand-holding-box","hand-holding-heart","hand-holding-magic","hand-holding-seedling","hand-holding-usd","hand-holding-water","hand-holding","hand-lizard","hand-paper","hand-peace","hand-point-down","hand-point-left","hand-point-right","hand-point-up","hand-pointer","hand-receiving","hand-rock","hand-scissors","hand-spock","hands-heart","hands-helping","hands-usd","hands","handshake-alt","handshake","hanukiah","hashtag","hat-witch","hat-wizard","haykal","hdd","head-side","head-vr","heading","headphones-alt","headphones","headset","heart-circle","heart-rate","heart-square","heart","heartbeat","helicopter","helmet-battle","hexagon","highlighter","hiking","hippo","history","hockey-mask","hockey-puck","hockey-sticks","home-heart","home","hood-cloak","horse","hospital-alt","hospital-symbol","hospital","hot-tub","hotel","hourglass-end","hourglass-half","hourglass-start","hourglass","house-damage","house-flood","hryvnia","humidity","hurricane","i-cursor","id-badge","id-card-alt","id-card","image","images","inbox-in","inbox-out","inbox","indent","industry-alt","industry","infinity","info-circle","info-square","info","inhaler","integral","intersection","inventory","italic","jack-o-lantern","jedi","joint","journal-whills","kaaba","key-skeleton","key","keyboard","keynote","khanda","kidneys","kiss-beam","kiss-wink-heart","kiss","kite","kiwi-bird","knife-kitchen","lambda","lamp","landmark-alt","landmark","language","laptop-code","laptop","laugh-beam","laugh-squint","laugh-wink","laugh","layer-group","layer-minus","layer-plus","leaf-heart","leaf-maple","leaf-oak","leaf","lemon","less-than-equal","less-than","level-down-alt","level-down","level-up-alt","level-up","life-ring","lightbulb-dollar","lightbulb-exclamation","lightbulb-on","lightbulb-slash","lightbulb","link","lips","lira-sign","list-alt","list-ol","list-ul","list","location-arrow","location-circle","location-slash","location","lock-alt","lock-open-alt","lock-open","lock","long-arrow-alt-down","long-arrow-alt-left","long-arrow-alt-right","long-arrow-alt-up","long-arrow-down","long-arrow-left","long-arrow-right","long-arrow-up","loveseat","low-vision","luchador","luggage-cart","lungs","mace","magic","magnet","mail-bulk","male","mandolin","map-marked-alt","map-marked","map-marker-alt-slash","map-marker-alt","map-marker-check","map-marker-edit","map-marker-exclamation","map-marker-minus","map-marker-plus","map-marker-question","map-marker-slash","map-marker-smile","map-marker-times","map-marker","map-pin","map-signs","map","marker","mars-double","mars-stroke-h","mars-stroke-v","mars-stroke","mars","mask","medal","medkit","megaphone","meh-blank","meh-rolling-eyes","meh","memory","menorah","mercury","meteor","microchip","microphone-alt-slash","microphone-alt","microphone-slash","microphone","microscope","mind-share","minus-circle","minus-hexagon","minus-octagon","minus-square","minus","mobile-alt","mobile-android-alt","mobile-android","mobile","money-bill-alt","money-bill-wave-alt","money-bill-wave","money-bill","money-check-alt","money-check","monitor-heart-rate","monkey","monument","moon-cloud","moon-stars","moon","mortar-pestle","mosque","motorcycle","mountain","mountains","mouse-pointer","music","narwhal","network-wired","neuter","newspaper","not-equal","notes-medical","object-group","object-ungroup","octagon","oil-can","oil-temp","om","omega","otter","outdent","paint-brush-alt","paint-brush","paint-roller","palette","pallet-alt","pallet","paper-plane","paperclip","parachute-box","paragraph","parking-circle-slash","parking-circle","parking-slash","parking","passport","pastafarianism","paste","pause-circle","pause","paw-alt","paw-claws","paw","peace","pegasus","pen-alt","pen-fancy","pen-nib","pen-square","pen","pencil-alt","pencil-paintbrush","pencil-ruler","pencil","pennant","people-carry","percent","percentage","person-booth","person-carry","person-dolly-empty","person-dolly","person-sign","phone-office","phone-plus","phone-slash","phone-square","phone-volume","phone","pi","pie","pig","piggy-bank","pills","place-of-worship","plane-alt","plane-arrival","plane-departure","plane","play-circle","play","plug","plus-circle","plus-hexagon","plus-octagon","plus-square","plus","podcast","podium-star","podium","poll-h","poll-people","poll","poo-storm","poo","poop","portrait","pound-sign","power-off","pray","praying-hands","prescription-bottle-alt","prescription-bottle","prescription","presentation","print-slash","print","procedures","project-diagram","pumpkin","puzzle-piece","qrcode","question-circle","question-square","question","quidditch","quote-left","quote-right","quran","rabbit-fast","rabbit","racquet","rainbow","raindrops","ram","ramp-loading","random","receipt","rectangle-landscape","rectangle-portrait","rectangle-wide","recycle","redo-alt","redo","registered","repeat-1-alt","repeat-1","repeat-alt","repeat","reply-all","reply","republican","retweet-alt","retweet","ribbon","ring","road","robot","rocket","route-highway","route-interstate","route","rss-square","rss","ruble-sign","ruler-combined","ruler-horizontal","ruler-triangle","ruler-vertical","ruler","running","rupee-sign","sad-cry","sad-tear","save","scalpel-path","scalpel","scanner-keyboard","scanner-touchscreen","scanner","scarecrow","school","screwdriver","scroll-old","scroll","scrubber","scythe","search-dollar","search-location","search-minus","search-plus","search","seedling","server","shapes","share-all","share-alt-square","share-alt","share-square","share","sheep","shekel-sign","shield-alt","shield-check","shield-cross","shield","ship","shipping-fast","shipping-timed","shoe-prints","shopping-bag","shopping-basket","shopping-cart","shovel","shower","shredder","shuttle-van","shuttlecock","sigma","sign-in-alt","sign-in","sign-language","sign-out-alt","sign-out","sign","signal-1","signal-2","signal-3","signal-4","signal-alt-1","signal-alt-2","signal-alt-3","signal-alt-slash","signal-alt","signal-slash","signal","signature","sitemap","skeleton","skull-crossbones","skull","slash","sliders-h-square","sliders-h","sliders-v-square","sliders-v","smile-beam","smile-plus","smile-wink","smile","smog","smoke","smoking-ban","smoking","snake","snow-blowing","snowflake","socks","solar-panel","sort-alpha-down","sort-alpha-up","sort-amount-down","sort-amount-up","sort-down","sort-numeric-down","sort-numeric-up","sort-up","sort","spa","space-shuttle","spade","spider-black-widow","spider-web","spider","spinner-third","spinner","splotch","spray-can","square-full","square-root-alt","square-root","square","squirrel","staff","stamp","star-and-crescent","star-exclamation","star-half-alt","star-half","star-of-david","star-of-life","star","stars","steering-wheel","step-backward","step-forward","stethoscope","sticky-note","stomach","stop-circle","stop","stopwatch","store-alt","store","stream","street-view","strikethrough","stroopwafel","subscript","subway","suitcase-rolling","suitcase","sun-cloud","sun-dust","sun-haze","sun","sunrise","sunset","superscript","surprise","swatchbook","swimmer","swimming-pool","sword","swords","synagogue","sync-alt","sync","syringe","table-tennis","table","tablet-alt","tablet-android-alt","tablet-android","tablet-rugged","tablet","tablets","tachometer-alt-average","tachometer-alt-fast","tachometer-alt-fastest","tachometer-alt-slow","tachometer-alt-slowest","tachometer-alt","tachometer-average","tachometer-fast","tachometer-fastest","tachometer-slow","tachometer-slowest","tachometer","tag","tags","tally","tape","tasks","taxi","teeth-open","teeth","temperature-frigid","temperature-high","temperature-hot","temperature-low","tennis-ball","terminal","text-height","text-width","th-large","th-list","th","theater-masks","thermometer-empty","thermometer-full","thermometer-half","thermometer-quarter","thermometer-three-quarters","thermometer","theta","thumbs-down","thumbs-up","thumbtack","thunderstorm-moon","thunderstorm-sun","thunderstorm","ticket-alt","ticket","tilde","times-circle","times-hexagon","times-octagon","times-square","times","tint-slash","tint","tire-flat","tire-pressure-warning","tire-rugged","tire","tired","toggle-off","toggle-on","toilet-paper-alt","toilet-paper","tombstone-alt","tombstone","toolbox","tooth","toothbrush","torah","torii-gate","tornado","tractor","trademark","traffic-cone","traffic-light-go","traffic-light-slow","traffic-light-stop","traffic-light","train","transgender-alt","transgender","trash-alt","trash","treasure-chest","tree-alt","tree","trees","triangle","trophy-alt","trophy","truck-container","truck-couch","truck-loading","truck-monster","truck-moving","truck-pickup","truck-ramp","truck","tshirt","tty","turkey","turtle","tv-retro","tv","umbrella-beach","umbrella","underline","undo-alt","undo","unicorn","union","universal-access","university","unlink","unlock-alt","unlock","upload","usd-circle","usd-square","user-alt-slash","user-alt","user-astronaut","user-chart","user-check","user-circle","user-clock","user-cog","user-crown","user-edit","user-friends","user-graduate","user-injured","user-lock","user-md","user-minus","user-ninja","user-plus","user-secret","user-shield","user-slash","user-tag","user-tie","user-times","user","users-class","users-cog","users-crown","users","utensil-fork","utensil-knife","utensil-spoon","utensils-alt","utensils","value-absolute","vector-square","venus-double","venus-mars","venus","vial","vials","video-plus","video-slash","video","vihara","volcano","volleyball-ball","volume-down","volume-mute","volume-off","volume-slash","volume-up","volume","vote-nay","vote-yea","vr-cardboard","walking","wallet","wand-magic","wand","warehouse-alt","warehouse","watch-fitness","watch","water-lower","water-rise","water","weight-hanging","weight","whale","wheat","wheelchair","whistle","wifi-1","wifi-2","wifi-slash","wifi","wind-warning","wind","window-alt","window-close","window-maximize","window-minimize","window-restore","window","windsock","wine-bottle","wine-glass-alt","wine-glass","won-sign","wrench","x-ray","yen-sign","yin-yang"],
a.faBrand=["500px","accessible-icon","accusoft","acquisitions-incorporated","adn","adversal","affiliatetheme","algolia","alipay","amazon-pay","amazon","amilia","android","angellist","angrycreative","angular","app-store-ios","app-store","apper","apple-pay","apple","asymmetrik","audible","autoprefixer","avianex","aviato","aws","bandcamp","behance-square","behance","bimobject","bitbucket","bitcoin","bity","black-tie","blackberry","blogger-b","blogger","bluetooth-b","bluetooth","btc","buromobelexperte","buysellads","cc-amazon-pay","cc-amex","cc-apple-pay","cc-diners-club","cc-discover","cc-jcb","cc-mastercard","cc-paypal","cc-stripe","cc-visa","centercode","chrome","cloudscale","cloudsmith","cloudversify","codepen","codiepie","connectdevelop","contao","cpanel","creative-commons-by","creative-commons-nc-eu","creative-commons-nc-jp","creative-commons-nc","creative-commons-nd","creative-commons-pd-alt","creative-commons-pd","creative-commons-remix","creative-commons-sa","creative-commons-sampling-plus","creative-commons-sampling","creative-commons-share","creative-commons-zero","creative-commons","critical-role","css3-alt","css3","cuttlefish","d-and-d-beyond","d-and-d","dashcube","delicious","deploydog","deskpro","dev","deviantart","digg","digital-ocean","discord","discourse","dochub","docker","draft2digital","dribbble-square","dribbble","dropbox","drupal","dyalog","earlybirds","ebay","edge","elementor","ello","ember","empire","envira","erlang","ethereum","etsy","expeditedssl","facebook-f","facebook-messenger","facebook-square","facebook","fantasy-flight-games","firefox","first-order-alt","first-order","firstdraft","flickr","flipboard","fly","font-awesome-alt","font-awesome-flag","font-awesome","fonticons-fi","fonticons","fort-awesome-alt","fort-awesome","forumbee","foursquare","free-code-camp","freebsd","fulcrum","galactic-republic","galactic-senate","get-pocket","gg-circle","gg","git-square","git","github-alt","github-square","github","gitkraken","gitlab","gitter","glide-g","glide","gofore","goodreads-g","goodreads","google-drive","google-play","google-plus-g","google-plus-square","google-plus","google-wallet","google","gratipay","grav","gripfire","grunt","gulp","hacker-news-square","hacker-news","hackerrank","hips","hire-a-helper","hooli","hornbill","hotjar","houzz","html5","hubspot","imdb","instagram","internet-explorer","ioxhost","itunes-note","itunes","java","jedi-order","jenkins","joget","joomla","js-square","js","jsfiddle","kaggle","keybase","keycdn","kickstarter-k","kickstarter","korvue","laravel","lastfm-square","lastfm","leanpub","less","line","linkedin-in","linkedin","linode","linux","lyft","magento","mailchimp","mandalorian","markdown","mastodon","maxcdn","medapps","medium-m","medium","medrt","meetup","megaport","microsoft","mix","mixcloud","mizuni","modx","monero","napster","neos","nimblr","nintendo-switch","node-js","node","npm","ns8","nutritionix","odnoklassniki-square","odnoklassniki","old-republic","opencart","openid","opera","optin-monster","osi","page4","pagelines","palfed","patreon","paypal","penny-arcade","periscope","phabricator","phoenix-framework","phoenix-squadron","php","pied-piper-alt","pied-piper-hat","pied-piper-pp","pied-piper","pinterest-p","pinterest-square","pinterest","playstation","product-hunt","pushed","python","qq","quinscape","quora","r-project","ravelry","react","reacteurope","readme","rebel","red-river","reddit-alien","reddit-square","reddit","renren","replyd","researchgate","resolving","rev","rocketchat","rockrms","safari","sass","schlix","scribd","searchengin","sellcast","sellsy","servicestack","shirtsinbulk","shopware","simplybuilt","sistrix","sith","skyatlas","skype","slack-hash","slack","slideshare","snapchat-ghost","snapchat-square","snapchat","soundcloud","speakap","spotify","squarespace","stack-exchange","stack-overflow","staylinked","steam-square","steam-symbol","steam","sticker-mule","strava","stripe-s","stripe","studiovinari","stumbleupon-circle","stumbleupon","superpowers","supple","teamspeak","telegram-plane","telegram","tencent-weibo","the-red-yeti","themeco","themeisle","think-peaks","trade-federation","trello","tripadvisor","tumblr-square","tumblr","twitch","twitter-square","twitter","typo3","uber","uikit","uniregistry","untappd","usb","ussunnah","vaadin","viacoin","viadeo-square","viadeo","viber","vimeo-square","vimeo-v","vimeo","vine","vk","vnv","vuejs","weebly","weibo","weixin","whatsapp-square","whatsapp","whmcs","wikipedia-w","windows","wix","wizards-of-the-coast","wolf-pack-battalion","wordpress-simple","wordpress","wpbeginner","wpexplorer","wpforms","wpressr","xbox","xing-square","xing","y-combinator","yahoo","yandex-international","yandex","yelp","yoast","youtube-square","youtube","zhihu"];var h=_.map(a.icons,function(a){return{text:a,mark:'<i data-name="'+a+'" class="pointer icons-menu '+a+'"></i>'}}),i=_.map(a.faIcons,function(a){return{text:a,mark:'<i data-name="fal fa-'+a+'" class="pointer icons-menu fal fa-'+a+'"></i>'}}),j=_.map(a.faIcons,function(a){return{text:a,mark:'<i data-name="far fa-'+a+'" class="pointer icons-menu far fa-'+a+'"></i>'}}),k=_.map(a.faIcons,function(a){return{text:a,mark:'<i data-name="fas fa-'+a+'" class="pointer icons-menu fas fa-'+a+'"></i>'}}),l=_.map(a.faBrand,function(a){return{text:a,mark:'<i data-name="fab fa-'+a+'" class="pointer icons-menu fab fa-'+a+'"></i>'}}),m=h.concat(i,j,k,l);m=_.map(m,function(a,b){return{index:Math.floor(b/9),text:a.text,mark:a.mark}}),m=_.groupBy(m,"index"),m=_.map(m,function(a,b){return{text:_.map(a,"text").join(""),mark:"<tr><td>"+a.map(function(a){return a.mark}).join("</td><td>")+"</td></tr>"}}),data=m;var n,o="contentArea"+a.id;e(function(){n=new Clusterize({rows:_.map(data,"mark"),scrollId:"scrollArea"+a.id,contentId:o,callbacks:{mapFunction:function(a){return{markup:a}},clusterChanged:function(){$("#"+o).find("tr:not(.clusterize-extra-row) td i").on("click",function(){var b=$(this).data("name");e(function(){a.model=a.model||{},a.model.name=b,a.model.type="icon",g.hide(),a.change&&a.change()},0)})}}})},0),a.filter=function(a){n.update(_.map(data.filter(function(b){return b.text.indexOf(a)!=-1}),"mark"))},a.picModel={select:function(b){a.model=a.model||{},a.model.name=b,a.model.type="image",a.change&&a.change(),a.$apply()}},a.type=a.type||"image, icon",console.log("#### $scope.type",a.type),a.hasImage=a.type.indexOf("image")!=-1,a.hasIcon=a.type.indexOf("icon")!=-1}],templateUrl:app.urlPrefix+"dist/partial/management/directives/icons.html?v="+app.version}}).service("intervalFetchService",["$http",function(a){var b=function(b,c,d){return c||(c=0),d||(d=20),a.get(app.urlPrefix+"api/intervalfetchs/get/"+b,{params:{offset:c,count:d}}).then(function(a){return a.data})},c=function(b){return a.get(app.urlPrefix+"api/intervalfetchs/refresh/"+b).then(function(a){return a.data})},d=function(b,c,d){return a.post(app.urlPrefix+"api/intervalfetchs/add/",{id:b,from:c,to:d}).then(function(a){return a.data})},e=function(b){return a.post(app.urlPrefix+"api/intervalfetchs/deleteAll/"+b)},f=function(b){return a.post(app.urlPrefix+"api/intervalfetchs/delete/"+b)};return{get:b,refresh:c,deleteAll:e,add:d,remove:f}}]).directive("matrixSelect",function(){return{restrict:"E",transclude:!0,scope:{model:"=ngModel",dimColor:"=",ngChange:"&?"},controller:["$scope","$http","$translate","roles","$mdToast","utils","$timeout",function(a,b,c,d,e,f,g){a.app=app,a.$watch("dimColor",function(b){if(a.model=a.model||{enable:!1},a.model.data=a.model.data||{},b){var c=!1;for(var d in b)!a.model.data[d]&&b[d]&&(a.model.data[d]={check:!0},c=!0);c&&g(function(){a.ngChange()},1)}},!0),a.clear=function(){a.model.data={},a.dimColor={},a.ngChange()}}],template:'            <div class="form-row" layout="row" layout-align="start center">                                                 <div class="col-sm-offset-4 col-sm-8">                                                                          <div class="checkbox">                                                                                          <label class="">                                                                                                <input type="checkbox" ng-change="ngChange()" ng-model="model.enable" />                                    انتخاب برچسب‌های نمایش                                                                  </label>                                                                                                </div>                                                                                                  </div>                                                                                                  </div>                                                                                                      <div class= "ui mini segment" ng-show="model.enable" >                                                                                                             <div class="ui mini compact button" ng-click="clear()">پاک کردن</div>                                                                                       <div ng-repeat="(key, value) in model.data">                                                                                                                     <div class="form-row" layout="row" layout-align="start center">                                                                                                              <div class= "col-sm-offset-4 col-sm-8">                                                                                                                                        <div class="checkbox">                                                                                                                                                           <label class="">                                                                                                                                                                 <input type="checkbox" ng-model="model.data[key].check" ng-change="ngChange()" />   {{key}}                                 </label>                                                                                                                                                                 </div>                                                                                                                                                                   </div>                                                                                                                                                               </div >                                                                                                                                                              </div>            </div>'}});var ngApp=angular.module("management");ngApp.controller("menusCtrl",["$scope","$http","$sce","$routeParams","$location","$mdSidenav","toolbar","$timeout","$translate","$mdMedia","iframeService",function(a,b,c,d,e,f,g,h,i,j,k){var l={"Moderation/DataSource/index/":"/datasources","Account/UsersList":"/users","Account/RolesList":"/roles","Moderation/Charts/index/":"/charts","Moderation/GlobalVariable/index/":"/variables","Moderation/DatasourceInterRelation/index/":"/datasourceJoin","Moderation/AutoUpdate/index/":"/settings/update","Moderation/Settings/Mail/":"/settings/mail","Moderation/Settings/GeneralSettings/":"/settings",onlineUsers:"/onlineUsers",licence:"/licence"},m={"Account/UsersList":"person","Account/RolesList":"group","Moderation/DataSource/index/":"storage","Moderation/Charts/index/":"timeline","Moderation/GlobalVariable/index/":"space_bar","Moderation/DatasourceInterRelation/index/":"linear_scale","Moderation/AutoUpdate/index/":"update","Moderation/Settings/Mail/":"mail","Moderation/Settings/GeneralSettings/":"settings",onlineUsers:"rowing",licence:"card_membership",dashboards:"dashboard",syncUserVariablesList:"sync",eventNotifications:"notifications_none","forms/list":"assignment"};a.iframeService=k,a.lock=j("gt-md"),a.toolbar=g,a.app=app,a.persian=persian,a.mainMenuType=1,a.toggle=function(){console.log("### locl",a.lock,j("gt-md")),j("gt-md")?a.lock=!a.lock:(f("r").toggle(),console.log("### call toggle"))},b.get(app.urlPrefix+"api/menus/MenuCategories/3").then(function(b){function c(){a.closeAll();var b=e.path();_.each(a.menuCategories.data,function(a){_.each(a.menus,function(c){c.active=!1,b.replace(/^\/(.*)/i,"$1")==c.menu.Link.replace(/^\/(.*)/i,"$1")&&(c.active=!0,a.isOpen=!0)})})}a.menuCategories=b.data;try{a.menuCategories.data[4].menus.splice(0,1)}catch(d){}var f=e.path();_.each(a.menuCategories.data,function(a){_.each(a.menus,function(a){a.menu.icon=m[a.menu.Link]||"code",a.menu.Link=l[a.menu.Link]||a.menu.Link})}),f&&"/"!=f&&"/nothings"!=f||e.path(a.menuCategories.isRoleAdmin?"/roles":a.menuCategories.data[0].menus[0].menu.Link),c(),a.$on("$locationChangeStart",function(a,b,d){c()})}),a.setLink=function(a){f("r").toggle(),h(function(){e.path(a.menu.Link)},400)},a.closeNav=function(){f("r").toggle()},a.closeAll=function(b){_.each(a.menuCategories.data,function(a){b?a.category.Id!==b.category.Id&&(a.isOpen=!1):a.isOpen=!1})},a.gotoDashboard=function(){e.path()},0==+$("#lang").val()?i.use("fa"):i.use("en")}]),ngApp.service("toolbar",[function(){function a(a){f=a}function b(){return f}function c(a){e=a}function d(){e&&e.toggle()}var e,f=[{name:"",click:function(){}}];return{setTitles:a,getTitles:b,setSideNave:c,toggleSideNave:d}}]);var ngApp=angular.module("management");ngApp.config(["$routeProvider","$locationProvider",function(a,b){a.when("/datasources/add/mssql/:type/:packageId?/:id?",{templateUrl:app.urlPrefix+"dist/partial/management/datasource/mssql.html?v="+app.version,controller:"datasourceMssqlCtrl"}).when("/datasources/add/file/:packageId?/:id?",{templateUrl:app.urlPrefix+"dist/partial/management/datasource/file.html?v="+app.version,controller:"datasourcefileCtrl"}).when("/datasources/add/web/:packageId?/:id?",{templateUrl:app.urlPrefix+"dist/partial/management/datasource/web.html?v="+app.version,controller:"datasourceWebCtrl"}).when("/datasources/add/join/:packageId?/:id?",{templateUrl:app.urlPrefix+"dist/partial/management/datasource/join.html?v="+app.version,controller:"datasourceJoinCtrl"}).when("/datasources/new/:id?",{templateUrl:app.urlPrefix+"dist/partial/management/datasource/new.html?v="+app.version,controller:"datasourceNewCtrl"}).when("/datasources/:id?",{templateUrl:app.urlPrefix+"dist/partial/management/datasource/list.html?v="+app.version,controller:"datasourceListCtrl"}).when("/datasourceJoin",{templateUrl:app.urlPrefix+"dist/partial/management/datasource/interRelation.html?v="+app.version,controller:"interRelationCtrl"}).when("/charts/:id?",{templateUrl:app.urlPrefix+"dist/partial/management/charts/list.html?v="+app.version,controller:"chartsListCtrl"}).when("/charts/edit/:packageId?/:id?",{templateUrl:app.urlPrefix+"dist/partial/management/charts/editor.html?v="+app.version,controller:"chartsEditorCtrl"}).when("/charts/new/:type/:packageId/:datasourceId?/:charttype?",{templateUrl:app.urlPrefix+"dist/partial/management/charts/editor.html?v="+app.version,controller:"chartsEditorCtrl"}).when("/variables",{templateUrl:app.urlPrefix+"dist/partial/management/datasource/list.html?v="+app.version,controller:"datasourceCtrl"}).when("/users",{templateUrl:app.urlPrefix+"dist/partial/management/account/userList.html?v="+app.version,controller:"usersListCtrl"}).when("/users/edit/:id?",{templateUrl:app.urlPrefix+"dist/partial/management/account/userEdit.html?v="+app.version,controller:"userEditCtrl"}).when("/roles",{templateUrl:app.urlPrefix+"dist/partial/management/account/roleList.html?v="+app.version,controller:"rolesListCtrl"}).when("/roles/edit/:id?/:parent?",{templateUrl:app.urlPrefix+"dist/partial/management/account/roleEdit.html?v="+app.version,controller:"roleEditCtrl"}).when("/variables",{templateUrl:app.urlPrefix+"dist/partial/management/account/variables.html?v="+app.version,controller:"variablesCtrl"}).when("/settings/update",{templateUrl:app.urlPrefix+"dist/partial/management/account/update.html?v="+app.version,controller:"updateCtrl"}).when("/settings/mail",{templateUrl:app.urlPrefix+"dist/partial/management/account/mail.html?v="+app.version,controller:"mailCtrl"}).when("/settings",{templateUrl:app.urlPrefix+"dist/partial/management/account/settings.html?v="+app.version,controller:"settingsCtrl"}).when("/onlineUsers",{templateUrl:app.urlPrefix+"dist/partial/management/account/onlineUsers.html?v="+app.version,controller:"onlineUsersCtrl"}).when("/licence",{templateUrl:app.urlPrefix+"dist/partial/management/account/licence.html?v="+app.version,controller:"licenceCtrl"}).when("/activeDirectory",{templateUrl:app.urlPrefix+"dist/partial/management/account/activeDirectory.html?v="+app.version,controller:"activeDirectoryCtrl",controllerAs:"ad"}).when("/userBulkInsert",{templateUrl:app.urlPrefix+"dist/partial/management/account/userBulkInsert.html?v="+app.version,controller:"userBulkInsertCtrl",controllerAs:"ubi"}).when("/syncUserVariablesList",{templateUrl:app.urlPrefix+"dist/partial/management/account/syncUserVariablesList.html?v="+app.version,controller:"syncUserVariablesListCtrl",controllerAs:"cnl"}).when("/syncUserVariablesDetail/:id?",{templateUrl:app.urlPrefix+"dist/partial/management/account/syncUserVariablesDetail.html?v="+app.version,controller:"syncUserVariablesDetailCtrl",controllerAs:"cnl"}).when("/logs",{templateUrl:app.urlPrefix+"dist/partial/management/account/log.html?v="+app.version,controller:"logCtrl"}).when("/upload_chart",{templateUrl:app.urlPrefix+"dist/partial/management/account/uploadChart.html?v="+app.version,controller:"uploadChart"}).when("/upload_chart/:id",{templateUrl:app.urlPrefix+"dist/partial/management/account/uploadChartDetail.html?v="+app.version,controller:"uploadChartDetail"}).when("/dashboards/:id",{templateUrl:app.urlPrefix+"dist/partial/management/dashboard/detail.html?v="+app.version,controller:"dashboardDetailCtrl"}).when("/dashboards",{templateUrl:app.urlPrefix+"dist/partial/management/dashboard/dashboards.html?v="+app.version,controller:"dashboardsCtrl"}).when("/themes",{templateUrl:app.urlPrefix+"dist/partial/management/account/themes.html?v="+app.version,controller:"themesCtrl"}).when("/compare-data",{templateUrl:app.urlPrefix+"dist/partial/management/account/themes.html?v="+app.version,controller:"themesCtrl"}).when("/eventNotifications",{templateUrl:app.urlPrefix+"dist/partial/management/account/themes.html?v="+app.version,controller:"themesCtrl"}).when("/telegram-config",{templateUrl:app.urlPrefix+"dist/partial/management/account/themes.html?v="+app.version,controller:"themesCtrl"}).when("/process-all-tables",{templateUrl:app.urlPrefix+"dist/partial/management/account/themes.html?v="+app.version,controller:"themesCtrl"}).when("/login-page-logo",{templateUrl:app.urlPrefix+"dist/partial/management/account/themes.html?v="+app.version,controller:"themesCtrl"}).when("/olap-tables/:id?",{templateUrl:app.urlPrefix+"dist/partial/management/account/themes.html?v="+app.version,controller:"themesCtrl"}).when("/menu-category",{templateUrl:app.urlPrefix+"dist/partial/management/account/themes.html?v="+app.version,controller:"themesCtrl"}).when("/userVariables",{templateUrl:app.urlPrefix+"dist/partial/management/account/themes.html?v="+app.version,controller:"themesCtrl"}).when("/userVariables/:name",{templateUrl:app.urlPrefix+"dist/partial/management/account/themes.html?v="+app.version,controller:"themesCtrl"}).when("/chart-import",{templateUrl:app.urlPrefix+"dist/partial/management/account/themes.html?v="+app.version,controller:"themesCtrl"})}]);var ngApp=angular.module("management");ngApp.service("templates",[function(){var a={package_dialog:app.urlPrefix+"dist/partial/management/packages/select-package.html"};return{tmpl:a}}]);var ngApp=angular.module("management");ngApp.controller("activeDirectoryCtrl",["$scope","$http","$sce","$timeout","$mdToast","toolbar","$translate","utils","roles",function(a,b,c,d,e,f,g,h,i){var j=this;a.utils=h,a.app=app,g("Active Directory Integration").then(function(b){a.listTranslate=b,f.setTitles([{name:b,onclick:function(){}}])}),j.moment=moment,j.bindOption=2,i.get().then(function(a){j.roles=a.data.list}),$(".ui.dimmer.modals .cert-modal").remove(),this.getList=function(){j.progress=!0,b.post(app.urlPrefix+"api/activedirectory/GetUserList",JSON.stringify({server:j.server,user:j.user,pass:j.pass,container:j.container,bindOption:j.bindOption,ssl:j.ssl,approveHash:j.approveHash})).then(function(a){j.progress=!1,j.approveHash=null,a.data.result&&(j.data=a.data.list,$(".cert-modal").modal("hide")),a.data.result||(j.cert=a.data.cert,j.certHash=a.data.hash,$(".cert-modal").modal("show"))})["catch"](function(a){j.approveHash=null,h.showErrorToast(a.data.desc),j.progress=!1,$(".cert-modal").modal("hide")})},j.approveCert=function(){j.approveHash=j.certHash,j.getList()},this.selectAll=function(a){_.forEach(j.data,function(b){b.select=a})},this.saveSelectedUsers=function(){j.saveProgress=!0,j.moment=moment;var a=_.filter(j.data,{select:!0}).map(function(a){return{server:a.server,user:a.SamAccountName,pass:a.DisplayName,container:j.container,bindOption:j.bindOption,approveHash:a.approveHash,ssl:a.ssl}}),d=_.filter(j.roles,{check:!0});b.post(app.urlPrefix+"api/activedirectory/SaveUsers",JSON.stringify({users:a,roles:d})).then(function(a){if(j.saveProgress=!1,a.data&&a.data.length)j.error=c.trustAsHtml("<ul><li>"+a.data.map(function(a){return filterXSS(a.user)+", "}).join("</li><li>")+"</li></ul>");else{var b=e.simple().textContent("کاربرهای انتخاب شده با موفقیت به سیستم اضافه شدند");e.show(b)}j.data=null},function(a){h.showErrorToast(a.data.desc),j.saveProgress=!1})}}]);var ngApp=angular.module("management");ngApp.controller("userBulkInsertCtrl",["$scope","$http","$sce","$timeout","$mdToast","toolbar","$translate","utils","roles",function(a,b,c,d,e,f,g,h,i){var j=this;a.utils=h,a.app=app,g("اضافه کردن گروهی کاربرها").then(function(b){a.listTranslate=b,f.setTitles([{name:b,onclick:function(){}}])}),j.bindOption=2,i.get().then(function(a){j.roles=a.data.list}),j.process=function(){if(!j.rawData||!j.rawData.length)return void alert("داده‌ی درستی وارد نشده است");var a=_.split(j.rawData,/[\r\n]/);j.data=_.map(a,function(a){var b=_.split(a,/[;\t]/),c={name:"",family:"",username:"",password:"",complex:!1,needChange:!1};return b.length>=1&&(c.name=b[0]),b.length>=2&&(c.family=b[1]),b.length>=3&&(c.username=b[2]),b.length>=4&&(c.password=b[3]),b.length>=5&&+b[4]&&(c.complex=!0),b.length>=6&&+b[5]&&(c.needChange=!0),c})},this.selectAll=function(a){_.forEach(j.data,function(b){b.select=a})},this.saveSelectedUsers=function(){j.saveProgress=!0;var a=_.filter(j.data,{select:!0}),c=_.filter(j.roles,{check:!0});b.post(app.urlPrefix+"api/users/bulkinsert",JSON.stringify({users:a,roles:c})).then(function(a){j.saveProgress=!1;var b=e.simple().textContent("کاربرهای انتخاب شده با موفقیت به سیستم اضافه شدند");e.show(b),_.each(a.data.existed,function(a){_.find(j.data,{username:a.username}).status=1}),_.each(a.data.inserted,function(a){_.find(j.data,{username:a.username}).status=2})},function(a){h.showErrorToast(a.data.desc),j.saveProgress=!1})}}]);var ngApp=angular.module("management");ngApp.controller("syncUserVariablesListCtrl",["$scope","$http","$sce","$timeout","$mdToast","toolbar","$translate","utils","roles","$mdDialog",function(a,b,c,d,e,f,g,h,i,j){function k(a){e.show({template:'<md-toast class="md-toast error"> <span class="md-toast-text" flex>'+a+"</span></md-toast>",hideDelay:3e3,position:"bottom left"})}var l=this;l.utils=h,l.app=app;g("User Variable Sync").then(function(b){a.listTranslate=b,f.setTitles([{name:b,onclick:function(){}}])}),l.progress=!0,b.get(app.urlPrefix+"api/syncUserVariables/get").then(function(a){l.progress=!1,l.data=a.data},function(){l.progress=!1,k("خطایی در دریافت اطلاعات رخ داده است")}),l.sync=function(a,c){c.progress=!0,b.post(app.urlPrefix+"api/syncUserVariables/sync?id="+c.Id).then(function(a){c.progress=!1,c.LastRefresh=a.data.LastRefresh,e.show(e.simple().textContent(" منبع داده "+c.DatasourceName+"  و متغیر "+c.VariableName+" با موفقیت همگام شدند"))},function(){c.progress=!1,k("خطایی در همگام‌سازی رخ داده است")})},l["delete"]=function(a,c){var d=j.confirm().title("حذف برای همیشه؟").textContent("آیا ارتباط بین منبع داده "+c.DatasourceName+"  و متغیر "+c.VariableName+" حذف شود؟").ariaLabel("حذف").targetEvent(a).ok("حذف!").cancel("لغو");j.show(d).then(function(){b.post(app.urlPrefix+"api/syncUserVariables/delete?id="+c.Id).then(function(a){e.show(e.simple().textContent("عملیات با موفقیت به اتمام رسید")),_.remove(l.data,{Id:c.Id})},function(){k("خطایی در حذف رخ داده است")})})}}]),ngApp.controller("syncUserVariablesDetailCtrl",["$scope","$http","$sce","$timeout","$mdToast","toolbar","$translate","utils","datasources","$routeParams",function(a,b,c,d,e,f,g,h,i,j){function k(a){n.getInfoProgress=!1,n.error=a.data.desc}function l(){n.error=null}function m(a){e.show({template:'<md-toast class="md-toast error"> <span class="md-toast-text" flex>'+a+"</span></md-toast>",hideDelay:3e3,position:"bottom left"})}var n=this;a.utils=h,a.app=app;var o="undefined"!=typeof j.id?j.id:0;if(g("User Variable Sync").then(function(b){a.listTranslate=b,f.setTitles([{name:b,onclick:function(){}}])}),o>0){n.getInfoProgress=!0;var p=app.urlPrefix+"api/syncUserVariables/get/"+o;b.get(p).then(function(a){n.userProperties=[],n.selectedDatasource={id:a.data.DatasourceId,name:a.data.DatasourceName},n.usernameColumn=a.data.UsernameColumn,n.variableValueColumn=a.data.VariableValueColumn,n.variableName=a.data.VariableName,n.getColumns()},function(a){k(a)})}n.selectDatasource=function(a){i.select(a,{type:["datasources"]}).then(function(a){l(),n.selectedDatasource=a.selected[0],n.getColumns()})},n.getColumns=function(){i.getColumns(n.selectedDatasource.id).then(function(a){n.getInfoProgress=!1,n.datasourceColumns=a.CubeInfo.Dimensions[0].Hierarchies,n.userProperties=a.UsersProperty},function a(b){a(b)})},n.saveAndSync=function(c){return a.syncForm.$valid?(n.syncProgress=!0,n.syncError=null,n.effectedUsers=null,void b.post(app.urlPrefix+"api/syncUserVariables/saveAndSync",{id:o,datasourceId:n.selectedDatasource.id,usernameColumn:n.usernameColumn,variableValueColumn:n.variableValueColumn,variableName:n.variableName}).then(function(a){n.syncProgress=!1,n.effectedUsers=a.data.effected,o=a.data.id,e.show(e.simple().textContent("عملیات با موفقیت به اتمام رسید"))},function(a){n.syncProgress=!1,n.syncError=a.data.desc,m("خطایی در روند همگام سازی به وجود آمده است")})):void m("فیلدهای ضروری باید پر شوند")}}]);var ngApp=angular.module("management");ngApp.controller("licenceCtrl",["$scope","$http","$sce","$timeout","$mdToast","toolbar","$translate","utils",function(a,b,c,d,e,f,g,h){a.utils=h,g("licence_manager").then(function(b){a.listTranslate=b,f.setTitles([{name:b,onclick:function(){}}])}),a.progress=!0,b.get(app.urlPrefix+"api/licence/get").then(function(b){a.progress=!1,a.data=b.data}),a.clear=function(){b.post(app.urlPrefix+"api/licence/clear").then(function(a){window.location=app.urlPrefix+"Account/LogOff"})}}]);var ngApp=angular.module("management");ngApp.filter("htmlSafe",["$sce",function(a){return function(b){return a.trustAsHtml(filterXSS(b))}}]),ngApp.controller("mailCtrl",["$scope","$http","$sce","$timeout","$mdToast",function(a,b,c,d,e){function f(a){return a&&(a=a.trim()),_.isEmpty(a)}function g(){return!(f((a.port||"")+"")||f(a.host)||f((a.timeout||"")+"")||f(a.username)||f(a.password))||(a.message=null,a.error=c.trustAsHtml("فیلدهای ضروری باید پر شوند"),!1)}function h(b,c){return!(b.result||!b.cert)&&($(".mail-cert-modal").modal("show"),a.certMode=c,a.cert=b.cert,a.certHash=b.hash,!0)}$(".ui.dimmer.modals .mail-cert-modal").remove(),a.moment=moment,a.save=function(d){a.message=null,a.error=null,g()&&(a.progress=!0,b.post(app.urlPrefix+"api/Settings/Mail",JSON.stringify({port:a.port,host:a.host,ssl:a.ssl,timeout:a.timeout,username:a.username,password:a.password,approveHash:a.approveHash}),{headers:{"Content-Type":"application/json; charset=utf-8"}}).then(function(b){if(a.progress=!1,a.approveHash=null,$(".mail-cert-modal").modal("hide"),!h(b.data,"save"))if(b.data.result){window.history.back();var d=e.simple().textContent("تغییرات ثبت شد");e.show(d)}else a.message=null,a.error=c.trustAsHtml(filterXSS(b.data.error))},function(b){$(".mail-cert-modal").modal("hide"),a.approveHash=null,a.progress=!1,a.message=null,a.error=c.trustAsHtml(filterXSS(b.data.desc))}))},a.approveCert=function(){a.approveHash=a.certHash,"test"===a.certMode&&a.test(),"save"===a.certMode&&a.save()},a.test=function(d){a.error=null,a.message=null,g()&&(a.progress=!0,b.post(app.urlPrefix+"api/Settings/Test",JSON.stringify({port:a.port,host:a.host,ssl:a.ssl,timeout:a.timeout,username:a.username,password:a.password,approveHash:a.approveHash}),{headers:{"Content-Type":"application/json; charset=utf-8"}}).then(function(b){if(a.progress=!1,$(".mail-cert-modal").modal("hide"),a.approveHash=null,!h(b.data,"test"))if(b.data.result){a.message=c.trustAsHtml("ارسال پست الکترونیک با اطلاعات وارد درست است");var d=e.simple().textContent("ارسال پست الکترونیک با اطلاعات وارد درست است");e.show(d)}else a.message=null,a.error=c.trustAsHtml(filterXSS(b.data.error))},function(b){$(".mail-cert-modal").modal("hide"),a.approveHash=null,a.progress=!1,a.message=null,a.error=c.trustAsHtml(filterXSS(b.data.desc))}))},a.infoProgress=!0,b.get(app.urlPrefix+"api/settings/getMailInfo").then(function(b){a.infoProgress=!1;var c=b.data;a.port=c.port,a.host=c.host,a.ssl=c.ssl,a.timeout=c.timeout,a.username=c.username,a.password=c.password},function(b){a.infoProgress=!1,a.error=c.trustAsHtml(filterXSS(b.data.desc))})}]);var ngApp=angular.module("management");ngApp.controller("onlineUsersCtrl",["$scope","$http","$sce","$timeout","$mdToast","toolbar","$translate","utils",function(a,b,c,d,e,f,g,h){a.utils=h,g("online_users").then(function(b){a.listTranslate=b,f.setTitles([{name:b,onclick:function(){}}])}),a.kick=function(a){b.post(app.urlPrefix+"api/onlineusers/kick/"+a.id).then(function(a){})},a.progress=!0,b.get(app.urlPrefix+"api/onlineusers/get").then(function(b){a.progress=!1,a.data=b.data.list,a.SecurityCertPatch=b.data.SecurityCertPatch})}]);var ngApp=angular.module("management");ngApp.controller("roleEditCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$translate","$sce","roles","menus","utils","datasources",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){function o(b){a.error=j.trustAsHtml(filterXSS("<b>"+b.data.title+"</b> <br/>"+b.data.desc)),t(b.data.desc)}function p(){l.getParentMenu(a.parent).then(function(b){_.forEach(b.data,function(a){a.check=!1}),a.menus=_.groupBy(b.data,function(a){return JSON.stringify({name:a.parent,id:a.parentId})}),a.menusFlat=b.data,_.forEach(a.menus,function(a){_.forEach(a,function(a){a.action=1})}),a.menuCategoriesAction={},s()}),r()}function q(){b.get(app.urlPrefix+"api/users/get?parentRole="+a.parent+"&role="+a.id).then(function(b){a.progress=!1,a.users=b.data.list,a.manageableUsers=_.map(b.data.list,_.clone),s()},m.error)}function r(){b.get(app.urlPrefix+"api/roles/GetRoleFunctional?id="+a.parent).then(function(b){_.each(a.actions,function(a){_.each(a.childes,function(a){a.disable=!0,_.isArray(b.data)&&(a.disable=b.data.indexOf(a.id)===-1)})}),console.log(a.actions)})}function s(){a.model&&a.users&&a.menus&&a.themes&&a.mainmenus&&(console.log("#### call restore"),a.model.FirstMenuId=a.model.FirstMenuId+"",a.model.dashboardVariables=a.model.dashboardVariables||[],a.model.FunctionalActions&&_.forEach(a.actions,function(b){_.forEach(b.childes,function(b){b.check=a.model.FunctionalActions.indexOf(b.id)!==-1})}),_.forEach(a.users,function(b){b.check=a.model.Users.indexOf(b.id)!==-1}),_.forEach(a.manageableUsers,function(b){b.check=a.model.ManageableUsers.indexOf(b.id)!==-1}),_.forEach(a.model.MenuActions,function(b){var c=b.split("-").map(function(a){
return+a}),d=c[0],e=c[1];_.forEach(a.menus,function(a,b){var c=_.find(a,{id:e});if(c)return c.action=d,c.check=!0,!1})}),a.datasources=a.model.DatasourceActions.map(function(a){return JSON.parse(a)}),a.charts=a.model.ChartActions.map(function(a){return JSON.parse(a)}),_.each(a.charts,function(b){var c=_.find(a.model.ChartExtraPermissions,{id:b.id});c&&(b.chartExtraPermissions=c.permissions)}),_.forEach(a.model.MenuCategoryActions,function(b){var c=b.split("-").map(function(a){return+a}),d=c[0],e=c[1],f=!1;_.forEach(a.menus,function(b,c){var g=JSON.parse(c);if(g.id===e)return a.menuCategoriesAction[g.id]=d,f=!0,!1}),f||delete a.menuCategoriesAction[e]}),a.forms=a.model.forms,_.each(a.themes,function(b){var c=_.find(a.model.themes,{id:b.id});c&&(b.action=c.action,b.check=!0)}),_.each(a.mainmenus,function(b){var c=_.find(a.model.mainmenus,{id:b.id});c&&(b.action=c.action,b.check=!0)}),a.model.activeTheme=a.model.activeTheme||-1,console.log("#### end restore"),a.restoreFinish=!0)}function t(a){c.show({template:'<md-toast class="md-toast error"> <span class="md-toast-text" flex>'+a+"</span></md-toast>",hideDelay:3e3,position:"bottom left"})}function u(b){b?(a.model.DatasourceActions=a.datasources.map(function(a){return a.action+"-"+a.id}),a.model.ChartActions=a.charts.map(function(a){return a.action+"-"+a.id}),a.model.ChartExtraPermissions=a.charts.map(function(a){return{id:a.id,permissions:a.chartExtraPermissions}}),a.model.forms=a.forms?a.forms.map(function(a){return{id:a.id,action:a.action,recordPermission:a.recordPermission}}):[],a.model.themes=a.themes?_.filter(a.themes,{check:!0}).map(function(a){return{id:a.id,action:a.action}}):[],a.model.mainmenus=a.mainmenus?_.filter(a.mainmenus,{check:!0}).map(function(a){return{id:a.id,action:a.action}}):[]):(a.model.DatasourceActions=a.datasources.map(function(a){return JSON.stringify(a)}),a.model.ChartActions=a.charts.map(function(a){JSON.stringify(a)}),a.model.forms=a.forms?a.forms.map(function(a){return{id:a.id,action:a.action,recordPermission:a.recordPermission}}):[]),a.model.Users=_.filter(a.users,{check:!0}).map(function(a){return a.id}),a.model.ManageableUsers=_.filter(a.manageableUsers,{check:!0}).map(function(a){return a.id}),a.model.MenuActions=[],_.forEach(a.menus,function(b){var c=_.filter(b,{check:!0});_.forEach(c,function(b){a.model.MenuActions.push(b.action+"-"+b.id)})}),a.model.MenuCategoryActions=[],_.forEach(a.menuCategoriesAction,function(b,c){+b&&a.model.MenuCategoryActions.push(b+"-"+c)}),a.model.FunctionalActions=[],a.model.ParentRole=a.parent,_.forEach(a.actions,function(b){var c=_.filter(b.childes,{check:!0});_.forEach(c,function(b){a.model.FunctionalActions.push(b.id)})})}a.app=app;var v={ChartAdd:1,ChartView:2,ChartEdit:3,ChartDelete:4,MenuAdd:5,MenuView:6,MenuEdit:7,MenuDelete:8,DataSourceAdd:9,DataSourceView:10,DataSourceEdit:11,DataSourceDelete:12,FormAdd:22,FormView:23,FormEdit:24,FormDelete:25,AdminAccessOnCharts:13,AdminAccessOnMenus:14,AdminAccessOnDataSources:15,AdminAccessOnForms:21,DashboardAddDeleteArragneCharts:16,ManageAllUsersAndRoles:17,ViewManageMainMenu:18,ArrangeMenus:19,UploadChart:26,UserChangeInfo:27,UserChangePassword:28,ViewLogs:29,Chart_Extra_comment:30,Chart_Extra_excel:31,Chart_Extra_desc:32,Chart_Extra_filter:33,ThemeAdd:34,ThemeView:35,ThemeEdit:36,ThemeDelete:37};a.actions=[{title:"مدیریت نمودارها",childes:[{id:v.ChartAdd,name:"ساخت نمودار جدید"},{id:v.ChartView,name:"مشاهده نمودار"},{id:v.ChartEdit,name:"ویرایش نمودار"},{id:v.ChartDelete,name:"حذف نمودار"},{id:v.Chart_Extra_comment,name:"مجوز کامنت روی تمام نمودارها"},{id:v.Chart_Extra_excel,name:"مجوز خروجی اکسل روی تمام نمودارها"},{id:v.Chart_Extra_filter,name:"مجوز فیلتر روی تمام نمودارها"},{id:v.Chart_Extra_desc,name:"مجوز توضیحات روی تمام نمودارها"}]},{title:"مدیریت منوها",childes:[{id:v.MenuAdd,name:"ساخت منوی جدید"},{id:v.MenuView,name:"مشاهده منو"},{id:v.MenuEdit,name:"ویرایش منو"},{id:v.MenuDelete,name:"حذف منو"}]},{title:"مدیریت فرم‌ها",childes:[{id:v.FormAdd,name:"ساخت فرم جدید"},{id:v.FormView,name:"مشاهده فرم"},{id:v.FormEdit,name:"ویرایش فرم"},{id:v.FormDelete,name:"حذف فرم"}]},{title:"مدیریت منابع داده",childes:[{id:v.DataSourceAdd,name:"ساخت منبع داده‌ی جدید"},{id:v.DataSourceView,name:"مشاهده منبع داده"},{id:v.DataSourceEdit,name:"ویرایش منبع داده"},{id:v.DataSourceDelete,name:"حذف منبع داده"}]},{title:"مدیریت پوسته‌ها",childes:[{id:v.ThemeAdd,name:"ساخت پوسته جدید"},{id:v.ThemeView,name:"مشاهده پوسته"},{id:v.ThemeEdit,name:"ویرایش پوسته"},{id:v.ThemeDelete,name:"حذف پوسته"}]},{title:"مدیریت صفحات داشبوردی و کاربران و نقش‌ها",childes:[{type:"input",id:v.ArrangeMenus,name:"تغییر ترتیب منوها"}]},{title:"دسترسی کامل",childes:[{type:"input",id:v.AdminAccessOnCharts,name:"دسترسی کامل به تمام نمودارها"},{type:"input",id:v.AdminAccessOnMenus,name:"دسترسی کامل به تمام منوها"},{type:"input",id:v.AdminAccessOnDataSources,name:"دسترسی کامل به تمام منابع داده"},{type:"input",id:v.AdminAccessOnForms,name:"دسترسی کامل به تمام فرم‌ها"}]},{title:"سایر مجوز‌ها",childes:[{id:v.UploadChart,name:"آپلود کردن نمودار"},{id:v.UserChangeInfo,name:"تغییر اطلاعات کابران زیرمجموعه"},{id:v.UserChangePassword,name:"تغییر کلمه عبور کابران زیرمجموعه"},{id:v.ManageAllUsersAndRoles,name:"مدیر اصلی سیستم"},{id:v.ViewLogs,name:"مشاهده لاگ‌های سیستم"}]}];var w="undefined"!=typeof e.id?e.id:0;a.parent="undefined"!=typeof e.parent?+e.parent:0;var x=w>0;a.id=w,a.isEdit=x,k.get().then(function(b){a.isAdmin=b.data.isAdmin;var c=_.filter(b.data.list,{isAdmin:!0});x&&(c=_.reject(c,{id:+a.id})),a.isAdmin&&(c=[{name:"بدون پدر",id:0}].concat(c)),x||0!==a.parent||(a.parent=c[0].id,a.changeParent()),a.roles=c}),b.get(app.urlPrefix+"api/themes/getnames").then(function(b){a.themes=b.data.list,a.selectThemes=_.extend([],b.data.list),a.selectThemes.splice(0,0,{name:"پیش فرض",id:-1}),_.each(a.themes,function(a){a.action=1}),s()})["catch"](function(){a.themes=[],a.selectThemes=_.extend([],[]),s()}),b.get(app.urlPrefix+"api/mainmenus/get/-1").then(function(b){a.mainmenus=b.data.list,_.each(a.mainmenus,function(a){a.action=1}),s()})["catch"](function(){a.mainmenus=[],s()}),a.jsonParse=function(a){return JSON.parse(a)},a.setViewPermission=function(b,c){var d=JSON.parse(b).id;_.some(c,{check:!0})?a.menuCategoriesAction[d]=a.menuCategoriesAction[d]||1:delete a.menuCategoriesAction[d]},q(),a.datasources=[],a.addDatasource=function(b){n.select(b,{type:["datasources"],multipleDatasource:!0,parentRole:a.parent}).then(function(b){var c=_.filter(b.selected,function(b){return!_.some(a.datasources,{id:b.id})});a.datasources=a.datasources.concat(c.map(function(a){return{id:a.id,name:a.name,action:1,permissions:a.permissions}}))})},a.clearDatasources=function(){a.datasources=[]},a.charts=[],a.addChart=function(b){n.select(b,{type:["charts"],parentRole:a.parent}).then(function(b){var c=_.filter(b.selected,function(b){return!_.some(a.charts,{id:b.id})});a.charts=a.charts.concat(c.map(function(a){return{id:a.id,name:a.name,action:1,permissions:a.permissions}}))})},a.clearCharts=function(){a.charts=[]},a.extraActionAllx=[],a.$watch("extraActionAllx",function(b,c){_.isArray(b)&&_.each(a.charts,function(a){a.chartExtraPermissions=b.slice()})},!0),a.datasourceActionAll=1,a.chartActionAll=1,a.actionAll=function(b,c){var d="datasource"===b?a.datasources:a.charts;"datasource"===b?a.datasourceActionAll:a.chartActionAll;_.forEach(d,function(a){var b=0;a.permissions.ViewPermission&&(b=1),a.permissions.EditPermission&&(b=2),a.permissions.DeletePermission&&(b=4),a.action=+c>b?b:+c})},x?b.get(app.urlPrefix+"api/roles/getInfo?id="+w).then(function(b){new Date;if(a.model=b.data.model,a.securityCertPatch=b.data.securityCertPatch,a.licenseThemes=b.data.themes,a.useApp=b.data.useApp,a.sign=b.data.sign,a.childs=b.data.childs,!a.licenseThemes){var c=_.indexOf(a.actions,{title:"مدیریت پوسته‌ها"});c!==-1&&a.actions.splice(c,1)}_.each(a.childs,function(b){b.parent===a.id&&(b.parent=0)}),a.childTree=k.createTree(a.childs),a.model.ParentRole&&(a.parent=a.model.ParentRole),p(),a.isAdmin=b.data.isAdmin,s()},o):(p(),a.restoreFinish=!0),a["delete"]=function(b,c){var d=a.charts;"chart"===b&&(d=a.charts),"datasource"===b&&(d=a.datasources);var e=_.findIndex(d,{id:c});e!==-1&&d.splice(e,1)},a.changeParent=function(){u(!1),p(),q()},b.get(app.urlPrefix+"api/users/getPropertyAutoCompleteEntries").then(function(b){a.auto=b.data,a.auto.keys=_.map(a.auto.keys,function(a){return{title:a}}),console.log("$scope.auto.keys",a.auto.keys),a.auto.flatValues=[],_.each(a.auto.values,function(b){_.each(b.values,function(b){a.auto.flatValues.indexOf(b)===-1&&a.auto.flatValues.push(b)})})},o),a.autocompeleteConfig={templates:{message:function(){}}},a.saveProgress=!1,i(["permission_view","permission_view_edit","permission_view_edit_delete"]).then(function(b){a.actionsKey=[{v:1,c:b.permission_view},{v:2,c:b.permission_view_edit},{v:4,c:b.permission_view_edit_delete}]}),a.save=function(d){a.restoreFinish&&(console.log("#### save"),a.saveProgressState=d?"exit":"stay",a.error=null,a.testResult=null,u(!0),console.log("#### save setModelData ",a.model),a.saveProgress=!0,b.post(app.urlPrefix+"api/roles/edit",a.model).then(function(b){a.saveProgress=!1,k.reset(),i(["new_role_created","edit_complete"]).then(function(a){var b=c.simple().textContent(x?a.edit_complete:a.new_role_created);c.show(b)}),d?f.path("/roles"):x||f.path("/roles/edit/"+b.data+"/"+a.parent)},function(b){a.saveProgress=!1,a.error=j.trustAsHtml(filterXSS("<b>"+b.data.title+"</b> <br/>"+b.data.desc)),t(b.data.desc)}))},a.checkAll=function(a){_.forEach(a.childes,function(b){b.disable||(b.check=a.checkAll)})},a.addFormSettings={},a.onFormSelect=function(b,c){a.forms=a.forms||[],_.each(b,function(b){_.some(a.forms,{id:b.id})||a.forms.push({id:b.id,name:b.name,action:1})}),h(function(){c.visible=!1},0)}}]),ngApp.filter("filterUsers",function(){return function(a,b){return a&&b?_.filter(a,function(a){return a.username.indexOf(b.username)!==-1||a.name.indexOf(b.username)!==-1}):a}}),ngApp.directive("formPremission",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel"},controller:["$scope","$http","formsService",function(a,b,c){}],template:'<div class="ui mini input">                        <sm-dropdown model="model" class="multiple selection" items="[                                                            {k:\'new record\', v:5},                                                            {k:\'edit record\', v:6},                                                            {k:\'delete record\', v:7},                                                            '+(app.license.formBatch?"{k:'batch edit', v:12},{k:'batch delete', v:13},":"")+'                                                          ]" label="item.k" value="item.v" default-text=""></sm-dropdwon>                    </div>'}});var ngApp=angular.module("management");ngApp.controller("rolesListCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$translate","utils","roles","toolbar","$q",function(a,b,c,d,e,f,g,h,i,j,k,l,m){a.utils=j,i("لیست نقش‌ها").then(function(a){l.setTitles([{name:a,click:function(){f.path("/roles")}}])}),a.progress=!0,k.get().then(function(b){a.progress=!1,a.data=_.filter(b.data.list,{editPermission:!0}),a.securityCertPatch=b.data.securityCertPatch,a.root=k.createTree(a.data)}),a.isSelected=function(){return _.some(a.data,{select:!0})},a["new"]=function(a){f.path("roles/edit")},a.deleteOne=function(b){_.each(a.data,function(a){a.select=!1}),b.select=!0,a["delete"]()},a.deleteRole=function(d){a.deleteType=d?"with-child":"";var e=app.urlPrefix+"api/roles/delete"+(d?"?withChild=true":""),f=_.filter(a.data,{select:!0}).map(function(a){return a.id});a.deleteProgress=!0,b.post(e,f).then(function(b){a.data=_.filter(a.data,function(a){return b.data.indexOf(a.id)==-1}),k.reset(),a.root=k.createTree(a.data);var d=c.simple().textContent("حذف انجام شد");c.show(d),$(".role-delete-modal").modal("hide"),console.log($(".role-delete-modal")),a.deleteProgress=!1},function(b){a.deleteProgress=!1,j.showErrorToast(b.data.desc),$(".role-delete-modal").modal("hide")})},$(".ui.dimmer.modals .role-delete-modal").remove(),a["delete"]=function(a){$(".role-delete-modal").modal("show")},a["goto"]=function(a,b){f.path("roles/edit/"+a.id)};var n,o=null;a.$watch("search",function(){h.cancel(n),n=h(function(){"undefined"!=typeof a.search&&(null!==o&&o.resolve(),o=m.defer(),a.progress=!0,b.get(app.urlPrefix+"api/roles/get?query="+a.search,{timeout:o.promise}).then(function(b){a.progress=!1,a.data=b.data.list}))},400)}),a.selectAll=function(){a.data&&_.forEach(a.data,function(b){b.select=a.selectAllCheckbox})}}]);var ngApp=angular.module("management");ngApp.controller("settingsCtrl",["$scope","$http","$sce","$timeout","$mdToast","roles",function(a,b,c,d,e,f){a.saveProgress=!1,$(".ui.dimmer.modals .sms-cert-modal").remove(),a.moment=moment,a.license=app.license,a.app=app,a.langs=[{key:0,value:"فارسی"},{key:1,value:"English"}],a.rebuildOlap=function(c){var d=confirm("آیا برای انجام انجام عملیات ساخت مجدد اطمینان دارید؟");d&&(a.rebuildProcess=!0,b.post(app.urlPrefix+"api/olap/rebuild").then(function(){a.rebuildProcess=!1,alert("عملیات موفق")},function(){a.rebuildProcess=!1,alert("خطا در انجام عملیات")}))},f.get().then(function(b){a.roles=b.data.list}),b.get(app.urlPrefix+"api/users/get").then(function(b){a.users=b.data.list}),b.get(app.urlPrefix+"api/LocationIp/get").then(function(b){a.locations=b.data}),a.save=function(d){a.saveProgress=!0,a.error=null,b.post(app.urlPrefix+"api/Settings/save",JSON.stringify(a.model),{headers:{"Content-Type":"application/json; charset=utf-8"}}).then(function(b){if(a.saveProgress=!1,b.data.result){var d=e.simple().textContent("تغییرات ثبت شد");e.show(d)}else a.error=c.trustAsHtml(filterXSS(b.data.error))})["catch"](function(b){a.saveProgress=!1,a.error=c.trustAsHtml(filterXSS(b.data.desc))})},a.checkSmsCert=function(){a.certCheckProgress=!0,b.get(app.urlPrefix+"api/sms/VerifyUrlCert").then(function(b){a.certCheckProgress=!1,a.invelidCert=!b.data.result,$(".sms-cert-modal").modal("show"),b.data.result||(a.cert=b.data.cert,a.hash=b.data.hash)})["catch"](function(){a.certCheckProgress=!1,alert("خطایی رخ داده است")})},a.approveCert=function(){a.certProgress=!0,b.post(app.urlPrefix+"api/sms/ApproveCert",{hash:a.hash}).then(function(b){a.certProgress=!1,$(".sms-cert-modal").modal("hide"),a.model.smsApprovedHash=a.hash})["catch"](function(){a.certProgress=!1,alert("خطایی رخ داده است")})},b.get(app.urlPrefix+"api/settings/getGeneralInfo").then(function(b){a.model=b.data.model,a.model.preventLoginRules=a.model.preventLoginRules||[],a.securityCertPatch=b.data.securityCertPatch,a.cdn=b.data.cdn,a.compareData=b.data.compareData,a.verification=b.data.verification,a.uploadLogo=b.data.uploadLogo}),a.addCdn=function(){a.model.cdn=a.model.cdn||{},a.model.cdn.items=a.model.cdn.items||[],a.model.cdn.items.push({type:0})},a.previewFile=function(b,c){var e=b.files[0];if(e.size>102400)return void alert("حجم فایل باید کمتر از ۱۰۰ کیلو بایت باشد");var f=new FileReader;$(b).attr("index");f.addEventListener("load",function(){d(function(){c?a.model.logoInverse=f.result:a.model.logo=f.result},0)},!1),e&&f.readAsDataURL(e)},a.appUpdate=function(){a.appUpdateProgress=!0,b.post(app.urlPrefix+"api/settings/updateApp").then(function(){a.appUpdateProgress=!1,alert("به روز رسانی با موفقیت انجام شد")})["catch"](function(){a.appUpdateProgress=!1,alert("خطا در عملیات به روز رسانی")})},a.rescheduleProcess=!1,a.reschedule=function(){a.rescheduleProcess=!0,b.post(app.urlPrefix+"api/Datasources/setAllDatasourceSchedule").then(function(b){var c=b.data.list.length;alert("تعداد "+c+" منبع داده با موفقیت دوباره زمانبدی شد"),a.rescheduleProcess=!1})["catch"](function(){alert("اشکال در اجرای برنامه"),a.rescheduleProcess=!1})}}]);var ngApp=angular.module("management");ngApp.controller("themesCtrl",["$scope","$http","$sce","$timeout","$location","roles","datasources","$routeParams",function(a,b,c,d,e,f,g,h){a.datasources=g,a.license=app.license,a.id="undefined"!=typeof h.id?h.id:0,a.variableName=h.name,a.path=e.path(),a.compareDataModel={datasources:g},a.isOlapTables=/\/olap-tables.*/.test(a.path),a.isUserVariableDetail=/\/userVariables\/.+/.test(a.path),a.onSaveTable=function(a){d(function(){e.path("/olap-tables/"+a.datasourceId)},0)}}]);var ngApp=angular.module("management"),mapType={Account:"مدیریت ورورد و کاربران",DataIntegrity:"صحت داده",BarChart:"خروجی اکسل و نمودار درختی",Charts:"نمودارها",CustomCharts:"نمودار دلخواد",Dashboard:"داشبورد",DashboardPage:"مدیریت داشبورد ",Dashboards:"داشبوردها",DataSource:"مدیریت منابع داده",DatasourceInterRelation:"مدیریت ارتباط بین منابع داده",Datasources:"لیست منابع داده",Excel:"خروجی اکسل",Filter:"فیلتر",Forms:"فرمها",GlobalVariable:"متغیرهای سراسری",Intervalfetchs:"دریافت دوره‌ای داده‌ها",JoinDataSource:"ارتباط بین منابع داده",Logs:"لاگ برنامه",Map:"دریافت نقشه",Maps:"مدیریت نقشه",Menu:"مدیریت منوها",Menus:"لیست منوها در قسمت مدیریت برنامه",Notification:"اعلان‌ها",OlapChartDesign:"مدیریت ساخت نمودار",Package:"مدیریت فولدرها",Permissions:"دریافت مجوز",Permission:"مجوزها",Profile:"پروفایل کاربر",Roles:"نقش‌ها",Sadaf:"کنترلر اصلی برنامه",Settings:"مدیریت تنظیمات برنامه",Users:"مدیریت کاربران",WebResource:"مدیریت وب سرویس‌ها",Alert:"هشدارها",Obfuscator:"درهم ساز",Captcha:"کپچا",License:"مجوز استفاده برنامه",RefreshManager:"تازه کردن منبع داده",ActiveDirectory:"اکتیودایرکتوری",Email:"پست الکترونیک"},mapOperation={VerifyCode:"کد احراز هویت",RemoveOldestRecord:"حذف رکوردهای قدیمی",Obfuscate:"درهم کردن",DeObfuscate:"باز کردن",LimitNotification:"اعلان محدودیت",Check:"بررسی",Activation:"فعال کردن لایسنس برنامه",Add:"اضافه کردن",AddMenu:"اضافه کردن منو",ChangePass:"تغییر کلمه عبور",Checkusername:"بررسی نام کاربری",Clone:"تکرار",CloneChart:"تکرار نمودار",Copy:"کپی",Create:"ایجاد",CubeInformation:"دریافت اطلاعات منبع داده",Dashboard:"داشبورد",Delete:"حذف",DeleteCharts:"حذف نمودارها",DeleteMenu:"حذف منو",Download:"دانلود",DuplicateMenu:"تکرار منو",Edit:"ویرایش",EditMenu:"ویرایش منو",Export:"خروجی",ExportToExcel:"خروجی به اکسل",GeneralSettings:"تنظیمات کلی",Get:"دریافت",GetCaptcha:"دریافت کد کپچا",GetChartMenus:"دریافت منوهای نمودار",GetChartPermissions:"دریافت مجوزهای نمودار",GetCurrent:"دریافت اطلاعات کاربر فعلی",GetDatasourceDimension:"دریافت یک ستون از منبع داده",GetDatasourceList:"لیست منابع داده",GetDatasourcePermissions:"مجوزهای منبع داده",GetEditor:"دریافت اطلاعات مربوط به ساخت نمودار",GetGeneralInfo:"دریافت اطلاعات تنظیمات",GetMailInfo:"دریافت اطلاعات ایمیل سامانه",GetMember:"دریافت داده‌های یک ستون از منبع داده",GetPropertyAutoCompleteEntries:"دریافت اطلاعات متغیرهای قبلی تعریف شده در سامانه برای نمایش لیست خودکار متغیرهای قبلی در ساخت متغیر زمان ویرایش کاربر",GetRecords:"دریافت رکوردهای لاگ",GetRelatedDatasource:"دریافت لیست منابع داده مرتبط با یک منبع داده",GetRoleFunctional:"دریافت لیست مجوزهای عملیاتی یک نقش",GetSingleChartInfo:"دریافت اطلاعات کلی از یک نمودار",GetTreeData:"دریافت اطلاعات نمودار درختی",Help:"راهنما",Index:"اکشن پیش فرض برنامه در کنترلر پیش فرض‌(sadaf)",Login:"ورود به برنامه",LogOff:"خروج از برنامه",MainMenu:"دریافت منوهای اصلی (مدیریت - داشبوردها)",Management:"اکشن مدیریت مربوط به کنترلر پیش فرض (برای باز شدن صفحه مدیریت این اکشن فراخوانی می‌شود)",MenuCategories:"دریافت لیست گروه‌های منو به همراه زیر منوها",MoveToPackage:"انتقال منابع داده یا نمودارها به یک پوشه",New:"جدید",Refresh:"تازه کردن",RemoveChartFromPage:"حذف نمودار از صفحه داشبورد",Sample:"نمایش داده های نمونه از فایل بارگذاری شده اکسل",Save:"ذخیره",SaveChart:"ذخیره نمودار",SendActivationSms:"ارسال کد فعالسازی پیامک در روند ثبت نام",SetChartsOrder:"ذخیره ترتیب نمودارها",Signup:"ثبت نام",ToogleFullscreen:"حالت تمام صفحه کردن داشبورد",Update:"به روز رسانی کاربر",UpdateSettings:"به روز رسانی تنظیمات",Upload:"آپلود نقشه جدید",UploadFiles:"آپلود فایل اکسل",VerifyPassword:"بررسی درست بودن کلمه عبور",View:"نمایش",AcceptInvalidCertificate:"تایید گواهینامه نامعتبر توسط کاربر",CheckCertificate:"بررسی گواهینامه",GetList:"دریافت لیست",CanLogin:"بررسی امکان لاگین"},mapResult={Begin:"شروع عملیات",End:"پایان عملیات",Failed:"اجرای ناموفق عملیات",Ok:"اجرای موفق"};ngApp.controller("logCtrl",["$scope","$http","$sce","$timeout","$mdToast","roles",function(a,b,c,d,e,f){function g(a){return Object.keys(a).map(function(b,c){return{label:a[b]||b,value:b}})}function h(){a.filters.page=a.page,a.getListProgress=!0,b.post(app.urlPrefix+"api/logs/getRecords",a.filters).then(function(b){a.getListProgress=!1,a.logs=b.data.list,a.checkList=b.data.checkList,a.pageCount=b.data.pageCount,a.page=b.data.page,a.securityCertPatch=b.data.securityCertPatch})["catch"](function(){a.getListProgress=!1})}a.saveProgress=!1,$(".ui.dimmer.modals .settings").remove(),f.get().then(function(b){a.roles=b.data.list}),a.mapType=_.sortBy(g(mapType),"label"),a.mapOperation=_.sortBy(g(mapOperation),"label"),a.mapResult=_.sortBy(g(mapResult),"label"),a.filters={},a.filters.rowCount=20,a.filters.sortKeys=[{order:"desc",name:"time"},{order:"desc",name:"date"}],a.langs=[{key:0,value:"فارسی"},{key:1,value:"English"}],a.showModal=function(){$(".ui.modal.settings").modal("show")},a.save=function(d){a.saveProgress=!0,b.post(app.urlPrefix+"api/logs/save",JSON.stringify(a.model),{headers:{"Content-Type":"application/json; charset=utf-8"}}).then(function(b){a.saveProgress=!1,$(".ui.modal.settings").modal("hide");var c=e.simple().textContent("تغییرات ثبت شد");e.show(c),a.error=null})["catch"](function(b){a.saveProgress=!1,a.error=c.trustAsHtml(b.data.desc)})},a.sortBy=function(b){if("sign"!==b){a.filters.sortKeys=a.filters.sortKeys||[];var c=_.remove(a.filters.sortKeys,{name:b}),d={order:"desc",name:b};c&&c.length>0&&(d=c[0]),d.order="desc"===d.order?"asc":"desc",a.filters.sortKeys.push(d),h()}},a.orderIcon=function(b){var c=_.find(a.filters.sortKeys,{name:b});return c?c&&"desc"==c.order?"down":"up":""},b.get(app.urlPrefix+"api/logs/get").then(function(b){a.model=b.data}),h(),a.filter=function(){a.page=0,h()},a.prevPage=function(){return a.page--,a.page<0?void(a.page=0):void h()},a.nextPage=function(){return a.page++,a.page>=a.pageCount?void a.page--:void h()}}]),ngApp.filter("dicMap",function(){return function(a,b){return"type"===b?mapType[a]||a:"operation"===b?mapOperation[a]||a:"result"===b?mapResult[a]||a:void 0}});var ngApp=angular.module("management");ngApp.controller("uploadChart",["$scope","$http","$sce","$timeout","$mdToast","customChart","utils",function($scope,$http,$sce,$timeout,$mdToast,customChart,utils){$(".ui.dimmer.modals .new-custom-chart-modal").remove(),$scope.utils=utils,$scope.model={},$scope.add=function(){$scope.model={},$(".new-custom-chart-modal").modal("show")},$scope.remove=function(a,b){var c=confirm(app.lang.translate("delete custom chart desc"));c&&customChart.remove(a.id).then(function(){$scope.data.splice(b,1);var a=$mdToast.simple().textContent("حذف انجام شد");$mdToast.show(a)})["catch"](function(){utils.showErrorToast("خطا در انجام عملیات")})},$scope.edit=function(a){$(".new-custom-chart-modal").modal("show"),$scope.editProgress=!0,customChart.get(a.id).then(function(a){$scope.editProgress=!1,$scope.model=a.model})["catch"](function(){$scope.editProgress=!1,utils.showErrorToast("خطا در انجام عملیات")})},$scope.editCat=function(){var a=_.find($scope.categories,{id:$scope.model.categoryId}),b=prompt("نام جدید را وارد کنید",a.name);b&&$http.post(app.urlPrefix+"api/customCharts/editCategory/"+a.id,'"'+b+'"').then(function(){a.name=b})},$scope.deleteCat=function(){var a=_.find($scope.categories,{id:$scope.model.categoryId}),b=_.findIndex($scope.categories,{id:$scope.model.categoryId}),c=confirm("ایا برای حذف دسته‌بندی "+a.name+" اطمینان دارید؟");c&&$http.post(app.urlPrefix+"api/customCharts/removeCategory/"+a.id).then(function(){$scope.categories.splice(b,1)})},customChart.get().then(function(a){$scope.data=a.list,$scope.categories=a.categories}),$scope.save=function(ev){if($scope.model.settingsTemplate=$scope.model.settingsTemplate||"{}",!$scope.model.name||!$scope.model.name.trim())return void alert("نام را وارد کنید");try{if(eval("var sTemp = "+$scope.model.settingsTemplate),"undefined"==typeof sTemp)return void alert("الگوی تنظیمات درست نیست");$scope.model.settingsTemplate=JSON.stringify(sTemp,null,"    ")}catch(e){return void alert("الگوی تنظیمات درست نیست")}$scope.saveProgress=!0,$http.post(app.urlPrefix+"api/customCharts/edit",$scope.model).then(function(a){var b=a.data;$scope.saveProgress=!1,$(".new-custom-chart-modal").modal("hide");var c=$mdToast.simple().textContent("ذخیره با موفقیت انجام شد");if($mdToast.show(c),$scope.model.id){var d=_.find($scope.data,{id:$scope.model.id});d.name=b.name}else $scope.data=$scope.data||[],$scope.data.push({id:b.id,name:b.name})})["catch"](function(a){alert("خطا در انجام عملیات "+a.data.desc),$scope.saveProgress=!1})}}]);var ngApp=angular.module("management");ngApp.controller("uploadChartDetail",["$scope","$http","$sce","$timeout","$mdToast","customChart","utils","$routeParams",function($scope,$http,$sce,$timeout,$mdToast,customChart,utils,$routeParams){function aceLoaded(a,b){a.renderer.setPadding(18),a.commands.addCommand({name:"myCommand",bindKey:{win:"Ctrl-S",mac:"Command-S"},exec:function(a){$timeout(function(){$scope.save()},0)}}),$scope.insertFormula=function(b){a.insert(b),a.focus()}}$scope.utils=utils,$scope.model={},$scope.app=app,$scope.add=function(){$scope.model={},$(".new-custom-chart-modal").modal("show")},$scope.aceOption={useWrapMode:!0,showGutter:!1,theme:"sqlserver",mode:"sqlserver",maxLines:14,onLoad:aceLoaded,require:["beautify"]},$scope.remove=function(a,b){var c=confirm(app.lang.translate("delete custom chart desc"));c&&customChart.remove(a.id).then(function(){$scope.data.splice(b,1);var a=$mdToast.simple().textContent("حذف انجام شد");$mdToast.show(a)})["catch"](function(){utils.showErrorToast("خطا در انجام عملیات")})},$scope.edit=function(){$scope.editProgress=!0,customChart.get($routeParams.id).then(function(a){$scope.editProgress=!1,$scope.model=a.model,$scope.categories=a.categories})["catch"](function(){$scope.editProgress=!1,utils.showErrorToast("خطا در انجام عملیات")})},$scope.edit(),$scope.editCat=function(){var a=_.find($scope.categories,{id:$scope.model.categoryId}),b=prompt("نام جدید را وارد کنید",a.name);b&&$http.post(app.urlPrefix+"api/customCharts/editCategory/"+a.id,'"'+b+'"').then(function(){a.name=b})},$scope.deleteCat=function(){var a=_.find($scope.categories,{id:$scope.model.categoryId}),b=_.findIndex($scope.categories,{id:$scope.model.categoryId}),c=confirm("ایا برای حذف دسته‌بندی "+a.name+" اطمینان دارید؟");c&&$http.post(app.urlPrefix+"api/customCharts/removeCategory/"+a.id).then(function(){$scope.categories.splice(b,1)})},$scope.save=function(ev){if($scope.model.settingsTemplate=$scope.model.settingsTemplate||"{}",!$scope.model.name||!$scope.model.name.trim())return void alert("نام را وارد کنید");try{if(eval("var sTemp = "+$scope.model.settingsTemplate),"undefined"==typeof sTemp)return void alert("الگوی تنظیمات درست نیست");$scope.model.settingsTemplate=JSON.stringify(sTemp,null,"    ")}catch(e){return void alert("الگوی تنظیمات درست نیست")}$scope.saveProgress=!0,$http.post(app.urlPrefix+"api/customCharts/edit",$scope.model).then(function(a){var b=a.data;$scope.saveProgress=!1,$(".new-custom-chart-modal").modal("hide");var c=$mdToast.simple().textContent("ذخیره با موفقیت انجام شد");if($mdToast.show(c),$scope.model.id){var d=_.find($scope.data,{id:$scope.model.id});d.name=b.name}else $scope.data=$scope.data||[],$scope.data.push({id:b.id,name:b.name})})["catch"](function(a){alert(a.data.desc),$scope.saveProgress=!1})}}]);var ngApp=angular.module("management");ngApp.controller("updateCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$translate","utils","datasources",function(a,b,c,d,e,f,g,h,i,j,k){a.progress=!0,b.get(app.urlPrefix+"api/users/get").then(function(b){a.progress=!1,a.data=b.data.list},j.error),j.onError(function(b){a.error=b,a.progress=!1}),a.isSelected=function(){return _.some(a.data,{select:!0})},a["new"]=function(a){f.path("users/edit")},a["delete"]=function(e){var f=app.urlPrefix+"api/users/delete",g=_.filter(a.data,{select:!0}).map(function(a){return a.id}),h=d.confirm().title("حذف برای همیشه؟").textContent(g.length+" مورد برای حذف انتخاب شده است").ariaLabel("حذف").targetEvent(e).ok("حذف!").cancel("لغو");d.show(h).then(function(){b.post(f,g).then(function(b){a.data=_.filter(a.data,function(a){return b.data.indexOf(a.id)==-1});var d=c.simple().textContent("حذف انجام شد");c.show(d)},function(a){j.showErrorToast(a.data.desc)})})},a["goto"]=function(a,b){f.path("users/edit/"+a.id)};var l;a.$watch("search",function(){h.cancel(l),l=h(function(){"undefined"!=typeof a.search&&(a.progress=!0,b.get(app.urlPrefix+"api/users/get?query="+a.search).then(function(b){a.progress=!1,a.data=b.data.list}))},400)}),a.selectAll=function(){a.data&&_.forEach(a.data,function(b){b.select=a.selectAllCheckbox})}}]);var ngApp=angular.module("management");ngApp.controller("userEditCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$translate","$sce","roles",function(a,b,c,d,e,f,g,h,i,j,k){function l(b){a.error=j.trustAsHtml(filterXSS("<b>"+b.data.title+"</b> <br/>"+b.data.desc))}function m(){a.model&&a.model.Roles&&a.roles&&(!a.model.mainRole&&a.roles.length&&(a.model.mainRole=a.roles[0].id),_.forEach(a.roles,function(b){a.model.Roles.indexOf(b.id)!==-1&&(b.check=!0)}),_.forEach(a.managebleRoles,function(b){a.model.ManagebleRoles.indexOf(b.id)!==-1&&(b.check=!0)}))}function n(a,b){a&&(a.check&&b.push(a.id),_.each(a.nodes,function(a){n(a,b)}))}function o(){var b=[];n(a.root,b),a.selectedRoles=_.filter(a.roles,function(a){return b.indexOf(a.id)!==-1})}function p(a){c.show({template:'<md-toast class="md-toast error"> <span class="md-toast-text" flex>'+a+"</span></md-toast>",hideDelay:3e3,position:"bottom left"})}function q(a){var b=new persianDate(a).format("YYYY/MM/DD");return depersian(b)}var r="undefined"!=typeof e.id?e.id:0,s=r>0;a.id=r,a.isEdit=s,a.app=app;var t=$("#user-expire-time").pDatepicker({autoClose:!0,format:"YYYY/MM/DD",initialValue:!1,onSelect:function(b){a.model.Expire=q(b)}});k.get().then(function(b){var c=performance.now();a.roles=angular.merge([],b.data.list),_.forEach(a.roles,function(a){a.action=1,a.check=!1}),a.managebleRoles=angular.merge([],a.roles),m();var d=_.filter(a.roles,{isAdmin:!0}),e=_.filter(a.managebleRoles,{isAdmin:!0});a.root=k.createTree(d),a.root2=k.createTree(e),o(),console.log("### get role time",performance.now()-c)}),a.urlbaseAdd=function(){a.model.urlbaseActiveRole=a.model.urlbaseActiveRole||{},a.model.urlbaseActiveRole.items=a.model.urlbaseActiveRole.items||[],a.model.urlbaseActiveRole.items.push({})},a.props=[],s?b.get(app.urlPrefix+"api/users/getInfo?id="+r).then(function(b){a.model=b.data.data,a.sign=b.data.sign,a.verification=b.data.verification,a.roleAdmins=b.data.roleAdmins,a.model.Properties&&(a.props=JSON.parse(a.model.Properties)),m(),a.model.Expire&&t.setDate(1e3*moment(a.model.Expire,"jYYYY/jMM/jDD").unix())},l):a.model={active:!0},a.verify=function(){a.verifyProgress=!0,b.post(app.urlPrefix+"api/users/verify?id="+r).then(function(b){a.verifyProgress=!1,a.model.isNameAuthenticated=b.data.isNameAuthenticated,a.model.isMobileAuthenticated=b.data.isMobileAuthenticated,a.model.FirstName=b.data.FirstName,a.model.LastName=b.data.LastName})["catch"](function(){a.verifyProgress=!1})},a.approve=function(){a.approveProgress=!0,b.post(app.urlPrefix+"api/users/approve?id="+r).then(function(){a.approveProgress=!1,a.model.isNameAuthenticated=!0,a.model.isMobileAuthenticated=!0})["catch"](function(){a.approveProgress=!1})},b.get(app.urlPrefix+"api/users/getPropertyAutoCompleteEntries").then(function(b){a.auto=b.data,a.auto.flatValues=[],_.each(a.auto.values,function(b){_.each(b.values,function(b){a.auto.flatValues.indexOf(b)===-1&&a.auto.flatValues.push(b)})})},l),a.$watch("root",function(a){o()},!0),a.saveProgress=!1,
a.save=function(){if(a.error=null,a.testResult=null,!a.userForm.$valid)return void i("form_invalid").then(function(a){p(a)});var d=[];n(a.root,d);var e=[];n(a.root2,e),a.model.Roles=d,a.model.ManagebleRoles=e;var g=_.indexOf(d,a.model.mainRole);return g===-1&&d.length?void p("نقش اصلی باید در لیست نقش‌ها انتخاب شده باشد"):(a.model.Properties=JSON.stringify(_.map(a.props,function(a){return{Key:a.Key,Value:a.Value}})),a.saveProgress=!0,void b.post(app.urlPrefix+"api/users/edit",a.model).then(function(b){a.saveProgress=!1;var d=c.simple().textContent(s?"تغییرات ثبت شد":"منبع داده جدید ایجاد شد");c.show(d),f.path("/users")},function(b){a.saveProgress=!1,a.error=j.trustAsHtml(filterXSS("<b>"+b.data.title+"</b> <br/>"+b.data.desc))}))}}]);var ngApp=angular.module("management");ngApp.controller("usersListCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$translate","utils","datasources","toolbar","$q",function(a,b,c,d,e,f,g,h,i,j,k,l,m){a.utils=j,i("لیست کاربران").then(function(a){l.setTitles([{name:a,click:null}])}),a.app=app,a.timeFormat=function(a){return a?moment(a).format("jYYYY/jMM/jDD HH:mm:ss"):""},a.progress=!0,b.get(app.urlPrefix+"api/users/get").then(function(b){a.progress=!1,a.data=b.data.list,a.securityCertPatch=b.data.securityCertPatch},j.error),j.onError(function(b){a.error=b,a.progress=!1}),a.isSelected=function(){return _.some(a.data,{select:!0})},a["new"]=function(a){f.path("users/edit")},a["delete"]=function(e){var f=app.urlPrefix+"api/users/delete",g=_.filter(a.data,{select:!0}).map(function(a){return a.id}),h=d.confirm().title("حذف برای همیشه؟").textContent(g.length+" مورد برای حذف انتخاب شده است").ariaLabel("حذف").targetEvent(e).ok("حذف!").cancel("لغو");d.show(h).then(function(){b.post(f,g).then(function(b){a.data=_.filter(a.data,function(a){return b.data.indexOf(a.id)==-1});var d=c.simple().textContent("حذف انجام شد");c.show(d)},function(a){j.showErrorToast(a.data.desc)})})},a["goto"]=function(a,b){f.path("users/edit/"+a.id)};var n,o;a.$watch("search",function(){h.cancel(n),n=h(function(){"undefined"!=typeof a.search&&(o&&o.resolve(),o=m.defer(),a.progress=!0,b.get(app.urlPrefix+"api/users/get?query="+a.search,{timeout:o.promise}).then(function(b){a.progress=!1,a.data=b.data.list}))},400)}),a.selectAll=function(){a.data&&_.forEach(a.data,function(b){b.select=a.selectAllCheckbox})}}]);var ngApp=angular.module("management");ngApp.controller("variablesCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$translate","utils","datasources","$mdMedia","toolbar",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(a){return a.DefaultValue=JSON.parse(a.DefaultValue),a.DefaultValue&&(a.DefaultValue=a.DefaultValue.map(function(a){return a.replace(/\[(index|calc)-\d+\]/gim,"")})),a}function o(a,b){return d.show({controller:["$scope","$mdDialog","$timeout",function(a,c,d){a.cancel=function(){c.cancel()},a.select=function(){return a.gbForm.$valid?void c.hide(a.model):void a.gbForm.$setSubmitted()},a.model={Name:"",Scope:0,DefaultValue:[]},b&&(a.model=angular.merge({},b))}],parent:angular.element(document.body),targetEvent:a,clickOutsideToClose:!0,fullscreen:l("sm")||l("xs"),template:'<md-dialog aria-label="{{\'choose\' | translate}}" ng-cloak >                                                                               <md-toolbar md-theme="default">                                                                                                                            <div class ="md-toolbar-tools">                                                                                                         <h2>{{\'choose\' | translate}}</h2>                                                                                                 <span flex></span>                                                                                                                  <span class ="material-icons" ng-click="cancel()">close</span>                                                                  </div>                                                                                                                          </md-toolbar>                                                                                                                       <md-dialog-content>                                                                                                                     <div class ="md-dialog-content" flex>                                                                                               <form name="gbForm">                                                                                                                   <div layout="row" layout-align="start center">                                                                                           <md-input-container flex="50" >                                                                                                         <label>{{\'name\' | translate}}</label>                                                                                             <input required name="name" ng-model="model.Name" md-autofocus>                                                                     <div ng-messages="gbForm.name.$error" ng-if=\'gbForm.$submitted || gbForm.name.$touched\'>                                            <div ng-message="required">{{\'form_username_required\' | translate}}</div>                                                       </div>                                                                                                                          </md-input-container>                                                                                                               <md-input-container flex="50">                                                                                                          <label>{{\'scope\' | translate}}</label>                                                                                            <md-select  ng-model="model.Scope">                                                                                                     <md-option value="0">{{\'scope_all_page\' | translate}}</md-option>                                                                 <md-option value="1">{{\'scope_current_page\' | translate}}</md-option>                                                         </md-select>                                                                                                                    </md-input-container>                                                                                                       </form>                                                                                                                             </div>                                                                                                                                                                                                                                                                     <md-chips flex ng-model="model.DefaultValue"                                                                                             ng-click=" $event.stopPropagation()"                                                                                                ng-change="row"                                                                                                                     placeholder="{{\'insert_user_prop_value\' | translate}}"                                                                            delete-button-label="{{\'delete_user_prop_value\' | translate}}"                                                                    delete-hint="{{\'press_delete_user_prop_value\' | translate}}"                                                                      secondary-placeholder="{{\'add_user_prop_value\' | translate}}"></md-chips>                                                                                                                                                                                     </div>                                                                                                                          </md-dialog-content>                                                                                                                <md-dialog-actions layout="row">                                                                                                        <md-button ng-click="select()" >                                                                                                        {{\'choose\' | translate}}                                                                                                      </md-button>                                                                                                                        <md-button ng-click="cancel()">                                                                                                         {{\'cancel\' | translate}}                                                                                                      </md-button>                                                                                                                    </md-dialog-actions>                                                                                                        </md-dialog>'})}a.utils=j,i("متغیرهای سراسری").then(function(a){m.setTitles([{name:a,click:null}])}),a.progress=!0,b.get(app.urlPrefix+"api/globalvariable/getlist").then(function(b){a.progress=!1,a.data=b.data,a.data=a.data.map(function(a){return n(a)})},j.error),j.onError(function(b){a.error=b,a.progress=!1}),a.isSelected=function(){return _.some(a.data,{select:!0})},a["new"]=function(d){o(d).then(function(d){b.post(app.urlPrefix+"api/globalvariable/add",d).then(function(b){a.data=a.data||[],a.data.push(n(b.data)),i("new_variable_created").then(function(a){var b=c.simple().textContent(a);c.show(b)})})})},a["delete"]=function(e){var f=app.urlPrefix+"api/globalvariable/deleteAll",g=_.filter(a.data,{select:!0}).map(function(a){return a.Id}),h=d.confirm().title("حذف برای همیشه؟").textContent(g.length+" مورد برای حذف انتخاب شده است").ariaLabel("حذف").targetEvent(e).ok("حذف!").cancel("لغو");d.show(h).then(function(){b.post(f,g).then(function(b){a.data=_.filter(a.data,function(a){return b.data.indexOf(a.Id)==-1}),i("delete_complete").then(function(a){var b=c.simple().textContent(a);c.show(b)})},function(a){j.showErrorToast(a.data.desc)})})},a["goto"]=function(a,d){o(d,a).then(function(d){b.post(app.urlPrefix+"api/globalvariable/add",d).then(function(b){a.DefaultValue=n(b.data).DefaultValue,i("edit_complete").then(function(a){var b=c.simple().textContent(a);c.show(b)})})})};var p;a.$watch("search",function(){h.cancel(p),p=h(function(){"undefined"!=typeof a.search&&(a.progress=!0,b.get(app.urlPrefix+"api/users/get?query="+a.search).then(function(b){a.progress=!1,a.data=b.data.list}))},400)}),a.selectAll=function(){a.data&&_.forEach(a.data,function(b){b.select=a.selectAllCheckbox})}}]),function(){function a(a,b){var c=1,d=b.map(function(a){return a.toLowerCase()});if(d.indexOf(a.toLowerCase())===-1)return a;for(;d.indexOf(a.toLowerCase()+c)!==-1;)c++;return a+c}function b(a,b){return a.filter(function(a){return!a.type||"kpi"!==a.type&&"measure"!==a.type}).map(function(a){return{Name:a.Name,UniqueName:a.UniqueName,Top:a.Top,preventChangeByUser:a.preventChangeByUser,sortOrder:a.sortOrder,sortKey:a.sortKey,sortFormula:a.sortFormula,CalcId:a.CalcId,formula:a.formula,formulas:a.formulas,applyLevel:a.applyLevel||0,IsNamedSet:"namedset"===a.type,aggregation:a.aggregation,Members:a.members&&a.members.list?a.members.list.filter(function(a){return a.Checked}).map(function(a){return b?a.UniqueName:a.Name}):[],UserProperties:a.userProperty?a.userProperty.filter(function(a){return a.Checked}).map(function(a){return a.Name}):[],GlobalViariable:a.globalVariable?a.globalVariable.filter(function(a){return a.Checked}).map(function(a){return a.Id}):[],NumericFilter:a.members?JSON.stringify(a.members.numericFilter):"",IsNumeric:!!a.members&&a.members.isNumeric,filter:a.members?a.members.filter:{},detail:JSON.stringify(a.detail||{})}})}function c(a,b){for(var c in a)if("customChartSettingTemplat"!==c)try{var d=a[c].series;if("undefined"==typeof d||!d||!a.hasOwnProperty(c))continue;var e=k(b);if(c!==e){delete a[c];continue}for(var e in d)d.hasOwnProperty(e)&&a.series.indexOf(e)===-1&&delete d[e]}catch(f){}}function d(a){var b=_.merge({},e(a.chartProp,a.chartType,a.dimensions,a.measures,a.where));return delete b.levelTypes,{prop:b,type:_.merge({},a.chartType)}}function e(a,b,c,e,f,g){_.isUndefined(a.tree)||_.remove(a.tree.dimensions,function(a){return _.isUndefined(_.find(c,{Name:a.name}))});var h=k(b);a[h]||(a[h]=m[h]);var i=a[h]||{};try{g&&(a.levelTypes.props[+a.levelTypes.current]=d(g)),a.levelTypes.enable||(a.levelTypes.props=[])}catch(j){}return i.levelTypes=a.levelTypes,i}function f(a){return _.find(app.charts.list,{type:a})}function g(b,c,d,e){var f=b.Formula?b.Formula:b.UniqueName,g="SUM("+f+")",h="SUM";b.IsNumeric||(g=""+f,h="NONE",e.measures.length||(g="COUNT("+f+")",h="COUNT")),b.Top={IsTop:!1,Top:10,IsPercent:!1,TopOrder:"DESC"};var i=$.extend({},b,{formula:g,aggregation:h});return+d.info.aggregation===-1&&(i.formula=f,i.aggregation="NONE"),i.Name=a(b.Name,c.map(function(a){return a.Name})),i}function h(b,c){var d=$.extend({},b,{sortOrder:"ASC",sortKey:"NONE",sortFormula:b.Formula?b.Formula:b.UniqueName,formula:b.Formula?b.Formula:b.UniqueName,applyLevel:0,detail:{histogramCategory:{enable:!1,width:10,count:7,overflowEnable:!1,underflowEnable:!1,overflow:100,underflow:0,type:"auto",customLabels:[],customLabelEnable:!1}}});return d.Name=a(b.Name,c.map(function(a){return a.Name})),d}function i(b,c){var d=$.extend({},b,{sortOrder:"ASC",sortKey:"NONE",formula:b.Formula?b.Formula:b.UniqueName});return d.Name=a(b.Name,c.map(function(a){return a.Name})),d}function j(a){var b=a.chartType.id,c=a.chartProp[n[+b]];return a.chartType.isCustom?{needDim:!0,needMeasure:!0,needServerData:!0}:a.chartType.id>10?f(a.chartType.id).config:app.chartCommons.getChartConfig(+b,c.info)}function k(a){var b=n[a.id];return a.id>10&&(b="key-"+a.id),a.isCustom&&(b="customChart"),b}var l={1:{name:app.lang.translate("bar"),type:1},2:{name:app.lang.translate("stack-bar"),type:1},3:{name:app.lang.translate("خطی"),type:1},4:{name:app.lang.translate("stack-line"),type:1},5:{name:app.lang.translate("area"),type:1},6:{name:app.lang.translate("stack area"),type:1},7:{name:app.lang.translate("pie"),type:2},8:{name:app.lang.translate("donut"),type:2},9:{name:app.lang.translate("arc gauge"),type:4},10:{name:app.lang.translate("نمودار رادار"),type:8},11:{name:app.lang.translate("نقشه"),type:6},12:{name:app.lang.translate("نمودار درختی"),type:9},13:{name:app.lang.translate("aggregated table"),type:5},14:{name:app.lang.translate("table"),type:5},15:{name:app.lang.translate("single select"),type:7},16:{name:app.lang.translate("multi select"),type:7},17:{name:app.lang.translate("تاریخ"),type:7},18:{name:app.lang.translate("محدوده تاریخ"),type:7},19:{name:app.lang.translate("range number"),type:7},20:{name:app.lang.translate("search"),type:7},21:{name:app.lang.translate("percent-stack-bar"),type:1},22:{name:app.lang.translate("percent-stack-line"),type:1},23:{name:app.lang.translate("percent-stack-area"),type:1},24:{name:app.lang.translate("multi part arc gauge"),type:4},25:{name:app.lang.translate("linear gauge"),type:4},26:{name:app.lang.translate("multi part linear gauge"),type:4},27:{name:app.lang.translate("number"),type:4},28:{name:app.lang.translate("جعبه‌ای"),type:1},29:{name:app.lang.translate("جدول فرم"),type:5},30:{name:app.lang.translate("تغییر شاخص"),type:7},31:{name:app.lang.translate("کلید فیلتر"),type:7}},m={bar:{info:{aggregation:"1",canExportXlsx:!0,refreshPeriod:"0",horizontalLines:!0,sortMeasures:!1,showSortBox:!0,formatString:",.0f",stackedBar:"1",stackedLine:"1",tooltip:"2",tooltipHeader:"{{set.key}}",tooltipFormat:'{{point.label}}: <span class="ltr inline" style="padding:0; margin:0;"><b>{{point.data}}</b></span>',xAxisLen:20,font:{bold:!1,color:"#333333",italic:!1,fontSize:"12px",fontName:"IRANSans",formatString:",.0f",formatStringCustom:",.0f"},secondaryY:{enable:!1,ticksType:"auto",ticksCount:10,ticksSpace:20,measures:{},font:{bold:!1,color:"#333333",italic:!1,fontSize:"12px",fontName:"IRANSans",formatString:",.0f",formatStringCustom:",.0f"}},xAxisRotate:"-90",AxeY:{ticksType:"auto",ticksCount:10,ticksSpace:20},showLegends:!0}},map:{info:{aggregation:"1",canExportXlsx:!0,refreshPeriod:"0",borderColor:"#374649",defaultColor:"#eeeeee",borderWidth:.5,tooltip:"3",tooltipFormat:'{{point.label}}: <span class="ltr inline" style="padding:0; margin:0;"><b>{{point.data}}</b></span>',tooltipHeader:"{{set.key}}",map:{selectedMap:"1"},chartType:"pie",showLabels:!1,mapType:"path",chartSize:50,realMap:{initialZoom:5,fillOpacity:.5},showLegend:!0,selectableArea:!0}},pie:{info:{aggregation:"1",canExportXlsx:!0,tooltip:"3",hole:"50",refreshPeriod:"0",formatString:",.0f",colorType:1,tooltipHeader:"{{set.key}}",tooltipFormat:"{{point.label}}: {{point.data}} :: {{point.percentage}}%",sort:!1}},tree:{info:{selectable:"one",aggregation:"1",canExportXlsx:!0,tooltip:"3",refreshPeriod:"0",formatString:",.0f",tooltipHeader:"{{set.key}}",tooltipFormat:"{{point.label}}: {{point.data}} :: {{point.percentage}}%",variableId:"-1",variableDefaultType:"NONE",functionDateFormat:"yy/mm/dd",functionUnitAgo:1,functionUnitAgoTwo:0,functionUnitAgoOffset:1,functionUnitAgoTwoOffset:1,dateFormatValue:"yy/mm/dd",justFilterDirectChild:!0}},gauge:{info:{font:{bold:!0,color:"#333333",italic:!1,fontSize:"34px",fontName:"IRANSans",formatString:",.0f",formatStringCustom:",.0f"},aggregation:"1",canExportXlsx:!0,textBold:!0,textItalic:!1,refreshPeriod:"0",segmentType:"singleSegment",style:"arc",height:"medium",formatString:",.2f",fontSize:"3em",color:"#333333",colorAriaThree:"#e14d57",colorAriaTwo:"#FBEE58",colorAriaOne:"#71b37c"}},radar:{info:{labelWidth:100,aggregation:"1",canExportXlsx:!0,refreshPeriod:"0",formatString:",.0f"}},table:{info:{aggregation:"1",canExportXlsx:!0,refreshPeriod:"0",sortMeasures:!1,condensed:!1,bordered:!1,stripped:!0,hover:!0,showHeader:!0,showRowNumber:!1,rowAsKey:!1,selectable:"multi",showAddButton:!0,cellHeight:60}},userControl:{info:{aggregation:"1",canExportXlsx:!1,showFilterIcon:"0",type:"combo",comboStyle:"bootstrap",label:"",sliderRange:"min-max",dateFormatShow:"yy/mm/dd",dateOp:"eq",sliderFormat:",.0f",variableId:"-1",variableDefaultType:"NONE",functionDateFormat:"yy/mm/dd",functionUnitAgo:1,functionUnitAgoTwo:0,functionUnitAgoOffset:1,functionUnitAgoTwoOffset:1,dateFormatValue:"yy/mm/dd",textOperand:"or",useLike:!0,useNormal:!0}},text:{info:{aggregation:"1",canExportXlsx:!1,formatString:",.0f",refreshPeriod:"0",showFilterIcon:"0",html:""}}},n={1:"bar",2:"pie",4:"gauge",8:"radar",5:"table",6:"map",7:"userControl",9:"tree",10:"text"},o=angular.module("management");o.directive("draggableItems",["$timeout","refreshChartService",function(a,b){return function(a,c,d){function f(){$("#columnList .datasource-field").draggable({appendTo:".chart-editor",helper:"clone",start:function(a,b){$(b.helper).addClass("ui-helper"),$(b.helper).width($(a.currentTarget).width())}}),$("#divX, #divY, #divProv").droppable({activeClass:"ui-state-default",hoverClass:"ui-state-hover",accept:":not(.ui-sortable-helper)",drop:function(c,d){var f=$(this).attr("id");if(a.$parent.isOlap){var j=d.draggable.attr("type"),k=null;if("measure"===j||"kpi"===j){if("divY"!==f)return;k="measure"===j?_.find(a.$parent.olapCubes[+a.$parent.selectedOlapCube||0].Measures,{UniqueName:d.draggable.data("name")}):_.find(a.$parent.olapCubes[+a.$parent.selectedOlapCube||0].Kpis,{UniqueName:d.draggable.data("name")}),k.type=j,a.$apply(function(){var b="divX"===f?a.dimensions:"divY"===f?a.measures:a.where;b.push($.extend({},k))})}if("dimension"===j){var l=d.draggable.attr("group-name");k=a.$parent.olapCubes[+a.$parent.selectedOlapCube||0].Dimensions[+d.draggable.attr("DimIndex")].group[l][+d.draggable.attr("index")],k.type="dimension";var m="divX"===f?a.dimensions:"divY"===f?a.measures:a.where;a.$apply(function(){m.push($.extend({},k))})}if("namedset"===j){var l=d.draggable.attr("group-name");k=a.$parent.olapCubes[+a.$parent.selectedOlapCube||0].NamedSets[+d.draggable.attr("index")],k.type="namedset";var m="divX"===f?a.dimensions:"divY"===f?a.measures:a.where;a.$apply(function(){m.push($.extend({},k))})}b.refreshChart()}else a.$apply(function(){var b=e(a.$parent.chartProp,a.$parent.chartType,null,null,null,a.$parent),c=a.dimensions.concat(a.measures).concat(a.where),j="divX"===f?a.dimensions:"divY"===f?a.measures:a.where,k="divX"===f?h:"divY"===f?g:i;j.push($.extend({},k(a.datasource.CubeInfo.Dimensions[+d.draggable.attr("DimIndex")].Hierarchies[+d.draggable.attr("index")],c,b,a)))}),b.refreshChart()}})}a.$last&&f()}}]),o.service("refreshChartService",["$timeout",function(a){var b,c=function(a){b=a},d=function(a){b&&b(a)};return{refreshChart:d,registerRefreshFunction:c}}]),o.controller("chartsEditorCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$translate","utils","$compile","$mdSidenav","$mdMedia","menus","datasources","roles","refreshChartService","customChart",function(a,i,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C){function D(){function b(){return angular.element("#divProp div")?(angular.element("#divProp div").remove(),angular.element("#divProp").append(h),v(angular.element("#divProp"))(a),void(a.chartType.isCustom||a.refreshChart())):void s(b,50)}var c=function(b,c){a.chartProp.customChartSettingTemplat=b,a.chartProp[c]=a.chartProp[c]||{general:{},series:{},info:{aggregation:1}},a.chartProp[c].config=a.chartProp.customChartSettingTemplat.config,_.each(a.chartProp.customChartSettingTemplat.general,function(b){b&&b.key&&"undefined"==typeof a.chartProp[c].general[b.key]&&(a.chartProp[c].general[b.key]=b["default"]),"section"===b.type&&_.each(b.items,function(b){b&&b.key&&"undefined"==typeof a.chartProp[c].general[b.key]&&(a.chartProp[c].general[b.key]=b["default"])})}),a.customChartDefaultSeries={},_.each(a.chartProp.customChartSettingTemplat.series,function(b,d){"undefined"==typeof a.chartProp[c].series[b.key]&&(a.customChartDefaultSeries[b.key]=b["default"]),"section"===b.type&&_.each(b.items,function(b){"undefined"==typeof a.chartProp[c].series[b.key]&&(a.customChartDefaultSeries[b.key]=b["default"])})}),a.chartProp[c].series._default=_.merge({},a.customChartDefaultSeries),a.refreshChart()};if(a.chartType.isCustom)C.getSettingsTemplate(a.chartType.id).then(function(a){c(JSON.parse(a||"{}"),"customChart")});else if(a.chartType.id>10){var d=f(a.chartType.id),e=k(a.chartType),g=d.settings;d.getSettings&&(g=d.getSettings()),c(g,e)}var h={};a.cntrName="chartsEditorCtrl";var e=k(a.chartType);switch(+a.chartType.id){case 1:h='<div  ng-chart-properties management-only="managementOnly" api-key="apiKey" open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="bar" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>';break;case 2:h='<div  ng-chart-properties management-only="managementOnly" api-key="apiKey" open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="pie" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>';break;case 4:h='<div  ng-chart-properties management-only="managementOnly" api-key="apiKey" open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="gauge" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>';break;case 5:h='<div  ng-chart-properties management-only="managementOnly" api-key="apiKey" open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="table" dimensions="dimensions" measures="measures" where="where" datasource="datasource"  filter-exception="filterException" calculated-fields="calculatedFields"></div>';break;case 6:h='<div  ng-chart-properties management-only="managementOnly" api-key="apiKey" open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="map" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>';break;case 7:h='<div  ng-chart-properties management-only="managementOnly" api-key="apiKey" open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="userControl" dimensions="dimensions" measures="measures" where="where" datasource="datasource"  filter-exception="filterException" calculated-fields="calculatedFields"></div>';break;case 8:h='<div  ng-chart-properties management-only="managementOnly" api-key="apiKey" open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="radar" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>';break;case 9:h='<div  ng-chart-properties management-only="managementOnly" api-key="apiKey" open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="tree" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>';break;case 10:h='<div ng-chart-properties management-only="managementOnly" api-key="apiKey" open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="text" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>';break;default:h='<div ng-chart-properties management-only="managementOnly" api-key="apiKey" open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="bar" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>'}a.chartType.isCustom&&(h='<div ng-chart-properties key="'+e+'" management-only="managementOnly" api-key="apiKey" open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="customChart" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>'),!a.chartType.isCustom&&a.chartType.id>10&&(h='<div ng-chart-properties key="'+e+'" management-only="managementOnly" api-key="apiKey" open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="key-'+a.chartType.id+'" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>'),s(b,0)}function E(b){_.forEach(b.Dimensions,function(a){a.group=_.groupBy(a.Hierarchies,"DisplayFolder")}),b.pkiGroup=_.groupBy(b.Kpis,"ParentUniquename"),b.MeasureGroups=b.MeasureGroups||[],b.MeasureGroups.unshift({name:"All",caption:"همه"}),a.selectedMeasureGroup="All",a.datasource.CubeInfo=a.olapCubes[a.selectedOlapCube]}function F(){return"combo-kpi"===a.type}function G(){var b=a.chartProp.extraKpi||[];if(b=b.filter(function(a){return a.name}).map(function(a){return a.name}),a.chartProp.series=(a.chartTriggeredSeries||[]).concat(b),a.chartType.isCustom||a.chartType.id>10){var c=k(a.chartType);_.each(a.chartProp.series,function(b){a.chartProp[c]&&a.chartProp[c].series&&(a.chartProp[c].series[b]=_.merge({},a.customChartDefaultSeries,a.chartProp[c].series[b]||{}))})}}function H(){a.menusSelected&&a.menus&&_.forEach(a.menus,function(b){_.forEach(b,function(b){a.menusSelected.indexOf(b.id)!==-1&&(b.check=!0)})})}function I(){if("undefined"!=typeof Storage){var a=localStorage.getItem("returnUrl");if(localStorage.removeItem("returnUrl"),!_.isUndefined(a)&&!_.isEmpty(a))return void(window.location.href=a)}window.history.length<=2?q.path("charts"):window.history.back()}function J(){var b=345;$("#tdChart").css("height",$(window).height()-b+"px").css("overfolw","auto"),$("#menu").css("height",$(".panel-body.chart-design").height()+"px").css("overfolw","auto"),$("#chrt-prop").css("height",$(".panel-body.chart-design").height()+"px").css("overfolw","auto"),"combo-kpi"===a.type&&$("#tdChart").css("height",$(window).height()-b+140+"px").css("overfolw","auto")}function K(){var b=a.chartProp[k(a.chartType)];return b||(a.chartProp=a.chartProp||$.extend({},m),b=a.chartProp[k(a.chartType)]||{}),b}function L(){a.rolePermissions&&a.roles&&(a.rolePermissionLoaded=!0,_.forEach(a.roles,function(b){var c=_.find(a.rolePermissions,{roleId:b.id});c&&(b.action=1==c.actionSum?1:3==c.actionSum?2:4,_.isArray(c.extra)&&(b.extra=c.extra.slice()),b.check=!0)}))}a.defaultIcon=app.urlPrefix+"images/chart-icons/unknown.png",a.oldcharts=[{title:"",items:[{type:1,title:"bar",iconLink:app.urlPrefix+"images/chart-icons/d3-bar.png"},{type:2,title:"bar-stack",iconLink:app.urlPrefix+"images/chart-icons/d3-bar-stack.png"},{type:21,title:"percent-stack-bar",iconLink:app.urlPrefix+"images/chart-icons/d3-bar-stack-percent.png"},{type:3,title:"خطی",iconLink:app.urlPrefix+"images/chart-icons/d3-line.png"},{type:4,title:"stack-line",iconLink:app.urlPrefix+"images/chart-icons/d3-line-stack.png"},{type:22,title:"percent-stack-line",iconLink:app.urlPrefix+"images/chart-icons/d3-line-stack-percent.png"},{type:5,title:"area",iconLink:app.urlPrefix+"images/chart-icons/d3-area.png"},{type:6,title:"stack area",iconLink:app.urlPrefix+"images/chart-icons/d3-area-stack.png"},{type:23,title:"percent-stack-area",iconLink:app.urlPrefix+"images/chart-icons/d3-area-stack-percent.png"},{type:28,title:"جعبه‌ای",iconLink:app.urlPrefix+"images/chart-icons/d3-box.png"},{type:7,title:"pie",iconLink:app.urlPrefix+"images/chart-icons/d3-pie.png"},{type:8,title:"donut",iconLink:app.urlPrefix+"images/chart-icons/d3-donut.png"},{type:9,title:"arc gauge",iconLink:app.urlPrefix+"images/chart-icons/d3-gauge.png"},{type:24,title:"multi part arc gauge",iconLink:app.urlPrefix+"images/chart-icons/d3-gauge-multi.png"},{type:25,title:"linear gauge",iconLink:app.urlPrefix+"images/chart-icons/d3-gauge-horiz.png"},{type:26,title:"multi part linear gauge",iconLink:app.urlPrefix+"images/chart-icons/d3-gauge-horiz-multi.png"},{type:27,title:"number",iconLink:app.urlPrefix+"images/chart-icons/digit.png"},{type:10,title:"نمودار رادار",iconLink:app.urlPrefix+"images/chart-icons/d3-radar.png"},{type:11,title:"نقشه",iconLink:app.urlPrefix+"images/chart-icons/d3-map.png"},{type:12,title:"نمودار درختی",iconLink:app.urlPrefix+"images/chart-icons/tree-data.png"},{type:13,title:"aggregated table",iconLink:app.urlPrefix+"images/chart-icons/table-aggr.png"},{type:14,title:"table",iconLink:app.urlPrefix+"images/chart-icons/table.png"},{type:29,title:"جدول فرم - ورود اطلاعات",iconLink:app.urlPrefix+"images/chart-icons/table-form.png"}]},{title:"",items:[{type:15,title:"single select",iconLink:app.urlPrefix+"images/chart-icons/combo.png"},{type:16,title:"multi select",iconLink:app.urlPrefix+"images/chart-icons/combo-multi.png"},{type:17,title:"تاریخ",iconLink:app.urlPrefix+"images/chart-icons/date.png"},{type:18,title:"محدوده تاریخ",iconLink:app.urlPrefix+"images/chart-icons/date-range.png"},{type:19,title:"range number",iconLink:app.urlPrefix+"images/chart-icons/slider.png"},{type:20,title:"search",iconLink:app.urlPrefix+"images/chart-icons/search.png"},{type:30,title:"تغییر شاخص",iconLink:app.urlPrefix+"images/chart-icons/kpi.png"},{type:31,title:"کلید فیلتر",iconLink:app.urlPrefix+"images/chart-icons/key.png"}]}],a.app=app;var M="undefined"!=typeof p.packageId?p.packageId:0,N="undefined"!=typeof p.id?p.id:0,O="undefined"!=typeof p.charttype?p.charttype:0,P=(p.type,
N>0);a.isEdit=P,a.id=N;var Q,R,S=N,T=app.urlPrefix+"api/olapchartdesign/SaveChart",U=P;a.managementOnly={id:N},a.olapData={measures:[],kpis:[]},a.dimensions=[],a.measures=[],a.where=[],console.log("### call editor"),a.newChartList=[],a.newChartEnable=chartUtils.enableNewCharts,chartUtils.enableNewCharts&&(a.newChartList=_.flatten(app.charts.list.map(function(a){return a.expandedChartType})),s(function(){var b=$(".chart-selector").popup({popup:$(".ui.flowing.basic.admission.popup"),transition:"scale",on:"click"});a.hidemenu=function(c){b.popup("hide"),s(function(){a.changeChartType(c)},0)}},0)),a.chartDimensions=[],a.chartMeasures=[],a.getChartName=function(a){var b="";return l[a]?b=l[a].name:_.each(app.charts.list,function(c){_.each(c.expandedChartType,function(c){c.type===a&&(b=c.name)})}),b||"نمودار دلخواه"},a.chartType={isCustom:!1,id:1},O&&(a.chartType={isCustom:!1,id:5},a.expandedChartType=29),a.chartProp=$.extend({},m),a.relatedDatasource=[],a.filterException={},a.calculatedFields={},a.selectedTab=0,a.updateDatasources=function(b){s(function(){a.datasource=a.datasource})},a.showAddDatasource=function(){z.select(null,{type:["datasources"]}).then(function(b){var c=b.selected[0];a.addRelatedDatasource(c.id)})},a.showRelatedDatasource=function(b){o.show({controller:["$scope","$mdDialog",function(b,c){b.$scope=a,a.relatedDatasourceList||i.get(app.urlPrefix+"api/olapchartdesign/GetRelatedDatasource?DataSourceId="+Q).then(function(b){a.relatedDatasourceList=b.data.filter(function(b){return a.datasource.CubeInfo.Dimensions.map(function(a){return+a.UniqueName}).indexOf(+b.Id)===-1})}),b.cancel=function(){c.cancel()}}],templateUrl:"chart-editor/related-datasource.html",parent:angular.element(document.body),targetEvent:b,clickOutsideToClose:!0,fullscreen:x("sm")||x("xs")})},a.removeRelatedDatasource=function(b,c){a.relatedDatasource.splice(a.relatedDatasource.indexOf(+c.UniqueName),1);var d=a.datasource.CubeInfo.Dimensions.splice(b,1);d[0].Hierarchies.forEach(function(b){function c(a){var c=a.map(function(a){return a.UniqueName}).indexOf(b.UniqueName);c!==-1&&a.splice(c,1)}c(a.dimensions),c(a.measures),c(a.where)}),a.refreshChart()},a.addRelatedDatasource=function(b){i.get(app.urlPrefix+"api/datasources/GetDatasourceDimension?DataSourceId="+b).then(function(c){a.finishedJob++,a.finishedJob===a.maxJob&&a.$broadcast("finishJobs"),a.datasource.CubeInfo.Dimensions.push(c.data),a.relatedDatasource.indexOf(b)===-1&&a.relatedDatasource.push(b)},function(){a.datasource.CubeInfo.Dimensions.push({Name:b+" - [حذف شده]",UniqueName:b+""}),a.finishedJob++,a.finishedJob===a.maxJob&&a.$broadcast("finishJobs"),a.refreshChart()})},a.filterRelatedDatasource=function(b){return a.relatedDatasource.indexOf(+b.Id)===-1},a.menu={name:"salam"},a.refreshingCube=function(){var b=a.olapCubes[a.selectedOlapCube];a.refreshCube=!0,i.post(app.urlPrefix+"api/olapchartdesign/ResetCube?CubeName="+b.Name+"&DataSourceId="+Q).then(function(){a.refreshCube=!1},function(){a.refreshCube=!1,alert("اشکال در روند اجرای برنامه")})},a.gettingData=!0,a.collapseAll=function(b){_.each(a.olapCubes[+a.selectedOlapCube].Dimensions,function(a){a.expand=b}),a.measureExp=b,a.kpiExp=b},a.changeCube=function(){var b=a.olapCubes[a.selectedOlapCube];b.Dimensions||i.get(app.urlPrefix+"api/olapchartdesign/GetCubeInnerData?CubeName="+b.Name+"&DataSourceId="+Q).then(function(b){performance.now();a.olapCubes[a.selectedOlapCube]=b.data.CubeInfo,E(a.olapCubes[a.selectedOlapCube])},function(){})},a.gr=function(a,b,c){return _.groupBy(a,b)},a.getColumnList=function(){a.datasource||i.get(app.urlPrefix+"api/OlapChartDesign/CubeInformation?DataSourceId="+Q).then(function(b){a.gettingData=!1;var c=b.data;a.isOlap=c.isOlap,a.datasource=c,c.isOlap&&(a.olapCubes=c.olapCubes,a.selectedOlapCube="0",E(a.olapCubes[0])),a.$broadcast("datasourceReady")})},a.gotoDatasource=function(a){var b={MsOlap:1,MSSQL:2,MySQL:3,File:4,WebResource:5,JoinDatasource:6},c=0;if(5===a.SystemType)return void q.path("olap-tables"+(a.UniqueName?"/"+a.UniqueName:""));if(6===a.SystemType||4===a.SystemType)return void alert("امکان ویرایش منابع داده سیستمی وجود ندارد");switch(a.DatasourceType){case b.MySQL:q.path("datasources/add/mssql/"+b.MySQL+"/"+c+"/"+a.UniqueName);break;case b.MsOlap:q.path("datasources/add/mssql/"+b.MsOlap+"/"+c+"/"+a.UniqueName);break;case b.MSSQL:q.path("datasources/add/mssql/"+b.MSSQL+"/"+c+"/"+a.UniqueName);break;case b.File:q.path("datasources/add/file/"+c+"/"+a.UniqueName);break;case b.WebResource:q.path("datasources/add/web/"+c+"/"+a.UniqueName);break;case b.JoinDatasource:q.path("datasources/add/join/"+c+"/"+a.UniqueName)}},a.changeDatasource=function(b,c){z.select(null,{type:["datasources"]}).then(function(d){var e=d.selected[0];i.get(app.urlPrefix+"api/datasources/GetDatasourceDimension?DataSourceId="+e.id).then(function(d){a.datasource.CubeInfo.Dimensions.splice(c,1,d.data),0===c&&(Q=e.id),a.relatedDatasource.indexOf(+b.UniqueName)!==-1&&a.relatedDatasource.splice(a.relatedDatasource.indexOf(+b.UniqueName),1,e.id);var f=function(a){return a?a.replace("id"+b.UniqueName,"id"+e.id):a},g=function(a){a.UniqueName=f(a.UniqueName),a.sortFormula=f(a.sortFormula),a.formula=f(a.formula),a.Levels[0].UniqueName=f(a.Levels[0].UniqueName),a.Levels[1].UniqueName=f(a.Levels[1].UniqueName)};_.each(a.dimensions,g),_.each(a.measures,g),_.each(a.where,g),a.refreshChart()})})},a.gotoChart=function(a){q.path("charts/edit/0/"+a.Id)};var V,W=function(b){o.show({controller:["$scope","$mdDialog",function(b,c){b.parent=a,b.cancel=function(){b.parent.memberQuery=null,c.cancel()},b.save=function(){b.parent.memberQuery=null,b.parent.refreshChart(),c.cancel()}}],templateUrl:"editor/filterMember.html",parent:angular.element(document.body),targetEvent:b,clickOutsideToClose:!0,fullscreen:x("sm")||x("xs")})},X=_.debounce(function(){console.log(a.memberQuery,V),a.filterMember(V,!0)},400);a.memberQueryChange=function(){X()},a.memberProgress=!1,a.filterMember=function(b,c,d){V=b,c||W();b.members&&!b.members.list;a.memberProgress=!0,i.post(app.urlPrefix+"api/OlapChartDesign/GetMember",JSON.stringify({CubeName:a.isOlap?a.olapCubes[+a.selectedOlapCube||0].Name:"",Uniquename:a.isOlap?b.UniqueName:b.formula,aggregation:b.aggregation,orderBy:"NONE"===b.sortKey?b.formula:b.sortFormula,orderType:b.sortOrder,DataSourceId:Q,calculatedFields:[],query:a.memberQuery}),{headers:{"Content-Type":"application/json; charset=utf-8"}}).then(function(c){var e=c.data;if(e.result){var f={name:b.Name,isNumeric:e.isNumeric,list:e.data,numericFilter:{type:"condition",conditions:[{condition:"none",parameter:"0"},{condition:"none",parameter:"0"}],conditionType:"and",func:"aboveAvg"},aggregation:b.aggregation,filter:{type:"value",funcType:"time"}};if(f=_.extend({},f,b.members),b.members){var g=_.filter(b.members.list,{Checked:!0}),h=_.differenceWith(e.data,g,function(a,b){return a.UniqueName==b.UniqueName});f.list=g.concat(h);var i=_.filter(b.members.list,{Checked:!0});i.forEach(function(a){var b=_.find(f.list,{UniqueName:a.UniqueName});b&&(b.Checked=!0)})}b.members=f}a.members=b.members,d&&d(),a.memberProgress=!1})["catch"](function(){a.memberProgress=!1}),b.userProperty=a.datasource.UsersProperty.map(function(a){var c={Name:a};return b.userProperty&&(c.Checked=_.some(b.userProperty,{Name:a,Checked:!0})),c}).slice(0),b.globalVariable=a.datasource.GlobalVariable.map(function(a){var c={Name:a.Name,Id:a.Id};return b.globalVariable&&(c.Checked=_.some(b.globalVariable,{Id:a.Id,Checked:!0})),c}).slice(0),a.globalVariable=b.globalVariable,a.userProperty=b.userProperty},a.checkAll=function(a,b){a&&a.forEach(function(a){a.Checked=b})},a.sortableOptions={stop:function(){s(function(){a.refreshChart()},0)},receive:function(a,b){$(a.target).attr("id"),$(b.sender).attr("id")}},a.refreshChart=function(c){app.chartCommons.drillDown.clearAll();var d=$.extend({needDim:!0,needMeasure:!0,needServerData:!0},j(a));a.chartRenderError=null;var f=app.customChart.getConfig(a.chartType)||{};if(!a.chartType.isCustom){if(!F()&&d.needDim&&0===a.dimensions.length)return $("#divChart").empty(),void t("chart_editor_need_measure").then(function(b){a.chartRenderError=b});if(!F()&&d.needMeasure&&0===a.measures.length)return $("#divChart").empty(),void t("chart_editor_need_measure").then(function(b){a.chartRenderError=b});if(F()&&!a.combo.selectedChart.length)return $("#divChart").empty(),void t("chart_editor_need_chart").then(function(b){a.chartRenderError=b})}if(f.needServerData!==!1&&!F()&&d.needMeasure&&0===a.measures.length)return $("#divChart").empty(),void t("chart_editor_need_measure").then(function(b){a.chartRenderError=b});if(f.needServerData!==!1&&F()&&!a.combo.selectedChart.length)return $("#divChart").empty(),void t("chart_editor_need_chart").then(function(b){a.chartRenderError=b});if(c&&$("#divChart").data("isChart")){var g=$("#divChart").data("settings");if("undefined"==typeof g.input)return;g.input.result||(c=null),F()||!d.needServerData||g.input.fields||7!==+a.chartType.id||a.chartType.isCustom||(c="refreshWithData")}var h={Title:"",CubeName:a.isOlap?a.olapCubes[+a.selectedOlapCube||0].Name:"xxx",Description:"",Hierarchies:b(a.dimensions,a.isOlap),Where:b(a.where,a.isOlap),SeriesLevel:b(a.measures,a.isOlap),DataSourceId:Q,Detail:JSON.stringify({chartProp:e(a.chartProp,a.chartType,a.dimensions,a.measures,a.where,a),needServerData:d.needServerData,tableInfo:a.tableInfo,relatedDatasource:a.relatedDatasource,filterException:a.filterException,calculatedFields:a.calculatedFields,dataType:a.type,combo:a.combo})};a.isOlap&&(h.Measurs=_.map(_.filter(a.measures,["type","measure"]),"UniqueName"),h.Kpis=_.map(_.filter(a.measures,["type","kpi"]),"UniqueName"));var i={ChartInfo:h,notEditMode:!1},k={chartProp:e(a.chartProp,a.chartType,a.dimensions,a.measures,a.where,a),parameters:i,editMode:!0,needServerData:d.needServerData,tableInfo:a.tableInfo,relatedDatasource:a.relatedDatasource,calculatedFields:a.calculatedFields,dataType:a.type,combo:a.combo};$("#divChart").data("chartInfo",h),app.chartCommons.drillDown.clear(-1),clearTimeout(a.lastRefreshTimeout),a.lastRefreshTimeout=setTimeout(function(){k.permissions={},k.type=a.chartType,k.title=a.chartName||"",c||$("#divChart").empty(),dashboard.addChart(null,k,c,0,$("#divChart"))},400),$("#divChart").off("legendClick"),$("#divChart").on("legendClick",function(b,c,d,e){s(function(){a.menu.set("series"),a.chartProp.selectedSeries=e.key},20)})},B.registerRefreshFunction(a.refreshChart),a.gotoDimentionSettings=function(b,c){a.menu.set("dimension"),a.menu.selectedDimension=c+""},a.gotoMeasureSettings=function(b,c){a.menu.set("measure"),a.menu.selectedMeasure=c+""},a.gotoWhereSettings=function(b,c){a.menu.set("where"),a.menu.selectedwhere=c+""},$("#divChart").bind("tableInfo",null,function(b,c){s(function(){var b=a.tableInfo?a.tableInfo.Limit||10:10;a.tableInfo=c.TableInfo,a.tableInfo.Limit=b,a.chartProp.tableInfo=a.tableInfo},0)}),$("#divChart").bind("columnsWidth",null,function(b,c){s(function(){a.chartProp.table.info.columnsWidth=c.columnsWidth},0)}),a.$watch("chartProp.extraKpi",function(b){_.isArray(a.chartProp.series)&&G()},!0),$("#divChart").off("chartproperty"),$("#divChart").on("chartproperty",null,function(b,c){s(function(){a.chartTriggeredSeries=c,G()},0)}),$("#divChart").bind("dimColor",null,function(b,c){s(function(){a.chartProp.dimColor=a.chartProp.dimColor||{},_.each(c,function(b){a.chartProp.dimColor[b]={}}),a.chartProp.matrix=_.merge({},a.chartProp.dimColor)},0)}),y.get().then(function(b){_.forEach(b.data,function(a){a.check=!1});var c=_.sortBy(b.data,["parentOrder","order"]);a.menus=_.groupBy(angular.merge([],c),"parent"),H()}),a.showDialog=function(b,c){o.show({controller:["$scope","$mdDialog",function(b,d){b.parent=a,b.cancel=function(){d.cancel()},b.save=function(){P||b.parent.saveNewChart(c),d.cancel()}}],templateUrl:"editor/save-chart.html",parent:angular.element(document.body),targetEvent:b,clickOutsideToClose:!0,fullscreen:x("sm")||x("xs")})},a.save=function(b,c){return U?void a.saveNewChart(c):void a.showDialog(b,c)},a.cancel=function(){I()},a["delete"]=function(b){var c=app.urlPrefix+"api/Charts/DeleteCharts",d=o.confirm().title("حذف برای همیشه؟").textContent("آیا برای حذف نمودار "+a.chartName+" اطمینان دارید؟").ariaLabel("حذف").targetEvent(b).ok("حذف!").cancel("لغو");o.show(d).then(function(){i.post(c,["ChartId-"+a.id]).then(function(a){if(a.data.result){var b=n.simple().textContent("حذف انجام شد");n.show(b),2===window.history.length?q.path("charts"):window.history.back()}},function(){var a=n.simple().textContent("اشکال در حذف!");n.show(a)})})},a.saveNewChart=function(d){if(!a.chartName)return t("form_name_required").then(function(a){u.showErrorToast(a)}),!1;var f=_.filter(a.roles,{check:!0}).map(function(a){return a.action+"-"+a.id}),g=_.filter(a.roles,{check:!0}).map(function(a){return{id:a.id,permissions:a.extra}}),h=[];_.forEach(a.menus,function(a){_.forEach(a,function(a){a.check&&h.push(a.id)})}),c(a.chartProp,a.chartType);var k=$.extend({needDim:!0,needMeasure:!0,needServerData:!0},j(a));a.combo&&!U&&(a.combo.title=$("#chartTitleFarsi").val());var l=e(a.chartProp,a.chartType,a.dimensions,a.measures,a.where,a),m={datasourceId:Q,relatedDatasource:a.relatedDatasource,dimensions:a.dimensions,measures:a.measures,where:a.where,chartType:a.chartType,expandedChartType:a.expandedChartType,chartProp:l,needServerData:k.needServerData,tableInfo:a.tableInfo,filterException:a.filterException,calculatedFields:a.calculatedFields,dataType:a.type,combo:a.combo,isOlap:a.isOlap,selectedOlapCube:a.selectedOlapCube,extraKpi:a.chartProp.extraKpi},o={id:S,editMode:U,xChartType:a.chartType.id,isCustom:a.chartType.isCustom,xTitleFarsi:a.chartName,chartUniquename:"",cubeName:a.isOlap?a.olapCubes[+a.selectedOlapCube||0].Name:"xxx",hierarchy:b(a.dimensions,a.isOlap),where:b(a.where,a.isOlap),seriesLevel:b(a.measures,a.isOlap),ChartActions:f,chartExtraActions:g,Menus:h,detail:JSON.stringify(m),DataSourceId:Q,Desc:a.chartDesc,PackageId:M,managementOnly:a.managementOnly};return a.isOlap&&(o.measures=_.map(_.filter(a.measures,["type","measure"]),"UniqueName"),o.kpis=_.map(_.filter(a.measures,["type","kpi"]),"UniqueName")),a.saveProgress=!0,i.post(T,JSON.stringify(o),{headers:{"Content-Type":"application/json; charset=utf-8"}}).then(function(b){a.saveProgress=!1,t("chart_editor_save_success").then(function(a){n.show(n.simple().textContent(a))}),a.$broadcast("save-chart"),q.path("charts/edit/"+M+"/"+b.data.id).replace(),z.reset(),d&&I()})["catch"](function(){a.saveProgress=!1,n.show({template:'<md-toast class="md-toast error"> <span class="md-toast-text" flex>خطا در ذخیره‌سازی</span></md-toast>',hideDelay:3e3,position:"bottom left"})}),!0},a.addLevelType=function(){"undefined"==typeof a.chartProp.levelTypes&&(a.chartProp.levelTypes={enable:!0,current:0,props:[d(a)]}),a.chartProp.levelTypes.enable=!0;var b=a.chartProp.levelTypes;b.props=b.props||[{}],b.props.push(d(a));var c=b.current;b.current=b.props.length-1+"",a.changeLevelType(b.current,c)},a.removeLevelType=function(){var b=a.chartProp.levelTypes;b.props.length<2||(_.isArray(b.props)&&b.props.length&&a.chartProp.levelTypes.props.splice(b.props.length-1,1),+b.current===b.props.length&&(b.current=+b.current-1+"",a.changeLevelType(b.current,+b.current+1)),1===b.props.length&&(b.enable=!1))},a.changeLevelType=function(b,c){var e=a.chartProp.levelTypes;e.props=e.props||[],e.props.length>+c&&(e.props[+c]=d(a));var f=_.merge({},e.props[+b]);if(f&&f.type){var g=k(f.type);a.chartProp[g]=_.merge({},f.prop),a.chartType=_.merge({},f.type)}D()},a.restore=function(b){var c={datasourceId:-1,dimensions:[],relatedDatasource:[],measures:[],where:[],chartType:1,chartProp:{},tableInfo:null,filterException:{},calculatedFields:{},isOlap:!1};b=$.extend({},c,b),Q=b.datasourceId,a.relatedDatasource=b.relatedDatasource,a.where=b.where,a.chartType=b.chartType,"undefined"==typeof b.chartType.isCustom&&(a.chartType={isCustom:!1,id:b.chartType});var d={},e=k(a.chartType);if(d[e]=b.chartProp,d.levelTypes=b.chartProp.levelTypes,a.dimensions=b.dimensions,a.measures=b.measures,a.chartProp=_.merge({},m,d),a.expandedChartType=b.expandedChartType,a.tableInfo=b.tableInfo,a.filterException=b.filterException,a.calculatedFields=b.calculatedFields||{},a.chartProp.extraKpi=b.extraKpi||[],a.maxJob=0,a.finishedJob=-1,a.isOlap=b.isOlap,a.selectedOlapCube=b.selectedOlapCube,a.selectedOlapCube=_.findIndex(a.olapCubes,{Name:a.chart.CubeName})+"",a.isOlap&&0!==+a.selectedOlapCube&&a.changeCube(),a.type=b.dataType,a.combo=b.combo||{},a.combo.synonyms=a.combo.synonyms||[],a.combo.aggregation=a.combo.aggregation||0,a.maxJob=a.relatedDatasource?a.relatedDatasource.length:0,a.relatedDatasource.forEach(function(b){a.addRelatedDatasource(b)}),_.each(a.combo.selectedChart,function(b){i.get(app.urlPrefix+"api/charts/get?id="+b.Id).then(function(c){if(!c.data)return _.remove(a.combo.selectedChart,{Id:b.Id}),void a.refreshChart();var d=_.find(a.combo.selectedChart,{Id:b.Id});d.Name=c.data.Name})}),_.isUndefined(a.expandedChartType)){var f=_.findKey(l,_.find(l,{type:+a.chartType.id}));a.expandedChartType=+f}D()},a.chagePivotFormula=function(b){a.measures&&(1===b?a.measures.forEach(function(a){var b="SUM("+a.UniqueName+")",c="SUM";a.IsNumeric||(b="COUNT("+a.UniqueName+")",c="COUNT"),a.formula=b,a.aggregation=c}):a.measures.forEach(function(a){a.formula=a.UniqueName,a.aggregation="NONE"}))},a.setType=function(b){a.type=b,"combo-kpi"!==b?a.getColumnList():a.$broadcast("datasourceReady"),J()},a.charts=[],a.getCharts=function(){i.get(app.urlPrefix+"api/charts/get").then(function(b){b.data.result?a.charts=b.data.list:a.charts=[]},function(){a.charts=[]})},a.showChartsDialog=function(){$("#charts-modal").modal("show"),a.charts&&a.charts.length||a.getCharts()},a.combo={combineType:0,aggregation:0,selectedChart:[],synonyms:[]},a.addChart=function(b){a.combo.selectedChart.push(b),a.refreshChart()},a.selectChart=function(b){z.select(b,["charts"]).then(function(b){"charts"===b.type&&(_.forEach(b.selected,function(b){a.combo.selectedChart.push({Id:b.id,Name:b.name})}),a.refreshChart())})},C.get().then(function(b){a.customCharts=b.list,a.customCharts2=_.groupBy(b.list,"category"),_.each(b,function(a){l[a.id+1e3]={name:a.name,type:a.id}})}),a.getChartTypeBaseOnExtendedType=function(a){if(l[a])return l[a].type;var b=-1;return _.each(app.charts.list,function(c){_.each(c.expandedChartType,function(d){d.type===a&&(b=c.type)})}),b},l={1:{name:app.lang.translate("bar"),type:1},2:{name:app.lang.translate("stack-bar"),type:1},3:{name:app.lang.translate("خطی"),type:1},4:{name:app.lang.translate("stack-line"),type:1},5:{name:app.lang.translate("area"),type:1},6:{name:app.lang.translate("stack area"),type:1},7:{name:app.lang.translate("pie"),type:2},8:{name:app.lang.translate("donut"),type:2},9:{name:app.lang.translate("arc gauge"),type:4},10:{name:app.lang.translate("نمودار رادار"),type:8},11:{name:app.lang.translate("نقشه"),type:6},12:{name:app.lang.translate("نمودار درختی"),type:9},13:{name:app.lang.translate("aggregated table"),type:5},14:{name:app.lang.translate("table"),type:5},15:{name:app.lang.translate("single select"),type:7},16:{name:app.lang.translate("multi select"),type:7},17:{name:app.lang.translate("تاریخ"),type:7},18:{name:app.lang.translate("محدوده تاریخ"),type:7},19:{name:app.lang.translate("range number"),type:7},20:{name:app.lang.translate("search"),type:7},21:{name:app.lang.translate("percent-stack-bar"),type:1},22:{name:app.lang.translate("percent-stack-line"),type:1},23:{name:app.lang.translate("percent-stack-area"),type:1},24:{name:app.lang.translate("multi part arc gauge"),type:4},25:{name:app.lang.translate("linear gauge"),type:4},26:{name:app.lang.translate("multi part linear gauge"),type:4},27:{name:app.lang.translate("number"),type:4},28:{name:app.lang.translate("جعبه‌ای"),type:1},29:{name:app.lang.translate("جدول فرم"),type:5},30:{name:app.lang.translate("تغییر شاخص"),type:7},31:{name:app.lang.translate("کلید فیلتر"),type:7}},a.expandedChartType=a.expandedChartType||1;var Y=1;if(a.changeChartType=function(b,c){Y=a.expandedChartType,app.chartCommons.clicked=!0,a.expandedChartType=b;var d=_.extend({},a.chartType),e=a.getChartTypeBaseOnExtendedType(b);e===-1?a.chartType.id=b-1e3:a.chartType.id=e,a.chartType.isCustom=c||!1,14!==Y&&29!==Y||14===a.expandedChartType||a.chagePivotFormula(1),14===Y||14!==a.expandedChartType&&29!==a.expandedChartType||a.chagePivotFormula(-1),app.chartCommons.expandedType=a.expandedChartType;var f=K();app.chartCommons.changeSeriesPropertyBaseOnExpandedType(f),D(),f=K(),f.indicator=a.chartProp[k(d)].indicator},P)a.selectedTab=1,i.get(app.urlPrefix+"api/charts/GetChartMenus?id="+N).then(function(b){a.menusSelected=b.data,H()}),A.get().then(function(b){a.roles=angular.merge({},b.data.list),_.forEach(a.roles,function(a){a.action=1,a.extra=[],a.check=!1}),L()}),i.get(app.urlPrefix+"api/permissions/getChartPermissions?id="+a.id).then(function(b){a.rolePermissions=b.data.list,L()}),a.app=app,i.get(app.urlPrefix+"api/charts/getEditor?id="+N).then(function(b){Q=b.data.dataSourceId,R=b.data.type,a.sign=b.data.sign,a.chart=b.data.chart,a.apiKey={key:b.data.ApiKey,id:N};var c=JSON.parse(b.data.chart.Detail);a.$on("datasourceReady",function(){a.restore(c)}),a.setType(R),a.chartName=a.chart.Name,a.chartDesc=a.chart.Description,a.managementOnly=b.data.managementOnly,a.managementOnly=a.managementOnly||{},a.managementOnly.id=N,a.managementOnly.restore=function(b){a.restore(JSON.parse(b.detail))}},function(a){a.data.desc?alert(a.data.desc):alert("خطا در دریافت اطلاعات نمودار")});else{Q=p.datasourceId,R=p.type,"combo-kpi"===R&&_.forEach(z.lastSelected.charts,function(b){a.combo.selectedChart.push({Id:b.id,Name:b.name})}),a.setType(R),app.chartCommons.expandedType=a.expandedChartType;var Z=K();app.chartCommons.changeSeriesPropertyBaseOnExpandedType(Z),D()}a._=_,a.existIn=function(a,b){return _.some(b,{UniqueName:a.UniqueName})},a.notInMeasureGroup=function(a){},a.addToChart=function(b){var c=!b.IsNumeric,d=e(a.chartProp,a.chartType,null,null,null,a),f=a.dimensions.concat(a.measures).concat(a.where),i=c?a.dimensions:a.measures,j=c?h:g;i.push($.extend({},j(b,f,d,a))),B.refreshChart()},a.hide=function(b,c,d){if("measure"===c){var e=b.GroupName===a.selectedMeasureGroup||"All"===a.selectedMeasureGroup,f=!0;a.query&&(f=_.includes(normilize(b.Name).toLowerCase(),normilize(a.query).toLowerCase()));var g=!e||!f;return g}if("dimension"===c){var e=_.indexOf(b.MeasureGroups,a.selectedMeasureGroup)!==-1||"All"===a.selectedMeasureGroup,f=!0;if(a.query){f=_.includes(normilize(b.Name),normilize(a.query));for(var h=0;h<b.Hierarchies.length&&!(f=_.includes(normilize(b.Hierarchies[h].Name).toLowerCase(),normilize(a.query).toLowerCase()));h++);}return!e||!f}if("check-name"===c){var f=!0;return a.query&&(f=_.includes(normilize(b.Name).toLowerCase(),normilize(a.query).toLowerCase())),!f}}}]),o.directive("ngChartProperties",function(){return{restrict:"AE",require:"^ngModel",scope:{ngModel:"=",dimensions:"=",measures:"=",where:"=",datasource:"=",type:"@",key:"@",apiKey:"=",isOlap:"=",relatedDatasourceList:"=",calculatedFields:"=",filterException:"=",openMenuName:"=",managementOnly:"="},templateUrl:function(a,b){var c=/key-\d+/.test(b.type);if(c)return app.urlPrefix+"dist/partial/management/charts/directives/types/customChart.html?v="+app.version;switch(b.type){case"customChart":return app.urlPrefix+"dist/partial/management/charts/directives/types/customChart.html?v="+app.version;case"bar":return app.urlPrefix+"dist/partial/management/charts/directives/types/barLine.html?v="+app.version;case"map":return app.urlPrefix+"dist/partial/management/charts/directives/types/map.html?v="+app.version;case"pie":return app.urlPrefix+"dist/partial/management/charts/directives/types/pie.html?v="+app.version;case"gauge":return app.urlPrefix+"dist/partial/management/charts/directives/types/gauge.html?v="+app.version;case"radar":return app.urlPrefix+"dist/partial/management/charts/directives/types/radar.html?v="+app.version;case"table":return app.urlPrefix+"dist/partial/management/charts/directives/types/table.html?v="+app.version;case"userControl":return app.urlPrefix+"dist/partial/management/charts/directives/types/userControl.html?v="+app.version;case"tree":return app.urlPrefix+"dist/partial/management/charts/directives/types/tree.html?v="+app.version;case"text":return app.urlPrefix+"dist/partial/management/charts/directives/types/text.html?v="+app.version;default:return app.urlPrefix+"dist/partial/management/charts/directives/types/customChart.html?v="+app.version}},controller:["$scope","$timeout","$http",function(a,b,c){a.cntrName="ngChartProperties",a.license=app.license||{},a._=_,a.changeColor=function(b,c,d){$(b.target).colorSelector(c&&c[d]?c[d]:"#1f77b4",function(e){$(b.target).css("background-color",e),a.$apply(function(){c&&(c[d]=e),a.refreshChart("refresh"),a.changeAllSeries(d,e)})})},a.refreshChart=function(b){a.$parent.refreshChart(b)},a.chagePivotFormula=function(b){a.$parent.chagePivotFormula(b)},a.setTableInfoLimit=function(b,c){a.$parent.tableInfo=a.$parent.tableInfo||{},"undefined"!=typeof b&&null!==b&&(a.$parent.tableInfo.Limit=b),"undefined"!=typeof c&&(a.$parent.tableInfo.useDistinct=c)},a.$parent.dereg&&a.$parent.dereg(),a.$parent.dereg=a.$watch("dimensions",function(b,c){if("undefined"!=typeof b){a.ngModel.tree=a.ngModel.tree||{},a.ngModel.tree.dimensions=a.ngModel.tree.dimensions||[];for(var d=0;d<b.length;d++){var e=b[d],f=_.filter(a.ngModel.tree.dimensions,{name:e.Name}).length;f||a.ngModel.tree.dimensions.push({type:0===d?"id":1===d?"parent":2===d?"name":"type",name:e.Name})}}},!0),a.changeAllSeries=function(b,c){if("{All}"===a.ngModel.selectedSeries){var d=a.ngModel[a.type].series;if(!d["{All}"])return;var e=d["{All}"][b];e=_.isUndefined(e)?c:e;for(var f in d)d[f][b]=_.isObject(e)?_.merge({},e):e,console.log("### set",f,b,e)}},c.get(app.urlPrefix+"api/forms/get").then(function(b){a.formList=b.data.list})}],link:function(){app.lang.setLang()}}}),o.directive("managementOnlyDir",function(){return{scope:{managementOnly:"="},controller:["$scope","$timeout",function(a,b){a.updateModel=function(b){a.managementOnly.notifications=b},a.render=!0,a.updateModel=function(c){a.managementOnly.notifications=c,a.render=!1,b(function(){a.render=!0},0)};var c=null;a.detail=function(b){c=b,a.chart=JSON.parse(b.detail),console.log(b,a.chart),a.chart.name=a.$parent.$parent.$parent.$parent.getChartName(a.chart.expandedChartType)},a["if"]=!0,a.$on("save-chart",function(){a["if"]=!1,b(function(){a["if"]=!0},100)}),a.restore=function(){a.managementOnly.restore(c)}}],template:'<div>                <menu-item class="">                    <menu-header style="position:relative" class="pointer">                        <div data-toggle="" href="#events">اعلان‌های سیستمی</div>                    </menu-header>                    <menu-body id="events" class="prop-section form-horizontal">                        <register-notification type="\'chart\'" onupdate="updateModel" ng-model="managementOnly.notifications" ng-if="render"></register-notification>                    </menu-body>                </menu-item>                <menu-item class="">                    <menu-header style="position:relative" class="pointer">                        <div data-toggle="" href="#events">ویرایش‌های قبلی</div>                    </menu-header>                    <menu-body id="events" class="prop-section form-horizontal">                        <versions ng-if="if" id="{{managementOnly.id}}" type="1" on-restore="restore(model)" on-detail="detail(model)" class="small"></versions>                        <div ng-show="chart" class="ui segment secondary">                             <div><b>نوع نمودار: </b>{{chart.name}}</div>                                <ul><b>شاخص‌ها</b><li ng-repeat="i in chart.measures">{{i.Name}} {{i.formula}}</li></ul>                                <ul><b>ابعاد</b><li ng-repeat="i in chart.dimensions">{{i.Name}} {{i.formula}}</li></ul>                                <div class="ui mini button" ng-click="restore()">بازنشانی</div>                           </div>                    </menu-body>                </menu-item>                </div>'}}),o.service("customChart",["$http",function(a){var b=function(b){return b?a.get(app.urlPrefix+"api/customCharts/get/"+b).then(function(a){return a.data}):a.get(app.urlPrefix+"api/customCharts/get").then(function(a){return a.data})},c=function(b){return a.get(app.urlPrefix+"api/customCharts/getSettingsTemplate/"+b).then(function(a){return a.data})},d=function(b){return a.post(app.urlPrefix+"api/customCharts/remove/"+b).then(function(a){return a.data})};return{get:b,getSettingsTemplate:c,remove:d}}]),o.directive("topMeasure",function(){return{restrict:"E",scope:{model:"=?ngModel",change:"&ngChange",dims:"=?dims"},link:function(a,b,c,d){},controller:["$scope",function(a){a.dims=a.dims||[],a.model&&(a.model.selectedDims=a.model.selectedDims||{})}],template:'                                                                                                                 <div class="form-row" layout="row" layout-align="start center" layout-wrap>                                                                 <md-switch ng-model="model.IsTop" ng-change="change()">                                                                         {{ \'isTop\' | translate }}                                                                                             </md-switch>                                                                                                            </div>                                                                                                                      <div ng-if="model.IsTop">                                                                                                       <div class="form-row" layout="row" layout-align="start center">                                                                 <label>{{ \'top\' | translate }}</label>                                                                                    <span class="form-divider" flex></span>                                                                                     <div>                                                                                                                           <md-switch ng-model="model.IsPercent" ng-change="change()" style="display:inline">                                              {{ \'IsPercent\' | translate }}                                                                                         </md-switch>                                                                                                                                                                                                                                            <input type="number" class="form-control" placeholder="{{ \'top\' | translate }}"                                                  ng-model-options="{ updateOn: \'blur\' }"                                                                                   ng-change="change()"                                                                                                        ng-model="model.Top" />                                                                                                                                                                                                                          <select class="selectpicker form-control"                                                                                           ng-model="model.TopOrder"                                                                                                   ng-change="change()"                                ng-options="color.name as  color.value for color in [                                    {name:\'DESC\', value: \'نزولی\'  },                                     {name:\'ASC\', value: \'صعودی\'  },                                     ]">                                                                                               </select>                                                                                                               </div>                                                                                                                  </div>                                                                                                                      <div class="form-row" layout="row" layout-align="start center">                                                                 <label>{{ \'Applied_to\' | translate }}</label>                                                                             <span class="form-divider" flex></span>                    <div>                                                                                                                           <md-checkbox ng-repeat="d in dims track by $index" ng-model="model.selectedDims[d.Name]" ng-change="change()">{{d.Name}}</md-checkbox>                       </div>                                                                                                                  </div>                                                                                                                  </div>                                                                                                                      '
}})}();var ngApp=angular.module("management");ngApp.controller("chartsListCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$translate","utils","datasources","toolbar","$q",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(b){var c=new Date;a.progress=!1,a.allData=b.data.list,a.securityCertPatch=b.data.securityCertPatch,a.pageCount=40,a.page=1,a.maxPage=Math.ceil(a.allData.length/a.pageCount),a.setPage=function(b){a.page=b,a.data=a.allData.slice((a.page-1)*a.pageCount,a.page*a.pageCount)},a.setPage(1),i("لیست نمودارها").then(function(c){a.listTranslate=c,b.data.path.unshift({name:c,id:null}),a.path=b.data.path.map(function(b){return b.click=function(){a["goto"]({type:1,id:b.id})},b}),l.setTitles(a.path)}),h(function(){console.log("Process time: "+(new Date-c))},0)}function o(){return _.map(_.filter(a.data,{select:!0}),function(a){return 2===a.type?"ChartId-"+a.id:"PackageId-"+a.id})}function p(b){var c=_.lastIndexOf(a.data.map(function(a){return a.type}),1);c==-1?a.data=b.concat(a.data):Array.prototype.splice.apply(a.data,[c+1,0].concat(b))}function q(a){j.showErrorToast(a.data.desc)}function r(b){a.data=_.filter(a.data,function(a){var c=2==a.type?"ChartId-"+a.id:"PackageId-"+a.id;return b.indexOf(c)==-1})}a.utils=j;var s="undefined"!=typeof e.id?e.id:0;a.app=app,a._=_;var t=m.defer(),u=s?"?packageId="+s:"";a.progress=!0,b.get(app.urlPrefix+"api/charts/getList"+u,{timeout:t.promise}).then(function(a){n(a)},q),j.onError(function(b){a.error=b,a.progress=!1}),i("لیست نمودارها").then(function(b){a.listTranslate=b});var v=function(){return _.some(a.data,{select:!0})};a.menuInvalidate=function(){var b=v(),c=_.filter(a.data,{select:!0,type:1}).length,d=_.filter(a.data,{select:!0,type:2}).length;a.canCopy=b,a.canDelete=b,a.canForward=b,a.canExport=b,a.canDirEdit=1==c&&0==d},a.copy=function(){var d=app.urlPrefix+"api/Charts/CloneCharts",e=o();b.post(d,e).then(function(b){if(b.data.result){if(b.data.inserted){var d=_.findIndex(a.data,{type:2});a.data.splice.apply(a.data,[d,0].concat(b.data.inserted))}b.data.packages&&p(b.data.packages);var e=c.simple().textContent("کپی انجام شد");c.show(e)}},q)},a["delete"]=function(e){var f=app.urlPrefix+"api/Charts/DeleteCharts",g=o(),h=d.confirm().title("حذف برای همیشه؟").textContent(g.length+" مورد برای حذف انتخاب شده است").ariaLabel("حذف").targetEvent(e).ok("حذف!").cancel("لغو");d.show(h).then(function(){b.post(f,g).then(function(b){if(b.data.result){b.data.deletedIds&&r(b.data.deletedIds);var d=c.simple().textContent("حذف انجام شد");c.show(d),a.menuInvalidate()}},q)})},a.forward=function(a){k.select(a,{type:["charts"],justDir:!0,selectableDir:!0,multipleChart:!1}).then(function(a){var d=a.selected[0];if(e.id==d.id){var f=c.simple().textContent("موارد انتخاب شده در همین پوشه هستند");return void c.show(f)}var g=o();b.post(app.urlPrefix+"api/Charts/MoveToPackage",{Ids:g,packageId:d.id}).then(function(a){r(a.data.ids);var b=c.simple().textContent("انتقال انجام شد");c.show(b)},q)},q)},a.dirEdit=function(b){var d=o(),e=d[0].replace("PackageId-","");g.edit(b,2,e,function(b){_.find(a.data,{select:!0}).name=b.data.info.Name;var d=c.simple().textContent("نام پوشه تغییر کرد");c.show(d)},q)},a.newPackage=function(a){g.create(a,1,e.id,function(a){p([{id:a.data.info.Id,name:a.data.info.Name,type:1}]);var b=c.simple().textContent("پوشه جدید ایجاد شد");c.show(b),k.reset()})},a["goto"]=function(a,b){1==a.type?f.path("charts"+(a.id?"/"+a.id:"")):2==a.type&&f.path("charts/edit/"+s+"/"+a.id)},a.getTypeName=function(a){var b=1,c=2,d=3,e=5,f=6,g=7,h=8,i=9,j="";switch(+a){case b:j="Bar";break;case c:j="Pie";break;case d:j="Line";break;case e:j="Table";break;case f:j="Map";break;case g:j="User Control";break;case h:j="Radar";break;case i:j="Tree"}return j},a.getChartTypeImage=function(a){var b="",c={};switch(c.BAR=1,c.PIE=2,c.LINE=3,c.GAUGE=4,c.TABLE=5,c.MAP=6,c.USER_CONTROL=7,c.RADAR=8,c.TREE=9,+a){case c.BAR:b=app.urlPrefix+"Images/bar.png";break;case c.GAUGE:b=app.urlPrefix+"Images/guage.png";break;case c.PIE:b=app.urlPrefix+"Images/pie.png";break;case c.LINE:b=app.urlPrefix+"Images/line.png";break;case c.TABLE:b=app.urlPrefix+"Images/table.png";break;case c.MAP:b=app.urlPrefix+"Images/map.png";break;case c.USER_CONTROL:b=app.urlPrefix+"Images/combo_box.png";break;case c.RADAR:b=app.urlPrefix+"Images/radar_plot.png";break;case c.TREE:b=app.urlPrefix+"Images/tree.png"}return b};var w;a.$watch("search",function(){h.cancel(w),w=h(function(){"undefined"!=typeof a.search&&(a.progress=!0,null!==t&&t.resolve(),t=m.defer(),b.get(app.urlPrefix+"api/charts/getList?q="+a.search,{timeout:t.promise}).then(function(a){n(a)},q))},400)}),a.selectAll=function(){a.data&&_.forEach(a.data,function(b){b.select=a.selectAllCheckbox}),a.menuInvalidate()},a.newChart=function(a){k.select(a,{type:["charts","datasources"]}).then(function(a){"charts"==a.type?(k.lastSelected.charts=a.selected,f.path("charts/new/combo-kpi/"+(e.id?e.id:"0"))):f.path("charts/new/normal/"+(e.id?e.id:"0")+"/"+a.selected[0].id)})},a.sortDetail={},a.sort=function(b){a.sortDetail[b]=a.sortDetail[b]||{},a.sortDetail[b].isDesc=!a.sortDetail[b].isDesc;var c=_.filter(a.data,{type:1}),d=_.filter(a.data,{type:2});d=_.sortBy(d,[b]),c=_.sortBy(c,[b]),a.sortDetail[b].isDesc||(d=_.reverse(d),c=_.reverse(c)),a.data=c.concat(d)},a["export"]=function(){var c=o(),d=_.filter(a.data,{select:!0,type:2}).map(function(a){return a.id});console.log(c,d),b.post(app.urlPrefix+"api/Charts/export",d).then(function(a){console.log(a.data);var b=new Blob([a.data],{type:"text/plain;charset=utf-8;"});saveAs(b,"thing.txt")})}}]),function(a){var b=angular.module("management");b.directive("alert",["$timeout","$http","datasources",function(b,c,d){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/alert.html?v="+app.version,scope:{model:"=prop",config:"="},controller:["$scope","$sce",function(e,f){e.name="ALERT_CONTROLLER",e.s=f,e.alertTypes=[{name:"sms",value:"پیام کوتاه"},{name:"email",value:"پست الکترونیک"}],app.license.telegram&&e.alertTypes.push({name:"telegram",value:"تلگرام"}),e.contactList=[{phone:"",email:""}],e.roleList=null,e.userList=null,e.schedule={occure:"daily",dailyRecurs:1,weeklyRecurs:1,weeklySat:!1,weeklySun:!1,weeklyMon:!1,weeklyTus:!1,weeklyWen:!1,weeklyThu:!1,weeklyFri:!1,monthlyDayOf:1,monthlyRecurs:1,dailyFrequency:"once",dailyFrequencyAtHour:"1200",dailyFrequencyRecur:1,dailyFrequencyRecurType:"hour",dailyFrequencyStart:"1200",dailyFrequencyStop:"2359"},e.getPreview=function(a,b){console.log("### alertx c",a);var d=e.$parent.$parent.$parent.$parent.id;return 0==+d?void a("ابتدا باید نمودار را ذخیره کنید"):(a.previewProgress=!0,void c.post(app.urlPrefix+"api/Alert/preview",{id:d,alert:a,isPreview:b}).then(function(b){a.previewProgress=!1,a.preview=b.data})["catch"](function(b){a.previewProgress=!1,a.preview={result:!1,message:b.data}}))},e.selectDatasource=function(a,b){d.select(a,{type:["datasources"]}).then(function(a){b.error=null,b.selectedDatasource=a.selected[0],b.selectedDatasourceId=a.selected[0].id,b.datasourceCaptionsColumn=[],e.getColumns(b)})},e.getColumns=function(a){d.getColumns(a.selectedDatasource.id).then(function(b){a.getInfoProgress=!1,a.datasourceColumns=b.CubeInfo.Dimensions[0].Hierarchies,a.userProperties=b.UsersProperty},function(b){a.error=b})},e.newAlert=function(){e.model[e.config.name].alerts.push({type:"sms",body:"@{name}\n@{update-time}\n@{content}\n@{filters}",rules:[{}],schedule:_.merge({},e.schedule),format:"[@{k} :: ][, ][@{m}: @{n}]",selectedSeries:[],contactType:"role"}),b(function(){app.lang.setLang()},0)},e.formatClock=function(a){var b=a+"";return b.substr(0,2)+":"+b.substr(2)},e.model[e.config.name]&&(e.model[e.config.name].alerts=a.extend([],e.model[e.config.name].alerts)),e.addContact=function(a){a.contactList||(a.contactList=[{email:"",phone:""}]),0==a.contactList.length&&(a.contactList=[{email:"",phone:""}]),e.contactList=a.contactList},e.addSchedule=function(a){a.schedule||(a.schedule={occure:"daily",dailyRecurs:1,weeklyRecurs:1,weeklySat:!1,weeklySun:!1,weeklyMon:!1,weeklyTus:!1,weeklyWen:!1,weeklyThu:!1,weeklyFri:!1,monthlyDayOf:1,monthlyRecurs:1,dailyFrequency:"once",dailyFrequencyAtHour:"1200",dailyFrequencyRecur:1,dailyFrequencyRecurType:"hour",dailyFrequencyStart:"1200",dailyFrequencyStop:"2359"}),e.schedule=a.schedule},e.addUser=function(a){function b(){a.userList&&0!=a.userList.length||(a.userList=e.serverUserList.map(function(a){return{name:a.name,id:a.id,username:a.username}})),e.userList=a.userList}e.serverUserList?b():c.get(app.urlPrefix+"Account/GetUsers").then(function(a){e.serverUserList=a.data.list,b()})},e.addRole=function(a){function b(){a.roleList&&0!=a.roleList.length||(a.roleList=e.serverRoleList.map(function(a){return{name:a.name,id:a.id}})),e.roleList=a.roleList}e.serverRoleList?b():c.get(app.urlPrefix+"Account/GetRoles").then(function(a){e.serverRoleList=a.data.list,b()})},e.changeItem=function(c,d){var f=a.extend({},c.rules[d]);app.indicator(e.model.series,f,function(a,e){b(function(){c.rules[d]=a},0)},[])},e.toggleSelectedSeries=function(a,b){a.selectedSeries||(a.selectedSeries=[]);var c=a.selectedSeries.indexOf(b);c==-1?a.selectedSeries.push(b):a.selectedSeries.splice(c,1)},e.persian=function(a){return persian(a)},e.mapOp={1:"برابر باشد با",2:"برابر نباشد با",3:"بزرگتر باشد از",4:"بزرگتر يا مساوي باشد از",5:"کوچکتر باشد از",6:"کوچکتر يا مساوي باشد از",7:"شامل",8:"نباشد شامل"}}],link:function(){app.lang.setLang()}}}])}(jQuery),function(a){var b=angular.module("management");b.filter("filterCalculateFields",function(){return function(a,b){for(var c=[],d=0;d<a.length;d++)d<b&&c.push(a[d]);return c}}),b.directive("calculateFields",function(){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/calculateField.html?v="+Math.random(),scope:{calculatedFields:"="},controller:["$scope","$mdDialog","$mdMedia",function(b,c,d){b.refreshChart=function(a){b.$parent.refreshChart(a)};var e=-1;b.add=function(a){e=-1,b.currentFormula={},b.showDialog(a)},b.edit=function(a,c){e=a,b.currentFormula={name:b.calculatedFields.fields[a].name,formula:b.calculatedFields.fields[a].formula},b.showDialog(c)},b.calculatedFields=b.calculatedFields||{},b.calculatedFields.fields=b.calculatedFields.fields||[],b.save=function(){if(!b.currentFormula.name)return alert("فیلد نام نمی تواند خالی باشد"),!1;var a=_.some(b.calculatedFields.fields,function(a){return a.name.trim()==b.currentFormula.name.trim()})||_.some(b.$parent.ngModel.series,function(a){return a.trim()==b.currentFormula.name.trim()});return!a||e!=-1&&b.calculatedFields.fields[e].name==b.currentFormula.name?(e==-1?b.calculatedFields.fields.push({name:b.currentFormula.name,formula:b.currentFormula.formula}):(b.calculatedFields.fields[e].name=b.currentFormula.name,b.calculatedFields.fields[e].formula=b.currentFormula.formula),!0):(alert("نام انتخابی تکراری است"),!1)},b.showDialog=function(e){c.show({controller:["$scope","$mdDialog",function(c,d){c.parent=b,c.cancel=function(){d.cancel()},c.save=function(){c.parent.save()&&(c.parent.refreshChart(),d.cancel())},c.addColumn=function(b,d){c.parent.currentFormula.formula||(c.parent.currentFormula.formula=""),c.parent.currentFormula.formula+=" {R+0, ["+b+"]} ",a(".formula-input").focus()}}],templateUrl:"editor/calc/calc-fields-modal.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0,fullscreen:d("sm")||d("xs")})}}],link:function(){app.lang.setLang()}}})}(jQuery),function(a){var b=angular.module("management");b.directive("dimMeasWhere",function(){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/dimMeasWhere.html?v="+app.version,scope:{dimensions:"=",measures:"=",where:"=",datasource:"=",model:"=?model"},controller:["$scope","$mdDialog","$mdMedia","$timeout",function(a,b,c,d){a.model=a.model||{},a.model.selectedDimension=0,a.model.selectedMeasure=0,a.model.selectedwhere=0,a.tConfig={format:!0,font:!1,bold:!1,size:!1,color:!1,align:!1},a.addFormula=function(a){a.formulas=a.formulas||[],a.formulas.push({})},a.changeFormula=function(a){a.members=null},a.change=function(){d(function(){a.$parent.refreshChart()},1)},a.addLabel=function(){a.dimensions[a.model.selectedDimension].detail.histogramCategory.customLabels.push({name:""})},a.refreshChart=function(b){a.$parent.refreshChart(b)},a.$watch("datasource",function(b){b&&(a.dimentionWithNone=[{UniqueName:"NONE",Name:"خودش"},{UniqueName:"CUSTOM_FORMULA",Name:"سفارشی ..."}].concat(b.CubeInfo.Dimensions[0].Hierarchies))},!0),a.changeDimensionName=function(b,c){var d=c.Name,e=a.dimensions.concat(a.measures).concat(a.where).map(function(a){return a.Name})||[],f=e.filter(function(a){return a===d}).length>1;f?(c.Name=b,setTimeout(function(){alert("نام انتخاب شده تکراری است")},0)):a.refreshChart()},a.changeMeasureAggregation=function(b){var c=a.measures[+b].aggregation,d=a.measures[+b],e=d.Formula?d.Formula:d.UniqueName;"NONE"==c?d.formula=e:d.formula=c+"("+e+")",a.changeFormula(a.measures[+b])},a.showDialog=function(c,d,e){var f=c;b.show({controller:["$scope","$mdDialog",function(b,d){function g(a,c){a.renderer.setPadding(18),i=a.getSession(),b.insertFormula=function(b){a.insert(b),a.focus()}}b.parent=a;var h;switch(c){case"dimention":b.formula=a.dimensions[a.model.selectedDimension].formula;break;case"measure":b.formula=e.formula,h=e;break;case"where":b.formula=a.where[a.model.selectedwhere].formula}b.aceOption={useWrapMode:!0,showGutter:!1,theme:"sqlserver",mode:"sqlserver",maxLines:14,onLoad:g,require:["ace/ext/beautify"]};var i;b.aceOption.onChange=function(a){b.formula=i.getValue()},b.cancel=function(){d.cancel()},b.save=function(){switch(f){case"dimention":a.dimensions[a.model.selectedDimension].formula=b.formula;break;case"measure":h.formula=b.formula;break;case"where":a.where[a.model.selectedwhere].formula=b.formula}d.cancel()}}],templateUrl:"editor/formula/edit.html",parent:angular.element(document.body),targetEvent:d,clickOutsideToClose:!1,fullscreen:!0})}}],link:function(){app.lang.setLang()}}})}(jQuery),function(a){var b=angular.module("management");b.directive("filterExcept",function(){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/filterExcept.html?v="+app.version,scope:{datasource:"=",filterException:"="},controller:["$scope","$mdDialog","$mdMedia",function(a,b,c){a.refreshChart=function(b){a.$parent.refreshChart(b)},a.toggleAllToList=function(b){a.filterException.allFields=a.filterException.allFields||[];var c=a.filterException.allFields.indexOf(b.UniqueName);c!=-1?a.filterException.allFields.splice(c,1):(a.filterException.allFields.push(b.UniqueName),a.filterException.fields=_.reject(a.filterException.fields,function(a){var c="\\[id"+b.UniqueName+"\\]";return new RegExp(c).test(a.UniqueName)}))},a.toggleToList=function(b){a.filterException.fields=a.filterException.fields||[];var c=_.filter(a.filterException.fields,{Name:b.Name,UniqueName:b.UniqueName});c.length?c.forEach(function(b){a.filterException.fields.splice(_.indexOf(a.filterException.fields,b),1)}):a.filterException.fields.push({Name:b.Name,UniqueName:b.UniqueName})},a.isInList=function(b){return _.filter(a.filterException.fields,{UniqueName:b.Name,UniqueName:b.UniqueName}).length},a.getDatasourceName=function(b){var c=_.find(a.datasource.CubeInfo.Dimensions,function(a){return a.UniqueName==b});return c?c.Name.replace(/as id\d+/gi,""):""},a.showDialog=function(d){b.show({controller:["$scope","$mdDialog",function(b,c){b.parent=a,b.cancel=function(){c.cancel()}}],templateUrl:"editor/filter-except/select-except-modal.html",parent:angular.element(document.body),targetEvent:d,clickOutsideToClose:!1,fullscreen:c("sm")||c("xs")})}}],link:function(){app.lang.setLang()}}})}(jQuery),function(a){var b=angular.module("management");b.service("myService",["$http",function(a){var b=null;this.getMenus=function(){return null==b&&(b=a.get(app.urlPrefix+"api/menus/get")),b}}]),b.factory("myFactory",function(){return{sayHello:function(a){return"Hi "+a+"!"}}}),b.directive("generalSettings",["myService","myFactory",function(a,b){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/generalSettings.html?v="+app.version,scope:{apiKey:"=",model:"=ngModel",props:"=",change:"&ngChange"},controller:["$scope",function(b){b.menus=[],b.ff=function(){b.change()},b.license=app.license,b.model.exportApiParams=b.model.exportApiParams||[{columns:[{}]}],b.prefix=window.location.origin+app.urlPrefix,a.getMenus().then(function(a){var c=a.data;0===c.filter(function(a){return+a.id===-1}).length,b.menus=c},function(){b.error="خطا در دریافت اطلاعات"})}],link:function(){app.lang.setLang()}}}]),b.directive("selectKpi",[function(){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/selectKpi.html?v="+app.version,scope:{model:"=ngModel",change:"&ngChange"},controller:["$scope",function(a){a.addExtraKpi=function(){a.model.extraKpi.push({})},a.removeExtraKpi=function(b){a.model.extraKpi.splice(b,1)}}],link:function(b,c,d){app.lang.setLang(),a(c).find(".ui.button.font-popup").popup({popup:a(c).find(".ui.popup"),transition:"scale",on:"click"})}}}])}(jQuery),function(a){var b=angular.module("management");b.directive("globalVariable",function(){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/globalVariable.html?v="+app.version,scope:{dimensions:"=",measures:"=",prop:"="},controller:["$scope",function(a){}],link:function(){app.lang.setLang()}}})}(jQuery),function(a){var b=angular.module("management");b.directive("numberFormat",function(){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/numberFormat.html?v="+app.version,scope:{model:"=ngModel"},controller:["$scope",function(b){b.model=a.extend({formatString:",.2f",formatStringCustom:",.2f"},b.model),b.refreshChart=function(a){b.$parent.refreshChart(a)}}],link:function(){app.lang.setLang()}}})}(jQuery),function(a){var b=angular.module("management");b.directive("textEditor",function(){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/textEditor.html?v="+app.version+new Date,scope:{model:"=prop",onChange:"&?","default":"=?",config:"=?"},controller:["$scope",function(a){a.config=_.merge({format:!0,bold:!0,size:!0,font:!0,color:!0,align:!0,rotate:!1,anchor:!1,position:!1},a.config),a.model=_.merge({bold:!1,color:"#333333",align:"right",italic:!1,fontSize:"12px",fontName:"IRANSans",formatString:",.2f",formatStringCustom:",.2f",rotate:0,anchor:"end",position:"end"},a["default"]||{},a.model),a.change=function(){console.log("formatString",a.model.formatString),a.onChange()}}],link:function(b,c,d){app.lang.setLang(),a(c).find(".ui.button.font-popup").popup({popup:a(c).find(".ui.popup"),transition:"scale",on:"click"})}}})}(jQuery),function(a){var b=angular.module("management");b.directive("generalCustomControl",function(){return{templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/generalControl.html?v="+app.version,scope:{parent:"=?",item:"=?",change:"&?"},controller:["$scope",function(a){a.onchange=function(b){if(a.item.onchange){var c=b||a.parent[a.item.key];a.item.onchange(c,a.parent,a.item)}a.change()}}]}})}(jQuery),function(a){var b=angular.module("management");b.directive("dimentionColorSelector",function(){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/dimentionColorSelector.html?v="+app.version,scope:{model:"=ngModel",dimColor:"=",ngChange:"&?"},controller:["$scope","$timeout",function(a,b){a.model=a.model||{enable:!1,palette:"1",data:{}},a.colorSet=function(b){var c=d3.scaleOrdinal(d3.schemeCategory10);switch(+a.model.palette){case 2:c=d3.scaleOrdinal(d3.schemeBrBG[11]);break;case 3:c=d3.scaleOrdinal(d3.schemePuOr[11]);break;case 4:c=d3.scaleOrdinal(d3.schemeRdGy[11])}var d=0;_.each(a.model.data,function(a){a.color&&!b||(a.color=c(d)),d++})},a.$watch("dimColor",function(b){if(_.isObject(a.model)||(a.model={}),a.model=a.model||{enable:!1,palette:"1"},a.model.data=a.model.data||{},b)for(var c in b)a.model.data[c]=a.model.data[c]||b[c];a.colorSet(!1)},!0),a.clear=function(){a.model.data={},a.dimColor={},a.ngChange()}}]}})}(jQuery),function(a){var b=angular.module("management");b.directive("mapSelector",["$timeout",function(b){return{restrict:"E",scope:{model:"=prop"},controller:["$scope","$http","$mdDialog","$mdMedia",function(b,c,d,e){b.model=a.extend({selectedMap:"1"},b.model),b.refreshList=function(){b.list=null,b.getList()},b.getList=function(){b.list||c.get(app.urlPrefix+"api/Map/GetList").then(function(a){a.data.result&&(b.list=a.data.list)})},b.getList(),b.showUploadDialog=function(c){d.show({controller:["$scope","$mdDialog","$timeout","$mdToast",function(c,d,e,f){c.parent=b,c.cancel=function(){d.cancel()},c.selectFile=function(){a("#file-upload[type=file]").click()},c.upload=function(){function b(){e(function(){var a=f.simple().textContent("آپلود ناموفق بود");f.show(a)},0)}if(!c.name||!c.file){var g=f.simple().textContent("نام و فایل نقشه را وارد کنید");return void f.show(g)}var h=new FormData;h.append("file",c.file),h.append("name",c.name);var i=new XMLHttpRequest;i.onreadystatechange=function(){4===i.readyState&&e(function(){var a=JSON.parse(i.response);console.log("map data",a),c.parent.list.push({id:a.id,name:a.name})},0)},i.upload.addEventListener("load",function(){e(function(){d.cancel();var a=f.simple().textContent("آپلود با موفقیت انجام شد");f.show(a)},0)}),i.upload.addEventListener("error",b),i.upload.addEventListener("abort",b),i.open("POST",app.urlPrefix+"api/Map/Upload");var j=a("input[name=__RequestVerificationToken]").val();i.setRequestHeader("__RequestVerificationToken",j),i.send(h)},c.d3=d3}],templateUrl:"editor/map/upload-map.html",parent:angular.element(document.body),targetEvent:c,clickOutsideToClose:!0,fullscreen:e("sm")||e("xs")})},b.showEditDialog=function(a){d.show({controller:["$scope","$mdDialog","$timeout","$mdToast",function(a,d,e,f){a.parent=b,a.cancel=function(){d.cancel()},a.remove=function(b,d){var e=confirm("آیا برای حذف اطمینان دارید؟");e&&(b.progressRemove=!0,c.post(app.urlPrefix+"api/Map/remove/"+b.id).then(function(c){b.progressRemove=!1,a.parent.list.splice(d,1)})["catch"](function(){b.progressRemove=!1,alert("عملیات ناموفق")}))},a.edit=function(a,b){a.progressEdit=!0,c.post(app.urlPrefix+"api/Map/edit",a).then(function(b){a.progressEdit=!1,a.change=!1})["catch"](function(){a.progressEdit=!1,alert("عملیات ناموفق")})}}],templateUrl:"editor/map/edit-map.html",parent:angular.element(document.body),targetEvent:a,clickOutsideToClose:!0,fullscreen:e("sm")||e("xs")})}}],templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/types/mapSelector.html?v="+app.version}}])}(jQuery),function(a){var b=angular.module("management");b.directive("tableIndicator",["$timeout",function(a){return{restrict:"E",scope:{prop:"=",dimensions:"=",measures:"=",config:"="},controller:["$scope","$http",function(a,b){a.prop[a.config.name]&&(a.prop[a.config.name].indicator=a.prop[a.config.name].indicator||[],a.model=a.prop[a.config.name].indicator,a.change=function(){a.$parent.refreshChart("refresh")},a.changeItem=function(a){},a.copy=function(a,b){var c=angular.copy(a[b]);a.splice(b,0,c)})}],link:function(){app.lang.setLang()},templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/types/tableIndicator.html?v="+app.version}}])}(jQuery),function(a){var b=angular.module("management");b.directive("userControlVariableRelation",["$timeout",function(b){return{restrict:"E",scope:{prop:"=",dimensions:"=",measures:"=",type:"="},controller:["$scope","$http",function(a,c){a.$parent.dereg&&a.$parent.dereg(),a.$parent.mdereg&&a.$parent.mdereg(),a.$parent.dereg=a.$watch("dimensions",function(b,c){a.prop[a.type].info.dimensions=a.dimensions},!0),a.$parent.mdereg=a.$watch("measures",function(b,c){a.prop[a.type].info.measures=a.measures},!0),a.list||c.get(app.urlPrefix+"api/GlobalVariable/GetList").then(function(b){b.data.unshift({Id:"-1",Name:"NONE"}),a.list=b.data}),a.AddGlobalVariables=function(){app.globalVariableHelper.AddGlobalVariables(function(c){b(function(){a.list.push({Id:c.Id,Name:c.Name}),a.prop[a.type].info.variableId=c.Id+""},0)})}}],templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/types/variableRelation.html?v="+app.version,link:function(c,d,e){var f=e.selector;angular.element(a(f)).bind("default-value",function(a,d,e,f,g){b(function(){c.prop[c.type].info.variableDefault={values:e,type:f,valuesCaption:g}},0)}),app.lang.setLang()}}}])}(jQuery);var ngApp=angular.module("management");ngApp.controller("datasourcefileCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$window","$sce","datasources",function(a,b,c,d,e,f,g,h,i,j,k){function l(b){a.error=j.trustAsHtml(filterXSS("<b>"+b.data.title+"</b> <br/>"+b.data.desc))}function m(a){c.show({template:'<md-toast class="md-toast error"> <span class="md-toast-text" flex>'+a+"</span></md-toast>",hideDelay:3e3,position:"bottom left"})}function n(b){a.sheets=b.result.list,a.savedFileName=b.result.savedFileName,a.filename=b.result.filename,a.sheetName=a.sheets[0],a.changeSheet()}function o(b){var c="",d=_.map(b,function(a,b){return"<tr>"+_.map(a,function(a){return 0===b?"<th>"+filterXSS(a)+"</th>":"<td>"+filterXSS(a)+"</td>"}).join("")+"</tr>"}).join("");c='<table class="table">'+d+"</table>",a.testResult=j.trustAsHtml(c)}function p(){var a=$("#main-form").width();$("#testResult").css("max-width",a+"px"),$("#testResult").css("overflow","auto")}a.app=app;var q={MsOlap:1,MSSQL:2,MySQL:3,File:4,WebResource:5,JoinDatasource:6};a.license=app.license;var r="undefined"!=typeof e.packageId?e.packageId:0,s="undefined"!=typeof e.id?e.id:0,t=(e.type,s>0);a.isEdit=t,a.id=s;var u=!1;t&&(b.get(app.urlPrefix+"api/datasources/GetInfo?type="+q.File+"&id="+s).then(function(b){a.name=b.data.name,a.modelType=b.data.modelType,a.keepHistory=b.data.keepHistory,u=b.data.keepHistory,a.metainfo=b.data.metainfo,a.sign=b.data.sign,a.tableName=b.data.tableName},l),b.get(app.urlPrefix+"api/Excel/Sample?id="+s).then(function(a){a.data?o(a.data):($("#queryResult").html(""),$("#test-result").removeClass().addClass("alert alert-danger").show().find("span").html("اشکال در دریافت اطلاعات").append('<p style="text-align: left;margin-top:7px;">'+filterXSS(a.error)+"</p>"))},l)),a.save=function(){if(a.error=null,!a.fileForm.$valid)return void m("فیلدهای ضروری باید پر شوند");a.testResult=null;var d=_.filter(a.roles,{check:!0}).map(function(a){return a.action+"-"+a.id});if(!a.keepHistory&&u){var e=confirm("در صورت ذخیره منبع داده، با توجه به عدم انتخاب گزینه نگهداری تاریخچه، رکوردهای قبلی پاک می‌شوند. آیا برای ادامه اطمینان دارید؟");if(!e)return}b.post(app.urlPrefix+"api/Excel/save",{SheetName:a.sheetName,savedFileName:a.savedFileName,filename:a.filename,DataSourceName:a.name,KeepHistory:a.keepHistory,Id:s,type:a.extention,PackageId:r,RolesActions:d,ModelType:a.modelType,metainfo:a.metainfo,AceProvider:a.aceProvider}).then(function(a){function b(){window.history.length<=2?f.path("/datasources/"+r):window.history.back()}var d=c.simple().textContent(t?"تغییرات ثبت شد":"منبع داده جدید ایجاد شد");c.show(d),b(),k.reset()},l)},a.extention="XLS",a.aceProvider="12",a.progress=-1,a.changeSheet=function(){b.get(app.urlPrefix+"api/Excel/data?file="+a.savedFileName+"&name="+a.filename+"&sheetName="+encodeURIComponent(a.sheetName)+"&AceProvider="+a.aceProvider).then(function(b){b.data?o(b.data):a.error=j.trustAsHtml("اشکال در دریافت اطلاعات")})},$("#input-file-id").fileupload({dataType:"json",url:app.urlPrefix+"api/Excel/UploadFiles",autoUpload:!1,done:function(a,b){h(function(){switch(b.formData.type){case"XLS":n(b);break;case"CSV":o(b.result);break;case"XML":}},0)},add:function(b,c){h(function(){a.uploadData=c,a.fileName=j.trustAsHtml(filterXSS(c.files[0].name+"<br><sub><b>حجم:</b> "+(c.files[0].size/1024).toFixed(2)+" KB</sub>"));var b=c.files[0].name.match(/\.[^.]+$/);if(null!==b){var d=b[0];".xlsx"!==d&&"xls"!==d||(a.extention="XLS"),".csv"===d&&(a.extention="CSV"),".xml"===d&&(a.extention="XML")}},0)},error:function(b,c){h(function(){a.error=j.trustAsHtml(filterXSS('<div class="ltr"><b>'+b.responseJSON.title+"</b> <br/>"+b.responseJSON.desc+"</div>"))},0)}}).on("fileuploadprogressall",function(b,c){var d=parseInt(c.loaded/c.total*100,10);h(function(){a.progress=d},0)}),a.uploadData,a.upload=function(){a.error=null,a.testResult=null,a.uploadData.formData={type:a.extention,aceProvider:a.aceProvider},a.uploadData.submit(),a.progress=0,p()}}]);var ngApp=angular.module("management"),ngApp=angular.module("management");ngApp.service("interRelation",["$http",function(a){var b,c=function(){return b=a.get(app.urlPrefix+"api/datasourceInterRelation/get")};return{get:c,reset:function(){b=null}}}]),ngApp.controller("interRelationCtrl",["$scope","$http","$mdToast","$mdDialog","$translate","interRelation","$mdMedia","utils","toolbar",function(a,b,c,d,e,f,g,h,i){function j(b){d.show({controller:["$scope","$mdDialog","$timeout",function(b,c,d){b.parent=a,b.cancel=function(){c.cancel()},b.parent.cancel=b.cancel,b.change=function(a,b){}}],parent:angular.element(document.body),targetEvent:b,clickOutsideToClose:!0,fullscreen:g("sm")||g("xs"),templateUrl:"datasourceRelation/add-relation.html"})}a.utils=h,e("interRelation").then(function(a){i.setTitles([{name:a,click:null}])}),a.progress=!0,f.get().then(function(b){a.progress=!1,a.data=b.data.list.map(function(a){var b=JSON.parse(a.data);return b.conditions.forEach(function(a){if("string"==typeof a.left){var b=a.left;a.left={column:b,isText:!1,formula:null},a.op="="}if("string"==typeof a.right){var b=a.right;a.right={column:b,isText:!1,formula:null}}}),b.id=a.id,b}),a.getList(function(){a.modalRelationObject={conditions:[{}],left:-1,right:-1}})}),a.modalRelationObject={conditions:[{}],left:0,right:0},a.$watch("modalRelationObject",function(a,b){console.log(a,b)},!0),a.datasourceChange=function(){console.log("setSelected")};var k=!0;a.getList=function(c){k?(k=!1,b.get(app.urlPrefix+"api/JoinDataSource/GetDatasourceList").then(function(b){a.datasourceList=b.data,c&&c()})):c&&c()},a.add=function(c){return 0==a.modalRelationObject.conditions.length?(alert("حداقل یک رابطه تعریف کنید"),!1):(a.modalRelationObject.name=a.datasourceList.filter(function(b){return+a.modalRelationObject.left==b.Id})[0].Name+" - "+a.datasourceList.filter(function(b){return+a.modalRelationObject.right==b.Id})[0].Name,a.addProgress=!0,a.error=null,void b.post(app.urlPrefix+"api/DatasourceInterRelation/Save",JSON.stringify(a.modalRelationObject),{headers:{"Content-Type":"application/json; charset=utf-8"}}).then(function(b){a.addProgress=!1;var c=b.data;if(c.result){if(a.modalRelationObject.id){var d=a.data.filter(function(b){return b.id===a.modalRelationObject.id})[0];d=angular.extend({},a.modalRelationObject)}else a.modalRelationObject.id=c.id,a.data.splice(a.data.length,0,a.modalRelationObject);a.cancel()}else a.error=$sce.trustAsHtml(filterXSS(c.message))})["catch"](function(b){a.addProgress=!1,a.error=$sce.trustAsHtml(filterXSS(b.data.title))}))},a.cancel=function(){},a["new"]=function(b){a.modalRelationObject={conditions:[{op:"="}],left:0,right:0},j(b)},a.edit=function(b,c){a.modalRelationObject=c,j(b)},a["delete"]=function(e){var f=app.urlPrefix+"api/DatasourceInterRelation/Delete",g=_.filter(a.data,{select:!0}).map(function(a){return a.id}),h=d.confirm().title("حذف برای همیشه؟").textContent(g.length+" مورد برای حذف انتخاب شده است").ariaLabel("حذف").targetEvent(e).ok("حذف!").cancel("لغو");d.show(h).then(function(){b.post(f,g).then(function(b){if(b.data.deleted&&(a.data=_.filter(a.data,function(a){return b.data.deleted.indexOf(a.id)===-1})),b.data.errors&&b.data.errors.length)c.show({template:'<md-toast class="md-toast error"> <span class="md-toast-text" flex>'+b.data.errors.join("\n")+"</span></md-toast>",hideDelay:3e3,position:"bottom left"
});else{var d=c.simple().textContent("حذف انجام شد");c.show(d)}})})},a.selectedCount=function(){return console.log("### selectedCount"),_.filter(a.data,{select:!0}).length},a.selectAll=function(){console.log("### selectedCount1"),_.forEach(a.data,function(b){b.select=a.selectAllCheckbox})},a.restore=function(b){console.log("### selectedCount2"),a.modalRelationObject=b},a.getLastFocus=function(b){console.log("### selectedCount4"),a.lastFocus=b.target;var c=b.target;if(c)if("selectionStart"in c)a.selectionStart=c.selectionStart,a.selectionEnd=c.selectionEnd;else if(document.selection){c.focus();var d=document.selection.createRange(),e=document.selection.createRange().text.length;d.moveStart("character",-c.value.length),a.selectionStart=d.text.length-e}},a.addFormula=function(b,c){$(a.lastFocus).focus();var d=$(a.lastFocus).val(),e="[id"+c+"].["+b+"]",f=0;d=d.substring(0,a.selectionStart)+d.substring(a.selectionEnd,d.length);var g=d.substring(0,a.selectionStart)+e+d.substring(a.selectionStart,d.length);$(a.lastFocus).val(g);var h=$(a.lastFocus).get(0);h.setSelectionRange(a.selectionStart+f,a.selectionStart+f),a.selectionStart=a.selectionStart+f,a.selectionEnd=a.selectionStart}}]),ngApp.filter("filterColumns",function(){return function(a,b,c,d){if(console.log("### selectedCount5"),a){var e=b.map(function(a){return c?a.left:a.right}).filter(function(a,b){return a!=-1&&b!=+d});return a.filter(function(a){return e.indexOf(a)==-1})}}});var ngApp=angular.module("management");ngApp.controller("datasourceJoinCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$window","$sce","$mdMedia","utils","datasources",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(b){a.saveProgress=!1,a.testProgress=!1,a.error=j.trustAsHtml(filterXSS("<b>"+b.data.title+"</b> <br/>"+b.data.desc))}function o(){2==window.history.length?f.path("/datasources/"+s):window.history.back()}function p(){return{id:t,isEdit:u,name:a.name,disable:a.disable,disableMessage:a.disableMessage,selectedDs:a.selectedDatasource.map(function(a){return a.Id}),selectedFields:a.selectedFields,relationsList:a.relationsList.map(function(a){return{left:a.left,right:a.right,includeRight:a.includeRight,includeLeft:a.includeLeft,repeatRows:a.repeatRows,conditions:a.conditions.map(function(a){return{left:a.left,right:a.right,op:a.op}})}}),script:a.script,relationType:a.relationType,aliasArray:JSON.stringify(a.aliasArray),isSchedule:a.isSchedule,schedule:a.schedule,partitions:a.partitions}}function n(b){a.saveProgress=!1,a.testProgress=!1,a.scriptProgress=!1,a.error=j.trustAsHtml("<b>"+filterXSS(b.data.title)+"</b> <br/>")}function q(a,b){return d.show({controller:["$scope","$mdDialog","$timeout",function(a,c,d){function e(b,c){b.renderer.setPadding(18),a.insertFormula=function(a){b.insert(a),b.focus()}}a.cancel=function(){c.cancel()},a.save=function(){c.hide(a.formula)},b&&(a.formula=b),a.aceOption={useWrapMode:!0,showGutter:!1,theme:"sqlserver",mode:"sqlserver",maxLines:14,onLoad:e,require:["ace/ext/beautify"]}}],parent:angular.element(document.body),targetEvent:a,clickOutsideToClose:!0,fullscreen:!0,template:'<md-dialog aria-label="{{\'editor\' | translate}}" ng-cloak class="fullscreen-dialog">                                 <md-toolbar>                                                                                                                            <div class="md-toolbar-tools">                                                                                                          <h2>{{\'editor\' | translate}}</h2>                                                                                                   <span flex></span>                                                                                                                  <md-button class="md-icon-button" ng-click="cancel()">                                                                                  <span class="material-icons">close</span>                                                                                       </md-button>                                                                                                                    </div>                                                                                                                          </md-toolbar>                                                                                                                       <md-dialog-content layout-margin flex layout="row" class="md-dialog-contentx">                                                          <style>                                                                                                                                 .ace_editor {                                                                                                                           border: 1px solid #efefef;                                                                                                      }                                                                                                                                                                                                                                                                           .ace_editor, .ace_editor div {                                                                                                          font: 16px/normal \'Courier New\', \'Menlo\', \'Ubuntu Mono\', \'Consolas\', \'source-code-pro\', monospace;                              }                                                                                                                                                                                                                                                                   md-dialog.fullscreen-dialog {                                                                                                           max-width: 100%;                                                                                                                    max-height: 100%;                                                                                                                   width: 100%;                                                                                                                        height: 100%;                                                                                                                       border-radius: 0;                                                                                                               }                                                                                                                               </style>                                                                                                                                                                                                                                                                <div class="ltr" flex="100" ui-ace="aceOption" ng-model="formula">                                                                      select * from tbl_meuns                                                                                                         </div>                                                                                                                                                                                                                                                              </md-dialog-content>                                                                                                                <md-dialog-actions layout="row">                                                                                                        <md-button ng-click="save()">                                                                                                           {{ \'ذخیره\' | translate }}                                                                                                        </md-button>                                                                                                                        <md-button ng-click="cancel()">                                                                                                         {{ \'cancel\' | translate }}                                                                                                      </md-button>                                                                                                                    </md-dialog-actions>                                                                                                            </md-dialog>'})}var r={MsOlap:1,MSSQL:2,MySQL:3,File:4,WebResource:5,JoinDatasource:6};a.utils=l,a.license=app.license,a.app=app;var s="undefined"!=typeof e.packageId?e.packageId:0,t="undefined"!=typeof e.id?e.id:0,u=(e.type,t>0);a.isEdit=u,a.id=t,a.model={},u&&b.get(app.urlPrefix+"api/datasources/GetInfo?type="+r.JoinDatasource+"&id="+t).then(function(b){a.restore(b.data.model,b.data.list),a.sign=b.data.sign},n);var v=!1;a.isSchedule=!1,a.selectedDatasource=[],a.selectedFields=[],a.relationsList=[],a.relationType="JOIN";var w=function(c){return a.datasourceListPromise||(a.datasourceListPromise=b.get(app.urlPrefix+"api/JoinDataSource/GetDatasourceList")),a.datasourceListPromise};a.select=function(b){d.show({controller:["$scope","$mdDialog",function(b,c){w().then(function(c){a.datasourceList=c.data,b.datasourceList=c.data,_.forEach(b.datasourceList,function(a){a.check=!1})}),b.select=function(){_.filter(b.datasourceList,{check:!0}).forEach(function(b){a.addItemToDatasource(b.Id)}),c.hide()},b.cancel=function(){c.cancel()}}],templateUrl:"join/datasource_select.html",parent:angular.element(document.body),targetEvent:b,clickOutsideToClose:!0,fullscreen:k("sm")||k("xs")})},a.exploreDatasource=function(c,e){d.show({controller:["$scope","$mdDialog",function(d,e){d.exploreError=null,d.explor=null,b.post(app.urlPrefix+"api/JoinDataSource/ExploreDatasource",JSON.stringify({Id:a.selectedDatasource[c].Id}),{headers:{"Content-Type":"application/json; charset=utf-8"}}).then(function(a){d.exploreError=null;var b=_.map(a.data.datasourceExplore,function(a,b){return"<tr>"+_.map(a,function(a){return 0==b?"<th>"+a+"</th>":"<td>"+a+"</td>"}).join("")+"</tr>"}).join("");d.explor=j.trustAsHtml('<table class="table">'+filterXSS(b)+"</table>")},function(b){a.exploreError=j.trustAsHtml(filterXSS(b.data.title+"<br/>"+b.data.desc))}),d.cancel=function(){e.cancel()}}],templateUrl:"join/datasource_explor.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0,fullscreen:k("sm")||k("xs")})},a.showRelationDialog=function(b){d.show({controller:["$scope","$mdDialog",function(b,c){b.$scope=a,b.cancel=function(){a.cancelItemtoRelationsList(),c.cancel()},b.ok=function(){a.addItemtoRelationsList(),c.hide()}}],templateUrl:"join/datasource_add_relation.html",parent:angular.element(document.body),targetEvent:b,clickOutsideToClose:!0,fullscreen:k("sm")||k("xs")})},a.addItemToDatasource=function(b){var c=a.selectedDatasource.filter(function(a){return a.Id.replace(/(\d+)-\d+/,"$1")==b}).length,d=a.datasourceList.filter(function(a){return a.Id==b});if(d&&d.length>0){for(var e=[],f=0;f<d[0].PartitionCount;f++)e.push({index:f,check:!0});a.selectedDatasource.push({Id:d[0].Id+"-"+c,Name:d[0].Name+(c>0?" شماره"+c:""),Fields:d[0].Fields,Partitions:e})}},a.removeSelectedDatasource=function(b){var c=a.selectedDatasource[b];a.selectedDatasource.splice(b,1),a.relationsList=a.relationsList.filter(function(a){return a.left!=c.Id&&a.right!=c.Id}),a.selectedFields=a.selectedFields.filter(function(a){var b=a.split(",");return b[0]!=c.Id})},a.persian=function(a){return persian(a)},a.aliasArray={},a.toggleSelectedFields=function(b){var c=a.selectedFields.indexOf(b);c>-1?a.selectedFields.splice(c,1):a.selectedFields.push(b)},a.toggleSelectedFieldsCheckAll=function(b,c){for(var d=$(c.target).prop("checked"),e=0;e<b.Fields.length;e++){var f=b.Id+","+e,g=a.selectedFields.indexOf(f);g>-1&&!d&&a.selectedFields.splice(g,1),g==-1&&d&&a.selectedFields.push(f)}},a.addRelationLimit=function(){a.modalRelationObject.conditions.push({left:0,op:"=",right:0})},a.removeRelationLimit=function(b){a.modalRelationObject.conditions.splice(b,1)},a.addItemtoRelationsList=function(){v||a.relationsList.push(a.modalRelationObject),a.cancelItemtoRelationsList()},a.cancelItemtoRelationsList=function(){v=!1,a.modalRelationObject={conditions:[{left:0,op:"=",right:0}],left:"0",right:"0",includeRight:!0,includeLeft:!0,repeatRows:!1}},a.editRelation=function(b){v=!0,$("#add-relation-modal").modal("show"),a.modalRelationObject=a.relationsList[b]},a.cancel=function(){o()},a.deleteDatasource=function(a){$(a.target).button("loading");var c=$("#datasource-id").val();b.post(app.urlPrefix+"api/JoinDataSource/Delete",JSON.stringify({id:c}),{headers:{"Content-Type":"application/json; charset=utf-8"}}).then(function(b){$(a.target).button("reset"),b.data.result&&app.router.navigate("Moderation/DataSource/index/",{trigger:!0})})},a.restore=function(b,c){a.isEdit=!0,a.datasourceList=c,b.selectedDs=b.selectedDs||[],c.forEach(function(c){for(var d=b.selectedDs.filter(function(a){return+a.replace(/(\d+)-\d+/,"$1")==+c.Id}),e=0;e<d.length;e++){for(var f=d[e],g=+f.replace(/(\d+)-(\d+)/,"$2"),h=[],e=0;e<c.PartitionCount;e++)h.push({index:e,check:!0});var i={Id:f,Name:c.Name+(g>0?" شماره"+g:""),Fields:c.Fields,Partitions:h};a.selectedDatasource.push(i)}}),a.selectedFields=b.selectedFields||[],a.relationsList=b.relationsList||[],a.name=b.name,a.modelType=b.modelType,a.disable=b.disable,a.disableMessage=b.disableMessage,a.script=b.script,a.relationType=b.relationType,a.aliasArray=JSON.parse(b.aliasArray),a.isSchedule=b.isSchedule,a.schedule=b.schedule,a.partitions=b.partitions||[]},a.saveJoin=function(c){var d=p();d.packageId=s,d.RolesActions=_.filter(a.roles,{check:!0}).map(function(a){return a.action+"-"+a.id}),d.modelType=a.modelType,a.saveProgress=!0,b.post(app.urlPrefix+"api/JoinDataSource/SaveRelation",JSON.stringify(d),{headers:{"Content-Type":"application/json; charset=utf-8"}}).then(function(b){a.saveProgress=!1,a.error=null,o(),m.reset()},n)},a.getScript=function(c){var d=p();a.scriptProgress=!0,b.post(app.urlPrefix+"api/JoinDataSource/GetScript",JSON.stringify(d),{headers:{"Content-Type":"application/json; charset=utf-8"}}).then(function(b){a.scriptProgress=!1,b.data.result?(a.script=b.data.script,a.error=null):a.error=j.trustAsHtml(filterXSS(b.data.message))})},a.test=function(c){var d=p();a.testProgress=!0,b.post(app.urlPrefix+"api/JoinDataSource/Test",JSON.stringify(d),{headers:{"Content-Type":"application/json; charset=utf-8"}}).then(function(b){var c=b.data;a.testProgress=!1,c.result?(a.testResult=c.queryResult,a.error=null):a.error=j.trustAsHtml(filterXSS(c.message))})},a.modalRelationObject={conditions:[{left:0,op:"=",right:0}],left:"0",right:"0",includeRight:!0,includeLeft:!0,repeatRows:!1},a.showDialog=function(b){q(b,a.script).then(function(b){a.script=b})}}]);var ngApp=angular.module("management");ngApp.controller("datasourceListCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$translate","datasources","utils","toolbar","$q",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(b){var c=new Date;a.progress=!1,a.securityCertPatch=b.data.securityCertPatch,a.allData=b.data.list,a.pageCount=40,a.page=1,a.maxPage=Math.ceil(a.allData.length/a.pageCount),a.setPage=function(b){a.page=b,a.data=a.allData.slice((a.page-1)*a.pageCount,a.page*a.pageCount)},a.setPage(1),i("لیست منابع داده").then(function(c){a.listTranslate=c,b.data.path.unshift({name:c,id:null}),a.path=b.data.path.map(function(b){return b.click=function(){a["goto"]({type:1,id:b.id})},b}),l.setTitles(a.path)}),h(function(){console.log("Process time: "+(new Date-c))},0)}function o(){return _.map(_.filter(a.data,{select:!0}),function(a){return[a.id,a.type]})}function p(b){var c=_.lastIndexOf(a.data.map(function(a){return a.type}),1);c==-1?a.data=b.concat(a.data):Array.prototype.splice.apply(a.data,[c+1,0].concat(b))}function q(b){a.data=_.filter(a.data,function(a){return!_.some(b,{id:a.id,type:a.type})})}function r(b){y=!1,a.timeDatasourceId=b.id,a.timeDatasourceName=b.name,a.timeDatasourceModelType=b.modelType,$(".datatime-modal").modal("show")}function s(a){k.showErrorToast(a.data.desc)}a.utils=k;var t="undefined"!=typeof e.id?e.id:0;a.app=app,a._=_;var u=t?"?packageId="+t:"",v=m.defer();a.progress=!0,b.get(app.urlPrefix+"api/datasources/get"+u,{timeout:v.promise}).then(function(a){n(a)},s),$(".ui.dimmer.modals .datatime-modal").remove();var w=function(){return _.some(a.data,{select:!0})};a.menuInvalidate=function(){console.log("#### menuInvalidate");var b=w(),c=_.filter(a.data,{select:!0,type:1}).length,d=_.filter(a.data,{select:!0,type:2}).length;a.canCopy=b,a.canDelete=b,a.canForward=b,a.canDirEdit=1==c&&0==d},a.copy=function(){var d=app.urlPrefix+"api/Datasources/Clone",e=o();b.post(d,e).then(function(b){if(b.data.result){b.data.datasources&&_.each(b.data.datasources,function(b){a.data.splice(_.findIndex(a.data,{type:2}),0,b)}),b.data.packages&&p(b.data.packages);var d=c.simple().textContent("کپی انجام شد");c.show(d)}},s)},a["delete"]=function(e){var f=app.urlPrefix+"api/Datasources/Delete",g=o(),h=d.confirm().title("حذف برای همیشه؟").textContent(g.length+" مورد برای حذف انتخاب شده است").ariaLabel("حذف").targetEvent(e).ok("حذف!").cancel("لغو");d.show(h).then(function(){b.post(f,g).then(function(b){if(b.data.result){b.data.deletedIds&&q(b.data.deletedIds);var d=c.simple().textContent("حذف انجام شد");c.show(d),a.menuInvalidate()}},s)},function(){a.status="You decided to keep your debt."})},a.forward=function(a){j.select(a,{type:["datasources"],justDir:!0,selectableDir:!0,multipleChart:!1}).then(function(a){var d=a.selected[0];if(e.id==d.id){var f=c.simple().textContent("موارد انتخاب شده در همین پوشه هستند");return void c.show(f)}var g=o();b.post(app.urlPrefix+"api/datasources/MoveToPackage",{Ids:g,packageId:d.id}).then(function(a){q(a.data.ids);var b=c.simple().textContent("انتقال انجام شد");c.show(b)},s)})},a.dirEdit=function(b){var d=o();g.edit(b,2,d[0][0],function(b){_.find(a.data,{select:!0}).name=b.data.info.Name;var d=c.simple().textContent("نام پوشه تغییر کرد");c.show(d)},s)},a.newPackage=function(a){g.create(a,2,e.id,function(a){p([{id:a.data.info.Id,name:a.data.info.Name,type:1}]);var b=c.simple().textContent("پوشه جدید ایجاد شد");c.show(b),j.reset()},s)},a.insertChart=function(a,b){f.path("charts/new/normal/0/"+a.id)},a.gotoChart=function(a){f.path("charts/edit/0/"+a.id)},a["goto"]=function(a,b){var c={MsOlap:1,MSSQL:2,MySQL:3,File:4,WebResource:5,JoinDatasource:6};if(4===a.systemType||1===a.systemType)return void alert("امکان ویرایش منابع داده سیستمی وجود ندارد");if(6===a.systemType)return void r(a);if(5===a.systemType)return void f.path("olap-tables"+(a.id?"/"+a.id:""));if(1===a.type&&f.path("datasources"+(a.id?"/"+a.id:"")),2==a.type)switch(a.dsType){case c.MySQL:f.path("datasources/add/mssql/"+c.MySQL+"/"+t+"/"+a.id);break;case c.MsOlap:f.path("datasources/add/mssql/"+c.MsOlap+"/"+t+"/"+a.id);break;case c.MSSQL:f.path("datasources/add/mssql/"+c.MSSQL+"/"+t+"/"+a.id);break;case c.File:f.path("datasources/add/file/"+t+"/"+a.id);break;case c.WebResource:f.path("datasources/add/web/"+t+"/"+a.id);break;case c.JoinDatasource:f.path("datasources/add/join/"+t+"/"+a.id)}},a.getTypeName=function(a){var b=1,c=2,d=3,e=4,f=5,g=6,h="";switch(+a){case b:h="MsOlap";break;case c:h="MSSQL";break;case d:h="MySQL";break;case e:h="File";break;case f:h="WebResource";break;case g:h="JoinDatasource"}return h};var x;a.$watch("search",function(){h.cancel(x),x=h(function(){"undefined"!=typeof a.search&&(a.progress=!0,null!==v&&v.resolve(),v=m.defer(),b.get(app.urlPrefix+"api/datasources/get?q="+a.search,{timeout:v.promise}).then(function(a){n(a)},s))},400)}),a.selectAll=function(){a.data&&_.forEach(a.data,function(b){b.select=a.selectAllCheckbox}),a.menuInvalidate()},a.newDatasource=function(a){f.path("datasources/new/"+(e.id?e.id:""))};var y=!1;a.addTimeDatasoure=function(b){y=!0,i(["Create Time Datasource","Enter the datasource name.","name","ok","cancel"]).then(function(b){a.timeDatasourceId=0,a.timeDatasourceName=null,a.timeDatasourceModelType=0,$(".datatime-modal").modal("show")})},a.createDatatime=function(){a.timeDatasourceProgress=!0,b.get(app.urlPrefix+"api/datasources/createDatetimeDatasource?name="+a.timeDatasourceName+"&pId="+t+"&type="+a.timeDatasourceModelType+"&id="+a.timeDatasourceId).then(function(b){y?a.data.splice(_.findIndex(a.data,{type:2}),0,b.data):a.data.splice(_.findIndex(a.data,{type:2,id:b.data.id}),1,b.data),a.timeDatasourceProgress=!1,$(".datatime-modal").modal("hide")},function(){a.timeDatasourceProgress=!1,$(".datatime-modal").modal("hide"),alert("خطایی در ساخت منبع داده رخ داده است")})},a.sortDetail={},a.sort=function(b){a.sortDetail[b]=a.sortDetail[b]||{},a.sortDetail[b].isDesc=!a.sortDetail[b].isDesc;var c=_.filter(a.data,{type:1}),d=_.filter(a.data,{type:2});d=_.sortBy(d,[b]),c=_.sortBy(c,[b]),a.sortDetail[b].isDesc||(d=_.reverse(d),c=_.reverse(c)),a.data=c.concat(d)}}]);var ngApp=angular.module("management");ngApp.controller("datasourceMssqlCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$window","$sce","roles","datasources",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(b){a.error=j.trustAsHtml("<b>"+filterXSS(b.data.title)+"</b> <br/>")}function n(){2==window.history.length?f.path("/datasources/"+r):window.history.back()}function o(){$("md-content").animate({scrollTop:4e3},500)}function p(a,b){return d.show({controller:["$scope","$mdDialog","$timeout",function(a,c,d){function e(b,c){b.renderer.setPadding(18),a.insertFormula=function(a){b.insert(a),b.focus()}}a.cancel=function(){c.cancel()},a.save=function(){c.hide(a.formula)},b&&(a.formula=b),a.aceOption={useWrapMode:!0,showGutter:!1,theme:"sqlserver",mode:"sqlserver",maxLines:14,onLoad:e,require:["ace/ext/beautify"]}}],parent:angular.element(document.body),targetEvent:a,clickOutsideToClose:!0,fullscreen:!0,template:'<md-dialog aria-label="{{\'editor\' | translate}}" ng-cloak class="fullscreen-dialog">                                 <md-toolbar>                                                                                                                            <div class="md-toolbar-tools">                                                                                                          <h2>{{\'editor\' | translate}}</h2>                                                                                                   <span flex></span>                                                                                                                  <md-button class="md-icon-button" ng-click="cancel()">                                                                                  <span class="material-icons">close</span>                                                                                       </md-button>                                                                                                                    </div>                                                                                                                          </md-toolbar>                                                                                                                       <md-dialog-content layout-margin flex layout="row" class="md-dialog-contentx">                                                          <style>                                                                                                                                 .ace_editor {                                                                                                                           border: 1px solid #efefef;                                                                                                      }                                                                                                                                                                                                                                                                           .ace_editor, .ace_editor div {                                                                                                          font: 16px/normal \'Courier New\', \'Menlo\', \'Ubuntu Mono\', \'Consolas\', \'source-code-pro\', monospace;                              }                                                                                                                                                                                                                                                                   md-dialog.fullscreen-dialog {                                                                                                           max-width: 100%;                                                                                                                    max-height: 100%;                                                                                                                   width: 100%;                                                                                                                        height: 100%;                                                                                                                       border-radius: 0;                                                                                                               }                                                                                                                               </style>                                                                                                                                                                                                                                                                <div class="ltr" flex="100" ui-ace="aceOption" ng-model="formula">                                                                      select * from tbl_meuns                                                                                                         </div>                                                                                                                                                                                                                                                              </md-dialog-content>                                                                                                                <md-dialog-actions layout="row">                                                                                                        <md-button ng-click="save()">                                                                                                           {{ \'ذخیره\' | translate }}                                                                                                        </md-button>                                                                                                                        <md-button ng-click="cancel()">                                                                                                         {{ \'cancel\' | translate }}                                                                                                      </md-button>                                                                                                                    </md-dialog-actions>                                                                                                            </md-dialog>'})}var q={MsOlap:1,MSSQL:2,MySQL:3,File:4,WebResource:5,JoinDatasource:6};a.license=app.license,a.app=app;var r="undefined"!=typeof e.packageId?e.packageId:0,s="undefined"!=typeof e.id?e.id:0,t=e.type,u=s>0;a.id=s,a.isEdit=u,a.type=t,a.schedule={},a.schedulePartition=[],u?b.get(app.urlPrefix+"api/datasources/GetInfo?type="+t+"&id="+s).then(function(b){if(a.model=b.data.model,a.sign=b.data.sign,a.tableName=b.data.tableName,a.model.Schedule&&(a.schedule=JSON.parse(a.model.Schedule)),a.model.schedulePartition&&(a.schedulePartition=JSON.parse(a.model.schedulePartition)),a.model.Type=t,a.model.intervalFetch){var c=[a.model.intervalFetch.fieldTrash].concat(a.model.intervalFetch.fieldId||[]);a.fields=c}},m):a.model={Authentication:0,CollationDefault:1,AutoRefresh:"15",Type:t},a.saveProgress=!1,a.cancel=function(){n()},a.save=function(d){a.model.saveData=d,a.error=null,a.testResult=null,a.model.Schedule=JSON.stringify(a.schedule),a.model.schedulePartition=JSON.stringify(a.schedulePartition),a.model.RolesActions=_.filter(a.roles,{check:!0}).map(function(a){return a.action+"-"+a.id}),a.saveProgress=!0,b.post(app.urlPrefix+"api/Datasources/AddMsOlap",{model:a.model,Type:t,IsEdit:u,PackageId:r}).then(function(b){a.saveProgress=!1;var d=c.simple().textContent(u?"تغییرات ثبت شد":"منبع داده جدید ایجاد شد");c.show(d),n(),l.reset()},function(b){a.saveProgress=!1,a.error=j.trustAsHtml("<b>"+filterXSS(b.data.desc)+"</b> <br/>"),o()})},a.testProgress=!1,app.http=b,app.scope=a,a.test=function(){a.error=null,a.testResult=null,a.mssql.$submitted=!0,a.model.Schedule=JSON.stringify(a.schedule),a.model.schedulePartition=JSON.stringify(a.schedulePartition),a.testProgress=!0,b.post(app.urlPrefix+"api/Datasources/TestMsOlap",a.model).then(function(b){a.testProgress=!1;var c="";if(t!==q.MsOlap||a.model.Query){var d=_.map(b.data.queryResult,function(a,b){return"<tr>"+_.map(a,function(a){return 0===b?"<th>"+filterXSS(a)+"</th>":"<td>"+filterXSS(a)+"</td>"}).join("")+"</tr>"}).join("");c='<table class="table">'+d+"</table>",a.fields=b.data.queryResult[0]}t!==q.MsOlap||a.model.Query||(c='<div style="background-color:#dff0d8" flex>اتصال با موفقیت برقرار شد</div>'),a.testResult=j.trustAsHtml(c)},function(b){a.testProgress=!1,a.error=j.trustAsHtml("<b>"+filterXSS(b.data.desc)+"</b> <br/>"),o()})},a.showDialog=function(b){p(b,a.model.Query).then(function(b){a.model.Query=b})},a.clearCacheProgress=!1,a.clearCache=function(){a.clearCacheProgress=!0,b.post(app.urlPrefix+"api/Datasources/clearCache/"+s).then(function(b){a.clearCacheProgress=!1})["catch"](function(){a.clearCacheProgress=!1})},a.detail=function(b){function c(a){var b=[{val:"0",label:"در لحظه"},{val:"1",label:"هر یک دقیقه"},{val:"5",label:"هر پنج دقیقه"},{val:"15",label:"هر پانزده دقیقه"},{val:"30",label:"هر سی دقیقه"},{val:"60",label:"هر یک ساعت"},{val:"1440",label:"هر روز"},{val:"10080",label:"هر هفته"},{val:"40320",label:"هر ماه"},{val:"2147483647",label:"عدم به‌روز رسانی"},{val:"-1",label:"زمانبندی..."},{val:"-2",label:"تقسیم‌بندی..."}],c=_.find(b,{val:a+""});return c?c.label:""}a.detailModel=b,a.detailModel.ScheduleParse=JSON.parse(b.Schedule),a.detailModel.Detail=JSON.parse(b.Detail),a.detailModel.MetaInfoParse=JSON.parse(b.MetaInfo),a.detailModel.AutoRefreshLabel=c(a.detailModel.AutoReresh),console.log(a.detailModel),a.showDetailModel=!0},a.restoreVersion=function(){function b(b){a.model[b]=a.detailModel.Detail[b]}if(b("DisableMessage"),b("Host"),b("Username"),b("Port"),b("Query"),b("Disable"),b("Database"),b("Authentication"),b("CollationDefault"),b("ColumnStoreIndex"),b("intervalFetch"),a.model.Name=a.detailModel.Name,a.model.AutoRefresh=a.detailModel.AutoReresh+"",a.model.ModelType=a.detailModel.ModelType,a.detailModel.Schedule&&(a.schedule=JSON.parse(a.detailModel.Schedule)),a.detailModel.schedulePartition&&(a.schedulePartition=JSON.parse(a.detailModel.schedulePartition)),a.detailModel.intervalFetch){var c=[a.detailModel.intervalFetch.fieldTrash].concat(a.detailModel.intervalFetch.fieldId||[]);a.fields=c}}}]);var ngApp=angular.module("management");ngApp.controller("datasourceNewCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$translate",function(a,b,c,d,e,f,g,h,i){var j={MsOlap:1,
MSSQL:2,MySQL:3,File:4,WebResource:5,JoinDatasource:6},k="undefined"==typeof e.id?0:e.id;i(["sql server title","sql server desc","analysis service title","analysis service desc","file title","file desc","web service title","web service desc","datasource join title","datasource join desc"]).then(function(b){a.list=[{href:"datasources/add/mssql/"+j.MSSQL+"/"+k,icon:app.urlPrefix+"Images/ds-type-db.png",title:b["sql server title"],desc:b["sql server desc"]},{href:"datasources/add/mssql/"+j.MsOlap+"/"+k,icon:app.urlPrefix+"Images/ds-type-xmla.png",title:b["analysis service title"],desc:b["analysis service desc"]},{href:"datasources/add/file/"+k,icon:app.urlPrefix+"Images/ds-type-upload.png",title:b["file title"],desc:b["file desc"]},{href:"datasources/add/web/"+k,icon:app.urlPrefix+"Images/ds-type-point.png",title:b["web service title"],desc:b["web service desc"]},{href:"datasources/add/join/"+k,icon:app.urlPrefix+"Images/join-datasource.png",title:b["datasource join title"],desc:b["datasource join desc"]}],app.license.olap&&a.list.push({href:"olap-tables",icon:app.urlPrefix+"Images/calculated-table.png",title:"جدول محاسباتی",desc:"برای ساخت یک جدول جدید از روی مدل‌هایی که به صورت DAX ذخیره کرده‌اید از این گزینه استفاده کنید."})}),a["goto"]=function(a){console.log(a),f.path(a.href)}}]),function(a){var b=angular.module("datasourcePartitionExpressionCat",["ngAnimate","ui.mask","datasourceScheduleCat"]);b.directive("partitionExpression",["$timeout","$http",function(b,c){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/datasource/PartitionExprission.html",scope:{type:"=?",datasources:"=?",partition:"=ngModel"},controller:["$scope","$http",function(c,d){c.type||(c.type=1),c.partition||(c.partition=[]),c.newPartition=function(){c.partition.push({formulas:[{}],datasources:[],autoRefresh:60,schedule:{}}),b(function(){app.lang.setLang()},0)},c.getPartitionName=function(a){var b={0:"اول",1:"دوم",2:"سوم",3:"چهارم",4:"‍‍‍پنجم",5:"ششم",6:"هفتم",7:"هشتم",8:"نهم",9:"دهم"};return+a<10?b[+a]:"اضافه"},c.addDatasourceToPartition=function(d){var e=c.datasources.filter(function(a){return a.Id==d.id});e.length>0?d.partitions=a.extend(!0,[],e[0].Partitions):d.partitions=[],b(function(){app.lang.setLang()},0)},app.lang.setLang()}],link:function(){app.lang.setLang()}}}])}(jQuery),function(){var a=angular.module("datasourceScheduleCat",["ngAnimate","ui.mask","ngMaterial"]);a.directive("datasourceSchedule",["$timeout","$http",function(a,b){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/datasource/Schedule.html?v="+app.version,scope:{model:"=?ngModel"},controller:["$scope","$http","$element","$mdMedia","$mdDialog",function(a,b,c,d,e){function f(b,c){b.model=a.model,b.cancel=function(){c.cancel()},b.checkValue=function(){"second"==b.model.dailyFrequencyRecurType&&+b.model.dailyFrequencyRecur<10&&(b.model.dailyFrequencyRecur=10)},b.save=function(){c.hide(b.model)}}a.model&&a.model.occure||(a.model={occure:"daily",dailyRecurs:1,weeklyRecurs:1,weeklySat:!0,weeklySun:!1,weeklyMon:!1,weeklyTus:!1,weeklyWen:!1,weeklyThu:!1,weeklyFri:!1,monthlyDayOf:1,monthlyRecurs:1,dailyFrequency:"once",dailyFrequencyAtHour:"0600",dailyFrequencyRecur:1,dailyFrequencyRecurType:"hour",dailyFrequencyStart:"0001",dailyFrequencyStop:"2359"}),a.formatClock=function(a){var b=a+"";return b.substr(0,2)+":"+b.substr(2)},a.edit=function(a){function b(a){}var c=d("sm")||d("xs");e.show({controller:["$scope","$mdDialog",f],templateUrl:app.urlPrefix+"dist/partial/management/datasource/scheduleDialog.html?v="+Math.random(),parent:angular.element(document.body),targetEvent:a,clickOutsideToClose:!0,fullscreen:c}).then(b)}}]}}]),a.directive("datasourceScheduleCaption",["$timeout","$http",function(a,b){return{restrict:"E",template:"            {{'اجرا هر' | translate}}            {{model.occure!='daily'? '' : (model.dailyRecurs>1?model.dailyRecurs:'') + ' روز'}}            {{model.occure!='weekly'? '' : (model.weeklyRecurs>1?model.weeklyRecurs:'') + ' هفته' + ' در '}}            {{model.occure!='weekly'? '' : (model.weeklySat?'شنبه، ':'') }}            {{model.occure!='weekly'? '' : (model.weeklySun?'یک شنبه، ':'') }}            {{model.occure!='weekly'? '' : (model.weeklyMon?'دو شنبه، ':'') }}            {{model.occure!='weekly'? '' : (model.weeklyTus?'سه شنبه، ':'') }}            {{model.occure!='weekly'? '' : (model.weeklyWen?'چهار شنبه، ':'') }}            {{model.occure!='weekly'? '' : (model.weeklyThu?'پنج شنبه، ':'') }}            {{model.occure!='weekly'? '' : (model.weeklyFri?'جمعه':'') }}            {{model.occure!='monthly'? '' : (model.monthlyRecurs>1?model.monthlyRecurs:'') + ' ماه '}}            {{model.occure!='monthly'? '' : 'روز ' +  model.monthlyDayOf }}            {{model.dailyFrequency=='once'? 'راس ساعت ' +  formatClock(model.dailyFrequencyAtHour):'' }}            {{model.dailyFrequency=='recur'? 'هر ' +  model.dailyFrequencyRecur + (model.dailyFrequencyRecurType=='hour'?'ساعت ':model.dailyFrequencyRecurType=='minute'?'دقیقه ':'ثانیه ') + 'بین ساعت ' + formatClock(model.dailyFrequencyStart) + ' و '+ formatClock(model.dailyFrequencyStop):'' }}",scope:{model:"=?ngModel"},controller:["$scope","$http","$element","$mdMedia","$mdDialog",function(a,b,c,d,e){console.log("### [datasourceScheduleCaption] model",a.model),a.formatClock=function(a){var b=a+"";return b.substr(0,2)+":"+b.substr(2)}}]}}])}(),function(){var a=angular.module("management");a.directive("schemaTypes",[function(){return{templateUrl:app.urlPrefix+"dist/partial/management/datasource/schemaTypes.html?v="+app.version,scope:{model:"=?ngModel",id:"=?"},controller:["$scope","$http",function(a,b){a.types=[{name:"INT",type:0},{name:"BIGINT",type:1},{name:"DECIMAL",type:2},{name:"NVARCHAR_100",type:3},{name:"NVARCHAR_400",type:4},{name:"NVARCHAR_4000",type:5},{name:"NVARCHAR_MAX",type:6},{name:"DATE",type:7},{name:"DATE_TIME",type:8},{name:"BOOLEAN",type:9},{name:"FLOAT",type:10},{name:"UNKOWN",type:11},{name:"DATE_TIME2",type:12}];var c=0;a.$watch("model",function(b){c++,c>=3&&(a.change=!0,console.log("### chage model",a.change,b))},!0),a.save=function(){a.saveProgress=!0,b.post(app.urlPrefix+"api/datasources/changeSchema/"+a.id,a.model).then(function(){a.saveProgress=!1,a.change=!1})["catch"](function(b){a.error=b.data.desc,a.saveProgress=!1})},a.remove=function(){var c=confirm("با پاک کردن اسکیما، داده‌های قبلی به همراه اسکیمای جدول نیز پاک خواهند شد. آیا برای اینکار اطمینان دارید؟");c&&(a.removeProgress=!0,b.post(app.urlPrefix+"api/datasources/cleanDatasource/"+a.id).then(function(){a.removeProgress=!1,a.model=[]})["catch"](function(b){a.error=b.data.desc,a.removeProgress=!1}))}}]}}])}();var ngApp=angular.module("management");ngApp.controller("datasourceWebCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$window","$sce","datasources",function(a,b,c,d,e,f,g,h,i,j,k){function l(b){a.saveProgress=!1,a.testProgress=!1,a.error=b.data.desc}function m(b){a.model.isEdit=s,a.model.isTest=b,a.model.id=r,a.model.parameters=a.parameters.filter(function(a){return a.name}).map(function(a){return[a.name,a.value,a.type]}),a.model.Schedule=JSON.stringify(a.schedule),a.model.RolesActions=_.filter(a.roles,{check:!0}).map(function(a){return a.action+"-"+a.id})}function n(){2==window.history.length?f.path("/datasources/"+q):window.history.back()}function o(a){c.show({template:'<md-toast class="md-toast error"> <span class="md-toast-text" flex>'+a+"</span></md-toast>",hideDelay:3e3,position:"bottom left"})}var p={MsOlap:1,MSSQL:2,MySQL:3,File:4,WebResource:5,JoinDatasource:6},q="undefined"!=typeof e.packageId?e.packageId:0,r="undefined"!=typeof e.id?e.id:0,s=(e.type,r>0);a.license=app.license,a.app=app,a.isEdit=s,a.id=r,a.model={contentType:"1",packageId:q},b.get(app.urlPrefix+"api/JoinDataSource/GetDatasourceList?noColumn=true").then(function(b){a.datasourceList=_.filter(b.data,{Type:5})}),s&&b.get(app.urlPrefix+"api/datasources/GetInfo?type="+p.WebResource+"&id="+r).then(function(b){if(a.model=b.data.model,a.sign=b.data.sign,a.tableName=b.data.tableName,a.model.Schedule&&(a.schedule=JSON.parse(a.model.Schedule)),a.model.parameters&&(a.parameters=a.model.parameters.map(function(a){return{name:a[0],value:a[1],type:a[2]||"Query"}})),a.model.intervalFetch){var c=[a.model.intervalFetch.fieldTrash].concat(a.model.intervalFetch.fieldId||[]);c=_.uniq(c),a.fields=c}},l),a.schedule={},a.parameters=[{type:"Query"}],a.paging={type:"numbers",enable:!1,from:0,to:10},a.saveProgress=!1,a.save=function(d){return a.model.saveData=!(!d&&a.isEdit),a.error=null,a.testResult=null,a.webForm.$valid?(m(!1),link=app.urlPrefix+"api/WebResource/Add",a.saveProgress=!0,void b.post(link,a.model).then(function(b){a.saveProgress=!1;var d=c.simple().textContent(s?"تغییرات ثبت شد":"منبع داده جدید ایجاد شد");c.show(d),n(),k.reset()},l)):void o("فیلدهای ضروری باید پر شوند")},a.testProgress=!1,a.test=function(){return a.error=null,a.testResult=null,a.webForm.$valid?(m(!0),link=app.urlPrefix+"api/WebResource/Add",a.testProgress=!0,void b.post(link,a.model).then(function(b){a.testProgress=!1;var c="",d=_.map(b.data.list,function(a,b){return"<tr>"+_.map(a,function(a){return 0==b?"<th>"+filterXSS(a)+"</th>":"<td>"+filterXSS(a)+"</td>"}).join("")+"</tr>"}).join("");c='<table class="table">'+d+"</table>",a.testResult=j.trustAsHtml(c),a.fields=b.data.list[0]},l)):void o("فیلدهای ضروری باید پر شوند")},a.clearCacheProgress=!1,a.clearCache=function(){a.clearCacheProgress=!0,b.post(app.urlPrefix+"api/Datasources/clearCache/"+r).then(function(b){a.clearCacheProgress=!1})["catch"](function(){a.clearCacheProgress=!1})},a.detail=function(b){function c(a){var b=[{val:"0",label:"در لحظه"},{val:"1",label:"هر یک دقیقه"},{val:"5",label:"هر پنج دقیقه"},{val:"15",label:"هر پانزده دقیقه"},{val:"30",label:"هر سی دقیقه"},{val:"60",label:"هر یک ساعت"},{val:"1440",label:"هر روز"},{val:"10080",label:"هر هفته"},{val:"40320",label:"هر ماه"},{val:"2147483647",label:"عدم به‌روز رسانی"},{val:"-1",label:"زمانبندی..."},{val:"-2",label:"تقسیم‌بندی..."}],c=_.find(b,{val:a+""});return c?c.label:""}a.detailModel=b,a.detailModel.ScheduleParse=JSON.parse(b.Schedule),a.detailModel.Detail=JSON.parse(b.Detail),a.detailModel.MetaInfoParse=JSON.parse(b.MetaInfo),a.detailModel.AutoRefreshLabel=c(a.detailModel.AutoReresh),console.log(a.detailModel),a.showDetailModel=!0},a.restoreVersion=function(){function b(b,c){a.model[b]=a.detailModel.Detail[c||b]}if(b("type","Type"),b("url","Url"),b("method","Method"),b("jsonPostProcess"),b("rawBody"),b("resultTag"),b("resultTagNameSpace"),b("resultTagUseValue"),b("loginByToken"),b("paging"),b("parameters","Parameters"),b("authenticationType","AuthenticationType"),b("user","User"),b("ColumnStoreIndex"),b("streamMode"),b("schema"),b("intervalFetch"),b("contentType"),a.model.name=a.detailModel.Name,a.model.AutoRefresh=a.detailModel.AutoReresh+"",a.model.ModelType=a.detailModel.ModelType,a.detailModel.Schedule&&(a.schedule=JSON.parse(a.detailModel.Schedule)),a.detailModel.schedulePartition&&(a.schedulePartition=JSON.parse(a.detailModel.schedulePartition)),a.detailModel.intervalFetch){var c=[a.detailModel.intervalFetch.fieldTrash].concat(a.detailModel.intervalFetch.fieldId||[]);a.fields=c}}}]);var ngApp=angular.module("management");ngApp.service("indicator",["$mdDialog","$mdMedia","$rootScope","templates","$http",function(a,b,c,d,e){var f=function(c,e){function f(a,b){a.cancel=function(){b.cancel()}}var g=b("sm")||b("xs");return a.show({controller:["$scope","$mdDialog",f],parent:angular.element(document.body),targetEvent:c,clickOutsideToClose:!0,fullscreen:g,templateUrl:d.tmpl.package_dialog})};return{get:f}}]);var ngApp=angular.module("management");ngApp.service("packages",["$mdDialog","$mdMedia","$rootScope","$http",function(a,b,c,d){function e(a,b){return f||(f=d.post(app.urlPrefix+"api/Package/GetPackagesObject",{scope:a,withContent:b})),f}var f,g=function(c,d,f,g,h){function i(a,b){function c(a,b){b(a),a.subPackages&&_.forEach(a.subPackages,function(a){c(a,b)})}e(d,f).then(function(b){a.root=b.data.root,console.log("set root in package service ",a.root)}),a.clearSelect=function(){c(a.root,function(a){a.select=!1})},a.cancel=function(){b.cancel()},a.select=function(){var d=null;c(a.root,function(a){a.select&&(d=a)}),b.hide(d)}}var j=b("sm")||b("xs");a.show({controller:i,templateUrl:app.urlPrefix+"dist/partial/management/packages/select-package.html",parent:angular.element(document.body),targetEvent:c,clickOutsideToClose:!0,fullscreen:j}).then(g,h)},h=function(b,c,e,g,h,i){var j=a.prompt().title("ایجاد پوشه جدید").textContent("نام پوشه جدید را وارد کنید").placeholder("نام پوشه").ariaLabel("نام پوشه").targetEvent(b).ok("ایجاد").cancel("لغو");a.show(j).then(function(a){f=null,d.post(app.urlPrefix+"api/Package/Create",{name:a,scope:c,parentId:e}).then(g,h)},i)},i=function(b,c,e,g,h,i){var j=a.prompt().title("تغییر نام پوشه").textContent("نام جدید را وارد کنید").placeholder("نام پوشه").ariaLabel("نام پوشه").targetEvent(b).ok("تغییر").cancel("لغو");a.show(j).then(function(a){f=null,d.post(app.urlPrefix+"api/Package/Edit",{id:e,name:a}).then(g,h)},i)};return{name:"packages",select:g,create:h,edit:i}}]);var ngApp=angular.module("management");ngApp.service("utils",["$http","$translate","$sce","$mdToast",function(a,b,c,d){function e(a,b){if("undefined"==typeof b&&(b=app.lang.isRtl()),!b)return a;var c={0:"۰",1:"۱",2:"۲",3:"۳",4:"۴",5:"۵",6:"۶",7:"۷",8:"۸",9:"۹"};return a+="",a.replace(/(\d)/g,function(a,b){return c[b]||a})}function f(a){var b={"۰":0,"۱":1,"۲":2,"۳":3,"۴":4,"۵":5,"۶":6,"۷":7,"۸":8,"۹":9};return a+="",a.replace(/([۰۱۲۳۴۵۶۷۸۹])/g,function(a,c){return"undefined"!=typeof b[c]?b[c]:a})}function g(a){var b={"ي":"ی","إ":"ا","ؤ":"و","أ":"ا","ک":"ك"};return a+="",a.replace(/(.)/g,function(a,c){return b[c]||a})}function h(a){var b=c.trustAsHtml(filterXSS("<b>"+a.data.title+"</b> <br/>"+a.data.desc));j&&j(b)}function i(a){d.show({template:'<md-toast class="md-toast error"> <span class="md-toast-text" flex>'+a+"</span></md-toast>",hideDelay:3e3,position:"bottom left"})}var j,k=function(a){j=a};return{persian:e,depersian:f,normilize:g,error:h,onError:k,showErrorToast:i}}]);var cat=angular.module("settingsCat",["ngAnimate"]);cat.controller("myController",["$scope","$http","$sce","$timeout",function(a,b,c,d){a.langs=[{key:0,value:"فارسی"},{key:1,value:"English"}],a.save=function(d){$(d.target).button("loading"),b.post(app.urlPrefix+"api/Settings/GeneralSettings",JSON.stringify({Brand:a.brand,Language:a.language}),{headers:{"Content-Type":"application/json; charset=utf-8"}}).then(function(b){$(d.target).button("reset"),b.data.result?($("a.navbar-brand").text(b.data.brand),window.history.back()):a.error=c.trustAsHtml(filterXSS(b.data.error))})},a.restore=function(b){b&&d(function(){var c=JSON.parse(b);console.log(c),a.brand=c.Brand,a.language=c.Language},0)}}]);var cat=angular.module("settingsCat",["ngAnimate"]);cat.controller("myController",["$scope","$http","$sce","$timeout",function(a,b,c,d){a.save=function(d){b.post(app.urlPrefix+"api/Settings/Mail",JSON.stringify({port:a.port,host:a.host,ssl:a.ssl,timeout:a.timeout,username:a.username,password:a.password}),{headers:{"Content-Type":"application/json; charset=utf-8"}}).then(function(b){b.data.result?window.history.back():a.error=c.trustAsHtml(filterXSS(b.data.error))})},a.restore=function(b){b&&d(function(){var c=JSON.parse(b);console.log("[settingsCat] "),console.log(c),a.port=c.port,a.host=c.host,a.ssl=c.ssl,a.timeout=c.timeout,a.username=c.username,a.password=c.password},0)}}]);var ngApp=angular.module("management");ngApp.controller("dashboardsCtrl",["$scope","$http","$sce","$timeout","$mdToast","toolbar","$translate","utils","menus","$mdDialog",function(a,b,c,d,e,f,g,h,i,j){function k(){return _.map(_.filter(a.data,{select:!0}),function(a){return a.id})}a.utils=h,a.app=app;var l=function(){return _.some(a.data,{select:!0})};a.selectAll=function(){a.data&&_.forEach(a.data,function(b){b.select=a.selectAllCheckbox}),a.menuInvalidate()},a["delete"]=function(c){var d=app.urlPrefix+"api/menus/Delete",f=k(),g=j.confirm().title("حذف برای همیشه؟").textContent(f.length+" مورد برای حذف انتخاب شده است").ariaLabel("حذف").targetEvent(c).ok("حذف!").cancel("لغو");j.show(g).then(function(){b.post(d,f).then(function(b){b.data&&(a.data=_.filter(a.data,function(a){return _.indexOf(b.data,a.id)===-1}));var c=e.simple().textContent("حذف انجام شد");e.show(c),a.menuInvalidate()})})},a.menuInvalidate=function(){var b=l();a.canCopy=b,a.canDelete=b,a.canForward=b},a.progress=!0,i.get().then(function(b){a.progress=!1,a.data=b.data,_.each(a.data,function(a){a.time=0===a.updateDate?"":moment.utc(a.updateDate).format("jYYYY/jMM/jDD HH:mm:ss")})})}]);var ngApp=angular.module("management");ngApp.controller("dashboardDetailCtrl",["$scope","$http","$sce","$timeout","$mdToast","toolbar","$translate","utils","menus","$routeParams","mainmenus","menuCategories","$location",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(){b.get(app.urlPrefix+"api/users/get").then(function(b){a.users=b.data.list},h.error)}function o(){2==window.history.length?m.path("/dashboards"):window.history.back()}a.utils=h,a.app=app,a.id=j.id,i.getMenu(j.id).then(function(b){a.model=b.data.model,a.sign=b.data.sign,a.model.notifications=a.model.notifications||{},a.metadataModule=b.data.metadataModule}),a.render=!0,a.updateModel=function(b){a.model.notifications=b,a.render=!1,d(function(){a.render=!0},0),console.log("$scope.updateModel ",b)},k.get(-1).then(function(b){a.mainMenus=b.data.list}),l.get().then(function(b){a.menuCategories=b.data.list}),n(),a.save=function(){a.saveProgress=!0,a.error=null,a.model.rolesAction=_.filter(a.roles,{check:!0}).map(function(a){return{action:a.action,id:a.id,name:a.name}}),i.save(a.model).then(function(b){a.saveProgress=!1,a.model=b.data,0==a.id&&m.path("/dashboards/"+b.data.id);var c=e.simple().textContent("تغییرات با موفقیت ذخیره شد");e.show(c)})["catch"](function(b){a.saveProgress=!1,a.error=c.trustAsHtml(filterXSS(b.data.desc))})},a.restore=function(b){_.extend({},a.model);_.each(b.rolesAction,function(b){b.check=!1;var c=_.find(a.roles,{id:b.id});c&&(c.action=b.action,c.check=!0)}),a.model=b,a.save()},a.detail=function(b){a.detailModel=b,console.log(b),a.showDetailModel=!0},a.getRoleName=function(b){if(a.roles){var c=_.find(a.roles,{id:b});if(c)return c.name}return"نامشخص"},a.cancel=function(){o()}}]),function(){var a=angular.module("management");a.directive("datasourceMetainfo",["$timeout","$http","roles",function(a,b,c){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/datasource/datasourceMetainfo.html?v="+app.version,scope:{model:"=ngModel"},controller:["$scope","$http",function(a,b){a.show=app.datasourceMetadata,a.model=a.model||{}}]}}])}();
// داشبورد مدیریتی صدف info@sadafdashboard.ir 

function prepareData(a,b){for(var c=[],d=(a.matrix||[],0);d<a.matrix.length;d++){var e={};e.index=d,e.label=a.matrix[d].captions,e.onClickVal=a.matrix[d].canDrill?a.matrix[d].values:"",e.canDrill=a.matrix[d].canDrill,e.value=a.matrix[d].values,e.kpis=a.kpis.data[d],e.series=a.series.data[d];var f=[];if(e.kpis)for(var g=0;g<e.kpis.length;g++){for(var h=[],i=0;i<e.kpis[g].length;i++)""===e.kpis[g][i]?h.push(e.kpis[g][i]):h.push(parseFloat(e.kpis[g][i])||0);f.push(h)}e.kpis=f,f=[];for(var g=0;g<e.series.length;g++)""===e.series[g]||null===e.series[g]||isNaN(e.series[g])?f.push(e.series[g]):f.push(parseFloat(e.series[g])||0);e.series=f,c.push(e)}return c}function persian(a,b){if(null==a)return a;if(app.useEnglishDigit)return a;if("undefined"==typeof b&&(b=app.lang.isRtl()),!b)return a;var c={0:"۰",1:"۱",2:"۲",3:"۳",4:"۴",5:"۵",6:"۶",7:"۷",8:"۸",9:"۹"};return a+="",a.replace(/(\d)/g,function(a,b){return c[b]||a})}function depersian(a){var b={"۰":0,"۱":1,"۲":2,"۳":3,"۴":4,"۵":5,"۶":6,"۷":7,"۸":8,"۹":9};return a+="",a.replace(/([۰۱۲۳۴۵۶۷۸۹])/g,function(a,c){return"undefined"!=typeof b[c]?b[c]:a})}function normilize(a){var b={"ي":"ی","إ":"ا","ؤ":"و","أ":"ا","آ":"ا","ک":"ك"};return a+="",a.replace(/(.)/g,function(a,c){return b[c]||a})}function _instanceof(a,b){return null!=b&&"undefined"!=typeof Symbol&&b[Symbol.hasInstance]?!!b[Symbol.hasInstance](a):a instanceof b}function _slicedToArray(a,b){return _arrayWithHoles(a)||_iterableToArrayLimit(a,b)||_unsupportedIterableToArray(a,b)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(a,b){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(a)){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!b||c.length!==b);d=!0);}catch(i){e=!0,f=i}finally{try{d||null==h["return"]||h["return"]()}finally{if(e)throw f}}return c}}function _arrayWithHoles(a){if(Array.isArray(a))return a}function _classCallCheck(a,b){if(!_instanceof(a,b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}function _toConsumableArray(a){return _arrayWithoutHoles(a)||_iterableToArray(a)||_unsupportedIterableToArray(a)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(a,b){if(a){if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);return"Object"===c&&a.constructor&&(c=a.constructor.name),"Map"===c||"Set"===c?Array.from(a):"Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c)?_arrayLikeToArray(a,b):void 0}}function _iterableToArray(a){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(a))return Array.from(a)}function _arrayWithoutHoles(a){if(Array.isArray(a))return _arrayLikeToArray(a)}function _arrayLikeToArray(a,b){(null==b||b>a.length)&&(b=a.length);for(var c=0,d=new Array(b);c<b;c++)d[c]=a[c];return d}function _typeof(a){"@babel/helpers - typeof";return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a})(a)}var app=app||{};app.chartCommons={},app.chartCommons.tooltip={tooltipFormatter:function(set,fh,f,showPersain){var body=set.points.map(function(point){var bodyFormat=f||'{{point.label}}: <p class="ltr inline" style="padding:0; margin:0;" ><b>{{point.data}}</b></p>';return bodyFormat.replace(/{{([^(}})]+)}}/gm,function(i,p1){if(!p1.match(/point\.(data|label|color|format|percentage)/))return p1;var e=eval(p1);"NaN"===e&&(e="تعریف نشده");var s=isNaN(e)?e:persian(d3.format(point.format)(e),showPersain);return'<span class="inline ltr">'+s+"</span>"})}).join("<br/>"),headerFormat=fh||"",header=headerFormat.replace(/{{([^(}})]+)}}/gm,function(i,p1){var e=eval(p1);return isNaN(e)||"set.key"===p1?e:persian(d3.format(set.format)(e),showPersain)});header&&body.trim()&&(header+="<BR/>"),r='<div style="margin:0;text-align: right; padding:0;direction: rtl;">'+header+body+"</div>";var d=_.cloneDeep(filterXSS.whiteList);d.span=["class"];var fxx=filterXSS(r,{whiteList:d});return fxx}},app.chartCommons.setBackground=function(a,b){a.css("background",b.backgroundColor||"#fff"),b.backgroundColorIsGradient&&b.backgroundColor1&&b.backgroundColor2&&a.css("background-image","radial-gradient(circle, "+b.backgroundColor1+", "+b.backgroundColor2+")")},app.chartCommons.levelTypeUtils={getParam:function(a){if(!a.editMode&&a.chartProp.levelTypes&&a.chartProp.levelTypes.enable){var b=app.chartCommons.drillDown.get(a.ChartInPageId),c=b&&_.isArray(b.drillDown)?b.drillDown.length:0,d=Math.min(c,Object.keys(a.chartProp.levelTypes.props).length-1),e=a.chartProp.levelTypes.props[d];e.prop.levelTypes=_.merge({},a.chartProp.levelTypes),a.chartProp=e.prop,a.type=e.type}}},app.chartCommons.highchartSetTheme=function(){var a=d3.scale.category10();Highcharts.setOptions({lang:{loading:"در حال بارگذاری...",months:["January","February","March","April","May","June","July","August","September","October","November","December"],shortMonths:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],weekdays:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],decimalPoint:".",numericSymbols:["k","M","G","T","P","E"],resetZoom:"حالت اولیه",resetZoomTitle:"حالت اولیه 1:1",thousandsSep:","},global:{useUTC:!0,canvasToolsURL:"http://code.highcharts.com/4.1.4/modules/canvas-tools.js",VMLRadialGradientURL:"http://code.highcharts.com/4.1.4/gfx/vml-radial-gradient.png"}}),Highcharts.theme={chart:{},xAxis:{title:{text:null,align:"middle"}},yAxis:{endOnTick:!1,title:{text:null,align:"middle"},labels:{formatter:function(){return persian(d3.format(",")(this.value))}},lineWidth:2,lineColor:"#D8D8D8",tickWidth:1},tooltip:{valueSuffix:"",useHTML:!0,formatter:function(){return"<b>"+this.x+"</b>: <b>"+this.series.tooltipOptions.pointFormatter(this)+"</b>"},headerFormat:"",style:{"text-align":"right"}},plotOptions:{bar:{dataLabels:{enabled:!0}},series:{animation:{duration:800,easing:"easeInCubic"},allowPointSelect:!0,fillOpacity:.1,marker:{fillColor:"#FFFFFF",lineWidth:2,lineColor:null}}},credits:{enabled:!1},colors:[1,2,3,4,5,6,7,8,9,10].map(function(b,c){return a(c)}),chart:{animation:{duration:400,easing:"linear"},panning:!0,panKey:"shift"},title:{text:null,style:{color:"#000",font:"bold 16px Droid, Tahoma, Arial"}},subtitle:{style:{color:"#666666",font:"bold 12px Droid, Tahoma, Arial"}},legend:{itemStyle:{font:"9pt Droid, Tahoma, Arial",color:"black"},itemHoverStyle:{color:"gray"}}},Highcharts.setOptions(Highcharts.theme)},app.chartCommons.getError=function(a){if(!a.result){var b=0===+a.errorType?"منبع داده غیر فعال است":"اشکال در پرس و جو";return"<div class='temporal error'> <h4>"+b+"</h4><p>"+a.errorMessage+"</p></div>"}return"<div class='temporal error'> مشکلی در روند برنام ایجاد شده است</div>"},app.chartCommons.clearFilterParamsCache=function(a){if(!app.mobileMode){a||(a=JSON.parse(localStorage.getItem("filter-params")||"[]"));var b=(new Date).getTime()-864e5;_.remove(a,function(a){return a.time<b}),localStorage.setItem("filter-params",JSON.stringify(a))}},app.chartCommons.openLink=function(a,b){if(a&&a.checked){if(a.type||(a.type="dashboard",a.dashboardId===-1&&(a.type="link")),app.mobileMode){if(a.mode="open-dash","value-with-other"!==a.passFilterType&&(app.chartCommons.userFilter.clearAll(),app.chartCommons.drillDown.clearAll()),b&&b.value&&b.value.length&&"no-param"!==a.passFilterType){var c={id:-1,values:b.value,valuesCaption:b.caption,variableType:0,dimensionName:b.dimensionName,chartInPageId:b.ChartInPageId,datasourceId:b.DataSourceId,disableClear:!1,refreshDatasource:b.refreshDatasource};app.chartCommons.userFilter.setFilter(c)}return a.meta={drillDown:app.chartCommons.drillDown.filters,userFilter:app.chartCommons.userFilter.filters},void window.ReactNativeWebView.postMessage(JSON.stringify(a))}if("dashboard"===a.type){var d="";if("value-with-other"===a.passFilterType||"value"===a.passFilterType){if("value"===a.passFilterType&&(app.chartCommons.userFilter.clearAll(),app.chartCommons.drillDown.clearAll()),b){var c={id:-1,values:b.value,valuesCaption:b.caption,variableType:0,dimensionName:b.dimensionName,chartInPageId:b.ChartInPageId,datasourceId:b.DataSourceId,disableClear:!1,refreshDatasource:b.refreshDatasource};app.chartCommons.userFilter.setFilter(c)}b={drillDown:app.chartCommons.drillDown.filters,userFilter:app.chartCommons.userFilter.filters};var e=JSON.parse(localStorage.getItem("filter-params")||"[]");d="filter-"+md5(JSON.stringify(b)),_.remove(e,{key:d}),e.push({dash:a.dashboardId,key:d,data:b,time:(new Date).getTime()}),localStorage.setItem("filter-params",JSON.stringify(e))}var f=location.hash.replace(/.*app\/(\d+)\/dashboard.*/,"$1");location.hash="#/app/"+f+"/dashboard/"+a.dashboardId+(d?"/"+d:"")}if("back"===a.type&&window.history.back(),"link"===a.type){var g=window.open(a.link,"_blank");g?g.focus():alert("Please allow popups for this site")}}},app.chartCommons.calculateFields=function(series,calcFormulas,columnIsNumeric){function calc(item,series,columnIsNumeric){function getCell(a,b,c){return b=b<0?0:b>=a.length?a.length-1:b,c=c<0?0:c>=a[0].length?a[0].length-1:c,a[b][c]}if(series.labels.indexOf(item.name)===-1&&series.data instanceof Array){var isValid=/^({\s*r?([+-]?\d*)\s*,?\s*c?(\d*)}|[\d\s\+-\/\)\(\*]*|'[^']*')*$/gim.test(item.formula);if(!isValid)return void alert("### Not valid "+item.formula);for(var indexes=[],repFormula=item.formula.replace(/{\s*r?([\+-]?\d*)\s*,?\s*c?(\d*)}/gim,function(a,b,c){return indexes.push({row:+b,col:+c}),"$"+(indexes.length-1)}),i=0;i<series.data.length;i++){var rowFormula=repFormula.replace(/\$(\d+)/gim,function(a,b){var c=indexes[+b],d=getCell(series.data,c.row+i,c.col);return columnIsNumeric&&!columnIsNumeric[c.col]?"'"+d+"'":d||0});series.data[i].push(eval(rowFormula))}series.labels.push(item.name)}}return;var formulas},app.chartCommons.drillDown={filters:[],add:function(a,b,c,d,e){_.isArray(d)||(d=[d]),_.isArray(c)||(c=[c]),_.isArray(d)&&(d=JSON.stringify(d),c=JSON.stringify(c)),_.each(this.filters,function(a){_.each(a.drillDown,function(a){a.isLast=!1})});var f=_.find(this.filters,{chartInPageId:a});if(_.isUndefined(f)){var g={chartInPageId:a,datasourceId:b,refreshDatasource:e.RefreshDatasource,drillDown:[{isLast:!0,key:c,formula:e.CurrentDimFormula,value:d,keepFilter:_.find(e.CurrentDimKeepFilter||[])===!0}]};return this.filters.push(g),g.drillDown}var h=_.find(f.drillDown,{key:c});return _.isUndefined(h)||_.remove(f.drillDown,{key:c}),f.drillDown.push({key:c,value:d,isLast:!0,formula:e.CurrentDimFormula,keepFilter:_.find(e.CurrentDimKeepFilter||[])===!0}),f.drillDown},up:function(a,b){var c=_.find(this.filters,{chartInPageId:a});if(_.isUndefined(c))return[];_.isUndefined(b)&&(b=1);for(var d=0;d<b;d++)c.drillDown.length>0&&c.drillDown.pop();return c.drillDown},get:function(a){return _.find(this.filters,{chartInPageId:a})},clear:function(a,b){return _.remove(this.filters,{chartInPageId:a})},clearAll:function(a){a?this.filters=[]:this.filters=_.remove(this.filters,function(a){return a.drillDown=_.filter(a.drillDown,{keepFilter:!0}),a.drillDown&&a.drillDown.length})}},app.chartCommons.getFilterHierarchy=function(a,b){function c(a){if(_.isArray(a)){for(var b=0;b<a.length;b++){var c=a[b];"undefined"!=typeof c.Members&&c.Members&&(c.Members=c.Members.filter(function(a,b){return a.IsChecked}),c.FilteredMemberByUser=!0)}return a}}var b=$(".cid"+a+" .chart-dimentions-content").data("data");return _.isUndefined(b)?null:{Hierarchies:c(b.Hierarchies),Where:c(b.Where),SeriesLevel:c(b.SeriesLevel)}},app.chartCommons.userFilter={filters:[],clearAll:function(a){a?this.filters=[]:this.filters=_.filter(this.filters,{keepFilter:!0})},setUserControlFilters:function(a){this.clearAll(),_.isArray(a)&&_.each(a,function(a){app.chartCommons.userFilter.setFilterIfNotExist(a)})},setFilter:function(a){if(0===this.filters.length)return void this.filters.push(a);var b=_.find(this.filters,{chartInPageId:a.chartInPageId,dimensionName:a.dimensionName});_.isUndefined(b)||_.remove(this.filters,{chartInPageId:a.chartInPageId,dimensionName:a.dimensionName}),this.filters.push(a)},setFilterIfNotExist:function(a){if(!(_.isEmpty(a.values)||_.isArray(a.values)&&0===a.values.length)){if(0===this.filters.length)return void this.filters.push(a);var b=_.find(this.filters,{chartInPageId:a.chartInPageId,datasourceId:a.datasourceId});_.isUndefined(b)&&this.filters.push(a)}},getFilterValue:function(a){var b=_.find(this.filters,{chartInPageId:a});return _.isUndefined(b)?null:b}},app.chartCommons.lastRefreshDateFormat=function(a){if(!a)return"";if(0!==app.lang.langType)return a.D+"/"+a.M+"/"+a.Y+" - "+a.h+":"+a.m+":"+a.s+" ";var b="";a.Diff&&a.Diff<86400&&(b+=" - <b>",b+=a.Diff<60?Math.floor(a.Diff)+" ثانیه پیش":a.Diff<3600?Math.floor(a.Diff/60)+" دقیقه پیش":Math.floor(a.Diff/3600)+" ساعت پیش",b+="</b>");var c=1===+a.M?"فروردین":2===+a.M?"اردیبهشت":3===+a.M?"خرداد":4===+a.M?"تیر":5===+a.M?"مرداد":6===+a.M?"شهریور":7===+a.M?"مهر":8===+a.M?"آبان":9===+a.M?"آذر":10===+a.M?"دی":11===+a.M?"بهمن":"اسفند";return persian(a.D+" "+c+" ماه "+a.Y+" ساعت "+a.h+":"+a.m+":"+a.s+" "+b,!0)},app.chartCommons.setFilterParameter=function(a){var b=a.input&&a.input.RefreshDatasource?a.input.RefreshDatasource:null,c=app.chartCommons.getFilterParameter(a.ChartInPageId,b);a.parameters.drillDown=c.drillDown,a.editMode||(a.parameters.otherFilters=app.chartCommons.filterGroup(c.otherFilters,a),a.parameters.userControlFilter=app.chartCommons.filterGroup(c.userControlFilter,a),a.parameters.userVariable=c.userVariable)},app.chartCommons.filterGroup=function(a,b){var c=(b.chartProp.info.groups||"").split(",");return _.filter(a,function(a){var b=$("#ID"+a.chartInPageId).data("settings");if(!b){var d=_.find(dashboard.charts,{pageId:a.chartInPageId});d&&(b=JSON.parse(d.detail))}if(b){var e=(b.chartProp.info.groups||"").split(",");if((e.length||c.length)&&!_.intersection(e,c).length)return!1}return!0})},app.chartCommons.getFilterParameter=function(a,b){var c={drillDown:null},d=_.find(app.chartCommons.drillDown.filters,{chartInPageId:a});if(_.isUndefined(d)||(c.drillDown=d.drillDown),c.otherFilters=_.filter(app.chartCommons.drillDown.filters,function(c){if(!b)return!1;var d=b.indexOf(c.datasourceId)!==-1;return d&&c.chartInPageId!==a}),c.userControlFilter=$.extend([],_.filter(app.chartCommons.userFilter.filters,function(a){if(!b)return!1;var c=b.indexOf(a.datasourceId)!==-1;return c})),!app.mobileMode)var e=JSON.parse(localStorage.getItem("userVariable"));return c.userVariable=e,c},app.chartCommons.expandedType=1,app.chartCommons.clicked=!1,app.chartCommons.changeSeriesPropertyBaseOnExpandedType=function(a,b){var c=app.chartCommons.expandedType;a=a||{},a.info=a.info||{},a.info.aggregation="1",1===c&&(_.each(a.series,function(a,c){b&&c!==b||(a.seriesType="bar",a.areaOpacity=.1)}),a.info.stackedBar="1",a.info.stackedLine="1",a.info.isBox=!1),28===c&&(_.each(a.series,function(a,c){b&&c!==b||(a.seriesType="bar")}),a.info.stackedBar="1",a.info.stackedLine="1",a.info.isBox=!0),2===c&&(_.each(a.series,function(a,c){b&&c!==b||(a.seriesType="bar",a.areaOpacity=.1)}),a.info.stackedBar="2",a.info.isBox=!1,a.info.stackedLine="1"),21===c&&(_.each(a.series,function(a,c){b&&c!==b||(a.seriesType="bar",a.areaOpacity=.1)}),a.info.stackedBar="3",a.info.stackedLine="1",a.info.isBox=!1),3===c&&(_.each(a.series,function(a,c){b&&c!==b||(a.seriesType="line",a.lineType="line-dot-area",a.areaOpacity=.1)}),a.info.stackedBar="1",a.info.stackedLine="1",a.info.isBox=!1),4===c&&(_.each(a.series,function(a,c){b&&c!==b||(a.areaOpacity=.1,a.lineType="line-dot-area",a.seriesType="line")}),a.info.stackedBar="1",a.info.stackedLine="2",a.info.isBox=!1),22===c&&(_.each(a.series,function(a,c){b&&c!==b||(a.areaOpacity=.1,a.seriesType="line",a.lineType="line-dot-area")}),a.info.stackedBar="1",a.info.stackedLine="3",a.info.isBox=!1),5===c&&(_.each(a.series,function(a,c){b&&c!==b||(a.seriesType="line",a.lineType="line-area",a.areaOpacity=.4)}),a.info.stackedBar="1",a.info.stackedLine="1",a.info.isBox=!1),6===c&&(_.each(a.series,function(a,c){b&&c!==b||(a.seriesType="line",a.lineType="line-area",a.areaOpacity=.4)}),a.info.stackedBar="1",a.info.stackedLine="2",a.info.isBox=!1),23===c&&(_.each(a.series,function(a,c){b&&c!==b||(a.seriesType="line",a.lineType="line-area",a.areaOpacity=.4)}),a.info.stackedBar="1",a.info.stackedLine="3",a.info.isBox=!1),7===c&&(a.info.hole="0"),8===c&&(a.info.hole="50"),14===c&&(a.info.aggregation="-1"),29===c&&(a.info.aggregation="-1",a.info.selectable="edit"),13===c&&(a.info.aggregation="1"),15===c&&(a.info.type="combo"),16===c&&(a.info.type="multi"),17===c&&(a.info.type="datepicker"),18===c&&(a.info.type="datepicker-range"),19===c&&(a.info.type="slider"),20===c&&(a.info.type="text"),9===c&&(a.info.segmentType="singleSegment",a.info.style="arc"),24===c&&(a.info.segmentType="multiSegment",a.info.style="arc"),25===c&&(a.info.segmentType="singleSegment",a.info.style="horizontal"),26===c&&(a.info.segmentType="multiSegment",a.info.style="horizontal"),27===c&&(a.info.style="number",a.info.icons=a.info.icons||[{name:"icon warning"}],a.info.showLabels=!0),30===c&&(a.info.type="kpi-change"),31===c&&(a.info.type="apply-button"),app.charts.list&&_.each(app.charts.list,function(b){_.each(b.expandedChartType,function(d){d.type===c&&b.changeSeriesPropertyBaseOnExpandedType&&b.changeSeriesPropertyBaseOnExpandedType(a,c)})})},app.chartCommons.setDefault=function(a,b,c){var d=d3.scaleOrdinal(d3.schemeCategory10);_.isUndefined(b)||_.each(b,function(b,e){var f=d(e),g=c;a.series=a.series||{};var h={bar:{seriesColor:f,seriesType:"bar",formatString:",.0f",numberFactor:"1",showValues:!1,hidden:!1,cumulative:!1,cumulative_formula:"sum",lineFace:"5,0",lineWeight:"2",lineStyle:"linear",lineType:"line-dot-area",showValueColor:"#333333",areaOpacity:.1,formatStringCustom:",.0f",font:{bold:!1,color:"#333333",italic:!1,fontSize:"11px",fontName:"IRANSans",formatString:",.3s",formatStringCustom:",.0f"},top:{IsTop:!1,Top:10,IsPercent:!1,TopOrder:"DESC"}},map:{hidden:!1,formatString:",.0f",colorStart:"#31a354",colorEnd:"#c7e9c0",top:{IsTop:!1,Top:10,IsPercent:!1,TopOrder:"DESC"}},pie:{main:!0,numberFactor:"1",top:{IsTop:!1,Top:10,IsPercent:!1,TopOrder:"DESC"}},gauge:{type:"value",typeMs:"value",numberFactor:"1",top:{IsTop:!1,Top:10,IsPercent:!1,TopOrder:"DESC"}},radar:{numberFactor:"1",seriesColor:f,top:{IsTop:!1,Top:10,IsPercent:!1,TopOrder:"DESC"}},table:{numberFactor:"1",textAlign:"right",formatString:",.0f",fontSize:"14px",textItalic:!1,textBold:!1,color:"#000000",rowResult:"0",isHidden:!1,top:{IsTop:!1,Top:10,IsPercent:!1,TopOrder:"DESC"}},userControl:{numberFactor:"1",type:"value"},text:{}},i=!1;_.isUndefined(a.series[b])&&app.chartCommons.clicked===!0&&(i=!0,app.chartCommons.clicked=!1),a.series[b]=$.extend({},h[g],a.series[b]),i&&app.chartCommons.changeSeriesPropertyBaseOnExpandedType(a,b)})},app.chartCommons.commentUtils={getLabelsMeasures:function(a){var b=[],c=[],d=[];return a.matrix?(_.each(a.matrix,function(a){b.push(a.captions)}),_.each(a.series.labels,function(a){d.push(a)}),_.each(a.seriesLablesCaptions||a.series.labels,function(a){c.push(a)})):b=a.headers,{labels:b,measures:c,measuresKey:d}},getCommentCount:function(a,b,c){var d=b;return _.isArray(b)&&(d=_.sortBy(b).join(", ")),a.filter(function(a){return d===a.label&&a.measure===c}).length},getChartSelector:function(a){return".cid"+a},clickOnCommentIcon:function(a,b,c){$(app.chartCommons.commentUtils.getChartSelector(b)).trigger("new-comment",a);try{c.preventDefault(),c.stopPropagation(),d3.event.preventDefault(),d3.event.stopPropagation()}catch(c){}},highlight:function(a,b){var c=!1;_.each(a,function(a){a instanceof jQuery?a.removeClass("selected"):a.classed("selected",!1)}),_.each(a,function(a){if(c)return!1;if(a instanceof jQuery){var d=$(a[0]).data("table-data");return void a.each(function(a,e){var f=$(e).data("xrow"),g=$(e).data("xcol"),a=d.rows[f][g];if(b.category===a.category&&b.seriesLable===a.seriesLable)return d3.select(this).classed("selected",!0),c=!0,!1})}a.each(function(a){if(b.category===a.category&&b.seriesLable===a.seriesLable)return d3.select(this).classed("selected",!0),c=!0,!1})})},setOnHighlightListener:function(a,b){var c=$(app.chartCommons.commentUtils.getChartSelector(b)).data("collections")||[];c.push(a),$(app.chartCommons.commentUtils.getChartSelector(b)).data("collections",c),$(app.chartCommons.commentUtils.getChartSelector(b)).off("highlight-element"),$(app.chartCommons.commentUtils.getChartSelector(b)).on("highlight-element",function(a,c){if(c){var d=$(app.chartCommons.commentUtils.getChartSelector(b)).data("collections")||[];app.chartCommons.commentUtils.highlight(d,c)}})},destroyListener:function(a){$(app.chartCommons.commentUtils.getChartSelector(a)).data("collections",null)},addCommentIcon:function(a,b,c,d){if(app.commentOnChart){var e=$(app.chartCommons.commentUtils.getChartSelector(a)).find(".chart-data").data("settings");if(e.permissions.Comment){var f=b.append("g").attr("transform",function(a,b){return"translate("+c(a,b)+","+d(a,b)+")scale(0.38)"}).attr("class",function(a){return"comment"+(a.commentCount?" show":"")}).on("click",function(b,c){app.chartCommons.commentUtils.clickOnCommentIcon(c,a,b)}),g=f.append("rect");g.attrs({width:50,height:24,"class":"comment-background"}),f.append("path").attr("d","M10.718,18.561l6.78,5.311C17.609,23.957,17.677,24,17.743,24  c0.188,0,0.244-0.127,0.244-0.338v-5.023c0-0.355,0.233-0.637,0.548-0.637L21,18c2.219,0,3-1.094,3-2s0-13,0-14s-0.748-2-3.014-2  H2.989C0.802,0,0,0.969,0,2s0,13.031,0,14s0.828,2,3,2h6C9,18,10.255,18.035,10.718,18.561z"),f.append("text").text(function(a){return a.commentCount?persian(a.commentCount,!0):""}).attrs({x:34,y:"0.7em"}).styles({"font-size":"20px"})}}},updateIconCommentCount:function(a,b,c){function d(a){a.each(function(a){var d=_.sortBy(a.category).join(", ");a.seriesLable===b.measure&&d===b.label&&(d3.select(this).select("text").text(c?persian(c,!0):""),d3.select(this).classed("show",c>0))})}var e=$(app.chartCommons.commentUtils.getChartSelector(a)).data("collections")[0];if(e instanceof jQuery){var f=$(e[0]).data("table-data");return void e.each(function(){var d=$(this).data("xrow"),e=$(this).data("xcol"),g=f.rows[d][e],h=_.sortBy(g.category).join(", ");if(g.seriesLable===b.measure&&h===b.label){var i=$(app.chartCommons.commentUtils.getChartSelector(a)+" td[data-xcol="+e+"][data-xrow="+d+"]"),j=$(this).find(".comment"),k=i.find("svg:not(.td-comment) .comment");if(0===j.length){var l=$(app.chartCommons.commentUtils.getChartSelector(a)+" svg");j=l.clone().removeClass("td-comment"),k=l.clone().removeClass("td-comment"),$(this).append(j),i.append(k)}j.find(".comment").attr("class","comment show"),j.find("text").text(c?persian(c,!0):""),k.find(".comment").attr("class","comment show"),k.find("text").text(c?persian(c,!0):"")}})}var g=d3.selectAll(app.chartCommons.commentUtils.getChartSelector(a)+" .comment"),h=d3.selectAll("#"+app.chartCommons.commentUtils.getChartInModalSelector(a)+" .comment");d(h),d(g)},getChartInModalSelector:function(a){return"modal-chart-container-"+a},showLastVersionChart:function(){}},app.chartCommons.renderComments=function(a,b){function c(){var a='<div class="ui fuild modal '+u.substring(1,1e3)+' rtl"  style="cursor: initial;">     <i class="close icon"></i>     <div class="header">نسخه قبلی نمودار</div>     <div class="content" id="'+u.substring(1,1e3)+'" style="height:350px">         <div class="ui active inverted dimmer"><div class="ui text loader">آماده‌سازی نمودار</div></div>     </div></div>';if(0===$(u).length){var b=$(a);$("body").append(b),b.modal({allowMultiple:!0,onVisible:function(){app.chartCommons.commentUtils.showLastVersionChart()},onHidden:function(){$(u+" .content").html('<div class="ui active inverted dimmer"><div class="ui text loader">آماده‌سازی نمودار</div></div>')}})}}function d(a){return filterXSS('<div class="ui mini label value comment-value" data-label="'+a.label+'" data-measure="'+a.measure+'" data-value="'+a.value+'" style="">  '+a.measure+" در "+a.label+": "+persian(d3.format(",.2f")(a.value),!0)+"</div>")}function e(a){var c="";return+a.chartVersion!==+b.version&&(c=persian(" نسخه "+a.chartVersion+" نمودار ",!0),c='            <span class="version pointer" style="color:red;" data-version="'+a.chartVersion+'">'+c+"</span>"),'<div class="comment" data-id="'+a.id+'">    <div class="content">        <span class="author">'+a.username+'</span>        <span class="value-string">'+d(a)+'</span>        <div class="metadata">            <span class="date">'+moment(a.time).fromNow()+"</span>"+c+'        </div>        <div class="text">            <span class="comment-text">'+filterXSS(a.comment)+'            </span>            <span class="auto-hide animated ">            <a class="reply pointer metadata"> پاسخ </a>'+(a.userId===app.userId?'            <a class="edit pointer metadata"> ویرایش </a>':"")+(a.userId===app.userId?'            <a class="remove pointer metadata"> حذف </a>':"")+'            </span>        </div>        <div class="actions">        </div>    </div>'+(a.childs&&a.childs.length?f(a.childs):"")+"</div>"}function f(a,b){var c=(a||[]).map(e,b).join("");return'<div class="ui tiny relaxed threaded comments '+(b?" root":"")+'" '+(b?'style=" '+(v?"":"min-height:"+s+"px; overflow:auto;")+'   flex-grow: 1;flex-shrink: 1;flex-basis: 0px;"':"")+">"+c+"</div>"}function g(c){var d=b.FinalWhereList.map(function(a){var b='<div class="ui orange mini label"><span>'+a.Key.replace(/\[id\d+\].\[(.*)\]/,"$1")+': </span><span style="font-weight:200;">'+a.Value.join(",")+"</span></div>";return b}).join(""),e=f(c,!0),g='<form class="ui tiny form">  <div class="final-where">'+filterXSS(d)+'</div>  <div class="comment-modal-value"><span class="measure-value"></span> در <span class="label-value"></span>  <span class="value-value"></span></div>  <div class="field">    <textarea type="text"  rows="1" placeholder="'+app.lang.translate("new comment")+'"></textarea>  </div></form>';return'<div class="ui modal comment-modal comment-section rtl modal'+a.ChartInPageId+'" style="cursor: initial;">     <i class="close icon"></i>     <div class="header">'+app.lang.translate("commenting")+'</div>     <div class="content '+(v?"scrolling":"")+'" style="padding:0">         <div class="ui mobile reversed stackable padded grid">             <div class="six wide column" '+(v?"":'style="border-left: 1px solid #dcddde;display: flex;flex-direction: column;justify-content: flex-end;"')+">"+e+'     <div class="header" style="flex"></div>'+g+'             </div>             <div class="six wide column chart-container" id="'+q+'" >                   <div class="ui active inverted dimmer"><div class="ui text loader">'+app.lang.translate("preparing chart")+"</div></div>             </div>         </div>     </div></div>"}function h(){A.find(".selected-comment").remove(),A.find(".selected-comment-edit").remove(),B.val(null)}function i(a,c){if(!a||!c)return"";var d=x.indexOf(a),e=y.indexOf(c),f=b.series.data[d][e];return f}function j(a){B.val(a.comment),!a.seriesLable;var b=i(a.seriesLable,a.measure);F.data("v",a.seriesLable),E.data("v",a.measure),B.focus(),D.hide(),a.seriesLable&&(D.show(),F.text(a.seriesLable),E.text(a.measure),G.text(persian(d3.format(",.2f")(b),!0)))}function k(c){c.find(".version").on("click",function(){var b=$(this).data("version");app.chartCommons.commentUtils.showLastVersionChart=function(){$(u+" .content").charts(a.type,{id:u.substring(1,1e3),parameters:{type:a.dataType,fromCommentDialog:!0,lastVersionInfo:{version:b,lastVersionChartId:a.chartId}}})},$(u).modal("show")}),c.find(".reply").on("click",function(){var a=$(this).parents(".comment").data("id");h(),$selectedComment=$('<div class="ui mini label selected-comment field" data-id="'+a+'">پاسخ به '+a+' <i class="icon close" style="margin:0;"/>  </div>'),A.find(".ui.form").prepend($selectedComment),$selectedComment.find(".icon").on("click",h),B.focus()}),c.find(".edit").on("click",function(){var a=$(this).parents(".comment").data("id"),b=$(this).parents(".comment").first();h(),$selectedComment=$('<div class="ui mini label selected-comment-edit field" data-id="'+a+'"> ویرایش '+a+' <i class="icon close" style="margin:0;"/>  </div>'),A.find(".ui.form").prepend($selectedComment),$selectedComment.find(".icon").on("click",h),j({comment:b.find(".comment-text").first().text().trim(),label:b.find(".value").first().data("label"),measure:b.find(".value").first().data("measure")})}),c.find(".remove").on("click",function(){var c=$(this).parents(".comment").data("id"),d=$(this).parents(".comment").first(),e=confirm("در صورت حذف کامنت تمام پاسخ‌ها نیز حذف می‌شوند. آیا برای حذف اطمینان دارید؟");if(e){var f=app.urlPrefix+"api/chartComments/Delete?id="+c;$.post(f).done(function(e){d.transition("scale");var f=null;if(_.each(t,function(a){a.id===c&&(f=a)}),l(b.comment,c,function(a,b,d){b.id===c&&a.splice(d,1)}),f){var g=app.chartCommons.commentUtils.getCommentCount(t,e.label,e.measure);app.chartCommons.commentUtils.updateIconCommentCount(a.ChartInPageId,e,g)}})}})}function l(a,b,c){var d=null,e=0;return _.each(a,function(f){if(c&&c(a,f,e),f.id===b)return d=f,!1;var g=l(f.childs,b);return g?(d=g,!1):void e++}),d}function m(a){A.find(" .root.comments > .comment").hide(),_.each(a,function(a){A.find(" .root.comments > .comment[data-id="+a.id+"]").show()})}function n(a){var b=_.sortBy(a.category).join(", ");return t.filter(function(c){return b===c.label&&a.seriesLable===c.measure})}function o(){var c=_.extend({},a);c.id=q,c.fromCommentDialog=!0,$("#"+c.id).empty(),app.chartCommons.commentUtils.destroyListener(c.ChartInPageId),app.chartCommons.draw(c.type,b,c,!1),$("#"+q).on("select-series",function(a,b){j({comment:"",label:b.category,measure:b.seriesLable,measureKey:b.seriesKey}),m(n(b))})}if(app.commentOnChart&&a.permissions.Comment&&b.FinalWhereList){var p=app.chartCommons.commentUtils.getChartSelector(a.ChartInPageId),q=app.chartCommons.commentUtils.getChartInModalSelector(a.ChartInPageId),r=$(p+" .show-chart-comments"),s=300;$(p+" .comment-section").remove();var t=b.comment;if(!a.fromCommentDialog){var u=".last-version-modal";$(".comment-modal.modal"+a.ChartInPageId).remove(),$(p).off("new-comment"),r.off("click"),c();var v=$(window).width()<768;if(t){moment.locale("fa"),$(p).data("init-befor",!0);var w=app.chartCommons.commentUtils.getLabelsMeasures(b),x=w.labels,y=w.measures,z=w.measuresKey,A=$(g(t)),B=A.find("textarea"),C=A.find(".button"),D=(A.find(".chart-container"),A.find(".comment-modal-value")),E=A.find(".measure-value"),F=A.find(".label-value"),G=A.find(".value-value"),H=function(){function b(b){C.removeClass("loading"),B.val(null),h(),t=t||[];var c=l(t,o);if(c)c.childs=c.childs||[],c.childs.push(b);else{t.push(b);var d=app.chartCommons.commentUtils.getCommentCount(t,b.label,b.measure);app.chartCommons.commentUtils.updateIconCommentCount(a.ChartInPageId,b,d)}var g=A.find(".comments.root");if(o){if($parentComment=A.find(".comment[data-id="+o+"] .comments"),0===$parentComment.length){$parentComment=A.find(".comment[data-id="+o+"]");var i=$(f());$parentComment.append(i),$parentComment=i}g=$parentComment}var j=$(e(b));g.append(j),k(j),setTimeout(function(){var a=A.find(".root.comments [data-id="+b.id+"]"),c=A.find(".root.comments");c.animate({scrollTop:c.scrollTop()+a.offset().top-c.height()+a.height()
},400),setTimeout(function(){a.transition("pulse")},400)},400)}var c=F.data("v"),g=E.data("v");if(_.isArray(c)||(c=[c]),_.isArray(g)&&(g=g[0]),_.isEmpty(B.val()))return void alert("کامنت خود را بنویسید");if(_.isEmpty(c))return void alert("یکی از ردیف‌های اطلاعاتی را انتخاب کنید");if(_.isEmpty(g))return void alert("یکی از داده‌ها را انتخاب کنید");var j=i(c,g),m=$(p+" .chart-data").data("settings"),n=app.chartCommons.getFilterParameter(m.ChartInPageId,m.input.RefreshDatasource),o=A.find(".selected-comment").data("id"),q=A.find(".selected-comment-edit").data("id"),r=_.sortBy(c).join(", "),s={where:m.input.FinalWhereList,chartId:m.chartId,dashboardId:dashboard.pageId,datasourceId:m.input.DataSourceId,dimention:m.input.CurrentDimName,input:JSON.stringify(m.input),drillDown:n.drillDown,otherFilters:n.otherFilters,userControlFilter:n.userControlFilter,userVariable:n.userVariable,comment:B.val().trim(),parentId:o,label:r,measure:g,value:j};return C.addClass("loading"),q?void $.post(app.urlPrefix+"api/ChartComments/edit?id="+q+"&text="+B.val().trim()+"&label="+c+"&measure="+g+"&value="+j).done(function(a){C.removeClass("loading"),h(),B.val(null);var b=A.find(".comment[data-id="+q+"]").first(),c=A.find(".comment[data-id="+q+"] .comment-text").first(),e=A.find(".comment[data-id="+q+"] .value-string").first();c.text(a.comment),e.html(d(a)),setTimeout(function(){b.transition("pulse")},400)}).fail(function(a){C.removeClass("loading")}):(console.log("######",{"":JSON.stringify(s)}),void $.ajax({type:"POST",url:app.urlPrefix+"api/ChartComments/save",data:s,success:b,error:function(a){C.removeClass("loading")}}))},I={type:"modal",render:function(){$(p).append(A),k(A),B.on("keyup",function(a){return 13===a.keyCode&&a.ctrlKey?void B.val(B.val()+"\n"):void(13===a.keyCode&&H())}),"modal"===this.type&&(A.modal({allowMultiple:!0,onVisible:function(){o(),$(app.chartCommons.commentUtils.getChartSelector(a.ChartInPageId)).trigger("highlight-element",[I.highlightedValue])}}),r.on("click",function(){var a={category:x[0],seriesLable:y[1],seriesLablekey:z[1]};$(p).trigger("new-comment",a)})),"popup"===this.type&&r.popup({popup:$(p+" .popup.ui"),target:$(p+" .ui.card .content"),title:"کامنت‌ها",position:"top right",boundary:$(".main-container"),on:"click",lastResort:!0,prefer:"opposite",onShow:function(a,b){$(p+" .menu-bar").addClass("show-dropdown")},onVisible:function(){$parentDiv=$(".main-container.full-height-container"),$innerListItem=A,$parentDiv.animate({scrollTop:$parentDiv.scrollTop()-$parentDiv.height()+$innerListItem.offset().top+$innerListItem.height()+40},400)},onHide:function(a,b){$(p+" .menu-bar").removeClass("show-dropdown")}})},show:function(){"modal"===this.type&&A.modal("show"),"popup"===this.type&&r.popup("show")}};I.render(),$(p).on("new-comment",function(a,b){j({comment:"",seriesLable:b.category,measure:b.seriesLable,measureKey:b.seriesKey}),m(n(b)),I.highlightedValue=b,I.show(),$(p).trigger("highlight-element",[I.highlightedValue])})}}}},jQuery.fn.extend({lazyDropdown:function(a){return this.each(function(){var b=$(this);b.on("click",function(c){b.data("init-dd")||(c.stopPropagation(),c.preventDefault(),b.data("init-dd",!0),b.dropdown(a),b.click())})})}}),app.chartCommons.indicator={ifToString:function(a,b,c,d){var e={1:"برابر باشد با",2:"مخاف باشد با",3:"کوچک تر باشد از",4:"کوچکتر یا مساوی باشد از",5:"بزرگ‌تر باشد از",6:"بزرگ‌تر یا مساوی باشد از",7:"شامل",8:"عدم شمول"},f=function(a){if(b&&c){var e=b.indexOf(a),f=d.chartProp.series[a]=d.chartProp.series[a]||{};return f.name||c[e]}},g=_.map(a,function(a){return""+f(a.firstField)+" "+e[a.operand]+" "+(a.secondFieldIsText?a.secondFieldInput:""+f(a.secondFieldSelect))});return g.join(" و ")},checkRow:function(a,b,c){var d=c.indexOf(a.firstField);if(d===-1)return!1;try{b[d]}catch(e){}var f=b[d],g=0;if(a.secondFieldIsText)g=a.secondFieldInput;else{var h=c.indexOf(a.secondFieldSelect);if(h===-1)return!1;g=b[h]}switch(f=depersian(f),g=depersian(g),isNaN(g)||(g=+g),isNaN(f)||(f=+f),+a.operand){case 1:return f===g;case 2:return f!==g;case 3:return f>g;case 4:return f>=g;case 5:return f<g;case 6:return f<=g;case 7:return f.indexOf(g)>-1;case 8:return f.indexOf(g)<=-1}},getIndicator:function(a,b,c){var d=[],e=b;return c&&c.forEach(function(b,c){var f=!0;if($.each(b.ifRow,function(b,c){if(!app.chartCommons.indicator.checkRow(c,a,e))return f=!1,!1}),f){var g=JSON.parse(JSON.stringify(b.thenRow));_.each(g,function(a){a.index=c}),d.push(g)}}),d},getStripedColor:function(a,b,c){var d="diagonalHatch"+c;return a&&!a.select("#"+d).node()&&a.append("g").html('<pattern id="'+d+'" width="10" height="10" patternTransform="rotate(45 0 0)" patternUnits="userSpaceOnUse">                                                  <line x1="0" y1="0" x2="0" y2="10" style="stroke: '+b+';stroke-width: 4px;"></line>                                              </pattern>'),"url(#"+d+")"}},function(){var a="undefined"!=typeof exports&&exports||"undefined"!=typeof define&&{}||this||window;"undefined"!=typeof define&&define("save-svg-as-png",[],function(){return a});var b="http://www.w3.org/2000/xmlns/",c='<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd" [<!ENTITY nbsp "&#160;">]>',d=/url\(["']?(.+?)["']?\)/,e={woff2:"font/woff2",woff:"font/woff",otf:"application/x-font-opentype",ttf:"application/x-font-ttf",eot:"application/vnd.ms-fontobject",sfnt:"application/font-sfnt",svg:"image/svg+xml"},f=function(a){return a instanceof HTMLElement||a instanceof SVGElement},g=function(a){if(!f(a))throw new Error("an HTMLElement or SVGElement is required; got "+a)},h=function(a){return a&&0===a.lastIndexOf("http",0)&&a.lastIndexOf(window.location.host)===-1},i=function(a){var b=Object.keys(e).filter(function(b){return a.indexOf("."+b)>0}).map(function(a){return e[a]});return b?b[0]:(console.error("Unknown font format for "+a+". Fonts may not be working correctly."),"application/octet-stream")},j=function(a){for(var b="",c=new Uint8Array(a),d=0;d<c.byteLength;d++)b+=String.fromCharCode(c[d]);return window.btoa(b)},k=function(a,b,c){var d=a.viewBox&&a.viewBox.baseVal&&a.viewBox.baseVal[c]||null!==b.getAttribute(c)&&!b.getAttribute(c).match(/%$/)&&parseInt(b.getAttribute(c))||a.getBoundingClientRect()[c]||parseInt(b.style[c])||parseInt(window.getComputedStyle(a).getPropertyValue(c));return"undefined"==typeof d||null===d||isNaN(parseFloat(d))?0:d},l=function(a,b,c,d){if("svg"===a.tagName)return{width:c||k(a,b,"width"),height:d||k(a,b,"height")};if(a.getBBox){var e=a.getBBox(),f=e.x,g=e.y,h=e.width,i=e.height;return{width:f+h,height:g+i}}},m=function(a){return decodeURIComponent(encodeURIComponent(a).replace(/%([0-9A-F]{2})/g,function(a,b){var c=String.fromCharCode("0x"+b);return"%"===c?"%25":c}))},n=function(a){for(var b=window.atob(a.split(",")[1]),c=a.split(",")[0].split(":")[1].split(";")[0],d=new ArrayBuffer(b.length),e=new Uint8Array(d),f=0;f<b.length;f++)e[f]=b.charCodeAt(f);return new Blob([d],{type:c})},o=function(a,b){if(b)try{return a.querySelector(b)||a.parentNode&&a.parentNode.querySelector(b)}catch(c){console.warn('Invalid CSS selector "'+b+'"',c)}},p=function(a,b){var c=a.cssText.match(d),e=c&&c[1]||"";if(e&&!e.match(/^data:/)&&"about:blank"!==e){var f=e.startsWith("../")?b+"/../"+e:e.startsWith("./")?b+"/."+e:e;return{text:a.cssText,format:i(f),url:f}}},q=function(a){return Promise.all(Array.from(a.querySelectorAll("image")).map(function(a){var b=a.getAttributeNS("http://www.w3.org/1999/xlink","href")||a.getAttribute("href");return b?(h(b)&&(b+=(b.indexOf("?")===-1?"?":"&")+"t="+(new Date).valueOf()),new Promise(function(c,d){var e=document.createElement("canvas"),f=new Image;f.crossOrigin="anonymous",f.src=b,f.onerror=function(){return d(new Error("Could not load "+b))},f.onload=function(){e.width=f.width,e.height=f.height,e.getContext("2d").drawImage(f,0,0),a.setAttributeNS("http://www.w3.org/1999/xlink","href",e.toDataURL("image/png")),c(!0)}})):Promise.resolve(null)}))},r={},s=function(a){return Promise.all(a.map(function(a){return new Promise(function(b,c){if(r[a.url])return b(r[a.url]);var e=new XMLHttpRequest;e.addEventListener("load",function(){var c=j(e.response),f=a.text.replace(d,'url("data:'+a.format+";base64,"+c+'")')+"\n";r[a.url]=f,b(f)}),e.addEventListener("error",function(c){console.warn("Failed to load font from: "+a.url,c),r[a.url]=null,b(null)}),e.addEventListener("abort",function(c){console.warn("Aborted loading font from: "+a.url,c),b(null)}),e.open("GET",a.url),e.responseType="arraybuffer",e.send()})})).then(function(a){return a.filter(function(a){return a}).join("")})},t=null,u=function(){return t?t:t=Array.from(document.styleSheets).map(function(a){try{return{rules:a.cssRules,href:a.href}}catch(b){return console.warn("Stylesheet could not be loaded: "+a.href,b),{}}})},v=function(a,b){var c=b||{},d=c.selectorRemap,e=c.modifyStyle,f=c.modifyCss,g=c.fonts,h=f||function(a,b){var c=d?d(a):a,f=e?e(b):b;return c+"{"+f+"}\n"},i=[],j="undefined"==typeof g,k=g||[];return u().forEach(function(b){var c=b.rules,d=b.href;c&&Array.from(c).forEach(function(b){if("undefined"!=typeof b.style)if(o(a,b.selectorText))i.push(h(b.selectorText,b.style.cssText));else if(j&&b.cssText.match(/^@font-face/)){var c=p(b,d);c&&k.push(c)}else i.push(b.cssText)})}),s(k).then(function(a){return i.join("\n")+a})};a.prepareSvg=function(a,c,d){g(a);var e=c||{},f=e.left,h=void 0===f?0:f,i=e.top,j=void 0===i?0:i,k=e.width,m=e.height,n=e.scale,o=void 0===n?1:n,p=e.responsive,r=void 0!==p&&p;return q(a).then(function(){var e=a.cloneNode(!0),f=c||{},g=f.backgroundColor,i=void 0===g?"transparent":g;e.style.backgroundColor=i;var n=l(a,e,k,m),p=n.width,q=n.height;if("svg"!==a.tagName){if(!a.getBBox)return void console.error("Attempted to render non-SVG element",a);e.setAttribute("transform",e.getAttribute("transform").replace(/translate\(.*?\)/,""));var s=document.createElementNS("http://www.w3.org/2000/svg","svg");s.appendChild(e),e=s}return e.setAttribute("version","1.1"),e.setAttribute("viewBox",[h,j,p,q].join(" ")),e.getAttribute("xmlns")||e.setAttributeNS(b,"xmlns","http://www.w3.org/2000/svg"),e.getAttribute("xmlns:xlink")||e.setAttributeNS(b,"xmlns:xlink","http://www.w3.org/1999/xlink"),r?(e.removeAttribute("width"),e.removeAttribute("height"),e.setAttribute("preserveAspectRatio","xMinYMin meet")):(e.setAttribute("width",p*o),e.setAttribute("height",q*o)),Array.from(e.querySelectorAll("foreignObject > *")).forEach(function(a){a.getAttribute("xmlns")||a.setAttributeNS(b,"xmlns","http://www.w3.org/1999/xhtml")}),v(a,c).then(function(a){var b=document.createElement("style");b.setAttribute("type","text/css"),b.innerHTML="<![CDATA[\n"+a+"\n]]>";var c=document.createElement("defs");c.appendChild(b),e.insertBefore(c,e.firstChild);var f=document.createElement("div");f.appendChild(e);var g=f.innerHTML.replace(/NS\d+:href/gi,'xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href');return"function"!=typeof d?{src:g,width:p,height:q}:void d(g,p,q)})})},a.svgAsDataUri=function(b,d,e){g(b);var f=a.prepareSvg(b,d).then(function(a){var b=a.src,d=a.width,f=a.height,g="data:image/svg+xml;base64,"+window.btoa(m(c+b));return"function"==typeof e&&e(g,d,f),g});return f},a.svgAsPngUri=function(b,c,d){g(b);var e=c||{},f=e.encoderType,h=void 0===f?"image/png":f,i=e.encoderOptions,j=void 0===i?.8:i,k=e.canvg,l=function(a){var b=a.src,c=a.width,e=a.height,f=document.createElement("canvas"),g=f.getContext("2d"),i=window.devicePixelRatio||1;f.width=c*i,f.height=e*i,f.style.width=f.width+"px",f.style.height=f.height+"px",g.setTransform(i,0,0,i,0,0),k?k(f,b):g.drawImage(b,0,0);var l=void 0;try{l=f.toDataURL(h,j)}catch(m){if("undefined"!=typeof SecurityError&&m instanceof SecurityError||"SecurityError"===m.name)return void console.error("Rendered SVG images cannot be downloaded in this browser.");throw m}return"function"==typeof d&&d(l,f.width,f.height),Promise.resolve(l)};return k?a.prepareSvg(b,c).then(l):a.svgAsDataUri(b,c).then(function(a){return new Promise(function(b,c){var d=new Image;d.onload=function(){return b(l({src:d,width:d.width,height:d.height}))},d.onerror=function(){c("There was an error loading the data URI as an image on the following SVG\n"+window.atob(a.slice(26))+"Open the following link to see browser's diagnosis\n"+a)},d.src=a})})},a.download=function(a,b){if(navigator.msSaveOrOpenBlob)navigator.msSaveOrOpenBlob(n(b),a);else{var c=document.createElement("a");if("download"in c){c.download=a,c.style.display="none",document.body.appendChild(c);try{var d=n(b),e=URL.createObjectURL(d);c.href=e,c.onclick=function(){return requestAnimationFrame(function(){return URL.revokeObjectURL(e)})}}catch(f){console.warn("This browser does not support object URLs. Falling back to string URL."),c.href=b}c.click(),document.body.removeChild(c)}else window.open(b,"_temp","menubar=no,toolbar=no,status=no")}},a.saveSvg=function(b,c,d){g(b),a.svgAsDataUri(b,d||{},function(b){return a.download(c,b)})},a.saveSvgAsPng=function(b,c,d){g(b),a.svgAsPngUri(b,d||{},function(b){return a.download(c,b)})}}(),app.chartCommons.exportPng={svgString2Image:function(a,b,c,d,e){var f=document.createElement("canvas"),g=f.getContext("2d");f.width=b,f.height=c;var h=$('<div class="bar-chart"><img /></div>'),i=h.find("img").get(0);i.onload=function(){g.clearRect(0,0,b,c),g.drawImage(i,0,0,b,c),f.toBlob(function(a){var b=Math.round(a.length/1024)+" KB";e&&e(a,b)})},i.src=a},getSVGString:function(a){var b='<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">',c=(new XMLSerializer).serializeToString(a),d=new Blob([b+c],{type:"image/svg+xml;charset=utf-8"}),e=window.URL.createObjectURL(d);return e}},app.chartCommons.getChartConfig=function(a,b){if(a>10)return _.extend({},_.find(app.charts.list,{type:a}).config);switch(+a){case chartTypes.UserControl:return"apply-button"===b.type?{needDim:!1,needMeasure:!1,needServerData:!1,noTitle:!0}:"datepicker"===b.type||"datepicker-range"===b.type||"text"===b.type?{needDim:!0,needMeasure:!1,needServerData:!0}:{needDim:!0,needMeasure:!1,needServerData:!0};case chartTypes.Tree:return{needDim:!0,needMeasure:!1,needServerData:!0};case chartTypes.TABLE:return+b.aggregation===-1?{needDim:!1,needMeasure:!1,needServerData:!0}:{needDim:!1,needMeasure:!0,needServerData:!0};default:return{needDim:!1,needMeasure:!0,needServerData:!0}}},d3.selection.prototype.legend=function(a,b){a.order=a.order||"horizental",a.colorPos=a.colorPos||"left",a.font=a.font||{},a.click=a.click||function(){};var c={"top right":"legend-top-right","top left":"legend-top-left","top center":"legend-top-center","bottom right":"legend-bottom-right","bottom left":"legend-bottom-left","bottom center":"legend-bottom-center","center right":"legend-center-right","center left":"legend-center-left"};a.position=a.position||"top left";var d={},e=this.append("div").attr("class","legend-div temporal ").append("div").attr("class","list-inline "+c[a.position]).styles(d),f=e.selectAll("nothingd").data(a.data).enter().append("span").style("font-size",a.font.fontSize||"9px").style("font-family",a.font.fontName||"IRANSans").style("font-weight",a.font.bold?"bold":"300").style("font-style",a.font.italic?"italic":"inherit").style("color",a.font.color||"#333333").attr("class","pointer legend-item");f.on("click",function(b,c){var d=f.nodes().indexOf(this);a.selector&&$(a.selector).trigger("legendClick",[c.label,d,c]),a.click(c,d)}),f.append("span").classed("text inline ltr",!0).text(function(a){return persian(a.label,b)}),"vertical"===a.order&&f.style("display","block");var g;return"left"===a.colorPos?g=f.append("span"):(g=f.insert("span",".text"),f.style("text-align","right")),g.attr("class","legend-color").style("background-color",function(a){return a.color}).style("-webkit-print-color-adjust","exact"),e},d3.selection.prototype.breadcrumb=function(a,b,c,d){var e=a.slice(0);"undefined"!=typeof e[0]&&null!==e[0]&&e.unshift(app.lang.translate("پاک کردن"));var f=e[e.length-1];if(e.splice(e.length-1,1),e.length>0){var g=function(a,d){var f=$("#"+b.id).hasClass("fromCommentDialog");if(!f){var g=c.isProgress,h=c.showProgress;if(!g()){h(!0);var i=app.chartCommons.drillDown.up(b.ChartInPageId,e.length-d);b.parameters={drillDown:i,isUp:!0,upLevel:e.length-d,chartId:b.chartId,ChartInPageId:b.ChartInPageId},b.drill="up",app.chartCommons.levelTypeUtils.getParam(b),$("#"+b.id).charts(b.type,"refreshWithData",b)}}},h='<div class="ui mini breadcrumb floated right temporal">'+e.map(function(a){return'<a class="section clickable">'+a+"</a>"}).join('<i class="'+(app.lang.isRtl()?"left":"right")+' arrow icon divider"></i>')+'<i class="'+(app.lang.isRtl()?"left":"right")+' arrow icon divider"></i><div class="section active">'+f+"</div></div>";return $(this._groups[0][0]).append(h),void $(this._groups[0][0]).find(".breadcrumb .clickable").each(function(a,b){$(this).on("click",function(){g(0,a)})})}},d3.selection.prototype.titlebar=function(a){var b,c=this,d=$(c._groups[0][0]),e=function(){return"visible"==d.find(".myprogress").css("visibility")},f=d.parents(".ui.card").find(".progress-overall"),g=function(a){a?(d.find("*").attr("disabled",!0),d.find(".myprogress").css("visibility","visible"),f.fadeIn()):(d.find("*").attr("disabled",!1),d.find(".myprogress").css("visibility","hidden"),f.fadeOut())};return{title:b,showProgress:g,isProgress:e}};var d3Utils={prepareDataForBarChart:function(a,b,c,d,e,f){var g=d3.scaleOrdinal(d3.schemeCategory10);$.each(a,function(a,h){if(!h.kpis)return!0;var i=[];return $.each(h.kpis,function(a,c){var e=b.chartProp.series[d[a]]||b.chartProp.series["default"];g(a);"undefined"==typeof e&&"undefined"!=typeof model&&(e=$.extend(!0,{},"undefined"!=typeof model.seriesProp[d[a]]?model.seriesProp[d[a]]:model.seriesProp["default"]),e.seriesColor=g(a)),i.push({data:c,prop:e,key:d[a],label:f&&f.length>a?f[a]:d[a],type:"kpi",seriesLable:f&&f.length>a?f[a]:d[a],type:"kpi",seriesKey:d[a],category:h.label})}),!h.series||($.each(h.series,function(a,d){var f=b.chartProp.series[c[a]],g=""===d||null===d||isNaN(d),j={type:"series",data:g?d:d*parseFloat(f.numberFactor),prop:f,key:c[a],label:e&&e.length>a?e[a]:c[a],seriesLable:e&&e.length>a?e[a]:c[a],seriesKey:c[a],category:h.label};j.commentCount=app.chartCommons.commentUtils.getCommentCount(b.input.comment,j.category,j.label),i.push(j)}),void(h.series=i))});var h=[],i=[];a.length&&(_.each(a[0].series,function(b,c){if(b.prop.trendLine&&b.prop.trendLine.enable&&i.indexOf(b.seriesLable+"-trend")==-1){var d=_.map(a,function(a){return a.series[c].data});i.push(b.seriesLable+"-trend"),h.push({data:d,config:b.prop.trendLine})}}),_.each(h,function(c,d){var e=b.chartProp.series[i[d]];e||(e=b.chartProp.series["default"]||_.merge({},b.chartProp.series[Object.keys(b.chartProp.series)[0]])||{},e.seriesColor=g(d+a[0].series.length),e.seriesType="line",e.lineType="line",e.showValues=!1,b.chartProp.series[i[d]]=e);var f=0;c.config.formula=c.config.formula||"avg","max"===c.config.formula&&(f=d3.max(c.data)),"min"===c.config.formula&&(f=d3.min(c.data)),"avg"===c.config.formula&&(f=d3.sum(c.data)/c.data.length),_.each(a,function(a,b){var c=_.merge({},a.series[0]);c.prop=e,c.data=f,c.commentCount=0,c.seriesKey=i[d],c.seriesLabel=i[d],c.key=i[d],c.label=i[d],a.series.push(c)})})),_.each(i,function(a){c.indexOf(a)==-1&&(c.push(a),e.push(a))})},convertToKeyValue:function(a){var b=_.map(a.series.labels,function(b,c){var d=a.seriesLablesCaptions&&a.seriesLablesCaptions.length>c;return{key:b,value:d?a.seriesLablesCaptions[c]:b}}),c=_.map(a.kpis.labels,function(b,c){var d=a.kpisLablesCaptions&&a.kpisLablesCaptions.length>c;return{key:b,value:d?a.kpisLablesCaptions[c]:b}});return{seriesLabels:b,kpiLabels:c}}},app=app||{};app.helper=app.helper||{},function(){function a(a){for(var d=0;d<a.length;d++)for(var e=0;e<b.length;e++)a.charAt(d)===b[e]&&(a=a.replace(a.charAt(d),c[e]));return a}var b=["ي","إ","ؤ","أ","ي","ك"],c=["ی","ا","و","ا","ی","ک"];app.helper.filterMemberDialogOk=function(){var a=$("#filter-member-dialog").data("data");$("#filter-member-dialog .li ").each(function(b,c){var d=$(this).find("input"),e=$.grep(a.members,function(a){return a.Uniquename==d.attr("value")})[0];e.IsChecked=d.prop("checked")}),a.onfinish(a.members),$("#filter-member-dialog").modal("hide")},app.helper.filterMemberDialog=function(b,c,d){function e(a,b,c){var d='<div class=" " style="height:50vh; overflow:auto;"> '+b.map(function(a,b){return'<div class="li"><input value="'+a.Uniquename+'" type="checkbox" id="member-'+b+'" '+(a.IsChecked?" checked ":"")+' /> <label class="unstyled-lable" for="member-'+b+'">'+a.Caption+"</label></div>"}).join("")+"</div>";c.find(".member-list").html(d),$("#filter-member-dialog").modal("refresh")}var f=function(d){var f=window.innerHeight,g=$("#filter-member-dialog").outerHeight(),h=f-g-50;body='<div class="ui form"><input type="text" class="form-control" id="filter-member-search" placeholder="جستجو"></div>                    <input id="select-all-member-filter" type="checkbox" style="margin-top:10px"/><label style="margin-right:5px;" for="select-all-member-filter"> همه </label>                    <div class="member-list"></div>';var i=$("#filter-member-dialog #filter-member-dialog-content");i.html(body),$("#select-all-member-filter").change(function(){var a=this.checked;$("#filter-member-dialog .member-list .li input").filter(function(){return $(this).is(":visible")}).prop("checked",a)}),e(h,b,i);var j;$("#filter-member-dialog #filter-member-search").keyup(function(){var b=$(this).val().toLowerCase();if(b=a(b),c){if(b&&1==b.length)return;clearTimeout(j),j=setTimeout(function(){$.ajax(c+"&query="+b).done(function(a){var b=$("#filter-member-dialog").data("data");b.members=a,e(h,a,i)})},400)}else $("#filter-member-dialog li").show(),$("#filter-member-dialog li").filter(function(){var c=$(this).text().toLowerCase();return c=a(c),c.indexOf(b.toLowerCase())==-1}).hide()})};$("#filter-member-dialog").modal({onVisible:f}).modal("show"),$("#filter-member-dialog").data("data",{members:b,onfinish:d}),$("#filter-member-dialog").modal("show")}}($),function(a){function b(a,b){return"function"==typeof a?a.call(b):a}function c(b,c){this.$element=a(b),this.options=c,this.enabled=!0,this.fixTitle()}c.prototype={show:function(){var c=this.getTitle();if(c&&this.enabled){var d=this.tip();d.find(".tipsy-inner")[this.options.html?"html":"text"](c),d[0].className="tipsy",d.remove().css({top:0,left:0,visibility:"hidden",display:"block"}).appendTo(document.body);var e=a.extend({},this.$element.offset(),{width:this.$element[0].offsetWidth||0,height:this.$element[0].offsetHeight||0});if("object"==typeof this.$element[0].nearestViewportElement){var f=this.$element[0],g=f.getBoundingClientRect();e.width=g.width,e.height=g.height}var h,i=d[0].offsetWidth,j=d[0].offsetHeight,k=b(this.options.gravity,this.$element[0]);switch(k.charAt(0)){case"n":h={top:e.top+e.height+this.options.offset,left:e.left+e.width/2-i/2};break;case"s":h={top:e.top-j-this.options.offset,left:e.left+e.width/2-i/2};break;case"e":h={top:e.top+e.height/2-j/2,left:e.left-i-this.options.offset};break;case"w":h={top:e.top+e.height/2-j/2,left:e.left+e.width+this.options.offset};break;case"c":h={top:e.top+e.height/2-j/2,left:e.left+e.width/2-i/2}}2==k.length&&("w"==k.charAt(1)?h.left=e.left+e.width/2-15:h.left=e.left+e.width/2-i+15),d.css(h).addClass("tipsy-"+k),d.find(".tipsy-arrow")[0].className="tipsy-arrow tipsy-arrow-"+k.charAt(0),this.options.className&&d.addClass(b(this.options.className,this.$element[0])),this.options.fade?d.stop().css({opacity:0,display:"block",visibility:"visible"}).animate({opacity:this.options.opacity}):d.css({visibility:"visible",opacity:this.options.opacity});var l=this,m=function(a){return function(){l.$tip.stop(),l.tipHovered=a,a||(0===l.options.delayOut?l.hide():setTimeout(function(){"out"==l.hoverState&&l.hide()},l.options.delayOut))}};d.hover(m(!0),m(!1))}},hide:function(){this.options.fade?this.tip().stop().fadeOut(function(){a(this).remove()}):this.tip().remove()},fixTitle:function(){var a=this.$element;(a.attr("title")||"string"!=typeof a.attr("original-title"))&&a.attr("original-title",a.attr("title")||"").removeAttr("title"),"object"==typeof a.get(0).nearestViewportElement&&a.children("title").length&&a.append("<original-title>"+(a.children("title").text()||"")+"</original-title>").children("title").remove()},getTitle:function(){var a,b=this.$element,c=this.options;if(this.fixTitle(),"string"==typeof c.title){var d="title"==c.title?"original-title":c.title;a=b.children(d).length?b.children(d).html():b.attr(d)}else"function"==typeof c.title&&(a=c.title.call(b[0]));return a=(""+a).replace(/(^\s*|\s*$)/,""),a||c.fallback},tip:function(){return this.$tip||(this.$tip=a('<div class="tipsy"></div>').html('<div class="tipsy-arrow"></div><div class="tipsy-inner"></div>')),this.$tip},validate:function(){this.$element[0].parentNode||(this.hide(),this.$element=null,this.options=null)},enable:function(){this.enabled=!0},disable:function(){this.enabled=!1},toggleEnabled:function(){this.enabled=!this.enabled}},a.fn.tipsy=function(b){function d(d){var e=a.data(d,"tipsy");return e||(e=new c(d,a.fn.tipsy.elementOptions(d,b)),a.data(d,"tipsy",e)),e}function e(){var a=d(this);a.hoverState="in",0===b.delayIn?a.show():(a.fixTitle(),setTimeout(function(){"in"==a.hoverState&&a.show()},b.delayIn))}function f(){var a=d(this);if(a.hoverState="out",0===b.delayOut)a.hide();else{var c=function(){a.tipHovered&&b.hoverlock||"out"==a.hoverState&&a.hide()};setTimeout(c,b.delayOut)}}if(b===!0)return this.data("tipsy");if("string"==typeof b){var g=this.data("tipsy");return g&&g[b](),this}if(b=a.extend({},a.fn.tipsy.defaults,b),b.hoverlock&&0===b.delayOut&&(b.delayOut=100),"manual"!=b.trigger){var h=b.live?"live":"bind",i="hover"==b.trigger?"mouseenter":"focus",j="hover"==b.trigger?"click":"blur",k="hover"==b.trigger?"mouseleave":"blur";this[h](i,e)[h](k,f)[h](j,f)}return this},a.fn.tipsy.defaults={className:null,delayIn:0,delayOut:0,fade:!1,fallback:"",gravity:"n",html:!1,live:!1,offset:0,opacity:.8,title:"title",trigger:"hover",hoverlock:!1},a.fn.tipsy.elementOptions=function(b,c){return a.metadata?a.extend({},c,a(b).metadata()):c},a.fn.tipsy.autoNS=function(){return a(this).offset().top>a(document).scrollTop()+a(window).height()/2?"s":"n"},a.fn.tipsy.autoWE=function(){return a(this).offset().left>a(document).scrollLeft()+a(window).width()/2?"e":"w"},a.fn.tipsy.autoBounds=function(b,c){return function(){var d={ns:c[0],ew:c.length>1&&c[1]},e=a(document).scrollTop()+b,f=a(document).scrollLeft()+b,g=a(this);return g.offset().top<e&&(d.ns="n"),g.offset().left<f&&(d.ew="w"),a(window).width()+a(document).scrollLeft()-g.offset().left<b&&(d.ew="e"),a(window).height()+a(document).scrollTop()-g.offset().top<b&&(d.ns="s"),d.ns+(d.ew?d.ew:"")}}}(jQuery);var app=app||{};app.charts=app.charts||{},app.charts.bar={},app.charts.bar.draw=function(a,b,c,d){function e(a,c){return b.chartProp.info.yAxisAuto||a>0&&(a=0),a==c&&(a<0&&(c=0),a>0&&(a=0)),a=0==a?0:a-Math.abs(.25*(c-a)),c+=Math.abs(.25*(c-a)),{min:a,max:c}}function f(){var a="translate(4px, 16px) rotate(-90deg)",c=app.lang.isRtl()?"end":"start",d=+b.chartProp.info.font.fontSize.replace("px",""),e=1*d+"px",f=.25*d+"px",g=1.25*d+"px",h=1.5*d+"px";return"-90"===b.chartProp.info.xAxisRotate&&(a="translate("+f+", "+e+") rotate(-90deg)"),"-60"===b.chartProp.info.xAxisRotate&&(a="translate("+f+", "+e+") rotate(-60deg)"),"-45"===b.chartProp.info.xAxisRotate&&(a="translate("+f+", "+e+") rotate(-45deg)"),"-30"===b.chartProp.info.xAxisRotate&&(a="translate("+f+", "+g+") rotate(-30deg)"),"0"===b.chartProp.info.xAxisRotate&&(a="translate(0px, "+h+") rotate(0deg)",c="middle"),{transform:a,"text-anchor":c}}function g(a,c,d){if(b.chartProp.indicator){var e=app.chartCommons.indicator.getIndicator(c,d,b.chartProp.indicator);a.map(function(a){return a.thenRows=e,a})}}function h(a,c,d){var e=b.chartProp.info.dimColor=b.chartProp.info.dimColor||{};if(e.enable){var f=e.data[a.category.join("-")];return f=f||{},f.color||d}return d}function i(a,c,d,e){"line"===d&&(a=_.find(vb,{sIndex:e}).values[a].dIndex);var f=_.find(N,{index:a}),g=f.series;if(1===c&&d&&"undefined"!=typeof e&&(g=g.filter(function(a){return a.prop.seriesType===d&&!a.prop.hidden}),g=[g[e]]),2===c&&(g=g.filter(function(a){return!a.prop.hidden})),b.chartProp.info.isBox){var h=[];_.each(g,function(a){_.each([a.box.q1,a.box.q2,a.box.q3,a.box.min,a.box.max,a.box.avg],function(a,b){var c=0==b?"Q1":1==b?"Q2":2==b?"Q3":3==b?"MIN":4==b?"MAX":5==b?"AVG":"";h.push({prop:a.prop,data:a.data,label:(a.prop.name||a.label)+" "+c,format:G(a.prop),color:a.prop.seriesColor})})}),g=h}return g=g.map(function(a){return{data:a.data,label:a.prop.name||a.label,format:G(a.prop),color:a.prop.seriesColor}}),app.chartCommons.tooltip.tooltipFormatter({points:g,key:f.label,sum:d3.sum(g,function(a){return a.data}),avg:d3.sum(g,function(a){return a.data})/g.length,format:g.length>0?g[0].format:",.2f"},b.chartProp.info.tooltipHeader,b.chartProp.info.tooltipFormat,C)}function j(a){return"linear"==a?d3.curveLinear:"cardinal"==a?d3.curveNatural:"step"==a?d3.curveStep:d3.curveLinear}function k(a){a.selectAll("text").attr("transform",function(a,b){return a.prop.showValuesVertical?"translate(0,-10) rotate(90 ,0,0)":""}).attr("dy",function(a,b){return a.prop.showValuesVertical?"-0.4em":"-10"}).style("text-anchor",function(a,b){return a.prop.showValuesVertical?"end":app.lang.isRtl()?"start":"end"})}function l(a){return window.innerWidth-a[0].getBoundingClientRect().left<300?"e":"w"}function m(a){var b=a[0].series.filter(function(a,b){return"line"==a.prop.seriesType&&!a.prop.hidden}),c=b.map(function(b,c){var d={sIndex:b.sIndex,label:b.label,prop:b.prop,values:a.map(function(a,c){var d={sIndex:b.sIndex,dIndex:a.index,label:a.label+"#"+a.index,value:a.series.filter(function(a,c){return a.label==b.label})[0].data,valueLabel:a.series.filter(function(a,c){return a.label==b.label})[0].data,prop:a.series.filter(function(a,c){return a.label==b.label})[0].prop,onClickVal:a.onClickVal,primv:a.value,category:a.label,commentCount:a.series.filter(function(a,c){return a.label==b.label})[0].commentCount,seriesLable:b.label,seriesKey:b.key};return d}),valueStacked:a.map(function(a,c){return{sIndex:b.sIndex,label:a.label+"#"+a.index,valueLabel:a.series.filter(function(a,c){return a.label==b.label})[0].data,value:a.series.filter(function(a,c){return a.label==b.label})[0].data,prop:a.series.filter(function(a,c){return a.label==b.label})[0].prop,onClickVal:a.onClickVal,primv:a.value}})};return d}),d=0==c.length?[]:c[0].valueStacked.map(function(a){return Math.abs(a.value)});return c.forEach(function(a,b){if(0!=b){var e=c[b-1];a.valueStacked.forEach(function(a,b){d[b]+=Math.abs(a.value),a.value+=e.valueStacked[b].value})}}),M&&c.forEach(function(a,b){a.valueStacked.forEach(function(a,b){a.value=a.value/d[b]*100})}),c.forEach(function(a,b){a.values=a.values.filter(function(a){return""!==a.value}),a.valueStacked=a.valueStacked.filter(function(a){return""!==a.value}),a.prop.dontShowZeroValue&&(a.values=a.values.filter(function(a){return null!=a.value&&0!=a.value}),a.valueStacked=a.valueStacked.filter(function(a){return null!=a.value&&0!=a.value}))}),c}function n(){clearTimeout(Eb),bol=X.property("checked"),b.isSort=bol;var a=Y._groups[0][0].selectedIndex,c=Y._groups[0][0].value,d=(Y._groups[0][0],!0);a>=p.length&&(d=!1),Ua.domain(b.isSort?N.sort(function(a,b){return na=a.series.filter(function(a){return a.label==c}),nb=b.series.filter(function(a){return a.label==c}),na instanceof Array?(na=na[0],nb=nb[0],"series"==na.type?nb.data-na.data:nb.data[0]-na.data[0]):0}).map(function(a){return a.label+"#"+a.index}):N.sort(function(a,b){return a.index-b.index}).map(function(a){return a.label+"#"+a.index})),Wa.domain(b.isSort?N.filter(oa).sort(function(a,b){return na=a.series.filter(function(a){return a.label==c}),nb=b.series.filter(function(a){
return a.label==c}),na instanceof Array?(na=na[0],nb=nb[0],"series"==na.type?nb.data-na.data:nb.data[0]-na.data[0]):0}).map(function(a){return a.label+"#"+a.index}):N.filter(oa).sort(function(a,b){return a.index-b.index}).map(function(a){return a.label+"#"+a.index}));var e=ba.transition().duration(b.animationDuration),h=function(a,b){return O?50*b:0};e.on("end",function(){$(s+" .kpi").each(function(){var a=$(this);$(this).tipsy({gravity:l(a),html:!0,title:function(){var a=+b.chartProp.info.tooltip||1,c=N.map(function(a){return a.index}).indexOf($(this).parent(".gd").get(0).__data__.index);return i(c,a,"bar",$(this).index())}})}),$(s+" .series").each(function(){var a=$(this);$(this).tipsy({gravity:l(a),html:!0,title:function(){console.log("### tipsy title");var a=(N.map(function(a){return a.index}),$(this).parent(".gd").get(0)||$(this).parent(".gd-text").get(0)),c=a.__data__.index,d=+b.chartProp.info.tooltip||1,e=c,f=i(e,d,"bar",$(this).index());return f}})}),$(s+" .gd-text text").each(function(){var a=$(this);$(this).tipsy({gravity:l(a),html:!0,title:function(){var a=+b.chartProp.info.tooltip||1,c=N.map(function(a){return a.index}).indexOf($(this).parent(".gd-text").get(0).__data__.index);return i(c,a,"bar",$(this).index())}})})}),e.selectAll(".gd").delay(h).attr("transform",function(a){return"translate("+Ua(a.label+"#"+a.index)+",0)"}),e.selectAll(".gd-text").delay(h).attr("transform",function(a){return"translate("+Ua(a.label+"#"+a.index)+",0)"}),vb=m(N),ba.selectAll(".area").data(vb).datum(function(a){var b=a.prop.lineType;return"line-dot-area"==b||"line-area"==b?L?a.valueStacked:a.values:0}).transition().duration(b.animationDuration).attr("d",function(a){return _.isArray(a)&&0==a.length?"M0,0":0===a?"M0,0":yb.curve(j(a[0].prop.lineStyle))(a)}),ba.selectAll(".line").data(vb).datum(function(a){var b=a.prop.lineType;return"line-dot-area"==b||"line-dot"==b||"line-area"==b||"line"==b?L?a.valueStacked:a.values:0}).transition().duration(b.animationDuration).attr("d",function(a){return _.isArray(a)&&0==a.length?"M0,0":0===a?"M0,0":Ab.curve(j(a[0].prop.lineStyle))(a)}),ba.selectAll(".circle-group").data(vb).selectAll(".circle").data(function(a){var b=a.prop.lineType;return"line-dot-area"==b||"line-dot"==b||"dot"==b?L?a.valueStacked:a.values:0}).transition().duration(b.animationDuration).attr("stroke",function(a,b){var c=[a],d=d3.select(this.parentNode).datum().seriesLable,e=N[b].series.map(function(a){return a.label}),f=N[b].series.map(function(a){return a.data});g(c,f,e),a=c[0];var h=a.prop.seriesColor;return a.thenRows&&$.each(a.thenRows,function(a,b){$.each(b,function(a,b){if(d!=b.firstField)return!0;switch(+b.operand){case 1:h=b.secondFieldColor}})}),h}).attr("cx",function(a){return Ab.curve(j(a.prop.lineStyle)).x()(a)}).attr("cy",function(a){return Ab.curve(j(a.prop.lineStyle)).y()(a)});var k=ba.selectAll(".text-vals").data(vb).selectAll(".text-value").data(function(a){var b=a.prop.lineType,c=0;return"line-dot-area"!==b&&"line-dot"!==b&&"dot"!==b||(c=L?a.valueStacked:a.values),c});ba.selectAll(".text-vals text").text(function(a){return a=d3.select(d3.select(this).node().parentElement).datum(),persian(d3.format(G(a.prop.font,a.prop))(a.valueLabel),C)});k.transition().duration(b.animationDuration).attr("transform",function(a,b){var c=d3.select(this).node().getBBox().width,d=Ab.curve(j(a.prop.lineStyle)).y()(a),e=Ab.curve(j(a.prop.lineStyle)).x()(a)-c/2;return"translate("+e+","+d+")"});ba.selectAll(".colorStepGroup").data(vb).selectAll("stop").data(function(a){var b=[],c=1/(2*(a.values.length-1)),d=-1*c;return a.values.map(function(e,f){var h={value:e.value,label:a.label,color:a.prop.seriesColor},i=[h],j=N[f].series.map(function(a){return a.label}),k=N[f].series.map(function(a){return a.data});g(i,k,j),h=i[0],h.offset=d<0?0:d,b.push(h),h=$.extend({},h),d+=2*c,h.offset=d>1?d-c:d,b.push(h)}),b}).transition().attr("stop-color",function(a,b){var c=a.color;return a.thenRows&&$.each(a.thenRows,function(b,d){$.each(d,function(b,d){if(a.label!=d.firstField)return!0;switch(+d.operand){case 1:c=d.secondFieldColor}})}),c}).attr("offset",function(a){return a.offset}),e.select(".x.axis").call(sa).selectAll("g").delay(h),e.select(".x.axis").selectAll("g text").attr("class","axes-x-label inline ltr").attr("x","0").attr("dy","0").attr("y","0").style("transform",f().transform).style("font-family",b.chartProp.info.font.fontName).style("font-size",b.chartProp.info.font.fontSize).attr("fill",b.chartProp.info.font.color).style("font-weight",b.chartProp.info.font.bold?"bold":"normal").style("font-style",b.chartProp.info.font.italic?"italic":"normal").delay(h),ba.select(".x.axis").selectAll("g text").style("font-family",b.chartProp.info.font.fontName).style("font-size",b.chartProp.info.font.fontSize).attr("fill",b.chartProp.info.font.color).style("font-weight",b.chartProp.info.font.bold?"bold":"normal").style("font-style",b.chartProp.info.font.italic?"italic":"normal").style("text-anchor","end").attr("x","0").attr("dy","0").attr("y","0").style("text-anchor",pa["text-anchor"]).style("transform",pa.transform).append("title").text(function(a){return persian(a.replace(new RegExp("#\\d+$"),""),C)})}b.input=a;a.title,a.chartInfo;app.chartCommons.calculateFields(a.series,b.calculatedFields);var o="undefined"!=typeof a.series?a.series.labels:[],p="undefined"!=typeof a.kpis?a.kpis.labels:[],q=a.seriesLablesCaptions,r=a.kpisLablesCaptions,s="#"+b.id,t=$(s).hasClass("fromCommentDialog"),u={top:20,right:20,bottom:40,left:20},v=$(s).width(),w=$(s).height(),x=!1;if(x){var y=v;v=w,w=y}var z="small"==b.chartProp.info.chartSize?80:"medium"==b.chartProp.info.chartSize?130:"large"==b.chartProp.info.chartSize?160:"veryLarge"==b.chartProp.info.chartSize?200:130,A=!app.mobileMode,B=b.chartProp.info.openDashboard&&b.chartProp.info.openDashboard.checked,C="undefined"==typeof a.lang||0==+a.lang,D=(z+u.top+u.bottom,d3.scaleOrdinal(d3.schemeCategory10)),E=d.isProgress,F=d.showProgress,G=(d.title,function(a,b){if(!a)return",.2f";var c=a;if(!a.formatString){if(!b)return",.2f";c=b}return"custom"!=c.formatString?c.formatString:c.formatStringCustom}),H=+b.chartProp.info.stackedBar,I=3==H||2==H,J=3==H,K=+b.chartProp.info.stackedLine,L=3==K||2==K,M=3==K;if(app.chartCommons.setDefault(b.chartProp,p.concat(o),"bar"),!a.result)return void $("#"+b.id).append(app.chartCommons.getError(a));for(var N=prepareData(a,b.chartProp),O=N.length<25,P=d3.scaleOrdinal(d3.schemeCategory10),Q=[],R=0;R<o.length;R++){var S=b.chartProp.series[o[R]];if("undefined"==typeof S){S=0==b.chartProp.series.length?{seriesColor:"#1F77B4",seriesType:"bar",formatStringCustom:",.2f",formatString:",.2f",numberFactor:"1",showValues:!1,hidden:!1,cumulative:!1,lineFace:"5,0",lineWeight:"2",lineStyle:"linear",lineType:"line-dot-area",showValueColor:"#333333"}:$.extend({},b.chartProp.series[Object.keys(b.chartProp.series)[0]]);for(var T="#1F77B4",R=0;R<10&&(T=P(R)||"#1f77b4",Q.indexOf(T.toLowerCase())!=-1);R++);S.seriesColor=T,S.name=null,b.chartProp.series[o[R]]=S}S.font&&!S.datasourceType||(S.font={bold:!1,color:S.showValueColor||"#333333",italic:!1,fontSize:S.showValueFontSize||"12px",fontName:"Droid"}),Q.push(S.seriesColor.toLowerCase())}d3Utils.prepareDataForBarChart(N,b,o,p,q,r),_.each(N,function(a){_.each(a.series,function(a,b){a.sIndex=b})});var U=o;b.chartProp.info.isBox&&(N=_.map(N,function(a){for(var b=[],c=0;c<a.series.length/6;c++){var d=a.series[6*c+0];d.box={q1:a.series[6*c+0],q2:a.series[6*c+1],q3:a.series[6*c+2],min:a.series[6*c+3],max:a.series[6*c+4],avg:a.series[6*c+5]},b.push(d)}return a.series=b,a}),U=_.filter(o,function(a,b){return b%6===0})),b.editMode&&$(s).trigger("chartproperty",[p.concat(U)]);for(var V=null,R=0;R<N.length;R++){V||(V=new Array(N.length));for(var W=0;W<N[R].series.length;W++)V[R]||(V[R]=new Array(N[R].series.length)),V[R][W]=V[R][W]||{sum:null,avg:null,"var":null},N[R].series[W].prop&&N[R].series[W].prop.cumulative&&("undefined"!=typeof N[R].series[W].prop.cumulative_formula&&"sum"!=N[R].series[W].prop.cumulative_formula||(V[R][W].sum=d3.sum(N.filter(function(a,b){return b<=R}),function(a,b){return a.series[W].data})),"avg"==N[R].series[W].prop.cumulative_formula&&(V[R][W].avg=d3.mean(N.filter(function(a,b){return b<=R}),function(a,b){return a.series[W].data})),"var"==N[R].series[W].prop.cumulative_formula&&(V[R][W]["var"]=d3.variance(N.filter(function(a,b){return b<=R}),function(a,b){return a.series[W].data})),null==N[R].series[W].data&&N[R].series[W].prop.dontShowZeroValue&&(V[R][W].sum=null,V[R][W].avg=null,V[R][W]["var"]=null))}for(var R=0;R<N.length;R++)for(var W=0;W<N[R].series.length;W++)N[R].series[W].prop&&N[R].series[W].prop.cumulative&&(N[R].series[W].data=V[R][W]["var"]||V[R][W].sum||V[R][W].avg);J&&N.forEach(function(a){var b=a.series.filter(function(a,b){return!a.prop.hidden&&"bar"==a.prop.seriesType}),c=d3.sum(b.map(function(a){return Math.abs(a.data)}));b.forEach(function(a){a.data=a.data/c*100})}),$(s).addClass("bar-line-chart");var X,Y,Z=d3.select(s).append("div").attr("class","legend-bar temporal");if(X=d3.select(s).select("#sort_checkbox_btn"),Y=d3.select(s).select("#sort_checkbox select"),!X._groups[0][0]&&N.length>0){var aa=Z.append("div").attr("id","sort_checkbox").attr("class","sort-checkbox");X=aa.append("label").append("input").attr("type","checkbox").attr("id","sort_checkbox_btn"),aa.select("label").append("span"),app.lang.translateAsync("sort",function(a){var b=$(aa._groups[0][0]).find("span");b.html(" "+a)});var Y=aa.append("select").on("change",function(){var a=X.property("checked");b.isSort=a,X.property("checked")&&n()}).style("margin","0 7px");p.length+o.length==1&&Y.style("visibility","hidden").style("width","1px"),Y.selectAll("nothings").data(N[0].series.filter(function(a,b){return!a.prop.hidden}).map(function(a){return{name:(a.prop.name||a.label).replace(/^\[measure\]/,""),value:a.label}})).enter().append("option").text(function(a){return persian(a.name,C)}).attr("value",function(a){return a.value})}if("undefined"==typeof b.chartProp.info.showSortBox||b.chartProp.info.showSortBox||$(s+" #sort_checkbox").hide(),Z.breadcrumb(a.levels,b,d,C),!a.matrix||0==a.matrix.length)return void Z.append("div").attr("class","temporal").style("font-size","0.8em").style("margin","15px").append("span").attr("class","translate").attr("data-trans-key","داده‌ای برای نمایش وجود ندارد").text("داده‌ای برای نمایش وجود ندارد");(b.chartProp.info.showLegends||"undefined"==typeof b.chartProp.info.showLegends)&&Z.legend({width:v,font:b.chartProp.info.legendFont,position:b.chartProp.info.legendPosition,selector:s,data:N[0].series.filter(function(a,b){return!a.prop.hidden}).map(function(a){return{label:(a.prop.name||a.label).replace(/^\[measure\]/,""),color:a.prop.seriesColor,key:a.key,sIndex:a.sIndex}}),click:function(a){b.editMode||$(s+" .series-"+a.sIndex).fadeToggle()}},C),b.chartProp.indicatorLegendShow&&Z.legend({order:"horizental",width:v,font:b.chartProp.indicatorLegendFont,position:b.chartProp.info.legendPosition,selector:s,data:_.map(b.chartProp.indicator,function(c,d){var e=_.find(c.thenRow,{operand:"1"}),f=e?e.secondFieldColor:"#eeeeee",g=c.title||app.chartCommons.indicator.ifToString(c.ifRow,a.series.labels,a.seriesLablesCaptions,b);return{label:g,color:f}})},C);var ba=null;ba=_.indexOf(["bottom left","bottom right","bottom center"],b.chartProp.info.legendPosition)!=-1?d3.select(s).insert("svg",":first-child").attr("class","temporal line-chart"):d3.select(s).append("svg").attr("class","temporal line-chart"),x&&ba.style("transfotm","rotate(90deg)");var ca=_.extend({enable:!1,ticksType:"auto",ticksCount:10,ticksSpace:20,measures:{},font:{bold:!1,color:"#333333",italic:!1,fontSize:"10px",fontName:"IRANSans",formatString:b.chartProp.info.formatString||",.2f",formatStringCustom:",.2f"}},b.chartProp.info.secondaryY),da=d3.max(N,function(a){return d3.max(a.series.filter(function(a,b){return!a.prop.hidden}).filter(function(a,b){return!a.prop.hidden&&ca.measures[a.seriesKey]!==!0}),function(a){return"kpi"==a.type?d3.max(a.data):"series"==a.type?+a.data||0:void 0})}),ea=d3.min(N,function(a){return d3.min(a.series.filter(function(a,b){return!a.prop.hidden}).filter(function(a,b){return!a.prop.hidden&&ca.measures[a.seriesKey]!==!0}),function(a){return"kpi"==a.type?d3.min(a.data):"series"==a.type?+a.data||0:void 0})});if(b.chartProp.info.isBox&&(da=d3.max(N,function(a){return d3.max(a.series.filter(function(a,b){return!a.prop.hidden}).filter(function(a,b){return!a.prop.hidden&&ca.measures[a.seriesKey]!==!0}),function(a){return d3.max([a.box.q1.data,a.box.q2.data,a.box.q3.data,a.box.min.data,a.box.max.data,a.box.avg.data])})}),ea=d3.min(N,function(a){return d3.min(a.series.filter(function(a,b){return!a.prop.hidden}).filter(function(a,b){return!a.prop.hidden&&ca.measures[a.seriesKey]!==!0}),function(a){return d3.min([a.box.q1.data,a.box.q2.data,a.box.q3.data,a.box.min.data,a.box.max.data,a.box.avg.data])})})),I){var fa=d3.max(N,function(a){return d3.sum(a.series.filter(function(a,b){return!a.prop.hidden&&"bar"==a.prop.seriesType}).filter(function(a,b){return!a.prop.hidden&&ca.measures[a.seriesKey]!==!0}),function(a){return"kpi"==a.type?d3.max(a.data):"series"==a.type?a.data>0?a.data:0:void 0})});da=fa>da?fa:da;var ga=d3.min(N,function(a){return d3.sum(a.series.filter(function(a,b){return!a.prop.hidden}).filter(function(a,b){return!a.prop.hidden&&ca.measures[a.seriesKey]!==!0}),function(a){return"kpi"==a.type?d3.min(a.data):"series"==a.type?a.data<0?a.data:0:void 0})});ea=ga<ea?ga:ea}if(L){var fa=d3.max(N,function(a){return d3.sum(a.series.filter(function(a,b){return!a.prop.hidden&&"line"==a.prop.seriesType}).filter(function(a,b){return!a.prop.hidden&&ca.measures[a.seriesKey]!==!0}),function(a){return"kpi"==a.type?d3.max(a.data):"series"==a.type?a.data>0?a.data:0:void 0})});da=fa>da?fa:da;var ga=d3.min(N,function(a){return d3.sum(a.series.filter(function(a,b){return!a.prop.hidden}),function(a){return"kpi"==a.type?d3.min(a.data):"series"==a.type?a.data<0?a.data:0:void 0})});ea=ga<ea?ga:ea}var ha=e(ea,da);ea=ha.min,da=ha.max;var ia=N[0].series.filter(function(a){return"series"==a.type&&"bar"==a.prop.seriesType&&!a.prop.hidden}).length,ja=N[0].series.filter(function(a){return"series"==a.type&&"line"==a.prop.seriesType&&!a.prop.hidden}).length;(M&&ja>0||J&&ia>0)&&(da=100,ea=ea<0?-100:0),b.chartProp.info.yAxisMax&&(da=+b.chartProp.info.yAxisMax),b.chartProp.info.yAxisMin&&(ea=+b.chartProp.info.yAxisMin);var ka=+b.chartProp.info.xAxisLen||20;b.chartProp.info.font||(b.chartProp.info.font={bold:!1,color:"#333333",italic:!1,fontSize:"12px",fontName:"Droid"});var la=50,ma=N.length/la,oa=function(a,b){return N.length<35||(N.length<=la||(0===b&&(this.meter=0),b>=this.meter&&(this.meter+=ma,!0)))},pa=f(),qa=30;if(app.dashboardLayoutVersion=app.dashboardLayoutVersion||2,2===app.dashboardLayoutVersion){var ra=d3.scaleBand().range([v-400,v]).paddingInner(.1);ra.domain(N.map(function(a){return a.label+"#"+a.index}).filter(oa));var sa=d3.axisBottom(ra).tickFormat(function(a){var b=a.replace(new RegExp("#\\d+$"),"");return(b.length>ka?"...":"")+persian(b.substring(0,ka),C)}),ta=d3.select(s).append("svg");ta.append("g").attr("class","x axis").call(sa),ta.selectAll("g text").attr("fill",b.chartProp.info.font.color).attr("class","axes-x-label inline ltr").style("font-family",b.chartProp.info.font.fontName).style("font-size",b.chartProp.info.font.fontSize).style("font-weight",b.chartProp.info.font.bold?"bold":"normal").style("font-style",b.chartProp.info.font.italic?"italic":"normal").attr("x","0").attr("dy","0").attr("y","0").style("text-anchor",pa["text-anchor"]).style("transform",pa.transform).append("title").text(function(a){return persian(a.replace(new RegExp("#\\d+$"),""),C)});var ua=ta.node(),va=ua.getBBox();try{qa=ta.selectAll("text")._groups[0][1].getBBox().height}catch(wa){}var xa=$(s+" .title").outerHeight()||0,ya=$(s+" .legend-bar"),za="undefined"==typeof ya?0:ya.height()+ +ya.css("margin-top").replace("px","");ta.remove(),z=w-xa-va.height-u.bottom-za,z<50&&(z=50),ba.attr("width",v).attr("height",z+va.height+u.bottom)}var Aa=d3.scaleLinear().range([z+u.top,u.top]).domain([ea,da]);if((I||L)&&(ca.enable=!1),ca.enable){var Ba=d3.max(N,function(a){return d3.max(a.series.filter(function(a,b){return!a.prop.hidden&&ca.measures[a.seriesKey]===!0}),function(a){return"kpi"==a.type?d3.max(a.data):"series"==a.type?+a.data||0:void 0})}),Ca=d3.min(N,function(a){return d3.min(a.series.filter(function(a,b){return!a.prop.hidden&&ca.measures[a.seriesKey]===!0}),function(a){return"kpi"==a.type?d3.min(a.data):"series"==a.type?+a.data||0:void 0})}),ha=e(Ca,Ba);Ca=ha.min,Ba=ha.max,b.chartProp.info.secondaryY.yAxisMax&&(Ba=+b.chartProp.info.secondaryY.yAxisMax),b.chartProp.info.secondaryY.yAxisMin&&(Ca=+b.chartProp.info.secondaryY.yAxisMin);var Da=d3.scaleLinear().range([z+u.top,u.top]).domain([Ca,Ba])}"%"==b.chartProp.info.formatString&&(b.chartProp.info.formatString=".0%"),b.chartProp.info.fontYaxe=_.extend({bold:!1,color:"#333333",italic:!1,fontSize:"10px",fontName:"IRANSans",formatString:b.chartProp.info.formatString||",.2f",formatStringCustom:",.2f"},b.chartProp.info.fontYaxe);var Ea=d3.axisLeft(Aa).tickFormat(function(a){var c=d3.format(b.chartProp.info.fontYaxe.formatString);return persian(c(a),C)+""}),Fa=_.extend({ticksType:"auto",ticksCount:10,ticksSpace:20},b.chartProp.info.AxeY),Ga=Math.floor(z/22)+1;"count"===Fa.ticksType&&(Ga=Fa.ticksCount),"space"===Fa.ticksType&&(Ga=Math.floor(z/Fa.ticksSpace)+1),Ea.ticks(Ga);var Ha=ba.append("g").attr("class","y axis").attr("transform","translate(-10,0)");Ha.call(Ea),Ha.selectAll(".tick text").attr("fill",b.chartProp.info.fontYaxe.color).style("font-size",b.chartProp.info.fontYaxe.fontSize).style("font-family",b.chartProp.info.fontYaxe.fontName).style("font-weight",b.chartProp.info.fontYaxe.bold?"bold":"normal").style("font-style",b.chartProp.info.fontYaxe.italic?"italic":"normal");var Ia=Ha._groups[0][0].getBBox(),Ja={};if(ca.enable){var Ka=d3.axisRight(Da).tickFormat(function(a){var b=d3.format(ca.font.formatString);return persian(b(a),C)+""}),Ga=Math.floor(z/22)+1;"count"===ca.ticksType&&(Ga=ca.ticksCount),"space"===ca.ticksType&&(Ga=Math.floor(z/ca.ticksSpace)+1),Ka.ticks(Ga);var La=ba.append("g").attr("class","y2 axis").attr("transform","translate(-10,0)");if(La.call(Ka),La.selectAll(".tick text").attr("fill",ca.font.color).style("font-size",ca.font.fontSize).style("font-family",ca.font.fontName).style("font-weight",ca.font.bold?"bold":"normal").style("font-style",ca.font.italic?"italic":"normal"),Ja=La._groups[0][0].getBBox(),ca.label){var Ma=La.append("text").attr("fill",ca.fontLabel.color).attr("dy","0.7em").attr("dx","-0.7em").style("text-anchor","end").style("font-size",ca.fontLabel.fontSize).style("font-family",ca.fontLabel.fontName).style("font-weight",ca.fontLabel.bold?"bold":"normal").style("font-style",ca.fontLabel.italic?"italic":"normal").text(ca.label),Na=z/2-(Ma._groups[0][0].getBBox().width||0)/2;Ma.style("transform","translate("+((Ja.width||0)+14)+"px,"+Na+"px) rotate(-90deg)"),Ja=La._groups[0][0].getBBox()}}var Oa=v-Ia.width-(Ja.width||0)-u.left;N=N.filter(function(a,b){return b<Oa-2-.1*Oa});var Pa=[v-Oa-(Ja.width||0)+10,v-10-(Ja.width||0)],Qa=.1,Ra=1==N.length?1:N.length<5?.5:0,Sa=N[0].series.filter(function(a,b){return!a.prop.hidden&&"bar"==a.prop.seriesType});0==Sa.length&&(Ra=0),Ha.attr("transform","translate("+(Ia.width+u.left)+",0)"),ca.enable&&La.attr("transform","translate("+(Oa+u.left+Ia.width)+",0)");var Ta=$.grep(N[0].series,function(a,b){return"bar"==a.prop.seriesType&&!a.prop.hidden}),Ua=($.grep(N[0].series,function(a,b){return"line"==a.prop.seriesType&&!a.prop.hidden}),d3.scaleBand().range(Pa).paddingInner(Qa).paddingOuter(Ra));Ua.domain(N.map(function(a){return a.label+"#"+a.index}));var Va=d3.scaleBand().range([0,Ua.bandwidth()]).domain($.map(Ta,function(a){return a.label})),Wa=d3.scaleBand().range(Pa).paddingInner(Qa).paddingOuter(Ra);la=Math.abs(Pa[0]-Pa[1])/qa,ma=N.length/la,Wa.domain(N.map(function(a){return a.label+"#"+a.index}).filter(oa));var sa=d3.axisBottom(Wa).tickFormat(function(a){var b=a.replace(new RegExp("#\\d+$"),"");return(b.length>ka?"...":"")+persian(b.substring(0,ka),C)});ba.append("svg:rect").attr("class","background").style("fill","white").style("opacity","0").attr("width",Oa).attr("height",+ba.attr("height")).attr("transform","translate("+(v-Oa)+",0)").on("click",function(c,d,e){t||""!=a.levels&&(E()||(F(!0),b.isSort=X.property("checked"),app.chartCommons.drillDown.up(b.ChartInPageId),b.parameters={isUp:!0,chartId:b.chartId,ChartInPageId:b.ChartInPageId,notEditMode:!b.editMode},app.chartCommons.levelTypeUtils.getParam(b),$(s).charts(b.type,"refreshWithData",b)))}),b.chartProp.info.horizontalLines&&ba.select(".y.axis").selectAll("g line").attr("x2",Oa).attr("x1","-6").style("opacity","0.1");var Xa=b.chartProp.globalvariable&&b.chartProp.globalvariable.length>0&&!b.editMode&&b.chartProp.globalvariable.filter(function(b){return b.field==a.CurrentDimName}).length>0;ba.append("g").attr("class","x axis").attr("transform","translate(0,"+(z+u.top)+")").call(sa);var Ya=ba.select(".x.axis").selectAll("g text").attr("class","axes-x-label inline ltr").attr("x","0").attr("dy","0").attr("y","0").style("text-anchor",pa["text-anchor"]).style("transform",pa.transform).style("font-family",b.chartProp.info.font.fontName).style("font-size",b.chartProp.info.font.fontSize).attr("fill",b.chartProp.info.font.color).style("font-weight",b.chartProp.info.font.bold?"bold":"normal").style("font-style",b.chartProp.info.font.italic?"italic":"normal");ba.select(".x.axis").selectAll("g").append("title").text(function(a){return persian(a.replace(new RegExp("#\\d+$"),""),C)});var Za=d3.max(Ya._groups[0],function(a){return a.getBBox().width}),$a=Ya._groups[0].length*Za,_a=$a>Oa;_a=!0,_a&&Ya.style("text-anchor",pa["text-anchor"]).style("transform",pa.transform);var ab=function(c,d,e){if($(".tipsy").remove(),!t){if(b.chartProp.globalvariable&&b.chartProp.globalvariable.length>0&&!b.editMode&&(app.globalVariableHelper.updateGlobalVariables([a.CurrentDimName],[d.value],b.chartProp.globalvariable),$(s+" .gd.selected-item").attr("class",$(this).attr("class").replace("selected-item","")),$(s+" .circle.selected-item").attr("class",$(this).attr("class").replace("selected-item","")),$(this).attr("class",$(this).attr("class")+" selected-item")),!d.canDrill)return void(B&&!b.editMode&&app.chartCommons.openLink(b.chartProp.info.openDashboard,{ChartInPageId:b.ChartInPageId,DataSourceId:b.input.DataSourceId,dimensionName:b.input.dimensionName,value:d.value,refreshDatasource:b.input.RefreshDatasource}));if(!E()){F(!0);var f=X.property("checked");b.isSort=f,app.chartCommons.drillDown.add(b.ChartInPageId,b.input.DataSourceId,b.input.CurrentDimName,d.onClickVal,b.input),b.parameters={selectedItem:d.onClickVal,chartId:b.chartId,ChartInPageId:b.ChartInPageId,notEditMode:!b.editMode},app.chartCommons.levelTypeUtils.getParam(b),$(s).charts(b.type,"refreshWithData",b)}}},bb=ba.append("g").attr("class","charts"),cb=bb.selectAll(".gd").data(N).enter().append("g").attr("transform","translate("+Ua(N[0].label+"#"+N[0].index)+",0)").attr("class",function(a){return"gd "+(""!=a.onClickVal||a.canDrill||Xa||B?" pointer":"")}).on("click",ab),db={lastTexts:[],clear:function(){this.lastTexts=[]},noConfilict:function(a,b,c,d){for(var e=!0,f=0;f<this.lastTexts.length;f++){var g=this.lastTexts[f];if(e=c+Ua.bandwidth()/2-a/2>g.x+3||g.y-g.h-3>d||g.y<d-b-3,!e)break}return e&&(this.lastTexts.length>=5&&this.lastTexts.shift(),this.lastTexts.push({x:c+a/2,y:d,h:b})),e}},eb=b.chartProp.info.overlapBars||!1,fb=b.chartProp.info.isBox;if(I||fb)if(fb){var gb=cb.selectAll("nothings").data(function(a){var b=a.series.filter(function(a){return"series"==a.type&&"bar"==a.prop.seriesType&&!a.prop.hidden}),c=a.series.map(function(a){return a.label}),d=a.series.map(function(a){return a.data});return g(b,d,c),b}).enter().append("g");gb.attr("class",function(a){return"series series-"+a.sIndex}).attr("transform",function(a,b){return"translate("+Va(a.label)+",0)"});var hb=function(a){var b=Aa,c=ea,d=da;return ca.enable&&ca.measures[a.seriesKey]===!0&&(b=Da,c=Ca,d=Ba),b(a.data>=0?a.data>d?d:a.data:0)},ib=5,jb=Va.bandwidth()-2*ib,kb=function(a,b){return h(a,b,a.prop.seriesColor)};gb.append("line").attr("x1",ib).attr("x2",jb+ib).attr("y1",function(a){return hb(a.box.q2)}).attr("y2",function(a){return hb(a.box.q2)}).style("display",function(a){var b=a.prop.boxOption||{};return b.dontShowMedian===!0?"none":"auto"}).attr("stroke",kb),gb.append("line").attr("x1",jb/2+ib).attr("x2",jb/2+ib).attr("y1",function(a){return hb(a.box.min)}).attr("y2",function(a){return hb(a.box.q1)}).attr("stroke",kb),gb.append("line").attr("x1",jb/3+ib).attr("x2",2*jb/3+ib).attr("y1",function(a){return hb(a.box.min)}).attr("y2",function(a){return hb(a.box.min)}).attr("stroke",kb),gb.append("line").attr("x1",jb/3+ib).attr("x2",2*jb/3+ib).attr("y1",function(a){return hb(a.box.max)}).attr("y2",function(a){return hb(a.box.max)}).attr("stroke",kb),gb.append("line").attr("x1",jb/2+ib).attr("x2",jb/2+ib).attr("y1",function(a){return hb(a.box.max)}).attr("y2",function(a){return hb(a.box.q3)}).attr("stroke",kb),gb.append("circle").attr("cx",jb/2+ib).attr("cy",function(a){return hb(a.box.avg)}).attr("r","5px").style("display",function(a){var b=a.prop.boxOption||{};return b.dontShowAvg===!0?"none":"auto"}).attr("stroke",kb),gb.append("rect").attr("width",jb).attr("x",ib).attr("stroke",kb).attr("fill",function(a){var b=h(a,R,a.prop.seriesColor);return a.thenRows&&$.each(a.thenRows,function(c,d){$.each(d,function(c,d){if(a.label!==d.firstField)return!0;switch(+d.operand){case 1:b=d.secondFieldColor}})}),b+"99"}).attr("y",function(a){return hb(a.box.q3)}).attr("height",function(a){return hb(a.box.q1)-hb(a.box.q3)}).on("click",function(a,c){t&&app.chartCommons.commentUtils.clickOnCommentIcon(c,b.ChartInPageId)});var lb=function(a,b){var c=a.prop.boxOption||{},d={};return 0!==b&&2!==b||(d=c.q1q3ValueFont),1===b&&(d=c.midValueFont),3!==b&&4!==b||(d=c.minMaxValueFont),d||{}};gb.append("g").selectAll("text").data(function(a){return[a.box.q1,a.box.q2,a.box.q3,a.box.min,a.box.max]}).enter().append("text").attr("y",function(a){return hb(a)}).attr("x",ib).text(function(a,b){var c=a.prop.boxOption||{},d=!1;0!==b&&2!==b||(d=c.showq1q3Value),1===b&&(d=c.showMidValue&&c.dontShowMedian!==!0),3!==b&&4!==b||(d=c.showMinMaxValue);var e=lb(a,b);return d?persian(d3.format(G(e,a.prop))(a.data),C):""}).styles(function(a,b){var c=lb(a,b);return{"font-family":c.fontName,"font-size":c.fontSize,fill:c.color,"font-weight":c.bold?"bold":"normal","font-style":c.italic?"italic":"normal"}})}else{var mb=N.map(function(a){return a.label+"#"+a.index});b.chartProp.info.satckSumFont=b.chartProp.info.satckSumFont||{},cb.selectAll(".sum-text").data(function(a){var b=a.series.filter(function(a){return"series"===a.type&&"bar"===a.prop.seriesType&&!a.prop.hidden});return[_.sum(_.map(b,"data"))]}).enter().append("text").attr("y",function(a){var b=Aa;return b(a>=0?a>da?da:a:0)}).text(function(a,c){return b.chartProp.info.satckSumShow?0===a?"":persian(d3.format(b.chartProp.info.satckSumFont.formatString)(a),C):""}).attr("dy","-0.3em").style("font-family",b.chartProp.info.satckSumFont.fontName).style("font-size",b.chartProp.info.satckSumFont.fontSize).attr("fill",b.chartProp.info.satckSumFont.color).style("font-weight",b.chartProp.info.satckSumFont.bold?"bold":"normal").style("font-style",b.chartProp.info.satckSumFont.italic?"italic":"normal").attr("x",function(a){var b=d3.select(this).node().getBBox().width;return Ua.bandwidth()/2-b/2});var gb=cb.selectAll("nothings").data(function(a){var b=a.series.filter(function(a){return"series"===a.type&&"bar"===a.prop.seriesType&&!a.prop.hidden}),c=0,d=0;_.each(b,function(a){+a.data>0?(a.pOffset=c,c+=+a.data):(a.nOffset=d,d+=+a.data)});var e=a.series.map(function(a){return a.label}),f=a.series.map(function(a){return a.data});return g(b,f,e),b}).enter().append("g");gb.attr("class",function(a){return"series series-"+a.sIndex}).attr("transform",function(a,b){return"translate(0,0)"}),gb.append("rect").attr("width",Ua.bandwidth()).attr("fill",function(a,b){var c=a.prop.seriesColor;return a.thenRows&&$.each(a.thenRows,function(b,d){$.each(d,function(b,d){if(a.label!=d.firstField)return!0;switch(+d.operand){case 1:d.isStriped?(c=app.chartCommons.indicator.getStripedColor(ba,d.secondFieldColor,d.index),a.isStriped=!0,a.stripeColor=d.secondFieldColor):c=d.secondFieldColor}})}),c}).attr("stroke",function(a){return a.isStriped?a.stripeColor:null}).attr("y",function(a){var b=Aa,c=ea,d=da;ca.enable&&ca.measures[a.seriesKey]===!0&&(b=Da,c=Ca,d=Ba);var e=a.data>0?a.pOffset+a.data:a.nOffset;return b(e>=0?e>d?d:e:e<c?c:e)}).attr("height",function(a){var b=Aa,c=ea,d=da;ca.enable&&ca.measures[a.seriesKey]===!0&&(b=Da,c=Ca,d=Ba);var e=a.data>0?+a.pOffset:a.nOffset,f=b(e+ +a.data>d?Math.max(d-e,0):a.data);return a.data>0?b(Math.max(0,c))-f:b(a.data<c?c:a.data)-b(0)}).on("click",function(a,c){t&&app.chartCommons.commentUtils.clickOnCommentIcon(c,b.ChartInPageId)});var ob=[[]],ob=gb.append("text").attr("class",function(a){return"series-"+a.sIndex}).text(function(a,b){return a.prop.showValues?0==a.data?"":persian(d3.format(G(a.prop.font,a.prop))(a.data),C):""}).attr("dy","0.3em").style("font-family",function(a){return a.prop.font.fontName}).style("font-size",function(a){return a.prop.font.fontSize}).attr("fill",function(a){return a.prop.font.color}).style("font-weight",function(a){return a.prop.font.bold?"bold":"normal"}).style("font-style",function(a){return a.prop.font.italic?"italic":"normal"}).attr("x",function(a){var b=d3.select(this).node().getBBox().width;return Ua.bandwidth()/2-b/2}).attr("y",function(a){var b=Aa,c=ea,d=da;ca.enable&&ca.measures[a.seriesKey]===!0&&(b=Da,c=Ca,d=Ba);var e=a.data>0?+a.pOffset:a.nOffset,f=b(e+ +a.data>d?Math.max(d-e,0):a.data),g=a.data>0?b(Math.max(0,c))-f:b(a.data<c?c:a.data)-b(0),h=a.data>0?a.pOffset+a.data:a.nOffset,i=b(h>=0?h>d?d:h:h<c?c:h);return g/2+i});app.chartCommons.commentUtils.addCommentIcon(b.ChartInPageId,gb,function(a){return Ua.bandwidth()/2-5},function(a){var b=Aa,c=ea,d=da;ca.enable&&ca.measures[a.seriesKey]===!0&&(b=Da,c=Ca,d=Ba);var e=a.data>0?b(Math.max(0,c))-b(a.data>d?d:a.data):b(a.data<c?c:a.data)-b(0),f=b(a.data>=0?a.data>d?d:a.data:0);return f+e/2-24}),t&&app.chartCommons.commentUtils.setOnHighlightListener(cb.selectAll(".series"),b.ChartInPageId);gb.selectAll(".comment");gb._groups.forEach(function(a,b){var c=ob[b]||[];a=_.reverse(a),c=_.reverse(c),a.forEach(function(a,b){c[b]||null})})}else{var gb=cb.selectAll("nothings").data(function(a){var b=a.series.filter(function(a){return"series"==a.type&&"bar"==a.prop.seriesType&&!a.prop.hidden}),c=a.series.map(function(a){return a.label}),d=a.series.map(function(a){return a.data});return g(b,d,c),b}).enter().append("g").attr("class",function(a){return"series series-"+a.sIndex}).attr("transform",function(a,b){return eb?"":"translate("+Va(a.label)+",0)"});gb.append("rect").attr("sss","xxxs").attr("width",eb?Ua.bandwidth():Va.bandwidth()).attr("fill",function(a,b){var c=h(a,b,a.prop.seriesColor);return a.thenRows&&$.each(a.thenRows,function(b,d){$.each(d,function(b,d){if(a.label!=d.firstField)return!0;switch(+d.operand){case 1:d.isStriped?(c=app.chartCommons.indicator.getStripedColor(ba,d.secondFieldColor,d.index),a.isStriped=!0,a.stripeColor=d.secondFieldColor):c=d.secondFieldColor}})}),c}).attr("stroke",function(a){return a.isStriped?a.stripeColor:null}).attr("y",function(a){var b=Aa,c=ea,d=da;return ca.enable&&ca.measures[a.seriesKey]===!0&&(b=Da,c=Ca,d=Ba),b(a.data>=0?a.data>d?d:a.data:Math.min(0,d))}).attr("height",function(a){var b=Aa,c=ea,d=da;ca.enable&&ca.measures[a.seriesKey]===!0&&(b=Da,c=Ca,d=Ba);var e=a.data>0?b(Math.max(0,c))-b(a.data>d?d:a.data):b(a.data<c?c:a.data)-b(Math.min(0,d));return e}).on("click",function(a,c){t&&app.chartCommons.commentUtils.clickOnCommentIcon(c,b.ChartInPageId)}),app.chartCommons.commentUtils.addCommentIcon(b.ChartInPageId,gb,function(a){
return eb?Ua.bandwidth()/2-5:Va.bandwidth()/2-5},function(a){return Aa(a.data>=0?a.data>da?da:a.data:Math.min(0,da))-24}),t&&app.chartCommons.commentUtils.setOnHighlightListener(cb.selectAll(".series"),b.ChartInPageId);var pb=bb.selectAll(".gd-text").data(N).enter().append("g").attr("transform","translate("+Ua(N[0].label+"#"+N[0].index)+",0)").attr("class",function(a){return"gd-text"+(""!=a.onClickVal||Xa?" pointer":"")}).on("click",ab),ob=pb.selectAll("nothings").data(function(a){return a.series.filter(function(a){return"series"==a.type&&"bar"==a.prop.seriesType&&!a.prop.hidden})}).enter().append("text").text(function(a){return a.prop.showValues?persian(d3.format(G(a.prop.font,a.prop))(a.data),C):""}).attr("class",function(a){return"series series-"+a.sIndex}).style("font-family",function(a){return a.prop.font.fontName}).style("font-size",function(a){return a.prop.font.fontSize}).attr("fill",function(a){return a.prop.font.color}).style("font-weight",function(a){return a.prop.font.bold?"bold":"normal"}).style("font-style",function(a){return a.prop.font.italic?"italic":"normal"}).attr("x","0.3em").attr("dy",function(a){return a.data>=0?"-0.3em":"1em"}).attr("transform",function(a,b){return eb?"":"translate("+Va(a.label)+",0)"}).attr("y",function(a){var b=Aa,c=ea,d=da;return ca.enable&&ca.measures[a.seriesKey]===!0&&(b=Da,c=Ca,d=Ba),b(a.data>=0?a.data>d?d:a.data:a.data)}).on("click",function(a,c){t&&app.chartCommons.commentUtils.clickOnCommentIcon(c,b.ChartInPageId)}),mb=N.map(function(a){return a.label+"#"+a.index});ob._groups.forEach(function(a,b){a.forEach(function(a,c){var d=a.getBBox().width,e=a.getBBox().height,f=eb?Ua.bandwidth():Va.bandwidth(),g=f/2-d/2,h=(d3.select(a).data()[0],d3.select(a));h.attr("x",g);var i=h.attr("transform");d3.select(a).attr("x",g).style("text-anchor",function(a,b){return a.prop.showValuesVertical?"end":"start"}).attr("dy",function(a,b){return a.prop.showValuesVertical?"0.3em":a.data>=0?"-0.3em":"1em"}).attr("transform",function(b,d){return b.prop.showValuesVertical?"translate("+(f*c+f/2-g)+",-3) rotate(90, "+g+", "+d3.select(a).attr("y")+")":i}),d3.select(a).datum().prop.showValuesVertical||db.noConfilict(d,e,Ua(mb[b]),d3.select(a).attr("y"))||$(a).remove()})}),db.clear()}var gb=cb.selectAll("nothing").data(function(a){return a.series.filter(function(a){return"kpi"==a.type&&"bar"==a.prop.seriesType&&!a.prop.hidden})}).enter().append("g").attr("class","kpi").attr("transform",function(a,b){return"translate("+Va(a.label)+",0)"});gb.append("rect").attr("width",Va.bandwidth()).attr("y",function(a){return Aa(1.1*a.data[1])}).attr("height",function(a){return z+u.top-Aa(1.1*a.data[1])}).attr("fill","#eee"),gb.append("rect").attr("width",Va.bandwidth()).attr("y",function(a){return Aa(a.data[0])}).attr("height",function(a){return z+u.top-Aa(a.data[0])}).attr("fill",function(a,b){return D(b)}),gb.append("rect").attr("width",Va.bandwidth()).attr("y",function(a){return Aa(1*a.data[1])}).attr("height",function(a){return 0==a.data[1]?0:2}).attr("fill","#333");var qb=function(a){return a>0?"#71b37c":0==a?"#8d8d8d":"#e14d57"};gb.append("circle").attr("r",function(a){return 0==a.data[1]?0:Va.bandwidth()/2<5?Va.bandwidth()/2:5}).attr("fill",function(a){return qb(a.data[1])}).attr("cx",Va.bandwidth()/2).attr("cy",function(a){return Aa(1.1*a.data[1])-(Va.bandwidth()/2<5?Va.bandwidth()/2:5)});var rb=bb.append("g"),sb=bb.append("g"),tb=bb.append("g"),ub=bb.append("g"),vb=m(N),wb=d3.curveLinear,xb=d3.area().x(function(a){return Ua(a.label)+Ua.bandwidth()/2}).y0(z+u.top).y1(Aa(ea)).curve(wb),yb=d3.area().x(function(a){return Ua(a.label)+Ua.bandwidth()/2}).y0(z+u.top).y1(function(a){var b=Aa,c=ea,d=da;return ca.enable&&1==ca.measures[a.seriesKey]&&(b=Da,c=Ca,d=Ba),b(a.value>d?d:a.value<c?c:a.value)}).curve(wb),zb=d3.line().x(function(a){return Ua(a.label)+Ua.bandwidth()/2}).y(function(a){var b=Aa,c=ea;return ca.enable&&1==ca.measures[a.seriesKey]&&(b=Da,c=Ca),b(c)}).curve(wb),Ab=d3.line().x(function(a){return Math.floor(Ua(a.label)+Ua.bandwidth()/2)}).y(function(a){var b=Aa,c=ea,d=da;return ca.enable&&1==ca.measures[a.seriesKey]&&(b=Da,c=Ca,d=Ba),Math.floor(b(a.value>d?d:a.value<c?c:a.value))}).curve(wb),y=sb.selectAll("nothings").data(vb).enter().append("path").attr("class",function(a){return"area  series-"+a.sIndex}).attr("id",function(a,b){return"area"+b}).attr("fill",function(a,c){return b.chartProp.indicator&&b.chartProp.indicator.length?"url(#"+b.id+"-"+c+")":a.prop.seriesColor}).attr("z-index","-1").style("opacity",function(a){return a.prop.areaOpacity||.1}).datum(function(a){var b=a.prop.lineType;return"line-dot-area"==b||"line-area"==b?L?a.valueStacked:a.values:0});A?y.attr("d",function(a){return _.isArray(a)&&0==a.length?"M0,0":0===a?"M0,0":xb.curve(j(a[0].prop.lineStyle))(a)}).transition().duration(b.animationDuration).attr("d",function(a){return _.isArray(a)&&0==a.length?"M0,0":0===a?"M0,0":yb.curve(j(a[0].prop.lineStyle))(a)}):y.attr("d",function(a){return _.isArray(a)&&0==a.length?"M0,0":0===a?"M0,0":yb.curve(j(a[0].prop.lineStyle))(a)}),y=tb.selectAll("nothings").data(vb).enter().append("path").attr("class",function(a){return"line  series-"+a.sIndex}).attr("id",function(a,b){return"line"+b}).attr("stroke",function(a,c){return b.chartProp.indicator&&b.chartProp.indicator.length?"url(#"+b.id+"-"+c+")":a.prop.seriesColor}).attr("stroke-width",function(a,b){return a.prop.lineWeight}).attr("stroke-dasharray",function(a,b){return a.prop.lineFace}).datum(function(a){var b=a.prop.lineType;return"line-dot-area"==b||"line-dot"==b||"line-area"==b||"line"==b?L?a.valueStacked:a.values:0}),A?y.attr("d",function(a){return _.isArray(a)&&0==a.length?zb:0===a?zb:zb.curve(j(a[0].prop.lineStyle))(a)}).transition().duration(b.animationDuration).attr("d",function(a){return _.isArray(a)&&0==a.length?Ab:0===a?Ab:Ab.curve(j(a[0].prop.lineStyle))(a)}):y.attr("d",function(a){return _.isArray(a)&&0==a.length?Ab:0===a?Ab:Ab.curve(j(a[0].prop.lineStyle))(a)});var Xa=b.chartProp.globalvariable&&b.chartProp.globalvariable.length>0&&!b.editMode&&b.chartProp.globalvariable.filter(function(b){return b.field==a.CurrentDimName}).length>0,Bb=function(c,d,e){if(t)return void app.chartCommons.commentUtils.clickOnCommentIcon(d,b.ChartInPageId);if(b.chartProp.globalvariable&&b.chartProp.globalvariable.length>0&&!b.editMode&&(app.globalVariableHelper.updateGlobalVariables([a.CurrentDimName],[d.primv],b.chartProp.globalvariable),$(s+" .circle.selected-item").attr("class",$(this).attr("class").replace("selected-item","")),$(s+" .gd.selected-item").attr("class",$(this).attr("class").replace("selected-item","")),$(this).attr("class",$(this).attr("class")+" selected-item")),""==d.onClickVal)return void(B&&!b.editMode&&app.chartCommons.openLink(b.chartProp.info.openDashboard,{ChartInPageId:b.ChartInPageId,DataSourceId:b.input.DataSourceId,dimensionName:b.input.dimensionName,value:d.value,refreshDatasource:b.input.RefreshDatasource}));if(!E()){F(!0),b.isSort=f,app.chartCommons.drillDown.add(b.ChartInPageId,b.input.DataSourceId,b.input.CurrentDimName,d.onClickVal,b.input),b.parameters={selectedItem:d.onClickVal,chartId:b.chartId,ChartInPageId:b.ChartInPageId,notEditMode:!b.editMode},app.chartCommons.levelTypeUtils.getParam(b),$(s).charts(b.type,"refreshWithData",b);var f=X.property("checked")}};tempG=ub.selectAll("nothings").data(vb).enter().append("g").attr("class",function(a){return"circle-group "+(""!=a.onClickVal||Xa?" pointer":"")});var Cb=tempG.selectAll(".entry").data(function(a){return L?a.valueStacked:a.values}).enter().append("g").attr("class","entry"),y=Cb.append("circle").attr("s-index",function(a){return a.sIndex}).attr("class",function(a){return"circle series-"+a.sIndex}).attr("stroke",function(a,c){var d=d3.select(this.parentNode).datum().seriesLable,e=N[c].series.map(function(a){return a.label}),f=N[c].series.map(function(a){return a.data}),g=app.chartCommons.indicator.getIndicator(f,e,b.chartProp.indicator),h=a.prop.seriesColor,i=_.flatten(g);return _.each(i,function(a){if(d!==a.firstField)return!0;switch(+a.operand){case 1:h=a.secondFieldColor}}),h}).attr("stroke-width",function(a,b){return a.prop.lineWeight}).on("click",Bb).on("mouseover",function(a,b){d3.select(this).attr("stroke-width",parseInt(b.prop.lineWeight)+3)}).on("mouseout",function(a,b){d3.select(this).attr("stroke-width",b.prop.lineWeight)}).attr("cx",function(a){return Ab.curve(j(a.prop.lineStyle)).x()(a)}).style("opacity",function(){var a=d3.select(this.parentNode).datum().prop.lineType;return"line-area"==a||"line"==a?0:1}).attr("r","4");if(A?y.attr("cy",Aa(ea)).transition().duration(b.animationDuration).attr("cy",function(a){return Ab.curve(j(a.prop.lineStyle)).y()(a)}):y.attr("cy",function(a){return Ab.curve(j(a.prop.lineStyle)).y()(a)}),app.chartCommons.commentUtils.addCommentIcon(b.ChartInPageId,Cb,function(a){return Ab.curve(j(a.prop.lineStyle)).x()(a)-5},function(a){return Ab.curve(a.prop.lineStyle).y()(a)-24}),t){var Ya=tempG.selectAll(".entry");app.chartCommons.commentUtils.setOnHighlightListener(tempG.selectAll(".entry"),b.ChartInPageId)}b.chartProp.indicator&&b.chartProp.indicator.length&&rb.attr("class","colorStepGroups").selectAll(".colorStepGroup").data(vb).enter().append("linearGradient").attr("id",function(a,c){return b.id+"-"+c}).attr("class","colorStepGroup").attr("gradientUnits",function(a){var c=_.filter(b.chartProp.indicator,function(b){return _.map(b.thenRow,"firstField").indexOf(a.label)!==-1});return c.length?"objectBoundingBox":"userSpaceOnUse"}).selectAll("stop-color").data(function(a){var c=[],d=1/(2*(a.values.length-1)),e=-1*d;return a.values.map(function(f,g){var h={value:f.value,label:a.label,color:a.prop.seriesColor},i=N[g].series.map(function(a){return a.label}),j=N[g].series.map(function(a){return a.data}),k=app.chartCommons.indicator.getIndicator(j,i,b.chartProp.indicator),l=a.prop.seriesColor,m=_.flatten(k);_.each(m,function(a){if(h.label!==a.firstField)return!0;switch(+a.operand){case 1:l=a.secondFieldColor}}),h.color=l,h.offset=e<0?0:e,c.push(h),h=$.extend({},h),e+=2*d,h.offset=e>1?e-d:e,c.push(h)}),c}).enter().append("stop").attr("stop-color",function(a,b){var c=a.color;return c}).attr("offset",function(a){return a.offset}),y=ub.selectAll("nothings").data(vb).enter().append("g").attr("class",function(a){return"text-vals"}).selectAll("text").data(function(a){return a.prop.showValues?L?a.valueStacked:a.values:0}).enter().append("g"),y.append("text").text(function(a){return persian(d3.format(G(a.prop.font,a.prop))(a.valueLabel),C)}).style("font-family",function(a){return a.prop.font.fontName}).style("font-size",function(a){return a.prop.font.fontSize}).attr("fill",function(a){return a.prop.font.color}).style("font-weight",function(a){return a.prop.font.bold?"bold":"normal"}).style("font-style",function(a){return a.prop.font.italic?"italic":"normal"}).style("text-anchor",app.lang.isRtl()?"start":"end").attr("dy","-10"),k(y),y.attr("class",function(a){return"text-value pointer series-"+a.sIndex}).attr("x",function(a,b){var c=d3.select(this).node().getBBox().width;return Ab.curve(j(a.prop.lineStyle)).x()(a)-c/2}).attr("transform",function(a,b){var c=d3.select(this).node().getBBox().width,d=Ab.curve(j(a.prop.lineStyle)).y()(a);return"translate("+(Ab.curve(j(a.prop.lineStyle)).x()(a)-c/2)+","+d+")"}).on("click",Bb),A?y.attr("transform",function(a,b){var c=d3.select(this).node().getBBox().width;return"translate("+(Ab.curve(j(a.prop.lineStyle)).x()(a)-c/2)+","+Aa(ea)+")"}):y.attr("transform",function(a,b){var c=d3.select(this).node().getBBox().width,d=Ab.curve(j(a.prop.lineStyle)).y()(a);return"translate("+(Ab.curve(j(a.prop.lineStyle)).x()(a)-c/2)+","+d+")"}),$(s+" .circle").each(function(){var a=$(this);$(this).tipsy({gravity:l(a),html:!0,title:function(){var a=+b.chartProp.info.tooltip||1,c="",d=$(this).parent("g.entry").index(),e=+$(this).attr("s-index");return c=i(d,a,"line",e)}})}),$(s+" .text-value").each(function(){var a=$(this);$(this).tipsy({gravity:l(a),html:!0,title:function(){var a=+b.chartProp.info.tooltip||1,c="",d=$(this).index(),e=$(this).parent("g.text-vals").index()-$(this).parent("g.text-vals").parent().children().length/2;return c=i(d,a,"line",e)}})}),X.on("change",n),Y.on("change",n);var Db=!0,Eb=setTimeout(function(){b.isSort?X.property("checked",!0).each(n):X.each(n),Db=!1},0);$(s).trigger("heightChange")};var chartTypes={BAR:1,PIE:2,LINE:3,GAUGE:4,TABLE:5,MAP:6,UserControl:7,Radar:8,Tree:9,Text:10,CE_MAP:{1:"barLine",2:"pie",4:"gauge",5:"table",6:"map",7:"userControl",8:"radar",9:"tree",10:"text"},NAMES:{1:"نمودار خطی-میله‌ای",2:"نمودار دایره‌ای",4:"نمودار عقربه‌ای",5:"جدول",7:"کنترل کاربری",8:"نمودار رادار",9:"نمودار درختی",10:"متن"}};!function(a){function b(b,c,d){var e=a(this).data("settings");if("undefined"!=typeof e)return e.isRefresh=!0,e=a.extend(e,c),e.chartProp.info.disable&&!e.editMode?void f(e):(setTimeout(function(){i(b,e.input,e,!0,d),e.parameters.selectedItem=null,e.parameters.isUp=!1},0),this)}function c(b){if(b.editMode){var c=b.chartProp.info||{};b.type.isCustom&&(c=b.chartProp.general.info||{});var d=a("#"+b.id).parents(".chart-widget");c.backgroundColor&&d.find(".ui.card ").css("background",c.backgroundColor),c.dontShowTitle===!0?d.find(".ui.card .title-content").hide():d.find(".ui.card .title-content").show(),c.titleFont&&(d.find(".ui.card .title-content").css({"font-size":c.titleFont.fontSize,color:c.titleFont.color,"font-family":c.titleFont.fontName,"font-weight":c.titleFont.bold?"bold":"normal","font-style":c.titleFont.italic?"italic":"normal"}),d.find(".ui.card .title").css({"text-align":c.titleFont.align}))}}function d(a){try{var b=a.data("ajaxRequest");null!=b&&b.abort&&b.abort()}catch(c){}return this}function e(b,c,e){d(a(this)),e=a.extend({refreshRelatedDatasources:!0},e);var g=(a(this),a(this).data("settings"));if(g=a.extend(g,c),g.isRefresh=!1,"undefined"!=typeof g.chartProp){if("undefined"==typeof b.isCustom&&(b={id:+b,isCustom:!1}),g.chartProp.info.disable&&!g.editMode)return void f(g);app.chartCommons.setFilterParameter(g),g.parameters.filterHierarchy=app.chartCommons.getFilterHierarchy(g.ChartInPageId),g.editMode&&(g.parameters.ChartInfo=a("#divChart").data("chartInfo"));var j=[];if(b.id===chartTypes.TABLE)for(var l in g.chartProp.series)g.chartProp.series.hasOwnProperty(l)&&j.push({Name:l,Type:g.chartProp.series[l].rowResult});g.dataUrl=h(b);var m=a.extend(g.parameters,{resultRows:j,type:g.dataType}),n=app.mobileMode&&2===app.mobileScriptVersion?m:JSON.stringify(m);e.refreshRelatedDatasources&&g.ChartInPageId&&(app.moderation.dashboadpage.refreshRelatedDatasources(g.input.RefreshDatasource,[+g.ChartInPageId],g.chartProp.info.groups),app.filterBox&&app.filterBox.refresh&&app.filterBox.refresh());var o=app.mobileMode?proxy.ajax:a.ajax,p=k[g.ChartInPageId];return p&&p.abort&&p.abort(),p=o({url:g.dataUrl,type:"POST",dataType:"json",contentType:"application/json",data:n,async:g.async,requestId:g.requestId,success:function(a){i(b,a,g,!0),g.parameters.selectedItem=null,g.parameters.isUp=!1}}),k[g.ChartInPageId]=p,this}}function f(b){var c="#"+b.id;a(c).empty(),a(c).html('<div class="temporal" style="display: flex;justify-content: center;flex-direction: column;text-align: center; align-items: center;flex: 1">                <img style="margin:12px;"width="32" src="'+app.urlPrefix+'images/barricade-256.png"/>                <p>نمودار در حال تغییر است</p>            </div > ')}function g(b,c){var d=a.extend({},j,c),e=a(this);if(d.id=e.attr("id"),d.type=b,e.data("isChart",!0),e.data("settings",d),"undefined"==typeof b.isCustom&&(b={id:+b,isCustom:!1}),d.chartProp.info.disable&&!d.editMode)return void f(d);app.chartCommons.setFilterParameter(d),app.chartCommons.levelTypeUtils.getParam(d),b=d.type;var g=[];if(b.id===chartTypes.TABLE)for(var l in d.chartProp.series)d.chartProp.series.hasOwnProperty(l)&&g.push({Name:l,Type:d.chartProp.series[l].rowResult});d.dataUrl=h(b);var m=app.mobileMode?proxy.ajax:a.ajax,n=a.extend(d.parameters,{resultRows:g,type:d.dataType}),o=app.mobileMode&&2===app.mobileScriptVersion?n:JSON.stringify(n),p=app.customChart.getConfig(b,d.chartProp.info);if(p.needServerData===!1)i(b,{result:!0},d,!1);else{var q=k[d.ChartInPageId];q&&q.abort&&q.abort(),q=m({url:d.dataUrl,type:"POST",dataType:"json",data:o,cache:!1,contentType:"application/json",success:function(c,e,f){d.mobileModeData={isOnline:e,date:f},"undefined"==typeof d.chartProp&&c.detail&&(d=a.extend(d,JSON.parse(c.detail))),d.beforeDraw&&d.beforeDraw(d),i(b,c,d,!1),d.parameters.selectedItem=null,d.parameters.isUp=!1},error:function(b){d.error&&d.error(d),!app.mobileMode&&b&&b.responseJSON&&b.responseJSON.forceSignout&&(console.log("شما از برنامه خارج شده‌اید. ممکن است کاربر دیگری با نام کاربری شما وارد سیستم شده باشد."),alert("شما از برنامه خارج شده‌اید. ممکن است کاربر دیگری با نام کاربری شما وارد سیستم شده باشد."),window.location.href=app.urlPrefix);var c="#"+d.id;a(c).addClass("bar-chart").empty(),b&&b.responseJSON&&b.responseJSON.desc?a(c).addClass("bar-chart").html(filterXSS('<div class="temporal"><b>'+b.responseJSON.title+' </b>  <span class="glyphicon glyphicon-info-sign"> </span> <br/ > <p style="direction:ltr;">'+b.responseJSON.desc+"</p></div>")):a(c).addClass("bar-chart").html('<div class="temporal">خطا در دریافت اطلاعات <span class="glyphicon glyphicon-info-sign"> </span></div>'),a(c).css({display:"flex",overflow:"auto",padding:"20px 14px","flex-flow":"column"})},requestId:d.requestId}),k[d.ChartInPageId]=q}return e}function h(a){if(a.isCustom)return app.urlPrefix+"api/chartdata/getdata";switch(parseInt(a.id)){case chartTypes.UserControl:return app.urlPrefix+"api/chartdata/GetColumnMembers";case chartTypes.Tree:return app.urlPrefix+"api/BarChart/getTreeData";default:return app.urlPrefix+"api/chartdata/getdata"}}function i(b,d,e,f,g){var h="#"+e.id;if(e.selector=h,d.series&&d.series.labels){e.chartProp.series=e.chartProp.series||{};var i=_.difference(Object.keys(e.chartProp.series),d.series.labels),j=_.difference(d.series.labels,Object.keys(e.chartProp.series));_.each(d.series.labels,function(a,b){if(b=j.indexOf(a),e.chartProp.series&&!e.chartProp.series[a]){var c=Math.min(i.length,b),d=i[c];e.chartProp.series[a]=_.merge({},e.chartProp.series[d])}})}var k=_.merge({enable:!1},e.chartProp.info.sort);if(k.enable&&k.serie){var l=_.indexOf(d.series.labels,k.serie);if(l!==-1){var m=_.map(d.series.data,function(a,b){return{data:+a[l],index:b}}),n=_.orderBy(m,"data",k.type||"asc");d.matrix=_.map(n,function(a){return d.matrix[a.index]}),d.series.data=_.map(n,function(a){return d.series.data[a.index]})}}if(e.editMode||dashboard.setLastRefresh(e.ChartInPageId,d.LastRefresh),e.editMode){if(b.isCustom||b.id>=12){var o="undefined"!=typeof d.series?d.series.labels:[],p="undefined"!=typeof d.kpis?d.kpis.labels:[];a(h).trigger("chartproperty",[p.concat(o)])}a(h).trigger("dimColor",[_.map(d.matrix,function(a){return a.values.join("-")})])}if(c(e),e.input=d,arguments.length<4)return void a.error("تعداد پارامترها باید حداقل چهار تا باشد");if("undefined"!=typeof e.chartProp){e.chartProp=_.extend({info:{}},e.chartProp);var q=0;if(e.chartProp.info.refreshPeriod&&(q=+e.chartProp.info.refreshPeriod),e.type.isCustom&&e.chartProp.general.info&&(q=+e.chartProp.general.info.refreshPeriod),q>0){var r=a("#"+e.id).data("timeout");r&&clearTimeout(r);var s=setTimeout(function(){a("#"+e.id).charts(b,"refreshWithData",null,{refreshRelatedDatasources:!1})},1e3*q);a("#"+e.id).data("timeout",s)}a("#dashboard-chart-panel").trigger("chartComplete",[e,d]),f&&!g?a(h).parents(".chart-widget").find(".temporal").remove():a(h).addClass("bar-chart").empty(),e.fromCommentDialog&&a(h).addClass("fromCommentDialog"),d=a.extend({EditPermission:!1,Description:"",LastRefresh:0,isFresh:!0,title:""},d);var t={title:null,showProgress:function(){},isProgress:function(){}};if(t=d3.select(h).titlebar({EditPermission:d.EditPermission,editLink:e.editLink,RemoveFromPage:e.RemoveFromPage,deleteLink:e.removeLink,desc:d.Description,LastRefresh:d.LastRefresh,isFresh:d.isFresh,title:d.title,chartId:e.chartId,ChartInPageId:e.ChartInPageId,type:b,editMode:e.editMode,refreshWithData:f,redrowAll:g,settings:e,showFilterIcon:"undefined"==typeof e.chartProp.info.showFilterIcon?1:+e.chartProp.info.showFilterIcon}),e.titlebar=t,t.showProgress(!1),!d.result)return a("#"+e.id).append(app.chartCommons.getError(d)),void a("#"+e.id).css({display:"flex",overflow:"auto","margin-top":"20px",padding:"20px 14px","flex-flow":"column"});if("undefined"==typeof b.isCustom&&(b={id:+b,isCustom:!1}),b.isCustom){e.selector="#"+e.id;var o="undefined"!=typeof d.series?d.series.labels:[],p="undefined"!=typeof d.kpis?d.kpis.labels:[];return e.editMode&&a(e.selector).trigger("chartproperty",[p.concat(o)]),void app.customChart.charts[b.id](d,e,f,t)}switch(parseInt(b.id)){case chartTypes.BAR:app.charts.bar.draw(d,e,f,t);break;case chartTypes.GAUGE:app.charts.gauge.draw(d,e,f,t);break;case chartTypes.PIE:app.charts.pie.draw(d,e,f,t);break;case chartTypes.TABLE:app.charts.table.draw(d,e,f,t);break;case chartTypes.MAP:app.charts.map.draw(d,e,f,t);break;case chartTypes.UserControl:app.charts.userControl.draw(d,e,f,t);break;case chartTypes.Radar:app.charts.radar.draw(d,e,f,t);break;case chartTypes.Tree:app.charts.tree.draw(d,e,f,t);break;case chartTypes.Text:app.charts.text.draw(d,e,f,t)}if(b.id>10){var u=_.find(app.charts.list,{type:b.id});u&&u.draw(d,e,f,t)}app.lang.setLang({selector:h}),e.finishDraw&&e.finishDraw(e),app.chartCommons.renderComments(e,d)}}var j={isSort:!1,fadeSpeed:200,fadeinEasing:"easeInOutCubic",chartId:-1,animationDuration:1e3,animationEase:"cubic-out"},k={};jQuery.fn.charts=function(c,f){var h={init:g,refresh:b,refreshWithData:e,abort:d};if(h[f]){var i=Array.prototype.slice.call(arguments,0);return f=i.splice(1,1),h[f].apply(this,i)}return"object"!=typeof method&&"undefined"!=typeof method&&f?void a.Error("Method "+f+" does not exist on jQuery.sitBarChart: you must specify type"):h.init.apply(this,arguments)},app.chartCommons.draw=i,app.customChart={cacheJs:{},charts:{},getJs:function(b,c,d){return"undefined"!=typeof app.customChart.cacheJs[b]?void c(app.customChart.cacheJs[b]):void a.ajax({url:app.urlPrefix+"api/customcharts/getjs/"+b,cache:!0}).done(function(d){app.customChart.cacheJs[b]=d;var e=a("head script#id-"+b);e.length||(a("head").append("<script id=id-"+b+"> app.customChart.charts["+b+"] = function(input, settings, refreshWithData, titlebar){\n"+d.code+"\n}</script>"),a("head").append('<style type="text/css">\n'+d.css+"\n</style>")),c(d)}).fail(function(a,b,c){d&&d()})},getConfig:function(a,b){var c={};return app.customChart.config&&app.customChart.config[a.id]&&a.isCustom&&(c=app.customChart.config[a.id]||{}),a.isCustom?c:app.chartCommons.getChartConfig(a.id,b||{})}}}(jQuery);var app=app||{};app.charts=app.charts||{},app.charts.gauge={},app.charts.gauge.draw=function(a,b,c,d){function e(a,b){return"undefined"==typeof a?null:a[b]}function f(a,b){return isNaN(a)?b?-99999:99999:parseFloat(a)}function g(a,b,c,d){var e=150,f="arc"==d?150:"number"==d?100:60;if(a>=c*e)return{w:a/c,h:Math.max(b,f)};if(b>=c*f)return{w:Math.max(a,e),h:b/c};var g=Math.ceil(1*a/e),h=Math.ceil(1*c/g);return{w:Math.max(a/g,e),h:Math.max(b/h,f)}}function h(a,c,d,e,f){function g(a){return"auto"===a[5]?m:a[5]}var h=5;f-=48;var i=d3.select(a).selectAll("nothings").data(function(a){return a.kpis}).enter().append("div").styles({width:f+"px","margin-left":"10px","margin-right":"10px"}).append("div");if(b.chartProp.info.showLabels){i.append("div").style("color",H.color).style("font-family",H.fontName).style("font-size",H.fontSize).style("font-weight",H.bold?"bold":"normal").style("font-style",H.italic?"italic":"normal").text(function(a,b){var d=p[b];return persian(c.label+(d?" - "+d:""),n)})}var j=i.append("div"),k=j.append("div").style("text-align","left").style("position","relative");va=$(j._groups[0][0]).width();var l=j.append("svg").attr("width",va).attr("class","line-svg").attr("height",v+2*h),m=0,o=0;if(ka>=0&&ja>=0)m=0,o=1.2*ja;else{var q=Math.max(Math.abs(ja),Math.abs(ka));m=q*-1.2,o=1.2*q}var r=(d3.scaleLinear().range([0,va]).domain([m,o]),[]);j.each(function(a,b){r.push(d3.scaleLinear().range([0,va]).domain([g(a),a[4]||o]))}),l.append("rect").attr("height",v).attr("y",h).attr("fill",la[0]).attr("width",va),l.append("rect").attr("height",v).attr("y",h).attr("fill",function(a,b){return pa(a[2])}).attr("width",0).transition().duration(b.animationDuration).attr("width",function(a,b){return r[b](a[0])<0?0:r[b](a[0])}),l.append("rect").attr("width","5").attr("x","0").attr("y","0").attr("height",v+h).attr("fill","#333").transition().duration(b.animationDuration).attr("x",function(a,b){return r[b](a[0])-5<g(a)?g(a):r[b](a[0])-5}),l.filter(function(a){return!isNaN(a[1])}).append("path").attr("transform",function(a,b){return"translate("+(r[b](a[1])<g(a)?g(a):r[b](a[1]))+",0)"}).attr("d","M0 "+h+" 0 "+(v+2*h)).attr("stroke-dasharray","2,2").attr("stroke-width","2").attr("stroke","black").attr("fill","none").attr("class","target-pointer").style("display",function(a){return isNaN(a[1])?"none":"auto"});var s=j.append("div").style("text-align","left").style("position","relative");k.append("div").attr("class","gauge-value").style("color",G.color).style("font-family",G.fontName).style("font-size",G.fontSize).style("font-weight",G.bold?"bold":"normal").style("font-style",G.italic?"italic":"normal").text(function(a){return persian(d3.format(G.formatString)(a[0]),n)}).style("left","0").transition().duration(b.animationDuration).style("left",function(a,b){var c=$(this).outerWidth(),d=r[b](a[0])-5-c/2;return d<0&&(d=0),d+c>va&&(d=va-c),d+"px"}).tween("text",function(a){var b=qa("0",a[0]),c=this;return function(a){c.textContent=b(a)}});var t=(s.filter(function(a){return!isNaN(a[1])}).append("div").attr("class","gauge-target").text(function(a){return persian(d3.format(G.formatString)(a[1]),n)}).style("left",function(a,b){var c=$(this).outerWidth(),d=r[b](a[1])-5-c/2;return d<0&&(d=0),d+c>va&&(d=va-c),d+"px"}).style("color",I.color).style("font-family",I.fontName).style("font-size",I.fontSize).style("font-weight",I.bold?"bold":"normal").style("font-style",I.italic?"italic":"normal").style("display",function(a){return isNaN(a[1])?"none":"auto"}),$(k._groups[0][0]).find(".gauge-value").outerHeight()),u=$(s._groups[0][0]).find(".gauge-target").outerHeight();k.style("height",t+"px"),$(k._groups[0][0]).find(".gauge-value").css("height",t+"px"),$(k._groups[0][0]).find(".gauge-value").css("position","absolute"),s.style("height",u+"px"),$(s._groups[0][0]).find(".gauge-target").css("height",u+"px"),$(s._groups[0][0]).find(".gauge-target").css("position","absolute")}function i(a,c,d,e,f){function g(c){var d=_.filter(c,{operand:"6"});d&&d.length?($(d3.select(a).node()).parents(".ui.card ").css("background",d[0].secondFieldBackColor),wa=!0):wa||app.chartCommons.setBackground($(d3.select(a).node()).parents(".ui.card "),b.chartProp.info)}var h=d3.select(a);h.style("visibility","hidden");var i=d3.select(a).selectAll("nothings").data(function(a){return a.kpis}).enter().append("div");if(b.chartProp.info.haveCustomText)return i.append("div").attr("class","custom-text-gauge").call(function(a){var e=_.reduce(app.chartCommons.indicator.getIndicator(J[d].series,o,b.chartProp.indicator),function(a,b){return a=a||[],a.push(b),a}),f=o[0];_.forOwn(b.chartProp.series,function(a,c){"value"===b.chartProp.series[c].type&&(f=c)});var h=_.filter(e,{firstField:f});a.html(function(a,e){var f=p[e],i=persian(c.label+(f?" - "+f:""),n),j=persian(a[0],n);_.isNumber(a[0])&&(j=persian(d3.format(G.formatString)(a[0]),n));var k=_.filter(h,{operand:"2"}),l="",m="icon";b.chartProp.info.icons&&b.chartProp.info.icons.length&&(l=b.chartProp.info.icons[d%b.chartProp.info.icons.length],"string"==typeof l?l="":(m=l.type||"icon",l=l.name)),k.length&&(l=k[k.length-1].secondFieldIcon.name,m=k[k.length-1].secondFieldIcon.type),g(h);var o=_.filter(h,{operand:"1"}),q=G.color;o.length&&(q=o.pop().secondFieldColor);var r="";"icon"===m&&(r='<i class="'+l+'"></i>'),"image"===m&&(r='<img style="width:1.5em" src="'+app.urlPrefix+"api/upload/getpic/"+l+'"></i>');var s=b.chartProp.info.customText.replace("@value",'<span class="ltr inline" title="'+j+'">'+j+"</span>").replace("@label",i).replace("@icon",r);return s})}),void $(h.node()).transition("scale");var j="small"===b.chartProp.info.height?"mini":"medium"===b.chartProp.info.height?"tiny":"large"===b.chartProp.info.height?"":"large",k=i.append("div").attr("class","ui xstatistic "+j).call(function(a){var c=_.reduce(app.chartCommons.indicator.getIndicator(J[d].series,o,b.chartProp.indicator),function(a,b){return a=a||[],a.push(b),a}),e=o[0];_.forOwn(b.chartProp.series,function(a,c){"value"===b.chartProp.series[c].type&&(e=c)});var f=_.filter(c,{firstField:e});g(f),a.styles({color:G.color,"font-family":G.fontName,"font-size":G.fontSize,"font-weight":G.bold?"bold":"normal","font-style":G.italic?"italic":"normal"});var h=function(a){return _.isNumber(a[0])?persian(d3.format(G.formatString)(a[0]),n):persian(a[0],n)};a.append("div").classed("value",!0).style("white-space","nowrap").style("line-height","1").append("span").attr("class","text ltr inline").attr("title",h).text(h),a.select(".value").append("span").html(function(a,c){var e=_.filter(f,{operand:"2"}),g="",h="icon";b.chartProp.info.icons&&b.chartProp.info.icons.length&&(g=b.chartProp.info.icons[d%b.chartProp.info.icons.length],"string"==typeof g?g="":(h=g.type||"icon",g=g.name)),e.length&&(g=e[e.length-1].secondFieldIcon,h=e[e.length-1].secondFieldIcon.type);var i=_.filter(f,{operand:"1"}),j=G.color;i.length&&(j=i.pop().secondFieldColor);var k="";return"icon"===h&&(k='<i class="'+g+'" style="color:'+j+"; fontSize:"+G.fontSize+'; margin:0 10px;"></i>'),"image"===h&&(k='<img style="width:1.5em" src="'+app.urlPrefix+"api/upload/getpic/"+g+'"></i>'),k})}).call(function(a){var d=a.append("div").classed("xlabel",!0).styles({"font-family":G.fontName,"line-height":"1.7em","font-size":"40%","font-weight":"300"});b.chartProp.info.valueStaticTop&&d.append("div").attr("title",b.chartProp.info.valueStaticTop).text(b.chartProp.info.valueStaticTop),b.chartProp.info.showLabels&&d.append("div").style("color",H.color).style("font-family",H.fontName).style("font-size",H.fontSize).style("font-weight",H.bold?"bold":"normal").style("font-style",H.italic?"italic":"normal").attr("title",function(a,b){var d=p[b];return persian(c.label+(d?" - "+d:""),n)}).text(function(a,b){var d=p[b];return persian(c.label+(d?" - "+d:""),n)}),b.chartProp.info.valueStaticDown&&d.append("div").attr("title",b.chartProp.info.valueStaticDown).text(b.chartProp.info.valueStaticDown)});k.call(function(a){var b=$(q).width(),c=$(q).height(),d=a.node().getBoundingClientRect().width,e=a.node().getBoundingClientRect().height,f=1,g=1;b<d&&(f=b/d),c<e&&(g=c/e),a.style("transform","scale("+Math.min(g,f)+")")}),h.style("display","none"),h.style("visibility","visible"),$(h.node()).transition("scale"),setTimeout(function(){},1e3)}function j(a,c,d,e,f){var g=5;f-=48;var h=d3.select(a).selectAll("nothings").data(function(a){return a.kpis}).enter().append("div").styles({"margin-left":"10px","margin-right":"10px",width:f+"px"}).append("div"),i="12";if(b.chartProp.info.showLabels){h.append("div").style("color",H.color).style("font-family",H.fontName).style("font-size",H.fontSize).style("font-weight",H.bold?"bold":"normal").style("font-style",H.italic?"italic":"normal").text(function(a,b){var d=p[b];return persian(c.label+(d?" - "+d:""),n)});var i="9"}var j=h.append("div").attr("class","col-md-"+i),k=j.append("div").style("text-align","left").style("position","relative");va=$(j._groups[0][0]).width();var l=j.append("svg").attr("width",va).attr("height",v+2*g),m=[];l._groups.forEach(function(a,b){var c=a[0].__data__;m.push(d3.scaleLinear().range([0,va]).domain([c[3],c[6]]))}),l.append("rect").attr("height",v).attr("y",g).attr("fill",oa).attr("width",va),l.append("rect").attr("height",v).attr("y",g).attr("fill",na).attr("width",function(a,b){
return m[b](a[5])}),l.append("rect").attr("height",v).attr("y",g).attr("fill",ma).attr("width",function(a,b){return m[b](a[4])}),l.append("path").attr("transform",function(a,b){var c=m[b](a[3]<a[6]?a[3]:a[6]);return"translate("+(c<m[b](a[3])?m[b](a[3]):c)+",0)"}).attr("d","M0 "+g+" 0 "+(v+2*g)).attr("stroke-dasharray","2,2").attr("stroke-width","1").attr("stroke","black").attr("fill","none").attr("class","none"),l.append("path").attr("transform",function(a,b){var c=m[b](a[6]<a[6]?a[6]:a[6]);return"translate("+(c<m[b](a[3])?m[b](a[3]):c)+",0)"}).attr("d","M0 "+g+" 0 "+(v+2*g)).attr("stroke-dasharray","2,2").attr("stroke-width","1").attr("stroke","black").attr("fill","none").attr("class","none"),l.append("path").attr("transform",function(a,b){var c=m[b](a[5]<a[6]?a[5]:a[6]);return"translate("+(c<m[b](a[3])?m[b](a[3]):c)+",0)"}).attr("d","M0 "+g+" 0 "+(v+2*g)).attr("stroke-dasharray","2,2").attr("stroke-width","1").attr("stroke","black").attr("fill","none").attr("class","none"),l.append("path").attr("transform",function(a,b){var c=m[b](a[4]<a[6]?a[4]:a[6]);return"translate("+(c<m[b](a[3])?m[b](a[3]):c)+",0)"}).attr("d","M0 "+g+" 0 "+(v+2*g)).attr("stroke-dasharray","2,2").attr("stroke-width","1").attr("stroke","black").attr("fill","none"),l.append("rect").attr("width","5").attr("x","0").attr("y","0").attr("height",v+g).attr("fill","#333").transition().duration(b.animationDuration).attr("x",function(a,b){var c=m[b](a[0]<a[3]?a[3]:a[0]<a[6]?a[0]:a[6])-5;return c<m[b](a[3])?m[b](a[3]):c}),l.filter(function(a){return!isNaN(a[1])}).append("path").attr("transform",function(a,b){var c=m[b](a[1]<a[6]?a[1]:a[6])-5;return"translate("+(c<m[b](a[3])?m[b](a[3]):c)+",0)"}).attr("d","M0 "+g+" 0 "+(v+2*g)).attr("stroke-dasharray","2,2").attr("stroke-width","2").attr("stroke","black").attr("fill","none");var o=j.append("div").style("text-align","left").style("position","relative").style("margin-top","-10px");k.append("span").attr("class","gauge-value").style("color",G.color).style("font-family",G.fontName).style("font-size",G.fontSize).style("font-weight",G.bold?"bold":"normal").style("font-style",G.italic?"italic":"normal").text(function(a){return persian(d3.format(G.formatString)(a[0]),n)}).style("left","0").transition().duration(b.animationDuration).style("left",function(a,b){var c=$(this).outerWidth(),d=m[b](a[0])-5-c/2;return d<0&&(d=0),d+c>va&&(d=va-c),d+"px"}).tween("text",function(a){var b=qa(a[3],a[0]),c=this;return function(a){c.textContent=b(a)}}),o.filter(function(a){return!isNaN(a[1])}).append("span").attr("class","gauge-target").text(function(a){return persian(d3.format(G.formatString)(a[1]),n)}).style("left",function(a,b){var c=$(this).outerWidth(),d=m[b](a[1])-5-c/2;return d<0&&(d=0),d+c>va&&(d=va-c),d+"px"}),o.append("span").attr("class","gauge-target").text(function(a){return persian(d3.format(G.formatString)(a[3]),n)}).style("color",I.color).style("font-family",I.fontName).style("font-size",I.fontSize).style("font-weight",I.bold?"bold":"normal").style("font-style",I.italic?"italic":"normal").style("left",function(a,b){var c=$(this).outerWidth(),d=m[b](a[3])-c/2;return d<0&&(d=0),d+c>va&&(d=va-c),d+"px"}),o.append("span").attr("class","gauge-target").text(function(a){return persian(d3.format(G.formatString)(a[6]),n)}).style("color",I.color).style("font-family",I.fontName).style("font-size",I.fontSize).style("font-weight",I.bold?"bold":"normal").style("font-style",I.italic?"italic":"normal").style("left",function(a,b){var c=$(this).outerWidth(),d=m[b](a[6])-c/2;return d<0&&(d=0),d+c>va&&(d=va-c),d+"px"}),o.append("span").attr("class","gauge-target").text(function(a){return persian(d3.format(G.formatString)(a[4]),n)}).style("color",I.color).style("font-family",I.fontName).style("font-size",I.fontSize).style("font-weight",I.bold?"bold":"normal").style("font-style",I.italic?"italic":"normal").style("left",function(a,b){var c=$(this).outerWidth(),d=m[b](a[4])-c/2;return d<0&&(d=0),d+c>va&&(d=va-c),d+"px"}),o.append("span").attr("class","gauge-target").text(function(a){return persian(d3.format(G.formatString)(a[5]),n)}).style("color",I.color).style("font-family",I.fontName).style("font-size",I.fontSize).style("font-weight",I.bold?"bold":"normal").style("font-style",I.italic?"italic":"normal").style("left",function(a,b){var c=$(this).outerWidth(),d=m[b](a[5])-c/2;return d<0&&(d=0),d+c>va&&(d=va-c),d+"px"});var q=$(k._groups[0][0]).find(".gauge-value").outerHeight();k.style("height",q+"px"),$(k._groups[0][0]).find(".gauge-value").css("height",q+"px"),$(k._groups[0][0]).find(".gauge-value").css("position","absolute");var r=$(o._groups[0][0]).find(".gauge-target").outerHeight();o.style("height",r+"px"),$(o._groups[0][0]).find(".gauge-target").css("height",r+"px"),$(o._groups[0][0]).find(".gauge-target").css("position","absolute")}function k(a,c,d,e,f){m(a,c,d,e,f,function(d,g,h,i,j,k,l,m,o,r,s,t){function u(a){return"auto"===a[5]?z:a[5]}var w=!0;e+=28,f+=28;var x=Math.min(e/180,f/200),y=x;k=w?68:90,l=k-30,smallRadius=k-55,g=0,h=10,d=d3.select(a).style("transform","scale("+y+")").selectAll("nothings").data(function(a){return a.kpis}).enter().append("div").style("text-align","center");var z=0,A=0;if(ka>=0&&ja>=0)z=0,A=1.2*ja;else{var B=Math.max(Math.abs(ja),Math.abs(ka));z=B*-1.2,A=1.2*B}var C=[];d.each(function(a,b){C.push(d3.scaleLinear().range([i,j]).domain([u(a),a[4]||A]))});var D=d3.arc().innerRadius(k).outerRadius(l).startAngle(i).endAngle(j),E=d3.arc().innerRadius(k).outerRadius(l).startAngle(function(a){return a.start}).endAngle(function(a){return a.end}),F=d.append("div").style("margin-bottom","0").append("svg").attr("width",2*k+2*h).attr("height",2*k+2*h).append("g").attr("transform","translate("+(k+h)+","+(k+h)+")");b.chartProp.info.showLabels&&d.append("div").style("color",H.color).style("font-family",H.fontName).style("font-size",H.fontSize).style("font-weight",H.bold?"bold":"normal").style("font-style",H.italic?"italic":"normal").style("margin-top","-10px").text(function(a,b){var d=p[b];return persian(c.label+(d?" - "+d:""),n)});var J=F.append("path").attr("d",D).attr("transform","translate("+g+","+g+")").attr("fill",la[0]),K=(J.node().getBBox().height,F.append("path").attr("fill",function(a,b){return pa(a[2])}).attr("transform","translate("+g+","+g+")").transition().duration(b.animationDuration).attrTween("d",function(a,b){var c=d3.interpolate(u(a),Math.min(a[0]<u(a)?u(a):a[0],a[4]||A));return function(d){return E({start:C[b](u(a)),end:C[b](c(d))})}}),F.append("g"));K.append("rect").attr("width","5").attr("transform","translate("+(g-2.5)+","+g+")").attr("height",k+h).attr("fill","#333"),K.attr("transform","rotate("+(i*(180/Math.PI)+180)+" "+g+" "+g+" )"),K.append("circle").attr("r","5").attr("cx",g).attr("cy",g),K.transition().duration(b.animationDuration).attrTween("transform",function(a,b){var c=C[b](a[0]),d=i*(180/Math.PI)+180;if(isNaN(c))e=d;else var e=C[b](Math.min(a[0]<u(a)?u(a):a[0],a[4]||A))*(180/Math.PI)+180;var f=d3.interpolate(d,e);return function(a){return"rotate("+f(a)+" "+g+" "+g+" )"}}),F.filter(function(a){return!isNaN(a[1])}).append("path").attr("d","M"+g+" "+g+" "+g+" "+v).attr("stroke-dasharray","2,2").attr("stroke-width","1").attr("stroke","black").attr("fill","none").attr("transform",function(a,b){return"rotate("+C[b](a[1])*(180/Math.PI)+" "+g+" "+g+")translate(0,"+-k+")"}),F.filter(function(a){return!isNaN(a[1])}).append("text").attr("class","gauge-target").attr("text-anchor","middle").attr("dy","1em").style("fill",I.color).style("font-family",I.fontName).style("font-size",I.fontSize).style("font-weight",I.bold?"bold":"normal").style("font-style",I.italic?"italic":"normal").attr("title",function(a){return persian(d3.format(G.formatString)(a[1]),n)}).text(function(a){return persian(d3.format(G.formatString)(a[1]),n)}).attr("transform",function(a,b){return"rotate("+C[b](a[1])*(180/Math.PI)+" "+g+" "+g+" )translate("+g+","+(-1*k-10)+")"});$(q+" svg > g").get(0).getBBox(),F.append("text").attr("class","gauge-value").attr("text-anchor","middle").attr("dy","1em").style("fill",G.color).style("font-family",G.fontName).style("font-size",G.fontSize).style("font-weight",G.bold?"bold":"normal").style("font-style",G.italic?"italic":"normal").attr("title",function(a){return persian(d3.format(G.formatString)(a[0]),n)}).text(function(a){return persian(d3.format(G.formatString)(a[0]),n)}).attr("transform","translate("+g+",35)").transition().duration(b.animationDuration).tween("text",function(a){var b=qa(a[3],a[0]),c=this;return function(a){c.textContent=b(a)}})})}function l(a,c,d,e,f){m(a,c,d,e,f,function(d,g,h,i,j,k,l,m,o,q,r,s){function t(a,b,c,d){C.append("path").attr("d",function(c,d){var e=c.map(function(a,b){return A[d](a)});return B({start:e[a],end:e[b]})}).attr("fill",c).attr("transform","translate("+d+","+d+")")}function u(a){C.append("path").attr("d","M"+g+" "+g+" "+g+" "+(v+h+g)).attr("stroke-dasharray","2,2").attr("stroke-width","1").attr("stroke","black").attr("fill","none").attr("transform",function(b,c){return"rotate("+a(b,c)+" "+g+" "+g+")translate(0,"+(-k-h)+")"})}function w(a,b){C.append("text").attr("class","gauge-target").style("fill",I.color).style("font-family",I.fontName).style("font-size",I.fontSize).style("font-weight",I.bold?"bold":"normal").style("font-style",I.italic?"italic":"normal").attr("text-anchor","middle").attr("dy","-0.3em").attr("title",function(a){return persian(d3.format(G.formatString)(a[b]),n)}).text(function(a){return persian(d3.format(G.formatString)(a[b]),n)}).attr("transform",function(b,c){return"rotate("+A[c](a(b))*(180/Math.PI)+" "+g+" "+g+")translate("+g+","+(-k+g-h)+")"})}var x=!0;e+=28,f+=28;var y=Math.min(e/180,f/200),z=y;k=x?68:90,l=k-30,smallRadius=k-55,g=0,h=10,d=d3.select(a).style("transform","scale("+z+")").selectAll("nothings").data(function(a){return a.kpis}).enter().append("div").style("text-align","center");var A=[];d.each(function(a,b){A.push(d3.scaleLinear().range([i,j]).domain([a[3],a[6]]))});var B=(d3.arc().innerRadius(k).outerRadius(l).startAngle(i).endAngle(j),d3.arc().innerRadius(k).outerRadius(l).startAngle(function(a){return a.start}).endAngle(function(a){return a.end})),C=d.append("div").style("margin-bottom","0").append("svg").attr("width",2*k+2*h).attr("height",2*k+2*h).append("g").attr("transform","translate("+(k+h)+","+(k+h)+")");b.chartProp.info.showLabels&&d.append("div").style("color",H.color).style("font-family",H.fontName).style("font-size",H.fontSize).style("font-weight",H.bold?"bold":"normal").style("font-style",H.italic?"italic":"normal").style("margin-top","-10px").text(function(a,b){var d=p[b];return persian(c.label+(d?" - "+d:""),n)}),t(3,4,ma,g),t(4,5,na,g),t(5,6,oa,g);var D=C.append("g");D.append("rect").attr("width","5").attr("transform","translate("+(g-2.5)+","+g+")").attr("height",k+h).attr("fill","#333"),D.attr("transform","rotate("+(i*(180/Math.PI)+180)+" "+g+" "+g+")"),D.append("circle").attr("r","5").attr("cx",g).attr("cy",g),D.transition().duration(b.animationDuration).attrTween("transform",function(a,b){var c=A[b](a[0]<a[3]?a[3]:a[0]<a[6]?a[0]:a[6]),d=i*(180/Math.PI)+180,e=d;if(!isNaN(c)){var f=a[0]<a[3]?a[3]:a[0]<a[6]?a[0]:a[6];e=A[0](f)*(180/Math.PI)+180}var b=d3.interpolate(d,e);return function(a){return"rotate("+b(a)+" "+g+" "+g+")"}}),h=0,u(function(a,b){return A[b](a[3])*(180/Math.PI)}),u(function(a,b){return A[b](a[6])*(180/Math.PI)}),u(function(a,b){return A[b](a[4])*(180/Math.PI)}),u(function(a,b){return A[b](a[5])*(180/Math.PI)}),w(function(a){return a[3]},3),w(function(a){return a[6]},6),w(function(a){return a[4]},4),w(function(a){return a[5]},5);C.append("text").attr("class","gauge-value").attr("text-anchor","middle").style("fill",G.color).style("font-family",G.fontName).attr("dy","1em").style("font-size",G.fontSize).style("font-weight",G.bold?"bold":"normal").style("font-style",G.italic?"italic":"normal").attr("title",function(a){return persian(d3.format(G.formatString)(a[0]),n)}).text(function(a){return persian(d3.format(G.formatString)(a[0]),n)}).attr("transform","translate("+g+",35)").transition().duration(b.animationDuration).tween("text",function(a){var b=qa(a[3],a[0]),c=this;return function(a){c.textContent=b(a)}})})}function m(a,c,d,e,f,g){var h=d3.select(a).selectAll("nothings").data(function(a){return a.kpis}).enter().append("div").style("text-align","center"),i=0,j=10,k=0,l="small"==b.chartProp.info.chartSize?2*-Math.PI/5:"medium"==b.chartProp.info.chartSize?2*-Math.PI/4:2*-Math.PI/3,m=-1*l,o=Math.abs(Math.sin(l)),p=h.append("div").attr("class","gauge-value").style("color",G.color).style("font-family",G.fontName).style("font-size",G.fontSize).style("font-weight",G.bold?"bold":"normal").style("font-style",G.italic?"italic":"normal").text(function(a){return persian(d3.format(G.formatString)(a[0]),n)}),q=h.append("svg").append("text").attr("class","gauge-target").attr("text-anchor","middle").attr("dy","-0.3em").text(function(a){return persian(d3.format(G.formatString)("80"),n)}),r=$(p.node()).height(),s={width:$(p.node()).width(),height:$(p.node()).height()};p.remove();q.node().getBBox().height,q.node().getBBox();h.select("svg").remove();var t=b.chartProp.info.showLabels?22:0,u=Math.min(f-2*j,e-r-t)-2*k,w=u/2,x=w,y=x-v,z=2*w*o,A=2*y*o,B=(Math.abs(Math.cos(l))+Math.abs(Math.cos(m)))*w,C=(B>=s.width,Math.abs(Math.sin(l))*w-r),D=u;D=Math.max(D,u),g&&g(h,i,j,l,m,x,y,o,z,A,C,D)}b.input=a,app.chartCommons.calculateFields(a.series,b.calculatedFields);var n=(a.title,a.chartInfo,"undefined"==typeof a.lang||0==+a.lang),o="undefined"!=typeof a.series?a.series.labels:[],p="undefined"!=typeof a.kpis?a.kpis.labels:[],q=(a.seriesLablesCaptions,a.kpisLablesCaptions,b.LabelY,"#"+b.id),r={top:95,right:20,bottom:0,left:20},s=$(q).width(),t=$(q).hasClass("fromCommentDialog"),u="small"==b.chartProp.info.chartSize?220:"medium"==b.chartProp.info.chartSize?250:"large"==b.chartProp.info.chartSize?280:"veryLarge"==b.chartProp.info.chartSize?330:250,v="small"==b.chartProp.info.height?20:"medium"==b.chartProp.info.height?30:"large"==b.chartProp.info.height?40:"veryLarge"==b.chartProp.info.height?50:30,w=b.chartProp.info.openDashboard&&b.chartProp.info.openDashboard.checked;u+r.top+r.bottom,d3.scaleOrdinal(d3.schemeCategory10);b.width=s;var x=d.isProgress,y=d.showProgress,z=(d.title,e(b.chartProp.info.font,"formatString")||b.chartProp.info.formatString||",.2f"),A=e(b.chartProp.info.font,"formatStringCustom")||b.chartProp.info.formatString||",.2f",B=e(b.chartProp.info.font,"fontName")||"Droid",C=e(b.chartProp.info.font,"fontSize")||b.chartProp.info.fontSize||"46px",D=null!=e(b.chartProp.info.font,"italic")?e(b.chartProp.info.font,"italic"):b.chartProp.info.textItalic||!1,E=e(b.chartProp.info.font,"color")||b.chartProp.info.color||"#333333",F=null!=e(b.chartProp.info.font,"bold")?e(b.chartProp.info.font,"bold"):b.chartProp.info.textBold||!1,G={};G.formatString=z,G.formatStringCustom=A,G.fontName=B,G.fontSize=C,G.italic=D,G.color=E,G.bold=F,G.formatString="custom"!=G.formatString?G.formatString:G.formatStringCustom;var H=_.extend({bold:!1,color:"#333333",italic:!1,fontSize:"16px",fontName:"IRANSans",formatString:G.formatString||"A",formatStringCustom:"A"},b.chartProp.info.fontLabel),I=_.extend({bold:!1,color:"#333333",italic:!1,fontSize:"8px",fontName:"IRANSans",formatString:G.formatString||",.2f",formatStringCustom:",.2f"},b.chartProp.info.metaValueFont);if(app.chartCommons.setDefault(b.chartProp,p.concat(o),"gauge"),b.editMode&&$(q).trigger("chartproperty",[o.concat(p)]),!a.result)return void $("#"+b.id).append(app.chartCommons.getError(a));var J=prepareData(a);b.chartProp.info.segmentType=b.chartProp.info.segmentType||"singleSegment";var K="singleSegment"==b.chartProp.info.segmentType,L=b.chartProp.info.value,M=b.chartProp.info.target,N=b.chartProp.info.trend,O=b.chartProp.info.status,P=b.chartProp.info.min;P=""===P||"undefined"==typeof P?"auto":P;var Q=b.chartProp.info.max;Q=""===Q||"undefined"==typeof Q?"auto":Q;var R=b.chartProp.info.yellow,S=b.chartProp.info.green;""==M&&(M=void 0);var T=!isNaN(L||"nan"),U=!isNaN(M||"nan"),V=!isNaN(O||"nan"),W=!isNaN(N||"nan"),X=!isNaN(P||"nan"),Y=!isNaN(Q||"nan"),Z=!isNaN(R||"nan"),aa=!isNaN(S||"nan");$(q).css({overflow:"auto",padding:"0"}),_.isArray(a.levels)&&0!=a.levels.length||b.editMode||$(q).css({overflow:"hidden"});for(var ba=0;ba<J.length;ba++){var ca=J[ba],da=[];da=K?[+L,+M,+O,+N,+Q,"auto"===P?"auto":+P]:[+L,+M,+N,+P,+R,+S,+Q];for(var ea=!1,fa=0;fa<ca.series.length;fa++){var ga=b.chartProp.series[o[fa]],ha=-1;ha=K?"value"!==ga.type||T?"target"!==ga.type||U?"status"!==ga.type||V?"trend"!==ga.type||W?"max"!==ga.type||Y?"min"!==ga.type||X?-1:5:4:3:2:1:0:"value"!=ga.typeMs||T?"target"!==ga.typeMs||U?"trend"!==ga.typeMs||W?"min"!==ga.typeMs||X?"yellow"!==ga.typeMs||Z?"green"!==ga.typeMs||aa?"max"!==ga.typeMs||Y?-1:6:5:4:3:2:1:0,ha!==-1&&(da[ha]=ca.series[fa]*+ga.numberFactor,_.isNumber(ca.series[fa])||(da[ha]=ca.series[fa]),ea=!0)}(ea||0==ca.kpis.length)&&ca.kpis.push(da),K?(("undefined"==typeof da[2]||isNaN(da[2]))&&(da[2]=1),("undefined"==typeof da[3]||isNaN(da[3]))&&(da[3]=1)):(("undefined"==typeof da[0]||isNaN(da[0]))&&(da[0]=0),("undefined"==typeof da[2]||isNaN(da[2]))&&(da[2]=1),("undefined"==typeof da[3]||isNaN(da[3]))&&(da[3]=0),("undefined"==typeof da[4]||isNaN(da[4]))&&(da[4]=da[0]>0?.3*da[0]:30),("undefined"==typeof da[5]||isNaN(da[5]))&&(da[5]=da[0]>0?.7*da[0]:70),("undefined"==typeof da[6]||isNaN(da[6]))&&(da[6]=da[0]>0?1.2*da[0]:100))}var ia=d3.select(q).append("div").attr("class","legend-bar temporal");if(ia.breadcrumb(a.levels,b,d,n),!a.matrix||0==a.matrix.length)return void d3.select(q).append("div").attr("class","temporal").style("font-size","0.8em").style("margin","15px").append("span").attr("class","translate").attr("data-trans-key","داده‌ای برای نمایش وجود ندارد").text("داده‌ای برای نمایش وجود ندارد");var ja=d3.max(J,function(a){return d3.max(a.kpis,function(a){return Math.max(f(a[0],!0),f(a[1],!0))})}),ka=d3.min(J,function(a){return d3.min(a.kpis,function(a){return Math.min(f(a[0],!1),f(a[1],!1))})}),la=["#eee","#ddd","#ccc"],ma=b.chartProp.info.colorAriaOne||"#e14d57",na=b.chartProp.info.colorAriaTwo||"#FBEE58",oa=b.chartProp.info.colorAriaThree||"#71b37c",pa=function(a){return a>0?oa:0==a?na:ma},qa=function(a,b){var c,d,e=/^([0-9,.-]+)$/,f=d3.format(G.formatString);return c=e.exec(a),d=e.exec(b),c&&d?(a=parseFloat(c[1]),b=parseFloat(d[1])-a,function(c){var d=a+b*c;return persian(f(d),n)}):function(b){return a}},ra=$(q).width(),sa=$(q).height(),ta=J.length,ua=g(ra,sa,ta,b.chartProp.info.style);d3.select(q).styles({display:"flex","align-items":"center","flex-direction":"column"});var va=s;ua.h-=28,ua.w-=28,_.isArray(a.levels)&&0!=a.levels.length||b.editMode||1!=ta||$(q).css({overflow:"hidden"});var wa=(d3.select(q).append("div").attr("class","temporal gauge-container").styles({display:"flex","align-items":"center","flex-wrap":"wrap","justify-content":"space-around","flex-grow":1,"flex-shrink":1,"flex-basis":"0%",height:"100%",width:"100%"}).selectAll("nothings").data(J).enter().append("div").attr("class",function(a,b){return""!=a.onClickVal||w?"gauge-item temporal pointer":"gauge-item temporal"}).on("click",function(a,c,d){return t?void app.chartCommons.commentUtils.clickOnCommentIcon(c,b.ChartInPageId):""==c.onClickVal?void(w&&!b.editMode&&app.chartCommons.openLink(b.chartProp.info.openDashboard,{ChartInPageId:b.ChartInPageId,DataSourceId:b.input.DataSourceId,dimensionName:b.input.dimensionName,value:c.value,refreshDatasource:b.input.RefreshDatasource})):void(x()||(y(!0),b.drill="down",app.chartCommons.drillDown.add(b.ChartInPageId,b.input.DataSourceId,b.input.CurrentDimName,c.onClickVal,b.input),b.parameters={selectedItem:c.onClickVal,chartId:b.chartId,ChartInPageId:b.ChartInPageId},app.chartCommons.levelTypeUtils.getParam(b),$(q).charts(b.type,"refreshWithData",b)))}).each(function(a,c){switch(a.label+=""+(b.chartProp.info.label||""),b.chartProp.info.style){case"arc":K?k(this,a,c,ua.h,ua.w):l(this,a,c,ua.h,ua.w);break;case"horizontal":K?h(this,a,c,ua.h,ua.w):j(this,a,c,ua.h,ua.w);break;case"circle":K?k(this,a,c,ua.h,ua.w):l(this,a,c,ua.h,ua.w);break;case"semiCircle":K?k(this,a,c,ua.h,ua.w):l(this,a,c,ua.h,ua.w);break;case"verical":K?h(this,a,c,ua.h,ua.w):j(this,a,c,ua.h,ua.w);break;case"number":i(this,a,c,ua.h,ua.w)}}),!1)};var app=app||{};app.charts=app.charts||{},app.charts.map=app.charts.map||{},app.charts.map.draw=function(a,b,c,d){function e(c){function d(){function a(a,b){b.on({mousemove:function(a){var b=a.target.feature;q(a,b,null,null,a.containerPoint)},mouseout:r,click:function(a){var b=a.target.feature;p(a,b)}})}function c(){b.editMode&&(b.chartProp.info.realMap.initialZoom=g.getZoom(),b.chartProp.info.realMap.initialCenter=g.getCenter())}var d=b.chartProp.info.realMap||{},e="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";"open-street-online"===d.type&&(e="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"),"open-street-offline"===d.type&&(e="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"),"google-offline"===d.type&&(e=app.urlPrefix+"map_data//Tiles/{z}/gm_{x}_{y}_{z}.png"),"google-online"===d.type&&(e="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png");var f="map-"+b.chartId;$("#"+b.id).append('<div class="temporal" id = "'+f+'" style = "width: 100%; height:100%;" ></div > '),"undefined"==typeof b.chartProp.info.realMap.scrollWheelZoom&&(b.chartProp.info.realMap.scrollWheelZoom=!0);var g=null;g=b.chartProp.info.realMap.initialCenter?L.map(f,{center:[b.chartProp.info.realMap.initialCenter.lat,b.chartProp.info.realMap.initialCenter.lng],zoom:b.chartProp.info.realMap.initialZoom||5,scrollWheelZoom:b.chartProp.info.realMap.scrollWheelZoom}):L.map(f,{center:[32.8,53.6894],zoom:b.chartProp.info.realMap.initialZoom||5,scrollWheelZoom:b.chartProp.info.realMap.scrollWheelZoom}),L.tileLayer(e,{attributionControl:!1,attribution:"داشبورد مدیریتی صدف"}).addTo(g),g.getContainer().focus=function(){};var h=L.geoJson(O,{style:function(a,c){var e=l(a,null);return{color:b.chartProp.info.borderColor||"#666",strokeWidth:(b.chartProp.info.borderWidth||"0.5")+"px",fillColor:e,fillOpacity:d.fillOpacity||.5,weight:.8}},onEachFeature:a}).addTo(g);if(b.geo=h,svg1=d3.select(g.getPanes().overlayPane).select("svg"),Y=d3.select(g.getPanes().overlayPane).append("svg"),_.each(O.features,function(a){l(a,svg1)}),I){var j=L.control({position:b.chartProp.info.legendPosition.replace(" ","")});j.onAdd=function(a){var b=$("<div />").css({background:"#fff",padding:"10px","border-radius":"4px","font-family":"iransans"}).html(H.html()).get(0);return H.style("display","none"),b},j.addTo(g)}var k=function(a){var b=[0,0];h.eachLayer(function(c){c.feature.properties.Code===a.properties.Code&&(b=c.getBounds().getCenter())});var c=g.latLngToLayerPoint(b);return c},n=function(){b.chartProp.info.showChart&&"bar"===b.chartProp.info.chartType&&s(Y,k,null),b.chartProp.info.showChart&&"pie"===b.chartProp.info.chartType&&t(Y,k,null),b.chartProp.info.showName&&u(Y,k),b.chartProp.info.showValue&&v(Y,k),i(g,Y)};g.on("zoomstart",function(a){$(Y.node()).fadeOut()});var o=null;g.on("zoomend",function(a){c(),o&&clearTimeout(o),o=setTimeout(function(){Y.selectAll("*").remove(),n(),$(Y.node()).fadeIn()},400)}),g.on("moveend",function(a){i(g,Y),c()}),n();var w=g.getPanes(),x=1;_.each(w,function(a){a.style.zIndex=x++}),$(m+" .leaflet-control-container").children().css("z-index",1)}function e(){var a=d3.geoMercator().scale(1).translate([0,0]);T=d3.geoPath().projection(a);var d=T.bounds(O),e=.95/Math.max((d[1][0]-d[0][0])/N,(d[1][1]-d[0][1])/M),f=[(N-e*(d[1][0]+d[0][0]))/2,(M-e*(d[1][1]+d[0][1]))/2];a.scale(e).translate(f),T=T.projection(a),Y=d3.select(m).append("div").style("overflow","hidden").style("position","relative").attr("class","map-container temporal").append("svg").attr("class","temporal").attr("width",N).attr("height",M).append("g"),Y.selectAll("path").data(O.features).enter().append("path").attr("d",T).classed("pointer",!0).style("fill",function(a){return l(a,Y)}).on("click",p).on("mousemove",q).on("mouseout",r),Y.append("path").datum(topojson.mesh(c,c.objects.map,function(a,b){return!0})).attr("id","state-borders").attr("stroke",b.chartProp.info.borderColor||"#666").style("stroke-width",(b.chartProp.info.borderWidth||"0.5")+"px").attr("d",T),b.chartProp.info.showChart&&"bar"===b.chartProp.info.chartType&&s(Y,function(a){var b=T.centroid(a);return{x:b[0],y:b[1]}},p),b.chartProp.info.showChart&&"pie"===b.chartProp.info.chartType&&t(Y,function(a){var b=T.centroid(a);return{x:b[0],y:b[1]}},p),b.chartProp.info.showName&&u(Y,function(a){var b=T.centroid(a);return{x:b[0],y:b[1]}},p),b.chartProp.info.showValue&&v(Y,function(a){var b=T.centroid(a);return{x:b[0],y:b[1]}},p)}function l(c,d){var e=x[c.properties.Code+""];if("undefined"==typeof e)return b.chartProp.info.defaultColor||"#eee";var f=F(1);D-E!=0&&(f=F((e-E)/(D-E)));var g=a.series.labels,h=P.indexOf(c.properties.Code+"");if(h!==-1){var i=a.series.data[h],j=app.chartCommons.indicator.getIndicator(i,g,b.chartProp.indicator),k=_.flatten(j);if(k.length>0){var l=_.filter(k,{operand:"1"}),m=_.first(l),n=!!m&&m.isStriped;return m?n?app.chartCommons.indicator.getStripedColor(d,m.secondFieldColor,m.index):m.secondFieldColor:null}}return f}function p(c,d){if(o&&!b.editMode){var e=d.properties.Code+"";return void app.chartCommons.openLink(b.chartProp.info.openDashboard,{ChartInPageId:b.ChartInPageId,DataSourceId:b.input.DataSourceId,dimensionName:b.input.dimensionName,value:[e],caption:[d.properties.Name+""],refreshDatasource:b.input.RefreshDatasource})}var f=[d.properties.Code+""],g=[d.properties.Name+""];if("undefined"!=typeof T){var h,i,j;if(d&&aa!==d){var k=T.centroid(d);h=k[0],i=k[1],j=4,aa=d}else h=N/2,i=M/2,j=1,aa=null,f=null,g=null;Y.selectAll("path").classed("active",aa&&function(a){return a===aa}),Y.transition().duration(750).attr("transform","translate("+N/2+","+M/2+")scale("+j+")translate("+-h+","+-i+")").style("stroke-width",1.5/j+"px")}var l=b.chartProp.info.selectableArea;"undefined"==typeof l&&(l=!0),!b.editMode&&l&&(app.chartCommons.userFilter.setFilter({id:b.ChartInPageId,values:f,valuesCaption:g,variableType:0,dimensionName:a.dimensionName,chartInPageId:b.ChartInPageId,datasourceId:a.DataSourceId,disableClear:!1}),app.moderation.dashboadpage.refreshRelatedDatasources(a.RefreshDatasource,[+b.ChartInPageId],b.chartProp.info.groups),app.filterBox.refresh())}function q(a,b,c,d,e){var f=P.indexOf(b.properties.Code+""),g={};if(e)g=e;else{var i=d3.pointer(a);g.x=i[0]+7,g.y=i[1]+7}d3.select(m+" #map-tooltip ").transition().duration(200).style("opacity",.9),d3.select(m+" #map-tooltip ").html(h(f,n,b.properties.Name)).style("left",g.x+"px").style("top",g.y+"px")}function r(){d3.select(m+" #map-tooltip ").transition().duration(500).style("opacity",0)}function s(b,c,d){b.selectAll("g.bar").data(O.features).enter().append("g").classed("bar",!0).attr("transform",function(b){var d=P.indexOf(b.properties.Code+""),e=a.series.data[d];b.childes=_.map(e,function(a,b){return{index:b,data:a}}),b.childes=_.filter(b.childes,function(a){return!g(a.index).hidden});var f=c(b);return"translate("+(f.x-b.childes.length*W/2)+", "+f.y+")"}).on("click",d).on("mousemove",q).on("mouseout",r).selectAll("rect").data(function(a){return a.childes}).enter().append("rect").attr("width",W+"px").attr("fill",function(a,b){return g(a.index).color||U(b)}).attr("height",function(a){var b=a.data/D;return b*V+"px"}).attr("transform",function(a,b){var c=a.data/D;return"translate("+b*W+", -"+c*V+")"})}function t(b,c,d){var e=_.map(a.series.labels,function(a,b){return{name:a,prop:g(b)}}),f=a.series.data.map(function(a){return a.filter(function(a,b){return!e[b].prop.hidden})}),h=d3.pie().value(function(a){return a.data}),i=d3.max(f,function(a){return d3.max(a,function(a){return+a})});b.selectAll("g.pie").data(O.features).enter().append("g").classed("pie",!0).style("pointer-events","auto").attr("transform",function(b){var d=P.indexOf(b.properties.Code+""),e=a.series.data[d];b.childes=_.map(e,function(a,b){return{index:b,data:a}}),b.childes=_.filter(b.childes,function(a){return!g(a.index).hidden});var f=d3.max(b.childes,function(a){return a.data}),h=f/i*V*.65,j=.65*V/2.5;j>h&&(h=j);var k=d3.arc().innerRadius(0).outerRadius(h);_.each(b.childes,function(a){a.arc=k});var l=c(b);return"translate("+(l.x-b.childes.length*W/2)+", "+l.y+")"}).on("click",d).on("mousemove",q).on("mouseout",r).selectAll("path").data(function(a){return h(a.childes)}).enter().append("path").attr("d",function(a){return a.data.arc(a)}).style("pointer-events","auto").attr("fill",function(a,b){return g(a.data.index).color||U(b)})}function u(a,c,d){a.selectAll(".city-name").data(O.features).enter().append("svg:text").classed("city-name",!0).text(function(a){return a.properties.Name}).attr("x",function(a){return c(a).x}).attr("y",function(a){return c(a).y+X}).attr("text-anchor","middle").attr("fill",b.chartProp.info.nameEditor.color||"#333").style("font-size",b.chartProp.info.nameEditor.fontSize||"9px").style("font-family",b.chartProp.info.nameEditor.fontName||"IRANSans").style("font-weight",b.chartProp.info.nameEditor.bold?"bold":"200").style("font-style",b.chartProp.info.nameEditor.italic?"italic":"inherit").on("click",d).on("mousemove",q).on("mouseout",r)}function v(a,c,d){a.selectAll(".data-value").data(O.features).enter().append("svg:text").classed("data-value",!0).text(function(a){var c=x[a.properties.Code+""];return"undefined"==typeof c?"":persian(d3.format(b.chartProp.info.valueEditor.formatString)(c),j)}).attr("x",function(a){return c(a).x}).attr("y",function(a){return c(a).y+X+(b.chartProp.info.showName?-1*+b.chartProp.info.nameEditor.fontSize.replace("px","")-1:0)}).attr("text-anchor","middle").attr("fill",b.chartProp.info.valueEditor.color||"#333").style("font-size",b.chartProp.info.valueEditor.fontSize||"9px").style("font-family",b.chartProp.info.valueEditor.fontName||"IRANSans").style("font-weight",b.chartProp.info.valueEditor.bold?"bold":"200").style("font-style",b.chartProp.info.valueEditor.italic?"italic":"inherit").on("click",d).on("mousemove",q).on("mouseout",r)}var c=JSON.parse(c),w=k.indexOf(b.chartProp.info.mainSeries);w==-1&&(w=0),$(m+" .temporal").remove();for(var x={},y={},z=0,A=0;A<a.matrix.length;A++){var B=+a.series.data[A][w];x[a.matrix[A].captions[0]]=B,y[a.matrix[A].values[0]]=a.matrix[A].values[0],z+=B}b.chartProp.info.colorStart=b.chartProp.info.colorStart||"#31a354",b.chartProp.info.colorEnd=b.chartProp.info.colorEnd||"#c7e9c0";var C=$.extend({formatString:",.0f",colorStart:"#31a354",colorEnd:"#c7e9c0"},b.chartProp.series[a.series.labels[w]]),D=d3.max(a.series.data,function(a){return+a[w]}),E=d3.min(a.series.data,function(a){return+a[w]}),F=d3.interpolate(b.chartProp.info.colorEnd,b.chartProp.info.colorStart),G="pointer";b.editMode||(G="");var H=d3.select(m).append("div").attr("class","legend temporal "+G).styles({"text-align":"left",position:"absolute","background-color":"#fff","z-index":"1","border-radius":"4px",padding:"10px"}),I=!1;b.chartProp.info.legendPosition=b.chartProp.info.legendPosition||"top left";var J={"top right":{top:0,right:0},"top left":{top:0,left:0},"top center":{top:0,right:"50%",transform:"translate(50%)"},"bottom right":{bottom:0,right:0},"bottom left":{bottom:0,left:0},"bottom center":{bottom:0,right:"50%",transform:"translate(50%)"},"center right":{top:"50%",right:0},"center left":{top:"50%",left:0}};if(H.styles(J[b.chartProp.info.legendPosition]),b.chartProp.info.showLegend&&(f(m,b.chartProp.info.colorStart,b.chartProp.info.colorEnd,E,D,C,H,w),I=!0),b.chartProp.indicatorLegendShow){I=!0;H.legend({order:"vertical",colorPos:"right",width:N,font:b.chartProp.indicatorLegendFont,position:b.chartProp.info.legendPosition,selector:m,data:_.map(b.chartProp.indicator,function(c,d){var e=_.find(c.thenRow,{operand:"1"}),f=e?e.secondFieldColor:"#eeeeee",g=c.title||app.chartCommons.indicator.ifToString(c.ifRow,a.series.labels,a.seriesLablesCaptions,b);if(c.labelIsColumn){var h=a.series.labels.indexOf(c.labelColumn),i=a.series.labels.indexOf(c.ifRow[0].firstField),j="";
_.each(a.series.data,function(b){var d=b[i],e=0;if(c.ifRow[0].secondFieldIsText)e=c.ifRow[0].secondFieldInput;else{var f=a.series.labels.indexOf(c.ifRow[0].secondFieldSelect);e=b[f]}var g=!1;switch(+c.ifRow[0].operand){case 1:g=d===e;break;case 2:g=d!==e;break;case 3:g=d>e;break;case 4:g=d>=e;break;case 5:g=d<e;break;case 6:g=d<=e;break;case 7:g=d.indexOf(e)>-1;break;case 8:g=d.indexOf(e)<=-1}if(g)return j=b[h],!1}),j&&(g=j)}return{label:g,color:f}})},j)}if(b.chartProp.info.showChart&&b.chartProp.info.showChartLegend){var K=_.map(a.series.labels,function(a,b){return{name:a,prop:g(b)}});I=!0,H.legend({order:"vertical",colorPos:"right",font:b.chartProp.info.legendFont,width:$(m).width(),selector:m,data:K.filter(function(a,b){return!a.prop.hidden}).map(function(a){return{label:(a.prop.name||a.name).replace(/^\[measure\]/,""),color:a.prop.color,key:a.name}})},j)}var M=$(m).height(),N=$(m).width();M<150&&(M=150);var O=topojson.feature(c,c.objects.map),P=a.matrix.map(function(a){return a.captions[0]}),Q=_.map(c.objects.map.geometries,"properties.Code"),R=_.differenceWith(P,Q,_.isEqual),S=b.chartProp.info.extraCode||{};S.enable&&(I=!0,H.insert("div",":first-child").selectAll(".diff").data(R).enter().append("div").style("margin-bottom","10px").html(function(c){var d=P.indexOf(c+""),e=(a.series.data[d],_.find(S.items,{code:c})),f=e&&e.caption?e.caption:c,g=h(d,n,f),i=$("<div />").html(g);return i.find("> div").css("font-size",b.chartProp.info.extraCode.font.fontSize||"9px").css("font-family",b.chartProp.info.extraCode.font.fontName||"IRANSans").css("font-weight",b.chartProp.info.extraCode.font.bold?"bold":"200").css("font-style",b.chartProp.info.extraCode.font.italic?"italic":"inherit"),g=i.html()}));var T,U=d3.scaleOrdinal(d3.schemeCategory10),V=.25*M*(b.chartProp.info.chartSize||50)/100,W=5,X=8,Y=null;I||H.remove();var Z=b.chartProp.info.mapType||"path";"path"===Z?e():d();var aa;d3.select(m).append("div").attr("id","map-tooltip").attr("class","temporal"),_.each(a.series.labels,function(a,b){var c=g(b);c.color=c.color||U(b)})}function f(c,d,e,f,g,h,i,k){if(!b.chartProp.info.showLegend)return d3.select(c).append("div");var l=h.name||a.seriesLablesCaptions[k],m=.05*$(c).width(),n=i.append("div").style("text-align","right").style("margin-bottom","10px");n.append("div").text(l).style("margin","0 0px");var o=n.append("div").classed("ltr",!0).style("display","inline-block");return o.append("span").text(persian(d3.format(h.formatString)(f||0),j)),o.append("div").style("background","-webkit-linear-gradient(to right, "+e+", "+d+")").style("background","-o-linear-gradient(to right, "+e+", "+d+")").style("background","-moz-linear-gradient(to right, "+e+", "+d+")").style("background","linear-gradient(to right, "+e+", "+d+")").style("display","inline-block").style("height","7px").style("width",m+"px").style("margin","0 7px"),o.append("span").text(persian(d3.format(h.formatString)(g||100),j)),b.chartProp.info.showChart&&b.chartProp.info.showChartLegend||i.on("click",function(){c&&$(c).trigger("legendClick",[l,0,{key:a.series.labels[0]}])}),i}function g(c){return b.chartProp.series[a.series.labels[c]]}function h(c,d,e){if(c==-1)return app.chartCommons.tooltip.tooltipFormatter({points:[{data:"NaN",label:"-",format:","}],key:e,sum:"NaN",avg:"NaN",format:",.2f"},b.chartProp.info.tooltipHeader,b.chartProp.info.tooltipFormat,j);var f=a.series.data[c];if(1===d){var h=k.indexOf(b.chartProp.info.mainSeries);f=[{data:f[h],index:h}]}else f=2===d?f.filter(function(a,b){return!g(b).hidden}).map(function(a,b){return{data:a,index:b}}):f.map(function(a,b){return{data:a,index:b}});return f=f.map(function(b,c){return{data:b.data,label:g(b.index).name||a.seriesLablesCaptions[b.index],format:g(b.index).formatString}}),app.chartCommons.tooltip.tooltipFormatter({points:f,key:e,sum:d3.sum(f,function(a){return a.data}),avg:d3.sum(f,function(a){return a.data})/f.length,format:f.length>0?f[0].format:",.2f"},b.chartProp.info.tooltipHeader,b.chartProp.info.tooltipFormat)}function i(a,c){app.chartCommons.setFilterParameter(b),b.parameters.filterHierarchy=app.chartCommons.getFilterHierarchy(b.ChartInPageId),b.editMode&&(b.parameters.ChartInfo=$("#divChart").data("chartInfo")),b.chartProp.info.showLatLng=b.chartProp.info.showLatLng||{},b.chartProp.info.showLatLng.bounds=a.getBounds(),b.chartProp.info.showLatLng.zoomLevel=a.getZoom();var d=+b.chartProp.info.showLatLng.startZoom<=b.chartProp.info.showLatLng.zoomLevel,e=!b.chartProp.info.showLatLng.enable||!d||!b.chartProp.info.showLatLng.disableMap;if(e?(a.addLayer(b.geo),_.each(r,function(b){a.removeLayer(b)})):(a.removeLayer(b.geo),c.selectAll("*").remove()),b.chartProp.info.showLatLng.enable&&!(+b.chartProp.info.showLatLng.startZoom>b.chartProp.info.showLatLng.zoomLevel)){var f=(Math.sin(Math.PI*b.chartProp.info.showLatLng.bounds._southWest.lat/180),Math.sin(Math.PI*b.chartProp.info.showLatLng.bounds._northEast.lat/180),$.extend(b.parameters,{chartId:b.chartId,type:b.dataType,mapModel:b.chartProp.info.showLatLng})),g=JSON.stringify(f),h=app.mobileMode?proxy.ajax:$.ajax;clearTimeout(q),q=setTimeout(function(){app.charts.map.symbolRequest=app.charts.map.symbolRequest||{};var c=app.charts.map.symbolRequest[b.ChartInPageId];c&&c.abort();var d=h({url:app.urlPrefix+"api/map/getSymbols",type:"POST",dataType:"json",contentType:"application/json",data:g,async:b.async,requestId:b.requestId,success:function(c){_.each(r,function(b){a.removeLayer(b)}),a.on("popupopen",function(a){}),a.on("popupclose",function(a){}),_.each(c.series.data,function(d){var e=c.series.labels,f=app.chartCommons.indicator.getIndicator(d,e,b.chartProp.indicator),g=_.flatten(f),h=b.chartProp.info.showLatLng.color||"#ffc107";if(g.length>0){var i=_.filter(g,{operand:"7"}),j=_.first(i);if(!j)return null;h=j.symbolColor}var k=c.series.labels.indexOf(b.chartProp.info.showLatLng.inCircleKpi),l=c.series.labels.indexOf(b.chartProp.info.showLatLng.popupKpi);k===-1&&(k=2),l===-1&&(l=2);var m=0;d[k]&&(m=d[k].toString().length),width=19+6*m;var n=function(a,b){var c=$("<div/>"),d=$("<div/>");return d.attr("class","ltr").html(b).css("font-family",a.fontName).css("font-size",a.fontSize).css("text-align",a.align).css("color",a.color).css("font-weight",a.bold?"bold":"normal").css("font-style",a.italic?"italic":"normal"),c.append(d),c.html()},o=function(a,b){if(!a)return",.2f";var c=a;if(!a.formatString){if(!b)return",.2f";c=b}return"custom"!==c.formatString?c.formatString:c.formatStringCustom},p=n(b.chartProp.info.showLatLng.inCircleFont,'<div style="background: '+h+";width: "+width+"px;height: "+width+"px;border-radius: "+width/2+'px;display: flex;align-items: center;justify-content: center;">'+persian(d3.format(o(b.chartProp.info.showLatLng.inCircleFont))(d[k]))+"</div>"),q=L.divIcon({className:"my-div-icon",html:p}),s=L.marker([+d[1],+d[0]],{icon:q}).addTo(a);if(r.push(s),+d[2]){var t="";b.chartProp.info.showLatLng.popupPrefix&&(t=b.chartProp.info.showLatLng.popupPrefix+"<br/>");var u=c.series.labels[l];u&&(t=t+u+"<br/>");var v=persian(d3.format(o(b.chartProp.info.showLatLng.popupFont))(d[l])),w=n(b.chartProp.info.showLatLng.popupFont,t+v),x={maxWidth:"400",width:"200",className:"popupCustom"};s.bindPopup(w,x),s.on("mouseover",function(a){s.openPopup()}),s.on("mouseout",function(a){s.closePopup()})}})}});app.charts.map.symbolRequest[b.ChartInPageId]=d},400)}}b.input=a,app.chartCommons.calculateFields(a.series,b.calculatedFields);var j=(a.title,a.chartInfo,"undefined"==typeof a.lang||0==+a.lang),k="undefined"!=typeof a.series?a.series.labels:[],l="undefined"!=typeof a.kpis?a.kpis.labels:[],m="#"+b.id,n=+b.chartProp.info.tooltip||1,o=(d3.scaleOrdinal(d3.schemeCategory10),d.isProgress,d.showProgress,d.title,b.chartProp.info.openDashboard&&b.chartProp.info.openDashboard.checked);if(app.chartCommons.setDefault(b.chartProp,l.concat(k),"map"),b.editMode&&$(m).trigger("chartproperty",[l.concat(k)]),!a.result)return void $("#"+b.id).append(app.chartCommons.getError(a));if(!a.matrix||0==a.matrix.length)return void d3.select(m).append("div").attr("class","temporal").style("font-size","0.8em").style("margin","15px").append("span").attr("class","translate").attr("data-trans-key","داده‌ای برای نمایش وجود ندارد").text("داده‌ای برای نمایش وجود ندارد");var p=b.chartProp.info.map.selectedMap;"undefined"!=typeof b.map&&p===b.map.id?e(b.map.data):(d3.select(m+"").append("div").style("padding","15px").attr("class","temporal info").text("در حال بارگذاری نقشه ..."),$.ajax({url:app.urlPrefix+"api/Map/Get?Id="+p+"&v="+m,cache:!0,type:"GET",success:function(a){a.result?(b.map=a.map,b.map.id=p,e(a.map.data)):d3.select(m+" .info").text("نقشه انتخاب شده معتبر نیست. در منوی تنظیمات یک نقشه را انتخاب کنید یا نقشه‌ی مورد نظر خود را بارگذاری نمایید.")}}));var q,r=[]};var app=app||{};app.charts=app.charts||{},app.charts.pie={},app.charts.pie.draw=function(a,b,c,d){function e(a,c){var d=b.chartProp.info.dimColor=b.chartProp.info.dimColor||{};if(d.enable){var e=d.data[a.value.join("-")];return e=e||{},e.color||x(c)}return x(c)}function f(){function c(){var a=Math.min(n,k)/2,c=+b.chartProp.info.hole/100*a,d=d3.arc().innerRadius(c).outerRadius(a),e=d3.arc().innerRadius(1.1*a).outerRadius(1.1*a);return{radius:a,arc:d,arcText:e}}function d(a){return a.startAngle+(a.endAngle-a.startAngle)/2}function f(c,d){return O?void app.chartCommons.commentUtils.clickOnCommentIcon(c,b.ChartInPageId):(b.chartProp.globalvariable&&b.chartProp.globalvariable.length>0&&!b.editMode&&(app.globalVariableHelper.updateGlobalVariables([a.CurrentDimName],[c.data.value],b.chartProp.globalvariable),$(m+" path.selected-item").attr("class",$(this).attr("class").replace("selected-item","")),$(this).attr("class",$(this).attr("class")+" selected-item")),""==c.data.onClickVal?void(s&&!b.editMode&&app.chartCommons.openLink(b.chartProp.info.openDashboard,{ChartInPageId:b.ChartInPageId,DataSourceId:b.input.DataSourceId,dimensionName:b.input.dimensionName,value:c.value,refreshDatasource:b.input.RefreshDatasource})):void(q()||(r(!0),app.chartCommons.drillDown.add(b.ChartInPageId,b.input.DataSourceId,b.input.CurrentDimName,c.category,b.input),b.parameters={selectedItem:c.data.onClickVal,chartId:b.chartId,ChartInPageId:b.ChartInPageId,notEditMode:!b.editMode},app.chartCommons.levelTypeUtils.getParam(b),$(m).charts(b.type,"refreshWithData",b))))}function j(a){return{left:a.pos[0]-("start"===a.anchor?a.box.width:0),right:a.pos[0]+("start"===a.anchor?0:a.box.width),top:a.pos[1],bottom:a.pos[1]+a.box.height}}console.log("#### renderPie");var k=0;if(app.dashboardLayoutVersion=app.dashboardLayoutVersion||2,2===app.dashboardLayoutVersion){var u=$(m+" .title").outerHeight()||0,v=$(m+" .legend-bar"),x="undefined"==typeof v?0:v.outerHeight(!0);k=$(m).height()-u-x}else 1==app.dashboardLayoutVersion&&(n=o,n>300&&(n=300));var z=A.append("svg").attr("class","temporal").attr("width",n).attr("height",k),C=c(),D=C.radius;B=C.arc;var E=C.arcText;z.append("svg:rect").attr("class","background").style("fill","white").style("opacity","0").attr("width",n).attr("height",k).on("click",function(c,d,e){""!=a.levels&&(q()||(r(!0),b.parameters={isUp:!0,chartId:b.chartId,ChartInPageId:b.ChartInPageId,notEditMode:!b.editMode},app.chartCommons.drillDown.up(b.ChartInPageId),app.chartCommons.levelTypeUtils.getParam(b),$(m).charts(b.type,"refreshWithData",b)))}).on("mouseout",i);var F=z.append("g").attr("transform","translate("+n/2+","+k/2+")"),G=d3.pie().value(y);b.chartProp.info.sort||(G=G.sort(null));var H=F.datum(t).selectAll("path").data(G).enter();_.each(H._groups[0],function(a){a.__data__.category=a.__data__.data.series[0].category,a.__data__.seriesLable=a.__data__.data.series[0].seriesLable,a.__data__.seriesKey=a.__data__.data.series[0].seriesKey,a.__data__.commentCount=a.__data__.data.series[0].commentCount});var I=null;if(l){var J,K=0,L=0;F.append("g").attr("class","labels"),I=F.select(".labels").selectAll("text").data(G).enter().append("text"),I.attr("class",function(a,b){return""!=a.data.onClickVal||M||s?"label pointer":" label"}).attr("id",function(a,b){return"l-"+b}).attr("dy",".35em").text(function(a,c){var d=[];return b.chartProp.info.showLabels&&d.push(persian(a.data.label,p)),b.chartProp.info.showValues&&d.push(persian(d3.format(b.chartProp.info.legendFont.formatString)(a.value),p)),b.chartProp.info.showValuesPercent&&d.push(persian(d3.format(",.2f")(100*a.value/w),p)+"%"),d.join(" - ")}).styles({direction:"rtl","font-size":b.chartProp.info.legendFont.fontSize}).on("click",f).on("mouseover",h).on("mousemove",h).each(function(a){var b=d(a)>=Math.PI?"left":"right",c=this.getBBox();J=c.height,"left"==b?K<c.width&&(K=c.width):L<c.width&&(L=c.width)}),n=n-L-K-40,n<70&&(n=70),k-=2*J,C=c(),D=C.radius,B=C.arc,E=C.arcText}var M=b.chartProp.globalvariable&&b.chartProp.globalvariable.length>0&&!b.editMode&&b.chartProp.globalvariable.filter(function(b){return b.field==a.CurrentDimName}).length>0,N=H.append("g").classed("part",!0);N.append("path").attr("class",function(a,b){return""!=a.data.onClickVal||M||s?"arc pointer":" arc"}).attr("title","").attr("fill",function(a,b){return e(a.data,b)}).attr("d",B).each(function(a){this._current=a.data.series[0].data}).on("click",f).on("mouseover",h).on("mousemove",h);var O=$(m).hasClass("fromCommentDialog");if(app.chartCommons.commentUtils.addCommentIcon(b.ChartInPageId,N,function(a){return B.centroid(a)[0]},function(a){return B.centroid(a)[1]}),O&&app.chartCommons.commentUtils.setOnHighlightListener(N,b.ChartInPageId),l){var P=[];I.attr("transform",function(a,b){var c=E.centroid(a);return c[0]=1.1*D*(d(a)<Math.PI?1:-1),P[b]={pos:c,box:this.getBBox(),data:a.data.label[0]},"translate("+c+")"}).style("text-anchor",function(a,b){return P[b].anchor=d(a)>=Math.PI?"start":"end",d(a)>=Math.PI?"start":"end"}).style("display",function(a){var b=d3.select(this),c=(g(b.attr("transform")),"start"===b.style("text-anchor")?1:-1,this.getBBox(),"auto");return c});var Q=_.extend({enable:!1},b.chartProp.info.showLabelMatrix);if(console.log("### showMatrix ",_.merge({},Q)),Q.enable)_.each(P,function(a){var b=Q.data[a.data]||{check:!1};a.hide=!b.check});else for(var R=0;R<P.length-1;R++)for(var S=P[R],T=R+1;T<P.length;T++){var U=P[T];if(U.hide!==!0){var V=j(S),W=j(U),X=Math.max(V.left,W.left),Y=Math.min(V.right,W.right),Z=Math.min(V.bottom,W.bottom),aa=Math.max(V.top,W.top);X<Y&&Z>aa&&(U.hide=!0)}}I.style("display",function(a,b){return P[b].hide===!0?"none":"auto"}),F.append("g").attr("class","lines");var ba=F.select(".lines").selectAll("polyline").data(G).enter().append("polyline");ba.attr("points",function(a,b){this._current=this._current||a;var c=d3.interpolate(this._current,a);this._current=c(0);var e=E.centroid(a);return e[0]=1*D*(d(a)<Math.PI?1:-1),[B.centroid(a),E.centroid(a),e]}).style("display",function(a,b){return $(m+" #l-"+b).css("display")})}}function g(a){var b=document.createElementNS("http://www.w3.org/2000/svg","g");b.setAttributeNS(null,"transform",a);var c,d,e,f=b.transform.baseVal.consolidate().matrix,g=f.a,h=f.b,i=f.c,j=f.d,k=f.e,l=f.f;return(c=Math.sqrt(g*g+h*h))&&(g/=c,h/=c),(e=g*i+h*j)&&(i-=g*e,j-=h*e),(d=Math.sqrt(i*i+j*j))&&(i/=d,j/=d,e/=d),g*j<h*i&&(g=-g,h=-h,e=-e,c=-c),{translateX:k,translateY:l,rotate:Math.atan2(h,g)*Math.PI/180,skewX:Math.atan(e)*Math.PI/180,scaleX:c,scaleY:d}}function h(a,c){var d=[0,0];d=d3.pointer(a);var e=d[0]+7,f=d[1]+7,g=(B.centroid(c),c.data.series),h=+b.chartProp.info.tooltip||1;1==h&&(g=[g[0]]),2==h&&(g=g.filter(function(a){return!a.prop.hidden})),g=g.map(function(a,c){return{data:a.data,label:a.prop.name||a.label,format:b.chartProp.info.formatString,color:a.prop.seriesColor,percentage:100*a.data/w[c]}});var i=app.chartCommons.tooltip.tooltipFormatter({points:g,key:c.data.label,sum:d3.sum(c,function(a){return a.data}),avg:d3.sum(c,function(a){return a.data})/c.length,format:c.length>0?c[0].format:",.2f"},b.chartProp.info.tooltipHeader,b.chartProp.info.tooltipFormat,p);D.html(i),D.style("opacity",1).style("left",e+"px").style("top",f+"px")}function i(a){D.transition().duration(500).style("opacity",1e-6).end().then(function(){D.style("left","0px").style("top","0px")})}b.input=a,app.chartCommons.calculateFields(a.series,b.calculatedFields);var j=(a.title,a.chartInfo,"undefined"!=typeof a.series?a.series.labels:[]),k="undefined"!=typeof a.kpis?a.kpis.labels:[],l=b.chartProp.info.showLabels||b.chartProp.info.showValues||b.chartProp.info.showValuesPercent,m=(b.LabelY,"#"+b.id),n=$(m).width(),o=($(m).height(),"small"==b.chartProp.info.chartSize?150:"medium"==b.chartProp.info.chartSize?200:"large"==b.chartProp.info.chartSize?250:"veryLarge"==b.chartProp.info.chartSize?400:130);b.width=n;var p="undefined"==typeof a.lang||0==+a.lang,q=d.isProgress,r=d.showProgress,s=(d.title,b.chartProp.info.openDashboard&&b.chartProp.info.openDashboard.checked);if(app.chartCommons.setDefault(b.chartProp,k.concat(j),"pie"),b.editMode&&($(m).trigger("chartproperty",[k.concat(j)]),$(m).trigger("dimColor",[_.map(a.matrix,function(a){return a.values.join("-")})])),!a.result)return void $("#"+b.id).append(app.chartCommons.getError(a));$(m).addClass("pie-chart");var t=prepareData(a),u=a.seriesLablesCaptions,v=a.kpisLablesCaptions;d3Utils.prepareDataForBarChart(t,b,j,k,u,v);var w=0==t.length?[1]:t[0].series.map(function(a,b){return d3.sum(t.map(function(a){return a.series[b].data}))}),x=d3.scaleOrdinal(d3.schemeCategory10);switch(+b.chartProp.info.colorType){case 2:x=d3.scaleOrdinal(d3.schemeBrBG[11]);break;case 3:x=d3.scaleOrdinal(d3.schemePuOr[11]);break;case 4:x=d3.scaleOrdinal(d3.schemeRdGy[11])}var y=function(a){var b=a.series.filter(function(a){return"series"===a.type&&a.prop.main});return b.length>0?b[0].data:a.series.filter(function(a){return"series"===a.type})[0].data},z=d3.select(m).append("div").attr("class","legend-bar temporal");z.breadcrumb(a.levels,b,d,p),b.chartProp.info.showLabels?z.append("div").attr("class","legendBar"):(z.legend({width:n,font:b.chartProp.info.legendFont,position:b.chartProp.info.legendPosition,selector:m,data:t.map(function(a,b){var c=a.series.filter(function(a){return"series"===a.type&&a.prop.main}),d=null;d=c.length>0?c[0]:a.series.filter(function(a){return"series"===a.type})[0];var f={label:a.label.join(", "),color:e(a,b)};return f})},p),z.style("margin-bottom","12px"));var A=null;A=_.indexOf(["bottom left","bottom right","bottom center"],b.chartProp.info.legendPosition)!=-1?d3.select(m).insert("div",":first-child").attr("class","temporal").style("position","relative"):d3.select(m).append("div").attr("class","temporal").style("position","relative");var B,C=!1;app.mobileMode?f():"loading"===document.fonts.status?(app.charts.pie.fontCallback=app.charts.pie.fontCallback||[],app.charts.pie.fontCallback.push(function(){C||(C=!0,f())}),document.fonts.onloadingdone=function(a){_.each(app.charts.pie.fontCallback,function(a){a&&a()})}):f();var D=A.append("div").style("position","absolute").style("color","#fff").style("-moz-border-radius","5px").style("-webkit-border-radius","5px").style("border-radius","5px").style("padding","7px 15px").style("text-align","right").style("z-index","10").style("opacity","0").style("background-color","#000");$(m).trigger("heightChange")};var app=app||{};app.charts=app.charts||{},app.charts.radar={},app.charts.radar.draw=function(a,b,c,d){b.input=a,app.chartCommons.calculateFields(a.series,b.calculatedFields);var e=(a.title,a.chartInfo,"undefined"==typeof a.lang||0==+a.lang),f="undefined"!=typeof a.series?a.series.labels:[],g="undefined"!=typeof a.kpis?a.kpis.labels:[],h="#"+b.id,i={top:10,right:20,bottom:0,left:20},j=("small"==b.chartProp.info.chartSize?180:"medium"==b.chartProp.info.chartSize?250:"large"==b.chartProp.info.chartSize?400:"veryLarge"==b.chartProp.info.chartSize?600:130,b.chartProp.info.openDashboard&&b.chartProp.info.openDashboard.checked),k=$(h).width(),l=$(h).height()-i.top-i.bottom;d3.scaleOrdinal(d3.schemeCategory10);b.width=k;var m=d.isProgress,n=d.showProgress;d.title;if($(h).addClass("radar-chart"),app.chartCommons.setDefault(b.chartProp,g.concat(f),"radar"),b.editMode&&$(h).trigger("chartproperty",[g.concat(f)]),!a.result)return void $("#"+b.id).append(app.chartCommons.getError(a));for(var o=prepareData(a),p=0;p<o.length;p++)for(var q=0;q<o[p].series.length;q++)b.chartProp.series[f[q]].cumulative&&(o[p].series[q]+=o[p-1]?o[p-1].series[q]:0);var r=d3.select(h).append("div").attr("class","legend-bar temporal");if(r.breadcrumb(a.levels,b,d,e),!a.matrix||0==a.matrix.length)return void d3.select(h).append("div").attr("class","temporal").style("font-size","0.8em").style("margin","15px").append("span").attr("class","translate").attr("data-trans-key","داده‌ای برای نمایش وجود ندارد").text("داده‌ای برای نمایش وجود ندارد");var s=a.seriesLablesCaptions,t=a.kpisLablesCaptions;d3Utils.prepareDataForBarChart(o,b,f,g,s,t),r.legend({width:k,selector:h,data:o[0].series.filter(function(a){return!a.prop.hidden}).map(function(a){return{label:(a.prop.name||a.label).replace(/^\[measure\]/,""),color:a.prop.seriesColor,key:a.key}})},e);var u=$(h+" .title").outerHeight()||0,v=$(h+" .legend-bar"),w="undefined"==typeof v?0:v.height()+ +v.css("margin-top").replace("px","");l=$(h).height()-u-w,l<150&&(l=150);var x=_.extend({bold:!1,color:"#737373",italic:!1,fontSize:"10px",fontName:"IRANSans",formatString:b.chartProp.info.formatString||",.2f",formatStringCustom:",.2f"},b.chartProp.info.font),y=function(){var c=b.chartProp.info.labelWidth||100,d={radius:4,w:600,h:600,factor:1,factorLegend:.85,levels:6,maxValue:0,radians:2*Math.PI,opacityArea:.5,ToRight:5,TranslateX:0,TranslateY:0,ExtraWidthX:0,ExtraWidthY:0,color:d3.scaleOrdinal(d3.schemeCategory10)},f=d3.select(h).append("div").attr("class","temporal").style("position","relative").style("margin","0 auto").style("text-align","left"),g=o.map(function(a,b){return a.label}),i=g.length,p=0,q=f.selectAll(".axis-label").data(g).enter().append("div").text(function(a){return persian(a,e)}).attr("class","axis-label").style("width",c+"px").style("font-size","11px").style("padding","5px").style("text-overflow","ellipsis").style("white-space","nowrap").style("text-align",function(a,b){return p=$(this).outerHeight()||0,"right"});q.remove(),d.h=Math.min(l-2*p,k-2*c),d.w=d.h,d.maxValue=Math.max(d.maxValue,d3.max(o,function(a){return d3.max(a.series.filter(function(a,b){return!a.prop.hidden}).map(function(a){return a.data}))}));var r=d.factor*Math.min(d.w/2,d.h/2);d3.format("%");f.style("height",d.h+2*p+"px"),f.style("width",d.w+2*c+"px");var s=f.append("div"),t=s.append("svg"),u=f.append("div").classed("labels",!0).selectAll(".axis-label").data(g).enter().append("div").text(function(a){return persian(a,e)}).attr("title",function(a){return a}).attr("class","axis-label").style("width",c+"px").style("position","absolute").style("font-size","11px").style("padding","5px").style("text-overflow","ellipsis").style("white-space","nowrap").style("overflow","hidden").style("text-align",function(a,b){var c=d.w/2*(1-d.factor*Math.sin(b*d.radians/i)),e="right";return c>=d.w/2&&(e="left"),e}),p=0;u.style("left",function(a,b){var e=d.w/2*(1-d.factor*Math.sin(b*d.radians/i));return e>=d.w/2&&(e+=c),e+"px"}).style("top",function(a,b){var c=$(d3.select(this).node()).outerHeight()||0;p=c;var e=d.h/2*(1-d.factor*Math.cos(b*d.radians/i));return e+=c/2,0==b&&(e=0),e+"px"});var v=p;s.style("left",c+"px").style("position","absolute").style("top",v+"px");var w,y=t.attr("width",d.w).attr("height",d.h).append("g").attr("transform","translate("+d.TranslateX+","+d.TranslateY+")"),z=function(){var a=y.append("g").attr("class","axies").selectAll(".axis").data(g).enter().append("g").attr("class","axis");a.append("line").attr("x1",d.w/2).attr("y1",d.h/2).attr("x2",function(a,b){return d.w/2*(1-d.factor*Math.sin(b*d.radians/i))}).attr("y2",function(a,b){return d.h/2*(1-d.factor*Math.cos(b*d.radians/i))}).attr("class","line").style("stroke","grey").style("stroke-width","1px");for(var b=y.append("g").classed("values",!0),c=0;c<d.levels-1;c++){var f=d.factor*r*((c+1)/d.levels);b.selectAll(".levels").data(g).enter().append("svg:line").attr("x1",function(a,b){return f*(1-d.factor*Math.sin(b*d.radians/i))}).attr("y1",function(a,b){return f*(1-d.factor*Math.cos(b*d.radians/i))}).attr("x2",function(a,b){return f*(1-d.factor*Math.sin((b+1)*d.radians/i))}).attr("y2",function(a,b){return f*(1-d.factor*Math.cos((b+1)*d.radians/i))}).attr("class","line").style("stroke","grey").style("stroke-opacity","0.75").style("stroke-width","0.3px").attr("transform","translate("+(d.w/2-f)+", "+(d.h/2-f)+")")}for(var c=0;c<d.levels;c++){var f=d.factor*r*((c+1)/d.levels);b.selectAll(".levels").data([1]).enter().append("svg:text").attr("x",function(a){return f*(1-d.factor*Math.sin(0))}).attr("y",function(a){return f*(1-d.factor*Math.cos(0))}).attr("class","legend").style("font-size",x.fontSize).style("font-family",x.fontName).attr("dy","1em").attr("transform","translate("+(d.w/2-f+d.ToRight)+", "+(d.h/2-f)+")").attr("fill",x.color).text(persian(d3.format(x.formatString)((c+1)*d.maxValue/d.levels),e))}};series=0;var A=o[0].series.filter(function(a,b){return!a.prop.hidden});A.forEach(function(a,b){function c(a){var c="undefined"==typeof A[b].prop.areaOpacity?d.opacityArea:A[b].prop.areaOpacity;return e.match(/area/gi)||(c=0),c}if(!a.prop.hidden){dataValues=[],y.selectAll(".nodes").data(o,function(a,c){dataValues.push([d.w/2*(1-parseFloat(Math.max(a.series.filter(function(a,b){return!a.prop.hidden})[b].data,0))/d.maxValue*d.factor*Math.sin(c*d.radians/i)),d.h/2*(1-parseFloat(Math.max(a.series.filter(function(a,b){return!a.prop.hidden})[b].data,0))/d.maxValue*d.factor*Math.cos(c*d.radians/i))])}),dataValues.push(dataValues[0]);var e=A[b].prop.lineType;e||(e="line-dot-area"),y.selectAll(".area").data([dataValues]).enter().append("polygon").attr("class","radar-chart-serie"+series).style("stroke-width",function(a){var c=A[b].prop.lineWeight||2;return e.match(/line/gi)||(c=0),c+"px"}).style("stroke",A[b].prop.seriesColor).attr("points",function(a){for(var b="",c=0;c<a.length;c++)b=b+d.w/2+","+d.h/2+" ";return b}).style("fill",function(a,c){return A[b].prop.seriesColor}).style("fill-opacity",c).on("mouseover",function(a){}).on("mouseout",function(){}).transition(500).attr("points",function(a){for(var b="",c=0;c<a.length;c++)b=b+a[c][0]+","+a[c][1]+" ";return b}),series++}}),z(),series=0;var B=b.chartProp.globalvariable&&b.chartProp.globalvariable.length>0&&!b.editMode&&b.chartProp.globalvariable.filter(function(b){return b.field==a.CurrentDimName}).length>0;_.each(o,function(a){});var C=A.map(function(a,b){return o.map(function(a){var c=a.series.filter(function(a,b){return!a.prop.hidden})[b];return c.onClickVal=a.onClickVal,c})}),D=y.selectAll(".entry-group").data(C).enter().append("g").classed("entry-group",!0),E=D.selectAll(".entry-group").data(function(a){return a}).enter().append("g").classed("entry",!0),F=$(h).hasClass("fromCommentDialog");E.append("svg:circle").attr("class",function(a,b){return"radar-chart-serie"+b+" "+(""!=a.onClickVal||B||j?" pointer":"")}).classed("circle",!0).attr("r",d.radius).attr("alt",function(a){return d3.format(x.formatString)(a.data)}).attr("cx",function(a,b){return d.w/2}).attr("cy",function(a,b){return d.h/2}).attr("data-id",function(a){return a.axis}).style("fill","#fff").style("stroke",function(a){return a.prop.seriesColor}).style("stroke-width","2px").style("opacity",function(a){var b=a.prop.lineType;return b||(b="line-dot-area"),"line-area"===b||"line"===b?0:1}).on("click",function(c,d,e){return F?void app.chartCommons.commentUtils.clickOnCommentIcon(d,b.ChartInPageId):(b.chartProp.globalvariable&&b.chartProp.globalvariable.length>0&&!b.editMode&&(app.globalVariableHelper.updateGlobalVariables([a.CurrentDimName],[d.value],b.chartProp.globalvariable),$(h+" circle.selected-item").attr("class",$(this).attr("class").replace("selected-item","")),$(this).attr("class",$(this).attr("class")+" selected-item")),""==d.onClickVal?void(j&&!b.editMode&&app.chartCommons.openLink(b.chartProp.info.openDashboard,{ChartInPageId:b.ChartInPageId,DataSourceId:b.input.DataSourceId,dimensionName:b.input.dimensionName,value:d.category,refreshDatasource:b.input.RefreshDatasource})):void(m()||(n(!0),b.parameters={selectedItem:d.onClickVal,chartId:b.chartId,ChartInPageId:b.ChartInPageId,notEditMode:!b.editMode},app.chartCommons.drillDown.add(b.ChartInPageId,b.input.DataSourceId,b.input.CurrentDimName,d.onClickVal,b.input),app.chartCommons.levelTypeUtils.getParam(b),$(h).charts(b.type,"refreshWithData",b))))}).on("mouseover",function(a){newX=parseFloat(d3.select(this).attr("cx")),newY=parseFloat(d3.select(this).attr("cy")),console.log(a.category,newX,newY),w.transition(),w.style("left",newX+c+5+"px").style("top",newY-5+"px").html(filterXSS(a.category.join(", ")+"<br/> <b>"+a.label+": </b>"+persian(d3.format(x.formatString)(a.data),e))).transition(200).style("opacity",1);var b=($(w._groups[0]).width(),$(w._groups[0]).height());w.style("top",newY+b/2+"px")}).on("mouseout",function(a){console.log(a.category,"## out"),w.transition().duration(200).style("opacity",1e-6).end().then(function(){w.style("left",0).style("top",0)})["catch"](function(a){console.log(a)})}).transition(500).attr("cx",function(a,b){return d.w/2*(1-Math.max(a.data,0)/d.maxValue*d.factor*Math.sin(b*d.radians/i))}).attr("cy",function(a,b){return d.h/2*(1-Math.max(a.data,0)/d.maxValue*d.factor*Math.cos(b*d.radians/i))}),app.chartCommons.commentUtils.addCommentIcon(b.ChartInPageId,E,function(a,b){return d.w/2*(1-Math.max(a.data,0)/d.maxValue*d.factor*Math.sin(b*d.radians/i))-5},function(a,b){return d.h/2*(1-Math.max(a.data,0)/d.maxValue*d.factor*Math.cos(b*d.radians/i))-24}),F&&app.chartCommons.commentUtils.setOnHighlightListener(E,b.ChartInPageId),w=f.append("div").attr("class","tooltip").style("position","absolute").style("color","#fff").style("-moz-border-radius","5px").style("-webkit-border-radius","5px").style("border-radius","5px").style("padding","7px 15px").style("text-align","right").style("z-index","1000").style("opacity","0").style("background-color","#000").style("max-width","200px").style("opacity",0).style("font-size","13px")};y(),$(h).trigger("heightChange")};var app=app||{};app.charts=app.charts||{},app.charts.table={},app.charts.table.draw=function(input,settings,refreshWithData,titlebar){function onTdClick(a,b,c,d){var e=[],f="",g=$(this).hasClass("selected-item"),h=$(this).parents("tr").index();if("undefined"==typeof settings.chartProp.info.selectable&&(settings.chartProp.info.selectable="multi"),"none"!=settings.chartProp.info.selectable){if("edit"==settings.chartProp.info.selectable)return void $("body").trigger("open-form",[input.form,input.formIds[h],selector]);if(settings.chartProp.info.rowAsKey&&settings.chartProp.info.rowKey){if(b=c.indexOf(settings.chartProp.info.rowKey),b==-1)return;"one"==settings.chartProp.info.selectable&&$(selector+" .selected-item").removeClass("selected-item"),g?$(this).parents("tr").find("td").removeClass("selected-item"):$(this).parents("tr").find("td").addClass("selected-item")}else"one"==settings.chartProp.info.selectable&&$(selector+" td:nth-child("+(b+1)+").selected-item").removeClass("selected-item"),g?$(this).removeClass("selected-item"):$(this).addClass("selected-item");var i=b+1+(settings.chartProp.info.showRowNumber?1:0),e=$(selector+" td:nth-child("+i+").selected-item").map(function(){return d[h][b]}).toArray();if(f=c[b],e=e.filter(function(a,b){return e.indexOf(a)==b}),!settings.editMode){var d={Id:-1,Values:e,VariableType:0,dimensionName:f,datasourceId:input.DataSourceId,chartInPageId:settings.ChartInPageId,chartId:input.chartId};app.moderation.dashboadpage.selectValueOnChart(d,input.RefreshDatasource)}}}function hasScrollBar(a){return $(a).get(0).scrollHeight>$(a).height()}function postProcess(a,b,c,d,e,f){function g(){var a=document.createElement("div");a.style.visibility="hidden",a.style.width="100px",a.style.msOverflowStyle="scrollbar",document.body.appendChild(a);var b=a.offsetWidth;a.style.overflow="scroll";var c=document.createElement("div");
c.style.width="100%",a.appendChild(c);var d=c.offsetWidth;return a.parentNode.removeChild(a),b-d}function h(){$(selector+" .header-table").css("-ms-transform","translate3d("+(-m+$(selector+" #tablescroll").scrollLeft())+"px,0px,0px)"),$(selector+" .table-footer").css("-ms-transform","translate3d("+(-m+$(selector+" #tablescroll").scrollLeft())+"px,0px,0px)"),$(selector+" .header-table").css("-webkit-transform","translate3d("+(m-$(selector+" #tablescroll").scrollLeft())+"px,0px,0px)"),$(selector+" .table-footer").css("-webkit-transform","translate3d("+(m-$(selector+" #tablescroll").scrollLeft())+"px,0px,0px)"),$(selector+" .header-table").css("-moz-transform","translate3d("+-$(selector+" #tablescroll").scrollLeft()+"px,0px,0px)"),$(selector+" .table-footer").css("-moz-transform","translate3d("+-$(selector+" #tablescroll").scrollLeft()+"px,0px,0px)")}var i=a[0][0];$(selector).parents(".ui.card").width();$(i).find("td").each(function(e,f){var g=d[0][e],h=d3.select(c[0][0]).selectAll("th"),i=h[0][e],j=d3.select(b[0][0]).selectAll("th"),k=(j[0][e],$(f).outerWidth()),l=($(f).width(),$(f).css("padding-top")),m=$(f).css("padding-left"),n=$(f).css("padding-right"),o=$(f).css("padding-bottom"),p=function(a){a.css("width",k+"px"),a.css("max-width",k+"px"),a.css("min-width",k+"px"),a.css("padding-top",l),a.css("padding-left",m),a.css("padding-right",n),a.css("padding-bottom",o)};p($(g)),p($(a[0][0]).map(function(a,b){return $(b).find("td")[e]})),p($(i))}),b.remove(),e||$(selector+" .table-footer").remove(),f.remove();var j=$(i).outerWidth();if($(selector+" table").css("width",j+"px"),$(selector+" table").css("max-width",j+"px"),hasScrollBar($(selector+" #tablescroll"))){var k=0;k=g();var l=k+$(selector+" .header-table table th:last-child").outerWidth();$(selector+" .header-table table th:last-child").css({"min-width":l+"px","max-width":l+"px",width:l+"px"}),l=k+$(selector+" .table-footer table th:last-child").outerWidth(),$(selector+" .table-footer table th:last-child").css({"min-width":l+"px","max-width":l+"px",width:l+"px"})}var m=$(selector+" #tablescroll").scrollLeft();if($(selector+" #tablescroll").on("scroll",h),h(),2==app.dashboardLayoutVersion&&!settings.editMode){var n=$(selector+" .table-body").get(0).scrollWidth>$(selector+" .table-body").innerWidth()?15:0;n=0;var o=0;try{o=$(selector+" .pagination").height()+ +$(selector+" .pagination").css("margin-top").replace("px","")}catch(p){}}}function checkRow(a,b,c){var d=c.indexOf(a.firstField),e=b[d],f=a.secondFieldIsText?a.secondFieldInput:b[c.indexOf(a.secondFieldSelect)];switch(e=depersian(e),f=depersian(f),isNaN(f)||(f=+f),isNaN(e)||(e=+e),+a.operand){case 1:return e==f;case 2:return e!=f;case 3:return e>f;case 4:return e>=f;case 5:return e<f;case 6:return e<=f;case 7:return e.indexOf(f)>-1;case 8:return e.indexOf(f)<=-1}}function getIndicator(a,b,c){return}function sorting(a,b,c){$(b);if(isDesc=!1,TableInfo&&TableInfo.Order)for(var d=0;d<TableInfo.Order.length;d++){var e=TableInfo.Order[d];if(e.Index==a){isDesc=2==e.DescType;break}}c.sort(function(b,c){return"undefined"!=typeof b.label&&(b=[b.label].concat(b.series),c=[c.label].concat(c.series)),"undefined"!=typeof isDesc&&isDesc?/^[0-9.]+$/.test(b[a])?d3.descending(+b[a],+c[a]):d3.descending(b[a],c[a]):/^[0-9.]+$/.test(b[a])?d3.ascending(+b[a],+c[a]):d3.ascending(b[a],c[a])})}function addHeaders(a,b,c,d){if(showHeader){var e=b.selectAll("nothing").data(a).enter().append("th").html(function(a,b){var c="";c='<div class="ui  dropdown " id="filterbox-'+b+'"><i class="table-filter-icon filter icon"></i><div class="menu"><div class="ui left icon input mini"><i class="search icon"></i><input type="text" name="search" placeholder="جستجو"></div><div class="item"></div>';return'<div class="inline header-text pointer" style="white-space:initial;">'+persian(a.prop.name||a.value,showPersian).replace(/^\[measure\]/,"")+"</div>"+c}).attr("class","pointer hover-show-glyph").style("white-space","nowrap").style("text-align",function(a,b){return a.prop.textAlign}).style("display",function(a,b){return a.prop.isHidden?"none":"auto"}),f=0;e[0].forEach(function(a,b){if(f+=+$(a).width(),f<130||0==b){var c=$(a).find(".dropdown-menu-right");c.removeClass("dropdown-menu-right"),c.addClass("dropdown-menu-left")}}),c.selectAll("thead th").each(function(a,b){d3.select(this).select(".header-text").on("click",function(){d.sort(b,this,tr),settings.editMode&&selector&&$(selector).trigger("legendClick",[a.label,b,a])})}),c.selectAll("thead th").each(function(a,b){$(this).find("input").keyup(function(a){13==a.keyCode&&d.filter()})}),c.selectAll("thead th").each(function(a,b){$(this).find(".btn-default").on("click",function(){d.filterclear(b)})}),c.selectAll("thead th").each(function(a,b){$(this).find(".dropdown").on("shown.bs.dropdown",function(){$(this).find("input").focus()})});for(var g=0;g<a.length;g++)d3.select(selector+" #filterbox-"+g+" select").on("click",function(a){d3.event.stopPropagation()}),d3.select(selector+" #filterbox-"+g+" input").on("click",function(a){d3.event.stopPropagation()}),$(selector+" #filterbox-"+g+" input").mousedown(function(a){3==a.which&&(a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation())}),$(selector+" #filterbox-"+g).on("keypress",function(a){13===a.keyCode&&(a.preventDefault(),$(this).find(".btn-primary").click())});settings.editMode||$(selector).find(".ui.dropdown").lazyDropdown()}}function getPropOfIndexFromKeyValueLabel(a){return a>=headers.length&&(a=headers.length-1),headers[a].prop}function getProp(a){var b={numberFactor:"1",textAlign:"right",formatString:",.2f",fontSize:"14px",textItalic:!1,textBold:!1,color:"#000000",rowResult:"0",isHidden:!1};try{return settings.chartProp.series[a]||settings.chartProp.series["default"]||b}catch(c){return b}}function getFilterParameter(){for(var a=[],b=$(selector+" table thead th input"),c=0;c<b.length;c++){if(value=$(selector+" #filterbox-"+c+" input").val(),type=$(selector+" #filterbox-"+c+" select").val()||1,null==type)return;"undefined"!=typeof value&&null!=value&&""!=value&&($(selector+" #filterbox-"+c+" .glyphicon-filter").addClass("show"),d3.select(selector+" #filterbox-"+c+" select").on("click",function(a){d3.event.stopPropagation()}),d3.select(selector+" #filterbox-"+c+" input").on("click",function(a){d3.event.stopPropagation()}),$(selector+" #filterbox-"+c+" input").mousedown(function(a){3==a.which&&(a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation())})),a.push({value:value,type:type})}return $(selector).data("filterbox",a),a}function filterTable(){var a=getFilterParameter();"undefined"!=typeof tr&&tr.style("display",function(b){"undefined"!=typeof b.label&&(b=[b.label].concat(b.series));var c=filter(b,a);return c?null:"none"}),settings.editMode&&$(selector).trigger("tableInfo",[{TableInfo:TableInfo}])}function restoreFilterboxValue(a,b){if("undefined"!=typeof a){for(var c=!1,d=0;d<a.length;d++)"undefined"!=typeof a[d].value&&""!=a[d].value&&(c=!0),$(selector+" #filterbox-"+d+" input").val(a[d].value),_.isEmpty(a[d].value)||$(selector+" #filterbox-"+d+" .table-filter-icon").addClass("fill"),$(selector+" #filterbox-"+d+" select").val(a[d].type);c&&!b&&filterTable()}}function filter(a,b){for(var c=!0,d=0;d<b.length;d++)if(parameter=b[d].value,parameter=depersian(parameter),parameter=RegExp(/^[\d,\s]+$/).test(parameter)?+parameter.replace(/,/g,""):parameter,type=b[d].type,"undefined"!=typeof parameter&&""!=parameter)switch(+type){case 1:a[d];c=c&&a[d].indexOf(parameter)!=-1;break;case 6:a[d];c=c&&a[d].indexOf(parameter)==-1;break;case 2:c=c&&(parseFloat(a[d])||0)==parameter;break;case 3:c=c&&(parseFloat(a[d])||0)>parameter;break;case 4:c=c&&(parseFloat(a[d])||0)<parameter;break;case 5:var e=parameter.split(",");"undefined"!=e&&(c=c&&(parseFloat(a[d])||0)>e[0]&&(parseFloat(a[d])||0)<e[1])}return c}var selector="#"+settings.id,margin={top:10,right:20,bottom:0,left:20},width=$(selector).width(),barHeight="small"==settings.chartProp.info.chartSize?170:"medium"==settings.chartProp.info.chartSize?300:"large"==settings.chartProp.info.chartSize?400:"veryLarge"==settings.chartProp.info.chartSize?500:250,height=barHeight+margin.top+margin.bottom;settings.width=width;var isProgress=titlebar.isProgress,showProgress=titlebar.showProgress,title=titlebar.title,showPersian="undefined"==typeof input.lang||0==+input.lang,hasHref=settings.chartProp.info.openDashboard&&settings.chartProp.info.openDashboard.checked;input.columnTypes&&_.each(input.columnTypes,function(a){a.control&&4==a.control.type&&(a.isDropdown=!0,a.isRadio=a.isDropdown&&"radio"==a.control.dropdown.theme)}),_.isArray(settings.chartProp.info.columnsWidth);var nullReplcament=settings.chartProp.info.nullReplacement;_.isUndefined(nullReplcament)&&(nullReplcament="");var lastTableInfo=$(selector).data("table-info"),TableInfo=lastTableInfo||settings.tableInfo||{};$(selector).data("table-info",TableInfo);var showHeader="undefined"==typeof settings.chartProp.info.showHeader||settings.chartProp.info.showHeader;if($(selector).addClass("table-chart-container table-chart"),$(selector).parents(".content").addClass("hidden-overflow"),settings.editMode&&($(selector).addClass("edit-mode"),$(selector).css("margin","0px")),2==app.dashboardLayoutVersion&&!settings.editMode){var titleHeight=$(selector+" .title").outerHeight()||0,chartHeight=$(selector).height()-titleHeight;barHeight=chartHeight}"undefined"==typeof settings.chartProp.info.stripped&&(settings.chartProp.info.stripped=!0),"undefined"==typeof settings.chartProp.info.hover&&(settings.chartProp.info.hover=!0);var tableStyle=(settings.chartProp.info.bordered?" table-bordered":"")+(settings.chartProp.info.stripped?" table-striped":"")+(settings.chartProp.info.hover?" table-hover":"")+" ",rowNumberLablel="#ردیف",tableInfo={option:{},headerTemplate:function(a){if(!showHeader)return"";_.map(a,function(a,b){a.index=b}),this.filteredHeaders=_.filter(a,function(a){return!a.prop.isHidden});var b=function(a){var b=["font-weight:"+(tableInfo.option.settings.chartProp.info.headerFont.bold?"bold":"normal"),"italic","font-size:"+tableInfo.option.settings.chartProp.info.headerFont.fontSize,"text-align:"+(a.font.align||tableInfo.option.settings.chartProp.info.headerFont.align),"color:"+tableInfo.option.settings.chartProp.info.headerFont.color,"font-family:"+tableInfo.option.settings.chartProp.info.headerFont.fontName],c=b.join(";");return tableInfo.option.settings.chartProp.info.headerNowrap||(c+=";white-space:initial;"),c},c=_.map(this.filteredHeaders,function(a){var c=filterXSS(a.prop.name||a.value);tableInfo.option.page=tableInfo.option.page||{};var d=_.find(tableInfo.option.page.Order,{Index:a.index}),e="";d&&(e='<i class="icon sort '+(1===d.DescType?"ascending":"descending")+'"></i>'),tableInfo.option.settings.chartProp.info.headerFont=tableInfo.option.settings.chartProp.info.headerFont||{bold:!0,italic:!1,fontSize:"13px",fontName:"IRANSans"};var f=tableInfo.option.tableData.headers[a.index].prop;f.font=f.font||{};var g=b(f);return'<th title="'+c+'" data-index="'+a.index+'" ><span class="resize"></span><div style="'+g+'">'+c+e+"</div></th>"}).join(""),d="";if(settings.chartProp.info.showRowNumber){var e=tableInfo.option.settings.chartProp.series[rowNumberLablel];e=e||{},e.font=e.font||{};var f=b(e);d='<th title="ردیف" ><span class="resize"></span><div style="'+f+'">ردیف</div></th>'}return"<tr>"+d+c+"</tr>"},getFooterTemplate:function(){if(!_.some(tableInfo.option.resultRows,function(a){return+a.Type>0}))return"";var a=_.map(_.filter(tableInfo.option.tableData.headers,function(a,b){return!a.prop.isHidden}),function(a){var b=_.find(tableInfo.option.resultRows,{Name:a.key});if(!b||0===+b.Type)return"<td><div></div></td>";var c={data:b.Value},d=_.findIndex(tableInfo.option.tableData.headers,{key:a.key}),e=tableInfo.getStyle(tableInfo.option.tableData.headers[d].prop);return'<td style="'+e+'" title="'+tableInfo.getText(c,d)+'"><div>'+tableInfo.getText(c,d)+"</div></td>"}).join(""),b="";settings.chartProp.info.showRowNumber&&(b="<td><div></div></td>");var c='  <table class="ui celled table unstackable small  footer-table" style="margin:0;border-left: none;border-right: none;">                                                      <tbody>                                                <tr>'+b+a+"</tr>    </tbody>                                                 </table>                                                 ";return c},svg:'<svg  class="td-comment" width="24" height="24" style="position: absolute; left: 6px; fill-opacity: 0.5;"><g transform="translate(0,0)scale(0.38)" class="comment"><rect width="24" height="24" class="comment-background"></rect><path d="M10.718,18.561l6.78,5.311C17.609,23.957,17.677,24,17.743,24  c0.188,0,0.244-0.127,0.244-0.338v-5.023c0-0.355,0.233-0.637,0.548-0.637L21,18c2.219,0,3-1.094,3-2s0-13,0-14s-0.748-2-3.014-2  H2.989C0.802,0,0,0.969,0,2s0,13.031,0,14s0.828,2,3,2h6C9,18,10.255,18.035,10.718,18.561z"></path><text x="34" y="0.7em" style="font-size: 20px;"></text></g></svg>',svgShow:'<svg  class="" width="24" height="24" style="position: absolute; left: 6px; fill-opacity: 0.5;"><g transform="translate(0,0)scale(0.38)" class="comment show"><rect width="24" height="24" class="comment-background"></rect><path d="M10.718,18.561l6.78,5.311C17.609,23.957,17.677,24,17.743,24  c0.188,0,0.244-0.127,0.244-0.338v-5.023c0-0.355,0.233-0.637,0.548-0.637L21,18c2.219,0,3-1.094,3-2s0-13,0-14s-0.748-2-3.014-2  H2.989C0.802,0,0,0.969,0,2s0,13.031,0,14s0.828,2,3,2h6C9,18,10.255,18.035,10.718,18.561z"></path><text x="34" y="0.7em" style="font-size: 20px;"></text></g></svg>',bodyTemplate:function(a){var b="";if(this.option.remoteData){var c=this.option.page.Page;b=this.paging(c)}var d=settings.chartProp.info.stripped?"striped ":"",e=settings.chartProp.info.hover?"selectable ":"",f=settings.chartProp.info.bordered?"celled ":"",g='<div class="clusterize temporal" style="overflow: hidden;">                                     <table class="ui '+d+e+f+' table unstackable small  header-table" style="margin:0;border-left: none;border-right: none;">                                                      <thead>                                                '+tableInfo.headerTemplate(a.headers)+'    </thead>                                                 </table>                                                   <div id="scrollArea'+settings.id+'" class="clusterize-scroll" style="xdisplay: flex;max-height:200px; overflow:auto;">              <table class="ui '+d+e+f+' table unstackable  small body-table" style="margin:0;border: none; border-bottom: 1px solid #eaeaea;">                                                      <tbody id="contentArea'+settings.id+'" class="clusterize-content">          <tr class="clusterize-no-data">                              <td>Loading data…</td>                                   </tr>                                                    </tbody>                                                 </table>                                               '+(app.commentOnChart?tableInfo.svg:"")+"  </div>                                                   "+tableInfo.getFooterTemplate(a.headers)+b+"</div>                                                     ";return g},getStyle:function(a){"%"==a.formatString&&(a.formatString=".0%"),a.font=_.extendWith({},{bold:a.textBold,italic:a.textItalic,fontSize:a.fontSize,color:a.color,formatString:a.formatString,fontName:"IRANSans"},a.font);var b=["font-weight:"+(a.font.bold?"bold":"normal"),"italic","font-size:"+a.font.fontSize,"font-family:"+a.font.fontName,"text-align:"+(a.font.align||a.textAlign),"color:"+a.font.color,"position:relative","display:"+(a.isHidden?"none":"auto")];return a.forceLtr&&b.push(app.lang.isRtl()?"direction:ltr":"direction:rtl"),tableInfo.option.settings.chartProp.info.wrapContent&&(b.push("white-space:initial"),b.push("height:"+(tableInfo.option.settings.chartProp.info.cellHeight||50)+"px")),b.join(";")},getThenStyle:function(a){var b=[];a&&_.each(a,function(a){switch(+a.operand){case 1:b.push("color:"+a.secondFieldColor);break;case 3:b.push("background-color:"+a.secondFieldBackColor);break;case 4:var c=+a.secondFieldStyle;1===c&&(b.push("font-weight: normal"),b.push("font-style: normal")),2!==c&&4!==c||b.push("font-weight: bold"),3!==c&&4!==c||b.push("font-style: italic"),5===c&&b.push("text-decoration: underline")}});var c=_.head(_.filter(a,{operand:"2"})),d="";if(c&&c.secondFieldIcon&&"image"===c.secondFieldIcon.type)d=' <img style="width:1.5em" src="'+app.urlPrefix+"api/upload/getpic/"+c.secondFieldIcon.name+'"></i>';else if(c&&c.secondFieldIcon){var e=c.secondFieldIcon.name||c.secondFieldIcon;d=' <i class="'+e+'"></i>'}var f=_.head(_.filter(a,{operand:"5"}));return f&&(f=f.secondFieldReplace),{style:b.join(";"),icon:d,replace:f}},getText:function(a,b){var c=a.data;if(""===c)return nullReplcament;var d=tableInfo.option.tableData.headers[b].prop.isHtml,e=isNaN(c);if(!e){var f=tableInfo.option.tableData.headers[b].prop.font.formatString;return"custom"===f&&(f=tableInfo.option.tableData.headers[b].prop.font.formatStringCustom),d?c:persian(d3.format(f)(c),showPersian)}return d?c:persian(c,showPersian)},render:function(option){function onCellClick(){var a=$(this).data("xrow"),b=$(this).data("xcol");if(!tableInfo.option.tableData.headers[b].prop.preventClick){if(settings.chartProp.info.print&&settings.chartProp.info.print.enable&&print(tableInfo.option.tableData.headers,tableInfo.dataset,a,settings.chartProp.info.print.layout,settings.chartProp.info.print.oriantation,settings.chartProp.info.print.size,0,settings.chartProp.info.print.headerSize,settings.chartProp.info.print.footerSize),settings.chartProp.info.sheetEdit&&!tableInfo.option.tableData.headers[b].prop.openForm)return void editable.activeCell(a,b);if(tableInfo.option.pivoteMode){var c=tableInfo.dataset[a][0];if(isFromCommentDialog)return;if(settings.chartProp.globalvariable&&settings.chartProp.globalvariable.length>0&&!settings.editMode){var d=input.series.labels.concat([input.CurrentDimName]),e=c.series.concat(c.label);app.globalVariableHelper.updateGlobalVariables(d,e,settings.chartProp.globalvariable),$(selector+" .selected-item").removeClass("selected-item"),$(this).addClass("selected-item")}if(""===c.onClickVal||null===c.onClickVal)return void(hasHref&&!settings.editMode?app.chartCommons.openLink(settings.chartProp.info.openDashboard,{ChartInPageId:settings.ChartInPageId,DataSourceId:settings.input.DataSourceId,dimensionName:settings.input.dimensionName,value:c.value,refreshDatasource:settings.input.RefreshDatasource}):b<input.CurrentDimName.length&&tableInfo.onTdClick(a,b,$(this)));if(isProgress())return;showProgress(!0),settings.parameters={selectedItem:c.onClickVal,chartId:settings.chartId,ChartInPageId:settings.ChartInPageId,notEditMode:!settings.editMode},app.chartCommons.drillDown.add(settings.ChartInPageId,settings.input.DataSourceId,settings.input.CurrentDimName,c.onClickVal,settings.input),app.chartCommons.levelTypeUtils.getParam(settings),$(selector).charts(settings.type,"refreshWithData",settings)}tableInfo.option.pivoteMode||tableInfo.onTdClick(a,b,$(this))}}function trans3d(){var a=$(scrollId).scrollLeft();$(selector+" .header-table").css("-ms-transform","translate3d("+(-offset+a)+"px,0px,0px)"),$(selector+" .footer-table").css("-ms-transform","translate3d("+(-offset+a)+"px,0px,0px)"),$(selector+" .header-table").css("-webkit-transform","translate3d("+(offset-a)+"px,0px,0px)"),$(selector+" .footer-table").css("-webkit-transform","translate3d("+(offset-a)+"px,0px,0px)"),$(selector+" .header-table").css("-moz-transform","translate3d("+-a+"px,0px,0px)"),$(selector+" .footer-table").css("-moz-transform","translate3d("+-a+"px,0px,0px)")}tableInfo.option=option;var selector=option.selector,settings=option.settings,tableData=option.tableData,resultRows=option.resultRows,isFromCommentDialog=$(selector).hasClass("fromCommentDialog");$(selector).append(tableInfo.bodyTemplate(tableData));var hKeys=_.map(tableData.headers,"key"),mapFunction=function(a,b){var c=app.chartCommons.indicator.getIndicator(_.map(a,"data"),hKeys,settings.chartProp.indicator),d=_.flatten(c),e=[],f=a.map(function(a,c){var f=_.filter(d,{firstField:tableInfo.option.tableData.headers[c].key}),g=tableInfo.getStyle(tableInfo.option.tableData.headers[c].prop),h=tableInfo.getThenStyle(f);tableInfo.option.tableData.headers[c].prop.isHidden||e.push(a.data);var i="";if(tableInfo.option.pivoteMode){var j=tableData.rows[b][0];i=j.onClickVal}var k=tableInfo.option.tableData.headers[c].prop.isHtml,l="";("none"!==settings.chartProp.info.selectable||""!==i||hasHref||_.size(settings.chartProp.globalvariable)>0)&&(l="pointer");var m="";a.commentCount>0&&(m=tableInfo.svgShow.replace("</text>",persian(a.commentCount,showPersian)+"</text>")),app.commentOnChart||(m="");var n=filterXSS(h.replace||tableInfo.getText(a,c))||"&nbsp;";return'<td class="entry '+l+'" data-val="'+(a.data||"").toString().entitize()+'" data-xrow="'+b+'" data-xcol="'+c+'" title="'+(k?"":n)+'" ><div style="'+g+";"+h.style+'">'+n+(h.icon||"")+m+"</div></td>"}).filter(function(a,b){return!tableInfo.option.tableData.headers[b].prop.isHidden}),g="";if(settings.chartProp.info.showRowNumber){var h=0;tableInfo.option.page.Page&&(h=tableInfo.option.page.Limit*(tableInfo.option.page.Page-1));var i=tableInfo.option.settings.chartProp.series[rowNumberLablel];i=i||{},i.font=i.font||{};var j=tableInfo.getStyle(i);g='<td><div style="'+j+'">'+persian(h+b+1)+"</div></td>"}return{markup:"<tr>"+g+f.join("")+"</tr>",row:e}};tableInfo.dataset=tableData.rows;var $scroll=$("#scrollArea"+settings.id),$content=$("#contentArea"+settings.id),$headers=$(selector+" .header-table"),scrollBarWidth=7,fitHeaderColumns=function(){var a=[],b=!0;return function(){var c=$content.find("tr:not(.clusterize-extra-row):first"),d=c.children(),e=$(selector+" .footer-table tr:first-child td"),f=0,g=$(selector+" .body-table").height()||0,h=($(selector).height()||0)-($(selector+" .legend-bar").height()||0)-($(selector+" .header-table").height()||0)-($(selector+" .footer-table").height()||0)-($(selector+" .ui.pagination").height()||0)-4;f=g>h?scrollBarWidth:0;var i=$(selector).data("columnsWidth");i&&(a=i);var j=50;if(0===_.size(a)&&(d=$headers.find("tr").children(),c.children().each(function(b){var c=$(this).outerWidth();$(d.get(b)).outerWidth();0!==b&&c--,_.isArray(settings.chartProp.info.columnsWidth)&&(c=Math.max(settings.chartProp.info.columnsWidth[b],c)),a.push(c)}),!_.isArray(settings.chartProp.info.columnsWidth))){for(var k=$(selector).width(),l=0,m=0;m<a.length;m++)l+=a[m];if(l>k)for(var n=600,o=0,m=0;m<a.length;m++)if(a[m]>n&&(l-=a[m]-n,a[m]=n,o=m),l<=k){a[o]+=k-l-f-a.length-1;break}}if(!settings.chartProp.info.enableHorzScroll){var p=$(selector).width()-f-a.length,l=_.sum(a);a:for(;l>p;)for(var m=0;m<a.length;m++)if(a[m]>j&&(a[m]--,l--),_.max(a)<=j)break a}$headers.find("tr").children().each(function(b){var c=0;d.length-1==b&&(c=f),$(this).find("div").css({width:a[b]+c+"px"})}),d.each(function(b){var c=0;d.length-1==b&&(c=f),$(e.get(b)).find("div").css({width:a[b]+c+"px"})}),$content.find("tr:not(.clusterize-extra-row)").each(function(){$(this).children().each(function(b){$(this).find("div").css({width:a[b]+"px"})})}),b=!1}}(),editable={showError:function(a,b){a?(editable.error.text(b),editable.error.text(b),editable.error.show()):editable.error.hide()},save:function(){var a=this.cell,b=new $.Deferred,c=editable.inputElement.val(),d=editable.refElement.data("val"),e=input.columnTypes[a.col];return"bit"==e.type&&(c=editable.inputElement.prop("checked")?"True":"False"),e.isRadio&&(c=editable.element.find(".radio input:checked").val(),"undefined"==typeof c)?(b.resolve(),b.promise()):c==d?(b.resolve(),b.promise()):(editable.progress(!0,a.col),editable.showError(!1,a.col),console.log("### save ",{uniquename:input.Uniquenames[a.col],value:depersian(c),rowId:input.formIds[a.row]}),jQuery.ajax({url:app.urlPrefix+"api/formssubmit/submitcell/"+input.form,type:"POST",data:JSON.stringify({uniquename:input.Uniquenames[a.col],value:depersian(c),rowId:input.formIds[a.row]}),dataType:"json",contentType:"application/json; charset=utf-8",success:function(d){editable.progress(!1,a.col);var e=filterXSS(tableInfo.getText({data:c},a.col))||"&nbsp;";editable.refElement.find("div").text(e),editable.refElement.data("val",c),app.moderation.dashboadpage.refreshRelatedDatasources(d.RefreshDatasource,[settings.ChartInPageId],settings.chartProp.info.groups),b.resolve()},error:function(c){editable.showError(!0,a.col,c.responseJSON.desc),editable.progress(!1,a.col),editable.inputElement.focus(),console.log(c),b.reject()}}),b.promise())},progress:function(a){a?editable.progressElement.show():editable.progressElement.hide(),editable.inputElement.attr("disabled",a)},show:function(a,b){for(var c=0;c<editable.elements.length;c++)if(c!=b){var d=editable.elements[c];d&&d.element.hide()}a?editable.element.show():editable.element.hide()},activeCell:function(a,b){function c(){if(!editable.elements[b]){editable.cell={row:a,col:b},$("html").click(function(a){0===$(a.target).parents(".clusterize-scroll").length&&(editable.progress(!0,b),editable.save().then(function(){editable.progress(!1,b),editable.show(!1,b)}))}),editable.element=$('<div class="table-input">                                                    <div class="ui inline active tiny loader" style="display:none; position: absolute;right: auto;top: 5px;left: 5px;"></div>                                                    <input type="text" />                                                    <small class="error" style="display:none; text-align:right; background: #D32F2F; padding: 0.1em 0.5em;border-radius: 4px;margin: 0px; color: white;"></small>                                               </div>');var c=input.columnTypes[b];if(editable.inputElement=editable.element.find("input"),"bit"==c.type&&(editable.element=$('<div class="table-input" style="background: white; border: 1px solid silver; display: flex; align-items: center;justify-content: center;">                                                    <div class="ui inline active tiny loader" style="display:none; position: absolute;right: auto;top: 5px;left: 5px; "></div>                                                    <input type="checkbox"  style="width:auto; height:auto;"/>                                                    <small class="error" style="display:none; text-align:right; background: #D32F2F; padding: 0.1em 0.5em;border-radius: 4px;margin: 0px; color: white;"></small>                                               </div>'),editable.inputElement=editable.element.find("input")),c.isRadio){editable.element=$('<div class="table-input" style="background: white; border: 1px solid silver; display: flex; align-items: flex-start;justify-content: flex-end;">                                                    <div class="ui inline active tiny loader" style="display:none; position: absolute;right: auto;top: 5px;left: 5px; "></div>                                                    <span style="position: absolute;text-align: center;width: 100%;height: 100%;display: flex;justify-content: center;align-items: center;" class="old-value"></span>                                                    <div class="root" style="text-align: start; padding: 10px; background: white;border: 1px solid silver;border-radius: 4px;width: 100%;min-width: 120px;"></div>                                                    <small class="error" style="display:none; text-align:right; background: #D32F2F; padding: 0.1em 0.5em;border-radius: 4px;margin: 0px; color: white;"></small>                                                  </div>');var d=_.map(c.control.dropdown.items,function(a,b){return'<div class="ui radio checkbox" >                                          <input name="model-radio-'+c.control.name+'" type="radio" tabindex="'+b+'" id="'+c.control.name+b+'" value="'+a.value+'">                                          <label class="pointer" for="'+c.control.name+b+'">'+a.value+"</label>                                        </div>"}),e=d.join("<br/>");editable.element.find(".root").html(e),editable.inputElement=editable.element.find("table-input")}editable.progressElement=editable.element.find(".loader"),editable.error=editable.element.find(".error"),editable.elements[b]={element:editable.element,error:editable.error,progress:editable.progressElement,input:editable.inputElement},editable.inputElement.keyup(function(a){var c=editable.cell;if(27===a.keyCode&&editable.show(!1,b),38===a.keyCode){if(0===c.row)return;editable.save().then(function(){editable.activeCell(--c.row,c.col)})}if(40===a.keyCode||13===a.keyCode){if(c.row+1===tableInfo.option.tableData.rows.length)return;editable.save().then(function(){editable.activeCell(++c.row,c.col)})}if(37===a.keyCode){if(c.col+1===tableInfo.option.tableData.headers.length)return;editable.save().then(function(){editable.activeCell(c.row,++c.col)})}if(39===a.keyCode){if(0===c.col)return;editable.save().then(function(){editable.activeCell(c.row,--c.col)})}}),f.append(editable.element)}}function d(){editable.element=editable.elements[b].element,editable.error=editable.elements[b].error,editable.progressElement=editable.elements[b].progress,editable.inputElement=editable.elements[b].input}function e(){editable.refElement=f.find("td[data-xrow="+a+"][data-xcol="+b+"]");var c=(editable.refElement.find("div"),editable.refElement.data("val")),d=input.columnTypes[b];editable.show(!0,b),editable.showError(!1,b),d.isRadio?(editable.element.find(".old-value").text(c),editable.element.find(".radio input").prop("checked",!1),editable.element.find('.radio input[value="'+c+'"]').prop("checked",!0)):"bit"!=d.type?(editable.inputElement.val(c),editable.inputElement.get(0).setSelectionRange(0,(c+"").length)):editable.inputElement.prop("checked","True"==c),f.css({position:"relative"}),a*editable.refElement.height()<f.scrollTop()&&f.scrollTop(a*editable.refElement.height()),(a+1)*editable.refElement.height()>f.height()+f.scrollTop()&&f.scrollTop((a+1.5)*editable.refElement.height()-f.height()),editable.element.css({width:editable.refElement.width(),height:editable.refElement.height(),top:editable.refElement.position().top,left:editable.refElement.position().left}),d.isRadio&&editable.element.find(".root").css("margin-top",editable.refElement.height()+"px"),editable.inputElement.focus()}console.log("### active cell",a,b,"active cell",this.cell);var f=$(selector).find(".clusterize-scroll");editable.elements=editable.elements||[],editable.element?editable.save().then(function(){editable.cell={row:a,col:b},console.log(" set cell ",editable.cell),c(),d(),e()}):(c(),e())}},print=function(headers,data,index,layout,oriantation,size,back,headersize,footersize){function getValueWithFormat(a,b,c){return a.replace(pattern,function(a,b){var d=_.find(headers,{key:b}),e=c[d.index].data,f=filterXSS(tableInfo.getText({data:e},d.index))||"&nbsp;";return f})}function getValue(a,b){return a.replace(/@\{(.*?)\}/gi,function(a,c){var d=_.find(headers,{key:c}),e=b[d.index].data;return e})}function calc(input,row){return input.replace(/calc\[\[(.*?)\]\]/gim,function(match,p1){var c=getValue(p1,row);try{return persian(eval(c),!0)}catch(e){return"Error: "+e.message}})}var row=data[index],pattern=/@\{(.*?)\}/gi,content=layout.replace(/calc\{\{(.*?)\}\}/gim,function(a,b){return"calc[["+b+"]]"}),content=content.replace(/each\{\{(([\r\n]|.)*?)\}\}/gim,function(a,b,c){var d=_.map(data,function(a){var c=b;return c=calc(c,a),c=getValueWithFormat(c,!0,a)});return d.join("")});content=getValueWithFormat(content,!0,row),calc(content,row),app.print.printHeaderFooter(content,"name",oriantation,size,back,headersize,footersize)},data=tableInfo.dataset;if(!tableInfo.option.remoteData&&tableInfo.option.page&&tableInfo.option.page&&tableInfo.option.page.Order&&tableInfo.option.page.Order.length>0)for(var p=0;p<tableInfo.option.page.Order.length;p++){var entry=tableInfo.option.page.Order[p];
data=_.orderBy(data,function(a){return a[p]},1==entry.DescType?"asc":"desc")}var $comment;if(tableInfo.clusterize=new Clusterize({rows:data,rows_in_block:Math.floor($(selector).height()/(settings.chartProp.info.cellHeight||50))+1,scrollId:"scrollArea"+settings.id,contentId:"contentArea"+settings.id,callbacks:{mapFunction:mapFunction,clusterChanged:function(){if(fitHeaderColumns(),tableInfo.option.remoteData||$content.find("tr:not(.clusterize-extra-row) td").on("mouseover",function(a,b){$(this).find("div").append($comment)}),$content.find("tr:not(.clusterize-extra-row) td").on("click",onCellClick),isFromCommentDialog){var a=$content.find("tr:not(.clusterize-extra-row) td");$(a[0]).data("table-data",tableInfo.option.tableData),app.chartCommons.commentUtils.setOnHighlightListener($content.find("tr:not(.clusterize-extra-row) td"),settings.ChartInPageId)}}}}),$comment=$(selector+" .td-comment"),$comment.on("click",function(a){var b=$(this).parents("[data-xrow]").data("xrow"),c=$(this).parents("[data-xcol]").data("xcol"),d=tableInfo.dataset[b][c];return app.chartCommons.commentUtils.clickOnCommentIcon(d,settings.ChartInPageId),a.preventDefault(),!1}),"edit"===settings.chartProp.info.selectable&&settings.chartProp.info.showAddButton){var formBatch="";app.license=app.license||{},app.license.formBatch&&(input.formBatchEdit||input.formBatchDelete)&&(formBatch='      <div class="temporal ui mini compact button form-edit-batches"><i class="icon edit"></i> تغییر دسته‌ای رکوردها </div>    <div class="temporal batch-btns" style="display:inline-block;">'+(input.formBatchEdit?' <div class="temporal ui mini compact button form-edit-record"><i class="icon edit"></i> ویرایش </div>':"")+(input.formBatchEdit?' <div class="temporal ui mini compact button form-copy-record"><i class="icon copy"></i> کپی </div>':"")+(input.formBatchDelete?' <div class="temporal ui mini red compact button form-delete-record"><i class="icon edit"></i> حذف </div>':"")+"    </div>"),$openForm=$('<div class="temporal btn-container" style="margin:5px;">    <div class="temporal ui mini compact button form-new-record"><i class="icon add"></i> '+app.lang.translate("new record")+" </div>"+formBatch+"</div>"),$(selector).parents(".chart-widget").find(".title").append($openForm),$openForm.find(".form-new-record").on("click",function(){$("body").trigger("open-form",[input.form,0,selector])}),$openForm.find(".form-delete-record").on("click",function(){$("body").trigger("open-form",[input.form,0,selector,"delete-all",settings])}),$openForm.find(".form-edit-record").on("click",function(){$("body").trigger("open-form",[input.form,0,selector,"edit-all",settings])}),$openForm.find(".form-copy-record").on("click",function(){$("body").trigger("open-form",[input.form,0,selector,"copy-all",settings])}),$(selector).parents(".chart-widget").find(".batch-btns").hide(),$(selector).parents(".chart-widget").find(".form-edit-batches").on("click",function(){$(selector).parents(".chart-widget").find(".batch-btns").toggle()})}if(settings.chartProp.info.printAllRows&&settings.chartProp.info.printAllRows.enable){var container=$(selector).parents(".chart-widget").find(".title .btn-container");0==container.length&&(container=$('<div class="temporal" style="margin:5px;"></div>'),$(selector).parents(".chart-widget").find(".title").append(container));var $print=$('<div class="temporal ui mini compact button"><i class="icon print"></i> '+app.lang.translate("print")+" </div>");$(selector).parents(".chart-widget").find(".title .btn-container").append($print),$print.on("click",function(){print(tableInfo.option.tableData.headers,tableInfo.dataset,0,settings.chartProp.info.printAllRows.layout,settings.chartProp.info.printAllRows.oriantation,settings.chartProp.info.printAllRows.size,settings.chartProp.info.printAllRows.pic?settings.chartProp.info.printAllRows.pic.name:0,settings.chartProp.info.printAllRows.headerSize,settings.chartProp.info.printAllRows.footerSize)}),console.log("settings.chartProp.info.printAllRows",settings.chartProp.info.printAllRows)}var all=($(selector).height()||0)-($(selector+" .legend-bar").height()||0)-($(selector+" .header-table").height()||0)-($(selector+" .footer-table").height()||0)-($(selector+" .form-new-record-container").outerHeight()||0)-($(selector+" .ui.pagination").height()||0)-4;$(selector+" .clusterize-scroll").css({"max-height":all+"px","min-height":all+"px"});var scrollId="#scrollArea"+settings.id,offset=$(scrollId).scrollLeft();$(function(){var a,b,c=!1,d=!1,e=void 0;$(selector+" .header-table th .resize").on("click",function(a){return a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation(),!1}),$(selector+" .header-table th .resize").mousedown(function(d){e=$(this).parent().find("div"),c=!0,a=d.pageX,b=e.outerWidth(),$(e).addClass("resizing")}),$(document).mousemove(function(f){if(c){var g=b+(a-f.pageX);$(e).css({width:g+"px"}),d=!0}}),$(document).mouseup(function(a){if(c){$(e).removeClass("resizing"),c=!1;var b=[];$(selector+" .header-table th").each(function(){b.push($(this).outerWidth())}),b[b.length-1]-=scrollBarWidth;for(var f=0,g=0;g<b.length;g++)f+=b[g];$(selector).data("columnsWidth",b),fitHeaderColumns(),offset=$(scrollId).scrollLeft(),$(selector).trigger("columnsWidth",[{columnsWidth:b}]),setTimeout(function(){d=!1},500)}}),$(selector+" .header-table th").on("click",function(a,b){if(console.log("### header-table th click",c),!c&&!d){var e=+$(this).data("index");tableInfo.option.page=tableInfo.option.page||{},tableInfo.option.page.Order=tableInfo.option.page.Order||[];var f=_.find(tableInfo.option.page.Order,{Index:e});f||(f={Index:e,DescType:2}),_.remove(tableInfo.option.page.Order,f),tableInfo.option.page.Order.push(f),f.DescType=1===f.DescType?2:1,$(this).find(".icon").remove(),$(this).find("div").append('<i class="icon sort '+(1===f.DescType?"ascending":"descending")+'"></i>'),tableInfo.sort()}})}),$(scrollId).on("scroll",trans3d),trans3d(),$(selector+" .ui.pagination a").on("click",function(){var a=$(this).attr("value");tableInfo.gotoPage(parseInt(a))}),!tableInfo.option.remoteData&&tableInfo.option.page.Order&&tableInfo.sort()},sort:function(){if(!tableInfo.option.remoteData){var a=_.reverse(tableInfo.option.page.Order.map(function(a){return function(b){try{return b[a.Index].data||0}catch(c){return console.log("#### error ",b,a),""}}})),b=_.reverse(tableInfo.option.page.Order.map(function(a){return 1===a.DescType?"asc":"desc"}));tableInfo.dataset=_.orderBy(tableInfo.dataset,a,b),tableInfo.clusterize.update(tableInfo.dataset)}tableInfo.option.remoteData&&tableInfo.sortRemote(),settings.editMode&&$(selector).trigger("tableInfo",[{TableInfo:tableInfo.option.page}])},sortRemote:function(){isProgress()||(showProgress(!0),$.extend(settings.parameters,{TableInfo:tableInfo.option.page,notEditMode:!settings.editMode}),app.chartCommons.levelTypeUtils.getParam(settings),$(selector).charts(settings.type,"refreshWithData",settings,{refreshRelatedDatasources:!1}))},paging:function(a){var b=Math.ceil(tableInfo.option.totalRows/tableInfo.option.page.Limit),c=5;if(1==b)return"";b<c&&(c=b);for(var d=a-Math.ceil(c/2)>0,e=a+Math.ceil(c/2)<b,f=d?e?a-Math.ceil(c/2)+1:b-c+1:1,g="",h=0;h<c;h++)g+="<a  "+(f+h==a?'class="active item"':'class="item"')+' value="'+(f+h)+'">'+persian(f+h,showPersian)+"</a>";var i="";return""!=g&&(i='<div  class="ui borderless pagination menu attached  " style="">                                <a  '+(d?'class="item"':'class="disabled item"')+' value="1" style="border-right:1px solid #d4d4d5; border-radius:0;">&laquo;</a>                                '+g+"                                <a  "+(e?'class="item"':'class="disabled item"')+' value="'+b+'">&raquo;</a>                                <div class="item" style="font-size: 0.8em;color: #9E9E9E;"> '+app.lang.translate("all rows count")+": "+persian(this.option.totalRows,showPersian)+"</div>                            </div>"),i},gotoPage:function(a){TableInfo=tableInfo.option.page,isProgress()||(showProgress(!0),TableInfo.Page=a,TableInfo.IsPageValid=!0,$.extend(settings.parameters,{TableInfo:TableInfo,notEditMode:!settings.editMode}),app.chartCommons.levelTypeUtils.getParam(settings),$(selector).charts(settings.type,"refreshWithData",settings,{refreshRelatedDatasources:!1}),settings.parameters.TableInfo.IsPageValid=!1)},onTdClick:function(a,b,c){if("undefined"==typeof settings.chartProp.info.selectable&&(settings.chartProp.info.selectable="multi"),"none"!=settings.chartProp.info.selectable){if("edit"==settings.chartProp.info.selectable)return void $("body").trigger("open-form",[input.form,input.formIds[a],selector]);var d=c.hasClass("selected-item"),e=b+1+(settings.chartProp.info.showRowNumber?1:0);if(settings.chartProp.info.rowAsKey&&settings.chartProp.info.rowKey){var f=_.findIndex(this.filteredHeaders,{key:settings.chartProp.info.rowKey});if(f==-1)return;"one"==settings.chartProp.info.selectable&&$(selector+" .selected-item").removeClass("selected-item"),d?c.parents("tr").find("td").removeClass("selected-item"):c.parents("tr").find("td").addClass("selected-item")}else"one"==settings.chartProp.info.selectable&&$(selector+" td:nth-child("+e+").selected-item").removeClass("selected-item"),d?c.removeClass("selected-item"):c.addClass("selected-item");if(!settings.editMode){var g=$(selector+" td.selected-item").map(function(){var a=+$(this).data("xrow"),c=+$(this).data("xcol");return c!=b?null:tableInfo.dataset[a][c].data}).filter(function(a){return null!=a}).toArray(),h=this.option.tableData.headers[b].key;if(hasHref&&!settings.editMode)return void app.chartCommons.openLink(settings.chartProp.info.openDashboard,{ChartInPageId:settings.ChartInPageId,DataSourceId:settings.input.DataSourceId,dimensionName:h,value:g,refreshDatasource:settings.input.RefreshDatasource});var i={Id:-1,Values:g,VariableType:0,dimensionName:h,datasourceId:input.DataSourceId,chartInPageId:settings.ChartInPageId,chartId:input.chartId};app.moderation.dashboadpage.selectValueOnChart(i,input.RefreshDatasource)}}}};if(+input.isPivot>-1){settings.input=input,app.chartCommons.calculateFields(input.series,settings.calculatedFields);var chartInfo=input.chartInfo,seriesLabels="undefined"!=typeof input.series?input.series.labels:[],kpisLabels="undefined"!=typeof input.kpis?input.kpis.labels:[],labels=d3Utils.convertToKeyValue(input);labels.seriesLabels=labels.seriesLabels.map(function(a){return a.prop=getProp(a.key),a});var seriesLabelsKeys=labels.seriesLabels.map(function(a){return a.key}),seriesLabelsValues=labels.seriesLabels.map(function(a){return a.value}),yAxeLable=settings.LabelY,colors=d3.scaleOrdinal(d3.schemeCategory10);if(app.chartCommons.setDefault(settings.chartProp,seriesLabelsKeys.concat(chartInfo.hierarchyLabels),"table"),settings.editMode){var mLabels=seriesLabelsKeys.concat(chartInfo.hierarchyLabels);settings.chartProp.info.showRowNumber&&mLabels.splice(0,0,rowNumberLablel),$("#divChart").trigger("chartproperty",[mLabels])}if(!input.result)return void $("#"+settings.id).append(app.chartCommons.getError(input));var data=prepareData(input,null,!0),seriesLabelsCaptions=input.seriesLablesCaptions,kpisLabelsCaptions=input.kpisLablesCaptions;if(d3Utils.prepareDataForBarChart(data,settings,seriesLabels,kpisLabels,seriesLabelsCaptions,kpisLabelsCaptions),input.levels&&input.levels.length>0){var legendBar=d3.select(selector).append("div").attr("class","legend-bar temporal");legendBar.breadcrumb(input.levels,settings,titlebar,showPersian)}if(2===app.dashboardLayoutVersion&&!settings.editMode){var lb=$(selector+" .legend-bar"),topMargin=lb.css("margin-top"),topMarginDigit=topMargin?+lb.css("margin-top").replace("px",""):0,legendHeight="undefined"==typeof lb?0:lb.height()+0;barHeight-=legendHeight}if(!input.matrix||0===input.matrix.length)return void d3.select(selector).append("div").attr("class","temporal").style("font-size","0.8em").style("margin","15px").append("span").attr("class","translate").attr("data-trans-key","داده‌ای برای نمایش وجود ندارد").text("داده‌ای برای نمایش وجود ندارد");var headers=labels.seriesLabels.map(function(a){return{key:a.key,value:a.value,prop:getProp(a.key)}}),names=[];_.each(input.CurrentDimName,function(a){names.push({key:a,value:a,prop:getProp(a)})}),headers=names.concat(headers);var tableData={rows:data.map(function(a){var b=a.series,c=[];return _.each(a.label,function(b,d){c.push({data:b,prop:headers[d].prop,key:headers[d].key,label:headers[d].value,onClickVal:a.onClickVal?a.value:null,value:a.value})}),b=c.concat(b)}),headers:headers};return void tableInfo.render({selector:selector,settings:settings,tableData:tableData,resultRows:input.resultRows,pivoteMode:!0,page:settings.tableInfo})}if(settings.input=input,app.chartCommons.setDefault(settings.chartProp,input.headers,"table"),settings.editMode){var mLabels=input.headers.concat([]);settings.chartProp.info.showRowNumber&&mLabels.splice(0,0,rowNumberLablel),$("#divChart").trigger("chartproperty",[mLabels])}if(!input.result)return void $("#"+settings.id).append(app.chartCommons.getError(input));var nonPivotMatrix=input.nonPivotMatrix,dims=input.Dimentions.Hierarchies.concat(input.Dimentions.SeriesLevel||[]),headers=input.headers.map(function(a,b){return{key:dims[b],value:a,prop:getProp(a)}}),tableData={rows:nonPivotMatrix.map(function(a){var b=a.map(function(a){return{data:a}});return b}),headers:headers};if(tableInfo.render({selector:selector,settings:settings,tableData:tableData,resultRows:input.resultRows,page:input.TableInfo,totalRows:input.nonPivotMatrixLength,remoteData:!0}),input.TableInfo&&input.TableInfo.Filter){var filterparameters=input.TableInfo.Filter.map(function(a){return{value:a.FilterParameter,type:a.FilterType}});restoreFilterboxValue(filterparameters)}var filterparameters=$(selector).data("filterbox");restoreFilterboxValue(filterparameters)},function(a,b){"undefined"!=typeof module?module.exports=b():"function"==typeof define&&"object"==typeof define.amd?define(b):this[a]=b()}("Clusterize",function(){"use strict";function a(a,b,c){return b.addEventListener?b.addEventListener(a,c,!1):b.attachEvent("on"+a,c)}function b(a,b,c){return b.removeEventListener?b.removeEventListener(a,c,!1):b.detachEvent("on"+a,c)}function c(a){return"[object Array]"===Object.prototype.toString.call(a)}function d(a,b){return window.getComputedStyle?window.getComputedStyle(b)[a]:b.currentStyle[a]}var e=function(){for(var a=3,b=document.createElement("b"),c=b.all||[];b.innerHTML="<!--[if gt IE "+ ++a+"]><i><![endif]-->",c[0];);return a>4?a:document.documentMode}(),f=navigator.platform.toLowerCase().indexOf("mac")+1,g=function(d){if(!(this instanceof g))return new g(d);var e=this,h={rows_in_block:50,blocks_in_cluster:4,tag:null,show_no_data_row:!0,no_data_class:"clusterize-no-data",no_data_text:"No data",keep_parity:!0,callbacks:{}};e.options={};for(var i,j=["rows_in_block","blocks_in_cluster","show_no_data_row","no_data_class","no_data_text","keep_parity","tag","callbacks"],k=0;i=j[k];k++)e.options[i]="undefined"!=typeof d[i]&&null!=d[i]?d[i]:h[i];for(var l,m=["scroll","content"],k=0;l=m[k];k++)if(e[l+"_elem"]=d[l+"Id"]?document.getElementById(d[l+"Id"]):d[l+"Elem"],!e[l+"_elem"])throw new Error("Error! Could not find "+l+" element");e.content_elem.hasAttribute("tabindex")||e.content_elem.setAttribute("tabindex",0);var n=c(d.rows)?d.rows:e.fetchMarkup(),o={},p=e.scroll_elem.scrollTop;e.insertToDOM(n,o),e.scroll_elem.scrollTop=p;var q=!1,r=0,s=!1,t=function(){f&&(s||(e.content_elem.style.pointerEvents="none"),s=!0,clearTimeout(r),r=setTimeout(function(){e.content_elem.style.pointerEvents="auto",s=!1},50)),q!=(q=e.getClusterNum())&&e.insertToDOM(n,o),e.options.callbacks.scrollingProgress&&e.options.callbacks.scrollingProgress(e.getScrollProgress())},u=0,v=function(){clearTimeout(u),u=setTimeout(e.refresh,100)};a("scroll",e.scroll_elem,t),a("resize",window,v),e.destroy=function(a){b("scroll",e.scroll_elem,t),b("resize",window,v),e.html((a?e.generateEmptyRow():n).join(""))},e.refresh=function(a){(e.getRowsHeight(n)||a)&&e.update(n)},e.update=function(a){n=c(a)?a:[];var b=e.scroll_elem.scrollTop;n.length*e.options.item_height<b&&(e.scroll_elem.scrollTop=0,q=0),e.insertToDOM(n,o),e.scroll_elem.scrollTop=b},e.clear=function(){e.update([])},e.getRowsAmount=function(){return n.length},e.getScrollProgress=function(){return this.options.scroll_top/(n.length*this.options.item_height)*100||0};var w=function(a,b){var d=c(b)?b:[];d.length&&(n="append"==a?n.concat(d):d.concat(n),e.insertToDOM(n,o))};e.append=function(a){w("append",a)},e.prepend=function(a){w("prepend",a)}};return g.prototype={constructor:g,fetchMarkup:function(){for(var a=[],b=this.getChildNodes(this.content_elem);b.length;)a.push(b.shift().outerHTML);return a},exploreEnvironment:function(a,b){var c=this.options;if(c.content_tag=this.content_elem.tagName.toLowerCase(),a.length){var d=[a[0]].map(this.options.callbacks.mapFunction).map(function(a){return a.markup})[0];e&&e<=9&&!c.tag&&(c.tag=d.match(/<([^>\s/]*)/)[1].toLowerCase()),this.content_elem.children.length<=1&&(b.data=this.html(d+d+d)),c.tag||(c.tag=this.content_elem.children[0].tagName.toLowerCase()),this.getRowsHeight(a)}},getRowsHeight:function(a){var b=this.options,c=b.item_height;if(b.cluster_height=0,a.length){var e=this.content_elem.children;if(e.length){var f=e[Math.floor(e.length/2)];if(b.item_height=f.offsetHeight,"tr"==b.tag&&"collapse"!=d("borderCollapse",this.content_elem)&&(b.item_height+=parseInt(d("borderSpacing",this.content_elem),10)||0),"tr"!=b.tag){var g=parseInt(d("marginTop",f),10)||0,h=parseInt(d("marginBottom",f),10)||0;b.item_height+=Math.max(g,h)}return b.block_height=b.item_height*b.rows_in_block,b.rows_in_cluster=b.blocks_in_cluster*b.rows_in_block,b.cluster_height=b.blocks_in_cluster*b.block_height,c!=b.item_height}}},getClusterNum:function(){return this.options.scroll_top=this.scroll_elem.scrollTop,Math.floor(this.options.scroll_top/(this.options.cluster_height-this.options.block_height))||0},generateEmptyRow:function(){var a=this.options;if(!a.tag||!a.show_no_data_row)return[];var b,c=document.createElement(a.tag),d=document.createTextNode(a.no_data_text);return c.className=a.no_data_class,"tr"==a.tag&&(b=document.createElement("td"),b.colSpan=100,b.appendChild(d)),c.appendChild(b||d),[c.outerHTML]},generate:function(a,b){var c=this.options,d=a.length;if(d<c.rows_in_block){var e=c.callbacks.mapFunction&&a.map(c.callbacks.mapFunction).map(function(a){return a.markup});return{top_offset:0,bottom_offset:0,rows_above:0,rows:d?e:this.generateEmptyRow()}}var f=Math.max((c.rows_in_cluster-c.rows_in_block)*b,0),g=f+c.rows_in_cluster,h=Math.max(f*c.item_height,0),i=Math.max((d-g)*c.item_height,0),j=[],k=f;h<1&&k++;for(var l=f;l<g;l++)a[l]&&j.push(a[l]);return j=c.callbacks.mapFunction&&j.map(function(a,b){return c.callbacks.mapFunction(a,b+f)}).map(function(a){return a.markup}),{top_offset:h,bottom_offset:i,rows_above:k,rows:j}},renderExtraTag:function(a,b){var c=document.createElement(this.options.tag),d="clusterize-";return c.className=[d+"extra-row",d+a].join(" "),b&&(c.style.height=b+"px"),c.outerHTML},insertToDOM:function(a,b){this.options.cluster_height||this.exploreEnvironment(a,b);var c=this.generate(a,this.getClusterNum()),d=c.rows.join(""),e=this.checkChanges("data",d,b),f=this.checkChanges("top",c.top_offset,b),g=this.checkChanges("bottom",c.bottom_offset,b),h=this.options.callbacks,i=[];e||f?(c.top_offset&&(this.options.keep_parity&&i.push(this.renderExtraTag("keep-parity")),i.push(this.renderExtraTag("top-space",c.top_offset))),i.push(d),c.bottom_offset&&i.push(this.renderExtraTag("bottom-space",c.bottom_offset)),h.clusterWillChange&&h.clusterWillChange(),this.html(i.join("")),"ol"==this.options.content_tag&&this.content_elem.setAttribute("start",c.rows_above),this.content_elem.style["counter-increment"]="clusterize-counter "+(c.rows_above-1),h.clusterChanged&&h.clusterChanged()):g&&(this.content_elem.lastChild.style.height=c.bottom_offset+"px")},html:function(a){var b=this.content_elem;if(e&&e<=9&&"tr"==this.options.tag){var c,d=document.createElement("div");for(d.innerHTML="<table><tbody>"+a+"</tbody></table>";c=b.lastChild;)b.removeChild(c);for(var f=this.getChildNodes(d.firstChild.firstChild);f.length;)b.appendChild(f.shift())}else b.innerHTML=a},getChildNodes:function(a){for(var b=a.children,c=[],d=0,e=b.length;d<e;d++)c.push(b[d]);return c},checkChanges:function(a,b,c){var d=b!=c[a];return c[a]=b,d}},g}),!function(){"use strict";function a(d){if(!d)throw new Error("No options passed to Waypoint constructor");if(!d.element)throw new Error("No element option passed to Waypoint constructor");if(!d.handler)throw new Error("No handler option passed to Waypoint constructor");this.key="waypoint-"+b,this.options=a.Adapter.extend({},a.defaults,d),this.element=this.options.element,this.adapter=new a.Adapter(this.element),this.callback=d.handler,this.axis=this.options.horizontal?"horizontal":"vertical",this.enabled=this.options.enabled,this.triggerPoint=null,this.group=a.Group.findOrCreate({name:this.options.group,axis:this.axis}),this.context=a.Context.findOrCreateByElement(this.options.context),a.offsetAliases[this.options.offset]&&(this.options.offset=a.offsetAliases[this.options.offset]),this.group.add(this),this.context.add(this),c[this.key]=this,b+=1}var b=0,c={};a.prototype.queueTrigger=function(a){this.group.queueTrigger(this,a)},a.prototype.trigger=function(a){this.enabled&&this.callback&&this.callback.apply(this,a)},a.prototype.destroy=function(){this.context.remove(this),this.group.remove(this),delete c[this.key]},a.prototype.disable=function(){return this.enabled=!1,this},a.prototype.enable=function(){return this.context.refresh(),this.enabled=!0,this},a.prototype.next=function(){return this.group.next(this)},a.prototype.previous=function(){return this.group.previous(this)},a.invokeAll=function(a){var b=[];for(var d in c)b.push(c[d]);for(var e=0,f=b.length;f>e;e++)b[e][a]()},a.destroyAll=function(){a.invokeAll("destroy")},a.disableAll=function(){a.invokeAll("disable")},a.enableAll=function(){a.Context.refreshAll();for(var b in c)c[b].enabled=!0;return this},a.refreshAll=function(){a.Context.refreshAll()},a.viewportHeight=function(){return window.innerHeight||document.documentElement.clientHeight},a.viewportWidth=function(){return document.documentElement.clientWidth},a.adapters=[],a.defaults={context:window,continuous:!0,enabled:!0,group:"default",horizontal:!1,offset:0},a.offsetAliases={"bottom-in-view":function(){return this.context.innerHeight()-this.adapter.outerHeight()},"right-in-view":function(){return this.context.innerWidth()-this.adapter.outerWidth()}},window.Waypoint=a}(),function(){"use strict";function a(a){window.setTimeout(a,1e3/60)}function b(a){this.element=a,this.Adapter=e.Adapter,this.adapter=new this.Adapter(a),this.key="waypoint-context-"+c,this.didScroll=!1,this.didResize=!1,this.oldScroll={x:this.adapter.scrollLeft(),y:this.adapter.scrollTop()},this.waypoints={vertical:{},horizontal:{}},a.waypointContextKey=this.key,d[a.waypointContextKey]=this,c+=1,e.windowContext||(e.windowContext=!0,e.windowContext=new b(window)),this.createThrottledScrollHandler(),this.createThrottledResizeHandler()}var c=0,d={},e=window.Waypoint,f=window.onload;b.prototype.add=function(a){var b=a.options.horizontal?"horizontal":"vertical";this.waypoints[b][a.key]=a,this.refresh()},b.prototype.checkEmpty=function(){var a=this.Adapter.isEmptyObject(this.waypoints.horizontal),b=this.Adapter.isEmptyObject(this.waypoints.vertical),c=this.element==this.element.window;a&&b&&!c&&(this.adapter.off(".waypoints"),delete d[this.key])},b.prototype.createThrottledResizeHandler=function(){function a(){b.handleResize(),b.didResize=!1}var b=this;this.adapter.on("resize.waypoints",function(){b.didResize||(b.didResize=!0,e.requestAnimationFrame(a))})},b.prototype.createThrottledScrollHandler=function(){function a(){b.handleScroll(),b.didScroll=!1}var b=this;this.adapter.on("scroll.waypoints",function(){(!b.didScroll||e.isTouch)&&(b.didScroll=!0,e.requestAnimationFrame(a))})},b.prototype.handleResize=function(){e.Context.refreshAll()},b.prototype.handleScroll=function(){var a={},b={horizontal:{newScroll:this.adapter.scrollLeft(),oldScroll:this.oldScroll.x,forward:"right",backward:"left"},vertical:{newScroll:this.adapter.scrollTop(),oldScroll:this.oldScroll.y,forward:"down",backward:"up"}};for(var c in b){var d=b[c],e=d.newScroll>d.oldScroll,f=e?d.forward:d.backward;for(var g in this.waypoints[c]){var h=this.waypoints[c][g];if(null!==h.triggerPoint){var i=d.oldScroll<h.triggerPoint,j=d.newScroll>=h.triggerPoint,k=i&&j,l=!i&&!j;(k||l)&&(h.queueTrigger(f),a[h.group.id]=h.group)}}}for(var m in a)a[m].flushTriggers();this.oldScroll={x:b.horizontal.newScroll,y:b.vertical.newScroll}},b.prototype.innerHeight=function(){return this.element==this.element.window?e.viewportHeight():this.adapter.innerHeight()},b.prototype.remove=function(a){delete this.waypoints[a.axis][a.key],this.checkEmpty()},b.prototype.innerWidth=function(){return this.element==this.element.window?e.viewportWidth():this.adapter.innerWidth()},b.prototype.destroy=function(){var a=[];for(var b in this.waypoints)for(var c in this.waypoints[b])a.push(this.waypoints[b][c]);for(var d=0,e=a.length;e>d;d++)a[d].destroy()},b.prototype.refresh=function(){var a,b=this.element==this.element.window,c=b?void 0:this.adapter.offset(),d={};this.handleScroll(),a={horizontal:{contextOffset:b?0:c.left,contextScroll:b?0:this.oldScroll.x,contextDimension:this.innerWidth(),oldScroll:this.oldScroll.x,forward:"right",backward:"left",offsetProp:"left"},vertical:{contextOffset:b?0:c.top,contextScroll:b?0:this.oldScroll.y,contextDimension:this.innerHeight(),oldScroll:this.oldScroll.y,forward:"down",backward:"up",offsetProp:"top"}};for(var f in a){var g=a[f];for(var h in this.waypoints[f]){var i,j,k,l,m,n=this.waypoints[f][h],o=n.options.offset,p=n.triggerPoint,q=0,r=null==p;n.element!==n.element.window&&(q=n.adapter.offset()[g.offsetProp]),"function"==typeof o?o=o.apply(n):"string"==typeof o&&(o=parseFloat(o),n.options.offset.indexOf("%")>-1&&(o=Math.ceil(g.contextDimension*o/100))),i=g.contextScroll-g.contextOffset,n.triggerPoint=Math.floor(q+i-o),j=p<g.oldScroll,k=n.triggerPoint>=g.oldScroll,l=j&&k,m=!j&&!k,!r&&l?(n.queueTrigger(g.backward),d[n.group.id]=n.group):!r&&m?(n.queueTrigger(g.forward),d[n.group.id]=n.group):r&&g.oldScroll>=n.triggerPoint&&(n.queueTrigger(g.forward),d[n.group.id]=n.group)}}return e.requestAnimationFrame(function(){for(var a in d)d[a].flushTriggers()}),this},b.findOrCreateByElement=function(a){return b.findByElement(a)||new b(a)},b.refreshAll=function(){for(var a in d)d[a].refresh()},b.findByElement=function(a){return d[a.waypointContextKey]},window.onload=function(){f&&f(),b.refreshAll()},e.requestAnimationFrame=function(b){var c=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||a;c.call(window,b)},e.Context=b}(),function(){"use strict";function a(a,b){return a.triggerPoint-b.triggerPoint}function b(a,b){return b.triggerPoint-a.triggerPoint}function c(a){this.name=a.name,this.axis=a.axis,this.id=this.name+"-"+this.axis,this.waypoints=[],this.clearTriggerQueues(),d[this.axis][this.name]=this}var d={vertical:{},horizontal:{}},e=window.Waypoint;c.prototype.add=function(a){this.waypoints.push(a)},c.prototype.clearTriggerQueues=function(){this.triggerQueues={up:[],down:[],left:[],right:[]}},c.prototype.flushTriggers=function(){for(var c in this.triggerQueues){var d=this.triggerQueues[c],e="up"===c||"left"===c;d.sort(e?b:a);for(var f=0,g=d.length;g>f;f+=1){var h=d[f];(h.options.continuous||f===d.length-1)&&h.trigger([c])}}this.clearTriggerQueues()},c.prototype.next=function(b){this.waypoints.sort(a);var c=e.Adapter.inArray(b,this.waypoints),d=c===this.waypoints.length-1;return d?null:this.waypoints[c+1]},c.prototype.previous=function(b){this.waypoints.sort(a);var c=e.Adapter.inArray(b,this.waypoints);return c?this.waypoints[c-1]:null},c.prototype.queueTrigger=function(a,b){this.triggerQueues[b].push(a)},c.prototype.remove=function(a){var b=e.Adapter.inArray(a,this.waypoints);b>-1&&this.waypoints.splice(b,1)},c.prototype.first=function(){return this.waypoints[0]},c.prototype.last=function(){return this.waypoints[this.waypoints.length-1]},c.findOrCreate=function(a){return d[a.axis][a.name]||new c(a)},e.Group=c}(),function(){"use strict";function a(a){this.$element=b(a)}var b=window.jQuery,c=window.Waypoint;b.each(["innerHeight","innerWidth","off","offset","on","outerHeight","outerWidth","scrollLeft","scrollTop"],function(b,c){a.prototype[c]=function(){var a=Array.prototype.slice.call(arguments);return this.$element[c].apply(this.$element,a)}}),b.each(["extend","inArray","isEmptyObject"],function(c,d){a[d]=b[d]}),c.adapters.push({name:"jquery",Adapter:a}),c.Adapter=a}(),function(){"use strict";function a(a){return function(){var c=[],d=arguments[0];return a.isFunction(arguments[0])&&(d=a.extend({},arguments[1]),d.handler=arguments[0]),this.each(function(){var e=a.extend({},d,{element:this});"string"==typeof e.context&&(e.context=a(this).closest(e.context)[0]),c.push(new b(e))}),c}}var b=window.Waypoint;window.jQuery&&(window.jQuery.fn.waypoint=a(window.jQuery)),window.Zepto&&(window.Zepto.fn.waypoint=a(window.Zepto))}(),function(a){var b,c=a(document),d=a("head"),e=null,f={},g=0,h="id",i="px",j="JColResizer",k="JCLRFlex",l=parseInt,m=Math,n=navigator.userAgent.indexOf("Trident/4.0")>0;try{b=sessionStorage}catch(o){}d.append("<style type='text/css'>  .JColResizer{table-layout:fixed;} .JColResizer > tbody > tr > td, .JColResizer > tbody > tr > th{overflow:hidden}  .JPadding > tbody > tr > td, .JPadding > tbody > tr > th{padding-left:0!important; padding-right:0!important;} .JCLRgrips{ height:0px; position:relative;} .JCLRgrip{margin-left:-5px; position:absolute; z-index:5; } .JCLRgrip .JColResizer{position:absolute;background-color:red;filter:alpha(opacity=1);opacity:0;width:10px;height:100%;cursor: col-resize;top:0px} .JCLRLastGrip{position:absolute; width:1px; } .JCLRgripDrag{ border-left:1px dotted black;\t} .JCLRFlex{width:auto!important;} .JCLRgrip.JCLRdisabledGrip .JColResizer{cursor:default; display:none;}</style>");var p=function(b,c){var e=a(b);if(e.opt=c,e.mode=c.resizeMode,e.dc=e.opt.disabledColumns,e.opt.removePadding&&e.addClass("JPadding"),e.opt.disable)return q(e);var i=e.id=e.attr(h)||j+g++;e.p=e.opt.postbackSafe,!e.is("table")||f[i]&&!e.opt.partialRefresh||("col-resize"!==e.opt.hoverCursor&&d.append("<style type='text/css'>.JCLRgrip .JColResizer:hover{cursor:"+e.opt.hoverCursor+"!important}</style>"),e.addClass(j).attr(h,i).before('<div class="JCLRgrips"/>'),e.g=[],e.c=[],e.w=e.width(),e.gc=e.prev(),e.f=e.opt.fixed,c.marginLeft&&e.gc.css("marginLeft",c.marginLeft),c.marginRight&&e.gc.css("marginRight",c.marginRight),e.cs=l(n?b.cellSpacing||b.currentStyle.borderSpacing:e.css("border-spacing"))||2,e.b=l(n?b.border||b.currentStyle.borderLeftWidth:e.css("border-left-width"))||1,f[i]=e,r(e))},q=function(a){var b=a.attr(h),a=f[b];a&&a.is("table")&&(a.removeClass(j+" "+k).gc.remove(),delete f[b])},r=function(c){var d=c.find(">thead>tr:first>th,>thead>tr:first>td");d.length||(d=c.find(">tbody>tr:first>th,>tr:first>th,>tbody>tr:first>td, >tr:first>td")),d=d.filter(":visible"),c.cg=c.find("col"),c.ln=d.length,c.p&&b&&b[c.id]&&s(c,d),d.each(function(b){var d=a(this),e=c.dc.indexOf(b)!=-1,f=a(c.gc.append('<div class="JCLRgrip"></div>')[0].lastChild);f.append(e?"":c.opt.gripInnerHtml).append('<div class="'+j+'"></div>'),b==c.ln-1&&(f.addClass("JCLRLastGrip"),c.f&&f.html("")),f.bind("touchstart mousedown",y),e?f.addClass("JCLRdisabledGrip"):f.removeClass("JCLRdisabledGrip").bind("touchstart mousedown",y),f.t=c,f.i=b,f.c=d,d.w=d.width(),c.g.push(f),c.c.push(d),d.width(d.w).removeAttr("width"),f.data(j,{i:b,t:c.attr(h),last:b==c.ln-1})}),c.cg.removeAttr("width"),c.find("td, th").not(d).not("table th, table td").each(function(){a(this).removeAttr("width")}),c.f||c.removeAttr("width").addClass(k),
t(c)},s=function(a,c){var d,e,f=0,g=0,h=[];if(c){if(a.cg.removeAttr("width"),a.opt.flush)return void(b[a.id]="");for(d=b[a.id].split(";"),e=d[a.ln+1],!a.f&&e&&(a.width(e*=1),a.opt.overflow&&(a.css("min-width",e+i),a.w=e));g<a.ln;g++)h.push(100*d[g]/d[a.ln]+"%"),c.eq(g).css("width",h[g]);for(g=0;g<a.ln;g++)a.cg.eq(g).css("width",h[g])}else{for(b[a.id]="";g<a.c.length;g++)d=a.c[g].width(),b[a.id]+=d+";",f+=d;b[a.id]+=f,a.f||(b[a.id]+=";"+a.width())}},t=function(a){a.gc.width(a.w);for(var b=0;b<a.ln;b++){var c=a.c[b];a.g[b].css({left:c.offset().left-a.offset().left+c.outerWidth(!1)+a.cs/2+i,height:a.opt.headerOnly?a.c[0].outerHeight(!1):a.outerHeight(!1)})}},u=function(a,b,c){var d=e.x-e.l,f=a.c[b],g=a.c[b+1],h=f.w+d,j=g.w-d;f.width(h+i),a.cg.eq(b).width(h+i),a.f?(g.width(j+i),a.cg.eq(b+1).width(j+i)):a.opt.overflow&&a.css("min-width",a.w+d),c&&(f.w=h,g.w=a.f?j:g.w)},v=function(b){var c=a.map(b.c,function(a){return a.width()});b.width(b.w=b.width()).removeClass(k),a.each(b.c,function(a,b){b.width(c[a]).w=c[a]}),b.addClass(k)},w=function(a){if(e){var b=e.t,c=a.originalEvent.touches,d=c?c[0].pageX:a.pageX,f=d-e.ox+e.l,g=b.opt.minWidth,h=e.i,j=1.5*b.cs+g+b.b,k=h==b.ln-1,l=h?b.g[h-1].position().left+b.cs+g:j,n=b.f?h==b.ln-1?b.w-j:b.g[h+1].position().left-b.cs-g:1/0;if(f=m.max(l,m.min(n,f)),e.x=f,e.css("left",f+i),k){var o=b.c[e.i];e.w=o.w+f-e.l}if(b.opt.liveDrag){k?(o.width(e.w),!b.f&&b.opt.overflow?b.css("min-width",b.w+f-e.l):b.w=b.width()):u(b,h),t(b);var p=b.opt.onDrag;p&&(a.currentTarget=b[0],p(a))}return!1}},x=function(d){if(c.unbind("touchend."+j+" mouseup."+j).unbind("touchmove."+j+" mousemove."+j),a("head :last-child").remove(),e){if(e.removeClass(e.t.opt.draggingClass),e.x-e.l!=0){var f=e.t,g=f.opt.onResize,h=e.i,i=h==f.ln-1,k=f.g[h].c;i?(k.width(e.w),k.w=e.w):u(f,h,!0),f.f||v(f),t(f),g&&(d.currentTarget=f[0],g(d)),f.p&&b&&s(f)}e=null}},y=function(b){var g=a(this).data(j),h=f[g.t],i=h.g[g.i],k=b.originalEvent.touches;if(i.ox=k?k[0].pageX:b.pageX,i.l=i.position().left,i.x=i.l,c.bind("touchmove."+j+" mousemove."+j,w).bind("touchend."+j+" mouseup."+j,x),d.append("<style type='text/css'>*{cursor:"+h.opt.dragCursor+"!important}</style>"),i.addClass(h.opt.draggingClass),e=i,h.c[g.i].l)for(var l,m=0;m<h.ln;m++)l=h.c[m],l.l=!1,l.w=l.width();return!1},z=function(){for(var a in f)if(f.hasOwnProperty(a)){a=f[a];var c,d=0;if(a.removeClass(j),a.f){for(a.w=a.width(),c=0;c<a.ln;c++)d+=a.c[c].w;for(c=0;c<a.ln;c++)a.c[c].css("width",m.round(1e3*a.c[c].w/d)/10+"%").l=!0}else v(a),"flex"==a.mode&&a.p&&b&&s(a);t(a.addClass(j))}};a(window).bind("resize."+j,z),a.fn.extend({colResizable:function(b){var c={resizeMode:"fit",draggingClass:"JCLRgripDrag",gripInnerHtml:"",liveDrag:!1,minWidth:15,headerOnly:!1,hoverCursor:"col-resize",dragCursor:"col-resize",postbackSafe:!1,flush:!1,marginLeft:null,marginRight:null,disable:!1,partialRefresh:!1,disabledColumns:[],removePadding:!0,onDrag:null,onResize:null},b=a.extend(c,b);switch(b.fixed=!0,b.overflow=!1,b.resizeMode){case"flex":b.fixed=!1;break;case"overflow":b.fixed=!1,b.overflow=!0}return this.each(function(){p(this,b)})}})}(jQuery);var app=app||{};app.charts=app.charts||{},app.charts.tree={},app.charts.tree.draw=function(a,b,c,d){function e(c){return c.dimensionName=a.dimensionName,c.datasourceId=a.DataSourceId,c.chartId=b.editMode?-1:a.chartId,b.editMode||c.Id!==-1||app.chartCommons.userFilter.setFilter({id:c.Id,values:c.Values,variableType:c.VariableType,dimensionName:c.dimensionName,chartInPageId:b.ChartInPageId,datasourceId:c.datasourceId}),+c.Id===-1?(app.moderation.dashboadpage.refreshRelatedDatasources(a.RefreshDatasource,[+b.ChartInPageId]),void app.filterBox.refresh()):void $.ajax({type:"POST",url:app.urlPrefix+"api/GlobalVariable/SetValueForUser",dataType:"json",contentType:"application/json;charset=utf-8",traditional:!0,data:JSON.stringify(c),success:function(a){a.result?(app.moderation.dashboadpage.refreshRelatedDatasources(a.relatedDatasource,[+b.ChartInPageId]),app.filterBox.refresh()):alert(a.Message)}})}b.input=a,app.chartCommons.calculateFields(a.series,b.calculatedFields);var f=(a.title,a.chartInfo,"undefined"!=typeof a.series?a.series.labels:[]),g="undefined"!=typeof a.kpis?a.kpis.labels:[],h=(b.LabelY,"#"+b.id),i=$(h).width();$(h).height(),"small"==b.chartProp.info.chartSize?150:"medium"==b.chartProp.info.chartSize?200:"large"==b.chartProp.info.chartSize?250:"veryLarge"==b.chartProp.info.chartSize?400:130;b.width=i;"undefined"==typeof a.lang||0==+a.lang,d.isProgress,d.showProgress,d.title;if(b.editMode&&$(h).trigger("chartproperty",[g.concat(f)]),!a.result)return void $("#"+b.id).append(app.chartCommons.getError(a));$(h).addClass("tree-chart"),$(h).css({"overflow-y":"auto","overflow-x":"hidden","margin-left":"-1rem"});var j=$(h+" .title").outerHeight(),k=$(h).outerHeight()-j-2,l=d3.select(h).append("ul").attr("class","root-node temporal tree").text("");l.style("height",k+"px");var m=function(a,c){a.select(".loading").remove(),$(a.node()).data("vals",c.vals);var d=$(a.node()).find(".tree-caret"),f=0==d.length||d.hasClass("rotate"),g=d3.select($("<ul></ul>").get(0)).attr("class","tree-element collapse fade "+(f?"in":""));c.data=c.data.map(function(a){return{id:a[0],parent:a[1],name:a[2]||a[0],type:c.hasType?a[3]:null,childs:a[a.length-1]}});var i=g.selectAll("li").data(c.data).enter().append("li").attr("class","node tree-element");i.append("span").text(function(a,b){return a.name}).attr("class","value pointer").on("click",function(a,d){var f=b.chartProp.info.selectable;if("undefined"!=typeof f&&"none"!=f){"one"==f&&$(this).closest(".tree-chart").find(".value.active").removeClass("active"),$(this).toggleClass("active");var g=d3.select(h).selectAll(".active").data().map(function(a){return a.id}),i=_.filter(c.vals,function(a){return a[0]===g[0]}).map(function(a){return a[1]});0===i.length&&(i=g),b.editMode?$(h).trigger("default-value",[!0,i,0]):e({Id:-1,Values:i,VariableType:0})}}),i.each(function(a){if(0!=+a.childs){var c=d3.select(this).append("i").attr("class",function(){return"icon angle left icon-animate large  tree-caret pointer"}).text(" ");c.on("click",function(a,d){c.nodes().indexOf(this);if(0!=+d.childs){var e="rotate-90",f=$(this),g=f.hasClass(e);g?f.removeClass(e):f.addClass(e);var h=$(this).data("loaded");if(h){var i=$(this).parent().find(" > ul");return console.log("sdsdsd"),void i.transition(g?"fade up":"fade down")}$(this).data("loaded",!0);var j={parent:d.id,chartId:b.chartId,ChartInPageId:b.ChartInPageId,notEditMode:!b.editMode};b.editMode&&(j.ChartInfo=$("#divChart").data("chartInfo"));var k=d3.select(this).node().parentElement;d3.select(k).append("ul").attr("class","loading collapse fade in").html('<div class="ui active inline loader mini"></div>');var l=app.urlPrefix+"api/BarChart/getTreeData",n=app.mobileMode?proxy.ajax:$.ajax,o=JSON.stringify(j);n({url:l,type:"POST",dataType:"json",contentType:"application/json",data:o,async:b.async,requestId:b.requestId,success:function(a,c,d){b.mobileModeData={isOnline:c,date:d},m(d3.select(k),a)},error:function(){}})}})}}),g.style("display","none"),$(a._groups[0][0]).append($(g._groups[0][0])),$(a._groups[0][0]).find("> ul").transition("fade up ")};m(l,a),$(h).trigger("heightChange")};var app=app||{};app.charts=app.charts||{},app.charts.text={},app.charts.text.draw=function(a,b,c,d){b.input=a,app.chartCommons.calculateFields(a.series,b.calculatedFields);var e=(a.title,a.chartInfo,"undefined"!=typeof a.series?a.series.labels:[]),f="undefined"!=typeof a.kpis?a.kpis.labels:[],g=(b.LabelY,"#"+b.id),h=$(g).width();$(g).height(),"small"==b.chartProp.info.chartSize?150:"medium"==b.chartProp.info.chartSize?200:"large"==b.chartProp.info.chartSize?250:"veryLarge"==b.chartProp.info.chartSize?400:130;b.width=h;"undefined"==typeof a.lang||0==+a.lang,d.isProgress,d.showProgress,d.title;if(b.editMode&&$(g).trigger("chartproperty",[f.concat(e)]),!a.result)return void $("#"+b.id).append(app.chartCommons.getError(a));$(g).addClass("tree-chart").css("text-align","right");var i=$(g+" .title").outerHeight(),j=$(g).outerHeight()-i-2,k=d3.select(g).append("ul").attr("class","root-node temporal tree").text("");k.style("height",j+"px"),$(g).append(b.chartProp.info.html)};var app=app||{};app.charts=app.charts||{},app.charts.userControl={},String.prototype.deentitize=function(){var a=this.replace(/&gt;/g,">");return a=a.replace(/&amp;/g,"&"),a=a.replace(/&lt;/g,"<"),a=a.replace(/&quot;/g,'"'),a=a.replace(/&ldquo;/g,'"'),a=a.replace(/“/g,'"'),a=a.replace(/”/g,'"'),a=a.replace(/&apos;/g,"'"),a=a.replace(/<br r >/g,"\r"),a=a.replace(/<br n >/g,"\n")},String.prototype.entitize=function(a){var b=this;return b=b.replace(/&/g,"&amp;"),b=b.replace(/>/g,"&gt;"),b=b.replace(/</g,"&lt;"),a?(b=b.replace(/"/g,"&ldquo;"),b=b.replace(/'/g,"&apos;")):(b=b.replace(/"/g,"&ldquo;"),b=b.replace(/'/g,"&apos;")),b=b.replace(/\r/g,"<br r >"),b=b.replace(/\n/g,"<br n >")},app.charts.userControl.draw=function(a,b,c,d){function e(){function c(a){var c=[a],d=b.chartProp.info.textOperand||"or",e="undefined"==typeof b.chartProp.info.useLike||b.chartProp.info.useLike,f="undefined"==typeof b.chartProp.info.useNormal||b.chartProp.info.useNormal;c.push(JSON.stringify({op:d,useLike:e,useNormal:f}));var g=b.chartProp.info.dimensions.map(function(a){return a.Name}).join(", ");if(c.push(g),b.chartProp.info.dimensions.forEach(function(a){c.push(a.formula)}),b.editMode)$(o).trigger("default-value",[!0,c,5]);else{var h={Id:b.chartProp.info.variableId||-1,Values:c,VariableType:5};n(h)}}var d='<div class="ui form temporal">    <div class=" field ui search">        <div class="ui icon input">            <input type="text" placeholder="جستجو...">            <i class="search icon"></i>        </div>        <div class="results"></div>    </div></div> ';d='<div class="temporal ui search">                  <div class="ui icon fluid input">                    <input class="prompt" type="text" placeholder="جستجو...">                    <i class="search icon"></i>                  </div>                  <div class="results"></div>                </div>',$(o).append(d),$.fn.search.settings.templates.message=function(a,b){return""},$(o+" .ui.search").search({fullTextSearch:!0,filterRemoteData:!1,apiSettings:{url:app.urlPrefix+"api/chartdata/GetColumnMembers",cache:!1,method:"post",beforeSend:function(a){var c=m();return a.data={chartId:b.chartId,chartInPageId:b.ChartInPageId,userVariable:c.userVariable,userControlFilter:c.userControlFilter,otherFilters:c.otherFilters,query:a.urlData.query,chartInfo:$("#divChart").data("chartInfo"),top:10},a},onResponse:function(a){return a.fields=a.fields.map(function(a){return{title:a.Key.entitize(),Value:a.Value.entitize()}}),console.log(a.fields),{results:a.fields}},dataType:"json"},onSelect:function(a,b){c(a.Value)}}),$(o+" input").on("keydown",function(a){var b=$(this).val();if(13===a.keyCode)return void c(b)});var e=[];e=a.GloablFilterDefaultValue?a.GloablFilterDefaultValue.Value:null!=a.DefaultValue&&a.DefaultValue.length>0&&b.chartProp.info.variableId!=-1?a.DefaultValue:b.chartProp.info.variableDefault&&b.chartProp.info.variableDefault.values&&"NONE"==b.chartProp.info.variableDefaultType&&b.chartProp.info.variableId!=-1?b.chartProp.info.variableDefault.values:["",""],$(o+" input").val(e[0])}function f(){if(!b.editMode){var c=app.chartCommons.userFilter.getFilterValue(b.ChartInPageId);_.isNull(c)||(a.GloablFilterDefaultValue=a.GloablFilterDefaultValue||{},a.GloablFilterDefaultValue.ValuesType=c.variableType,a.GloablFilterDefaultValue.Value=3==+c.variableType?c.defaultValue:c.values)}}function g(){var d=a.fields.map(function(a){return a.Value}),e=a.fields.map(function(a){return a.Key});e.length!=d.length&&$("#"+b.id).append(app.chartCommons.getError(a));for(var f=[],g=0;g<d.length;g++)f.push({Caption:e[g],Uniquename:d[g],IsChecked:!1});var h=function(c){var d=c.filter(function(a){return a.IsChecked}).map(function(a){return a.Uniquename}),e=c.filter(function(a){return a.IsChecked}).map(function(a){return a.Caption}),f='<div style="text-align: right; font-size: 0.9em; margin-top: 7px;"><b>انتخاب‌ها:</b><ul>'+e.map(function(a){return'<li style="  float:right; display:inline; width:33%;">'+a+"</li>"}).join("")+"</ul></div>";$(o+" .selected-item").html(filterXSS(f)),a.DefaultValue=d,b.editMode?$(o).trigger("default-value",[!0,d,0]):n({Id:b.chartProp.info.variableId||-1,Values:d})};if(select='<div class="container-fluid temporal" style="margin: 15px 0px 10px;"><div class="row"><a  class=" btn btn-primary pointer filter-member btn-block"> '+(b.chartProp.info.label||"انتخاب")+' <span class="glyphicon glyphicon-list-alt"></span></a></div><div class="row selected-item col-sm-12"></div></div>',$(o).append(select),$(o+" .filter-member").on("click",function(){app.helper.filterMemberDialog(f,h)}),null!=a.DefaultValue&&a.DefaultValue.length>0){f.filter(function(b){return a.DefaultValue.indexOf(b.Uniquename)!=-1}).forEach(function(a,b){a.IsChecked=!0});var i='<div style="text-align: right; font-size: 0.9em; margin-top: 7px;"><b>انتخاب‌ها:</b><ul>'+f.filter(function(a){return a.IsChecked}).map(function(a){return'<li style="  float:right; display:inline; width:33%;">'+a.Caption+"</li>"}).join("")+"</ul></div>";$(o+" .selected-item").html(filterXSS(i))}else if(b.chartProp.info.variableDefault&&b.chartProp.info.variableDefault.values){var j=b.chartProp.info.variableDefault.values;f.filter(function(a){return j.indexOf(a.Uniquename)!=-1}).forEach(function(a,b){a.IsChecked=!0});var i='<div style="text-align: right; font-size: 0.9em; margin-top: 7px;"><b>انتخاب‌ها:</b><ul>'+f.filter(function(a){return a.IsChecked}).map(function(a){return'<li style="  float:right; display:inline; width:33%;">'+a.Caption+"</li>"}).join("")+"</ul></div>";$(o+" .selected-item").html(filterXSS(i))}if(b.editMode){$(o).find("select");$(o).trigger("default-value",[!1,[f[0].UniqueName],0])}c&&h(f)}function h(c){function d(a){var b=1e3*moment(a,q).unix();return b<0&&(b=1e3*moment().unix()),b}function e(a){var b;return b="miladi"!==l?new persianDate(a).format(k):moment.unix(a/1e3).format(k),depersian(b)}function f(a,c,d,e,f){if((!c||d&&e)&&(c||d)&&(b.editMode||!(c&&u==d&&v==e||!c&&u==d))){u=d,v=e;var g=c?[d,e]:[d,b.chartProp.info.dateOp];if(b.input.DefaultValue=g,!b.editMode&&f){var h={Id:b.chartProp.info.variableId||-1,Values:g,VariableType:c?2:4};n(h)}else{$(o).find("select");$(o).trigger("default-value",[!0,g,c?2:4])}$(o).data("user-value",g)}}var g='<div class="ui form temporal"><div class=" field"><div class="ui input">                        <input autocomplete="off" type="text" id=""  class="form-control from" placeholder="تاریخ" /><input id="from-value" type="hidden"/>                      </div></div></div>';c&&(g='<div class="ui grid temporal form-content" ><div class="row">                        <div class="five wide column ui input">                            <input autocomplete="off" type="text" class="datepicker form-control from" placeholder="تاریخ شروع" />                            <input id="from-value" type="hidden"/>                        </div>                        <div class="two wide column">تا</div>                        <div class="five wide column ui input">                            <input autocomplete="off" type="text" class="datepicker form-control to" placeholder="تاریخ پایان"/>                            <input id="to-value" type="hidden"/>                        </div>                      </div></div>'),g=$(g),$(o).append(g);var h,i,j=b.chartProp.info.dateFormatShow.replace(/y/g,"YY").replace(/m/g,"M").replace(/d/g,"D"),k=b.chartProp.info.dateFormatValue.replace(/y/g,"YY").replace(/m/g,"M").replace(/d/g,"D"),l=b.chartProp.info.calendarType,m=function(a){var b=+a.view.$container.css("left").replace("px",""),c=$(window).width(),d=$(a.view.rendered).width(),e=10,f=Math.min(c-d-e,b);a.view.$container.css("left",f)};if(c)p=$(o+" .from"),p.change(function(a){var b=$(a.target).val();b=depersian(b),h.setDate(d(b));var j=e(i.getState().selected.unixDate);f(g,c,b,j,!0)}),h=p.pDatepicker({autoClose:!0,format:j,dayPicker:{enabled:!b.chartProp.info.disableDaySelect},toolbox:{calendarSwitch:{enabled:!1}},calendarType:"miladi"===l?"gregorian":"persian",initialValue:!1,onSelect:function(a){if(i&&i.options&&i.options.minDate!=a){var b=i.getState().selected.unixDate;i.options={minDate:a},i.setDate(b)}f(g,c,e(a),e(b),!0)},onShow:m}),p=$(o+" .to"),p.change(function(a){var b=$(a.target).val();b=depersian(b),i.setDate(d(b));var j=e(h.getState().selected.unixDate);f(g,c,j,b,!0)}),i=p.pDatepicker({autoClose:!0,format:j,initialValue:!1,dayPicker:{enabled:!b.chartProp.info.disableDaySelect},calendarType:"miladi"===l?"gregorian":"persian",toolbox:{calendarSwitch:{enabled:!1}},onSelect:function(a){if(h&&h.options&&h.options.maxDate!=a){var b=h.getState().selected.unixDate;h.options={maxDate:a},h.setDate(b)}f(g,c,e(b),e(a),!0)},onShow:m});else{var p=$(o+" .from");h=p.pDatepicker({autoClose:!0,format:j,dayPicker:{enabled:!b.chartProp.info.disableDaySelect},toolbox:{calendarSwitch:{enabled:!1}},calendarType:"miladi"===l?"gregorian":"persian",initialValue:!1,onSelect:function(a){f(g,c,e(a),null,!0)},onShow:m})}var q=k;"miladi"!==l&&(q=k.replace("YYYY","jYYYY").replace("YY","jYY").replace("MM","jMM").replace("DD","jDD"));var r=b.chartProp.info.dateLimit||{enable:!1};if(r.enable){if(!r.useDataMinMax&&r.minDate){var s=1e3*moment(r.minDate,q).unix();h.options={minDate:s},i.options={minDate:s}}if(!r.useDataMinMax&&r.maxDate){var t=1e3*moment(r.maxDate,q).unix();h.options={maxDate:t},i&&(i.options={maxDate:t})}if(r.useDataMinMax&&a.dataMinMax){var s=1e3*moment(a.dataMinMax.min,q).unix(),t=1e3*moment(a.dataMinMax.max,q).unix();h.options={minDate:s,maxDate:t},i&&(i.options={minDate:s,maxDate:t})}}var u,v,w=[];a.GloablFilterDefaultValue?w=a.GloablFilterDefaultValue.Value:null!=a.DefaultValue&&a.DefaultValue.length>0&&b.chartProp.info.variableId!=-1&&(w=a.DefaultValue),w=w.map(function(a){return a.replace(/\[[^\]]+\]/,"")}),w&&w.length>0&&w[0]&&h.setDate(d(w[0])),u=w[0],c&&(w&&w.length>1&&w[1]&&i.setDate(d(w[1])),v=w[1]),w&&w.length>0&&w[0]&&f(g,c,w[0],w[1],!1)}function i(c){function d(a,c){if(a||c.push(b.chartProp.info.sliderRange),b.input.DefaultValue=c,b.editMode)$(o).trigger("default-value",[!0,c,1]);else{var d={Id:b.chartProp.info.variableId||-1,Values:c,VariableType:1};$(o).data("user-value",c),n(d)}}var e=a.fields.map(function(a){return a.Value}),f=(a.fields.map(function(a){return a.Key}),""!=b.chartProp.info.sliderMax&&"undefined"!=typeof b.chartProp.info.sliderMax?+b.chartProp.info.sliderMax:d3.max(e,function(a){return a?+a.replace(/\[[^\]]+\]/,""):a})||100),g=""!=b.chartProp.info.sliderMin&&"undefined"!=typeof b.chartProp.info.sliderMin?+b.chartProp.info.sliderMin:d3.min(e,function(a){return a?+a.replace(/\[[^\]]+\]/,""):a})||0;a.dataMinMax&&(f=+a.dataMinMax.max,g=+a.dataMinMax.min);var h='<div class="temporal" style="padding-left: 15px; padding-right: 15px; padding-top:5px">                        <div class="slider" style="position: relative;"></div>                        <div class="slider-value ltr" style="margin-top:5px"> </div>                        <input id="from-value" type="hidden"/>                      </div>';h=$(h),$(o).append(h),b.chartProp.info.sliderFont=_.extend({bold:!1,color:"#333333",italic:!1,fontSize:"10px",fontName:"IRANSans",formatString:b.chartProp.info.sliderFormat||",.2f",formatStringCustom:",.2f"},b.chartProp.info.sliderFont);var i="min-max"==b.chartProp.info.sliderRange,j=function(a){var c=b.chartProp.info.sliderFont.formatString||",.2f";return Array.isArray(a)?'<div class="inline">'+persian(d3.format(c)(a[0]),q)+'</div> <div class="inline"> تا </div> <div class="inline">'+persian(d3.format(c)(a[1]),q)+"</div>":persian(d3.format(c)(a),q)};h.find(".slider").slider({range:!!i||b.chartProp.info.sliderRange,min:g,max:f,slide:function(a,b){h.find(".slider-value").html(j(i?b.values:b.value))},stop:function(a,b){d(i,i?b.values:[b.value])}}),h.find(".slider .ui-slider-range").css("background-color","#ddd"),h.find(".slider.ui-widget-content").css("box-shadow","none"),h.find(".slider .ui-slider-handle").css("background-color","#337ab7");var k=[];k=a.GloablFilterDefaultValue?a.GloablFilterDefaultValue.Value:null!=a.DefaultValue&&a.DefaultValue.length>0&&b.chartProp.info.variableId!=-1?a.DefaultValue:[g,f],k=k.map(function(a){return+a.toString().replace(/\[[^\]]+\]/,"")||0}),1==k.length&&k.splice(0,0,0),k[1]<k[0]&&(k[1]=k[0]),h.find(".slider-value").html(j(i?k:k[0])),h.find(".slider-value").css({"font-size":b.chartProp.info.sliderFont.fontSize,"font-family":b.chartProp.info.sliderFont.fontName,color:b.chartProp.info.sliderFont.color,"font-weight":b.chartProp.info.sliderFont.bold?"bold":"normal","font-style":b.chartProp.info.sliderFont.italic?"italic":"normal"}),i?h.find(".slider").slider("values",k):h.find(".slider").slider("value",k[0]),$(o).data("user-value",k)}function j(){var a=b.chartProp.info.label||"فیلتر کردن",c='<div class="temporal inline" style="display: flex;flex: 1 1 auto;height: 100%; justify-content: center;align-items: center;">                            <div style="display: flex;flex: 1 1 auto;">                                <div class="ui fluid '+b.chartProp.info.buttonClass+' button">'+a+"</div>                            </div>                      </div>";$(o).append(c),$(o).find(".button").on("click",function(){var a=_.map(app.chartCommons.userFilter.filters,"chartInPageId"),c=[];$(".bar-chart").each(function(b){var d=$(this).data("settings");_.indexOf(a,d.ChartInPageId)!==-1&&(c=c.concat(d.input.RefreshDatasource||[]))}),app.moderation.dashboadpage.refreshRelatedDatasources(c,[+b.ChartInPageId],b.chartProp.info.groups),app.filterBox.refresh()})}function k(){function c(){return _.map(a.DefaultValue,function(a){var c=_.find(b.chartProp.info.measures,{UniqueName:a})||{};return c.Name||a})}function d(){var a=$(o+" .ui.dropdown").dropdown("get value");return _.isArray(a)||(a=[a]),a=_.filter(a,null),a=_.map(a,function(a){return a?a.deentitize():a})}function e(){p||(clearTimeout(m),m=setTimeout(function(){var a=d();i(_.map(a,function(a){return a.deentitize()}))},200))}var f='<div class="dp-container temporal inline"><select class="temporal ui fluid search selection dropdown" >';f+='  <option value="">'+b.chartProp.info.label+"</option>";for(var g=0;g<b.chartProp.info.measures.length;g++)f+='  <option value="'+b.chartProp.info.measures[g].Name+'">'+b.chartProp.info.measures[g].Name+"</option>";f+="</select></div>",console.log(f),$(o).append(f),$(o).css("display","flex"),$(o).find(".dp-container").css("width","100%");var h=$(o).find("select");h.on("change",function(){app.lang.setLang({selector:o})});var i=null,j=function(){};i=b.editMode?function(b){a.DefaultValue=b,j(),$(o).trigger("default-value",[!0,a.DefaultValue,7,c()])}:function(d){return!b.chartProp.info.disableClear||d&&d.length?(a.DefaultValue=d,j(),void n({Id:b.chartProp.info.variableId||-1,Values:a.DefaultValue,VariableType:7,valuesCaption:c()})):void $(o+" .ui.dropdown").dropdown("set selected",a.DefaultValue)};var k=[];if(a.GloablFilterDefaultValue&&b.chartProp.info.variableId==-1?k=a.GloablFilterDefaultValue.Value:null!=a.DefaultValue&&a.DefaultValue.length>0&&(k=a.DefaultValue),k=[].concat(k),!k||!k.length){var l=_.find(app.chartCommons.userFilter.filters,{datasourceId:a.DataSourceId,dimensionName:a.dimensionName});l&&(k=l.values)}a.DefaultValue=k;var m,p=!0;$(o+" .ui.dropdown").dropdown({onChange:function(){console.log("#### cvv"),e()}}),$(o+" .ui.dropdown .dropdown.icon").on("click",function(a){a.preventDefault(),a.stopPropagation(),$(o+" .ui.dropdown input").focus()}),$(o+" .ui.dropdown").dropdown("set selected",k),p=!1}function l(c){function d(){var a=$(o+" .ui.dropdown").dropdown("get value");return _.isArray(a)||(a=[a]),a=_.filter(a,null),a=_.map(a,function(a){return a?a.deentitize():a})}function e(){u||(clearTimeout(t),t=setTimeout(function(){var a=d();p(_.map(a,function(a){return a.deentitize()}))},200))}var f=b.chartProp.info.comboStyle;(app.mobile||b.editMode)&&(f="default");var g=a.fields.map(function(a){return a.Value?a.Value.entitize():""}),h=a.fields.map(function(a){return a.Key?a.Key.entitize(!0):""});h.length!=g.length&&$("#"+b.id).append(app.chartCommons.getError(a));var i='<div class="dp-container temporal inline"><select class="temporal ui fluid '+(c?"multiple":"")+' search selection dropdown" '+(c?"multiple":"")+" >";i+='  <option value="">'+b.chartProp.info.label+"</option>";for(var j=0;j<h.length;j++)i+='  <option value="'+g[j]+'">'+h[j]+"</option>";if(i+="</select></div>",$(o).append(i),$(o).css("display","flex"),b.chartProp.info.showExclude){var k='<div class="temporal ui checkbox" style="display:inline-block; width:70px;text-align: left;padding: 10px;"><input type="checkbox" id="exclude"/><label> نقیض </label></div>';$(o).append(k),$(o).find(".checkbox").checkbox(),$(o).find(".dp-container").css({width:"calc(100% - 70px)"})}else $(o).find(".dp-container").css("width","100%");var l=$(o).find("select");l.on("change",function(){app.lang.setLang({selector:o})});var p=null,q=function(){var d=$(o).find("#exclude").is(":checked");if(!c){var e=b.chartProp.info.dateOp;if(d){var f={eq:"nteq",nteq:"eq",gr:"eqls",eqgr:"ls",ls:"eqgr",eqls:"gr"};e=f[e]}a.DefaultValue.push(e)}d&&c&&a.DefaultValue.push("exclude=1")};p=b.editMode?function(b){a.DefaultValue=b,q(),$(o).trigger("default-value",[!0,a.DefaultValue,c?0:4])}:function(d){return!b.chartProp.info.disableClear||d&&d.length?(a.DefaultValue=d,q(),void n({Id:b.chartProp.info.variableId||-1,Values:a.DefaultValue,VariableType:c?0:4})):void $(o+" .ui.dropdown").dropdown("set selected",a.DefaultValue)};var r=[];if(a.GloablFilterDefaultValue&&b.chartProp.info.variableId==-1?r=a.GloablFilterDefaultValue.Value:null!=a.DefaultValue&&a.DefaultValue.length>0&&(r=a.DefaultValue),!c&&r.length>1&&(r=[].concat(r),r.splice(r.length-1,1)),!r||!r.length){var s=_.find(app.chartCommons.userFilter.filters,{datasourceId:a.DataSourceId,dimensionName:a.dimensionName});s&&(r=s.values)}a.DefaultValue=r;var t,u=!0;$(o+" #exclude").on("change",function(){var a=d();a.length&&e()}),$(o+" .ui.dropdown").dropdown({onChange:function(a,b,d){c||e()},onRemove:function(a,b,c){e()},onAdd:function(a,b,c){e()},apiSettings:{url:app.urlPrefix+"api/chartdata/GetColumnMembers",cache:!1,method:"post",beforeSend:function(a){var c=m();return a.data={chartId:b.chartId,chartInPageId:b.ChartInPageId,userVariable:c.userVariable,userControlFilter:c.userControlFilter,otherFilters:c.otherFilters,query:a.urlData.query,chartInfo:$("#divChart").data("chartInfo")},a},onResponse:function(a){a.fields=a.fields.map(function(a){return{Key:a.Key?a.Key.entitize(!0):"",Value:a.Value?a.Value.entitize():""}});var b=$(o+" .ui.dropdown").dropdown("get value");return b||(b=[]),_.isArray(b)||(b=[b]),b=_.map(b,function(a){return a?a.deentitize():a}),a.fields=a.fields.filter(function(a){return b.indexOf(a.Value)===-1}),a},dataType:"json"},message:{noResults:app.lang.translate("No results found.")},fields:{remoteValues:"fields",name:"Key",value:"Value"},saveRemoteData:!1,forceSelection:!1}),$(o+" .ui.dropdown .dropdown.icon").on("click",function(a){a.preventDefault(),a.stopPropagation(),$(o+" .ui.dropdown input").focus()}),$(o+" .ui.dropdown").dropdown("set selected",r),u=!1}function m(){var a=_.filter(app.chartCommons.drillDown.filters,function(a){if(!b.input||!b.input.RefreshDatasource)return!1;var c=b.input.RefreshDatasource.indexOf(a.datasourceId)!=-1;return c&&a.chartInPageId!=b.ChartInPageId}),c=$.extend([],_.filter(app.chartCommons.userFilter.filters,function(a){if(!b.input||!b.input.RefreshDatasource)return!1;var c=b.input.RefreshDatasource.indexOf(a.datasourceId)!=-1;return c}));_.remove(c,{chartInPageId:b.ChartInPageId});var d=[];return app.mobileMode||(d=JSON.parse(localStorage.getItem("userVariable"))||[]),{otherFilters:app.chartCommons.filterGroup(a,b),userControlFilter:app.chartCommons.filterGroup(c,b),userVariable:d}}function n(c){var d=app.mobileMode?proxy.ajax:$.ajax;if(c.disableClear=b.chartProp.info.disableClear,!b.editMode&&!r){var e=function(a,e,f){var g={id:c.Id,values:c.Values,valuesCaption:c.valuesCaption,variableType:c.VariableType,dimensionName:e,chartInPageId:b.ChartInPageId,datasourceId:a,disableClear:c.disableClear,keepFilter:f};app.chartCommons.userFilter.setFilter(g);var g=app.mobileMode&&2===app.mobileScriptVersion?g:JSON.stringify(g);d({url:app.urlPrefix+"api/chartdata/logUserControl",type:"POST",dataType:"json",contentType:"application/json",data:g,cache:!1,success:function(){}})};a.datasources&&"text"!==b.chartProp.info.type&&a.datasources&&"kpi-change"!==b.chartProp.info.type?_.each(a.datasources,function(b,c){e(b.datasourceId,b.name,a.CurrentDimKeepFilter[c])}):e(a.DataSourceId,a.dimensionName)}if(+c.Id==-1){var f=!1;if($(".bar-chart").each(function(a){var b=$(this).data("settings");if(!b.type.isCustom&&7===+b.type.id&&"apply-button"===b.chartProp.info.type)return f=!0,!1}),console.log("hasApplyButton",f),f)return;return app.moderation.dashboadpage.refreshRelatedDatasources(a.RefreshDatasource,[+b.ChartInPageId],b.chartProp.info.groups),void app.filterBox.refresh()}c.dimensionName=a.dimensionName,c.datasourceId=a.DataSourceId,c.chartId=a.chartId;var g=app.mobileMode&&2===app.mobileScriptVersion?c:JSON.stringify(c);console.log("### user control ajaxCall init *****************"),d({type:"POST",url:app.urlPrefix+"api/GlobalVariable/SetValueForUser",dataType:"json",contentType:"application/json;charset=utf-8",traditional:!0,data:g,success:function(c){c.result?"undefined"!=typeof b.chartProp.info.variableId&&b.chartProp.info.variableId!=-1?(app.moderation.dashboadpage.refreshRelatedDatasources(a.RefreshDatasource,[+b.ChartInPageId],b.chartProp.info.groups),$(".bar-chart").each(function(){var a=$(this).data("settings");"undefined"!=typeof a.input.GlobalVariables&&a.input.GlobalVariables.indexOf(b.chartProp.info.variableId)!=-1&&(a.titlebar.showProgress(!0),$(this).charts(a.type,"refreshWithData",a,{refreshRelatedDatasources:!1}))})):app.mobileMode?app.mobile.filterChanged(c.RefreshDatasource,[+b.ChartInPageId]):(app.moderation.dashboadpage.refreshRelatedDatasources(c.RefreshDatasource,[+b.ChartInPageId],b.chartProp.info.groups),app.filterBox.refresh()):alert(c.Message)},error:function(a){app.mobileMode&&app.mobile.showToastMessage(a)}})}app.dashboardLayoutVersion=app.dashboardLayoutVersion||2,b.input=a,app.chartCommons.calculateFields(a.series,b.calculatedFields);var o="#"+b.id,p=$(o).width();b.width=p;var q="undefined"==typeof a.lang||0==+a.lang;d.isProgress,d.showProgress,d.title;if("NONE"==b.chartProp.info.variableDefaultFunction&&(b.chartProp.info.variableDefaultType="NONE"),!a.result&&"datepicker"!=b.chartProp.info.type&&"datepicker-range"!=b.chartProp.info.type)return void $("#"+b.id).append(app.chartCommons.getError(a));var r=b.chartProp.info.variableId!=-1;switch(f(),b.chartProp.info.type){case"combo":l();break;case"multi":l(!0);break;case"kpi-change":k();break;case"apply-button":j();break;case"datepicker":h(!1);break;case"datepicker-range":h(!0);break;case"multi-filter":g();break;case"slider":i();break;case"text":e()}$(o).trigger("heightChange")};var chartUtils=chartUtils||{};chartUtils.enableNewCharts=!0,chartUtils.chartsId={funnel:{type:20,extendTypes:[{type:42,name:"Funnel",iconLink:app.urlPrefix+"images/chart-icons/funnel.png"}]},fitLine:{type:21,extendTypes:[{type:43,name:"عدد همراه با سابقه",iconLink:app.urlPrefix+"images/chart-icons/trend-line.png"}]},image:{type:22,extendTypes:[{type:44,name:"تصویر",iconLink:app.urlPrefix+"images/chart-icons/image.png"}]}},chartUtils.getFormatString=function(a,b){return b||(b=",.2f"),a?(a.formatString||(a.formatString=b),"custom"!==a.formatString?a.formatString:a.formatStringCustom):b},chartUtils.renderLegendForBar=function(a,b,c,d,e,f,g){var h=d3.select(a.selector+" .lgb");h.empty()&&(h=d3.select(a.selector).append("div").attr("class","lgb"));var i=h.append("div").attr("class","legend-bar temporal");
return i.breadcrumb(c.levels,a,d,!0),!!chartUtils.checkEmtryResult(c,i)||(g||(a.chartProp.general.showLegends||"undefined"==typeof a.chartProp.general.showLegends)&&i.legend({display:!1,width:e,font:a.chartProp.general.legendFont,position:a.chartProp.general.legendPosition,selector:a.selector,data:b.filter(function(a,b){return!a.sadafInfo.prop.hidden}).map(function(a){return{label:a.sadafInfo.prop.name||a.label,color:a.sadafInfo.prop.color,key:a.sadafInfo.seriesLabel,sIndex:a.sadafInfo.index}}),click:function(b){if(!a.editMode){var c=$(a.selector+" canvas").data("chart");Chart.defaults.global.legend.onClick.call(c.legend,d3.event,{datasetIndex:b.sIndex,text:b.key})}}},f),void(g||a.chartProp.indicatorLegendShow&&i.legend({order:"horizental",width:e,font:a.chartProp.indicatorLegendFont,position:a.chartProp.general.legendPosition,selector:selector,data:_.map(a.chartProp.indicator,function(b,d){var e=_.find(b.thenRow,{operand:"1"}),f=e?e.secondFieldColor:"#eeeeee",g=b.title||app.chartCommons.indicator.ifToString(b.ifRow,c.series.labels,c.seriesLablesCaptions,a);return{label:g,color:f}})},f)))},chartUtils.onClickCalback=function(a,b,c,d){d=d||{};var e=d.isProgress||function(){},f=d.showProgress||function(){};if(a.chartProp.globalvariable&&a.chartProp.globalvariable.length>0&&!a.editMode&&(app.globalVariableHelper.updateGlobalVariables([b.CurrentDimName],[c.value],a.chartProp.globalvariable),$(selector+" .gd.selected-item").attr("class",$(this).attr("class").replace("selected-item","")),$(selector+" .circle.selected-item").attr("class",$(this).attr("class").replace("selected-item","")),$(this).attr("class",$(this).attr("class")+" selected-item")),!c.canDrill){var g=a.chartProp.info.openDashboard&&a.chartProp.info.openDashboard.checked;return void(g&&!a.editMode&&app.chartCommons.openLink(a.chartProp.info.openDashboard,{ChartInPageId:a.ChartInPageId,DataSourceId:a.input.DataSourceId,dimensionName:a.input.dimensionName,value:c.values,refreshDatasource:a.input.RefreshDatasource}))}e()||(f(!0),app.chartCommons.drillDown.add(a.ChartInPageId,a.input.DataSourceId,a.input.CurrentDimName,c.values,a.input),a.parameters={selectedItem:c.values,chartId:a.chartId,ChartInPageId:a.ChartInPageId,notEditMode:!a.editMode},app.chartCommons.levelTypeUtils.getParam(a),$(a.selector).charts(a.type,"refreshWithData",a))},chartUtils.drillUp=function(a,b,c){var d=c.isProgress,e=c.showProgress;""!=b.levels&&(d()||(e(!0),app.chartCommons.drillDown.up(a.ChartInPageId),a.parameters={isUp:!0,chartId:a.chartId,ChartInPageId:a.ChartInPageId,notEditMode:!a.editMode},app.chartCommons.levelTypeUtils.getParam(a),$(a.selector).charts(a.type,"refreshWithData",a)))},chartUtils.checkEmtryResult=function(a,b){return(!a.matrix||0==a.matrix.length)&&(b.append("div").attr("class","temporal").style("font-size","0.8em").style("margin","15px").append("span").attr("class","translate").attr("data-trans-key","داده‌ای برای نمایش وجود ندارد").text("داده‌ای برای نمایش وجود ندارد"),!0)},chartUtils.getPattern=function(){return["#01B8AA","#374649","#FD625E","#F2C80F","#5F6B6D","#8AD4EB","#FE9666","#A66999","#3599B8","#DFBFBF"]},chartUtils.getColorArray=function(a,b){var c=chartUtils.getPattern();if(c.length<a.matrix.length)for(var d=c.length,e=0;e<a.matrix.length-d;e++)c.push(c[(e+d)%d]);var f=b.chartProp.general.dimColor=b.chartProp.general.dimColor||{};return f.enable?a.matrix.map(function(a){var b=f.data[a.captions.join("-")];return b=b||{color:"#efefef"},b.color}):_.take(c,a.matrix.length)},chartUtils.getData=function(a,b,c){function d(c,d){var e=void 0;if(b.chartProp.indicator&&b.chartProp.indicator.length){var f=a.series.data[c],g=a.series.labels,h=app.chartCommons.indicator.getIndicator(f,g,b.chartProp.indicator);_.isArray(h)&&h.length&&_.each(_.flatten(h),function(a){if("1"===a.operand&&a.firstField===d)return void(e=a.secondFieldColor)})}return e}var e=!1,f=!1;return _.map(a.series.labels,function(g,h){function i(a){_.isUndefined(a.color)&&(a.color=chartUtils.getPattern()[h%10]),_.isUndefined(a.borderColor)&&(a.borderColor=a.color);var b=a.fillOpacity||1;return Color(a.color).alpha(b).rgbaString()}"stack"===b.chartProp.general.stack&&(e=!0,f=!1),"stack100"===b.chartProp.general.stack&&(e=!1,f=!0),b.chartProp.series[g]=_.merge({},b.chartProp.series._default,b.chartProp.series[g]);var j=b.chartProp.series[g],k=_.extend({},j.showLabelFont);return{sadafInfo:{index:h,prop:j,seriesLabel:g},hidden:j.hidden,lineTension:"none"===j.lineMode?0:"default"===j.lineMode?.3:.44,backgroundColor:"line"===j.type?i(j):a.matrix.map(function(a,b){_.isUndefined(j.color)&&(j.color=chartUtils.getPattern()[h%10]),_.isUndefined(j.borderColor)&&(j.borderColor=j.color);var c=j.color,e=d(b,g);return e&&(c=e),c}),type:j.type,fill:j.fill,pointRadius:j.pointRadius,pointBackgroundColor:"white",borderColor:j.borderColor,borderWidth:j.borderWidth,spanGaps:j.spanGaps,steppedLine:"none"!==j.steppedLine&&j.steppedLine,borderDash:"simple"===j.borderDash?null:"dash"===j.borderDash?[5,5]:[5,10],label:j.label||g,data:_.map(a.series.data,function(a){return _.isNull(a[h])?null:+a[h]}),datalabels:{display:!!j.showLabel&&(!j.showLabelAuto||"auto"),offset:0,align:k.position||"end",textAlign:k.align||"center",anchor:k.anchor||"end",rotation:k.rotate||0,formatter:function(a,b){var c=chartUtils.getFormatString(k);f&&(a=b.chart.tooltip._data.calculatedData[b.datasetIndex][b.dataIndex]);var d=persian(d3.format(c)(a),!0);return d},color:k.color||"#000",font:{family:k.fontName,size:(k.fontSize||"").replace("px",""),weight:k.bold?"bold":"normal",style:k.italic?"italic":"normal"},listeners:{click:function(d){console.log("label click ",d),labelClick=!0,chartUtils.onClickCalback(b,a,a.matrix[d.dataIndex],c)}}}}})},chartUtils.format=function(a,b){return null===b?"-":_.isNumber(b)?d3.format(a)(b):b},chartUtils.getFontFromProp=function(a){return a=_.merge({bold:!1,color:"#333333",align:"right",italic:!1,fontSize:"12px",fontName:"IRANSans",formatString:",.2f",formatStringCustom:",.2f",rotate:0,anchor:"end",position:"end"},a),a.fontSize=a.fontSize.replace("px",""),a.bold=a.bold?"bold":"normal",a.italic=a.italic?"italic":"normal",{fontColor:a.color,fontFamily:a.fontName,fontSize:+a.fontSize,fontStyle:a.italic+" "+a.bold}},chartUtils.handleStackLabel=function(a,b){if(a.chartProp.general.stackSumLabel){var c=_.map(b.data.datasets[0].data,function(a,c){return d3.sum(b.data.datasets,function(a){return a.data[c]})}),d=_.extend({},a.chartProp.general.stackSumLabelFont);b.data.datasets.push({sadafInfo:{prop:{}},label:"مجموع",data:_.map(c,function(){return 0}),backgroundColor:"rgba(24,91,62,0)",datalabels:{display:!0,offset:0,align:d.position||"end",textAlign:d.align||"center",anchor:d.anchor||"end",rotation:d.rotate||0,formatter:function(a,b){var e=chartUtils.getFormatString(d);a=c[b.dataIndex];var f=persian(d3.format(e)(a),!0);return f},color:d.color||"#000",font:{family:d.fontName,size:(d.fontSize||"").replace("px",""),weight:d.bold?"bold":"normal",style:d.italic?"italic":"normal"}}});var e=b.options.tooltips.callbacks.label;b.options.tooltips.callbacks.label=function(a,f){if(a.datasetIndex===b.data.datasets.length-1){var g=c[a.index],h=chartUtils.getFormatString(d);return persian("مجموع\t\t\t\t\t"+chartUtils.format(h,g),!0)}return e.call(this,a,f)}}},chartUtils.getChartOption=function(a,b,c,d){function e(c){chartUtils.onClickCalback(b,a,a.matrix[c],d)}var f=!1,g=!1;"stack"===b.chartProp.general.stack&&(f=!0,g=!1),"stack100"===b.chartProp.general.stack&&(f=!1,g=!0);var h=!1,i=_.map(a.matrix,function(a){return a.captions.join(", ")}),j=d3.max(c,function(a){return a.sadafInfo.prop.hidden?-(1/0):d3.max(a.data)}),k=d3.min(c,function(a){return a.sadafInfo.prop.hidden?1/0:d3.min(a.data)});k>0&&(k=0);var l=b.chartProp.general.xfontLabel;b.chartProp.general.xfontLabelDynamic&&(l=a.CurrentDimName.join(""));var m=_.merge({fontSize:"12",fontName:"IRANSans"},b.chartProp.general.tooltipFont);m.fontSize=+m.fontSize.replace("px","");var n=chartUtils.getFontFromProp(b.chartProp.general.legendFont);return{animation:{duration:2e3},type:"line",data:{labels:i,datasets:c},options:{scales:{xAxes:[{offset:!0,stacked:f,scaleLabel:_.merge({display:!!l,labelString:l},chartUtils.getFontFromProp(b.chartProp.general.xfontLabelFont)),ticks:_.merge({callback:function(a,c,d){var e=a,f=b.chartProp.general.xMaxLen||40,g=a;if(b.chartProp.general.xMultiline){for(var h=f;h<g.length;h+=f){var c=g.indexOf(" ",h);c!=-1&&(g=g.substr(0,c)+"\n"+g.substr(c+1))}g=g.split(/\n/)}else e=a?(a+"").substring(0,f):a,g=persian(e,!0);return g}},chartUtils.getFontFromProp(b.chartProp.general.xfont)),gridLines:{display:!!b.chartProp.general.linesVert}}],yAxes:[{stacked:f,gridLines:{display:!!b.chartProp.general.linesHoriz,borderDash:[8,4]},scaleLabel:_.merge({display:!!b.chartProp.general.yfontLabel,labelString:b.chartProp.general.yfontLabel},chartUtils.getFontFromProp(b.chartProp.general.yfontLabelFont)),ticks:_.merge({beginAtZero:!0,suggestedMax:1.11*j,suggestedMin:1.11*k,callback:function(a,c,d){var e=chartUtils.getFormatString(b.chartProp.general.yfont);return persian(d3.format(e)(a),!0)}},chartUtils.getFontFromProp(b.chartProp.general.yfont))}]},elements:{rectangle:{borderWidth:0}},layout:{padding:{top:15}},responsive:!1,plugins:{stacked100:{enable:g,replaceTooltipLabel:!0}},tooltips:{mode:"index",position:"nearest",intersect:!1,bodyFontSize:m.fontSize,titleFontSize:1.1*m.fontSize,bodyFontFamily:m.fontName,bodyFontStyle:m.bold?"bold":"normal",bodyAlign:m.align,titleAlign:"center",bodySpacing:Math.max(2,m.fontSize-10),callbacks:{title:function(a,b){return b.labels[a[0].index]},label:function(a,c){var d=c.datasets.filter(function(a,b){return!a.sadafInfo.prop.hidden}),e=this._options.getValueCallback||function(a){return a},f=this._options.getLabelCallback||function(a){return a},g=this._options.showPercentage,h=a.datasetIndex!==d.length-1;"all"!==b.chartProp.general.tooltipMode&&(h=!0);var i=chartUtils.getFormatString(c.datasets[a.datasetIndex].sadafInfo.prop.tooltipFont);if(h){var j=c.datasets[a.datasetIndex].data[a.index],k=c.datasets[a.datasetIndex].label;j=e(j),k=f(k);var l="";if(g){var m=1*j/d3.sum(c.datasets[a.datasetIndex].data);l="\t\t\t\t\t"+d3.format(".0%")(m)}return _.isArray(j)?j:persian(""+k+"\t\t\t\t\t"+chartUtils.format(i,j)+l,!0)}return c.datasets.filter(function(b,c){return b.sadafInfo.prop.hidden||c===a.datasetIndex}).map(function(b){var c=chartUtils.getFormatString(b.sadafInfo.prop.tooltipFont),d=b.data[a.index];d=e(d);var h="";if(g){var i=1*d/d3.sum(b.data);h="\t\t\t\t\t"+d3.format(".0%")(i)}var j=f(b.label);return persian(j+" "+chartUtils.format(c,d)+h)})},labelColor:function(a,b){var c=b.data.datasets[a.datasetIndex];return{borderColor:c.sadafInfo.prop.borderColor,backgroundColor:c.sadafInfo.prop.color}}}},legend:{display:!1,position:"right",align:"start",labels:_.merge({boxWidth:10},n),usePointStyle:!0,onClick:function(a,c){var d=c.datasetIndex,e=this.chart;b.editMode?$(b.selector).trigger("legendClick",[e.data.datasets[d].label,d,{key:e.data.datasets[d].label}]):Chart.defaults.global.legend.onClick.call(this,a,c)}},title:{display:!1,text:""},onClick:function(c){var f=this.getElementAtEvent(c);if(!_.isArray(f)||!f.length)return h||chartUtils.drillUp(b,a,d),void(h=!1);var g=f[0];e(g._index)},onHover:function(c){var d=this.getElementAtEvent(c);if(!_.isArray(d)||!d.length)return void $(b.selector).css("cursor","default");var e=d[0];a.matrix[e._index].canDrill&&$(b.selector).css("cursor","pointer")}}}},chartUtils.getChartSettings=function(){return{hasGeneralSettings:!0,general:[{key:"stack",title:"پشته",type:"select","default":"none",entries:[{name:"بدون پشته",value:"none"},{name:"پشته",value:"stack"},{name:"پشته درصدی",value:"stack100"}]},{key:"stackSumLabel",title:"نمایش عدد مجموع روی نمودار",type:"checkbox","default":!1,"if":{key:"stack",value:"stack"}},{key:"stackSumLabelFont",title:"فونت برچسب‌ها","if":{key:"stack",value:"stack"},type:"font","default":{fontSize:"13px",formatString:"A",align:"center"},config:{rotate:!0,anchor:!0,position:!0}},{key:"linesHoriz",title:"نمایش خطوط افقی",type:"checkbox","default":!0},{key:"linesVert",title:"نمایش خطوط عمودی",type:"checkbox","default":!1},{key:"customFont",title:"فونت و برچسب‌های محورها",type:"checkbox","default":!1},{title:"فونت و برچسب‌های محورها",type:"section",key:"axes-section","if":{key:"customFont",value:!0},items:[{key:"xfont",title:"فونت محور افقی",type:"font","default":{fontSize:"12px",formatString:"A"}},{key:"xfontLabel",title:"برچسب محور افقی",type:"text","default":""},{key:"xfontLabelDynamic",title:"استفاده از نام بُعد جاری",type:"checkbox","default":!1},{key:"xfontLabelFont",title:"فونت برچسب محور افقی",type:"font","default":{fontSize:"14px",formatString:"A"}},{key:"xMaxLen",title:"حداکثر تعداد کاراکتر برچسب‌ها",type:"number","default":40},{key:"xMultiline",title:"چند خطی شدن برچسب‌های محور افقی",type:"checkbox","default":!1},{key:"yfont",title:"فونت محور عمودی",type:"font","default":{fontSize:"12px",formatString:"A"}},{key:"yfontLabel",title:"برچسب محور عمودی",type:"text","default":""},{key:"yfontLabelFont",title:"فونت برچسب محور عمودی",type:"font","default":{fontSize:"14px",formatString:"A"}}]},{key:"showLegends",title:"نمایش راهنمای رنگ",type:"checkbox","default":!0},{key:"legendFont",title:"فونت راهنمای رنگ",type:"font","if":{key:"showLegends",value:!0},"default":{fontSize:"13px"},config:{color:!0,format:!1,align:!1}},{key:"legendPosition",title:"مکان راهنمای رنگ","if":{key:"showLegends",value:!0},type:"position","default":"top left"},{key:"tooltipMode",title:"نوع tooltip",type:"select","default":"visible",entries:[{name:"شاخص‌های پیدا",value:"visible"},{name:"تمام شاخص‌ها",value:"all"}]},{key:"tooltipFont",title:"فونت tooltip",type:"font","default":{fontSize:"14px",formatString:",.1f"},config:{format:!1,color:!1}},{key:"dimColor",title:"رنگ دلخواه",type:"dim-color","default":{}}],series:[{key:"label",title:"برچسب",type:"text"},{key:"color",title:"رنگ",type:"color"},{key:"type",title:"نوع",type:"select","default":"bar",entries:[{name:"میله‌ای",value:"bar"},{name:"خطی",value:"line"}]},{title:"تنظیمات خط",type:"section",key:"line-config","if":{key:"type",value:"line"},items:[{key:"fill",title:"پر کردن زیر خط",type:"checkbox","default":!0},{key:"fillOpacity",title:"شفافیت محدوده زیر نمودار",type:"number","default":.1,desc:"مقدار باید بین ۰ و ۱ باشد"},{key:"borderDash",title:"نوع خط",type:"select","default":"simple",entries:[{name:"ساده",value:"simple"},{name:"راه راه",value:"dash"},{name:"راه راه بلند",value:"long-dash"}]},{key:"spanGaps",title:"عدم نمایش مقادیر خالی",type:"checkbox","default":!1},{key:"steppedLine",title:"خط پله‌ای",type:"select","default":"none",entries:[{name:"غیرفعال",value:"none"},{name:"قبل",value:"before"},{name:"وسط",value:"middle"},{name:"بعد",value:"after"}]},{key:"lineMode",title:"نوع رسم خط",type:"select","default":"default",entries:[{name:"ساده",value:"none"},{name:"منحنی ۱",value:"default"},{name:"منحنی ۲",value:"monotone"}]},{key:"pointRadius",title:"شعاع دایره‌های روی خط",type:"number","default":3}]},{key:"borderWidth",title:"قطر خط",type:"number","default":3},{key:"borderColor",title:"رنگ خط",type:"color"},{key:"hidden",title:"مخفی کردن",type:"checkbox"},{key:"tooltipFont",title:"فرمت مقدار",type:"font","default":{formatString:",.0f"},config:{size:!1,font:!1,color:!1,align:!1,bold:!1}},{key:"showLabel",title:"نمایش مقادیر روی نمودار",type:"checkbox"},{key:"showLabel-section",title:"نمایش مقادیر روی نمودار",type:"section","if":{key:"showLabel",value:!0},items:[{key:"showLabelAuto",title:"عدم نمایش در صورت روی هم افتادن برچسب",type:"checkbox","default":!0},{key:"showLabelFont",title:"فونت برچسب‌ها",type:"font","default":{fontSize:"13px",formatString:",.0f",align:"center"},config:{rotate:!0,anchor:!0,position:!0}}]}]}},chartUtils.handlePieSettings=function(a){_.remove(a.series,{key:"type"}),_.remove(a.series,{key:"color"}),_.remove(a.general,{key:"stack"}),_.remove(a.general,{key:"axes-section"}),_.remove(a.general,{key:"customFont"}),_.remove(a.general,{key:"linesVert"}),_.find(a.general,{key:"legendPosition"})["default"]="center right",_.find(a.general,{key:"legendPosition"})["if"]={key:"showLegends",value:"legend"},_.find(a.series,{key:"borderColor"})["default"]="white",a.general.push({key:"cutoutPercentage",title:"شعاع محدوده خالی",type:"number","default":50}),a.general.push({key:"showPercentage",title:"نمایش درصد در tooltip",type:"checkbox","default":!0}),_.find(a.series,{key:"showLabel-section"}).items=_.find(a.series,{key:"showLabel-section"}).items.concat([{key:"showLegends",type:"select",title:"نوع نمایش راهنما","default":"legend",entries:[{name:"راهنمای کنار",value:"legend"},{name:"برچسب روی نمودار",value:"out-label"}]},{title:"نمایش درصد روی برچسب",key:"showPercentageInLegend",type:"checkbox","default":!0,"if":{key:"showLegends",value:"out-label"}},{title:"نمایش مقدار روی برچسب",key:"showValueInLegend",type:"checkbox","default":!1,"if":{key:"showLegends",value:"out-label"}},{key:"padding","if":{key:"showLegends",value:"out-label"},title:"فضای خالی اطراف نمودار",type:"number","default":60}])},function(){if(chartUtils.enableNewCharts){var a={type:12,expandedChartType:[{name:"میله‌ای",type:33,iconLink:app.urlPrefix+"images/chart-icons/bar.png"},{name:"خطی",type:40,iconLink:app.urlPrefix+"images/chart-icons/line.png"}],category:"ChartJs",config:{needDim:!1,needMeasure:!0,needServerData:!0},changeSeriesPropertyBaseOnExpandedType:function(a,c){_.find(b.series,{key:"type"})["default"]=33===c?"bar":"line",_.find(b.series,{key:"borderWidth"})["default"]=33===c?0:2,_.forOwn(a.series,function(b,d){a.series[d].type=33===c?"bar":"line",a.series[d].borderWidth=33===c?0:2})},draw:function(a,b,c,d){var e=b.selector;$(b.selector).addClass("canvas-chart");var f=!0,g=$(b.selector).width(),h=chartUtils.getData(a,b);if(!chartUtils.renderLegendForBar(b,h,a,d,g,f)){var i=0,j=$(b.selector+" .legend-bar").height(),k=$(b.selector).height()+i-j,l=chartUtils.getChartOption(a,b,h,d),m=b.chartProp.general.useScroll,n=+b.chartProp.general.xfont.fontSize.replace("px",""),o=4*g;if(o=a.matrix.length*n*+b.chartProp.general.scrollLableRate,o<g&&(m=!1),m){0!=b.chartProp.general.xRotate&&(l.options.scales.xAxes[0].ticks.maxRotation=b.chartProp.general.xRotate,l.options.scales.xAxes[0].ticks.minRotation=b.chartProp.general.xRotate),l.options.scales.xAxes[0].afterFit=function(a){a.height<b.chartProp.general.minXheight&&(a.height=b.chartProp.general.minXheight)};var p=$('<div class="temporal" style="position:relative;"></div>');$(b.selector).append(p),p.append('<div class="scl-container" style="width:'+g+'px; overflow-x:auto"><canvas class="temporal canvas"  width="'+o+'" height="'+k+'" style="margin-top:-'+i+'px"></canvas></div>'),p.find(".scl-container").scrollLeft(-1*o);var q=_.debounce(function(){var a=p.find(".scl-container").scrollLeft();console.log("### scroll",a,o),a>-1*o+g+20?$(e+" #axis-Test").fadeIn():$(e+" #axis-Test").fadeOut()},200);p.find(".scl-container").on("scroll",function(){q()}),p.append('<canvas style="position:absolute; left:0; top:0;" id="axis-Test" height="'+k+'" width="10"></canvas>');var r=!1;l.options.animation={onComplete:function(){if(!r){var a=window.devicePixelRatio,b=this.chart,c=b.chart.canvas,d=b.scales["y-axis-0"].width-10,f=b.scales["y-axis-0"].height+b.scales["y-axis-0"].top+10,g=$(e+" #axis-Test").get(0).getContext("2d");g.scale(a,a),g.canvas.width=d*a,g.canvas.height=f*a,g.canvas.style.width=d+"px",g.canvas.style.height=f+"px",g.drawImage(c,0,0,d*a,f*a,0,0,d*a,f*a);c.getContext("2d");r=!0}},onProgress:function(){if(r===!0){var a=this.chart;a.scales["y-axis-0"].width,a.scales["y-axis-0"].height+a.scales["y-axis-0"].top+10,a.chart.canvas.getContext("2d")}}}}else $(b.selector).append('<canvas class="temporal canvas"  width="'+g+'" height="'+k+'" style="margin-top:-'+i+'px"></canvas>');var s=$(b.selector+" canvas").get(0).getContext("2d");Chart.defaults.global.defaultFontFamily="IRANSans";_.each(h,function(a,b){if(a.sadafInfo.prop.extraAxe){a.yAxisID="id_"+b;var c=_.merge({id:"id_"+b},l.options.scales.yAxes[0]),d=d3.max(a.data),e=d3.min(a.data);c.position="right",c.gridLines.drawOnChartArea=!1,c.scaleLabel=_.merge({display:!!a.sadafInfo.prop.yfontLabel,labelString:a.sadafInfo.prop.yfontLabel},chartUtils.getFontFromProp(a.sadafInfo.prop.yfontLabelFont)),c.ticks=_.merge({beginAtZero:!0,suggestedMax:1.11*d,suggestedMin:1.11*e,callback:function(b,c,d){var e=chartUtils.getFormatString(a.sadafInfo.prop.yfont);return persian(d3.format(e)(b),!0)}},chartUtils.getFontFromProp(a.sadafInfo.prop.yfont)),l.options.scales.yAxes.push(c)}}),l.type="bar",chartUtils.handleStackLabel(b,l);var t=new Chart(s,l);$(b.selector+" canvas").data("chart",t)}}},b=chartUtils.getChartSettings();_.find(b.series,{key:"borderWidth"})["default"]=0,_.find(b.series,{key:"color"}).onchange=function(a,b,c){b.borderColor=a},b.series.push({title:"ایجاد محور Y مجزا",type:"checkbox",key:"extraAxe","default":!1}),b.series.push({key:"axeSection",title:"فونت محور عمودی",type:"section","if":{key:"extraAxe",value:!0},items:[{key:"yfont",title:"فونت محور عمودی",type:"font","default":{fontSize:"12px",formatString:"A"},config:{align:!1}},{key:"yfontLabel",title:"برچسب محور عمودی",type:"text","default":""},{key:"yfontLabelFont",title:"فونت برچسب محور عمودی",type:"font","default":{fontSize:"14px",formatString:"A"},config:{format:!1,align:!1}}]}),b.general.push({title:"استفاده از اسکرول",type:"checkbox",key:"useScroll","default":!1}),b.general.push({title:"ضریب اندازه برچسب محور افقی",type:"number",key:"scrollLableRate","default":2.5,"if":{key:"useScroll",value:!0}}),b.general.push({title:"حداقل ارتفاع محور افقی",type:"number",key:"minXheight","default":120,"if":{key:"useScroll",value:!0}}),b.general.push({title:"زاویه برچسب‌ها",type:"number",desc:"برای حالت خودکار از مقدار ۰ استفاده کنید",key:"xRotate","default":90,"if":{key:"useScroll",value:!0}}),a.settings=b,a.getSettings=function(){return b},app=app||{},app.charts=app.charts||{},app.charts.list=app.charts.list||[],app.charts.list.push(a)}}(),function(){if(chartUtils.enableNewCharts){var a={type:17,expandedChartType:[{name:"حبابی",type:38,iconLink:app.urlPrefix+"images/chart-icons/bubble.png"}],category:"ChartJs",config:{needDim:!1,needMeasure:!0,needServerData:!0},changeSeriesPropertyBaseOnExpandedType:function(a,b){},draw:function(a,b,c,d){b.selector;$(b.selector).addClass("canvas-chart");var e=!0,f=$(b.selector).width(),g=chartUtils.getData(a,b);if(!chartUtils.renderLegendForBar(b,g,a,d,f,e,!0)){if(a.series.labels.length<3)return void $(b.selector).append('<div class="temporal "style="margin:40px">حداقل باید سه شاخص  برای ساخت نمودار وجود داشته باشد. x - y - volume </div>');var h=0,i=$(b.selector+" .legend-bar").height(),j=$(b.selector).height()+h-i;$(b.selector).append('<canvas class="temporal canvas"  width="'+f+'" height="'+j+'" style="margin-top:-'+h+'px"></canvas>');var k=$(b.selector+" canvas").get(0).getContext("2d");Chart.defaults.global.defaultFontFamily="IRANSans";var l=chartUtils.getChartOption(a,b,g,d);g[0].data=g[0].data.map(function(a,b){return{x:g[0].data[b],y:g[1].data[b],r:g[2].data[b],xLabel:g[0].label,yLabel:g[1].label,rLabel:g[2].label}}),delete g[0].type,l.data={datasets:[g[0]],labels:l.data.labels},_.each(g,function(a){a.pointRadius=a.sadafInfo.prop.pointRadius}),l.type="bubble";var m=d3.max(g[0].data,function(a){return a.y});l.options.tooltips.getValueCallback=function(a){return[a.xLabel+": "+a.x,a.yLabel+": "+a.y,a.rLabel+": "+a.r]},l.options.tooltips.mode="nearest",l.options.tooltips.getLabelCallback=function(a){return""},l.options.scales.yAxes[0].ticks.suggestedMax=1.11*m,l.options.scales.xAxes[0].ticks.callback=function(a,c,d){var e=chartUtils.getFormatString(b.chartProp.general.xfont);return persian(d3.format(e)(a),!0)};chart=new Chart(k,l),$(b.selector+" canvas").data("chart",chart)}}},b=chartUtils.getChartSettings();_.find(b.series,{key:"borderWidth"})["default"]=0,a.settings=b,app=app||{},app.charts=app.charts||{},app.charts.list=app.charts.list||[],app.charts.list.push(a)}}(),function(){var a={type:11,expandedChartType:[{name:"قطره آب",type:32,iconLink:app.urlPrefix+"images/chart-icons/drop.png"}],category:"",config:{needDim:!0,needMeasure:!0,needServerData:!0},changeSeriesPropertyBaseOnExpandedType:function(a,b){},draw:function(a,b,c,d){function e(){return{minValue:0,maxValue:100,circleThickness:.05,circleFillGap:.05,circleColor:"#178BCA",waveHeight:.05,waveCount:1,waveRiseTime:1e3,waveAnimateTime:18e3,waveRise:!0,waveHeightScaling:!0,waveAnimate:!0,waveColor:"#178BCA",waveOffset:0,textVertPosition:.5,textSize:1,valueCountUp:!0,displayPercent:!0,textColor:"#045681",waveTextColor:"#A4DBf8"}}function f(a,c,d){function f(a){return persian(d3.format(L.formatString)(a))}function g(){O.attr("transform","translate("+H(O.attr("T"))+",0)"),O.transition().duration(d.waveAnimateTime*(1-O.attr("T"))).ease(d3.easeLinear).attr("transform","translate("+H(1)+",0)").attr("T",1).on("end",function(){O.attr("T",0),g(d.waveAnimateTime)})}function h(){this.update=function(a){var b=parseFloat(a).toFixed(2),c=function(a){return Math.round(a)};parseFloat(b)!=parseFloat(c(b))&&(c=function(a){return parseFloat(a).toFixed(1)}),parseFloat(b)!=parseFloat(c(b))&&(c=function(a){return parseFloat(a).toFixed(2)});var e=function(){var b=d3.interpolate(this.textContent,parseFloat(a).toFixed(2));return function(a){this.textContent=c(b(a))+q}};Q.transition().duration(d.waveRiseTime).tween("text",e),text2.transition().duration(d.waveRiseTime).tween("text",e);var f,h=Math.max(d.minValue,Math.min(d.maxValue,a))/d.maxValue,j=u*i(100*h),k=d3.scaleLinear().range([t+2*u+j,t-j]).domain([0,1]),l=k(h),m=d3.scaleLinear().range([0,y]).domain([0,1]),n=d3.scaleLinear().range([0,j]).domain([0,1]);f=d.waveHeightScaling?d3.svg.area().x(function(a){return m(a.x)}).y0(function(a){return n(Math.sin(2*Math.PI*d.waveOffset*-1+2*Math.PI*(1-d.waveCount)+2*a.y*Math.PI))}).y1(function(a){return 2*u+j}):M;var o=d.waveAnimate?H(1):0;O.transition().duration(0).transition().duration(d.waveAnimate?d.waveAnimateTime*(1-O.attr("T")):d.waveRiseTime).ease(d3.easeLinear).attr("d",f).attr("transform","translate("+o+",0)").attr("T","1").each("end",function(){d.waveAnimate&&(O.attr("transform","translate("+H(0)+",0)"),g(d.waveAnimateTime))}),N.transition().duration(d.waveRiseTime).attr("transform","translate("+S+","+l+")")}}null==d&&(d=e());var i,j=d3.select("#"+a),k=Math.min(parseInt(j.style("width")),parseInt(j.style("height")))/2,l=parseInt(j.style("width"))/2-k,m=parseInt(j.style("height"))/2-k,n=Math.max(d.minValue,Math.min(d.maxValue,c))/d.maxValue;i=d.waveHeightScaling?d3.scaleLinear().range([0,d.waveHeight,0]).domain([0,50,100]):d3.scaleLinear().range([d.waveHeight,d.waveHeight]).domain([0,100]);var o=d.textSize*k/2,p=parseFloat(c).toFixed(2),q=(d.valueCountUp?d.minValue:p,d.displayPercent?"%":""),r=d.circleThickness*k,s=d.circleFillGap*k,t=r+s,u=k-t,v=u*i(100*n),w=2*u/d.waveCount,x=1+d.waveCount,y=w*x,z=function(a){return Math.round(a)};parseFloat(p)!=parseFloat(z(p))&&(z=function(a){return parseFloat(a).toFixed(1)}),parseFloat(p)!=parseFloat(z(p))&&(z=function(a){return parseFloat(a).toFixed(2)});for(var A=[],B=0;B<=40*x;B++)A.push({x:B/(40*x),y:B/40});var C=d3.scaleLinear().range([0,2*Math.PI]).domain([0,1]),D=d3.scaleLinear().range([0,k]).domain([0,k]),E=d3.scaleLinear().range([0,y]).domain([0,1]),F=d3.scaleLinear().range([0,v]).domain([0,1]),G=d3.scaleLinear().range([t+2*u+v,t-v]).domain([0,1]),H=d3.scaleLinear().range([0,y-2*u]).domain([0,1]),I=d3.scaleLinear().range([t+2*u,t+.7*o]).domain([0,1]),J=j.append("g").attr("transform","translate("+l+","+m+")"),K=d3.arc().startAngle(C(0)).endAngle(C(1)).outerRadius(D(k)).innerRadius(D(k-r));J.append("path").attr("d",K).style("fill",d.circleColor).attr("transform","translate("+k+","+k+")");var L=_.merge({bold:!1,color:"#333333",italic:!1,fontSize:o+"px",fontName:"IRANSans",formatString:",.2f"},b.chartProp.general.format),M=d3.area().x(function(a){return E(a.x)}).y0(function(a){return F(Math.sin(2*Math.PI*d.waveOffset*-1+2*Math.PI*(1-d.waveCount)+2*a.y*Math.PI))}).y1(function(a){return 2*u+v}),N=J.append("defs").append("clipPath").attr("id","clipWave"+a),O=N.append("path").datum(A).attr("d",M).attr("T",0),P=J.append("g").attr("clip-path","url(#clipWave"+a+")");P.append("circle").attr("cx",k).attr("cy",k).attr("r",u).style("fill",d.waveColor);var Q=J.append("text").text(f(0)).attr("class","liquidFillGaugeText").attr("text-anchor","middle").attr("font-size",o+"px").style("fill",d.textColor).style("fill",L.color).style("font-family",L.fontName).style("font-weight",L.bold?"bold":"normal").style("font-style",L.italic?"italic":"normal").attr("transform","translate("+k+","+I(d.textVertPosition)+")");if(d.valueCountUp){var R=function(){var a=d3.interpolate(depersian(this.textContent),p);return function(b){this.textContent=f(a(b))}};Q.transition().duration(d.waveRiseTime).tween("text",R)}var S=t+2*u-y;return d.waveRise?N.attr("transform","translate("+S+","+G(0)+")").transition().duration(d.waveRiseTime).attr("transform","translate("+S+","+G(n)+")").on("start",function(){O.attr("transform","translate(1,0)")}):N.attr("transform","translate("+S+","+G(n)+")"),d.waveAnimate&&g(),new h}var g=e();g.circleColor=b.chartProp.general.circleColor,g.textColor=b.chartProp.general.textColor,g.waveTextColor=b.chartProp.general.waveColor,g.waveColor=b.chartProp.general.waveColor,g.circleThickness=b.chartProp.general.circleThickness,g.circleFillGap=+b.chartProp.general.circleFillGap,g.textVertPosition=1-+b.chartProp.general.circleFillGap,g.waveAnimateTime=2e3,g.waveHeight=.3,g.waveCount=1,g.minValue=b.chartProp.general.min,g.maxValue=b.chartProp.general.max;var h=b.id+"-svg";d3.select(b.selector).append("svg").attr("class","temporal").attr("id",h).attr("height",$(b.selector).height()).attr("width",$(b.selector).width());f(h,+a.series.data[0][0],g)}};a.settings={general:[{key:"waveColor",title:"رنگ دایره داخلی",type:"color","default":"rgba(33, 150, 243, 0.7)"},{key:"textColor",title:"رنگ نوشته",type:"color","default":"#424242"},{key:"circleColor",title:"رنگ دایره خارجی",type:"color","default":"#2196f3"},{key:"circleThickness",title:"قطر دایره",type:"number","default":.1},{key:"circleFillGap",title:"اندازه شکاف",type:"number","default":.2},{key:"format",title:"قالب نمایش",type:"font","default":{}},{key:"min",title:"کمترین مقدار",type:"number","default":0},{key:"max",title:"بیشترین مقدار",type:"number","default":100}]},app=app||{},app.charts=app.charts||{},app.charts.list=app.charts.list||[],app.charts.list.push(a)}(),function(){if(chartUtils.enableNewCharts){var a={type:chartUtils.chartsId.fitLine.type,expandedChartType:chartUtils.chartsId.fitLine.extendTypes,category:"ChartJs",config:{needDim:!1,needMeasure:!0,needServerData:!0},changeSeriesPropertyBaseOnExpandedType:function(a,b){},draw:function(a,b,c,d){b.selector;$(b.selector).addClass("canvas-chart");var e=!0,f=$(b.selector).width(),g=chartUtils.getData(a,b),h=!1;_.each(g,function(a){h=h||"bar"===a.type,a.fill=!!a.sadafInfo.prop.fill&&"start"});var i=0;if("sum"===b.chartProp.general.agg&&(i=d3.sum(g[0].data)),"avg"===b.chartProp.general.agg&&(i=d3.sum(g[0].data)/g[0].data.length),"var"===b.chartProp.general.agg&&(i=d3.variance(g[0].data)),"last"===b.chartProp.general.agg&&(i=_.last(g[0].data)),"first"===b.chartProp.general.agg&&(i=_.first(g[0].data)),!chartUtils.renderLegendForBar(b,g,a,d,f,e)){var j=null,k=null;"last"===b.chartProp.general.agg&&(j=g[0].data.length-2<0?0:g[0].data[g[0].data.length-2],k=i/j-1,0===j&&(k=0));var l=0,m=$(b.selector+" .legend-bar").height(),n=$(b.selector).height()+l-m,o=function(a,b){var c=a.chartProp.general.titleFont,d=persian(d3.format(c.formatString)(b),e),f="",g="";if(null!==k){var h=a.chartProp.general.percentColor,i=k>0&&"1"===h||k<0&&"2"===h,l=i?"up":"down",m=i?"green":"red";f='<span class="ltr" style="display:inline-block; color: '+m+'"><i style="" class="chevron '+l+" "+m+' icon"/> '+persian(d3.format(".0%")(k))+"</span>",g='<span class="ltr" style="display:inline-block;">'+persian(d3.format(c.formatString)(j))+"</span>";
}var n=a.chartProp.general.text.replace("@value",'<span class="ltr inline" title="'+d+'">'+d+"</span>").replace("@percent",'<span class="ltr inline" title="">'+f+"</span>").replace("@last",'<span class="ltr inline" title="">'+g+"</span>");return n};$(b.selector).append('<div class="float-digit temporal" style="display:none;z-index:0;position: absolute;left: 0;right: 0;margin: auto;margin-top:14px;">'+o(b,i)+"</div >");var p="position:absolute;background-color:rgba(0,0,0,0);margin:-14px; top:29px; border-radius:4px;",q=f+28;b.editMode&&(p="position:absolute;background-color:rgba(0,0,0,0);margin:0px; top:0px; border-radius:4px;",q=f),$(b.selector).append('<canvas class="temporal canvas"  width="'+q+'" height="'+n+'" style="'+p+'"></canvas>'),$(b.selector+" .float-digit").transition("scale","1000ms");var r=$(b.selector+" canvas").get(0).getContext("2d");Chart.defaults.global.defaultFontFamily="IRANSans";var s=chartUtils.getChartOption(a,b,g,d);_.each(g,function(a){a.pointRadius=a.sadafInfo.prop.pointRadius}),s.type="bar",s.options.scales.xAxes[0].display=!1,s.options.scales.yAxes[0].display=!1,0!==s.options.scales.yAxes[0].ticks.suggestedMin||h||(s.options.scales.yAxes[0].ticks.suggestedMin=-10),s.options.scales.xAxes[0].offset=!1,s.options.layout.padding.top=Math.min(.35*n,100),s.options.tooltips.position="nearest",chart=new Chart(r,s),$(b.selector+" canvas").data("chart",chart),r.canvas.style.backgroundColor="rgba(0,0,0,0)"}}},b=chartUtils.getChartSettings();b.general.push({title:"متن برچسب",type:"editor",key:"text","default":'<strong style="font-size: 38px;">@value</strong><p>@percent</p><p>@last</p>',desc:"@value: مقدار - @percent: درصد تغییرات - @last: آخرین مقدار"}),b.general.push({title:"فرمت",type:"font",key:"titleFont","default":{formatString:",.0f"},config:{size:!1,font:!1,color:!1,align:!1,bold:!1}}),b.general.push({title:"تابع محاسبه عدد ",type:"select",key:"agg","default":"last",entries:[{name:"last",value:"last"},{name:"first",value:"first"},{name:"sum",value:"sum"},{name:"avg",value:"avg"},{name:"var",value:"var"}]}),b.general.push({"if":{key:"agg",value:"last"},title:"رنگ درصد تغییرات",type:"select",key:"percentColor","default":"1",entries:[{name:"مقدار مثبت با رنگ سبز",value:"1"},{name:"مقدار منفی با رنگ سبز",value:"2"}]}),_.find(b.series,{key:"borderWidth"})["default"]=2,_.find(_.find(b.series,{key:"line-config"}).items,{key:"fill"})["default"]="start",_.find(_.find(b.series,{key:"line-config"}).items,{key:"fillOpacity"})["default"]=.2,_.find(_.find(b.series,{key:"line-config"}).items,{key:"pointRadius"})["default"]=0,_.find(b.series,{key:"type"})["default"]="line",_.find(b.series,{key:"color"}).onchange=function(a,b,c){b.borderColor=a},_.find(b.general,{key:"showLegends"})["default"]=!1,a.settings=b,app=app||{},app.charts=app.charts||{},app.charts.list=app.charts.list||[],app.charts.list.push(a)}}(),function(){if(chartUtils.enableNewCharts){var a={type:chartUtils.chartsId.funnel.type,expandedChartType:chartUtils.chartsId.funnel.extendTypes,category:"ChartJs",config:{needDim:!1,needMeasure:!0,needServerData:!0},changeSeriesPropertyBaseOnExpandedType:function(a,b){},draw:function(a,b,c,d){$(b.selector).addClass("canvas-chart");var e=!0,f=$(b.selector).width(),g=chartUtils.getData(a,b);if(!chartUtils.renderLegendForBar(b,g,a,d,f,e,!0)){_.each(g,function(c){c.backgroundColor=chartUtils.getColorArray(a,b),c.hoverBackgroundColor=chartUtils.getColorArray(a,b),c.datalabels={display:!0},delete c.datalabels,delete c.type});var h=0,i=$(b.selector+" .legend-bar").height(),j=$(b.selector).height()+h-i;$(b.selector).append('<canvas class="temporal canvas"  width="'+f+'" height="'+j+'" style="margin-top:-'+h+'px"></canvas>');var k=$(b.selector+" canvas").get(0).getContext("2d");Chart.defaults.global.defaultFontFamily="IRANSans";var l=chartUtils.getChartOption(a,b,g,d);l.type="funnel",l.options.tooltips.mode="nearest",l.options.tooltips.position="nearest",l.options.tooltips.intersect=!0,delete l.options.scales,delete l.options.tooltips,l.options.plugins.datalabels=!1,chart=new Chart(k,l),$(b.selector+" canvas").data("chart",chart)}}},b=chartUtils.getChartSettings();_.find(b.series,{key:"borderWidth"})["default"]=0,_.remove(b,{key:"type"}),a.settings=b,app=app||{},app.charts=app.charts||{},app.charts.list=app.charts.list||[],app.charts.list.push(a)}}(),function(){if(chartUtils.enableNewCharts){var a={type:14,expandedChartType:[{name:"میله‌ای افقی",type:35,iconLink:app.urlPrefix+"images/chart-icons/horizontal-bar.png"}],category:"ChartJs",config:{needDim:!1,needMeasure:!0,needServerData:!0},changeSeriesPropertyBaseOnExpandedType:function(a,b){},draw:function(a,b,c,d){$(b.selector).addClass("canvas-chart");var e=!0,f=$(b.selector).width(),g=chartUtils.getData(a,b);if(!chartUtils.renderLegendForBar(b,g,a,d,f,e)){var h=0,i=$(b.selector+" .legend-bar").height(),j=$(b.selector).height()+h-i;$(b.selector).append('<canvas class="temporal canvas"  width="'+f+'" height="'+j+'" style="margin-top:-'+h+'px"></canvas>');var k=$(b.selector+" canvas").get(0).getContext("2d");Chart.defaults.global.defaultFontFamily="IRANSans";var l=chartUtils.getChartOption(a,b,g,d);l.type="horizontalBar",_.each(g,function(a){delete a.type});var m=l.options.scales.xAxes;l.options.scales.xAxes=l.options.scales.yAxes,l.options.scales.yAxes=m,b.chartProp.general.paddingLeft&&(l.options.layout.padding.left=b.chartProp.general.paddingLeft),l.options.rtl=!0,chartUtils.handleStackLabel(b,l),chart=new Chart(k,l),$(b.selector+" canvas").data("chart",chart)}}},b=chartUtils.getChartSettings();_.find(b.series,{key:"borderWidth"})["default"]=0,b.general.push({key:"paddingLeft",title:"اندازه اضافه برای برچسب محور عمودی",desc:"در صورتی که برچسب‌های محور عمودی کامل نمایش داده نمی‌شود از این آپشن برای افزایش فضا استفاده کنید",type:"number","default":0}),a.settings=b,app=app||{},app.charts=app.charts||{},app.charts.list=app.charts.list||[],app.charts.list.push(a)}}(),function(){if(chartUtils.enableNewCharts){var a={type:chartUtils.chartsId.image.type,expandedChartType:chartUtils.chartsId.image.extendTypes,category:"ChartJs",config:{needDim:!1,needMeasure:!1,needServerData:!1},changeSeriesPropertyBaseOnExpandedType:function(a,b){},draw:function(a,b,c,d){if("cover"===b.chartProp.general.picSize){var e=$(b.selector).parent();$(b.selector).parent().find(".title").css("z-index",1),e.css("position","relative"),$(b.selector).css({position:"absolute",left:0,top:0,width:"100%",height:"100%","margin-top":0})}var f=b.chartProp.general.text,g="";b.chartProp.general.pic&&"image"===b.chartProp.general.pic.type&&(g='<div class="image" style="flex: 5 1 0;background-size:'+b.chartProp.general.picSize+" !important; background-position: center !important;background-repeat: no-repeat !important; background-repeat-x: no-repeat !important;background-repeat-y: no-repeat !important;background:url('"+app.urlPrefix+"api/upload/getPic/"+b.chartProp.general.pic.name+'\')"><ximg  src="'+app.urlPrefix+"api/upload/getPic/"+b.chartProp.general.pic.name+'"/></div>'),b.chartProp.general.pic&&"icon"===b.chartProp.general.pic.type&&(g='<i class="'+b.chartProp.general.pic.name+'"/>',f=f.replace("@icon",g),g="");var h="",i=f.replace(/(<.*?>|\s+)/gi,"");""!=i&&(h='<div class="" style="flex: 1 0 0; padding: '+b.chartProp.general.textPadding+'px; line-height:1.8">'+f+"</div>");var j='<div class="temporal image-chart"  style="display: flex;flex-direction: column;height: 100%;">'+g+h+"</div>";$(b.selector+" ").append(j)}},b={hasGeneralSettings:!0,general:[{key:"pic",title:"انتخاب عکس",type:"icon","default":{}},{key:"text",title:"متن",type:"editor","default":""},{key:"textPadding",title:"حاشیه متن",type:"number","default":14},{key:"picSize",title:"نوع نمایش عکس",type:"select","default":"contain",entries:[{name:"contain",value:"contain"},{name:"cover",value:"cover"}]}],series:[]};a.settings=b,a.getSettings=function(){return b},app=app||{},app.charts=app.charts||{},app.charts.list=app.charts.list||[],app.charts.list.push(a)}}(),function(){if(chartUtils.enableNewCharts){var a={type:18,expandedChartType:[{name:"Matrix",type:39,iconLink:app.urlPrefix+"images/chart-icons/matrix.png"}],category:"ChartJs",config:{needDim:!1,needMeasure:!0,needServerData:!0},changeSeriesPropertyBaseOnExpandedType:function(a,b){},draw:function(a,b,c,d){b.selector;$(b.selector).addClass("canvas-chart");var e=!0,f=$(b.selector).width(),g=chartUtils.getData(a,b);if(!chartUtils.renderLegendForBar(b,g,a,d,f,e,!0)){if(a.matrix[0].captions.length<2)return void $(b.selector).append('<div class="temporal "style="margin:40px">برای ساخت نمودار ماتریس باید دو قسمت ابعاد دو ستون در یک سطح قرار گرفته باشند</div>');var h=0,i=$(b.selector+" .legend-bar").height(),j=$(b.selector).height()+h-i;$(b.selector).append('<canvas class="temporal canvas"  width="'+f+'" height="'+j+'" style="margin-top:-'+h+'px"></canvas>');var k=$(b.selector+" canvas").get(0).getContext("2d");Chart.defaults.global.defaultFontFamily="IRANSans";var l=chartUtils.getChartOption(a,b,g,d);delete g[0].type,l.data={datasets:[g[0]],labels:l.data.labels},_.each(g,function(a){a.pointRadius=a.sadafInfo.prop.pointRadius}),l.type="matrix";d3.max(g[0].data,function(a){return a.y});l.options.tooltips.getValueCallback=function(a){return a.v},l.options.tooltips.mode="nearest",l.options.tooltips.position="nearest",l.options.tooltips.intersect=!0,l.options.tooltips.getLabelCallback=function(a){return""};var m=_.uniq(a.matrix.map(function(a,b){return a.captions[0]})),n=_.uniq(a.matrix.map(function(a,b){return a.captions[1]}));b.chartProp.general.xSort&&(m=m.sort()),b.chartProp.general.ySort&&(n=n.sort());var o=a.matrix.map(function(b,c){return{x:b.captions[0],y:b.captions[1],v:a.series.data[c][0]}});g=[g[0]];var p={data:o,datalabels:{formatter:function(a,b){var c=chartUtils.getFormatString(b.dataset.sadafInfo.prop.showLabelFont),d=persian(d3.format(c)(a.v),!0);return d}},backgroundColor:function(a){var b=a.dataset.data[a.dataIndex].v,c=d3.max(a.dataset.data,function(a){return+a.v}),d=d3.min(a.dataset.data,function(a){return+a.v}),e=(b-d)/(c-d)+.1;c===d&&(e=1),e>1&&(e=1);var f=e;return console.log("a",e),Color(a.dataset.sadafInfo.prop.color).alpha(f).rgbString()},width:function(a){var b=a.chart.chartArea;return(b.right-b.left)/(1*m.length)},height:function(a){var b=a.chart.chartArea;return(b.bottom-b.top)/(1*n.length)}};g[0]=_.merge(g[0],p),console.log(m,n,o),l.options.layout.padding.top=0,l.options.scales.xAxes[0].type="category",l.options.scales.xAxes[0].lables=m,l.options.scales.xAxes[0].offset=!0,l.options.scales.xAxes[0].ticks={display:!0},l.options.scales.xAxes[0]={type:"category",labels:m,ticks:{display:!0},offset:!0,gridLines:{display:!1}},l.options.scales.yAxes[0].type="category",l.options.scales.yAxes[0].lables=n,l.options.scales.yAxes[0].offset=!0,l.options.scales.yAxes[0].gridLines.display=!1,l.options.scales.yAxes[0].ticks={display:!0},l.options.scales.yAxes[0]={type:"category",weight:100,labels:n,offset:!0,ticks:{display:!0},gridLines:{display:!1}},l.data.datasets=g,b.chartProp.general.paddingLeft&&(l.options.layout.padding.left=b.chartProp.general.paddingLeft),chart=new Chart(k,l),$(b.selector+" canvas").data("chart",chart)}}},b=chartUtils.getChartSettings();_.find(b.series,{key:"borderWidth"})["default"]=1,_.find(_.find(b.series,{key:"showLabel-section"}).items,{key:"showLabelFont"})["default"]={fontSize:"13px",formatString:"A",align:"center",anchor:"center",position:"center"},_.remove(b.general,{key:"legendFont"}),_.remove(b.general,{key:"legendPosition"}),_.remove(b.general,{key:"stack"}),_.remove(b.general,{key:"linesHoriz"}),_.remove(b.general,{key:"linesVert"}),_.remove(b.general,{key:"customFont"}),_.remove(b.general,{key:"showLegends"}),_.remove(b.general,{key:"dimColor"}),_.remove(b.series,{key:"type"}),b.general.push({key:"paddingLeft",title:"اندازه اضافه برای برچسب محور عمودی",desc:"در صورتی که برچسب‌های محور عمودی کامل نمایش داده نمی‌شود از این آپشن برای افزایش فضا استفاده کنید",type:"number","default":0}),b.general.push({key:"xSort",title:"مرتب کردن محور افقی براساس حروف الفبا",type:"checkbox","default":!1}),b.general.push({key:"ySort",title:"مرتب کردن محور عمودی براساس حروف الفبا",type:"checkbox","default":!1}),a.settings=b,app=app||{},app.charts=app.charts||{},app.charts.list=app.charts.list||[],app.charts.list.push(a)}}(),function(){if(chartUtils.enableNewCharts){var a={type:13,expandedChartType:[{name:"دایره‌ای",type:34,iconLink:app.urlPrefix+"images/chart-icons/pie.png"}],category:"ChartJs",config:{needDim:!1,needMeasure:!0,needServerData:!0},changeSeriesPropertyBaseOnExpandedType:function(a,b){},draw:function(a,b,c,d){b.selector;$(b.selector).addClass("canvas-chart");var e=d3.select(b.selector+" .lgb");e.empty()&&(e=d3.select(b.selector).append("div").attr("class","lgb"));var f=e.append("div").attr("class","legend-bar temporal");if(f.breadcrumb(a.levels,b,d,!0),!chartUtils.checkEmtryResult(a,f)){var g=chartUtils.getData(a,b),h=0,i=$(b.selector).width(),j=$(b.selector+" .legend-bar").height(),k=$(b.selector).height()+h-j;$(b.selector).append('<canvas class="temporal canvas"  width="'+i+'" height="'+k+'" style="margin-top:-'+h+'px"></canvas>');var l=$(b.selector+" canvas").get(0).getContext("2d");Chart.defaults.global.defaultFontFamily="IRANSans";var m=chartUtils.getChartOption(a,b,g,d);_.each(g,function(c){delete c.type,c.backgroundColor=chartUtils.getColorArray(a,b),c.borderColor=a.matrix.map(function(a){return c.sadafInfo.prop.borderColor}),c.borderWidth=c.sadafInfo.prop.borderWidth;var d=(c.sadafInfo.prop.showLabelFont.fontSize||"12px").replace("px","");"out-label"===c.sadafInfo.prop.showLegends?(c.datalabels={display:!1},c.outlabels={text:function(a){var b="",d="";if(c.sadafInfo.prop.showPercentageInLegend&&(b=d3.format(".0%")(a.percent)+""),c.sadafInfo.prop.showValueInLegend){var e=chartUtils.getFormatString(c.sadafInfo.prop.showLabelFont,",.0f");d=d3.format(e)(a.dataset.data[a.dataIndex])+" "}return persian(a.labels[a.dataIndex]+" "+d+b,!0)},backgroundColor:"#00000000",color:c.sadafInfo.prop.showLabelFont.color||"#333",stretch:15,font:{resizable:!1,minSize:8,maxSize:+d,size:+d,family:c.sadafInfo.prop.showLabelFont.fontName}}):c.outlabels={display:!1}}),delete m.options.scales;var n=(b.chartProp.general.legendPosition||"center left").replace("center left","left start").replace("center right","right start").split(" "),o=n[0],p=(n[1]||"start").replace("right","end").replace("left","start");m.options.legend.position=o,m.options.legend.align=p,m.options.legend.display="legend"===b.chartProp.general.showLegends||b.chartProp.general.showLegends===!0,delete m.options.legend.onClick,delete m.options.tooltips.intersect,delete m.options.tooltips.index,m.options.tooltips.showPercentage=b.chartProp.general.showPercentage,m.options.tooltips.callbacks.title=function(a,b){return b.labels[a[0].index]},m.options.tooltips.callbacks.labelColor=function(a,b){var c=b.data.datasets[a.datasetIndex];return{borderColor:c.borderColor[a.index],backgroundColor:c.backgroundColor[a.index]}},m.type="pie";var q=!1,r=0;if(_.forOwn(b.chartProp.series,function(a,b){if("{All}"!==b&&"_default"!==b&&"out-label"===a.showLegends)return q=!0,r=a.padding,!1}),q){m.options.legend.display=!1;var s=r;m.options.layout.padding.bottom=s,m.options.layout.padding.top=s,m.options.layout.padding.left=s,m.options.layout.padding.right=s}else m.options.layout.padding.bottom=15,m.options.plugins.outlabels={display:!1};m.options.cutoutPercentage=b.chartProp.general.cutoutPercentage||50,chart=new Chart(l,m),$(b.selector+" canvas").data("chart",chart)}}},b=chartUtils.getChartSettings();chartUtils.handlePieSettings(b),_.remove(b.general,{key:"linesHoriz"}),a.settings=b,app=app||{},app.charts=app.charts||{},app.charts.list=app.charts.list||[],app.charts.list.push(a)}}(),function(){if(chartUtils.enableNewCharts){var a={type:16,expandedChartType:[{name:"Polar Area",type:37,iconLink:app.urlPrefix+"images/chart-icons/polar.png"}],category:"ChartJs",config:{needDim:!1,needMeasure:!0,needServerData:!0},changeSeriesPropertyBaseOnExpandedType:function(a,b){},draw:function(a,b,c,d){b.selector;$(b.selector).addClass("canvas-chart");var e=d3.select(b.selector+" .lgb");e.empty()&&(e=d3.select(b.selector).append("div").attr("class","lgb"));var f=e.append("div").attr("class","legend-bar temporal");if(f.breadcrumb(a.levels,b,d,!0),!chartUtils.checkEmtryResult(a,f)){var g=chartUtils.getData(a,b),h=0,i=$(b.selector).width(),j=$(b.selector+" .legend-bar").height(),k=$(b.selector).height()+h-j;$(b.selector).append('<canvas class="temporal canvas"  width="'+i+'" height="'+k+'" style="margin-top:-'+h+'px"></canvas>');var l=$(b.selector+" canvas").get(0).getContext("2d");Chart.defaults.global.defaultFontFamily="IRANSans";var m=chartUtils.getChartOption(a,b,g,d);_.each(g,function(c){delete c.type,c.backgroundColor=chartUtils.getColorArray(a,b),c.borderColor=a.matrix.map(function(a){return c.sadafInfo.prop.borderColor}),c.borderWidth=c.sadafInfo.prop.borderWidth,"out-label"==b.chartProp.general.showLegends?c.outlabels={text:function(a){var c="";if(b.chartProp.general.showPercentageInLegend){var d=a.dataset.data[a.dataIndex]/d3.sum(a.dataset.data);c=d3.format(".0%")(d)+""}return persian(a.labels[a.dataIndex]+" "+c,!0)},color:"white",stretch:15,font:{resizable:!0,minSize:12,maxSize:18}}:c.outlabels={display:!1}});var n=(b.chartProp.general.legendPosition||"center left").replace("center left","left start").replace("center right","right start").split(" "),o=n[0],p=(n[1]||"start").replace("right","end").replace("left","start");if(m.options.legend.position=o,m.options.legend.align=p,m.options.legend.display="legend"===b.chartProp.general.showLegends||b.chartProp.general.showLegends===!0,delete m.options.legend.onClick,delete m.options.tooltips.intersect,delete m.options.tooltips.index,m.options.tooltips.showPercentage=b.chartProp.general.showPercentage,m.options.tooltips.callbacks.title=function(a,b){return b.labels[a[0].index]},m.type="polarArea","out-label"==b.chartProp.general.showLegends){var q=60;m.options.layout.padding.bottom=q,m.options.layout.padding.top=q,m.options.layout.padding.left=q,m.options.layout.padding.right=q}else m.options.layout.padding.bottom=15,m.options.plugins.outlabels={display:!1};var r=m.options.scales;delete m.options.scales,m.options.scale={pointLabels:r.xAxes[0].ticks,ticks:r.yAxes[0].ticks,gridLines:r.yAxes[0].gridLines},chart=new Chart(l,m),$(b.selector+" canvas").data("chart",chart)}}},b=chartUtils.getChartSettings();chartUtils.handlePieSettings(b),a.settings=b,app=app||{},app.charts=app.charts||{},app.charts.list=app.charts.list||[],app.charts.list.push(a)}}(),function(){if(chartUtils.enableNewCharts){var a={type:15,expandedChartType:[{name:"رادار",type:36,iconLink:app.urlPrefix+"images/chart-icons/radar.png"}],category:"ChartJs",config:{needDim:!1,needMeasure:!0,needServerData:!0},changeSeriesPropertyBaseOnExpandedType:function(a,b){},draw:function(a,b,c,d){$(b.selector).addClass("canvas-chart");var e=!0,f=$(b.selector).width(),g=chartUtils.getData(a,b);if(!chartUtils.renderLegendForBar(b,g,a,d,f,e)){var h=0,i=$(b.selector+" .legend-bar").height(),j=$(b.selector).height()+h-i;$(b.selector).append('<canvas class="temporal canvas"  width="'+f+'" height="'+j+'" style="margin-top:-'+h+'px"></canvas>');var k=$(b.selector+" canvas").get(0).getContext("2d");Chart.defaults.global.defaultFontFamily="IRANSans";var l=chartUtils.getChartOption(a,b,g,d);l.type="radar",_.each(g,function(a){delete a.type;var b=a.sadafInfo.prop.fillOpacity||1,c=Color(a.sadafInfo.prop.color).alpha(b).rgbaString();a.backgroundColor=c,a.borderColor||(a.borderColor=a.sadafInfo.prop.color)});var m=l.options.scales;delete l.options.scales,l.options.scale={pointLabels:m.xAxes[0].ticks,ticks:m.yAxes[0].ticks,gridLines:m.yAxes[0].gridLines},l.options.tooltips.mode="nearest",chart=new Chart(k,l),$(b.selector+" canvas").data("chart",chart)}}},b=chartUtils.getChartSettings();_.remove(b.general,{key:"linesVert"}),_.remove(b.series,{key:"type"}),_.find(b.general,{key:"linesHoriz"}).title="نمایش خطوط دایره‌ای",_.find(b.series,{key:"line-config"})["if"]=void 0,_.find(b.series,{key:"borderWidth"})["default"]=2,_.find(_.find(b.series,{key:"line-config"}).items,{key:"fill"})["default"]=!0,_.find(_.find(b.series,{key:"line-config"}).items,{key:"fillOpacity"})["default"]=.1,_.find(b.series,{key:"color"}).onchange=function(a,b,c){b.borderColor=a},a.settings=b,app=app||{},app.charts=app.charts||{},app.charts.list=app.charts.list||[],app.charts.list.push(a)}}(),function(a,b){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?b(require("chart.js")):"function"==typeof define&&define.amd?define(["chart.js"],b):(a=a||self,b(a.Chart))}(void 0,function(a){"use strict";function b(a){for(var b=_toConsumableArray(a),c=[];b.length;){var d=b.pop();Array.isArray(d)?b.push.apply(b,_toConsumableArray(d)):c.push(d)}return c.reverse()}function c(a,b,c,d,e){var f,g,h,i,j=Object.create(null),k=Object.create(null),l=[];for(g=0,h=a.length;g<h;++g)i=a[g],d&&i[d]!==e||(f=i[b]||"",f in j||(j[f]=0,k[f]=[]),j[f]+=+i[c],k[f].push(i));return Object.keys(j).forEach(function(a){i={children:k[a]},i[c]=+j[a],i[b]=a,d&&(i[d]=e),l.push(i)}),l}function d(a){var b=_typeof(a);return"function"===b||"object"===b&&!!a}function e(a,b){var c,e,f=a.length;if(!f)return b;for(e=d(a[0]),b=e?b:"v",c=0,f=a.length;c<f;++c)e?a[c]._idx=c:a[c]={v:a[c],_idx:c};return b}function f(a,b){b?a.sort(function(a,c){return+c[b]-+a[b]}):a.sort(function(a,b){return+b-+a})}function g(a,b){var c,d,e;for(c=0,d=0,e=a.length;d<e;++d)c+=b?+a[d][b]:+a[d];return c}function h(a,b){return+(Math.round(a+"e+"+b)+"e-"+b)}function i(a,b,c,d){var e=a._normalized,f=b*e/c,g=Math.sqrt(e*f),h=e/g,i="_ix"===d?g:h,j="_ix"===d?h:g;return{d1:g,d2:h,w:i,h:j}}function j(a,b,c,d){var e={x:h(a.x+a._ix,4),y:h(a.y+a._iy,4),w:h(c.w,4),h:h(c.h,4),a:b._normalized,v:b.value,s:d,_data:b._data};return b.group&&(e.g=b.group,e.l=b.level,e.gs=b.groupSum),e}function k(a){return{min:a.min,max:a.max,sum:a.sum,nmin:a.nmin,nmax:a.nmax,nsum:a.nsum}}function l(a,b){var c=+b[a.key],d=c*a.ratio;return b._normalized=d,{min:x(a.min,c),max:y(a.max,c),sum:a.sum+c,nmin:x(a.nmin,d),nmax:y(a.nmax,d),nsum:a.nsum+d}}function m(a,b){Object.assign(a,b)}function n(a,b,c){a._arr.push(b),m(a,c)}function o(a,b,c){if(0===a.sum)return!0;var d=_slicedToArray(c,1),e=d[0],f=a.nsum*a.nsum,g=b.nsum*b.nsum,h=e*e,i=Math.max(h*a.nmax/f,f/(h*a.nmin)),j=Math.max(h*b.nmax/g,g/(h*b.nmin));return j<=i}function p(a,b,c,d,e,f){function g(a){return c?+k[a][c]:+k[a]}function h(a){return d&&k[a][d]}var i,j,k,l=v.sum(a,c),m=[],n=new w(b),p=new z("value",n.area/l),q=n.side,r=a.length;if(!r)return m;for(k=a.slice(),c=v.index(k,c),v.sort(k,c),i=0;i<r;++i)j={value:g(i),groupSum:f,_data:a[k[i]._idx]},d&&(j.level=e,j.group=h(i)),j=p.pushIf(j,o,q),j&&(m.push(n.map(p)),q=n.side,p.reset(),p.push(j));return p.length&&m.push(n.map(p)),v.flatten(m)}function q(a,b){return!a||!b||a.x!==b.x||a.y!==b.y||a.w!==b.w||a.h!==b.h}function r(a,b){var c,d;if(a.lenght!==b.length)return!0;for(c=0,d=a.length;c<d;++c)if(a[c]!==b[c])return!0;return!1}function s(a,b){var c=a.width||a.w,d=a.height||a.h,e=2*b.lineHeight;return c>e&&d>e}function t(a,b,c){function d(a,b,j,k){var l,m=g[a],n=a>0&&g[a-1],o=v.group(f,m,e,n,j),q=p(o,b,e,m,a,k),r=q.slice();return a<h-1&&q.forEach(function(b){l={x:b.x+i,y:b.y+i,w:b.w-2*i,h:b.h-2*i},s(b,c)&&(l.y+=c.lineHeight,l.h-=c.lineHeight),r.push.apply(r,d(a+1,l,b.g,b.s))}),r}var e=a.key||"",f=a.tree||[],g=a.groups||[],h=g.length,i=(a.spacing||0)+(a.borderWidth||0);return!f.length&&a.data.length&&(f=a.tree=a.data),h?d(0,b):p(f,b,e)}function u(a){return B.extend(D({fontFamily:F(a.fontFamily,A.fontFamily),fontSize:F(a.fontSize,A.fontSize),fontStyle:F(a.fontStyle,A.fontStyle),lineHeight:F(a.lineHeight,A.lineHeight)}),{color:E([a.fontColor,A.fontColor,A.global.defaultFontColor])})}a=a&&a.hasOwnProperty("default")?a["default"]:a;var v={flatten:b,group:c,index:e,isObject:d,sort:f,sum:g},w=function(){function a(b){_classCallCheck(this,a);var c=this;c.x=b.x||b.left||0,c.y=b.y||b.top||0,c._ix=0,c._iy=0,c.w=b.w||b.width||b.right-b.left,c.h=b.h||b.height||b.bottom-b.top}return _createClass(a,[{key:"map",value:function(a){var b,c,d,e=this,f=[],g=a.nsum,h=a.get(),k=h.length,l=e.dir,m=e.side,n=m*m,o="x"===l?"_ix":"_iy",p=g*g,q=0,r=0;for(b=0;b<k;++b)c=h[b],d=i(c,n,p,o),r+=d.d1,d.d2>q&&(q=d.d2),f.push(j(e,c,d,a.sum)),e[o]+=d.d1;return e["y"===l?"_ix":"_iy"]+=q,e[o]-=r,f}},{key:"area",get:function(){return this.w*this.h}},{key:"iw",get:function(){return this.w-this._ix}},{key:"ih",get:function(){return this.h-this._iy}},{key:"dir",get:function(){var a=this.ih;return a<=this.iw&&a>0?"y":"x"}},{key:"side",get:function(){return"x"===this.dir?this.iw:this.ih}}]),a}(),x=Math.min,y=Math.max,z=function(){function a(b,c){_classCallCheck(this,a);var d=this;d.key=b,d.ratio=c,d.reset()}return _createClass(a,[{key:"reset",value:function(){var a=this;a._arr=[],a._hist=[],a.sum=0,a.nsum=0,a.min=1/0,a.max=-(1/0),a.nmin=1/0,a.nmax=-(1/0)}},{key:"push",value:function(a){n(this,a,l(this,a))}},{key:"pushIf",value:function(a,b){for(var c=l(this,a),d=arguments.length,e=new Array(d>2?d-2:0),f=2;f<d;f++)e[f-2]=arguments[f];return b(k(this),c,e)?void n(this,a,c):a}},{key:"get",value:function(){return this._arr}},{key:"length",get:function(){return this._arr.length}}]),a}(),A=a.defaults,B=a.helpers,C=B.options,D=C._parseFont,E=C.resolve,F=B.valueOrDefault,G=a.DatasetController.extend({dataElementType:a.elements.Rectangle,update:function(a){var b,c,d,e=this,f=e.getMeta(),g=e.getDataset(),h=g.groups||(g.groups=[]),i=u(g),j=f.data||[],k=e.chart.chartArea,l=g.key||"";for(d={x:k.left,y:k.top,w:k.right-k.left,h:k.bottom-k.top},(a||q(e._rect,d)||e._key!==l||r(e._groups,h))&&(e._rect=d,e._groups=h.slice(),e._key=l,g.data=t(g,d,i),e.resyncElements()),b=0,c=j.length;b<c;++b)e.updateElement(j[b],b,a)},updateElement:function(a,b,c){var d=this,e=d.index,f=d.getDataset(),g=f.data[b],h=d._resolveElementOptions(a,b),i=c?0:g.h-2*h.spacing,j=c?0:g.w-2*h.spacing,k=g.x+j/2+h.spacing,l=g.y+i/2+h.spacing,m=i/2;a._options=h,a._datasetIndex=e,a._index=b,a.hidden=i<=h.spacing||j<=h.spacing,a._model={x:k,base:l-m,y:l+m,top:g.y,left:g.x,width:j,height:i,backgroundColor:h.backgroundColor,borderColor:h.borderColor,borderSkipped:h.borderSkipped,borderWidth:h.borderWidth,font:D(h),fontColor:h.fontColor},a.pivot()},draw:function(){var a,b,c,d,e,f=this,g=f.getMeta().data||[],h=f.getDataset(),i=(h.groups||[]).length-1,j=h.data||[],k=f.chart.ctx;for(a=0,b=g.length;a<b;++a)if(c=g[a],e=c._view,d=j[a],!c.hidden&&(c.draw(),s(e,e.font)&&d.g)){if(k.save(),k.fillStyle=e.fontColor,k.font=e.font.string,k.beginPath(),k.rect(e.left,e.top,e.width,e.height),k.clip(),"l"in d&&d.l!==i)k.textAlign="start",k.textBaseline="top",k.fillText(d.g,e.left+e.borderWidth+3,e.top+e.borderWidth+3);else if(k.textAlign="center",k.textBaseline="middle",k.fillText(d.g,e.left+e.width/2,e.top+e.height/2),f._config.sadafInfo.prop.showLabel){var l=_.merge({bold:!1,color:"#333333",align:"right",italic:!1,fontSize:"12px",fontName:"IRANSans",formatString:",.0f",formatStringCustom:",.0f",rotate:0,anchor:"end",position:"end"},f._config.sadafInfo.prop.showLabelFont),m=_.last(d._data.children).value,n=chartUtils.getFormatString(l);m=persian(d3.format(n)(m),!0),k.font=(l.italic?"italic ":"")+(l.bold?"bold ":"")+l.fontSize+" "+l.fontName,k.fillStyle=l.color;var o=+l.fontSize.replace("px","")/2+13;k.fillText(m,e.left+e.width/2,e.top+e.height/2+o)}k.restore()}},_resolveElementOptions:function(a,b){var c,d,e,f=this,g=f.chart,h=f.getDataset(),i=g.options.elements.rectangle,j={},k={chart:g,dataIndex:b,dataset:h,datasetIndex:f.index},l=["backgroundColor","borderColor","borderSkipped","borderWidth","fontColor","fontFamily","fontSize","fontStyle","spacing"];for(c=0,d=l.length;c<d;++c)e=l[c],j[e]=E([h[e],i[e]],k,b);return j}}),H={hover:{mode:"point",intersect:!0},tooltips:{mode:"point",position:"treemap",intersect:!0,callbacks:{title:function(a,b){return b.datasets[a[0].datasetIndex].key},label:function(a,b){var c=b.datasets[a.datasetIndex],d=c.data[a.index];return c.label+": "+d.v}}},scales:{xAxes:[{type:"linear",display:!1}],yAxes:[{type:"linear",display:!1}]},elements:{rectangle:{borderSkipped:!1,borderWidth:0,spacing:.5}}};a.controllers.treemap=G,a.defaults.treemap=H,a.Tooltip.positioners.treemap=function(a){if(!a.length)return!1;var b=a[a.length-1]._view;return{x:b.x,y:b.y-b.height/2}}}),function(){if(chartUtils.enableNewCharts){var a={type:19,expandedChartType:[{name:"TreeMap",type:41,iconLink:app.urlPrefix+"images/chart-icons/tree.png"}],category:"ChartJs",config:{needDim:!1,needMeasure:!0,needServerData:!0},changeSeriesPropertyBaseOnExpandedType:function(a,b){},draw:function(a,b,c,d){b.selector;$(b.selector).addClass("canvas-chart");var e=!0,f=$(b.selector).width(),g=chartUtils.getData(a,b);if(!chartUtils.renderLegendForBar(b,g,a,d,f,e,!0)){_.each(g,function(c){c.data=c.data.map(function(b,c){var d={};return d.value=b,d.sadaf_index=c,_.each(_.reverse(a.matrix[c].captions),function(a,b){d["x"+b]=a}),d});var d=chartUtils.getFontFromProp(b.chartProp.general.labelsFonts);c.key="value",c.groups=_.reverse(_.map(a.matrix[0].captions,function(a,b){return"x"+b})),c.fontColor=b.chartProp.general.showLabels?d.fontColor:"#00000000",c.fontFamily=d.fontFamily,c.fontSize=d.fontSize,c.spacing=.5,c.borderWidth=c.sadafInfo.prop.borderWidth,c.borderColor=c.sadafInfo.prop.borderColor,c.labelGroup=!1,delete c.type,delete c.datalabels;chartUtils.getColorArray(a,b);c.backgroundColor=function(c){var d=c.dataset.data[c.dataIndex];if(d.l!==a.matrix[0].captions.length-1)return"#909090";var e=d3.min(c.dataset.data,function(a){return a.v}),f=d3.max(c.dataset.data,function(a){return a.v}),g=(d.v-e)/(f-e)*.4+.6;f-e==0&&(g=1);var h=_.last(d._data.children).sadaf_index,i=c.dataset.sadafInfo.prop.color,j=b.chartProp.general.dimColor=b.chartProp.general.dimColor||{};if(j.enable){var k=j.data[a.matrix[h].captions.join("-")];k=k||{color:"#efefef"},i=k.color}return Color(i).alpha(g).rgbaString()}});var h=0,i=$(b.selector+" .legend-bar").height(),j=$(b.selector).height()+h-i;$(b.selector).append('<canvas class="temporal canvas"  width="'+f+'" height="'+j+'" style="margin-top:-'+h+'px"></canvas>');var k=$(b.selector+" canvas").get(0).getContext("2d");Chart.defaults.global.defaultFontFamily="IRANSans";var l=chartUtils.getChartOption(a,b,g,d);_.each(g,function(a){a.pointRadius=a.sadafInfo.prop.pointRadius}),l.type="treemap";d3.max(g[0].data,function(a){return a.y});l.options.tooltips.getValueCallback=function(a){return a.v},l.options.tooltips.callbacks.title=function(a,b){var c=_.map(a,function(a){return b.datasets[a.datasetIndex].data[a.index].g});return c.join(", ")},l.options.tooltips.callbacks.label=function(a,b){var c=b.datasets[a.datasetIndex],d=c.data[a.index],e=d.g,f=chartUtils.getFormatString(b.datasets[a.datasetIndex].sadafInfo.prop.tooltipFont);return persian(e+" - "+c.label+": "+chartUtils.format(f,d.v),!0)},l.options.tooltips.mode="point",l.options.tooltips.position="treemap",l.options.tooltips.intersect=!0,l.options.maintainAspectRatio=!1,l.options.plugins.datalabels=!1,l.options.onClick=function(c){var e=this.getElementAtEvent(c);if(!_.isArray(e)||!e.length)return labelClick||chartUtils.drillUp(b,a,d),void(labelClick=!1);var f=_.last(e[0]._chart.active)._index,g=e[0]._chart.data.datasets[0].data[f],h=_.last(g._data.children).sadaf_index;chartUtils.onClickCalback(b,a,a.matrix[h],d)},l.options.plugins={datalabels:!1},chart=new Chart(k,l),$(b.selector+" canvas").data("chart",chart)}}},b=chartUtils.getChartSettings();_.remove(b.series,{key:"type"}),_.find(_.find(b.series,{key:"showLabel-section"}).items,{key:"showLabelFont"})["default"].color="#ffffff",_.find(b.series,{key:"color"}).onchange=function(a,b,c){b.borderColor=a},_.find(b.series,{key:"borderWidth"})["default"]=1,_.remove(b.general,{key:"legendFont"}),_.remove(b.general,{key:"legendPosition"}),_.remove(b.general,{key:"stack"}),
_.remove(b.general,{key:"linesHoriz"}),_.remove(b.general,{key:"linesVert"}),_.remove(b.general,{key:"customFont"}),_.remove(b.general,{key:"showLegends"}),_.find(b.series,{key:"borderColor"})["default"]="white",b.general.push({title:"نمایش برچسب‌ها روی نمودار",key:"showLabels",type:"checkbox","default":!0}),b.general.push({title:"فونت برچسب‌های روی نمودار",key:"labelsFonts",type:"font","if":{key:"showLabels",value:!0},config:{format:!1,align:!1,bold:!1},"default":{fontSize:"12px",color:"white"}}),a.settings=b,app=app||{},app.charts=app.charts||{},app.charts.list=app.charts.list||[],app.charts.list.push(a)}}();