// داشبورد مدیریتی صدف info@sadafdashboard.ir

function prepareData(a,b){for(var c=[],d=(a.matrix||[],0);d<a.matrix.length;d++){var e={};e.index=a.matrix[d][0],e.label=a.matrix[d][1],e.onClickVal=a.matrix[d][2],e.value=a.matrix[d][3],e.kpis=a.kpis.data[d],e.series=a.series.data[d];var f=[];if(e.kpis)for(var g=0;g<e.kpis.length;g++){for(var h=[],i=0;i<e.kpis[g].length;i++)h.push(parseFloat(e.kpis[g][i])||0);f.push(h)}e.kpis=f,f=[];for(var g=0;g<e.series.length;g++)isNaN(e.series[g])?f.push(e.series[g]||0):f.push(parseFloat(e.series[g])||0);e.series=f,c.push(e)}return c}function persian(a,b){if(!b)return a;var c={0:"۰",1:"۱",2:"۲",3:"۳",4:"۴",5:"۵",6:"۶",7:"۷",8:"۸",9:"۹"};return a+="",a.replace(/(\d)/g,function(a,b){return c[b]||a})}function depersian(a){var b={"۰":0,"۱":1,"۲":2,"۳":3,"۴":4,"۵":5,"۶":6,"۷":7,"۸":8,"۹":9};return a+="",a.replace(/([۰۱۲۳۴۵۶۷۸۹])/g,function(a,c){return"undefined"!=typeof b[c]?b[c]:a})}function normilize(a){var b={"ي":"ی","إ":"ا","ؤ":"و","أ":"ا","ک":"ك"};return a+="",a.replace(/(.)/g,function(a,c){return b[c]||a})}var app=app||{};app.chartCommons={},app.chartCommons.tooltip={tooltipFormatter:function(set,fh,f,showPersain){var body=set.points.map(function(point){var bodyFormat=f||'{{point.label}}: <p class="ltr inline" style="padding:0; margin:0;" ><b>{{point.data}}</b></p>';return bodyFormat.replace(/{{([^(}})]+)}}/gm,function(i,p1){if(!p1.match(/point\.(data|label|color|format|percentage)/))return p1;var e=eval(p1);return"NaN"===e&&(e="تعریف نشده"),isNaN(e)?e:persian(d3.format(point.format)(e),showPersain)})}).join("<br/>"),headerFormat=fh||"",header=headerFormat.replace(/{{([^(}})]+)}}/gm,function(i,p1){var e=eval(p1);return isNaN(e)||"set.key"==p1?e:persian(d3.format(set.format)(e),showPersain)});return header&&body.trim()&&(header+="<BR/>"),r='<div style="margin:0;text-align: right; padding:0;direction: rtl;">'+header+body+"</div>",r}},app.chartCommons.highchartSetTheme=function(){var a=d3.scale.category10();Highcharts.setOptions({lang:{loading:"در حال بارگذاری...",months:["January","February","March","April","May","June","July","August","September","October","November","December"],shortMonths:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],weekdays:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],decimalPoint:".",numericSymbols:["k","M","G","T","P","E"],resetZoom:"حالت اولیه",resetZoomTitle:"حالت اولیه 1:1",thousandsSep:","},global:{useUTC:!0,canvasToolsURL:"http://code.highcharts.com/4.1.4/modules/canvas-tools.js",VMLRadialGradientURL:"http://code.highcharts.com/4.1.4/gfx/vml-radial-gradient.png"}}),Highcharts.theme={chart:{},xAxis:{title:{text:null,align:"middle"}},yAxis:{endOnTick:!1,title:{text:null,align:"middle"},labels:{formatter:function(){return persian(d3.format(",")(this.value))}},lineWidth:2,lineColor:"#D8D8D8",tickWidth:1},tooltip:{valueSuffix:"",useHTML:!0,formatter:function(){return"<b>"+this.x+"</b>: <b>"+this.series.tooltipOptions.pointFormatter(this)+"</b>"},headerFormat:"",style:{"text-align":"right"}},plotOptions:{bar:{dataLabels:{enabled:!0}},series:{animation:{duration:800,easing:"easeInCubic"},allowPointSelect:!0,fillOpacity:.1,marker:{fillColor:"#FFFFFF",lineWidth:2,lineColor:null}}},credits:{enabled:!1},colors:[1,2,3,4,5,6,7,8,9,10].map(function(b,c){return a(c)}),chart:{animation:{duration:400,easing:"linear"},panning:!0,panKey:"shift"},title:{text:null,style:{color:"#000",font:"bold 16px Droid, Tahoma, Arial"}},subtitle:{style:{color:"#666666",font:"bold 12px Droid, Tahoma, Arial"}},legend:{itemStyle:{font:"9pt Droid, Tahoma, Arial",color:"black"},itemHoverStyle:{color:"gray"}}},Highcharts.setOptions(Highcharts.theme)},app.chartCommons.getError=function(a){if(!a.result){var b=0==+a.errorType?"منبع داده غیر فعال است":"اشکال در پرس و جو";return"<div class='temporal error'> <h4>"+b+"</h4><p>"+a.errorMessage+"</p></div>"}return"<div class='temporal error'> مشکلی در روند برنام ایجاد شده است</div>"},app.chartCommons.openLink=function(a){if(-1!=a.dashboardId)location.hash="/dashboard/"+a.dashboardId;else{var b=window.open(a.link,"_blank");b?b.focus():alert("Please allow popups for this site")}},app.chartCommons.calculateFields=function(series,calcFormulas,columnIsNumeric){function calc(item,series,columnIsNumeric){function getCell(a,b,c){return b=0>b?0:b>=a.length?a.length-1:b,c=0>c?0:c>=a[0].length?a[0].length-1:c,a[b][c]}if(-1==series.labels.indexOf(item.name)&&series.data instanceof Array){var isValid=/^({\s*r?([+-]?\d*)\s*,?\s*c?(\d*)}|[\d\s\+-\/\)\(\*]*|'[^']*')*$/gim.test(item.formula);if(!isValid)return void alert("### Not valid "+item.formula);for(var indexes=[],repFormula=item.formula.replace(/{\s*r?([\+-]?\d*)\s*,?\s*c?(\d*)}/gim,function(a,b,c){return indexes.push({row:+b,col:+c}),"$"+(indexes.length-1)}),i=0;i<series.data.length;i++){var rowFormula=repFormula.replace(/\$(\d+)/gim,function(a,b){var c=indexes[+b],d=getCell(series.data,c.row+i,c.col);return columnIsNumeric&&!columnIsNumeric[c.col]?"'"+d+"'":d||0});series.data[i].push(eval(rowFormula))}series.labels.push(item.name)}}return;var formulas},app.chartCommons.drillDown={filters:[],add:function(a,b,c,d){var e=_.find(this.filters,{chartInPageId:a});if(_.isUndefined(e)){var f={chartInPageId:a,datasourceId:b,drillDown:[{key:c,value:d}]};return this.filters.push(f),f.drillDown}var g=_.find(e.drillDown,{key:c});return _.isUndefined(g)||_.remove(e.drillDown,{key:c}),e.drillDown.push({key:c,value:d}),e.drillDown},up:function(a,b){var c=_.find(this.filters,{chartInPageId:a});if(_.isUndefined(c))return[];_.isUndefined(b)&&(b=1);for(var d=0;b>d;d++)c.drillDown.length>0&&c.drillDown.pop();return c.drillDown},get:function(a){return _.find(this.filters,{chartInPageId:a})},clear:function(a){return _.remove(this.filters,{chartInPageId:a})},clearAll:function(){this.filters=[]}},app.chartCommons.getFilterHierarchy=function(a,b){function c(a){if(_.isArray(a)){for(var b=0;b<a.length;b++){var c=a[b];"undefined"!=typeof c.Members&&c.Members&&(c.Members=c.Members.filter(function(a,b){return a.IsChecked}),c.FilteredMemberByUser=!0)}return a}}var b=$(".cid"+a+" .chart-dimentions-content").data("data");return _.isUndefined(b)?null:{Hierarchies:c(b.Hierarchies),Where:c(b.Where),SeriesLevel:c(b.SeriesLevel)}},app.chartCommons.userFilter={filters:[],setUserControlFilters:function(a){this.filters=[],_.isArray(a)&&(this.filters=a)},setFilter:function(a){if(0==this.filters.length)return void this.filters.push(a);var b=_.find(this.filters,{chartInPageId:a.chartInPageId,dimensionName:a.dimensionName});_.isUndefined(b)||_.remove(this.filters,{chartInPageId:a.chartInPageId,dimensionName:a.dimensionName}),this.filters.push(a)},setFilterIfNotExist:function(a){if(!(_.isEmpty(a.values)||_.isArray(a.values)&&0==a.values.length)){if(0==this.filters.length)return void this.filters.push(a);var b=_.find(this.filters,{chartInPageId:a.chartInPageId});_.isUndefined(b)&&this.filters.push(a)}},getFilterValue:function(a){var b=_.find(this.filters,{chartInPageId:a});return _.isUndefined(b)?null:b}},app.chartCommons.lastRefreshDateFormat=function(a){if(!a)return"";if(0!=app.lang.langType)return a.D+"/"+a.M+"/"+a.Y+" - "+a.h+":"+a.m+":"+a.s+" ";var b="";a.Diff&&a.Diff<86400&&(b+=" - <b>",b+=a.Diff<60?Math.floor(a.Diff)+" ثانیه پیش":a.Diff<3600?Math.floor(a.Diff/60)+" دقیقه پیش":Math.floor(a.Diff/3600)+" ساعت پیش",b+="</b>");var c=1==+a.M?"فروردین":2==+a.M?"اردیبهشت":3==+a.M?"خرداد":4==+a.M?"تیر":5==+a.M?"مرداد":6==+a.M?"شهریور":7==+a.M?"مهر":8==+a.M?"آبان":9==+a.M?"آذر":10==+a.M?"دی":11==+a.M?"بهمن":"اسفند";return persian(a.D+" "+c+" ماه "+a.Y+" ساعت "+a.h+":"+a.m+":"+a.s+" "+b,!0)},app.chartCommons.setFilterParameter=function(a){a.parameters.drillDown=null;var b=_.find(app.chartCommons.drillDown.filters,{chartInPageId:a.ChartInPageId});if(_.isUndefined(b)||(a.parameters.drillDown=b.drillDown),!a.editMode){a.parameters.otherFilters=_.filter(app.chartCommons.drillDown.filters,function(b){if(!a.input||!a.input.RefreshDatasource)return!1;var c=-1!=a.input.RefreshDatasource.indexOf(b.datasourceId);return c&&b.chartInPageId!=a.ChartInPageId}),a.parameters.userControlFilter=$.extend([],_.filter(app.chartCommons.userFilter.filters,function(b){if(!a.input||!a.input.RefreshDatasource)return!1;var c=-1!=a.input.RefreshDatasource.indexOf(b.datasourceId);return c}));var c=JSON.parse(localStorage.getItem("userVariable"));a.parameters.userVariable=c}},d3.selection.prototype.settingsIcon=function(a){return},d3.selection.prototype.legend=function(a,b){var c=this.append("div").attr("class","legend-div temporal").append("div").attr("class","list-inline").style("margin-bottom","12px");return c.selectAll("nothingd").data(a.data).enter().append("span").text(function(a){return persian(a.label,b)}).attr("class","pointer legend-item").on("click",function(b,c){a.selector&&$(a.selector).trigger("legendClick",[b.label,c,b])}).append("span").attr("class","legend-color").style("background-color",function(a){return a.color}),c},d3.selection.prototype.breadcrumb=function(a,b,c,d){var e=a.slice(0);"undefined"!=typeof e[0]&&null!==e[0]&&e.unshift(app.lang.translate("پاک کردن"));var f=e[e.length-1];if(e.splice(e.length-1,1),e.length>0){var g=function(a,d){var f=c.isProgress,g=c.showProgress;if(!f()){g(!0);var h=app.chartCommons.drillDown.up(b.ChartInPageId,e.length-d);b.parameters={drillDown:h,isUp:!0,upLevel:e.length-d,chartId:b.chartId,ChartInPageId:b.ChartInPageId},b.drill="up",$("#"+b.id).charts(b.type,"refreshWithData",b)}},h='<div class="ui small breadcrumb floated right temporal">'+e.map(function(a){return'<a class="section clickable">'+a+"</a>"}).join('<i class="left arrow icon divider"></i>')+'<i class="left arrow icon divider"></i><div class="section active">'+f+"</div></div>";return $(this[0][0]).append(h),void $(this[0][0]).find(".breadcrumb .clickable").each(function(a,b){$(this).on("click",function(){g(0,a)})})}},d3.selection.prototype.titlebar=function(a){var b,c=d3.select(this[0][0]),d=function(){return"visible"==$(c[0][0]).find(".myprogress").css("visibility")},e=$(c[0][0]).parents(".ui.card").find(".progress-overall"),f=function(a){a?($(c[0][0]).find("*").attr("disabled",!0),$(c[0][0]).find(".myprogress").css("visibility","visible"),e.fadeIn()):($(c[0][0]).find("*").attr("disabled",!1),$(c[0][0]).find(".myprogress").css("visibility","hidden"),e.fadeOut())};return{title:b,showProgress:f,isProgress:d}};var d3Utils={prepareDataForBarChart:function(a,b,c,d,e,f){var g=d3.scale.category10();$.each(a,function(a,h){if(!h.kpis)return!0;var i=[];return $.each(h.kpis,function(a,c){var e=b.chartProp.series[d[a]]||b.chartProp.series["default"];g(a);"undefined"==typeof e&&"undefined"!=typeof model&&(e=$.extend(!0,{},"undefined"!=typeof model.seriesProp[d[a]]?model.seriesProp[d[a]]:model.seriesProp["default"]),e.seriesColor=g(a)),i.push({data:c,prop:e,key:d[a],label:f&&f.length>a?f[a]:d[a],type:"kpi"})}),h.series?($.each(h.series,function(a,d){var f=b.chartProp.series[c[a]];i.push({data:isNaN(d)?d:d*parseFloat(f.numberFactor),prop:f,key:c[a],label:e&&e.length>a?e[a]:c[a],type:"series"})}),void(h.series=i)):!0})},convertToKeyValue:function(a){var b=_.map(a.series.labels,function(b,c){var d=a.seriesLablesCaptions&&a.seriesLablesCaptions.length>c;return{key:b,value:d?a.seriesLablesCaptions[c]:b}}),c=_.map(a.kpis.labels,function(b,c){var d=a.kpisLablesCaptions&&a.kpisLablesCaptions.length>c;return{key:b,value:d?a.kpisLablesCaptions[c]:b}});return{seriesLabels:b,kpiLabels:c}}},app=app||{};app.helper=app.helper||{},function(){function a(a){for(var d=0;d<a.length;d++)for(var e=0;e<b.length;e++)a.charAt(d)===b[e]&&(a=a.replace(a.charAt(d),c[e]));return a}var b=["ي","إ","ؤ","أ","ي","ك"],c=["ی","ا","و","ا","ی","ک"];app.helper.filterMemberDialogOk=function(){var a=$("#filter-member-dialog").data("data");$("#filter-member-dialog .li ").each(function(b,c){var d=$(this).find("input"),e=$.grep(a.members,function(a){return a.Uniquename==d.attr("value")})[0];e.IsChecked=d.prop("checked")}),a.onfinish(a.members),$("#filter-member-dialog").modal("hide")},app.helper.filterMemberDialog=function(b,c,d){function e(a,b,c){var d='<div class=" " style="height:50vh; overflow:auto;"> '+b.map(function(a,b){return'<div class="li"><input value="'+a.Uniquename+'" type="checkbox" id="member-'+b+'" '+(a.IsChecked?" checked ":"")+' /> <label class="unstyled-lable" for="member-'+b+'">'+a.Caption+"</label></div>"}).join("")+"</div>";c.find(".member-list").html(d),$("#filter-member-dialog").modal("refresh")}var f=function(d){var f=window.innerHeight,g=$("#filter-member-dialog").outerHeight(),h=f-g-50;body='<div class="ui form"><input type="text" class="form-control" id="filter-member-search" placeholder="جستجو"></div>                    <input id="select-all-member-filter" type="checkbox" style="margin-top:10px"/><label style="margin-right:5px;" for="select-all-member-filter"> همه </label>                    <div class="member-list"></div>';var i=$("#filter-member-dialog #filter-member-dialog-content");i.html(body),$("#select-all-member-filter").change(function(){var a=this.checked;$("#filter-member-dialog ul li input").filter(function(){return $(this).is(":visible")}).prop("checked",a)}),e(h,b,i);var j;$("#filter-member-dialog #filter-member-search").keyup(function(){var b=$(this).val().toLowerCase();if(b=a(b),c){if(b&&1==b.length)return;clearTimeout(j),j=setTimeout(function(){$.ajax(c+"&query="+b).done(function(a){var b=$("#filter-member-dialog").data("data");b.members=a,e(h,a,i)})},400)}else $("#filter-member-dialog li").show(),$("#filter-member-dialog li").filter(function(){var c=$(this).text().toLowerCase();return c=a(c),-1==c.indexOf(b.toLowerCase())}).hide()})};$("#filter-member-dialog").modal({onVisible:f}).modal("show"),$("#filter-member-dialog").data("data",{members:b,onfinish:d}),$("#filter-member-dialog").modal("show")}}($),function(a){function b(a,b){return"function"==typeof a?a.call(b):a}function c(b,c){this.$element=a(b),this.options=c,this.enabled=!0,this.fixTitle()}c.prototype={show:function(){var c=this.getTitle();if(c&&this.enabled){var d=this.tip();d.find(".tipsy-inner")[this.options.html?"html":"text"](c),d[0].className="tipsy",d.remove().css({top:0,left:0,visibility:"hidden",display:"block"}).prependTo(document.body);var e=a.extend({},this.$element.offset(),{width:this.$element[0].offsetWidth||0,height:this.$element[0].offsetHeight||0});if("object"==typeof this.$element[0].nearestViewportElement){var f=this.$element[0],g=f.getBoundingClientRect();e.width=g.width,e.height=g.height}var h,i=d[0].offsetWidth,j=d[0].offsetHeight,k=b(this.options.gravity,this.$element[0]);switch(k.charAt(0)){case"n":h={top:e.top+e.height+this.options.offset,left:e.left+e.width/2-i/2};break;case"s":h={top:e.top-j-this.options.offset,left:e.left+e.width/2-i/2};break;case"e":h={top:e.top+e.height/2-j/2,left:e.left-i-this.options.offset};break;case"w":h={top:e.top+e.height/2-j/2,left:e.left+e.width+this.options.offset};break;case"c":h={top:e.top+e.height/2-j/2,left:e.left+e.width/2-i/2}}2==k.length&&("w"==k.charAt(1)?h.left=e.left+e.width/2-15:h.left=e.left+e.width/2-i+15),d.css(h).addClass("tipsy-"+k),d.find(".tipsy-arrow")[0].className="tipsy-arrow tipsy-arrow-"+k.charAt(0),this.options.className&&d.addClass(b(this.options.className,this.$element[0])),this.options.fade?d.stop().css({opacity:0,display:"block",visibility:"visible"}).animate({opacity:this.options.opacity}):d.css({visibility:"visible",opacity:this.options.opacity});var l=this,m=function(a){return function(){l.$tip.stop(),l.tipHovered=a,a||(0===l.options.delayOut?l.hide():setTimeout(function(){"out"==l.hoverState&&l.hide()},l.options.delayOut))}};d.hover(m(!0),m(!1))}},hide:function(){this.options.fade?this.tip().stop().fadeOut(function(){a(this).remove()}):this.tip().remove()},fixTitle:function(){var a=this.$element;(a.attr("title")||"string"!=typeof a.attr("original-title"))&&a.attr("original-title",a.attr("title")||"").removeAttr("title"),"object"==typeof a.context.nearestViewportElement&&a.children("title").length&&a.append("<original-title>"+(a.children("title").text()||"")+"</original-title>").children("title").remove()},getTitle:function(){var a,b=this.$element,c=this.options;if(this.fixTitle(),"string"==typeof c.title){var d="title"==c.title?"original-title":c.title;a=b.children(d).length?b.children(d).html():b.attr(d)}else"function"==typeof c.title&&(a=c.title.call(b[0]));return a=(""+a).replace(/(^\s*|\s*$)/,""),a||c.fallback},tip:function(){return this.$tip||(this.$tip=a('<div class="tipsy"></div>').html('<div class="tipsy-arrow"></div><div class="tipsy-inner"></div>')),this.$tip},validate:function(){this.$element[0].parentNode||(this.hide(),this.$element=null,this.options=null)},enable:function(){this.enabled=!0},disable:function(){this.enabled=!1},toggleEnabled:function(){this.enabled=!this.enabled}},a.fn.tipsy=function(b){function d(d){var e=a.data(d,"tipsy");return e||(e=new c(d,a.fn.tipsy.elementOptions(d,b)),a.data(d,"tipsy",e)),e}function e(){var a=d(this);a.hoverState="in",0===b.delayIn?a.show():(a.fixTitle(),setTimeout(function(){"in"==a.hoverState&&a.show()},b.delayIn))}function f(){var a=d(this);if(a.hoverState="out",0===b.delayOut)a.hide();else{var c=function(){a.tipHovered&&b.hoverlock||"out"==a.hoverState&&a.hide()};setTimeout(c,b.delayOut)}}if(b===!0)return this.data("tipsy");if("string"==typeof b){var g=this.data("tipsy");return g&&g[b](),this}if(b=a.extend({},a.fn.tipsy.defaults,b),b.hoverlock&&0===b.delayOut&&(b.delayOut=100),"manual"!=b.trigger){var h=b.live?"live":"bind",i="hover"==b.trigger?"mouseenter":"focus",j="hover"==b.trigger?"click":"blur",k="hover"==b.trigger?"mouseleave":"blur";this[h](i,e)[h](k,f)[h](j,f)}return this},a.fn.tipsy.defaults={className:null,delayIn:0,delayOut:0,fade:!1,fallback:"",gravity:"n",html:!1,live:!1,offset:0,opacity:.8,title:"title",trigger:"hover",hoverlock:!1},a.fn.tipsy.elementOptions=function(b,c){return a.metadata?a.extend({},c,a(b).metadata()):c},a.fn.tipsy.autoNS=function(){return a(this).offset().top>a(document).scrollTop()+a(window).height()/2?"s":"n"},a.fn.tipsy.autoWE=function(){return a(this).offset().left>a(document).scrollLeft()+a(window).width()/2?"e":"w"},a.fn.tipsy.autoBounds=function(b,c){return function(){var d={ns:c[0],ew:c.length>1?c[1]:!1},e=a(document).scrollTop()+b,f=a(document).scrollLeft()+b,g=a(this);return g.offset().top<e&&(d.ns="n"),g.offset().left<f&&(d.ew="w"),a(window).width()+a(document).scrollLeft()-g.offset().left<b&&(d.ew="e"),a(window).height()+a(document).scrollTop()-g.offset().top<b&&(d.ns="s"),d.ns+(d.ew?d.ew:"")}}}(jQuery);var app=app||{};app.charts=app.charts||{},app.charts.bar={},app.charts.bar.draw=function(a,b,c,d){function e(a,b,c){var d=c.indexOf(a.firstField),e=b[d],f=a.secondFieldIsText?a.secondFieldInput:b[c.indexOf(a.secondFieldSelect)];switch(e=depersian(e),f=depersian(f),isNaN(f)||(f=+f),isNaN(e)||(e=+e),+a.operand){case 1:return e==f;case 2:return e!=f;case 3:return e>f;case 4:return e>=f;case 5:return f>e;case 6:return f>=e;case 7:return e.indexOf(f)>-1;case 8:return e.indexOf(f)<=-1}}function f(a,c,d){b.chartProp.indicator&&b.chartProp.indicator.forEach(function(b){var f=!0;$.each(b.ifRow,function(a,b){return e(b,c,d)?void 0:(f=!1,!1)}),f&&a.map(function(a){return a.thenRows=a.thenRows||[],a.thenRows.push(b.thenRow),a})})}function g(a,c,d,e){var f=F[a].series;return 1==c&&d&&"undefined"!=typeof e&&(f=f.filter(function(a){return a.prop.seriesType==d&&!a.prop.hidden}),f=[f[e]]),2==c&&(f=f.filter(function(a){return!a.prop.hidden})),f=f.map(function(a){return{data:a.data,label:a.prop.name||a.label,format:y(a.prop),color:a.prop.seriesColor}}),app.chartCommons.tooltip.tooltipFormatter({points:f,key:F[a].label,sum:d3.sum(f,function(a){return a.data}),avg:d3.sum(f,function(a){return a.data})/f.length,format:f.length>0?f[0].format:",.2f"},b.chartProp.info.tooltipHeader,b.chartProp.info.tooltipFormat,t)}function h(a){var b=a[0].series.filter(function(a,b){return"line"==a.prop.seriesType&&!a.prop.hidden}),c=b.map(function(b,c){return{label:b.label,prop:b.prop,values:a.map(function(a,c){return{label:a.label+"#"+a.index,value:a.series.filter(function(a,c){return a.label==b.label})[0].data,valueLabel:a.series.filter(function(a,c){return a.label==b.label})[0].data,prop:a.series.filter(function(a,c){return a.label==b.label})[0].prop,onClickVal:a.onClickVal,primv:a.value}}),valueStacked:a.map(function(a,c){return{label:a.label+"#"+a.index,valueLabel:a.series.filter(function(a,c){return a.label==b.label})[0].data,value:a.series.filter(function(a,c){return a.label==b.label})[0].data,prop:a.series.filter(function(a,c){return a.label==b.label})[0].prop,onClickVal:a.onClickVal,primv:a.value}})}}),d=0==c.length?[]:c[0].valueStacked.map(function(a){return Math.abs(a.value)});return c.forEach(function(a,b){if(0!=b){var e=c[b-1];a.valueStacked.forEach(function(a,b){d[b]+=Math.abs(a.value),a.value+=e.valueStacked[b].value})}}),E&&c.forEach(function(a,b){a.valueStacked.forEach(function(a,b){a.value=a.value/d[b]*100})}),c}function i(){clearTimeout(cb),bol=O.property("checked"),b.isSort=bol;var a=P[0][0].selectedIndex,c=P[0][0].value,d=(P[0][0],!0);a>=k.length&&(d=!1),za.domain(b.isSort?F.sort(function(a,b){return na=a.series.filter(function(a){return a.label==c}),nb=b.series.filter(function(a){return a.label==c}),na instanceof Array?(na=na[0],nb=nb[0],"series"==na.type?nb.data-na.data:nb.data[0]-na.data[0]):0}).map(function(a){return a.label+"#"+a.index}):F.sort(function(a,b){return a.index-b.index}).map(function(a){return a.label+"#"+a.index})),Ba.domain(b.isSort?F.filter(ba).sort(function(a,b){return na=a.series.filter(function(a){return a.label==c}),nb=b.series.filter(function(a){return a.label==c}),na instanceof Array?(na=na[0],nb=nb[0],"series"==na.type?nb.data-na.data:nb.data[0]-na.data[0]):0}).map(function(a){return a.label+"#"+a.index}):F.filter(ba).sort(function(a,b){return a.index-b.index}).map(function(a){return a.label+"#"+a.index}));var e=Y.transition().duration(b.animationDuration),g=function(a,b){return G?50*b:0};e.selectAll(".gd").delay(g).attr("transform",function(a){return"translate("+za(a.label+"#"+a.index)+",0)"}),e.selectAll(".gd-text").delay(g).attr("transform",function(a){return"translate("+za(a.label+"#"+a.index)+",0)"});var i=h(F);Y.selectAll(".area").data(i).datum(function(a){var b=a.prop.lineType;return"line-dot-area"==b||"line-area"==b?D?a.valueStacked:a.values:0}).transition().duration(b.animationDuration).attr("d",function(a){return 0===a?Ya:Ya.interpolate(a[0].prop.lineStyle)(a)}),Y.selectAll(".line").data(i).datum(function(a){var b=a.prop.lineType;return"line-dot-area"==b||"line-dot"==b||"line-area"==b||"line"==b?D?a.valueStacked:a.values:0}).transition().duration(b.animationDuration).attr("d",function(a){return 0===a?$a:$a.interpolate(a[0].prop.lineStyle)(a)}),Y.selectAll(".circle-group").data(i).selectAll(".circle").data(function(a){var b=a.prop.lineType;return"line-dot-area"==b||"line-dot"==b||"dot"==b?D?a.valueStacked:a.values:0}).transition().duration(b.animationDuration).attr("stroke",function(a,b){var c=[a],d=d3.select(this.parentNode).datum().label,e=F[b].series.map(function(a){return a.label}),g=F[b].series.map(function(a){return a.data});f(c,g,e),a=c[0];var h=a.prop.seriesColor;return a.thenRows&&$.each(a.thenRows,function(a,b){$.each(b,function(a,b){if(d!=b.firstField)return!0;switch(+b.operand){case 1:h=b.secondFieldColor}})}),h}).attr("cx",function(a){return $a.interpolate(a.prop.lineStyle).x()(a)}).attr("cy",function(a){return $a.interpolate(a.prop.lineStyle).y()(a)}),Y.selectAll(".text-vals").data(i).selectAll(".text-value").data(function(a){var b=a.prop.lineType;return"line-dot-area"==b||"line-dot"==b||"dot"==b?D?a.valueStacked:a.values:0}).transition().duration(b.animationDuration).attr("x",function(a){var b=d3.select(this).node().getBBox().width;return $a.interpolate(a.prop.lineStyle).x()(a)-b/2}).text(function(a){return persian(d3.format(y(a.prop.font,a.prop))(a.valueLabel),t)}).attr("dy","-10").attr("y",function(a){return $a.interpolate(a.prop.lineStyle).y()(a)}),Y.selectAll(".colorStepGroup").data(i).selectAll("stop").data(function(a){var b=[],c=1/(2*(a.values.length-1)),d=-1*c;return a.values.map(function(e,g){var h={value:e.value,label:a.label,color:a.prop.seriesColor},i=[h],j=F[g].series.map(function(a){return a.label}),k=F[g].series.map(function(a){return a.data});f(i,k,j),h=i[0],h.offset=0>d?0:d,b.push(h),h=$.extend({},h),d+=2*c,h.offset=d>1?d-c:d,b.push(h)}),b}).transition().attr("stop-color",function(a,b){var c=a.color;return a.thenRows&&$.each(a.thenRows,function(b,d){$.each(d,function(b,d){if(a.label!=d.firstField)return!0;switch(+d.operand){case 1:c=d.secondFieldColor}})}),c}).attr("offset",function(a){return a.offset}),e.select(".x.axis").call(ea).selectAll("g").delay(g),e.select(".x.axis").selectAll("g text").attr("transform",function(){return Ga?"rotate(-90)":"rotate(0)"}).attr("class","axes-x-label").style("font-family",b.chartProp.info.font.fontName).style("font-size",b.chartProp.info.font.fontSize).attr("fill",b.chartProp.info.font.color).style("font-weight",b.chartProp.info.font.bold?"bold":"normal").style("font-style",b.chartProp.info.font.italic?"italic":"normal").attr("x","-1em").attr("dy","0.1em").attr("y","0").delay(g),Y.select(".x.axis").selectAll("g text").attr("transform",function(){return Ga?"rotate(-90)":"rotate(0)"}).style("font-family",b.chartProp.info.font.fontName).style("font-size",b.chartProp.info.font.fontSize).attr("fill",b.chartProp.info.font.color).style("font-weight",b.chartProp.info.font.bold?"bold":"normal").style("font-style",b.chartProp.info.font.italic?"italic":"normal").style("text-anchor","end").attr("x","-1em").attr("dy","0.1em").attr("y","0").append("title").text(function(a){return persian(a.replace(new RegExp("#\\d+$"),""),t)})}b.input=a;a.title,a.chartInfo;app.chartCommons.calculateFields(a.series,b.calculatedFields);var j="undefined"!=typeof a.series?a.series.labels:[],k="undefined"!=typeof a.kpis?a.kpis.labels:[],l=a.seriesLablesCaptions,m=a.kpisLablesCaptions,n="#"+b.id,o={top:0,right:20,bottom:0,left:20},p=$(n).width(),q="small"==b.chartProp.info.chartSize?80:"medium"==b.chartProp.info.chartSize?130:"large"==b.chartProp.info.chartSize?160:"veryLarge"==b.chartProp.info.chartSize?200:130,r=!app.mobileMode,s=b.chartProp.info.openDashboard&&b.chartProp.info.openDashboard.checked,t="undefined"==typeof a.lang?!0:0==+a.lang,u=q+o.top+o.bottom,v=d3.scale.category10();b.width=p;var w=d.isProgress,x=d.showProgress,y=(d.title,function(a,b){if(!a)return",.2f";var c=a;if(!a.formatString){if(!b)return",.2f";c=b}return"custom"!=c.formatString?c.formatString:c.formatStringCustom}),z=+b.chartProp.info.stackedBar,A=3==z||2==z,B=3==z,C=+b.chartProp.info.stackedLine,D=3==C||2==C,E=3==C;if(b.editMode&&$(n).trigger("chartproperty",[k.concat(j)]),!a.result)return void $("#"+b.id).append(app.chartCommons.getError(a));for(var F=prepareData(a,b.chartProp),G=F.length<25,H=d3.scale.category10(),I=[],J=0;J<j.length;J++){var K=b.chartProp.series[j[J]];if("undefined"==typeof K){K=0==b.chartProp.series.length?{seriesColor:"#1F77B4",seriesType:"bar",formatStringCustom:",.2f",formatString:",.2f",numberFactor:"1",showValues:!1,hidden:!1,cumulative:!1,lineFace:"5,0",lineWeight:"2",lineStyle:"linear",lineType:"line-dot-area",showValueColor:"#333333"}:$.extend({},b.chartProp.series[Object.keys(b.chartProp.series)[0]]);for(var L="#1F77B4",J=0;10>J&&(L=H(J)||"#1f77b4",-1!=I.indexOf(L.toLowerCase()));J++);K.seriesColor=L,K.name=null,b.chartProp.series[j[J]]=K}K.font&&!K.datasourceType||(K.font={bold:!1,color:K.showValueColor||"#333333",italic:!1,fontSize:K.showValueFontSize||"12px",fontName:"Droid"}),I.push(K.seriesColor.toLowerCase())}d3Utils.prepareDataForBarChart(F,b,j,k,l,m);for(var M=null,J=0;J<F.length;J++){M||(M=new Array(F.length));for(var N=0;N<F[J].series.length;N++)M[J]||(M[J]=new Array(F[J].series.length)),M[J][N]=M[J][N]||{sum:null,avg:null,"var":null},F[J].series[N].prop&&F[J].series[N].prop.cumulative&&("undefined"!=typeof F[J].series[N].prop.cumulative_formula&&"sum"!=F[J].series[N].prop.cumulative_formula||(M[J][N].sum=d3.sum(F.filter(function(a,b){return J>=b}),function(a,b){return a.series[N].data})),"avg"==F[J].series[N].prop.cumulative_formula&&(M[J][N].avg=d3.mean(F.filter(function(a,b){return J>=b}),function(a,b){return a.series[N].data})),"var"==F[J].series[N].prop.cumulative_formula&&(M[J][N]["var"]=d3.variance(F.filter(function(a,b){return J>=b}),function(a,b){return a.series[N].data})))}for(var J=0;J<F.length;J++)for(var N=0;N<F[J].series.length;N++)F[J].series[N].prop&&F[J].series[N].prop.cumulative&&(F[J].series[N].data=M[J][N]["var"]||M[J][N].sum||M[J][N].avg);B&&F.forEach(function(a){var b=a.series.filter(function(a,b){return!a.prop.hidden&&"bar"==a.prop.seriesType}),c=d3.sum(b.map(function(a){return Math.abs(a.data)}));b.forEach(function(a){a.data=a.data/c*100})}),$(n).addClass("bar-line-chart");var O,P,Q=d3.select(n).append("div").attr("class","legend-bar temporal");if(O=d3.select(n).select("#sort_checkbox_btn"),P=d3.select(n).select("#sort_checkbox select"),!O[0][0]&&F.length>0){var R=Q.append("div").attr("id","sort_checkbox").attr("class","sort-checkbox");O=R.append("label").append("input").attr("type","checkbox").attr("id","sort_checkbox_btn"),R.select("label").append("span"),app.lang.translateAsync("sort",function(a){var b=$(R[0][0]).find("span");b.html(" "+a)});var P=R.append("select").on("change",function(){var a=O.property("checked");b.isSort=a,O.property("checked")&&i()}).style("margin","0 7px");k.length+j.length==1&&P.style("visibility","hidden").style("width","1px"),P.selectAll("nothings").data(F[0].series.filter(function(a,b){return!a.prop.hidden}).map(function(a){return{name:(a.prop.name||a.label).replace(/^\[measure\]/,""),value:a.label}})).enter().append("option").text(function(a){return persian(a.name,t)}).attr("value",function(a){return a.value})}if("undefined"==typeof b.chartProp.info.showSortBox||b.chartProp.info.showSortBox||$(n+" #sort_checkbox").hide(),Q.breadcrumb(a.levels,b,d,t),!a.matrix||0==a.matrix.length)return void Q.append("div").attr("class","temporal").style("font-size","0.8em").style("margin","15px").append("span").attr("class","translate").attr("data-trans-key","داده‌ای برای نمایش وجود ندارد").text("داده‌ای برای نمایش وجود ندارد");Q.legend({width:p,selector:n,data:F[0].series.filter(function(a,b){return!a.prop.hidden}).map(function(a){return{label:(a.prop.name||a.label).replace(/^\[measure\]/,""),color:a.prop.seriesColor,key:a.key}})},t);var S=d3.max(F,function(a){return d3.max(a.series.filter(function(a,b){return!a.prop.hidden}),function(a){return"kpi"==a.type?d3.max(a.data):"series"==a.type?+a.data||0:void 0})}),T=d3.min(F,function(a){return d3.min(a.series.filter(function(a,b){return!a.prop.hidden}),function(a){return"kpi"==a.type?d3.min(a.data):"series"==a.type?+a.data||0:void 0})});if(A){var U=d3.max(F,function(a){return d3.sum(a.series.filter(function(a,b){return!a.prop.hidden&&"bar"==a.prop.seriesType}),function(a){return"kpi"==a.type?d3.max(a.data):"series"==a.type?a.data>0?a.data:0:void 0})});S=U>S?U:S;var V=d3.min(F,function(a){return d3.sum(a.series.filter(function(a,b){return!a.prop.hidden}),function(a){return"kpi"==a.type?d3.min(a.data):"series"==a.type?a.data<0?a.data:0:void 0})});T=T>V?V:T}if(D){var U=d3.max(F,function(a){return d3.sum(a.series.filter(function(a,b){return!a.prop.hidden&&"line"==a.prop.seriesType}),function(a){return"kpi"==a.type?d3.max(a.data):"series"==a.type?a.data>0?a.data:0:void 0})});S=U>S?U:S;var V=d3.min(F,function(a){return d3.sum(a.series.filter(function(a,b){return!a.prop.hidden}),function(a){return"kpi"==a.type?d3.min(a.data):"series"==a.type?a.data<0?a.data:0:void 0})});T=T>V?V:T}S=Math.max(S||0,0),T=Math.min(T||0,0),T-=Math.abs(.1*T),S+=Math.abs(.1*S);var W=F[0].series.filter(function(a){return"series"==a.type&&"bar"==a.prop.seriesType&&!a.prop.hidden}).length,X=F[0].series.filter(function(a){return"series"==a.type&&"line"==a.prop.seriesType&&!a.prop.hidden;
}).length;(E&&X>0||B&&W>0)&&(S=100,T=0>T?-100:0),b.chartProp.info.yAxisMax&&(S=+b.chartProp.info.yAxisMax),b.chartProp.info.yAxisMin&&(T=+b.chartProp.info.yAxisMin);var Y=d3.select(n).append("svg").attr("class","temporal line-chart"),Z=+b.chartProp.info.xAxisLen||20;b.chartProp.info.font||(b.chartProp.info.font={bold:!1,color:"#333333",italic:!1,fontSize:"12px",fontName:"Droid"});var _=50,aa=F.length/_,ba=function(a,b){return F.length<=_?!0:(0==b&&(this.meter=0),b>=this.meter?(this.meter+=aa,!0):!1)},ca=30;if(app.dashboardLayoutVersion=app.dashboardLayoutVersion||2,2==app.dashboardLayoutVersion&&!b.editMode){var da=d3.scale.ordinal().rangeRoundBands([p-400,p],.1);da.domain(F.map(function(a){return a.label+"#"+a.index}).filter(ba));var ea=d3.svg.axis().scale(da).orient("bottom").tickFormat(function(a){var b=a.replace(new RegExp("#\\d+$"),"");return(b.length>Z?"...":"")+persian(b.substring(0,Z),t)}),fa=d3.select(n).append("svg");fa.append("g").attr("class","x axis").call(ea),fa.selectAll("g text").attr("transform","rotate(-90)").attr("x","-1em").attr("dy","0.1em").attr("y","0").attr("fill",b.chartProp.info.font.color).attr("class","axes-x-label").style("font-family",b.chartProp.info.font.fontName).style("font-size",b.chartProp.info.font.fontSize).style("font-weight",b.chartProp.info.font.bold?"bold":"normal").style("font-style",b.chartProp.info.font.italic?"italic":"normal").append("title").text(function(a){return persian(a.replace(new RegExp("#\\d+$"),""),t)});var ga=fa.node(),ha=ga.getBBox();try{ca=fa.selectAll("text")[0][1].getBBox().height}catch(ia){}var ja=$(n+" .title").outerHeight(),ka=$(n+" .legend-bar"),la="undefined"==typeof ka?0:ka.height()+ +ka.css("margin-top").replace("px","");if(fa.remove(),q=$(n).height()-ja-la-ha.height-15,!app.mobile){var ma=$("#"+b.id).parents(".chart-widget"),oa=(b.widgetSize.size_y-+ma.attr("data-sizey"))*dashboard.baseDimantion.y;q+=oa;var pa=0;0>q&&(pa=Math.floor((-q-1)/dashboard.baseDimantion.y)+1),q+=dashboard.baseDimantion.y*pa,20>q&&(q+=dashboard.baseDimantion.y,pa++),b.editMode||dashboard.gs.resize_widget(ma,b.widgetSize.size_x,+b.widgetSize.size_y+ +pa)}Y.attr("width",p).attr("height",q+ha.height+15)}var qa=d3.scale.linear().range([q+o.top,o.top]).domain([T,S]),ra=d3.svg.axis().scale(qa).orient("left").tickFormat(function(a){var c=d3.format(b.chartProp.info.formatString);return persian(c(a),t)+""});ra.ticks(Math.floor(q/22)+1);var sa=Y.append("g").attr("class","y axis").attr("transform","translate(-10,0)");sa.call(ra);var ta=sa[0][0].getBBox(),ua=p-ta.width-o.left;F=F.filter(function(a,b){return ua-2-.1*ua>b});var va=[p-ua+10,p-10],wa=.1,xa=F.length<10?1:0;sa.attr("transform","translate("+(ta.width+o.left)+",0)");var ya=$.grep(F[0].series,function(a,b){return"bar"==a.prop.seriesType&&!a.prop.hidden}),za=($.grep(F[0].series,function(a,b){return"line"==a.prop.seriesType&&!a.prop.hidden}),d3.scale.ordinal().rangeBands(va,wa,xa));za.domain(F.map(function(a){return a.label+"#"+a.index}));var Aa=d3.scale.ordinal().rangeBands([0,za.rangeBand()]).domain($.map(ya,function(a){return a.label})),Ba=d3.scale.ordinal().rangeBands(va,wa,xa);_=Math.abs(va[0]-va[1])/ca,aa=F.length/_,Ba.domain(F.map(function(a){return a.label+"#"+a.index}).filter(ba));var ea=d3.svg.axis().scale(Ba).orient("bottom").tickFormat(function(a){var b=a.replace(new RegExp("#\\d+$"),"");return(b.length>Z?"...":"")+persian(b.substring(0,Z),t)});Y.append("svg:rect").attr("class","background").style("fill","white").style("opacity","0").attr("width",ua).attr("height",+Y.attr("height")).attr("transform","translate("+(p-ua)+",0)").on("click",function(c,d){""!=a.levels&&(w()||(x(!0),b.isSort=O.property("checked"),app.chartCommons.drillDown.up(b.ChartInPageId),b.parameters={isUp:!0,chartId:b.chartId,ChartInPageId:b.ChartInPageId,notEditMode:!b.editMode},$(n).charts(chartTypes.BAR,"refreshWithData",b)))}),b.chartProp.info.horizontalLines&&Y.select(".y.axis").selectAll("g line").attr("x2",ua).attr("x1","-6").style("opacity","0.1"),Y.select(".y.axis").append("text").attr("transform","translate(0,"+o.top+") rotate(-90)").attr("y",6).attr("dy",".71em").attr("class","axes-x-label").text("");var Ca=(d3.scale.ordinal().domain([0,1,2]).range(["#eee","#ddd","#ccc"]),b.chartProp.globalvariable&&b.chartProp.globalvariable.length>0&&!b.editMode&&b.chartProp.globalvariable.filter(function(b){return b.field==a.CurrentDimName}).length>0);Y.append("g").attr("class","x axis").attr("transform","translate(0,"+(q+o.top)+")").call(ea);var Da=Y.select(".x.axis").selectAll("g text").attr("class","axes-x-label").attr("x","-1em").attr("dy","0.1em").attr("y","0").style("font-family",b.chartProp.info.font.fontName).style("font-size",b.chartProp.info.font.fontSize).attr("fill",b.chartProp.info.font.color).style("font-weight",b.chartProp.info.font.bold?"bold":"normal").style("font-style",b.chartProp.info.font.italic?"italic":"normal"),Ea=d3.max(Da[0],function(a){return a.getBBox().width}),Fa=Da[0].length*Ea,Ga=Fa>ua;Ga=!0,Ga&&Da.attr("transform","rotate(-90)"),Da.append("title").text(function(a){return persian(a.replace(new RegExp("#\\d+$"),""),t)});var Ha=function(c,d){if(b.chartProp.globalvariable&&b.chartProp.globalvariable.length>0&&!b.editMode&&(app.globalVariableHelper.updateGlobalVariables([a.CurrentDimName],[c.value],b.chartProp.globalvariable),$(n+" .gd.selected-item").attr("class",$(this).attr("class").replace("selected-item","")),$(n+" .circle.selected-item").attr("class",$(this).attr("class").replace("selected-item","")),$(this).attr("class",$(this).attr("class")+" selected-item")),""==c.onClickVal)return void(s&&!b.editMode&&app.chartCommons.openLink(b.chartProp.info.openDashboard));if(!w()){x(!0);var e=O.property("checked");b.isSort=e,app.chartCommons.drillDown.add(b.ChartInPageId,b.input.DataSourceId,b.input.CurrentDimName,c.onClickVal),b.parameters={selectedItem:c.onClickVal,chartId:b.chartId,ChartInPageId:b.ChartInPageId,notEditMode:!b.editMode},$(n).charts(chartTypes.BAR,"refreshWithData",b)}},Ia=Y.append("g").attr("class","charts"),Ja=Ia.selectAll(".gd").data(F).enter().append("g").attr("transform","translate("+za(F[0].label+"#"+F[0].index)+",0)").attr("class",function(a){return"gd "+(""!=a.onClickVal||Ca||s?" pointer":"")}).on("click",Ha),Ka={lastTexts:[],clear:function(){this.lastTexts=[]},noConfilict:function(a,b,c,d){for(var e=!0,f=0;f<this.lastTexts.length;f++){var g=this.lastTexts[f];if(e=c+za.rangeBand()/2-a/2>g.x+3||g.y-g.h-3>d||g.y<d-b-3,!e)break}return e&&(this.lastTexts.length>=5&&this.lastTexts.shift(),this.lastTexts.push({x:c+a/2,y:d,h:b})),e}};if(A){var La=F.map(function(a){return a.label+"#"+a.index}),Ma=Ja.selectAll("nothings").data(function(a){var b=a.series.filter(function(a){return"series"==a.type&&"bar"==a.prop.seriesType&&!a.prop.hidden}),c=a.series.map(function(a){return a.label}),d=a.series.map(function(a){return a.data});return f(b,d,c),b}).enter().append("g").attr("class","series").attr("transform",function(a,b){return"translate(0,0)"});qa(T)-qa(0);Ma.append("rect").attr("width",za.rangeBand()).attr("fill",function(a,b){var c=a.prop.seriesColor;return a.thenRows&&$.each(a.thenRows,function(b,d){$.each(d,function(b,d){if(a.label!=d.firstField)return!0;switch(+d.operand){case 1:c=d.secondFieldColor}})}),c}).attr("y",function(a){return qa(a.data>=0?a.data>S?S:a.data:0)}).attr("height",function(a){return a.data>0?qa(Math.max(0,T))-qa(a.data>S?S:a.data):qa(a.data<T?T:a.data)-qa(0)});var Na=[[]],Oa=Y.selectAll(".gd-text").data(F).enter().append("g").attr("transform","translate("+za(F[0].label+"#"+F[0].index)+",0)").attr("class",function(a){return"gd-text"+(""!=a.onClickVal||Ca?" pointer":"")}).on("click",Ha);Na=Oa.selectAll("nothings").data(function(a){return a.series.filter(function(a){return"series"==a.type&&"bar"==a.prop.seriesType&&!a.prop.hidden})}).enter().append("text").text(function(a){return a.prop.showValues?0==a.data?"":persian(d3.format(y(a.prop.font,a.prop))(a.data),t):""}).attr("x","1em").attr("dy","0.3em").style("font-family",function(a){return a.prop.font.fontName}).style("font-size",function(a){return a.prop.font.fontSize}).attr("fill",function(a){return a.prop.font.color}).style("font-weight",function(a){return a.prop.font.bold?"bold":"normal"}).style("font-style",function(a){return a.prop.font.italic?"italic":"normal"}).attr("y",function(a){return qa(a.data>=0?a.data>S?S:a.data:0)+(a.data>0?qa(Math.max(0,T))-qa(a.data>S?S:a.data):qa(a.data<T?T:a.data)-qa(0))/2});var Pa=-999999;Ma.forEach(function(a,b){var c=Na[b]||[],d=0,e=0,f=0;a.forEach(function(a,g){var h=c[g]||null;if(null!=h){var i=h.getBBox().width,j=za.rangeBand();f=j/2-i/2,za(La[b])+f>Pa+5?Pa=za(La[b])+i/2:h.remove()}var k=a.__data__.data,l=d3.select(a).select("rect").attr("height");k>=0?(d3.select(a).attr("transform",function(a,b){return"translate(0,"+d+")"}),null!=h&&d3.select(h).attr("transform",function(a,b){return"translate(0,"+d+")"}).attr("x",f),d-=+l):(d3.select(a).attr("transform",function(a,b){return"translate(0,"+e+")"}),null!=h&&d3.select(h).attr("transform",function(a,b){return"translate(0,"+e+")"}).attr("x",f),e+=+l)})})}else{var Ma=Ja.selectAll("nothings").data(function(a){var b=a.series.filter(function(a){return"series"==a.type&&"bar"==a.prop.seriesType&&!a.prop.hidden}),c=a.series.map(function(a){return a.label}),d=a.series.map(function(a){return a.data});return f(b,d,c),b}).enter().append("g").attr("class","series").attr("transform",function(a,b){return"translate("+Aa(a.label)+",0)"});qa(T)-qa(0);Ma.append("rect").attr("width",Aa.rangeBand()).attr("fill",function(a,b){var c=a.prop.seriesColor;return a.thenRows&&$.each(a.thenRows,function(b,d){$.each(d,function(b,d){if(a.label!=d.firstField)return!0;switch(+d.operand){case 1:c=d.secondFieldColor}})}),c}).attr("y",function(a){return qa(a.data>=0?a.data>S?S:a.data:0)}).attr("height",function(a){return a.data>0?qa(Math.max(0,T))-qa(a.data>S?S:a.data):qa(a.data<T?T:a.data)-qa(0)});var Oa=Ia.selectAll(".gd-text").data(F).enter().append("g").attr("transform","translate("+za(F[0].label+"#"+F[0].index)+",0)").attr("class",function(a){return"gd-text"+(""!=a.onClickVal||Ca?" pointer":"")}).on("click",Ha),Na=Oa.selectAll("nothings").data(function(a){return a.series.filter(function(a){return"series"==a.type&&"bar"==a.prop.seriesType&&!a.prop.hidden})}).enter().append("text").text(function(a){return a.prop.showValues?persian(d3.format(y(a.prop.font,a.prop))(a.data),t):""}).style("font-family",function(a){return a.prop.font.fontName}).style("font-size",function(a){return a.prop.font.fontSize}).attr("fill",function(a){return a.prop.font.color}).style("font-weight",function(a){return a.prop.font.bold?"bold":"normal"}).style("font-style",function(a){return a.prop.font.italic?"italic":"normal"}).style("text-anchor",app.lang.isRtl()?"start":"end").attr("x","0.3em").attr("dy","-0.3em").attr("transform",function(a,b){return"translate("+Aa(a.label)+",0)"}).attr("y",function(a){return qa(a.data>=0?a.data>S?S:a.data:0)}).attr("y",function(a){return qa(a.data>=0?a.data>S?S:a.data:0)}),La=F.map(function(a){return a.label+"#"+a.index});Na.forEach(function(a,b){a.forEach(function(a,c){var d=a.getBBox().width,e=a.getBBox().height,f=Aa.rangeBand(),g=f/2-d/2;d3.select(a).attr("x",g),Ka.noConfilict(d,e,za(La[b]),d3.select(a).attr("y"))||$(a).remove()})}),Ka.clear()}if(1==app.dashboardLayoutVersion||b.editMode){var Da=Y.select(".x.axis").selectAll("g text").attr("class","axes-x-label").attr("x","-1em").attr("transform",function(){return Ga?"rotate(-90)":"rotate(0)"}).attr("dy","0.1em").attr("y","0").style("font-family",b.chartProp.info.font.fontName).style("font-size",b.chartProp.info.font.fontSize).attr("fill",b.chartProp.info.font.color).style("font-weight",b.chartProp.info.font.bold?"bold":"normal").style("font-style",b.chartProp.info.font.italic?"italic":"normal"),ga=$(n).find(".x").first().get(0),ha=ga.getBBox();ha.height-o.bottom;Y.attr("width",p).attr("height",u+ha.height)}var Ma=Ja.selectAll("nothing").data(function(a){return a.series.filter(function(a){return"kpi"==a.type&&"bar"==a.prop.seriesType&&!a.prop.hidden})}).enter().append("g").attr("class","kpi").attr("transform",function(a,b){return"translate("+Aa(a.label)+",0)"});Ma.append("rect").attr("width",Aa.rangeBand()).attr("y",function(a){return qa(1.1*a.data[1])}).attr("height",function(a){return q+o.top-qa(1.1*a.data[1])}).attr("fill","#eee"),Ma.append("rect").attr("width",Aa.rangeBand()).attr("y",function(a){return qa(a.data[0])}).attr("height",function(a){return q+o.top-qa(a.data[0])}).attr("fill",function(a,b){return v(b)}),Ma.append("rect").attr("width",Aa.rangeBand()).attr("y",function(a){return qa(1*a.data[1])}).attr("height",function(a){return 0==a.data[1]?0:2}).attr("fill","#333");var Qa=function(a){return a>0?"#71b37c":0==a?"#8d8d8d":"#e14d57"};Ma.append("circle").attr("r",function(a){return 0==a.data[1]?0:Aa.rangeBand()/2<5?Aa.rangeBand()/2:5}).attr("fill",function(a){return Qa(a.data[1])}).attr("cx",Aa.rangeBand()/2).attr("cy",function(a){return qa(1.1*a.data[1])-(Aa.rangeBand()/2<5?Aa.rangeBand()/2:5)}),$(n+" .kpi").tipsy({gravity:"w",html:!0,title:function(){var a=+b.chartProp.info.tooltip||1,c=F.map(function(a){return a.index}).indexOf($(this).parent(".gd").get(0).__data__.index);return g(c,a,"bar",$(this).index())}}),$(n+" .series").tipsy({gravity:"w",html:!0,title:function(){var a=+b.chartProp.info.tooltip||1,c=F.map(function(a){return a.index}).indexOf($(this).parent(".gd").get(0).__data__.index),d=g(c,a,"bar",$(this).index());return d}}),$(n+" .gd-text text").tipsy({gravity:"w",html:!0,title:function(){var a=+b.chartProp.info.tooltip||1,c=F.map(function(a){return a.index}).indexOf($(this).parent(".gd-text").get(0).__data__.index);return g(c,a,"bar",$(this).index())}});var Ra=Ia.append("g"),Sa=Ia.append("g"),Ta=Ia.append("g"),Ua=Ia.append("g"),Va=h(F),Wa="linear",Xa=d3.svg.area().x(function(a){return za(a.label)+za.rangeBand()/2}).y0(q+o.top).y1(qa(T)).interpolate(Wa),Ya=d3.svg.area().x(function(a){return za(a.label)+za.rangeBand()/2}).y0(q+o.top).y1(function(a){return qa(a.value>S?S:a.value<T?T:a.value)}).interpolate(Wa),Za=d3.svg.line().x(function(a){return za(a.label)+za.rangeBand()/2}).y(function(a){return qa(T)}).interpolate(Wa),$a=d3.svg.line().x(function(a){return za(a.label)+za.rangeBand()/2}).y(function(a){return qa(a.value>S?S:a.value<T?T:a.value)}).interpolate(Wa),_a=Sa.selectAll("nothings").data(Va).enter().append("path").attr("class","area").attr("id",function(a,b){return"area"+b}).attr("fill",function(a,c){return b.chartProp.indicator&&b.chartProp.indicator.length?"url(#"+b.id+"-"+c+")":a.prop.seriesColor}).attr("z-index","-1").style("opacity",function(a){return a.prop.areaOpacity||.1}).datum(function(a){var b=a.prop.lineType;return"line-dot-area"==b||"line-area"==b?D?a.valueStacked:a.values:0});r?_a.attr("d",function(a){return 0===a?Xa:Xa.interpolate(a[0].prop.lineStyle)(a)}).transition().duration(b.animationDuration).attr("d",function(a){return 0===a?Ya:Ya.interpolate(a[0].prop.lineStyle)(a)}):_a.attr("d",function(a){return 0===a?Ya:Ya.interpolate(a[0].prop.lineStyle)(a)}),_a=Ta.selectAll("nothings").data(Va).enter().append("path").attr("class","line").attr("id",function(a,b){return"line"+b}).attr("stroke",function(a,c){return b.chartProp.indicator&&b.chartProp.indicator.length?"url(#"+b.id+"-"+c+")":a.prop.seriesColor}).attr("stroke-width",function(a,b){return a.prop.lineWeight}).attr("stroke-dasharray",function(a,b){return a.prop.lineFace}).datum(function(a){var b=a.prop.lineType;return"line-dot-area"==b||"line-dot"==b||"line-area"==b||"line"==b?D?a.valueStacked:a.values:0}),r?_a.attr("d",function(a){return 0===a?Za:Za.interpolate(a[0].prop.lineStyle)(a)}).transition().duration(b.animationDuration).attr("d",function(a){return 0===a?$a:$a.interpolate(a[0].prop.lineStyle)(a)}):_a.attr("d",function(a){return 0===a?$a:$a.interpolate(a[0].prop.lineStyle)(a)});var Ca=b.chartProp.globalvariable&&b.chartProp.globalvariable.length>0&&!b.editMode&&b.chartProp.globalvariable.filter(function(b){return b.field==a.CurrentDimName}).length>0,ab=function(c,d){if(b.chartProp.globalvariable&&b.chartProp.globalvariable.length>0&&!b.editMode&&(app.globalVariableHelper.updateGlobalVariables([a.CurrentDimName],[c.primv],b.chartProp.globalvariable),$(n+" .circle.selected-item").attr("class",$(this).attr("class").replace("selected-item","")),$(n+" .gd.selected-item").attr("class",$(this).attr("class").replace("selected-item","")),$(this).attr("class",$(this).attr("class")+" selected-item")),""==c.onClickVal)return void(s&&!b.editMode&&app.chartCommons.openLink(b.chartProp.info.openDashboard));if(!w()){x(!0),b.isSort=e,app.chartCommons.drillDown.add(b.ChartInPageId,b.input.DataSourceId,b.input.CurrentDimName,c.onClickVal),b.parameters={selectedItem:c.onClickVal,chartId:b.chartId,ChartInPageId:b.ChartInPageId,notEditMode:!b.editMode},$(n).charts(chartTypes.BAR,"refreshWithData",b);var e=O.property("checked")}};_a=Ua.selectAll("nothings").data(Va).enter().append("g").attr("class",function(a){return"circle-group "+(""!=a.onClickVal||Ca?" pointer":"")}).selectAll("circle").data(function(a){return D?a.valueStacked:a.values}).enter().append("circle").attr("class","circle").attr("stroke",function(a,b){var c=[a],d=d3.select(this.parentNode).datum().label,e=F[b].series.map(function(a){return a.label}),g=F[b].series.map(function(a){return a.data});f(c,g,e),a=c[0];var h=a.prop.seriesColor;return a.thenRows&&$.each(a.thenRows,function(a,b){$.each(b,function(a,b){if(d!=b.firstField)return!0;switch(+b.operand){case 1:h=b.secondFieldColor}})}),h}).attr("stroke-width",function(a,b){return a.prop.lineWeight}).on("click",ab).on("mouseover",function(a){d3.select(this).attr("stroke-width",parseInt(a.prop.lineWeight)+3)}).on("mouseout",function(a){d3.select(this).attr("stroke-width",a.prop.lineWeight)}).attr("cx",function(a){return $a.interpolate(a.prop.lineStyle).x()(a)}).style("opacity",function(){var a=d3.select(this.parentNode).datum().prop.lineType;return"line-area"==a||"line"==a?0:1}).attr("r","4"),r?_a.attr("cy",qa(T)).transition().duration(b.animationDuration).attr("cy",function(a){return $a.interpolate(a.prop.lineStyle).y()(a)}):_a.attr("cy",function(a){return $a.interpolate(a.prop.lineStyle).y()(a)}),Ra.attr("class","colorStepGroups").selectAll(".colorStepGroup").data(Va).enter().append("linearGradient").attr("id",function(a,c){return b.id+"-"+c}).attr("class","colorStepGroup").selectAll("stop-color").data(function(a){var b=[],c=1/(2*(a.values.length-1)),d=-1*c;return a.values.map(function(e,g){var h={value:e.value,label:a.label,color:a.prop.seriesColor},i=[h],j=F[g].series.map(function(a){return a.label}),k=F[g].series.map(function(a){return a.data});f(i,k,j),h=i[0],h.offset=0>d?0:d,b.push(h),h=$.extend({},h),d+=2*c,h.offset=d>1?d-c:d,b.push(h)}),b}).enter().append("stop").attr("stop-color",function(a,b){var c=a.color;return a.thenRows&&$.each(a.thenRows,function(b,d){$.each(d,function(b,d){if(a.label!=d.firstField)return!0;switch(+d.operand){case 1:c=d.secondFieldColor}})}),c}).attr("offset",function(a){return a.offset}),_a=Ua.selectAll("nothings").data(Va).enter().append("g").attr("class",function(a){return"text-vals"}).selectAll("text").data(function(a){return a.prop.showValues?D?a.valueStacked:a.values:0}).enter().append("text").text(function(a){return persian(d3.format(y(a.prop.font,a.prop))(a.valueLabel),t)}).attr("class","text-value pointer xxx").style("font-family",function(a){return a.prop.font.fontName}).style("font-size",function(a){return a.prop.font.fontSize}).attr("fill",function(a){return a.prop.font.color}).style("font-weight",function(a){return a.prop.font.bold?"bold":"normal"}).style("font-style",function(a){return a.prop.font.italic?"italic":"normal"}).style("text-anchor",app.lang.isRtl()?"start":"end").attr("dy","-10").attr("dy","-10").attr("x",function(a,b){var c=d3.select(this).node().getBBox().width,d=d3.select(this).node().getBBox().height,e=(za(La[b]),$a.interpolate(a.prop.lineStyle).y()(a));return Ka.noConfilict(c,d,za(La[b]),e)||d3.select(this).style("display","none"),$a.interpolate(a.prop.lineStyle).x()(a)-c/2}).on("click",ab),r?_a.attr("y",qa(T)).transition().duration(b.animationDuration).attr("y",function(a){return $a.interpolate(a.prop.lineStyle).y()(a)}):_a.attr("y",function(a){return $a.interpolate(a.prop.lineStyle).y()(a)}),$(n+" .circle").tipsy({gravity:"w",html:!0,title:function(){var a=+b.chartProp.info.tooltip||1,c="",d=$(this).index(),e=$(this).parent("g.circle-group").index();return c=g(d,a,"line",e)}}),$(n+" .text-value").tipsy({gravity:"w",html:!0,title:function(){var a=+b.chartProp.info.tooltip||1,c="",d=$(this).index(),e=$(this).parent("g.text-vals").index()-$(this).parent("g.text-vals").parent().children().length/2;return c=g(d,a,"line",e)}}),O.on("change",i),P.on("change",i);var bb=!0,cb=setTimeout(function(){b.isSort?O.property("checked",!0).each(i):O.each(i),bb=!1},0);$(n).trigger("heightChange")};var chartTypes={BAR:1,PIE:2,LINE:3,GAUGE:4,TABLE:5,MAP:6,UserControl:7,Radar:8,Tree:9,Text:10,CE_MAP:{1:"barLine",2:"pie",4:"gauge",5:"table",6:"map",7:"userControl",8:"radar",9:"tree",10:"text"},NAMES:{1:"نمودار خطی-میله‌ای",2:"نمودار دایره‌ای",4:"نمودار عقربه‌ای",5:"جدول",7:"کنترل کاربری",8:"نمودار رادار",9:"نمودار درختی",10:"متن"}};!function(a){function b(b,c,d){var e=a(this).data("settings");if("undefined"!=typeof e)return e.isRefresh=!0,e=a.extend(e,c),setTimeout(function(){g(b,e.input,e,!0,d),e.parameters.selectedItem=null,e.parameters.isUp=!1},0),this}function c(b){var c=a(this).data("ajaxRequest");return null!=c&&c.abort(),this}function d(b,c,d){d=a.extend({refreshRelatedDatasources:!0},d);var e=a(this).data("settings");if(e=a.extend(e,c),e.isRefresh=!1,"undefined"!=typeof e.chartProp){app.chartCommons.setFilterParameter(e),e.parameters.filterHierarchy=app.chartCommons.getFilterHierarchy(e.ChartInPageId),e.editMode&&(e.parameters.ChartInfo=a("#divChart").data("chartInfo"));var h=[];if(b==chartTypes.TABLE)for(var i in e.chartProp.series)e.chartProp.series.hasOwnProperty(i)&&h.push({Name:i,Type:e.chartProp.series[i].rowResult});e.dataUrl=f(b);var j=app.mobileMode?proxy.ajax:a.ajax,k=a.extend(e.parameters,{resultRows:h,type:e.dataType}),l=app.mobileMode&&!app.mobileModeTest?k:JSON.stringify(k);d.refreshRelatedDatasources&&e.ChartInPageId&&(app.moderation.dashboadpage.refreshRelatedDatasources(e.input.RefreshDatasource,[+e.ChartInPageId]),app.filterBox&&app.filterBox.refresh&&app.filterBox.refresh());var m=j({url:e.dataUrl,type:"POST",dataType:"json",contentType:"application/json",data:l,async:e.async,requestId:e.requestId,success:function(a){g(b,a,e,!0),e.parameters.selectedItem=null,e.parameters.isUp=!1}});return a(this).data("ajaxRequest",m),this}}function e(b,c){var d=a.extend({},h,c),e=a(this);d.id=e.attr("id"),d.type=b,e.data("isChart",!0),e.data("settings",d),app.chartCommons.setFilterParameter(d);var i=[];if(b==chartTypes.TABLE)for(var j in d.chartProp.series)d.chartProp.series.hasOwnProperty(j)&&i.push({Name:j,Type:d.chartProp.series[j].rowResult});d.dataUrl=f(b);var k=app.mobileMode?proxy.ajax:a.ajax;app.mobileMode&&(a.ajax=proxy.ajax);var l=a.extend(d.parameters,{resultRows:i,type:d.dataType}),m=app.mobileMode&&!app.mobileModeTest?l:JSON.stringify(l),n=k({url:d.dataUrl,type:"POST",dataType:"json",data:m,success:function(a,c,e){d.mobileModeData={isOnline:c,date:e},g(b,a,d,!1),d.parameters.selectedItem=null,d.parameters.isUp=!1},cache:!1,contentType:"application/json",error:function(b){b&&b.responseJSON&&b.responseJSON.forceSignout&&(alert("شما از برنامه خارج شده‌اید. ممکن است کاربر دیگری با نام کاربری شما وارد سیستم شده باشد."),window.location.href=app.urlPrefix);var c="#"+d.id;a(c).addClass("bar-chart").empty(),b&&b.responseJSON&&b.responseJSON.desc?a(c).addClass("bar-chart").html("<b>"+b.responseJSON.title+' </b>  <span class="glyphicon glyphicon-info-sign"> </span> <br/ > <p style="direction:ltr;">'+b.responseJSON.desc+"</p>"):a(c).addClass("bar-chart").html('خطا در دریافت اطلاعات <span class="glyphicon glyphicon-info-sign"> </span>')},requestId:d.requestId});return a(this).data("ajaxRequest",n),e}function f(a){switch(parseInt(a)){case chartTypes.UserControl:return app.urlPrefix+"api/chartdata/GetColumnMembers";case chartTypes.Tree:return app.urlPrefix+"Charts/BarChart/getTreeData";default:return app.urlPrefix+"api/chartdata/getdata"}}function g(b,c,d,e,f){if(d.editMode||dashboard.setLastRefresh(d.ChartInPageId,c.LastRefresh),d.input=c,arguments.length<4)return void a.error("تعداد پارامترها باید حداقل چهار تا باشد");if("undefined"!=typeof d.chartProp){if(d.chartProp.info.refreshPeriod&&+d.chartProp.info.refreshPeriod>0){var g=a("#"+d.id).data("timeout");g&&clearTimeout(g);var h=setTimeout(function(){a("#"+d.id).charts(b,"refreshWithData")},1e3*+d.chartProp.info.refreshPeriod);a("#"+d.id).data("timeout",h)}a("#dashboard-chart-panel").trigger("chartComplete",[d,c]);var i="#"+d.id;e&&!f?a(i).find(".temporal").remove():a(i).addClass("bar-chart").empty(),c=a.extend({EditPermission:!1,Description:"",LastRefresh:0,isFresh:!0,title:""},c);var j={title:null,showProgress:function(){},isProgress:function(){}};switch(j=d3.select(i).titlebar({EditPermission:c.EditPermission,editLink:d.editLink,RemoveFromPage:d.RemoveFromPage,deleteLink:d.removeLink,desc:c.Description,LastRefresh:c.LastRefresh,isFresh:c.isFresh,title:c.title,chartId:d.chartId,ChartInPageId:d.ChartInPageId,type:b,editMode:d.editMode,refreshWithData:e,redrowAll:f,settings:d,showFilterIcon:"undefined"==typeof d.chartProp.info.showFilterIcon?1:+d.chartProp.info.showFilterIcon}),d.titlebar=j,j.showProgress(!1),parseInt(b)){case chartTypes.BAR:app.charts.bar.draw(c,d,e,j);break;case chartTypes.GAUGE:app.charts.gauge.draw(c,d,e,j);break;case chartTypes.PIE:app.charts.pie.draw(c,d,e,j);break;case chartTypes.TABLE:app.charts.table.draw(c,d,e,j);break;case chartTypes.MAP:app.charts.map.draw(c,d,e,j);break;case chartTypes.UserControl:app.charts.userControl.draw(c,d,e,j);break;case chartTypes.Radar:app.charts.radar.draw(c,d,e,j);break;case chartTypes.Tree:app.charts.tree.draw(c,d,e,j);break;case chartTypes.Text:app.charts.text.draw(c,d,e,j)}app.lang.setLang({selector:i}),d.finishDraw&&d.finishDraw(d)}}var h={isSort:!1,fadeSpeed:200,fadeinEasing:"easeInOutCubic",chartId:-1,animationDuration:1e3,animationEase:"cubic-out"};jQuery.fn.charts=function(f,g){var h={init:e,refresh:b,refreshWithData:d,abort:c};if(h[g]){var i=Array.prototype.slice.call(arguments,0),g=i.splice(1,1);return h[g].apply(this,i)}return"object"!=typeof method&&"undefined"!=typeof method&&g?void a.Error("Method "+g+" does not exist on jQuery.sitBarChart: you must specify type"):h.init.apply(this,arguments)}}(jQuery);var app=app||{};app.charts=app.charts||{},app.charts.gauge={},app.charts.gauge.draw=function(a,b,c,d){function e(a,b){return"undefined"==typeof a?null:a[b]}function f(a,c,d){var e=5,f=d3.select(a).selectAll("nothings").data(function(a){return a.kpis}).enter().append("div").append("div");if(b.chartProp.info.showLabels){f.append("div").text(function(a,b){var d=m[b];return persian(c.label+(d?" - "+d:""),k)})}var g=f.append("div"),h=g.append("div").style("text-align","left").style("position","relative");ta=$(g[0][0]).width();var i=g.append("svg").attr("width",ta).attr("class","line-svg").attr("height",r+2*e),j=0,l=0;if(da>=0&&ca>=0)j=0,l=1.2*ca;else{var n=Math.max(Math.abs(ca),Math.abs(da));j=-1.2*n,l=1.2*n}var o=d3.scale.linear().range([0,ta]).domain([j,l]);i.append("rect").attr("height",r).attr("y",e).attr("fill",ea(0)).attr("width",ta),i.append("rect").attr("height",r).attr("y",e).attr("fill",function(a,b){return ia(a[2])}).attr("width",0).transition().duration(b.animationDuration).attr("width",function(a){return o(a[0])}),i.append("rect").attr("width","5").attr("x","0").attr("y","0").attr("height",r+e).attr("fill","#333").transition().duration(b.animationDuration).attr("x",function(a){return o(a[0])-5<j?j:o(a[0])-5}),i.append("path").attr("transform",function(a){return"translate("+(o(a[1])-5<j?j:o(a[1])-5)+",0)"}).attr("d","M0 "+e+" 0 "+(r+2*e)).attr("stroke-dasharray","2,2").attr("stroke-width","2").attr("stroke","black").attr("fill","none");var p=g.append("div").style("text-align","left").style("position","relative");h.append("div").attr("class","gauge-value").style("color",C.color).style("font-family",C.fontName).style("font-size",C.fontSize).style("font-weight",C.bold?"bold":"normal").style("font-style",C.italic?"italic":"normal").text(function(a){return persian(d3.format(C.formatString)(a[0]),k)}).style("left","0").transition().duration(b.animationDuration).style("left",function(a){var b=$(this).outerWidth(),c=o(a[0])-5-b/2;return 0>c&&(c=0),c+b>ta&&(c=ta-b),c+"px"}).tween("text",function(a){var b=ja("0",a[0]);return function(a){this.textContent=b(a)}});var q=(p.append("div").attr("class","gauge-target").text(function(a){return persian(d3.format(C.formatString+"s")(a[1]),k)}).style("left",function(a){var b=$(this).outerWidth(),c=o(a[1])-5-b/2;return 0>c&&(c=0),c+b>ta&&(c=ta-b),c+"px"}),$(h[0][0]).find(".gauge-value").outerHeight()),s=$(p[0][0]).find(".gauge-target").outerHeight();h.style("height",q+"px"),$(h[0][0]).find(".gauge-value").css("height",q+"px"),$(h[0][0]).find(".gauge-value").css("position","absolute"),p.style("height",s+"px"),$(p[0][0]).find(".gauge-target").css("height",s+"px"),$(p[0][0]).find(".gauge-target").css("position","absolute")}function g(a,c,d){var e=5,f=d3.select(a).selectAll("nothings").data(function(a){return a.kpis}).enter().append("div").style("padding","0 10px").style("margin-top","25px").style("margin-bottom","10px").attr("class","container-fluid").append("div").attr("class","row"),g="12";if(b.chartProp.info.showLabels){f.append("div").style("margin-top","40px").style("margin-bottom","7px").style("padding","0 10px").attr("class","col-md-3").text(function(a,b){var d=m[b];return persian(c.label+(d?" - "+d:""),k)});var g="9"}var h=f.append("div").style("padding","0 10px").attr("class","col-md-"+g),i=h.append("div").style("text-align","left").style("position","relative");ta=$(h[0][0]).width();var j=h.append("svg").attr("width",ta).attr("height",r+2*e),l=[];j.forEach(function(a,b){var c=a[0].__data__;l.push(d3.scale.linear().range([0,ta]).domain([c[3],c[6]]))}),j.append("rect").attr("height",r).attr("y",e).attr("fill",ha).attr("width",ta),j.append("rect").attr("height",r).attr("y",e).attr("fill",ga).attr("width",function(a,b){return l[b](a[5])}),j.append("rect").attr("height",r).attr("y",e).attr("fill",fa).attr("width",function(a,b){return l[b](a[4])}),j.append("path").attr("transform",function(a,b){var c=l[b](a[3]<a[6]?a[3]:a[6]);return"translate("+(c<l[b](a[3])?l[b](a[3]):c)+",0)"}).attr("d","M0 "+e+" 0 "+(r+2*e)).attr("stroke-dasharray","2,2").attr("stroke-width","1").attr("stroke","black").attr("fill","none").attr("class","none"),j.append("path").attr("transform",function(a,b){var c=l[b](a[6]<a[6]?a[6]:a[6]);return"translate("+(c<l[b](a[3])?l[b](a[3]):c)+",0)"}).attr("d","M0 "+e+" 0 "+(r+2*e)).attr("stroke-dasharray","2,2").attr("stroke-width","1").attr("stroke","black").attr("fill","none").attr("class","none"),j.append("path").attr("transform",function(a,b){var c=l[b](a[5]<a[6]?a[5]:a[6]);return"translate("+(c<l[b](a[3])?l[b](a[3]):c)+",0)"}).attr("d","M0 "+e+" 0 "+(r+2*e)).attr("stroke-dasharray","2,2").attr("stroke-width","1").attr("stroke","black").attr("fill","none").attr("class","none"),j.append("path").attr("transform",function(a,b){var c=l[b](a[4]<a[6]?a[4]:a[6]);return"translate("+(c<l[b](a[3])?l[b](a[3]):c)+",0)"}).attr("d","M0 "+e+" 0 "+(r+2*e)).attr("stroke-dasharray","2,2").attr("stroke-width","1").attr("stroke","black").attr("fill","none"),j.append("rect").attr("width","5").attr("x","0").attr("y","0").attr("height",r+e).attr("fill","#333").transition().duration(b.animationDuration).attr("x",function(a,b){var c=l[b](a[0]<a[6]?a[0]:a[6])-5;return c<l[b](a[3])?l[b](a[3]):c}),j.append("path").attr("transform",function(a,b){var c=l[b](a[1]<a[6]?a[1]:a[6])-5;return"translate("+(c<l[b](a[3])?l[b](a[3]):c)+",0)";
}).attr("d","M0 "+e+" 0 "+(r+2*e)).attr("stroke-dasharray","2,2").attr("stroke-width","2").attr("stroke","black").attr("fill","none");var n=h.append("div").style("text-align","left").style("position","relative").style("margin-top","-10px");i.append("span").attr("class","gauge-value").style("color",C.color).style("font-family",C.fontName).style("font-size",C.fontSize).style("font-weight",C.bold?"bold":"normal").style("font-style",C.italic?"italic":"normal").text(function(a){return persian(d3.format(C.formatString)(a[0]),k)}).style("left","0").transition().duration(b.animationDuration).style("left",function(a,b){var c=$(this).outerWidth(),d=l[b](a[0])-5-c/2;return 0>d&&(d=0),d+c>ta&&(d=ta-c),d+"px"}).tween("text",function(a){var b=ja(a[3],a[0]);return function(a){this.textContent=b(a)}}),n.append("span").attr("class","gauge-target").text(function(a){return persian(d3.format(C.formatString+"s")(a[1]),k)}).style("left",function(a,b){var c=$(this).outerWidth(),d=l[b](a[1])-5-c/2;return 0>d&&(d=0),d+c>ta&&(d=ta-c),d+"px"}),n.append("span").attr("class","gauge-target").text(function(a){return persian(d3.format(C.formatString+"s")(a[3]),k)}).style("left",function(a,b){var c=$(this).outerWidth(),d=l[b](a[3])-c/2;return 0>d&&(d=0),d+c>ta&&(d=ta-c),d+"px"}),n.append("span").attr("class","gauge-target").text(function(a){return persian(d3.format(C.formatString+"s")(a[6]),k)}).style("left",function(a,b){var c=$(this).outerWidth(),d=l[b](a[6])-c/2;return 0>d&&(d=0),d+c>ta&&(d=ta-c),d+"px"}),n.append("span").attr("class","gauge-target").text(function(a){return persian(d3.format(C.formatString+"s")(a[4]),k)}).style("left",function(a,b){var c=$(this).outerWidth(),d=l[b](a[4])-c/2;return 0>d&&(d=0),d+c>ta&&(d=ta-c),d+"px"}),n.append("span").attr("class","gauge-target").text(function(a){return persian(d3.format(C.formatString+"s")(a[5]),k)}).style("left",function(a,b){var c=$(this).outerWidth(),d=l[b](a[5])-c/2;return 0>d&&(d=0),d+c>ta&&(d=ta-c),d+"px"});var o=$(i[0][0]).find(".gauge-value").outerHeight();i.style("height",o+"px"),$(i[0][0]).find(".gauge-value").css("height",o+"px"),$(i[0][0]).find(".gauge-value").css("position","absolute");var p=$(n[0][0]).find(".gauge-target").outerHeight();n.style("height",p+"px"),$(n[0][0]).find(".gauge-target").css("height",p+"px"),$(n[0][0]).find(".gauge-target").css("position","absolute")}function h(a,c,d,e,f){i(a,c,d,e,f,function(a,d,e,f,g,h,i,j,l,o,p,q){var s=0,t=0;if(da>=0&&ca>=0)s=0,t=1.2*ca;else{var u=Math.max(Math.abs(ca),Math.abs(da));s=-1.2*u,t=1.2*u}var v=d3.scale.linear().range([f,g]).domain([s,t]),w=d3.svg.arc().innerRadius(h).outerRadius(i).startAngle(f).endAngle(g),x=d3.svg.arc().innerRadius(h).outerRadius(i).startAngle(f).endAngle(function(a){return v(a)}),y=a.append("div").style("margin-bottom","0").append("svg").attr("width",2*h+2*d).attr("height",q).append("g").attr("transform","translate("+h+","+h+")");b.chartProp.info.showLabels&&a.append("div").style("margin-bottom","10px").text(function(a,b){var d=m[b];return persian(c.label+(d?" - "+d:""),k)});var z=y.append("path").attr("d",w).attr("transform","translate("+d+","+d+")").attr("fill",ea(0)),A=(z.node().getBBox().height,y.append("path").attr("fill",function(a,b){return ia(a[2])}).attr("transform","translate("+d+","+d+")").transition().duration(b.animationDuration).attrTween("d",function(a){var b=d3.interpolate(s,a[0]);return function(a){return x(b(a))}}),y.append("g"));A.append("rect").attr("width","5").attr("transform","translate("+(d-2.5)+","+d+")").attr("height",h+e).attr("fill","#333"),A.attr("transform","rotate("+(f*(180/Math.PI)+180)+" "+d+" "+d+" )"),A.append("circle").attr("r","5").attr("cx",d).attr("cy",d),A.transition().duration(b.animationDuration).attrTween("transform",function(a){var b=v(a[0]),c=f*(180/Math.PI)+180;if(isNaN(b))e=c;else var e=v(a[0])*(180/Math.PI)+180;var g=d3.interpolate(c,e);return function(a){return"rotate("+g(a)+" "+d+" "+d+" )"}}),y.append("path").attr("d","M"+d+" "+d+" "+d+" "+(r+d+e)).attr("stroke-dasharray","2,2").attr("stroke-width","2").attr("stroke","black").attr("fill","none").attr("transform",function(a){return"rotate("+v(a[1])*(180/Math.PI)+" "+d+" "+d+")translate(0,"+(-h-e)+")"}),y.append("text").attr("class","gauge-target").attr("text-anchor","middle").attr("dy","-0.3em").text(function(a){return persian(d3.format(C.formatString)(a[1]),k)}).attr("transform",function(a){return"rotate("+v(a[1])*(180/Math.PI)+" "+d+" "+d+" )translate("+d+","+(-h+d-e)+")"});$(n+" svg > g").get(0).getBBox(),y.append("text").attr("class","gauge-value").attr("text-anchor","middle").style("fill",C.color).style("font-family",C.fontName).attr("dy","1em").style("font-size",C.fontSize).style("font-weight",C.bold?"bold":"normal").style("font-style",C.italic?"italic":"normal").text(function(a){return persian(d3.format(C.formatString)(a[0]),k)}).attr("transform","translate("+d+","+p+")").transition().duration(b.animationDuration).tween("text",function(a){var b=ja(a[3],a[0]);return function(a){this.textContent=b(a)}})})}function i(a,c,d,e,f,g){var h=d3.select(a).selectAll("nothings").data(function(a){return a.kpis}).enter().append("div").style("text-align","center"),i=35,j=10,l="small"==b.chartProp.info.chartSize?2*-Math.PI/5:"medium"==b.chartProp.info.chartSize?2*-Math.PI/4:2*-Math.PI/3,m=-1*l,n=Math.cos(l);n=-1*(n-1);var o=h.append("div").attr("class","gauge-value").style("color",C.color).style("font-family",C.fontName).style("font-size",C.fontSize).style("font-weight",C.bold?"bold":"normal").style("font-style",C.italic?"italic":"normal").text(function(a){return persian(d3.format(C.formatString)(a[0]),k)}),p=h.append("svg").append("text").attr("class","gauge-target").attr("text-anchor","middle").attr("dy","-0.3em").text(function(a){return persian(d3.format(C.formatString)("80"),k)}),q=$(o.node()).width(),s={width:$(o.node()).width(),height:$(o.node()).height()};o.remove();p.node().getBBox().height,p.node().getBBox();h.select("svg").remove();var t=b.chartProp.info.showLabels?45:0,u=(e-t-(1>n?q:q/2))/(1>n?1:n)-i,v=f/2-i;u=Math.min(u,v);var w=u,x=w-r,y=(1>n?1:n)*w,z=(1>n?1:n)*x,A=Math.cos(2*Math.PI-Math.abs(l)-Math.abs(m));A=-1*(A-1),A*=x;var B=(w+i)*(1>n?1:n),D=n>1&&A>s.width,E=i+(1>n?0:z-x);D||(E=i+(1>n?0:y-w));var F=E+s.height+w;F=Math.max(F,B),g&&g(h,i,j,l,m,w,x,n,y,z,E,F)}function j(a,c,d,e,f){i(a,c,d,e,f,function(a,d,e,f,g,h,i,j,l,n,o,p){function q(a,b,c,d){w.append("path").attr("d",function(c,d){var e=c.map(function(a,b){return u[d](a)});return v({start:e[a],end:e[b]})}).attr("fill",c).attr("transform","translate("+d+","+d+")")}function s(a){w.append("path").attr("d","M"+d+" "+d+" "+d+" "+(r+e+d)).attr("stroke-dasharray","2,2").attr("stroke-width","2").attr("stroke","black").attr("fill","none").attr("transform",function(b,c){return"rotate("+a(b,c)+" "+d+" "+d+")translate(0,"+(-h-e)+")"})}function t(a,b){w.append("text").attr("class","gauge-target").attr("text-anchor","middle").attr("dy","-0.3em").text(function(a){return persian(d3.format(C.formatString)(a[b]),k)}).attr("transform",function(b,c){return"rotate("+u[c](a(b))*(180/Math.PI)+" "+d+" "+d+")translate("+d+","+(-h+d-e)+")"})}var u=[];a.forEach(function(a,b){var c=a[0].__data__;u.push(d3.scale.linear().range([f,g]).domain([c[3],c[6]]))});var v=(d3.svg.arc().innerRadius(h).outerRadius(i).startAngle(f).endAngle(g),d3.svg.arc().innerRadius(h).outerRadius(i).startAngle(function(a){return a.start}).endAngle(function(a){return a.end})),w=(d3.svg.arc().innerRadius(h).outerRadius(i).startAngle(f).endAngle(g),a.append("div").style("margin-bottom","0").append("svg").attr("width",2*h+2*d).attr("height",p).append("g").attr("transform","translate("+h+","+h+")"));b.chartProp.info.showLabels&&a.append("div").style("margin-bottom","10px").text(function(a,b){var d=m[b];return persian(c.label+(d?" - "+d:""),k)}),q(3,4,fa,d),q(4,5,ga,d),q(5,6,ha,d);var x=w.append("g");x.append("rect").attr("width","5").attr("transform","translate("+(d-2.5)+","+d+")").attr("height",h+e).attr("fill","#333"),x.attr("transform","rotate("+(f*(180/Math.PI)+180)+" "+d+" "+d+")"),x.append("circle").attr("r","5").attr("cx",d).attr("cy",d),x.transition().duration(b.animationDuration).attrTween("transform",function(a,b){var c=u[b](a[0]<a[6]?a[0]:a[6]),e=f*(180/Math.PI)+180;if(isNaN(c))g=e;else var g=u[0](a[0]<a[6]?a[0]:a[6])*(180/Math.PI)+180;var b=d3.interpolate(e,g);return function(a){return"rotate("+b(a)+" "+d+" "+d+")"}}),s(function(a,b){return u[b](a[3])*(180/Math.PI)}),s(function(a,b){return u[b](a[6])*(180/Math.PI)}),s(function(a,b){return u[b](a[4])*(180/Math.PI)}),s(function(a,b){return u[b](a[5])*(180/Math.PI)}),t(function(a){return a[3]},3),t(function(a){return a[6]},6),t(function(a){return a[4]},4),t(function(a){return a[5]},5);w.append("text").attr("class","gauge-value").attr("text-anchor","middle").style("fill",C.color).style("font-family",C.fontName).attr("dy","1em").style("font-size",C.fontSize).style("font-weight",C.bold?"bold":"normal").style("font-style",C.italic?"italic":"normal").text(function(a){return persian(d3.format(C.formatString)(a[0]),k)}).attr("transform","translate("+d+","+o+")").transition().duration(b.animationDuration).tween("text",function(a){var b=ja(a[3],a[0]);return function(a){this.textContent=b(a)}});d3.select(w.node().parentNode).attr("height",p)})}b.input=a,app.chartCommons.calculateFields(a.series,b.calculatedFields);var k=(a.title,a.chartInfo,"undefined"==typeof a.lang?!0:0==+a.lang),l="undefined"!=typeof a.series?a.series.labels:[],m="undefined"!=typeof a.kpis?a.kpis.labels:[],n=(a.seriesLablesCaptions,a.kpisLablesCaptions,b.LabelY,"#"+b.id),o={top:95,right:20,bottom:0,left:20},p=$(n).width(),q="small"==b.chartProp.info.chartSize?220:"medium"==b.chartProp.info.chartSize?250:"large"==b.chartProp.info.chartSize?280:"veryLarge"==b.chartProp.info.chartSize?330:250,r="small"==b.chartProp.info.height?20:"medium"==b.chartProp.info.height?30:"large"==b.chartProp.info.height?40:"veryLarge"==b.chartProp.info.height?50:30,s=b.chartProp.info.openDashboard&&b.chartProp.info.openDashboard.checked;q+o.top+o.bottom,d3.scale.category10();b.width=p;var t=d.isProgress,u=d.showProgress,v=(d.title,e(b.chartProp.info.font,"formatString")||b.chartProp.info.formatString||",.2f"),w=e(b.chartProp.info.font,"formatStringCustom")||b.chartProp.info.formatString||",.2f",x=e(b.chartProp.info.font,"fontName")||"Droid",y=e(b.chartProp.info.font,"fontSize")||b.chartProp.info.fontSize||"46px",z=null!=e(b.chartProp.info.font,"italic")?e(b.chartProp.info.font,"italic"):b.chartProp.info.textItalic||!1,A=e(b.chartProp.info.font,"color")||b.chartProp.info.color||"#333333",B=null!=e(b.chartProp.info.font,"bold")?e(b.chartProp.info.font,"bold"):b.chartProp.info.textBold||!1,C={};if(C.formatString=v,C.formatStringCustom=w,C.fontName=x,C.fontSize=y,C.italic=z,C.color=A,C.bold=B,C.formatString="custom"!=C.formatString?C.formatString:C.formatStringCustom,b.editMode&&$(n).trigger("chartproperty",[l.concat(m)]),!a.result)return void $("#"+b.id).append(app.chartCommons.getError(a));var D=prepareData(a);b.chartProp.info.segmentType=b.chartProp.info.segmentType||"singleSegment";var E="singleSegment"==b.chartProp.info.segmentType,F=b.chartProp.info.value,G=b.chartProp.info.target,H=b.chartProp.info.trend,I=b.chartProp.info.status,J=b.chartProp.info.min,K=b.chartProp.info.max,L=b.chartProp.info.yellow,M=b.chartProp.info.green,N=!isNaN(F||"nan"),O=!isNaN(G||"nan"),P=!isNaN(I||"nan"),Q=!isNaN(H||"nan"),R=!isNaN(J||"nan"),S=!isNaN(K||"nan"),T=!isNaN(L||"nan"),U=!isNaN(M||"nan");$(n).css({overflow:"auto",margin:"0 -14px",padding:"0 24px"});for(var V=0;V<D.length;V++){var W=D[V],X=[];X=E?[+F,+G,+I,+H]:[+F,+G,+H,+J,+L,+M,+K];for(var Y=!1,Z=0;Z<W.series.length;Z++){var _=b.chartProp.series[l[Z]],aa=-1;aa=E?"value"!=_.type||N?"target"!=_.type||O?"status"!=_.type||P?"trend"!=_.type||Q?-1:3:2:1:0:"value"!=_.typeMs||N?"target"!=_.typeMs||O?"trend"!=_.typeMs||Q?"min"!=_.typeMs||R?"yellow"!=_.typeMs||T?"green"!=_.typeMs||U?"max"!=_.typeMs||S?-1:6:5:4:3:2:1:0,-1!=aa&&(X[aa]=W.series[Z]*+_.numberFactor,Y=!0)}(Y||0==W.kpis.length)&&W.kpis.push(X),E?(("undefined"==typeof X[0]||isNaN(X[0]))&&(X[0]=0),("undefined"==typeof X[1]||isNaN(X[1]))&&(X[1]=70),("undefined"==typeof X[2]||isNaN(X[2]))&&(X[2]=1),("undefined"==typeof X[3]||isNaN(X[3]))&&(X[3]=1)):(("undefined"==typeof X[0]||isNaN(X[0]))&&(X[0]=0),("undefined"==typeof X[1]||isNaN(X[1]))&&(X[1]=70),("undefined"==typeof X[2]||isNaN(X[2]))&&(X[2]=1),("undefined"==typeof X[3]||isNaN(X[3]))&&(X[3]=0),("undefined"==typeof X[4]||isNaN(X[4]))&&(X[4]=X[0]>0?.3*X[0]:30),("undefined"==typeof X[5]||isNaN(X[5]))&&(X[5]=X[0]>0?.7*X[0]:70),("undefined"==typeof X[6]||isNaN(X[6]))&&(X[6]=X[0]>0?1.2*X[0]:100))}var ba=d3.select(n).append("div").attr("class","legend-bar temporal");if(ba.breadcrumb(a.levels,b,d,k),!a.matrix||0==a.matrix.length)return void d3.select(n).append("div").attr("class","temporal").style("font-size","0.8em").style("margin","15px").append("span").attr("class","translate").attr("data-trans-key","داده‌ای برای نمایش وجود ندارد").text("داده‌ای برای نمایش وجود ندارد");var ca=d3.max(D,function(a){return d3.max(a.kpis,function(a){return Math.max(parseFloat(a[0]),parseFloat(a[1]))})}),da=d3.min(D,function(a){return d3.min(a.kpis,function(a){return Math.min(parseFloat(a[0]),parseFloat(a[1]))})}),ea=d3.scale.ordinal().domain([0,1,2]).range(["#eee","#ddd","#ccc"]),fa=b.chartProp.info.colorAriaOne||"#e14d57",ga=b.chartProp.info.colorAriaTwo||"#FBEE58",ha=b.chartProp.info.colorAriaThree||"#71b37c",ia=function(a){return a>0?ha:0==a?ga:fa},ja=function(a,b){var c,d,e=/^([0-9,.-]+)$/,f=d3.format(C.formatString);return c=e.exec(a),d=e.exec(b),c&&d?(a=parseFloat(c[1]),b=parseFloat(d[1])-a,function(c){var d=a+b*c;return persian(f(d),k)}):function(b){return a}},ka=q;if(2==app.dashboardLayoutVersion){var la=$(n+" .title").outerHeight(),ma=$(n+" .legend-bar"),na="undefined"==typeof ma?0:ma.height()+ +ma.css("margin-top").replace("px",""),oa=$(n).height()-la-na,pa="arc"==b.chartProp.info.style?180:85+r-(app.lang.isRtl()?30:20)+35*(D.length-1)/D.length,qa=oa/D.length,ra=pa>qa?pa:qa;ka=b.isDashboardResize?ra:b.gaugeHeight||ra,b.gaugeHeight=ka,b.drill=null,b.isDashboardResize=!1}var sa=d3.select(n).append("div").attr("class","temporal gauge-container").selectAll("nothings").data(D).enter().append("div").attr("class",function(a,b){return""!=a.onClickVal||s?"temporal pointer":"temporal"}).style("margin-top","14px").on("click",function(a,c){return""==a.onClickVal?void(s&&!b.editMode&&app.chartCommons.openLink(b.chartProp.info.openDashboard)):void(t()||(u(!0),b.drill="down",app.chartCommons.drillDown.add(b.ChartInPageId,b.input.DataSourceId,b.input.CurrentDimName,a.onClickVal),b.parameters={selectedItem:a.onClickVal,chartId:b.chartId,ChartInPageId:b.ChartInPageId},$(n).charts(chartTypes.GAUGE,"refreshWithData",b)))}),p=$(sa[0][0]).width(),ta=p;sa.each(function(a,c){switch(b.chartProp.info.style){case"arc":E?h(this,a,c,ka,p):j(this,a,c,ka,p);break;case"horizontal":E?f(this,a,c,ka,p):g(this,a,c,ka,p);break;case"circle":E?h(this,a,c,ka,p):j(this,a,c,ka,p);break;case"semiCircle":E?h(this,a,c,ka,p):j(this,a,c,ka,p);break;case"verical":E?f(this,a,c,ka,p):g(this,a,c,ka,p)}})};var app=app||{};app.charts=app.charts||{},app.charts.map={},app.charts.map.draw=function(a,b,c,d){function e(c){function d(a,b){var c=D.indexOf(a.properties.Code);coordinates=d3.mouse(d3.select(l).select(".map-container").node());var d=coordinates[0]+7,e=coordinates[1]+7;d3.select(l+" #map-tooltip ").transition().duration(200).style("opacity",.9),d3.select(l+" #map-tooltip ").html(h(c,m,a.properties.Name)).style("left",d+"px").style("top",e+"px")}function e(){d3.select(l+" #map-tooltip ").transition().duration(500).style("opacity",0)}function i(a){if(n&&!b.editMode)return void app.chartCommons.openLink(b.chartProp.info.openDashboard);var c,d,e;if(a&&F!==a){var f=z.centroid(a);c=f[0],d=f[1],e=4,F=a}else c=w/2,d=v/2,e=1,F=null;E.selectAll("path").classed("active",F&&function(a){return a===F}),E.transition().duration(750).attr("transform","translate("+w/2+","+v/2+")scale("+e+")translate("+-c+","+-d+")").style("stroke-width",1.5/e+"px")}var c=JSON.parse(c);$(l+" .temporal").remove();for(var j={},k=0,o=0;o<a.matrix.length;o++){var p=+a.series.data[o][0];j[a.matrix[o][1]]=p,k+=p}var q=$.extend({formatString:",.0f",colorStart:"#31a354",colorEnd:"#c7e9c0"},b.chartProp.series[a.series.labels[0]]),r=d3.max(a.series.data,function(a){return+a[0]}),s=d3.min(a.series.data,function(a){return+a[0]}),t=d3.interpolate(q.colorEnd,q.colorStart),u=g(l,q.colorStart,q.colorEnd,s,r,q),v=$(l).height()-$(l+" .title").outerHeight()-$(u.node()).height(),w=$(l).width();150>v&&(v=150);var x=topojson.feature(c,c.objects.map),y=d3.geo.mercator().scale(1).translate([0,0]),z=d3.geo.path().projection(y),A=z.bounds(x),B=.95/Math.max((A[1][0]-A[0][0])/w,(A[1][1]-A[0][1])/v),C=[(w-B*(A[1][0]+A[0][0]))/2,(v-B*(A[1][1]+A[0][1]))/2];y.scale(B).translate(C),z=z.projection(y);var D=a.matrix.map(function(a){return a[1]}),E=d3.select(l).append("div").style("overflow","hidden").style("position","relative").attr("class","map-container temporal").append("svg").attr("class","temporal").attr("width",w).attr("height",v).append("g");d3.select(l).append("div").attr("id","map-tooltip").attr("class","temporal"),E.selectAll("path").data(x.features).enter().append("path").attr("d",z).style("fill",function(c,d){var e=a.series.labels,g=a.series.labels.map(function(){return j[c.properties.Code]}),h=[];if(b.chartProp.indicator&&b.chartProp.indicator.forEach(function(a){var b=!0;$.each(a.ifRow,function(a,c){return f(c,g,e)?void 0:(b=!1,!1)}),b&&h.push(a.thenRow)}),h.length>0)return h[0][0].secondFieldColor;var i=j[c.properties.Code];return"undefined"==typeof i?"#eee":t(i/r)}).on("click",i).on("mousemove",d).on("mouseout",e),E.append("path").datum(topojson.mesh(c,c.objects.map,function(a,b){return!0})).attr("id","state-borders").attr("stroke",b.chartProp.info.borderColor||"#666").attr("d",z),b.chartProp.info.showName&&E.selectAll("text").data(x.features).enter().append("svg:text").text(function(a){return a.properties.Name}).attr("x",function(a){return z.centroid(a)[0]}).attr("y",function(a){return z.centroid(a)[1]}).attr("text-anchor","middle").attr("fill",b.chartProp.info.nameEditor.color||"#333").style("font-size",b.chartProp.info.nameEditor.fontSize||"9px").style("font-family",b.chartProp.info.nameEditor.fontName||"Droid").style("font-weight",b.chartProp.info.nameEditor.bold?"bold":"normal").style("font-style",b.chartProp.info.nameEditor.italic?"italic":"inherit").on("click",i).on("mousemove",d).on("mouseout",e);var F}function f(a,b,c){var d=c.indexOf(a.firstField),e=b[d],f=a.secondFieldIsText?a.secondFieldInput:b[c.indexOf(a.secondFieldSelect)];switch(e=depersian(e),f=depersian(f),isNaN(f)||(f=+f),isNaN(e)||(e=+e),+a.operand){case 1:return e==f;case 2:return e!=f;case 3:return e>f;case 4:return e>=f;case 5:return f>e;case 6:return f>=e;case 7:return e.indexOf(f)>-1;case 8:return e.indexOf(f)<=-1}}function g(c,d,e,f,g,h){if(!b.chartProp.info.showLegend)return d3.select(c).append("div");var j=d3.select(c).append("div").attr("class","legend temporal").style("text-align","left");return j.append("span").text(h.name||a.series.labels[0]).style("margin","0 7px"),j.append("span").text(persian(d3.format(h.formatString)(f||0),i)),j.append("div").style("background","-webkit-linear-gradient(to right, "+d+", "+e+")").style("background","-o-linear-gradient(to right, "+d+", "+e+")").style("background","-moz-linear-gradient(to right, "+d+", "+e+")").style("background","linear-gradient(to right, "+d+", "+e+")").style("display","inline-block").style("height","10px").style("width","100px").style("margin","0 7px"),j.append("span").text(persian(d3.format(h.formatString)(g||100),i)),j}function h(c,d,e){function f(c){return b.chartProp.series[a.series.labels[c]]}if(-1==c)return app.chartCommons.tooltip.tooltipFormatter({points:a.series.labels.map(function(b,c){return{data:"NaN",label:f(c).name||a.series.labels[c],format:f(c).formatString}}),key:e,sum:"NaN",avg:"NaN",format:",.2f"},b.chartProp.info.tooltipHeader,b.chartProp.info.tooltipFormat,i);var g=a.series.data[c];if(1==d)g=[g[0]];else if(2==d)var g=g.filter(function(a,b){return!f(b).hidden});return g=g.map(function(b,c){return{data:b,label:f(c).name||a.series.labels[c],format:f(c).formatString}}),app.chartCommons.tooltip.tooltipFormatter({points:g,key:e,sum:d3.sum(g,function(a){return a.data}),avg:d3.sum(g,function(a){return a.data})/g.length,format:g.length>0?g[0].format:",.2f"},b.chartProp.info.tooltipHeader,b.chartProp.info.tooltipFormat)}b.input=a,app.chartCommons.calculateFields(a.series,b.calculatedFields);var i=(a.title,a.chartInfo,"undefined"==typeof a.lang?!0:0==+a.lang),j="undefined"!=typeof a.series?a.series.labels:[],k="undefined"!=typeof a.kpis?a.kpis.labels:[],l="#"+b.id,m=+b.chartProp.info.tooltip||1,n=(d3.scale.category10(),d.isProgress,d.showProgress,d.title,b.chartProp.info.openDashboard&&b.chartProp.info.openDashboard.checked);if(b.editMode&&$(l).trigger("chartproperty",[k.concat(j)]),!a.result)return void $("#"+b.id).append(app.chartCommons.getError(a));if(!a.matrix||0==a.matrix.length)return void d3.select(l).append("div").attr("class","temporal").style("font-size","0.8em").style("margin","15px").append("span").attr("class","translate").attr("data-trans-key","داده‌ای برای نمایش وجود ندارد").text("داده‌ای برای نمایش وجود ندارد");var o=b.chartProp.info.map.selectedMap;"undefined"!=typeof b.map&&o==b.map.id?e(b.map.data):(d3.select(l+"").append("div").style("padding","15px").attr("class","temporal info").text("در حال بارگذاری نقشه ..."),$.get(app.urlPrefix+"Moderation/Map/Get?Id="+o,null,function(a){a.result?(b.map=a.map,b.map.id=o,e(a.map.data)):d3.select(l+" .info").text("نقشه انتخاب شده معتبر نیست. در منوی تنظیمات یک نقشه را انتخاب کنید یا نقشه‌ی مورد نظر خود را بارگذاری نمایید.")}))};var app=app||{};app.charts=app.charts||{},app.charts.pie={},app.charts.pie.draw=function(a,b,c,d){function e(a){var c=[0,0];c=d3.mouse(E.node());var d=c[0]+7,e=c[1]+7,f=(D.centroid(a),a.data.series),g=+b.chartProp.info.tooltip||1;1==g&&(f=[f[0]]),2==g&&(f=f.filter(function(a){return!a.prop.hidden})),f=f.map(function(a,c){return{data:a.data,label:a.prop.name||a.label,format:b.chartProp.info.formatString,color:a.prop.seriesColor,percentage:100*a.data/K[c]}});var h=app.chartCommons.tooltip.tooltipFormatter({points:f,key:a.data.label,sum:d3.sum(a,function(a){return a.data}),avg:d3.sum(a,function(a){return a.data})/a.length,format:a.length>0?a[0].format:",.2f"},b.chartProp.info.tooltipHeader,b.chartProp.info.tooltipFormat,l);J.html(h),J.style("opacity",1).style("left",d+"px").style("top",e+"px")}function f(a){J.transition().duration(500).style("opacity",1e-6).each("end",function(){J.style("left","0px").style("top","0px")})}b.input=a,app.chartCommons.calculateFields(a.series,b.calculatedFields);var g=(a.title,a.chartInfo,"undefined"!=typeof a.series?a.series.labels:[]),h="undefined"!=typeof a.kpis?a.kpis.labels:[],i=(b.LabelY,"#"+b.id),j=$(i).width(),k=($(i).height(),"small"==b.chartProp.info.chartSize?150:"medium"==b.chartProp.info.chartSize?200:"large"==b.chartProp.info.chartSize?250:"veryLarge"==b.chartProp.info.chartSize?400:130);b.width=j;var l="undefined"==typeof a.lang?!0:0==+a.lang,m=d.isProgress,n=d.showProgress,o=(d.title,b.chartProp.info.openDashboard&&b.chartProp.info.openDashboard.checked);if(b.editMode&&$(i).trigger("chartproperty",[h.concat(g)]),!a.result)return void $("#"+b.id).append(app.chartCommons.getError(a));$(i).addClass("pie-chart");var p=prepareData(a),q=a.seriesLablesCaptions,r=a.kpisLablesCaptions;d3Utils.prepareDataForBarChart(p,b,g,h,q,r);var s=d3.scale.category10();switch(+b.chartProp.info.colorType){case 2:s=d3.scale.category20();break;case 3:s=d3.scale.category20b();break;case 4:s=d3.scale.category20c()}var t=function(a){var b=a.series.filter(function(a){return"series"==a.type&&a.prop.main});return b.length>0?b[0].data:a.series.filter(function(a){return"series"==a.type})[0].data},u=d3.select(i).append("div").attr("class","legend-bar temporal");if(u.breadcrumb(a.levels,b,d,l),u.legend({width:j,selector:i,data:p.map(function(a,b){var c=a.series.filter(function(a){return"series"==a.type&&a.prop.main}),d=null;d=c.length>0?c[0]:a.series.filter(function(a){return"series"==a.type})[0];var e={label:a.label.replace(/^\[measure\]/,""),color:s(b)};return e})},l),app.dashboardLayoutVersion=app.dashboardLayoutVersion||2,2==app.dashboardLayoutVersion){var v=$(i+" .title").outerHeight(),w=$(i+" .legend-bar"),x="undefined"==typeof w?0:w.height()+ +w.css("margin-top").replace("px",""),y=$(i).height()-v-x;j=Math.min(y,j)-10,100>j&&(j=100)}else 1==app.dashboardLayoutVersion&&(j=k,j>300&&(j=300));var z=j,A=Math.min(j,z)/2,B=d3.layout.pie().value(t).sort(null),C=+b.chartProp.info.hole/100*A,D=d3.svg.arc().innerRadius(C).outerRadius(A),E=d3.select(i).append("div").attr("class","temporal").style("position","relative"),F=E.append("svg").attr("class","temporal").attr("width",j).attr("height",z);F.append("svg:rect").attr("class","background").style("fill","white").style("opacity","0").attr("width",j).attr("height",z).on("click",function(c,d){""!=a.levels&&(m()||(n(!0),b.parameters={isUp:!0,chartId:b.chartId,ChartInPageId:b.ChartInPageId,notEditMode:!b.editMode},app.chartCommons.drillDown.up(b.ChartInPageId),$(i).charts(chartTypes.PIE,"refreshWithData",b)))}).on("mouseout",f);var G=F.append("g").attr("transform","translate("+j/2+","+z/2+")"),H=G.datum(p).selectAll("path").data(B).enter(),I=b.chartProp.globalvariable&&b.chartProp.globalvariable.length>0&&!b.editMode&&b.chartProp.globalvariable.filter(function(b){return b.field==a.CurrentDimName}).length>0;H.append("path").attr("class",function(a,b){return""!=a.data.onClickVal||I||o?"arc pointer":" arc"}).attr("title","").attr("fill",function(a,b){return s(b)}).attr("d",D).each(function(a){this._current=a}).on("click",function(c,d){return b.chartProp.globalvariable&&b.chartProp.globalvariable.length>0&&!b.editMode&&(app.globalVariableHelper.updateGlobalVariables([a.CurrentDimName],[c.data.value],b.chartProp.globalvariable),$(i+" path.selected-item").attr("class",$(this).attr("class").replace("selected-item","")),$(this).attr("class",$(this).attr("class")+" selected-item")),""==c.data.onClickVal?void(o&&!b.editMode&&app.chartCommons.openLink(b.chartProp.info.openDashboard)):void(m()||(n(!0),app.chartCommons.drillDown.add(b.ChartInPageId,b.input.DataSourceId,b.input.CurrentDimName,c.data.onClickVal),b.parameters={selectedItem:c.data.onClickVal,chartId:b.chartId,ChartInPageId:b.ChartInPageId,notEditMode:!b.editMode},$(i).charts(chartTypes.PIE,"refreshWithData",b)))}).on("mouseover",function(a){e(a)}).on("mousemove",function(a){e(a)});var J=E.append("div").style("position","absolute").style("color","#fff").style("-moz-border-radius","5px").style("-webkit-border-radius","5px").style("border-radius","5px").style("padding","7px 15px").style("text-align","right").style("z-index","10").style("opacity","0").style("background-color","#000"),K=0==p.length?[1]:p[0].series.map(function(a,b){return d3.sum(p.map(function(a){return a.series[b].data}))});$(i).trigger("heightChange")};var app=app||{};app.charts=app.charts||{},app.charts.radar={},app.charts.radar.draw=function(a,b,c,d){b.input=a,app.chartCommons.calculateFields(a.series,b.calculatedFields);var e=(a.title,a.chartInfo,"undefined"==typeof a.lang?!0:0==+a.lang),f="undefined"!=typeof a.series?a.series.labels:[],g="undefined"!=typeof a.kpis?a.kpis.labels:[],h="#"+b.id,i={top:10,right:20,bottom:0,left:20},j=("small"==b.chartProp.info.chartSize?180:"medium"==b.chartProp.info.chartSize?250:"large"==b.chartProp.info.chartSize?400:"veryLarge"==b.chartProp.info.chartSize?600:130,b.chartProp.info.openDashboard&&b.chartProp.info.openDashboard.checked),k=$(h).width(),l=$(h).height()-i.top-i.bottom;d3.scale.category10();b.width=k;var m=d.isProgress,n=d.showProgress;d.title;if($(h).addClass("radar-chart"),b.editMode&&$(h).trigger("chartproperty",[g.concat(f)]),!a.result)return void $("#"+b.id).append(app.chartCommons.getError(a));for(var o=prepareData(a),p=0;p<o.length;p++)for(var q=0;q<o[p].series.length;q++)b.chartProp.series[f[q]].cumulative&&(o[p].series[q]+=o[p-1]?o[p-1].series[q]:0);var r=d3.select(h).append("div").attr("class","legend-bar temporal");if(r.breadcrumb(a.levels,b,d,e),!a.matrix||0==a.matrix.length)return void d3.select(h).append("div").attr("class","temporal").style("font-size","0.8em").style("margin","15px").append("span").attr("class","translate").attr("data-trans-key","داده‌ای برای نمایش وجود ندارد").text("داده‌ای برای نمایش وجود ندارد");var s=a.seriesLablesCaptions,t=a.kpisLablesCaptions;d3Utils.prepareDataForBarChart(o,b,f,g,s,t),r.legend({width:k,selector:h,data:o[0].series.filter(function(a){return!a.prop.hidden}).map(function(a){return{label:(a.prop.name||a.label).replace(/^\[measure\]/,""),color:a.prop.seriesColor}})},e);var u=$(h+" .title").outerHeight(),v=$(h+" .legend-bar"),w="undefined"==typeof v?0:v.height()+ +v.css("margin-top").replace("px","");l=$(h).height()-u-w,150>l&&(l=150);var x=function(){var c={radius:4,w:600,h:600,factor:1,factorLegend:.85,levels:6,maxValue:0,radians:2*Math.PI,opacityArea:.5,ToRight:5,TranslateX:0,TranslateY:0,ExtraWidthX:0,ExtraWidthY:0,color:d3.scale.category10()},d=d3.select(h).append("div").attr("class","temporal").style("position","relative").style("margin","0 auto").style("text-align","left"),f=o.map(function(a,b){return a.label}),g=f.length,i=0,p=d.selectAll(".axis-label").data(f).enter().append("div").text(function(a){return persian(a,e)}).attr("class","axis-label").style("width","100px").style("font-size","11px").style("padding","5px").style("text-overflow","ellipsis").style("white-space","nowrap").style("text-align",function(a,b){return i=$(this).outerHeight(),"right"});p.remove(),c.h=Math.min(l-2*i,k-200),c.w=c.h,c.maxValue=Math.max(c.maxValue,d3.max(o,function(a){return d3.max(a.series.filter(function(a,b){return!a.prop.hidden}).map(function(a){return a.data}))}));var q=c.factor*Math.min(c.w/2,c.h/2);d3.format("%");d.style("height",c.h+2*i+"px"),d.style("width",c.w+200+"px");var r=d.append("svg"),s=d.selectAll(".axis-label").data(f).enter().append("div").text(function(a){return persian(a,e)}).attr("title",function(a){return a}).attr("class","axis-label").style("position","absolute").style("width","100px").style("font-size","11px").style("padding","5px").style("text-overflow","ellipsis").style("white-space","nowrap").style("overflow","hidden").style("text-align",function(a,b){var d=c.w/2*(1-c.factor*Math.sin(b*c.radians/g)),e="right";return d>=c.w/2&&(e="left"),e}),i=0;s.style("left",function(a,b){var d=c.w/2*(1-c.factor*Math.sin(b*c.radians/g));return d>=c.w/2&&(d+=100),d+"px"}).style("top",function(a,b){var d=$(d3.select(this).node()).outerHeight();i=d;var e=c.h/2*(1-c.factor*Math.cos(b*c.radians/g));return e+=d/2,0==b&&(e=0),e+"px"});for(var t,u=i,v=r.attr("width",c.w).attr("height",c.h).style("position","absolute").style("left","100px").style("top",u+"px").append("g").attr("transform","translate("+c.TranslateX+","+c.TranslateY+")"),w=0;w<c.levels-1;w++){var x=c.factor*q*((w+1)/c.levels);v.selectAll(".levels").data(f).enter().append("svg:line").attr("x1",function(a,b){return x*(1-c.factor*Math.sin(b*c.radians/g))}).attr("y1",function(a,b){return x*(1-c.factor*Math.cos(b*c.radians/g))}).attr("x2",function(a,b){return x*(1-c.factor*Math.sin((b+1)*c.radians/g))}).attr("y2",function(a,b){return x*(1-c.factor*Math.cos((b+1)*c.radians/g))}).attr("class","line").style("stroke","grey").style("stroke-opacity","0.75").style("stroke-width","0.3px").attr("transform","translate("+(c.w/2-x)+", "+(c.h/2-x)+")")}for(var w=0;w<c.levels;w++){var x=c.factor*q*((w+1)/c.levels);v.selectAll(".levels").data([1]).enter().append("svg:text").attr("x",function(a){return x*(1-c.factor*Math.sin(0))}).attr("y",function(a){return x*(1-c.factor*Math.cos(0))}).attr("class","legend").style("font-size","10px").attr("dy","1em").attr("transform","translate("+(c.w/2-x+c.ToRight)+", "+(c.h/2-x)+")").attr("fill","#737373").text(persian(d3.format(b.chartProp.info.formatString)((w+1)*c.maxValue/c.levels),e));
}var y=v.selectAll(".axis").data(f).enter().append("g").attr("class","axis");y.append("line").attr("x1",c.w/2).attr("y1",c.h/2).attr("x2",function(a,b){return c.w/2*(1-c.factor*Math.sin(b*c.radians/g))}).attr("y2",function(a,b){return c.h/2*(1-c.factor*Math.cos(b*c.radians/g))}).attr("class","line").style("stroke","grey").style("stroke-width","1px"),series=0,o[0].series.forEach(function(a,b){a.prop.hidden||(dataValues=[],v.selectAll(".nodes").data(o,function(a,d){dataValues.push([c.w/2*(1-parseFloat(Math.max(a.series[b].data,0))/c.maxValue*c.factor*Math.sin(d*c.radians/g)),c.h/2*(1-parseFloat(Math.max(a.series[b].data,0))/c.maxValue*c.factor*Math.cos(d*c.radians/g))])}),dataValues.push(dataValues[0]),v.selectAll(".area").data([dataValues]).enter().append("polygon").attr("class","radar-chart-serie"+series).style("stroke-width","2px").style("stroke",o[0].series[b].prop.seriesColor).attr("points",function(a){for(var b="",d=0;d<a.length;d++)b=b+c.w/2+","+c.h/2+" ";return b}).style("fill",function(a,c){return o[0].series[b].prop.seriesColor}).style("fill-opacity",c.opacityArea).on("mouseover",function(a){z="polygon."+d3.select(this).attr("class"),v.selectAll("polygon").transition(200).style("fill-opacity",.1),v.selectAll(z).transition(200).style("fill-opacity",.7)}).on("mouseout",function(){v.selectAll("polygon").transition(200).style("fill-opacity",c.opacityArea)}).transition(500).attr("points",function(a){for(var b="",c=0;c<a.length;c++)b=b+a[c][0]+","+a[c][1]+" ";return b}),series++)}),series=0;var A=b.chartProp.globalvariable&&b.chartProp.globalvariable.length>0&&!b.editMode&&b.chartProp.globalvariable.filter(function(b){return b.field==a.CurrentDimName}).length>0;o[0].series.forEach(function(d,f){d.prop.hidden||(v.selectAll(".nodes").data(o).enter().append("svg:circle").attr("class",function(a){return"radar-chart-serie"+series+" "+(""!=a.onClickVal||A||j?" pointer":"")}).attr("r",c.radius).attr("alt",function(a){return d3.format(b.chartProp.info.formatString)(a.series[f].data)}).attr("cx",function(a,b){return c.w/2}).attr("cy",function(a,b){return c.h/2}).attr("data-id",function(a){return a.axis}).style("fill","#fff").style("stroke",o[0].series[f].prop.seriesColor).style("stroke-width","2px").on("click",function(c,d){return b.chartProp.globalvariable&&b.chartProp.globalvariable.length>0&&!b.editMode&&(app.globalVariableHelper.updateGlobalVariables([a.CurrentDimName],[c.value],b.chartProp.globalvariable),$(h+" circle.selected-item").attr("class",$(this).attr("class").replace("selected-item","")),$(this).attr("class",$(this).attr("class")+" selected-item")),""==c.onClickVal?void(j&&!b.editMode&&app.chartCommons.openLink(b.chartProp.info.openDashboard)):void(m()||(n(!0),b.parameters={selectedItem:c.onClickVal,chartId:b.chartId,ChartInPageId:b.ChartInPageId,notEditMode:!b.editMode},app.chartCommons.drillDown.add(b.ChartInPageId,b.input.DataSourceId,b.input.CurrentDimName,c.onClickVal),$(h).charts(chartTypes.Radar,"refreshWithData",b)))}).on("mouseover",function(a){newX=parseFloat(d3.select(this).attr("cx")),newY=parseFloat(d3.select(this).attr("cy")),t.style("left",newX+105+"px").style("top",newY-5+"px").html(a.label+"<br/><b>"+a.series[f].label+": </b>"+persian(d3.format(b.chartProp.info.formatString)(a.series[f].data),e)).transition(200).style("opacity",1);var c=($(t[0][0]).width(),$(t[0][0]).height());t.style("top",newY+c/2+"px"),z="polygon."+d3.select(this).attr("class"),v.selectAll("polygon").transition(200).style("fill-opacity",.1),v.selectAll(z).transition(200).style("fill-opacity",.7)}).on("mouseout",function(){t.transition(200).style("opacity",0).each("end",function(){t.style("left",0).style("top",0)}),v.selectAll("polygon").transition(200).style("fill-opacity",c.opacityArea)}).transition(500).attr("cx",function(a,b){return c.w/2*(1-Math.max(a.series[f].data,0)/c.maxValue*c.factor*Math.sin(b*c.radians/g))}).attr("cy",function(a,b){return c.h/2*(1-Math.max(a.series[f].data,0)/c.maxValue*c.factor*Math.cos(b*c.radians/g))}),series++)}),t=d.append("div").attr("class","tooltip").style("position","absolute").style("color","#fff").style("-moz-border-radius","5px").style("-webkit-border-radius","5px").style("border-radius","5px").style("padding","7px 15px").style("text-align","right").style("z-index","1000").style("opacity","0").style("background-color","#000").style("max-width","200px").style("opacity",0).style("font-size","13px")};x(),$(h).trigger("heightChange")};var app=app||{};app.charts=app.charts||{},app.charts.table={},app.charts.table.draw=function(a,b,c,d){function e(b){var c=Math.ceil(a.nonPivotMatrixLength/a.TableInfo.Limit),d=5;if(1!=c){d>c&&(d=c);for(var e=b-Math.ceil(d/2)>0,f=b+Math.ceil(d/2)<c,h=e?f?b-Math.ceil(d/2)+1:c-d+1:1,i="",j=0;d>j;j++)i+="<a  "+(h+j==b?'class="active item"':'class="item"')+' value="'+(h+j)+'">'+(h+j)+"</a>";""!=i&&$(v+" .table-body").append('<div  class="ui borderless pagination menu attached  " style="">                        <a  '+(e?'class="item"':'class="disabled item"')+' value="1" style="border-right:1px solid #d4d4d5; border-radius:0;">&laquo;</a>                        '+i+"                        <a  "+(f?'class="item"':'class="disabled item"')+' value="'+c+'">&raquo;</a>                    </ul>'),$(v+" .table-body .pagination a").on("click",function(){var a=$(this).attr("value");g(parseInt(a))})}}function f(c,d,f){$(c+" .table-body").empty();var g=d3.select(c+" .table-body").style(app.mobileMode?{overflow:"hidden"}:{overflow:"hidden"}).append("div").attr("id","tablescroll").append("table").attr("class"," ui celled table unstackable small table-chart"+G+(b.chartProp.info.condensed?"table-condensed":"")),i=g.append("thead").style("background-color","white").append("tr"),j=g.append("tbody").selectAll("nothing").data(d).enter().append("tr").attr("class","pointer");b.chartProp.globalvariable&&b.chartProp.globalvariable.length>0&&!b.editMode&&j.on("click",function(a){$(c+" .selected-item").removeClass("selected-item"),$(this).addClass("selected-item")});var l=a.Dimentions.Hierarchies.concat(a.Dimentions.SeriesLevel||[]),n=j.selectAll("nothing").data(function(a){return a}).enter().append("td").style("font-weight",function(a,b){return U[b].prop.textBold?"bold":"normal"}).style("font-style",function(a,b){return U[b].prop.textItalic?"italic":"normal"}).style("font-size",function(a,b){return U[b].prop.fontSize}).style("text-align",function(a,b){return U[b].prop.textAlign}).style("color",function(a,b){return U[b].prop.color}).style("display",function(a,b){return U[b].prop.isHidden?"none":"auto"}).attr("data-value",function(a){return a}).on("click",function(b,c){h.call(this,b,c,l,a.nonPivotMatrix)});n.each(function(a,b){var c=isNaN(a);c||(a*=+U[b].prop.numberFactor);var d=a;c||(d=d3.format(U[b].prop.formatString)(a));var e=U[b].prop.isHtml,f=persian(d,B&&!e);e?d3.select(this).html(f):d3.select(this).text(f)});var p=!1,s=U.map(function(a){return a.key});a.resultRows.sort(function(a,b){var c=s.indexOf(a.Name),d=s.indexOf(b.Name);return d>c?-1:c>d?1:0});var u=g.select("tbody").append("tr").selectAll("nothing").data(a.resultRows).enter().append("td").style("font-weight","bold").style("display",function(a,b){return U[b].prop.isHidden?"none":"auto"}).text(function(a,b){if(""==a.Value||null==a.Value)return"";var c=isNaN(a.Value),d=a.Value,e=q(a.Name);return c||3==+a.Type||(d=+a.Value*+e.numberFactor),c||(d=d3.format(e.formatString)(d)),persian(d,B)}),v=d3.select(c+" .table-body").append("div").attr("class","table-footer").append("table").attr("class"," ui celled table unstackable small table-chart"+G+(b.chartProp.info.condensed?"table-condensed":"")).append("thead").append("tr").selectAll("nothing").data(a.resultRows).enter().append("th").style("width","1px").style("display",function(a,b){return U[b].prop.isHidden?"none":"auto"}).style("font-weight",function(a,b){return U[b].prop.textBold?"bold":"normal"}).style("font-style",function(a,b){return U[b].prop.textItalic?"italic":"normal"}).style("font-size",function(a,b){return U[b].prop.fontSize}).style("text-align",function(a,b){return U[b].prop.textAlign}).style("color",function(a,b){return U[b].prop.color}).text(function(a,b){if(""==a.Value||null==a.Value)return"";p=!0;var c=isNaN(a.Value),d=a.Value,e=q(a.Name);return c||3==+a.Type||(d=+a.Value*+e.numberFactor),c||(d=d3.format(e.formatString)(d)),persian(d,B)}),w=d3.select(c+" .table-body").insert("div","#tablescroll").attr("class","header-table").append("table").attr("class"," ui celled table unstackable small table-chart"+G+(b.chartProp.info.condensed?"table-condensed":"")),x=w.append("thead").style("background-color","white").append("tr");o(U,x,w,{sort:function(d,e,f){if(!z()){A(!0);var g=a.TableInfo;if(null==g.Order)g.Order=[{Index:d,DescType:1}];else{for(var h=!1,i=0;i<g.Order.length;i++){var j=g.Order[i];if(j.Index==d){var k={Index:d,DescType:0==j.DescType?1:1==j.DescType?2:1};g.Order.splice(i,1);g.Order.push(k),h=!0;break}}h||g.Order.push({Index:d,DescType:1})}$.extend(b.parameters,{TableInfo:g,notEditMode:!b.editMode}),b.editMode&&$(c).trigger("tableInfo",[{TableInfo:g}]),$(c).charts(chartTypes.TABLE,"refreshWithData",b,{refreshRelatedDatasources:!1})}},filter:function(){var d=r();if(!z()){A(!0);var e=a.TableInfo;e.Filter=d.map(function(a,b){return a.value=depersian(a.value,B),RegExp(/^[\d,]+$/).test(a.value)&&(a.value=a.value.replace(/,/g,"")),{Index:b,FilterType:a.type,FilterParameter:a.value}}),e.Page=1,b.TableInfo=e,$.extend(b.parameters,{TableInfo:e,notEditMode:!b.editMode}),$(c).charts(chartTypes.TABLE,"refreshWithData",b,{refreshRelatedDatasources:!1})}},filterclear:function(d){$(c+" #filterbox-"+d+" input").val("");var e=r();if(!z()){A(!0);var f=a.TableInfo;f.Filter=e.map(function(a,b){return{Index:b,FilterType:a.type,FilterParameter:a.value}}),f.Page=1,b.TableInfo=f,$.extend(b.parameters,{TableInfo:f}),$(c).charts(chartTypes.TABLE,"refreshWithData",b,{refreshRelatedDatasources:!1})}}}),d3.select(x[0][0]).selectAll("th").style("width","1px"),da&&0!=da.length||g.select("tbody").append("tr").append("td").attr("colspan",U.length).append("div").style("font-size","0.8em").append("span").attr("class","translate").attr("data-trans-key","داده‌ای برای نمایش وجود ندارد").text("داده‌ای برای نمایش وجود ندارد");var y=j[0];if(y.forEach(function(a,b){m(a.__data__,U,a)}),o(U,i,g,{sort:function(){},filter:function(){},filterclear:function(){}}),e(f),$(c).trigger("heightChange"),b.chartProp.info.showRowNumber&&D){var C=(a.TableInfo.Page-1)*a.TableInfo.Limit+1;j.insert("td","td").text(function(a,b){return persian(C+b,B)}).style("text-align","right"),d3.select(u.node().parentNode).insert("td","td"),x.insert("th","th").text("ردیف"),i.insert("th","th").text("ردیف"),d3.select(c+" .table-body .table-footer tr").insert("th","th").style("width","1px"),v=d3.selectAll(c+" .table-body .table-footer tr th"),u=d3.select(u.node().parentNode).selectAll("td")}k(j,i,x,v,p,u),$(c).trigger("heightChange");var E=$(c).data("filterbox");t(E)}function g(c){if(!z()){A(!0);var d=$.extend({},a.TableInfo);d.Page=c,d.IsPageValid=!0,$.extend(b.parameters,{TableInfo:d,notEditMode:!b.editMode}),$(v).charts(chartTypes.TABLE,"refreshWithData",b,{refreshRelatedDatasources:!1}),b.parameters.TableInfo.IsPageValid=!1}}function h(c,d,e,f){var g=[],h="",i=$(this).hasClass("selected-item");if("undefined"==typeof b.chartProp.info.selectable&&(b.chartProp.info.selectable="multi"),"none"!=b.chartProp.info.selectable){if(b.chartProp.info.rowAsKey&&b.chartProp.info.rowKey){if(d=e.indexOf(b.chartProp.info.rowKey),-1==d)return;"one"==b.chartProp.info.selectable&&$(v+" .selected-item").removeClass("selected-item"),i?$(this).parents("tr").find("td").removeClass("selected-item"):$(this).parents("tr").find("td").addClass("selected-item")}else"one"==b.chartProp.info.selectable&&$(v+" td:nth-child("+(d+1)+").selected-item").removeClass("selected-item"),i?$(this).removeClass("selected-item"):$(this).addClass("selected-item");var j=d+1+(b.chartProp.info.showRowNumber?1:0),g=$(v+" td:nth-child("+j+").selected-item").map(function(){var a=$(this).parents("tr").index();return f[a][d]}).toArray();if(h=e[d],g=g.filter(function(a,b){return g.indexOf(a)==b}),!b.editMode){var f={Id:-1,Values:g,VariableType:0,dimensionName:h,datasourceId:a.DataSourceId,chartInPageId:b.ChartInPageId,chartId:a.chartId};app.moderation.dashboadpage.selectValueOnChart(f,a.RefreshDatasource)}}}function i(){var a=document.createElement("p");a.style.width="100%",a.style.height="200px";var b=document.createElement("div");b.style.position="absolute",b.style.top="0px",b.style.left="0px",b.style.visibility="hidden",b.style.width="200px",b.style.height="150px",b.style.overflow="hidden",b.appendChild(a),document.body.appendChild(b);var c=a.offsetWidth;b.style.overflow="scroll";var d=a.offsetWidth;return c==d&&(d=b.clientWidth),document.body.removeChild(b),c-d}function j(a){return $(a).get(0).scrollHeight>$(a).height()}function k(a,c,d,e,f,g){function h(){var a=document.createElement("div");a.style.visibility="hidden",a.style.width="100px",a.style.msOverflowStyle="scrollbar",document.body.appendChild(a);var b=a.offsetWidth;a.style.overflow="scroll";var c=document.createElement("div");c.style.width="100%",a.appendChild(c);var d=c.offsetWidth;return a.parentNode.removeChild(a),b-d}function k(){$(v+" .header-table").css("-ms-transform","translate3d("+(-q+$(v+" #tablescroll").scrollLeft())+"px,0px,0px)"),$(v+" .table-footer").css("-ms-transform","translate3d("+(-q+$(v+" #tablescroll").scrollLeft())+"px,0px,0px)"),$(v+" .header-table").css("-webkit-transform","translate3d("+(q-$(v+" #tablescroll").scrollLeft())+"px,0px,0px)"),$(v+" .table-footer").css("-webkit-transform","translate3d("+(q-$(v+" #tablescroll").scrollLeft())+"px,0px,0px)"),$(v+" .header-table").css("-moz-transform","translate3d("+-$(v+" #tablescroll").scrollLeft()+"px,0px,0px)"),$(v+" .table-footer").css("-moz-transform","translate3d("+-$(v+" #tablescroll").scrollLeft()+"px,0px,0px)")}var l=a[0][0];$(v).parents(".ui.card").width();$(l).find("td").each(function(b,f){var g=e[0][b],h=d3.select(d[0][0]).selectAll("th"),i=h[0][b],j=d3.select(c[0][0]).selectAll("th"),k=(j[0][b],$(f).outerWidth()),l=($(f).width(),$(f).css("padding-top")),m=$(f).css("padding-left"),n=$(f).css("padding-right"),o=$(f).css("padding-bottom"),p=function(a){a.css("width",k+"px"),a.css("max-width",k+"px"),a.css("min-width",k+"px"),a.css("padding-top",l),a.css("padding-left",m),a.css("padding-right",n),a.css("padding-bottom",o)};p($(g)),p($(a[0]).map(function(a,c){return $(c).find("td")[b]})),p($(i))}),c.remove(),f||$(v+" .table-footer").remove(),g.remove();var m=$(l).outerWidth();$(v+" table").css("width",m+"px"),$(v+" table").css("max-width",m+"px");var n=h(),o=n+$(v+" .header-table table th:last-child").outerWidth();$(v+" .header-table table th:last-child").css({"min-width":o+"px","max-width":o+"px",width:o+"px"}),o=n+$(v+" .table-footer table th:last-child").outerWidth(),$(v+" .table-footer table th:last-child").css({"min-width":o+"px","max-width":o+"px",width:o+"px"});var p=0;j($(v+" #tablescroll"))&&(p=i());var q=$(v+" #tablescroll").scrollLeft();if($(v+" #tablescroll").on("scroll",k),k(),2==app.dashboardLayoutVersion&&!b.editMode){var r=$(v+" .table-body").get(0).scrollWidth>$(v+" .table-body").innerWidth()?15:0;r=0;var s=0;try{s=$(v+" .pagination").height()+ +$(v+" .pagination").css("margin-top").replace("px","")}catch(t){}}}function l(a,b,c){var d=c.indexOf(a.firstField),e=b[d],f=a.secondFieldIsText?a.secondFieldInput:b[c.indexOf(a.secondFieldSelect)];switch(e=depersian(e),f=depersian(f),isNaN(f)||(f=+f),isNaN(e)||(e=+e),+a.operand){case 1:return e==f;case 2:return e!=f;case 3:return e>f;case 4:return e>=f;case 5:return f>e;case 6:return f>=e;case 7:return e.indexOf(f)>-1;case 8:return e.indexOf(f)<=-1}}function m(a,c,d){var e=c.map(function(a){return a.key});b.chartProp.indicator&&b.chartProp.indicator.forEach(function(b){var c=!0;if($.each(b.ifRow,function(b,d){return l(d,a,e)?void 0:(c=!1,!1)}),c){var f=$(d).find("td");$.each(b.thenRow,function(a,b){var c=e.indexOf(b.firstField),d=$(f[c]);switch(+b.operand){case 1:d.css("color",b.secondFieldColor);break;case 2:d.append(' <span class="'+b.secondFieldIcon+'"> </span> ');break;case 3:d.css("background-color",b.secondFieldBackColor);break;case 4:var g=+b.secondFieldStyle;1==g&&(d.css("font-weight","normal"),d.css("font-style","normal")),2!=g&&4!=g||d.css("font-weight","bold"),3!=g&&4!=g||d.css("font-style","italic"),5==g&&d.css("text-decoration","underline");break;case 5:d.text(b.secondFieldReplace)}})}})}function n(a,b,c){var d=$(b),e=d.data("sort");c.sort(function(b,c){return"undefined"!=typeof b.label&&(b=[b.label].concat(b.series),c=[c.label].concat(c.series)),"undefined"!=typeof e&&e?(d.data("sort",!1),/^[0-9.]+$/.test(b[a])?d3.descending(+b[a],+c[a]):d3.descending(b[a],c[a])):(d.data("sort",!0),/^[0-9.]+$/.test(b[a])?d3.ascending(+b[a],+c[a]):d3.ascending(b[a],c[a]))})}function o(a,c,d,e){if(D){var f=c.selectAll("nothing").data(a).enter().append("th").html(function(a,b){var c="";c='<div class="ui  dropdown " id="filterbox-'+b+'"><i class="table-filter-icon filter icon"></i><div class="menu"><div class="ui left icon input mini"><i class="search icon"></i><input type="text" name="search" placeholder="جستجو"></div><div class="item"></div>';return'<div class="inline header-text" style="white-space:initial;">'+persian(a.prop.name||a.value,B).replace(/^\[measure\]/,"")+"</div>"+c}).attr("class","pointer hover-show-glyph").style("white-space","nowrap").style("text-align",function(a,b){return a.prop.textAlign}).style("display",function(a,b){return a.prop.isHidden?"none":"auto"}),g=0;f[0].forEach(function(a,b){if(g+=+$(a).width(),130>g||0==b){var c=$(a).find(".dropdown-menu-right");c.removeClass("dropdown-menu-right"),c.addClass("dropdown-menu-left")}}),d.selectAll("thead th").each(function(a,c){d3.select(this).select("div").on("click",function(){e.sort(c,this,S),b.editMode&&v&&$(v).trigger("legendClick",[a.label,c,a])})}),d.selectAll("thead th").each(function(a,b){$(this).find("input").keyup(function(a){13==a.keyCode&&e.filter()})}),d.selectAll("thead th").each(function(a,b){$(this).find(".btn-default").on("click",function(){e.filterclear(b)})}),d.selectAll("thead th").each(function(a,b){$(this).find(".dropdown").on("shown.bs.dropdown",function(){$(this).find("input").focus()})});for(var h=0;h<a.length;h++)d3.select(v+" #filterbox-"+h+" select").on("click",function(a){d3.event.stopPropagation()}),d3.select(v+" #filterbox-"+h+" input").on("click",function(a){d3.event.stopPropagation()}),$(v+" #filterbox-"+h+" input").mousedown(function(a){3==a.which&&(a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation())}),$(v+" #filterbox-"+h).on("keypress",function(a){13===a.keyCode&&(a.preventDefault(),$(this).find(".btn-primary").click())});b.editMode||$(v).find(".ui.dropdown").dropdown()}}function p(a){return a>=I.seriesLabels.length&&(a=I.seriesLabels.length-1),I.seriesLabels[a].prop}function q(a){try{return b.chartProp.series[a]||b.chartProp.series["default"]}catch(c){return{numberFactor:"1",textAlign:"right",formatString:",.2f",fontSize:"1em",textItalic:!1,textBold:!1,color:"#000000",rowResult:"0",isHidden:!1}}}function r(){for(var a=[],b=$(v+" table thead th input"),c=0;c<b.length;c++){if(value=$(v+" #filterbox-"+c+" input").val(),type=$(v+" #filterbox-"+c+" select").val()||1,null==type)return;"undefined"!=typeof value&&null!=value&&""!=value&&($(v+" #filterbox-"+c+" .glyphicon-filter").addClass("show"),d3.select(v+" #filterbox-"+c+" select").on("click",function(a){d3.event.stopPropagation()}),d3.select(v+" #filterbox-"+c+" input").on("click",function(a){d3.event.stopPropagation()}),$(v+" #filterbox-"+c+" input").mousedown(function(a){3==a.which&&(a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation())})),a.push({value:value,type:type})}return $(v).data("filterbox",a),a}function s(){var a=r();"undefined"!=typeof S&&S.style("display",function(b){"undefined"!=typeof b.label&&(b=[b.label].concat(b.series));var c=u(b,a);return c?null:"none"}),b.editMode&&$(v).trigger("tableInfo",[{TableInfo:aa}])}function t(a,b){if("undefined"!=typeof a){for(var c=!1,d=0;d<a.length;d++)"undefined"!=typeof a[d].value&&""!=a[d].value&&(c=!0),$(v+" #filterbox-"+d+" input").val(a[d].value),_.isEmpty(a[d].value)||$(v+" #filterbox-"+d+" .table-filter-icon").addClass("fill"),$(v+" #filterbox-"+d+" select").val(a[d].type);c&&!b&&s()}}function u(a,b){for(var c=!0,d=0;d<b.length;d++)if(parameter=b[d].value,parameter=depersian(parameter),parameter=RegExp(/^[\d,\s]+$/).test(parameter)?+parameter.replace(/,/g,""):parameter,type=b[d].type,"undefined"!=typeof parameter&&""!=parameter)switch(+type){case 1:a[d];c=c&&-1!=a[d].indexOf(parameter);break;case 6:a[d];c=c&&-1==a[d].indexOf(parameter);break;case 2:c=c&&(parseFloat(a[d])||0)==parameter;break;case 3:c=c&&(parseFloat(a[d])||0)>parameter;break;case 4:c=c&&(parseFloat(a[d])||0)<parameter;break;case 5:var e=parameter.split(",");"undefined"!=e&&(c=c&&(parseFloat(a[d])||0)>e[0]&&(parseFloat(a[d])||0)<e[1])}return c}var v="#"+b.id,w={top:10,right:20,bottom:0,left:20},x=$(v).width(),y="small"==b.chartProp.info.chartSize?170:"medium"==b.chartProp.info.chartSize?300:"large"==b.chartProp.info.chartSize?400:"veryLarge"==b.chartProp.info.chartSize?500:250;y+w.top+w.bottom;b.width=x;var z=d.isProgress,A=d.showProgress,B=(d.title,"undefined"==typeof a.lang?!0:0==+a.lang),C=b.chartProp.info.openDashboard&&b.chartProp.info.openDashboard.checked,D="undefined"!=typeof b.chartProp.info.showHeader?b.chartProp.info.showHeader:!0;if($(v).addClass("table-chart-container"),$(v).parents(".content").addClass("hidden-overflow"),b.editMode&&$(v).addClass("edit-mode"),2==app.dashboardLayoutVersion&&!b.editMode){var E=$(v+" .title").outerHeight(),F=$(v).height()-E;y=F}"undefined"==typeof b.chartProp.info.stripped&&(b.chartProp.info.stripped=!0),"undefined"==typeof b.chartProp.info.hover&&(b.chartProp.info.hover=!0);var G=(b.chartProp.info.bordered?" table-bordered":"")+(b.chartProp.info.stripped?" table-striped":"")+(b.chartProp.info.hover?" table-hover":"")+" ";if(+a.isPivot>-1){b.input=a,app.chartCommons.calculateFields(a.series,b.calculatedFields);var H=a.chartInfo,I=("undefined"!=typeof a.series?a.series.labels:[],"undefined"!=typeof a.kpis?a.kpis.labels:[],d3Utils.convertToKeyValue(a));I.seriesLabels=I.seriesLabels.map(function(a){return a.prop=q(a.key),a});var J=I.seriesLabels.map(function(a){return a.key}),K=I.seriesLabels.map(function(a){return a.value});b.LabelY,d3.scale.category10();if(b.editMode&&$(v).trigger("chartproperty",[J.concat(H.hierarchyLabels)]),!a.result)return void $("#"+b.id).append(app.chartCommons.getError(a));var L=prepareData(a,null,!0);if(a.levels&&a.levels.length>0){var M=d3.select(v).append("div").attr("class","legend-bar temporal");M.breadcrumb(a.levels,b,d,B)}if(2==app.dashboardLayoutVersion&&!b.editMode){var N=$(v+" .legend-bar"),O=N.css("margin-top"),P=(O?+N.css("margin-top").replace("px",""):0,"undefined"==typeof N?0:N.height()+0);y-=P}if(!a.matrix||0==a.matrix.length)return void d3.select(v).append("div").attr("class","temporal").style("font-size","0.8em").style("margin","15px").append("span").attr("class","translate").attr("data-trans-key","داده‌ای برای نمایش وجود ندارد").text("داده‌ای برای نمایش وجود ندارد");var Q=d3.select(v).append("div").attr("class","temporal table-body").style(app.mobileMode?{overflow:"hidden"}:{overflow:"hidden"}).append("div").attr("id","tablescroll").append("table").attr("class"," ui celled table unstackable unstackable small table-chart"+G+(b.chartProp.info.condensed?"table-condensed":"")),R=Q.append("thead").style("background-color","white").append("tr"),S=Q.append("tbody").selectAll("nothing").data(L).enter().append("tr").attr("class",function(a){return"none"!=b.chartProp.info.selectable||""!=a.onClickVal||C||b.chartProp.globalvariable&&b.chartProp.globalvariable.length>0&&!b.editMode?"pointer":""}).attr("data-index",function(a,b){return b}).on("click",function(c,d){if(b.chartProp.globalvariable&&b.chartProp.globalvariable.length>0&&!b.editMode){var e=a.series.labels.concat([a.CurrentDimName]),f=c.series.concat(c.label);app.globalVariableHelper.updateGlobalVariables(e,f,b.chartProp.globalvariable),$(v+" .selected-item").removeClass("selected-item"),$(this).addClass("selected-item")}return""==c.onClickVal?void(C&&!b.editMode&&app.chartCommons.openLink(b.chartProp.info.openDashboard)):void(z()||(A(!0),b.parameters={selectedItem:c.onClickVal,chartId:b.chartId,ChartInPageId:b.ChartInPageId,notEditMode:!b.editMode},app.chartCommons.drillDown.add(b.ChartInPageId,b.input.DataSourceId,b.input.CurrentDimName,c.onClickVal),$(v).charts(chartTypes.TABLE,"refreshWithData",b)))}),T=L.map(function(a){return[a.label]});S.append("td").style("font-weight",function(b,c){return q(a.CurrentDimName).textBold?"bold":"normal"}).style("font-style",function(b,c){return q(a.CurrentDimName).textItalic?"italic":"normal"}).style("font-size",function(b,c){return q(a.CurrentDimName).fontSize}).style("text-align",function(b,c){return q(a.CurrentDimName).textAlign}).style("color",function(b,c){return q(a.CurrentDimName).color}).style("display",function(b,c){return q(a.CurrentDimName).isHidden?"none":"auto"}).attr("data-index",function(a,b){return b}).text(function(a,b){return persian(a.label,B)}).on("click",function(c,d){b.chartProp.info.rowAsKey=!0,b.chartProp.info.rowKey=a.CurrentDimName;var e=d3.select(this.parentNode).datum();""==e.onClickVal&&h.call(this,c,d,[a.CurrentDimName],T)});var U=I.seriesLabels.map(function(a){return{key:a.key,value:a.value,prop:q(a.key)}});U.unshift({key:a.CurrentDimName,value:a.CurrentDimName,prop:q(a.CurrentDimName)}),S.selectAll("nothing").data(function(a){return a.series}).enter().append("td").style("font-weight",function(a,b){return I.seriesLabels[b].prop.textBold?"bold":"normal"}).style("font-style",function(a,b){return I.seriesLabels[b].prop.textItalic?"italic":"normal"}).style("font-size",function(a,b){return I.seriesLabels[b].prop.fontSize}).style("text-align",function(a,b){return I.seriesLabels[b].prop.textAlign}).style("color",function(a,b){return I.seriesLabels[b].prop.color}).style("display",function(a,b){return I.seriesLabels[b].prop.isHidden?"none":"auto"}).text(function(a,b){var c=I.seriesLabels[b].prop,d=isNaN(a);return d||(a*=+c.numberFactor),d?persian(a,B):persian(d3.format(c.formatString)(a),B)}).on("click",function(c,d){b.chartProp.info.rowAsKey=!0,b.chartProp.info.rowKey=a.CurrentDimName;var e=d3.select(this.parentNode).datum();""==e.onClickVal&&h.call(this,c,d,[a.CurrentDimName],T)}),b.isRefresh||(a.resultRows=a.resultRows.sort(function(a,b){var c=J.indexOf(a.Name),d=J.indexOf(b.Name);return c>d?1:d>c?-1:0}),a.resultRows=[{Name:"",Type:0,Value:""}].concat(a.resultRows));var V=Q.select("tbody").append("tr").selectAll("nothing").data(a.resultRows).enter().append("td").style("font-weight","bold").style("display",function(a,b){return I.seriesLabels.length-1<b?"auto":I.seriesLabels[b].prop.isHidden?"none":"auto"}).text(function(a,b){if("undefined"==typeof a||""==a.value)return"";var c=a.Value,d=q(a.Name);if("undefined"==typeof d)return"";var e=isNaN(a.Value);return e||3==+a.Type||(c=+a.Value*+d.numberFactor),e||(c=d3.format(d.formatString)(c)),persian(c,B)}),W=!1,X=d3.select(v+" .table-body").append("div").attr("class","table-footer").append("table").attr("class","table  table-chart"+G+(b.chartProp.info.condensed?"table-condensed":"")).append("thead").append("tr").selectAll("nothing").data(a.resultRows).enter().append("th").style("width","1px").style("display",function(a,b){return p(b).isHidden?"none":"auto"}).style("font-weight",function(a,b){return p(b).textBold?"bold":"normal"}).style("font-style",function(a,b){return p(b).textItalic?"italic":"normal"}).style("font-size",function(a,b){return p(b).fontSize}).style("text-align",function(a,b){return p(b).textAlign}).style("color",function(a,b){return p(b).color}).text(function(a,b){if("undefined"==typeof a||""==a.Value)return"";var c=a.Value,d=q(a.Name),e=isNaN(a.Value);return e||3==+a.Type||(c=+a.Value*+d.numberFactor),W=!0,e||(c=d3.format(d.formatString)(c)),persian(c,B)}),Y=d3.select(v+" .table-body").insert("div","#tablescroll").attr("class","header-table").append("table").attr("class"," ui celled table unstackable small table-chart"+G+(b.chartProp.info.condensed?"table-condensed":"")),Z=Y.append("thead").style("background-color","white").append("tr"),aa=a.TableInfo||{};o(U,Z,Y,{sort:function(a,c,d){if(n(a,c,d),T=d.data().map(function(a){return[a.label]}),null==aa.Order)aa.Order=[{Index:a,DescType:1}];else{for(var e=!1,f=0;f<aa.Order.length;f++){var g=aa.Order[f];if(g.Index==a){var h={Index:a,DescType:0==g.DescType?1:1==g.DescType?2:1};aa.Order.splice(f,1);aa.Order.push(h),e=!0;break}}e||aa.Order.push({Index:a,DescType:1})}b.editMode&&$(v).trigger("tableInfo",[{TableInfo:aa}])},filter:function(){s()},filterclear:function(a){$(v+" #filterbox-"+a+" input").val(""),s()}});var ba=S[0];if(ba.forEach(function(a,b){m([0].concat(a.__data__.series),[""].concat(K),a)}),o(U,R,Q,{sort:function(){},filter:function(){},filterclear:function(a){}}),b.chartProp.info.showRowNumber&&D&&(S.insert("td","td").text(function(a,b){return persian(1+b,B)}).style("text-align","right"),d3.select(V.node().parentNode).insert("td","td"),Z.insert("th","th").text("ردیف"),R.insert("th","th").text("ردیف"),d3.select(v+" .table-body .table-footer tr").insert("th","th").style("width","1px"),X=d3.selectAll(v+" .table-body .table-footer tr th"),V=d3.select(V.node().parentNode).selectAll("td")),k(S,R,Z,X,W,V),$(v).trigger("heightChange"),b.tableInfo&&b.tableInfo.Order&&b.tableInfo.Order.length>0){var ca=$(Z[0][0]).find("th").get(b.tableInfo.Order[0].Index);2==b.tableInfo.Order[0].DescType&&$(ca).find("div").data("sort",!0),$(ca).find("div").click()}}else{if(b.input=a,app.chartCommons.calculateFields({data:a.nonPivotMatrix,labels:a.headers},b.calculatedFields,a.ColumnIsNumeric),b.editMode&&$(v).trigger("chartproperty",[a.headers]),!a.result)return void $("#"+b.id).append(app.chartCommons.getError(a));var da=a.nonPivotMatrix,U=a.headers.map(function(a){return{key:a,value:a,prop:q(a)}});d3.select(v).append("div").attr("class","temporal table-body");a.TableInfo.Page;f(v,a.nonPivotMatrix,a.TableInfo.Page)}if(a.TableInfo&&a.TableInfo.Filter){var ea=a.TableInfo.Filter.map(function(a){return{value:a.FilterParameter,type:a.FilterType}});t(ea)}var ea=$(v).data("filterbox");t(ea)};var app=app||{};app.charts=app.charts||{},app.charts.tree={},app.charts.tree.draw=function(a,b,c,d){function e(c){return c.dimensionName=a.dimensionName,c.datasourceId=a.DataSourceId,c.chartId=b.editMode?-1:a.chartId,b.editMode||-1!=c.Id||app.chartCommons.userFilter.setFilter({id:c.Id,values:c.Values,variableType:c.VariableType,dimensionName:c.dimensionName,chartInPageId:b.ChartInPageId,datasourceId:c.datasourceId}),-1==+c.Id?(app.moderation.dashboadpage.refreshRelatedDatasources(a.RefreshDatasource,[+b.ChartInPageId]),void app.filterBox.refresh()):void $.ajax({type:"POST",url:app.urlPrefix+"Moderation/GlobalVariable/SetValueForUser",dataType:"json",contentType:"application/json;charset=utf-8",traditional:!0,data:JSON.stringify(c),success:function(a){a.result?(app.moderation.dashboadpage.refreshRelatedDatasources(a.relatedDatasource,[+b.ChartInPageId]),app.filterBox.refresh()):alert(a.Message)}})}b.input=a,app.chartCommons.calculateFields(a.series,b.calculatedFields);var f=(a.title,a.chartInfo,"undefined"!=typeof a.series?a.series.labels:[]),g="undefined"!=typeof a.kpis?a.kpis.labels:[],h=(b.LabelY,"#"+b.id),i=$(h).width();$(h).height(),"small"==b.chartProp.info.chartSize?150:"medium"==b.chartProp.info.chartSize?200:"large"==b.chartProp.info.chartSize?250:"veryLarge"==b.chartProp.info.chartSize?400:130;b.width=i;"undefined"==typeof a.lang?!0:0==+a.lang,d.isProgress,d.showProgress,d.title;if(b.editMode&&$(h).trigger("chartproperty",[g.concat(f)]),!a.result)return void $("#"+b.id).append(app.chartCommons.getError(a));
$(h).addClass("tree-chart").css("text-align","right");var j=$(h+" .title").outerHeight(),k=$(h).outerHeight()-j-2,l=d3.select(h).append("ul").attr("class","root-node temporal tree").text("");l.style("height",k+"px");var m=function(a,c){a.select(".loading").remove(),$(a.node()).data("vals",c.vals);var d=$(a.node()).find(".tree-caret"),f=0==d.length||d.hasClass("rotate"),g=d3.select($("<ul></ul>").get(0)).attr("class","tree-element collapse fade "+(f?"in":""));c.data=c.data.map(function(a){return{id:a[0],parent:a[1],name:a[2]||a[0],type:c.hasType?a[3]:null,childs:a[a.length-1]}});var i=g.selectAll("li").data(c.data).enter().append("li").attr("class","node tree-element");i.append("span").text(function(a,b){return a.name}).attr("class","value pointer").on("click",function(a){var d=b.chartProp.info.selectable;if("undefined"!=typeof d&&"none"!=d){"one"==d&&$(this).closest(".tree-chart").find(".value.active").removeClass("active"),$(this).toggleClass("active");var f=d3.select(h).selectAll(".active").data().map(function(a){return a.id}),g=_.filter(c.vals,function(a){return a[0]==f}).map(function(a){return a[1]});e({Id:-1,Values:g,VariableType:0})}}),i.each(function(a){0!=+a.childs&&d3.select(this).append(b.editMode?"span":"i").attr("class",function(){return b.editMode?"glyphicon-chevron-left glyphicon tree-caret pointer":"icon angle down icon-animate large  tree-caret pointer"}).text(" ").on("click",function(a,c){if(0!=+a.childs){var d=$(this),e=d.hasClass("rotate");e?d.removeClass("rotate"):d.addClass("rotate");var f=$(this).data("loaded");if(f){var g=$(this).parent().find(" > ul");return void(b.editMode?g.collapse(d.hasClass("rotate")?"hide":"show"):g.transition(e?"out scale right":"in  scale left"))}$(this).data("loaded",!0);var h=app.urlPrefix+"Charts/BarChart/getTreeData",i={parent:a.id,chartId:b.chartId,ChartInPageId:b.ChartInPageId,notEditMode:!b.editMode};b.editMode&&(i.ChartInfo=$("#divChart").data("chartInfo"));var j=d3.select(this).node().parentElement;d3.select(j).append("ul").attr("class","loading collapse fade in").html('<div class="ui active inline loader mini"></div>');var k=app.mobileMode?proxy.ajax:$.ajax,l=app.mobileMode&&!app.mobileModeTest?i:JSON.stringify(i);k({url:h,type:"POST",dataType:"json",data:l,success:function(a,c,d){b.mobileModeData={isOnline:c,date:d},m(d3.select(j),a)},contentType:"application/json",error:function(){}})}})}),b.editMode||g.style("display","none"),$(a[0][0]).append($(g[0][0])),b.editMode||$(a[0][0]).find("> ul").transition("in scale ")};m(l,a),$(h).trigger("heightChange")};var app=app||{};app.charts=app.charts||{},app.charts.text={},app.charts.text.draw=function(a,b,c,d){b.input=a,app.chartCommons.calculateFields(a.series,b.calculatedFields);var e=(a.title,a.chartInfo,"undefined"!=typeof a.series?a.series.labels:[]),f="undefined"!=typeof a.kpis?a.kpis.labels:[],g=(b.LabelY,"#"+b.id),h=$(g).width();$(g).height(),"small"==b.chartProp.info.chartSize?150:"medium"==b.chartProp.info.chartSize?200:"large"==b.chartProp.info.chartSize?250:"veryLarge"==b.chartProp.info.chartSize?400:130;b.width=h;"undefined"==typeof a.lang?!0:0==+a.lang,d.isProgress,d.showProgress,d.title;if(b.editMode&&$(g).trigger("chartproperty",[f.concat(e)]),!a.result)return void $("#"+b.id).append(app.chartCommons.getError(a));$(g).addClass("tree-chart").css("text-align","right");var i=$(g+" .title").outerHeight(),j=$(g).outerHeight()-i-2,k=d3.select(g).append("ul").attr("class","root-node temporal tree").text("");k.style("height",j+"px"),$(g).append(b.chartProp.info.html)};var app=app||{};app.charts=app.charts||{},app.charts.userControl={},app.charts.userControl.draw=function(a,b,c,d){function e(){function c(a){var c=[a],d=b.chartProp.info.textOperand||"or";c.push(d);var e=b.chartProp.info.dimensions.map(function(a){return a.Name}).join(", ");if(c.push(e),b.chartProp.info.dimensions.forEach(function(a){c.push(a.formula)}),b.editMode)$(l).trigger("default-value",[!0,c,5]);else{var f={Id:b.chartProp.info.variableId||-1,Values:c,VariableType:5};k(f)}}var d='<div class="input-group temporal" style="margin-top:10px">                   <span class="input-group-btn">                     <button type="button" class="btn btn-default">                     <span style="font-size:13px" class="glyphicon glyphicon-search"> </span>                     </button>                   </span>                   <input type="text" placeholder="جستجو..." class="form-control">                 </div>';d='<div class="ui form temporal"><div class=" field"><div class="ui icon input">  <input type="text" placeholder="جستجو...">  <i class="search icon"></i></div></div></div>',$(l).append(d),$(l+" input").on("keydown",function(a){if(13==a.keyCode){var b=$(this).val();c(b)}}),$(l+" button").on("click",function(){var a=$(l+" input").val();c(a)});var e=[];e=a.GloablFilterDefaultValue?a.GloablFilterDefaultValue.Value:null!=a.DefaultValue&&a.DefaultValue.length>0&&-1!=b.chartProp.info.variableId?a.DefaultValue:b.chartProp.info.variableDefault&&b.chartProp.info.variableDefault.values&&"NONE"==b.chartProp.info.variableDefaultFunction&&-1!=b.chartProp.info.variableId?b.chartProp.info.variableDefault.values:["",""],$(l+" input").val(e[0])}function f(){if(!b.editMode){var c=app.chartCommons.userFilter.getFilterValue(b.ChartInPageId);_.isNull(c)||(a.GloablFilterDefaultValue=a.GloablFilterDefaultValue||{},a.GloablFilterDefaultValue.ValuesType=c.variableType,a.GloablFilterDefaultValue.Value=3==+c.variableType?c.defaultValue:c.values)}}function g(){var d=a.fields.map(function(a){return a.Value}),e=a.fields.map(function(a){return a.Key});e.length!=d.length&&$("#"+b.id).append(app.chartCommons.getError(a));for(var f=[],g=0;g<d.length;g++)f.push({Caption:e[g],Uniquename:d[g],IsChecked:!1});var h=function(c){var d=c.filter(function(a){return a.IsChecked}).map(function(a){return a.Uniquename}),e=c.filter(function(a){return a.IsChecked}).map(function(a){return a.Caption}),f='<div style="text-align: right; font-size: 0.9em; margin-top: 7px;"><b>انتخاب‌ها:</b><ul>'+e.map(function(a){return'<li style="  float:right; display:inline; width:33%;">'+a+"</li>"}).join("")+"</ul></div>";$(l+" .selected-item").html(f),a.DefaultValue=d,b.editMode?$(l).trigger("default-value",[!0,d,0]):k({Id:b.chartProp.info.variableId||-1,Values:d})};if(select='<div class="container-fluid temporal" style="margin: 15px 0px 10px;"><div class="row"><a  class=" btn btn-primary pointer filter-member btn-block"> '+(b.chartProp.info.label||"انتخاب")+' <span class="glyphicon glyphicon-list-alt"></span></a></div><div class="row selected-item col-sm-12"></div></div>',$(l).append(select),$(l+" .filter-member").on("click",function(){app.helper.filterMemberDialog(f,h)}),null!=a.DefaultValue&&a.DefaultValue.length>0){f.filter(function(b){return-1!=a.DefaultValue.indexOf(b.Uniquename)}).forEach(function(a,b){a.IsChecked=!0});var i='<div style="text-align: right; font-size: 0.9em; margin-top: 7px;"><b>انتخاب‌ها:</b><ul>'+f.filter(function(a){return a.IsChecked}).map(function(a){return'<li style="  float:right; display:inline; width:33%;">'+a.Caption+"</li>"}).join("")+"</ul></div>";$(l+" .selected-item").html(i)}else if(b.chartProp.info.variableDefault&&b.chartProp.info.variableDefault.values){var j=b.chartProp.info.variableDefault.values;f.filter(function(a){return-1!=j.indexOf(a.Uniquename)}).forEach(function(a,b){a.IsChecked=!0});var i='<div style="text-align: right; font-size: 0.9em; margin-top: 7px;"><b>انتخاب‌ها:</b><ul>'+f.filter(function(a){return a.IsChecked}).map(function(a){return'<li style="  float:right; display:inline; width:33%;">'+a.Caption+"</li>"}).join("")+"</ul></div>";$(l+" .selected-item").html(i)}if(b.editMode){$(l).find("select");$(l).trigger("default-value",[!1,[f[0].UniqueName],0])}c&&h(f)}function h(c){function d(a){return jd_to_persian(gregorian_to_jd(a[0],a[1]+1,a[2]))}function e(a,b){var c="000000000"+a;return c.substr(c.length-b)}function f(a,c,d,e,f){if((!c||d&&e)&&(c||d)&&(b.editMode||!(c&&h==d&&i==e||!c&&h==d))){h=d,i=e;var g=c?[d,e]:[d,b.chartProp.info.dateOp];if(b.input.DefaultValue=g,!b.editMode&&f){var j={Id:b.chartProp.info.variableId||-1,Values:g,VariableType:c?2:4};k(j)}else{$(l).find("select");$(l).trigger("default-value",[!0,g,c?2:4])}$(l).data("user-value",g)}}var g='<div class="ui form temporal"><div class=" field"><div class="ui input">                        <input type="text" id=""  class="form-control from" placeholder="تاریخ" /><input id="from-value" type="hidden"/>                      </div></div></div>';c&&(g='<div class="ui grid temporal" ><div class="row">                        <div class="seven wide column ui input">                            <input id="" type="text" class="datepicker form-control from" placeholder="تاریخ شروع" />                            <input id="from-value" type="hidden"/>                        </div>                        <div class="two wide column">تا</div>                        <div class="seven wide column ui input">                            <input id="" type="text" class="datepicker form-control to" placeholder="تاریخ پایان"/>                            <input id="to-value" type="hidden"/>                        </div>                      </div></div>'),g=$(g),$(l).append(g),c?(g.find(".from").datepicker({defaultDate:"+1w",changeYear:!0,changeMonth:!0,dateFormat:b.chartProp.info.dateFormatShow+"",altFormat:b.chartProp.info.dateFormatValue+"",altField:g.find("#from-value"),onClose:function(a){a&&(g.find(".to").datepicker("option","minDate",a),f(g,c,g.find("#from-value").val(),g.find("#to-value").val(),!0))}}),g.find(".to").datepicker({defaultDate:"+1w",changeYear:!0,changeMonth:!0,dateFormat:b.chartProp.info.dateFormatShow+"",altFormat:b.chartProp.info.dateFormatValue+"",altField:g.find("#to-value"),onClose:function(a){a&&(g.find(".from").datepicker("option","maxDate",a),f(g,c,g.find("#from-value").val(),g.find("#to-value").val(),!0))}})):g.find(" .from").datepicker({changeMonth:!0,changeYear:!0,dateFormat:b.chartProp.info.dateFormatShow+"",altFormat:b.chartProp.info.dateFormatValue+"",altField:g.find("#from-value"),onClose:function(a){a&&f(g,c,g.find("#from-value").val(),null,!0)}});var h,i,j=!1;if("undefined"==typeof a.DefaultValue||!a.DefaultValue){var m=new Date,n=d([m.getFullYear(),m.getMonth(),m.getDate()]),o=n[0]+"/"+e(n[1],2)+"/"+e(n[2],2);g.find(".from").datepicker("option","dateFormat","yy/mm/dd"),g.find(".from").datepicker("setDate",o),g.find(".from").datepicker("option","dateFormat",b.chartProp.info.dateFormatValue),o=g.find(".from").val(),a.DefaultValue=[o,o],j=!0}var p=[];a.GloablFilterDefaultValue?p=a.GloablFilterDefaultValue.Value:null!=a.DefaultValue&&a.DefaultValue.length>0&&-1!=b.chartProp.info.variableId&&(p=a.DefaultValue),p=p.map(function(a){return a.replace(/\[[^\]]+\]/,"")}),g.find(".from").datepicker("option","dateFormat",b.chartProp.info.dateFormatValue+""),g.find(".to").datepicker("option","dateFormat",b.chartProp.info.dateFormatValue+""),h=j?"":p[0],g.find(".from").datepicker("setDate",p[0]),c&&(g.find(".to").datepicker("setDate",p[1]),i=j?"":p[1]),f(g,c,g.find("#from-value").val(),g.find("#to-value").val(),!1)}function i(c){function d(a,c){if(a||c.push(b.chartProp.info.sliderRange),b.input.DefaultValue=c,b.editMode)$(l).trigger("default-value",[!0,c,1]);else{var d={Id:b.chartProp.info.variableId||-1,Values:c,VariableType:1};$(l).data("user-value",c),k(d)}}var e=a.fields.map(function(a){return a.Value}),f=(a.fields.map(function(a){return a.Key}),""!=b.chartProp.info.sliderMax&&"undefined"!=typeof b.chartProp.info.sliderMax?+b.chartProp.info.sliderMax:d3.max(e,function(a){return+a.replace(/\[[^\]]+\]/,"")})||100),g=""!=b.chartProp.info.sliderMin&&"undefined"!=typeof b.chartProp.info.sliderMin?+b.chartProp.info.sliderMin:d3.min(e,function(a){return+a.replace(/\[[^\]]+\]/,"")})||0,h='<div class="temporal" style="padding-left: 15px; padding-right: 15px; padding-top:5px">                        <div class="slider"></div>                        <div class="slider-value ltr" style="margin-top:5px"> </div>                        <input id="from-value" type="hidden"/>                      </div>';h=$(h),$(l).append(h);var i="min-max"==b.chartProp.info.sliderRange,j=function(a){var c=b.chartProp.info.sliderFormat||",.2f";return Array.isArray(a)?'<div class="inline">'+persian(d3.format(c)(a[0]),n)+'</div> <div class="inline"> تا </div> <div class="inline">'+persian(d3.format(c)(a[1]),n)+"</div>":persian(d3.format(c)(a),n)};h.find(".slider").slider({range:i?!0:b.chartProp.info.sliderRange,min:g,max:f,slide:function(a,b){h.find(".slider-value").html(j(i?b.values:b.value))},stop:function(a,b){d(i,i?b.values:[b.value])}}),h.find(".slider .ui-slider-range").css("background-color","#ddd"),h.find(".slider.ui-widget-content").css("box-shadow","none"),h.find(".slider .ui-slider-handle").css("background-color","#337ab7");var m=[];m=a.GloablFilterDefaultValue?a.GloablFilterDefaultValue.Value:null!=a.DefaultValue&&a.DefaultValue.length>0&&-1!=b.chartProp.info.variableId?a.DefaultValue:[g,f],m=m.map(function(a){return+a.toString().replace(/\[[^\]]+\]/,"")||0}),1==m.length&&m.splice(0,0,0),m[1]<m[0]&&(m[1]=m[0]),h.find(".slider-value").html(j(i?m:m[0])),i?h.find(".slider").slider("values",m):h.find(".slider").slider("value",m[0]),$(l).data("user-value",m)}function j(c){function d(a){var d;if(b.editMode)return a?void $(l).find("select").val(a):$(l).find("select").val();if(a)$(l+" .ui.dropdown").dropdown("set selected",a),d=a;else if(c){var e=$(l+" .ui.dropdown").dropdown("get item");d=e?e.toArray().map(function(a){return $(a).attr("data-value")}):[]}else d=$(l+" .ui.dropdown").dropdown("get value");return $(l).data("user-value",d),d}var e=b.chartProp.info.comboStyle;(app.mobile||b.editMode)&&(e="default");var f=a.fields.map(function(a){return a.Value.replace(/\[[^\]]+\]/,"")}),g=a.fields.map(function(a){return a.Key});g.length!=f.length&&$("#"+b.id).append(app.chartCommons.getError(a));var h='<select class="temporal ui fluid '+(c?"multiple":"")+' search selection dropdown" '+(c?"multiple":"")+" >";h+='  <option value="">'+b.chartProp.info.label+"</option>";for(var i=0;i<g.length;i++)h+='  <option value="'+f[i]+'">'+g[i]+"</option>";h+="</select>",$(l).append(h);var j=[];a.GloablFilterDefaultValue&&-1==b.chartProp.info.variableId?j=a.GloablFilterDefaultValue.Value:null!=a.DefaultValue&&a.DefaultValue.length>0&&(j=a.DefaultValue),j.map&&(j=j.map(function(a){return a?a.replace(/\[[^\]]+\]/,""):a})),d(j);var m=$(l).find("select");m.on("change",function(){app.lang.setLang({selector:l})});var n=null;n=b.editMode?function(){a.DefaultValue=c?d():[d()],$(l).trigger("default-value",[!0,c?d():[d()],0])}:function(){a.DefaultValue=c?d():[d()],k({Id:b.chartProp.info.variableId||-1,Values:c?d():[d()],VariableType:0})},b.editMode?$(l+" select.ui.dropdown").on("change",n):$(l+" .ui.dropdown").dropdown({onChange:function(a,b,c){n()},message:{noResults:app.lang.translate("No results found.")},apiSettings:{url:app.urlPrefix+"api/chartdata/GetColumnMembers",cache:!1,method:"post",beforeSend:function(a){var c=_.filter(app.chartCommons.drillDown.filters,function(a){if(!b.input||!b.input.RefreshDatasource)return!1;var c=-1!=b.input.RefreshDatasource.indexOf(a.datasourceId);return c&&a.chartInPageId!=b.ChartInPageId}),d=$.extend([],_.filter(app.chartCommons.userFilter.filters,function(a){if(!b.input||!b.input.RefreshDatasource)return!1;var c=-1!=b.input.RefreshDatasource.indexOf(a.datasourceId);return c}));_.remove(d,{chartInPageId:b.ChartInPageId});var e=JSON.parse(localStorage.getItem("userVariable"))||[];return a.data={chartId:b.chartId,userVariable:e,userControlFilter:d,otherFilters:c,query:a.urlData.query},a},dataType:"json"},fields:{remoteValues:"fields",name:"Key",value:"Value"},saveRemoteData:!1})}function k(c){if(b.editMode||o||app.chartCommons.userFilter.setFilter({id:c.Id,values:c.Values,variableType:c.VariableType,dimensionName:a.dimensionName,chartInPageId:b.ChartInPageId,datasourceId:a.DataSourceId}),-1==+c.Id)return app.moderation.dashboadpage.refreshRelatedDatasources(a.RefreshDatasource,[+b.ChartInPageId]),void app.filterBox.refresh();c.dimensionName=a.dimensionName,c.datasourceId=a.DataSourceId,c.chartId=a.chartId;var d=app.mobileMode?proxy.ajax:$.ajax,e=app.mobileMode?c:JSON.stringify(c);console.log("### user control ajaxCall init *****************"),d({type:"POST",url:app.urlPrefix+"api/GlobalVariable/SetValueForUser",dataType:"json",contentType:"application/json;charset=utf-8",traditional:!0,data:e,success:function(a){console.log("### user control ajaxCall *****************"),a.result?"undefined"!=typeof b.chartProp.info.variableId&&-1!=b.chartProp.info.variableId?$(".bar-chart").each(function(){var a=$(this).data("settings");"undefined"!=typeof a.input.GlobalVariables&&-1!=a.input.GlobalVariables.indexOf(b.chartProp.info.variableId)&&(a.titlebar.showProgress(!0),$(this).charts(a.type,"refreshWithData",a,{refreshRelatedDatasources:!1}))}):app.mobileMode?app.mobile.filterChanged(a.RefreshDatasource,[+b.ChartInPageId]):(app.moderation.dashboadpage.refreshRelatedDatasources(a.RefreshDatasource,[+b.ChartInPageId]),app.filterBox.refresh()):alert(a.Message)},error:function(a){app.mobileMode&&app.mobile.showToastMessage(a)}})}app.dashboardLayoutVersion=app.dashboardLayoutVersion||2,b.input=a,app.chartCommons.calculateFields(a.series,b.calculatedFields);var l="#"+b.id,m=$(l).width();b.width=m;var n="undefined"==typeof a.lang?!0:0==+a.lang;d.isProgress,d.showProgress,d.title;if(!a.result&&"datepicker"!=b.chartProp.info.type&&"datepicker-range"!=b.chartProp.info.type)return void $("#"+b.id).append(app.chartCommons.getError(a));var o=-1!=b.chartProp.info.variableId;switch(f(),b.chartProp.info.type){case"combo":j();break;case"multi":j(!0);break;case"datepicker":h(!1);break;case"datepicker-range":h(!0);break;case"multi-filter":g();break;case"slider":i();break;case"text":e()}$(l).trigger("heightChange")};
//# sourceMappingURL=charts-theme2.js.map