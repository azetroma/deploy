// داشبورد مدیریتی صدف info@sadafdashboard.ir 

var cal=angular.module("calendar",[]),ngApp=angular.module("sadafForms",["iframeCommunicate","ng-sortable","services","calendar","semantic-ui","ngRoute","ui.sortable","pascalprecht.translate","ngSanitize","uibCollapseCat","ngFileUpload","ngQuill","vs-repeat"]);ngApp.config(["$translateProvider",function(a){a.useStaticFilesLoader({prefix:app.urlPrefix+"dist/locales/locale-",suffix:".js"}),a.preferredLanguage("fa"),a.useSanitizeValueStrategy("sanitizeParameters")}]),ngApp.config(["$compileProvider",function(a){a.debugInfoEnabled(!1),a.commentDirectivesEnabled(!1),a.cssClassDirectivesEnabled(!1)}]),ngApp.config(["ngQuillConfigProvider",function(a){var b=Quill["import"]("attributors/style/size");b.whitelist=["12px","14px","16px","18px","20px","24px","28px","32px","38px","48px","72px"],Quill.register(b,!0),a.set({placeholder:"متن را وارد کنید",theme:"snow"})}]),ngApp.config(["$routeProvider","$locationProvider",function(a,b){a.when("/forms/list",{templateUrl:app.urlPrefix+"dist/partial/forms/editor/form-generator-list.html?v="+app.version,controller:"fromsCtrl",controllerAs:"c"}).when("/forms/:id?",{templateUrl:app.urlPrefix+"dist/partial/forms/editor/form-generator-editor.html?v="+app.version,controller:"fromGeneratorCtrl",controllerAs:"c"})}]);var iframeCommunicate=angular.module("iframeCommunicate",[]);iframeCommunicate.service("iframeService",["$location","$http",function(a,b){return{setPath:function(a){window.location.href=app.urlPrefix+a,console.log("### [iframeService] window.location.href ",app.urlPrefix+a)},handleMessage:function(a){console.log("handleMessage",a),$this=this,"route"===a.type&&this.setPath(a.param),"action-call"===a.type&&b.get(a.param),"set-variable"===a.type&&(_.isArray(a.param.userVariables)&&localStorage.setItem("userVariable",JSON.stringify(a.param.userVariables)),$this.setPath(a.param.url))}}}]);var ngApp=angular.module("sadafForms");ngApp.directive("versions",function(){return{restrict:"E",scope:{id:"@id",subId:"@?subId",type:"@type",justRestore:"@",onRestore:"&",onDetail:"&?","class":"@"},controller:["$scope","versionsSvr",function(a,b){a.app=app,a.moment=moment,b.get(a.id,a.type,a.subId||0).then(function(b){a.list=b.data.list,_.each(a.list,function(a){a.time=0===a.updateDate?"":moment.utc(a.timestamp).format("jYYYY/jMM/jDD HH:mm:ss")})})["catch"](function(a){}),a.inlineRestore="undefined"!=typeof a.justRestore,a.showDetail=function(c){b.detail(c.id).then(function(b){if(a.onDetail){var c=b.data;return _.isString(c)&&(c=JSON.parse(c)),void a.onDetail({model:c})}a.showDetailFlag=!0,a.detail=JSON.parse(b.data)})["catch"](function(a){alert("دریافت با خطا مواجه شده است"),console.log(a)})},a.remove=function(c,d){var e=confirm("آیا برای حذف این رکورد اطمینان دارید؟");e&&b.remove(c.id).then(function(b){a.list.splice(d,1)})["catch"](function(){alert("عملیات با خطا مواجه شده است")})},a.restore2=function(c){if(a.onRestore){var d=confirm("آیا برای بازگردانی اطمینان دارید؟");if(!d)return;b.detail(c.id).then(function(b){a.detail=JSON.parse(b.data),a.onRestore({model:a.detail})})["catch"](function(a){alert("دریافت با خطا مواجه شده است"),console.log(a)})}},a.restore=function(){if(a.onRestore){var b=confirm("آیا برای بازگردانی اطمینان دارید؟");if(!b)return;a.onRestore({model:a.detail})}},a.cancelDetail=function(){a.showDetailFlag=!1}}],templateUrl:app.urlPrefix+"dist/partial/management/directives/versions.html?v="+app.version}}),angular.module("services").service("versionsSvr",["$http",function(a){function b(b,c,d){return a.get(app.urlPrefix+"api/versions/get?id="+b+"&type="+c+"&subId="+d)}function c(b){return a.get(app.urlPrefix+"api/versions/detail/"+b)}function d(b){return a.get(app.urlPrefix+"api/versions/remove/"+b)}return{get:b,detail:c,remove:d}}]);var ngApp=angular.module("sadafForms");ngApp.directive("sadafForm",function(){return{scope:{id:"@",rowId:"@?",onCancel:"&?",onFinish:"&?",onSave:"&?",option:"=?",settings:"=?"},controller:["$scope","$http","$sce","$routeParams","$timeout","$q","formsService","formsSubmitService","$attrs","taskExecutor",function($scope,$http,$sce,$routeParams,$timeout,$q,formsService,formsSubmitService,$attrs,taskExecutor){function executeTask(a){}function changeDigitType(a){_.each(a,function(a){rec(a.controls,function(a){2==a.type&&null!=a.value&&a.value&&(a.value=+a.value)})})}function rec(a,b){_.each(a,function(a){b(a),13==a.type&&_.each(a.multiRowForm.rows,function(a){rec(a,b)})})}function getFormData(){$scope.clearForm(),$scope.rowId&&0!==+$scope.id&&($scope.formLoading=!0,$scope.showVersion=!0,formsSubmitService.get($scope.id,$scope.rowId).then(function(a){changeDigitType(a.model.pages),$scope.editPermission=a.editPermission,$scope.addPermission=a.addPermission,$scope.deletePermission=a.deletePermission,$timeout(function(){$scope.data&&$scope.data.pages&&($scope.data.pages=[])},0),$timeout(function(){$scope.data=a.model,$scope.baseData=JSON.parse(JSON.stringify(a.model)),$scope.data.id=a.id,$scope.data.rowId=$scope.rowId,$scope.modelId=a.id,$scope.allControl=[],$scope.allControlMap={},runOnAllControll($scope.data,function(a,b,c,d,e){a.uiConfig=JSON.parse(a.uiConfigSerialized||"{}"),$scope.allControl.push(a),e||($scope.allControlMap[a.name]=a),2==a.type&&null!=a.value&&(a.value=+a.value)},initPageRun),serverDataProcess()},250),$timeout(function(){$scope.formLoading=!1},0)},function(){$scope.formLoading=!1}))}function serverDataProcess(){updateCalculated()}function setDefaultFunction(a){"today"===a.defaultFunction&&9===a.type&&(a.value=depersian(moment().format("jYYYY/jMM/jDD"))),"today"===a.defaultFunction&&14===a.type&&(a.value=depersian(moment().format("jYYYY/jMM/jDD")+" 00:00:00"))}function initPageRun(a){a.canView=!0,a.canEdit=!0}function getFormEmptyData(){$scope.clearForm(),$scope.formLoading=!0,formsService.get($scope.id).then(function(a){$timeout(function(){$scope.formLoading=!1},0),$scope.data=_.merge({},a.model),$scope.editPermission=a.editPermission,$scope.deletePermission=a.deletePermission,$scope.addPermission=a.addPermission,changeDigitType(a.model.pages),$scope.allControl=[],$scope.allControlMap={},runOnAllControll($scope.data,function(a,b,c,d,e){setDefaultFunction(a),a.uiConfig=JSON.parse(a.uiConfigSerialized||"{}"),$scope.allControl.push(a),e||($scope.allControlMap[a.name]=a),a&&2==a.type&&a.validations&&a.validations.autoIncrement&&(autoIncMap[a.name]=autoIncMap[a.name]||+a.value)},initPageRun),serverDataProcess()},function(){$scope.formLoading=!1})}function findControl(a,b){var c=null;return runOnAllControll(b,function(b){if(b.name===a||b.columnName===a)return c=b,!1}),c}function runOnAllControll(a,b,c){function d(a){_.each(a,function(c){13===c.type&&("field-636"==c.name,_.each(c.multiRowForm.rows,function(a,c){var f=[];_.each(a,function(a){22==a.type&&a.controlGroup&&(f=f.concat(a.controlGroup.controls||[]))}),f=f.concat(a),_.each(f,function(a){var d=!0;try{"field-449"==a.name,d=b(a,f,c,e,!0)}catch(g){console.log(g)}if(d===!1)return!1}),d(f)}));try{var f=b(c,a,void 0,e,!1);if(f===!1)return!1}catch(g){console.log(g)}})}if(a){var e=[];_.each(a.pages,function(a){try{c&&c(a)}catch(b){console.log(b)}a&&_.isArray(a.controls)&&(e=e.concat(a.controls))});var f=[];_.each(e,function(a){22==a.type&&a.controlGroup&&(f=f.concat(a.controlGroup.controls||[]))}),e=e.concat(f),d(e)}}function GetMultiRowControlBaseOnChildName(a){var b;return runOnAllControll($scope.data,function(c){if(13==c.type){var d=_.findIndex(c.multiRowForm.rows[0],{name:a});d!=-1&&(b={control:c,index:d})}}),b}function calcFlatFormula(f,rowControls,rowIndex,pagesControls,dataType){function handleControl(a,b,c){var d=!1;if(a||(d=!0,b.push({isnull:null,type:"digit",value:0}),a={}),8==a.type){d=!0;var e="00:00";a.value&&(e=a.value.substring(0,5)),b.push({isnull:null===a.value,type:"millisecond",value:moment.duration(e).asMilliseconds()})}if(9==a.type&&("decimal"==c||"date"==c||"dateTime"==c)){d=!0;var e="1300/0/01";a.value&&(e=a.value),b.push({isnull:null===a.value,type:"millisecond",dataType:c,value:1e3*moment(e,"jYYYY/jMM/jDD").utc().unix()})}if(14==a.type){d=!0;var e="1300/0/01 00:00:00";a.value&&(e=a.value),b.push({isnull:null===a.value,type:"millisecond",value:1e3*moment(e,"jYYYY/jMM/jDD HH:mm:ss").utc().unix()})}(2==a.type||16==a.type||5==a.type&&"digit"==a.calcType||16==a.type&&"digit"==a.calcType)&&(d=!0,b.push({isnull:!1,type:"digit",value:+a.value||0})),4==a.type&&(d=!0,b.push({isnull:null===a.value,type:"text",value:"'"+a.value+"'"})),(5==a.type&&"millisecond"==a.calcType||16==a.type&&"millisecond"==a.calcType)&&(d=!0,b.push({isnull:null===a.value,type:"millisecond",value:a.calculate.calculatedValue})),d||b.push({isnull:null===a.value,type:"text",value:"'"+a.value+"'"})}var params=[],r=f.replaceAll(/\[(field-\d+)\]\[(.*?)\]\[(field-\d+)\]/gi,function(a,b,c,d){var e=GetMultiRowControlBaseOnChildName(d);if(e){"index"==c&&(c=rowIndex||0);var f=null;return e.control.multiRowForm.rows.length>c&&(f=e.control.multiRowForm.rows[c][e.index]),handleControl(f,params,dataType),"{"+(params.length-1)+"}"}return""}),r=r.replace(/\[(field-\d+)\]/gi,function(a,b,c){var d=_.find(rowControls,{name:b});return d||(d=_.find(pagesControls,{name:b})),handleControl(d,params,dataType),"{"+(params.length-1)+"}"}),newR=r.replace(/\{(\d+)\}/gi,function(a,b,c){return" "+params[+b].value+" "}),haveDate=_.filter(params,function(a){return"millisecond"==a.type}).length>0,isnull=!1;if(_.find(params,{isnull:!0})&&(isnull=!0),haveDate){var v=moment.duration(+eval(newR)).format("d روز و h ساعت و m دقیقه");return{value:isnull?null:v,calculatedValue:isnull?null:+eval(newR),type:"millisecond"}}var v=eval(newR),type="text";return v===!0||v===!1||_.isNaN(+v)||(v=+v,type="digit"),{value:isnull?null:v,calculatedValue:isnull?null:v,type:type}}function checkAccessRule(a,b,c){if(1==a.baseon){var d=null;b&&(d=_.find(b,{name:a.control})),d||(d=$scope.allControlMap[a.control]);var e=checkSameRow(d,c);if(d&&e)switch(a.operand){case 0:a.result=_.trim(d.value)==_.trim(a.value);break;case 1:a.result=_.trim(d.value)!=_.trim(a.value);break;case 2:a.result=+_.trim(d.value)>+_.trim(a.value);break;case 3:a.result=+_.trim(d.value)>=+_.trim(a.value);break;case 4:a.result=+_.trim(d.value)<+_.trim(a.value);break;case 5:a.result=+_.trim(d.value)<=+_.trim(a.value);break;default:a.result=_.trim(d.value)==_.trim(a.value)}}2==a.baseon}function checkAccessOfControl(a,b,c){_.each(a.access,function(a){checkAccessRule(a,b,c)});var d=_.filter(a.access,{type:1}),e=_.filter(a.access,{type:2,baseon:1}),f=_.filter(a.access,{result:!0,type:1}),g=_.filter(a.access,{result:!0,type:2,baseon:1});"undefined"==typeof a.canViewOrg&&(a.canViewOrg=a.canView),"undefined"==typeof a.canEditOrg&&(a.canEditOrg=a.canEdit),a.canView=!0,d.length&&(a.canView=!1),f.length&&(a.canView=!0),e.length&&(a.canEdit=!1),g.length&&(a.canEdit=!0)}function checkSameRow(a,b){var c=!0;return!a||!b||("undefined"==typeof a.rowIndex&&"undefined"==typeof b.rowIndex||(c=!1,a.rowIndex==b.rowIndex&&(c=!0)),c)}function updateCalculated(a){function b(a){a.access&&a.access.length&&checkAccessOfControl(a)}runOnAllControll($scope.data,function(b,c,d,e){if(13!=b.type||b.setDefaultFunction||(b.setDefaultFunction=setDefaultFunction),"field-685"==b.name,b.access&&b.access.length&&checkAccessOfControl(b,c,a),"field-30"==b.name,5==b.type)try{var f=calcFlatFormula(b.calculate.expression,c,d,e,b.dataType);b.value=f.value,b.formula=f.formula,b.calcType=f.type,b.calculate.calculatedValue=f.calculatedValue}catch(g){b.value="Error!",console.error("#### Error calcFlatFormula",b.name,b.label,f),console.log(g)}if(24==b.type)try{var f=calcFlatFormula(b.alert.expression,c,d,e,b.dataType);b.value=f.value,b.formula=f.formula,b.calcType=f.type,f.value!==!0&&f.value!==!1||(b.canView=f.value),f.value.color&&f.value.message&&(b.alert.message=f.value.message,b.alert.color=f.value.color,b.canView=!0),b.value=""}catch(g){b.value="Error!",console.error("#### Error calcFlatFormula",b.name,b.label,f),console.log(g)}if(4==b.type&&b.dropdown.useFormula)try{var h=GetMultiRowControlBaseOnChildName(b.dropdown.formula);if(h){var i=_.map(h.control.multiRowForm.rows,function(a){var b=a[h.index].value;return{value:b,label:b}});i=_.filter(i,function(a){return""!=a.value&&null!=a.value}),i=_.uniqBy(i,"value"),i.length&&(b.dropdown.items=i)}else{var f=calcFlatFormula(b.dropdown.formula,c,d,e);b.dropdown.items=[{value:f.value,label:f.value}]}}catch(g){b.value="Error!",console.error("#### Error calcFlatFormula",b.name,b.label,f),console.log(g)}if(16==b.type){var j=/\s*(sum|avg|max|min|var)\s*\(([^\)]+)\)\s*/gi,k=!1,l=b.calculate.expression.replace(j,function(a,d,e){var f=[],g=e.replace(/.*\[(field-\d+)\].*/gi,"$1"),h=GetMultiRowControlBaseOnChildName(g);if(!h)return"از فیلدهای مربوط به فرم چند ردیفه باید استفاده شود";_.each(h.control.multiRowForm.rows,function(a){var d=calcFlatFormula(e,a,-1,c,b.dataType);"digit"!=d.type?(k=!0,f.push(d.calculatedValue||0)):f.push(d.value||0)});var i=0;return"min"===d&&(i=d3.min(f)),"max"===d&&(i=d3.max(f)),"sum"===d&&(i=d3.sum(f)),"avg"===d&&(i=d3.mean(f)),"var"===d&&(i=d3.variance(f)),_.isNaN(+i)?" '"+i+"' ":" "+i+" "});try{var f=calcFlatFormula(l,c,d,e,b.dataType);b.value=f.value,b.formula=f.formula,b.calcType=f.type,b.calculate.calculatedValue=f.calculatedValue}catch(g){b.value="Error!",console.error("#### Error calcFlatFormula",b.name,b.label,f),console.log(g)}}if(17==b.type){var m=_.find(c,{name:b.tableLookup.controlName});if(!m)return void(model.value=null);var n=[];if(m.dropdown&&m.dropdown.listValue&&m.dropdown.listValue.length?n.concat(m.dropdown.listValue):m.value&&n.push(m.value),b.tableLookup.lastV&&n.length==b.tableLookup.lastV.length&&0==_.difference(n,b.tableLookup.lastV).length)return;b.tableLookup.lastV=n,b.inProgress=!0,formsService.tableLookup(b.tableLookup,n).then(function(a){b.inProgress=!1,a&&a.length&&(b.value=a[0].value,b.tableLookup.label=a[0].label,$scope.changeValue(b))})}b.useFilter&&b.filters&&b.filters.length&&_.map(b.filters,function(d){if(2===d.type){if(a&&a.name==d.control){var e=checkSameRow(a,b);e&&(b.value=null,b.listValue=null)}"field-6"==b.name;var f=_.find(c,{name:d.control});f||(f=findControl(d.control,$scope.data)),f&&(12===f.type?d.controlValue=f.value:d.controlValue!==f.value&&(d.controlValue=f.value))}})},b)}var c=this;$scope.selector="selector-"+Math.floor(999999*Math.random()+1e6),$scope.option=$scope.option||{},$scope.onCancel=$scope.onCancel||function(){};var id=$scope.id;$scope.submittedStatus=0,$scope.formLoading=!0,$scope.activePage=0,$scope.app=app,$scope.root=$scope,$scope.changeValue=function(a){a&&(updateCalculated(a),_.each(observers,function(b){b.callback&&b.callback(a)}))};var observers=[];$scope.registerChangeNotify=function(a,b){_.remove(observers,{key:b}),observers.push({key:b,callback:a})},$scope.unregisterChangeNotify=function(a){_.remove(observers,{key:a})},$scope.print=function(){function getControlValue(a,b){if(!a)return"";if(12===a.type&&_.isArray(a.formLookup.keyControlsBindedValue)){var c=a.formLookup.keyControlsBindedValue[0];return a.formLookup.keyControlsBindedText&&(c=a.formLookup.keyControlsBindedText[0]),c}var d=a.value;if(17===a.type&&(d=a.tableLookup.label),6===a.type&&(d=a.value?"بله":"خیر"),4===a.type&&(_.isArray(a.dropdown.selected)?d=a.dropdown.selected.join(", "):_.isArray(a.dropdown.listValue)&&(d=a.dropdown.listValue.join(", "))),"undefined"==typeof d)return"";if(a.format&&!_.isNaN(+d)&&b){var e=a.format;"custom"===e&&(e=a.customFormat),d=d3.format(e)(d)}return 20!==a.type&&b&&(d=persian(d,!0)),null===d?"":d}function getValue(a,b){return a=a.replace(/\[(.*?)\]/gi,function(a,c){var d=findControl(c,$scope.data);return d?getControlValue(d,b):a}),a.replace(/@(field-\d+)/gi,function(a,c){var d=findControl(c,$scope.data);return getControlValue(d,b)})}function replaceCalcExp(content){return content=content.replace(/calc\{\{((.|[\r\n])*?)\}\}/gim,function(match,p1){var c=getValue(p1,!1);try{return persian(eval(c),!0)}catch(e){return console.log(e),console.log(c),"Error: "+e.message}}),content=content.replace(/each\(@(.*?)\)\{\{((.|[\r\n])*?)\}\}/gim,function(a,b,c){var d=findControl(b,$scope.data),e=_.map(d.multiRowForm.rows,function(a){return c.replace(/@(field-\d+)/gi,function(b,c){var d=_.find(a,{name:c});return getControlValue(d,!1)})});return e.join("")})}var content=replaceCalcExp($scope.data.printLayout);content=getValue(content,!0),app.print.print(content,getValue($scope.data.printFileName||$scope.data.name),$scope.data.printOrientation,$scope.data.printPage)},$scope.setActivePage=function(a){$scope.activePage=a},$scope.isValid=function(){var a=!1;if($scope.data&&$scope.data.pages)a:for(var b=0;b<$scope.data.pages.length;b++)for(var c=0;c<$scope.data.pages[b].controls.length;c++){var d=$scope.data.pages[b].controls[c];if(12==d.type&&!d.isValid){a=!0;break a}}return a},$scope.submit=function(a,b){$scope.loading!==!0&&($scope.loading=!0,$scope.clearAllErrors(),$scope.batch&&$scope.batch.command&&($scope.data.filters={command:$scope.batch.command,chartInPageId:$scope.batch.settings.ChartInPageId,otherFilters:$scope.batch.settings.parameters.otherFilters,userControlFilter:$scope.batch.settings.parameters.userControlFilter}),formsSubmitService.submit($scope.id,$scope.data).then(function(c){if($scope.loading=!1,$scope.submittedStatus=0,!c.result&&c.messages&&($scope.pagesContainError=$scope.pagesContainError||[],$scope.pagesContainError=_.map(c.messages,function(a){return a.error}),_.each(c.messages,function(a){var b=findControl(a.name,$scope.data);b&&(b.error=a.error)})),!c.result&&c.pageMessages&&_.each(c.pageMessages,function(a){var b=_.find($scope.data.pages,{name:a.name});b&&(b.error=a.error)}),c.result){0==+$scope.rowId,$scope.data;_.each(autoIncMap,function(a,b){autoIncMap[b]=a+1}),$timeout(function(){$("#"+$scope.selector+" .close-btn").focus()},0),b?($scope.rowId=c.rowId,$scope.editPermission=c.editPermission,$scope.addPermission=c.addPermission,$scope.deletePermission=c.deletePermission,runOnAllControll($scope.data,function(a,b,d,e,f){if(f)return!1;var g=findControl(a.name,c.model);g&&(a.rowId=g.rowId),19===a.type&&null!=a.attachment&&_.each(a.attachment.uploadList,function(a){var b=_.find(g.attachment.uploadList,{fileName:a.fileName});b&&(a.serverDbId=b.serverDbId,a.serverPath=null)}),13===a.type&&_.each(a.multiRowForm.rows,function(a,b){_.each(a,function(a,c){a.rowId=g.multiRowForm.rows[b][c].rowId})})}),$scope.saveAndCopy=!0,$timeout(function(){$scope.saveAndCopy=!1},2e3)):a?($scope.saveAndCopy=!0,$timeout(function(){$scope.saveAndCopy=!1},2e3),_.each($scope.data.pages,function(a){_.each(a.controls,function(a){19===a.type&&(a.attachment=null),a.rowId=null})})):$scope.data.showSubmitedInfo?($scope.submittedStatus=1,runOnAllControll($scope.data,function(a){a.readonly=!0})):$scope.submitNewInfo(),$scope.onSave&&$scope.onSave({data:c});var d=$("#"+$scope.selector).data("callback");d&&d.result(c)}},function(a){a.data.title&&a.data.desc?$scope.error={title:a.data.title,desc:a.data.desc}:$scope.error=null,$scope.loading=!1,$scope.submittedStatus=2}))},$scope.submitAndCopy=function(){$scope.submit(!0)},$scope.submitNewInfo=function(){$scope.submittedStatus=0,runOnAllControll($scope.data,function(a){a.readonly=!1}),$scope.onFinish&&$scope.onFinish(),$scope.clearForm(),formsService.clearCache($scope.id)},$scope.clearAllErrors=function(){$scope.pagesContainError=[],runOnAllControll($scope.data,function(a){a.error=null},function(a){a.error=null})};var autoIncMap={};$scope.clearForm=function(){$scope.submittedStatus=0,$scope.activePage=0,$scope.showVersion=!1,runOnAllControll($scope.data,function(a){return a&&2==a.type&&a.validations&&a.validations.autoIncrement?void(a.value=autoIncMap[a.name]):(a.value=null,a.dropdown&&(a.dropdown.listValue=null),a.value=null,a.dropdown&&(a.dropdown.listValue=null),13==a.type&&a.multiRowForm.rows.splice(0,a.multiRowForm.rows.length-1),void setDefaultFunction(a))})},$scope.cancel=function(){$scope.submitNewInfo()},$scope.remove=function(){var a=confirm("آیا برای حذف اطلاعات جاری فرم اطمینان دارید؟");a&&formsSubmitService.remove($scope.id,$scope.rowId).then(function(){$scope.onCancel(),$scope.submitNewInfo()},function(a){a.data.title&&a.data.desc&&alert(a.data.desc)})},!$scope.rowId&&$scope.id&&getFormEmptyData(),$scope.settings&&($scope.settings.notify=function(a,b,c,d){if($scope.rowId=b,$scope.id=a,$scope.batch={command:c,settings:d},"delete-all"===c){var e=confirm("با تایید این گزینه تمامی رکوردهایی که در جدول مشاهده میکنید حذف خواهند شد. آیا برای حذف اطمینان دارید؟");e&&$http.post(app.urlPrefix+"api/formssubmit/DeleteAll/"+a,{filters:{command:$scope.batch.command,chartInPageId:$scope.batch.settings.ChartInPageId,otherFilters:$scope.batch.settings.parameters.otherFilters,userControlFilter:$scope.batch.settings.parameters.userControlFilter}}).then(function(a){app.moderation.dashboadpage.refreshRelatedDatasources(a.data.RefreshDatasource)})}else{if(0===+$scope.id)return;$scope.allControl=null,$scope.rowId?getFormData():getFormEmptyData()}}),$scope.colseBtn=function(a){(a.ctrlKey&&13===a.keyCode||27===a.keyCode)&&$scope.submitNewInfo(),a.ctrlKey&&83===a.keyCode&&$scope.submitNewInfo()},$scope.backToBaseVersion=function(){$scope.setValue($scope.baseData),$scope.versionRestore=!1,runOnAllControll($scope.data,function(a){a.readonly=!1,a.highlight=!1})},$scope.setValue=function(a){$scope.versionRestore=!0,runOnAllControll($scope.data,function(a){a.readonly=!0}),runOnAllControll(a,function(a){var b=findControl(a.name,$scope.data);if(b&&(b.value!=a.value&&(b.highlight=!0),b.value=a.value,b.dropdown&&a.dropdown&&(b.dropdown.listValue!=a.dropdown.listValue&&(b.highlight=!0),b.dropdown.listValue=a.dropdown.listValue,$scope.$broadcast("dropdown-getonline-default",b)),b.formLookup&&a.formLookup&&(b.formLookup.keyControlsBindedValue!=a.formLookup.keyControlsBindedValue&&(b.highlight=!0),b.formLookup.keyControlsBindedValue=a.formLookup.keyControlsBindedValue,$scope.$broadcast("formLookup-set-default",b)),13===b.type&&b.multiRowForm&&a.multiRowForm)){b.reversionDeletedIds||(b.reversionDeletedIds=b.multiRowForm.rows.map(function(a){return a[0].rowId})),b.multiRowForm.deletedIds=b.reversionDeletedIds;var c=_.merge([],b.multiRowForm.rows[0]);b.multiRowForm.rows=[],_.each(a.multiRowForm.rows,function(a){var d=_.merge([],c);_.each(d,function(b,c){var d=a[c];b.value=d.value,b.rowId=0,b.dropdown&&d.dropdown&&(b.dropdown.listValue!=d.dropdown.listValue&&(b.highlight=!0),b.dropdown.listValue=d.dropdown.listValue,$scope.$broadcast("dropdown-getonline-default",b)),b.formLookup&&d.formLookup&&(b.formLookup.keyControlsBindedValue!=d.formLookup.keyControlsBindedValue&&(b.highlight=!0),b.formLookup.keyControlsBindedValue=d.formLookup.keyControlsBindedValue,$scope.$broadcast("formLookup-set-default",b))}),b.multiRowForm.rows.push(d)})}})}}],restrict:"AE",templateUrl:app.urlPrefix+"dist/partial/forms/form-render.html?v="+app.version}}),ngApp.service("formsSubmitService",["$http",function(a){var b=function(b,c){return a.get(app.urlPrefix+"api/formsSubmit/getData/"+b+"?rowId="+c).then(function(a){a.data.model.modalSize||(a.data.model.modalSize="large");var b=a.data;return a.data.editPermission||_.each(b.model.pages,function(a){_.each(a.controls,function(a){a.readonly=!0})}),b})},c={};c.CONTROL_TYPE_TEXT_SINGLE_LINE=0,c.CONTROL_TYPE_TEXT_MULTI_LINE=1,c.CONTROL_TYPE_NUMBER=2,c.CONTROL_TYPE_TEXT_LABEL=3,c.CONTROL_TYPE_DROP_DOWN=4,c.CONTROL_TYPE_CALCULATE=5,c.CONTROL_TYPE_CHECKBOX=6,c.CONTROL_TYPE_MULTI_CHOISE=7,c.CONTROL_TYPE_TIME=8,c.CONTROL_TYPE_DATE=9,c.CONTROL_TYPE_PHOTO=10,c.CONTROL_TYPE_LINK=11,c.CONTROL_TYPE_FORM_LOOKUP=12,c.CONTROL_TYPE_MULTI_ROW=13,c.CONTROL_TYPE_DATE_TIME=14,c.CONTROL_TYPE_BUTTON=15,c.CONTROL_TYPE_CALCULATE_SUM=16,c.CONTROL_TYPE_FILE_ATTACHMENT=19;var d=function(b,c){return a.post(app.urlPrefix+"api/formssubmit/submit/"+b,c).then(function(a){return app.moderation.dashboadpage.refreshRelatedDatasources(a.data.RefreshDatasource),a.data})},e=function(b,c){return a.post(app.urlPrefix+"api/formssubmit/delete/"+b,c).then(function(a){return app.moderation.dashboadpage.refreshRelatedDatasources(a.data.RefreshDatasource),a.data})};return{submit:d,remove:e,get:b}}]),ngApp.directive("selectForm",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{onSelect:"&",settings:"=?"},controller:["$scope","$http","formsService",function(a,b,c){a.model=a.model||[],a.settings=a.settings||{},c.get().then(function(b){a.forms=b}),a.opt={closable:!1,onApprove:function(){return a.model&&a.model.length?(a.onSelect({forms:a.model,settings:a.settings}),!1):(alert("حداقل یک مورد باید انتخاب شود"),!1)}}}],template:'<div>                   <sm-modal visible="settings.visible" settings="opt">                        <div class="header">انتخاب فرم</div>                        <div class="content">                            <p>لطفا فرم‌های مورد نظر خود را انتخاب کنید</p>                            <div class="ui form">                                <div class="field">                                    <label>انتخاب فرم</label>                                    <sm-dropdown class="selection search multiple"  settings="{fullTextSearch: true}" model="model" items="forms" label="item.name" value="item" ></sm-dropdown>                                </div>                            </div>                        </div>                        <div class="actions">                            <div class="ui black deny button">لغو</div>                            <div class="ui positive button" ng-class="{loading: settings.loaging}" >اضافه کردن</div>                        </div>                    </sm-modal>                    </div>',link:function(a,b,c){}}}),function(){function getFormat(a){var b=a.format;return"custom"===a.format&&(b=a.customFormat||""),b}function getDatasourceColumns(a,b){if(a)return b.getColumns(a).then(function(a){return a.CubeInfo.Dimensions[0].Hierarchies})}function stringToUnix(a,b){return b?1e3*moment(a,"YYYY/MM/DD").unix():1e3*moment(a,"jYYYY/jMM/jDD").unix()}function unixToString(a,b,c){var d;return d=c?moment.unix(a/1e3).format(b):new persianDate(a).format(b||"YYYY/MM/DD"),depersian(d)}function findControl(a,b){var c=null;return runOnAllControll(b,function(b){if(b.name===a)return c=b,!1}),c}function runOnAllControll(a,b,c){console.log("### runOnAllControll");var d=[];_.each(a,function(a){c&&c(a),a&&_.isArray(a.controls)&&(d=d.concat(a.controls))});var e=[];_.each(d,function(a){22==a.type&&(a.controlGroup.controls=a.controlGroup.controls||[],e=e.concat(a.controlGroup.controls||[]))}),d=d.concat(e),_.each(d,function(a,c){13===a.type&&a.multiRowForm&&_.each(a.multiRowForm.rows,function(a,c){_.each(a,function(d){b(d,a,c),13===d.type&&d.multiRowForm&&_.each(d.multiRowForm.rows,function(a,c){_.each(a,function(d){b(d,a,c)})})})}),b(a,d,c)})}function showErrorToast(a,b){b.show({template:'<md-toast class="md-toast error"> <span class="md-toast-text" flex>'+a+"</span></md-toast>",hideDelay:3e3,position:"bottom left"})}function getFormLookupFields(a,b,c){if(console.log("### call getFormLookupFields ",a),a&&a.form)return a.formLookupSourceFields&&a.formLookupSourceFields.length?void(c&&c()):void b.get(a.form).then(function(b){a.formLookupSourceFields=[],_.each(b.model.pages,function(b){_.each(b.controls,function(b){a.formLookupSourceFields.push(b)})}),a.formLookupSourceFields.push({name:"_id",label:app.lang.translate("identity")}),c&&c()})}var ngApp=angular.module("sadafForms");ngApp.controller("fromGeneratorCtrl",["$scope","$http","$sce","$timeout","$mdToast","$routeParams","formsService","controlPropertyService","$translate","$mdDialog",function(a,b,c,d,e,f,g,h,i,j){function k(){p=[],runOnAllControll(m.pages.data,function(a){console.log("setCurrentTableColumns"),p.push(a.columnName)})}function l(a,b){return j.show({controller:["$scope","$mdDialog","$timeout",function(a,c,d){function e(b,c){b.renderer.setPadding(18),b.commands.addCommand({name:"myCommand",bindKey:{win:"Ctrl-S",mac:"Command-S"},exec:function(b){d(function(){a.justsave()},0)}}),a.insertFormula=function(a){b.insert(a),b.focus()}}a.cancel=function(){c.cancel()},a.save=function(){c.hide(a.formula)},b&&(a.formula=b),a.justsave=function(){m.printLayout=a.formula,m.save()},a.aceOption={useWrapMode:!0,showGutter:!1,theme:"sqlserver",mode:"sqlserver",maxLines:14,onLoad:e,require:["ace/ext/beautify"]}}],parent:angular.element(document.body),targetEvent:a,clickOutsideToClose:!1,escapeToClose:!1,fullscreen:!0,template:'<md-dialog aria-label="{{\'editor\' | translate}}" ng-cloak class="fullscreen-dialog">                                 <md-toolbar>                                                                                                                            <div class="md-toolbar-tools">                                                                                                          <h2>{{\'editor\' | translate}}</h2>                                                                                                   <span flex></span>                                                                                                                  <md-button class="md-icon-button" ng-click="cancel()">                                                                                  <span class="material-icons">close</span>                                                                                       </md-button>                                                                                                                    </div>                                                                                                                          </md-toolbar>                                                                                                                       <md-dialog-content layout-margin flex layout="row" class="md-dialog-contentx">                                                          <style>                                                                                                                                 .ace_editor {                                                                                                                           border: 1px solid #efefef;                                                                                                      }                                                                                                                                                                                                                                                                           .ace_editor, .ace_editor div {                                                                                                          font: 16px/normal \'Courier New\', \'Menlo\', \'Ubuntu Mono\', \'Consolas\', \'source-code-pro\', monospace;                              }                                                                                                                                                                                                                                                                   md-dialog.fullscreen-dialog {                                                                                                           max-width: 100%;                                                                                                                    max-height: 100%;                                                                                                                   width: 100%;                                                                                                                        height: 100%;                                                                                                                       border-radius: 0;                                                                                                               }                                                                                                                               </style>                                                                                                                                                                                                                                                                <div class="ltr" flex="100" ui-ace="aceOption" ng-model="formula">                                                                                                                                                                               </div>                                                                                                                                                                                                                                                              </md-dialog-content>                                                                                                                <md-dialog-actions layout="row">                                                                                                        <md-button ng-click="save()">                                                                                                           {{ \'ذخیره و بستن\' | translate }}                                                                                                        </md-button>                                                                                                                        <md-button ng-click="justsave()">                                                                                                            ذخیره                                                                                                          </md-button>                                                                                                                        <md-button ng-click="cancel()">                                                                                                         {{ \'cancel\' | translate }}                                                                                                      </md-button>                                                                                                                    </md-dialog-actions>                                                                                                            </md-dialog>'
})}a.saveProgress=!1;var m=this;m.id=f.id||0;var n=m.id>0;m.app=app,m.items=[{order:1,columnClass:"four",key:"متن کوتاه",label:"نام",icon:"text cursor",type:0,showUniqueProp:!0,"default":!0,require:!0,disable:!0,regex:!0,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{order:2,columnClass:"four",key:"متن بلند",label:"متن بلند",icon:"text cursor",type:1,showUniqueProp:!0,"default":!0,require:!0,disable:!0,regex:!0,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{order:3,columnClass:"four",key:"عدد",label:"عدد",icon:"hashtag",type:2,showUniqueProp:!0,"default":!0,require:!0,disable:!0,regex:!0,format:",.0f",accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[],validations:{autoIncrementSeed:1}},{order:4,columnClass:"four",key:"برچسب",label:"برچسب",icon:"font",type:3,showUniqueProp:!1,"default":!1,require:!1,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{order:5,columnClass:"four",key:"چند گزینه",icon:"caret square down outline",label:"چند گزینه",type:4,showUniqueProp:!0,"default":!0,require:!0,disable:!0,dropdown:{useRemoteData:!1,theme:"combo"},accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{order:6.1,columnClass:"four",key:"چند گزینه رادیویی",icon:"dot circle outline",label:"چند گزینه رادیویی",type:4,showUniqueProp:!0,"default":!0,require:!0,disable:!0,dropdown:{useRemoteData:!1,theme:"radio"},accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{order:6,columnClass:"four",key:"چند گزینه ریموت",icon:"caret square down outline",label:"چند گزینه ریموت",type:4,showUniqueProp:!0,"default":!0,require:!0,disable:!0,accessControlEdit:!1,accessControlView:!1,dropdown:{useRemoteData:!0,theme:"combo"},accessControlEditRoles:[],accessControlViewRoles:[]},{columnClass:"four",key:"تایید",icon:"check square outline",type:6,label:"انتخاب مقدار",showUniqueProp:!1,"default":!0,require:!1,disable:!0,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[],order:7},{columnClass:"four",key:"زمان",icon:"clock outline icon",label:"زمان",type:8,showUniqueProp:!0,"default":!0,require:!0,disable:!0,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[],order:8},{columnClass:"four",key:"تاریخ",label:"تاریخ",icon:"calendar alternate outline",type:9,showUniqueProp:!0,"default":!0,disable:!0,require:!0,dataType:"shamsi",accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[],order:9},{type:14,columnClass:"four",key:" زمان - تاریخ",label:" زمان - تاریخ",icon:"calendar alternate outline",showUniqueProp:!0,"default":!0,disable:!0,dataType:"shamsi",require:!0,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[],order:9},{type:12,columnClass:"four",key:"ارجاع به فرم",label:"ارجاع به فرم",icon:"pointing right",formLookup:{form:-1,keyControls:[],showAddButton:!0},showUniqueProp:!0,"default":!0,disable:!0,require:!0,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[],order:10},{columnClass:"twelve",key:"گروه تکرار شونده",label:"لیست",dontShowAccessControl:!0,icon:"table",type:13,showUniqueProp:!1,"default":!1,disable:!0,require:!1,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[],multiRowForm:{addKeyText:"ردیف جدید",rows:[[]],controlSize:"mini"},uiConfig:{theme:"simple",matrixMode:!1},order:11},{columnClass:"four",key:"کلید",label:"کلید",icon:"square",type:15,showUniqueProp:!1,"default":!1,disable:!1,require:!1,button:{type:1,openLinkType:0,colorClass:"black",size:"tiny",tasks:[{type:0,openLinkType:0}]},accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[],order:12},{columnClass:"four",key:"محاسباتی",icon:"calculator",label:"فیلد محاسباتی",type:5,showUniqueProp:!1,"default":!1,disable:!1,require:!1,dataType:"string",format:"#,#",calculate:{expression:""},accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[],order:13},{columnClass:"four",key:"محاسباتی - جمع",label:"محاسباتی - جمع",icon:"calculator",type:16,showUniqueProp:!1,"default":!1,require:!1,format:"#,#",calculate:{expression:"",func:"sum"},accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[],order:14},{columnClass:"four",key:"اطلاعات اضافه ارجاع به فرم",label:"اطلاعات اضافه ارجاع به فرم",dontShowAccessControl:!0,icon:"info",type:17,showUniqueProp:!1,"default":!1,require:!1,format:"#,#",accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],columnClass:"four",key:"اطلاعات اضافه ارجاع به فرم",label:"اطلاعات اضافه ارجاع به فرم",dontShowAccessControl:!0,icon:"info",type:17,showUniqueProp:!1,"default":!1,require:!1,format:"#,#",accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[],tableLookup:{},order:15},{columnClass:"twelve",dontShowColumnSize:!0,dontShowHide:!0,dontShowAccessControl:!0,key:"تیتر",label:"تیتر",icon:"heading",type:18,showUniqueProp:!1,"default":!1,require:!1,format:"#,#",accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[],order:16},{columnClass:"twelve",dontShowColumnSize:!0,dontShowHide:!0,dontShowAccessControl:!0,key:"پیوست کردن فایل",label:"لیست فایل‌ها",icon:"file outline",type:19,showUniqueProp:!1,"default":!1,require:!0,format:"#,#",accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[],order:17},{order:18,columnClass:"four",key:"انتخاب کاربر",icon:"user outline",label:"انتخاب کاربر",type:4,showUniqueProp:!0,"default":!0,require:!0,dropdown:{useRemoteData:!0,isUser:!0,preventRelation:!0},accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{order:19,columnClass:"twelve",key:"متن بلند با فرمت",icon:"edit",label:"متن بلند با فرمت",type:20,showUniqueProp:!1,"default":!0,uiConfig:{minHeight:150,font:{fontSize:"16px",fontName:"IRANSans"}},require:!0,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{order:20,columnClass:"four",key:"انتخاب نقش",icon:"users",label:"انتخاب نقش",type:4,showUniqueProp:!0,"default":!0,require:!0,dropdown:{useRemoteData:!0,isUser:!1,isRole:!0,preventRelation:!0},accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{order:21,columnClass:"four",key:"نهایی کردن فرم",icon:"lock",label:"نهایی کردن فرم",type:21,showUniqueProp:!1,"default":!1,require:!1,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[],description:"در صورت فعال بودن فرم تنها برای نقش‌های مجاز قابل ویرایش خواهد بود"},{order:22,columnClass:"twelve",key:"گروه",label:"گروه‌بندی",icon:"square outline",type:22,controlGroup:{controls:[],color:"#fefefe"},showUniqueProp:!0,"default":!0,require:!0,disable:!0,regex:!0,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{order:24,columnClass:"twelve",key:"هشدار",label:"هشدار",icon:"bell outline",type:24,showUniqueProp:!1,"default":!1,require:!1,disable:!1,regex:!1,alert:{message:"هشدار",color:"red"},accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]}],i(["short text","long text","number","label","combo","remote combo","checkbox","time","date","date time","refer to form","iterator","calculator","calculator sum","extra info","header","key","file list"]).then(function(a){function b(a,b,c,d){var e=_.find(m.items,null===b?{type:a}:b);e.key=c,e.label=d}b(0,null,a["short text"],a["short text"]),b(1,null,a["long text"],a["long text"]),b(2,null,a.number,a.number),b(3,null,a.label,a.label),b(4,function(a){return 4==a.type&&0==a.dropdown.useRemoteData},a.combo,a.combo),b(4,function(a){return 4==a.type&&1==a.dropdown.useRemoteData},a["remote combo"],a["remote combo"]),b(6,null,a.checkbox,a.checkbox),b(8,null,a.time,a.time),b(9,null,a.date,a.date),b(14,null,a["date time"],a["date time"]),b(12,null,a["refer to form"],a["refer to form"]),b(13,null,a.iterator,a.iterator),b(15,null,a.key,a.key),b(5,null,a.calculator,a.calculator),b(16,null,a["calculator sum"],a["calculator sum"]),b(17,null,a["extra info"],a["extra info"]),b(18,null,a.header,a.header),b(19,null,a["file list"],a["file list"])}),m.publishFrom=function(a){m.publishProgress=!0,g.publish(m.id,m.name,a).then(function(a){m.publishProgress=!1,m.url=a.url,m.publish=a.publish})},m.controlProperty=function(a){return a?_.find(m.items,{type:a.type}):{showUniqueProp:!1,"default":!1,require:!1}},m.sortableOptions={"ui-floating":!0},m.compConf={sort:!1,group:{name:"form",pull:"clone",put:!1},animation:150,onEnd:function(a){console.log("### onEnd compConf",a),a.model.name=m.pages.naming.getName(),a.model.columnName=a.model.name,a.model.canView=!0,a.model.canEdit=!0}},m.checkColumnName=function(a,b){var c=!1;return runOnAllControll(m.pages.data,function(b){if(console.log("checkColumnName"),b.name!==a.name&&b.columnName===a.columnName)return c=!0,!0}),c?(i("duplicate name").then(function(a){alert(a)}),void(a.columnName=b)):void(p.indexOf(a.columnName)!==-1&&(a.columnName=b,i("duplicate name").then(function(a){alert(a)})))},m.drags=m.items.map(function(a){return[a]});var o=!1;m.control=h.get(),m.formLookupSourceFields=[],m.pages={data:[],add:function(a){var b={name:app.lang.translate("page")+" "+(m.pages.data.length+1),type:0,controls:[],rowValidation:{uniqueMultiField:!1,uniques:[]},size:""};m.pages.data.push(b),m.pages.setActive(b)},removeControl:function(a,b){var c=app.lang.translate("delete control message"),d=confirm(c);d&&(o=!0,m.pages.activePage.controls.splice(a,1))},copy:function(a,b){o=!0;var c=_.extend({},b);c.name=m.pages.naming.getName(),c.columnName=c.columnName+"-copy",m.pages.activePage.controls.splice(a+1,0,c)},remove:function(a){if(m.pages){var b=!0;if(m.pages.data[a].controls.length&&(b=confirm("delete page message")),b){m.pages.data[a].controls.length&&(o=!0);var c=m.pages.data.splice(a,1);c[0]===m.pages.activePage&&m.pages.setActive()}}},setActive:function(a){_.each(m.pages.data,function(a){a.active=!1}),!a&&m.pages.data.length&&(a=m.pages.data[0]),m.pages.activePage=a,m.pages.activePage.active=!0,m.control.active&&(m.control.active.isActive=!1,m.control.active=null)},getControlForRowValidation:function(){var a=m.pages.activePage.controls;return a},naming:{getName:function(){return"field-"+m.pages.naming.getMaxId()},exist:function(a){if("_id"==a)return!0;var b=!1;return _.each(m.pages.data,function(c){_.each(c.controls,function(c){var d=c.name||"";if(d==a)return b=!0,!1})}),b},getMaxId:function(){return m.maxFieldNumber=+m.maxFieldNumber||0,m.maxFieldNumber++,m.maxFieldNumber}}},m.controlList=[],a.$watch("c.pages",function(){m.controlList=[],runOnAllControll(m.pages.data,function(a){13!=a.type&&m.controlList.push(a)})},!0),m.saveProgress=!1,m.save=function(){var a=!1;a=!o||confirm("edit form message‌"),a&&(o=!1,m.saveProgress=!0,_.isObject(m.mapTable.columnId)&&(m.mapTable.columnId=null),runOnAllControll(m.pages.data,function(a){console.log("flag"),a.uiConfigSerialized=JSON.stringify(a.uiConfig||{})}),g.save(m.id,{pages:m.pages.data,name:m.name,maxFieldNumber:m.maxFieldNumber,triggers:m.triggers,showSubmitedInfo:m.showSubmitedInfo,modalSize:m.modalSize,printLayout:m.printLayout,printOrientation:m.printOrientation,printPage:m.printPage,formInfo:m.formInfo,printFileName:m.printFileName,dynamicAcl:m.dynamicAcl,dynamicAclDatasource:m.dynamicAclDatasource,dynamicAclColumn:m.dynamicAclColumn,userVariables:m.userVariables||[],userVariablesInEdit:m.userVariablesInEdit,mapTable:m.mapTable||{}}).then(function(a){m.saveProgress=!1,m.id=a,location.replace(app.hashUrlPrefix+"#/forms/"+a),k();var b=e.simple().textContent(app.lang.translate("saving successfully"));e.show(b)},function(a){m.saveProgress=!1;var b=app.lang.translate("error in saving");a.data.desc&&(b=a.data.desc),showErrorToast(b,e)}))},n||(m.name=app.lang.translate("new form"),m.showSubmitedInfo=!1,m.modalSize="large",m.pages.add());var p=[];m.userVariables=[],m.mapTable={},m.formInfo={concurrentSave:"prevent-save"},n&&g.get(m.id,!0).then(function(a){m.sign=a.sign,m.pages.data=a.model.pages,m.name=a.model.name,m.showSubmitedInfo=a.model.showSubmitedInfo,m.modalSize=a.model.modalSize,m.triggers=a.model.triggers,m.url=a.url,m.publish=a.publish,m.maxFieldNumber=a.model.maxFieldNumber,m.dynamicAcl=a.model.dynamicAcl,m.printLayout=a.model.printLayout,m.printOrientation=a.model.printOrientation,m.printPage=a.model.printPage,m.formInfo=a.model.formInfo,m.formInfo=m.formInfo||{},m.formInfo.concurrentSave||(m.formInfo.concurrentSave="prevent-save"),m.printFileName=a.model.printFileName,m.dynamicAclDatasource=a.model.dynamicAclDatasource,m.dynamicAclColumn=a.model.dynamicAclColumn,m.userVariables=a.model.userVariables||[],m.userVariablesInEdit=a.model.userVariablesInEdit,m.mapTable=a.model.mapTable||{},m.dynamicAcl&&m.getAllRelatedDatasource(),m.pages.setActive(),k(),runOnAllControll(m.pages.data,function(a){console.log("isEdit"),a.uiConfig=JSON.parse(a.uiConfigSerialized||"{}"),"today"===a.defaultFunction&&(a.defaultFunctionToday=!0),a.dropdown&&a.dropdown.items&&(a.dropdown.itemsTemp=a.dropdown.items.map(function(a){return a.label}).join("\n"))})}),m.getSiblingControl=function(a){var b={};return runOnAllControll(m.pages.data,function(c,d){a===c.name&&(b.row=d,b.index=_.findIndex(d,{name:a}))}),b},a.$watch("c.control.active",function(a){if(a&&a.name){var b=[];runOnAllControll(m.pages.data,function(a,c,d){b.push(a)}),m.activeSibling={rootControls:b,row:b}}}),m.getAllRelatedDatasource=function(){m.relatedDatasources||m.relatedDsProgress||(m.relatedDsProgress=!0,b.get(app.urlPrefix+"api/datasources/getAllRelated/"+m.id).then(function(a){m.relatedDsProgress=!1,m.relatedDatasources=a.data.list})["catch"](function(a){m.relatedDsProgress=!1}))},a.showDialog=function(b){l(b,a.c.printLayout).then(function(b){a.c.printLayout=b,m.save()})["catch"](function(){})},m.clearValue=function(){m.control.active.value=null,m.control.active.dropdown.listValue=null;for(var a in m.control.active)/chbx\d+/.test(a)&&(m.control.active[a]={check:!1})}}]),ngApp.directive("formControl",["$compile",function(a){return{restrict:"E",replace:!0,transclude:!0,scope:{disabled:"@",root:"=?",model:"=ngModel",editContext:"=?",settingsClick:"&?",remove:"&?",id:"@",edit:"@",settings:"=?",copy:"&?",sdSubmit:"&",change:"&?"},controller:["$scope","$translate","$timeout","$http","taskExecutor",function(a,b,c,d,e){if(a._=_,a.randomId=Math.floor(1e5*Math.random())+1,a.model.randomId=a.randomId,a.$watch("model.value",function(b){null==b&&$(".form-"+a.randomId+" .dropdown").dropdown("clear")}),a.simpleDropdownsettings={message:{noResults:app.lang.translate("No results found.")},fullTextSearch:!0,forceSelection:!1},a.$watch("model.dropdown.listValue",function(b){null==b&&$(".form-"+a.randomId+" .dropdown").dropdown("clear")}),a.model.dropdown&&a.model.dropdown.multiSelectDropdown&&a.model.dropdown.useRemoteData&&(a.model.items=a.model.dropdown.listValue),a.initDropdown=function(b){a.model.dropdown&&a.model.dropdown.multiSelectDropdown&&a.model.dropdown.useRemoteData&&c(function(){$(b).dropdown("set selected",a.model.dropdown.listValue)},100)},a.buttonClick=function(){a.edit||_.each(a.model.button.tasks,function(b){e.exec(b,a.$parent.$parent.$parent.data,a)})},12===a.model.type&&(a.model.formDialogInfo={formInfo:{form:a.model.formLookup.form},showModal:!1},a.model.formDialogInfo.formInfo.render=!0,a.showFormInModal=function(){a.model.formDialogInfo.formInfo.rowId=0,c(function(){a.model.formDialogInfo.showModalFunc();var b=a.model.formDialogInfo.formSettings.notify;b(a.model.formLookup.form,0,null,a.model.formDialogInfo.formSettings)},0)},a.editFormInModal=function(b){a.model.formDialogInfo.formInfo.rowId=+b.value,c(function(){a.model.formDialogInfo.showModalFunc();var b=a.model.formDialogInfo.formSettings.notify;b(a.model.formLookup.form,a.model.formDialogInfo.formInfo.rowId,null,a.model.formDialogInfo.formSettings)},0)}),a.keyup=function(b){b&&b.ctrlKey&&13==b.keyCode&&a.sdSubmit()},a.model.dropdown&&"radio"==a.model.dropdown.theme&&a.model.dropdown.multiSelectDropdown&&!a.model.dropdown.useRemoteData)for(var f=0;f<a.model.dropdown.items.length;f++){a.model.dropdown.listValue=a.model.dropdown.listValue||[];var g=a.model.dropdown.listValue.indexOf(a.model.dropdown.items[f].value);a.model["chbx"+f]={check:g!=-1}}a.multiselectChange=function(b,c,d,e,f){if(a.model.dropdown.listValue=a.model.dropdown.listValue||[],b){var g=a.model.dropdown.listValue.indexOf(e.value);g==-1&&b.check&&a.model.dropdown.listValue.push(e.value),g==-1||b.check||a.model.dropdown.listValue.splice(g,1)}a.changeValue()},a.changeValue=function(b){a.change&&a.change({model:b||a.model})}}],templateUrl:app.urlPrefix+"dist/partial/forms/editor/form-generator-control.directive.html?v="+app.version}}]),$.fn.dropdown.settings.message&&($.fn.dropdown.settings.message.noResults="موردی برای نمایش وجود ندارد"),ngApp.directive("newFormModal",["$compile","$timeout",function(a,b){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",show:"=?",control:"=?"},template:'<div>                            <div class="xcontent" ></div>                       </div>',link:function(b,c,d){function e(){b.id||(b.id=Math.floor(999999*Math.random())+1e6,$($(c).find(".modal")[0]).addClass("id"+b.id)),$(".id"+b.id).data("callback",{result:function(a){var c=findControl(b.control.formLookup.keyControls[0],a.model.pages);b.control.value=c.rowId,b.control.formLookup.keyControlsBindedValue=[c.value],b.$parent.$parent.$parent.$parent.$parent.$broadcast("formLookup-set-default",b.control)}}),b.modal=$(".id"+b.id).jqmodal(b.option)}function f(){var d=angular.element('<div                                                          <div sadaf-form row-id={{model.formInfo.rowId}} id="{{model.formInfo.form}}" on-finish="hideModal()" on-save="saveFinish(data)" option="{showCancel:true}" settings="formSettings" on-cancel="hideModal()"></div>                                                    </div></div>');a(d)(b),angular.element(c[0].querySelector(".xcontent")).html(d)}b.hideModal=function(a){b.model.showModal=!1,$.jqmodal.close()},b.saveFinish=function(a){},b.option={escapeClose:!1,clickClose:!1,showClose:!1,fadeDuration:0,closeExisting:!1},b.formSettings={modal:!0},b.model.showModalFunc=e,b.model.formSettings=b.formSettings,f()}}}]),ngApp.directive("formLookupProperty",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",settings:"=?",control:"=",rootForm:"@"},controller:["$scope","$http","formsService",function(a,b,c){a.model=a.model||{},a.settings=angular.merge({selectableColumns:!0},a.settings||{}),c.get().then(function(b){a.forms=_.filter(b,function(b){return b.id!=+a.rootForm})}),a.$watch(["model.keyControls","model.formLookupSourceFields"],function(b,c){b!=c&&c&&b&&0!=b.length&&0!=c.length&&(console.log("#### formula",b,c),a.model.formLookupSourceFields&&(a.model.keyLabels=_.map(b,function(b){return _.find(a.model.formLookupSourceFields,{name:b}).label})),a.model.keyFormula=_.map(b,function(b){return"["+_.find(a.model.formLookupSourceFields,{name:b}).columnName+"]"}).join(" + "))},[]),a.$watch("model.form",function(b){b==-1&&(a.model.form=a.forms[0].id),b&&c.get(b).then(function(b){a.formControls=[],_.each(b.model.pages,function(b){_.each(b.controls,function(b){a.formControls.push(b)})})})}),a.calcFormula=function(){if(12==a.control.type){var b=a.control.formLookup.form;if(!b||b<=0)return;console.log(a.control.formLookup.formLookupSourceFields),a.control.formLookup.formLookupSourceFields=null,getFormLookupFields(a.control.formLookup,c,function(){a.model.keyFormula=_.map(a.model.keyControls,function(b){return"["+_.find(a.model.formLookupSourceFields,{name:b}).columnName+"]"}).join(" + ")})}}}],template:'<form> <div class="field">                        <div class="field">                            <label>{{\'select form\' | translate}}</label>                            <sm-dropdown class="selection search fluid"  settings="{fullTextSearch: true, forceSelection: false}" xon-change="change()" model="model.form" items="forms" label="item.name" value="item.id" ></sm-dropdown>                        </div>                        <div class="field" ng-show=settings.selectableColumns>                            <label> {{\'key columns\' | translate}}</label>                            <sm-dropdown class="selection search multiple fluid" settings="{fullTextSearch: true, forceSelection: false}" model="model.keyControls" items="formControls" label="item.label" value="item.name" ></sm-dropdown>                        </div>                        <div class="field" ng-show=settings.selectableColumns>                            <label>{{\'فرمول جستجوی منوی آبشاری\' | translate}}  <small class="pointer" ng-click="calcFormula()">دریافت کد</small></label>                            <input class="selection search multiple fluid" ng-model="model.keyFormula" />                        </div>                        </div></form>',link:function(a,b,c){}}}),ngApp.directive("formLookupGetId",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",id:"@",ngChange:"&?"},controller:["$scope","$http","formsService","$timeout",function(a,b,c,d){function e(){a.model.formLookup.keyControls=a.model.formLookup.keyControls||[],a.keys=a.model.formLookup.keyControls.map(function(b,c){var d={name:b,dropdownSettings:h(b),change:function(b,c){d.value!==c&&(d.value=c,a.model.value=b,console.log("### change form lookup"),a.ngChange&&a.ngChange())},defaultText:a.model.label};return d})}function f(){if(a.model.formLookup.keyControlsBindedValue&&a.keys&&a.keys.length){for(var b=0;b<a.model.formLookup.keyControlsBindedValue.length;b++){var c=a.model.formLookup.keyControlsBindedValue[b];null===a.model.value||_.isEmpty(c)||(!a.model.format||_.isNaN(+c)||_.isEmpty(c)||(c=d3.format(getFormat(a.model))(+c)),a.keys[b].defaultText=c,a.keys[b].boldText=!0)}a.keys[0].defaultText=a.model.formLookup.keyControlsBindedValue.join(" ")}}function g(){$(".form-"+a.model.randomId+" .dropdown").dropdown("clear")}a.model.formLookup=a.model.formLookup||{};var h=function(b){return{apiSettings:{url:app.urlPrefix+"api/forms/getFormColumnData",cache:!1,method:"get",dataType:"json",beforeSend:function(b){return b.data={id:a.id,name:a.model.name,query:b.urlData.query,others:a.keys.map(function(a){return{label:a.name,value:a.value}}),filters:a.model.useFilter?a.model.filters:[]},b},onResponse:function(b){return b.fields=b.fields.map(function(a){return{value:a.value,label:a.label,id:a.id}}),a.model.format&&_.each(b.fields,function(b){_.isEmpty(b.label)||_.isNaN(+b.label)||(b.label=d3.format(getFormat(a.model))(+b.label))}),b}},onChange:function(b,c,d){a.model.formLookup.keyControlsBindedValue=[b],a.model.formLookup.keyControlsBindedText=[c]},message:{noResults:app.lang.translate("No results found.")},fields:{remoteValues:"fields",name:"label",value:"id"},saveRemoteData:!1,fullTextSearch:!0,forceSelection:!1}};a.render=!0,a.$on("formLookup-set-default",function(b,c){if(a.model.name===c.name){var e=_.merge([],a.keys);a.keys=[],a.render=!1,d(function(){a.keys=e,f(),a.render=!0},0)}}),a.$watch("model.formLookup.keyControlsBindedValue",function(a){f()},!0),a.$watch("model.formLookup.keyControls",function(a){e(),f()},!0);var i=!1,j=!1;a.$watch("model.value",function(b){a.model;null==b&&(j=!0,g())}),a.init=function(a){i=!0,j&&g()},a.model.isValid=!0}],template:' <div class="">                            <div ng-if="render" class="xfield" xng-repeat="f in keys">                                <sm-dropdown settings="keys[0].dropdownSettings" on-init="init" ng-class="{\'bold-text\':keys[0].boldText}" class="selection search {{keys[0].name}} fluid" on-change="keys[0].change" default-text="keys[0].defaultText" ></sm-dropdown>                            </div>                        </div>'}}),ngApp.directive("selectMenu",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",multiple:"@?"},controller:["$scope","$http","$timeout",function(a,b,c){b.get(app.urlPrefix+"api/menus/get").then(function(b){a.menus=b.data})}],template:'<div><sm-dropdown style="width:100%;"items="menus" model="model" class="selection search {{multiple}}" settings="{forceSelection: false}" label="item.name" value="item.id" ></sm-dropdown></div>'}}),ngApp.directive("selectDatasourceColumns",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",controls:"=",control:"="},controller:["$scope","$http","datasources",function(a,b,c){function d(){if(a.model.datasourceColumns&&a.model.datasourceColumns.length||c.getColumns(a.model.remoteDatasource.value).then(function(b){a.model.datasourceColumns=b.CubeInfo.Dimensions[0].Hierarchies,a.model.userProperties=b.UsersProperty,a.model.datasourceColumns.push({Name:"سفارشی...",UniqueName:"سفارشی..."})}),a.model.datasourceColumns.length){var b=a.model.datasourceColumns[a.model.datasourceColumns.length-1];"سفارشی..."!=b.Name&&a.model.datasourceColumns.push({Name:"سفارشی...",UniqueName:"سفارشی..."})}}a.select=function(){c.select(null,{type:["datasources"],showSubForms:!0}).then(function(b){b.selected&&b.selected.length&&(a.model.remoteDatasource&&b.selected[0].id!=a.model.remoteDatasource.value&&(a.model.datasourceColumns=null),a.model.remoteDatasource={value:b.selected[0].id,label:b.selected[0].name},d(),a.model.remoteColumnKey=null,a.model.remoteColumnLabel=null)})},a.model=a.model||{},a.$watch("model",function(a){console.log("### watch [selectDatasourceColumns]"),a&&d()}),a.$watch("model.remoteColumnKeyFormula",function(b){var c=_.find(a.controls.row,function(b){return 17==b.type&&b.tableLookup.controlName==a.control.name});c&&"سفارشی..."==a.model.remoteColumnKey&&(c.tableLookup.lookupField=b)}),a.setFormula=function(b){if("label"==b){var c=_.find(a.model.datasourceColumns,{Name:a.model.remoteColumnLabel});a.model.remoteColumnLabelFormula=c.UniqueName}if("key"==b){var c=_.find(a.model.datasourceColumns,{Name:a.model.remoteColumnKey});a.model.remoteColumnKeyFormula=c.UniqueName}}}],template:' <div class="ui form">                        <div class="field">                            <label>{{\'انتخاب منبع داده\'| translate}}</label>                            <button class="ui tiny button" ng-click="select()">                                <span ng-show="!model.remoteDatasource">{{\'select\'| translate}}</span>                                <span ng-show="model.remoteDatasource">{{model.remoteDatasource.label}}</span>                            </button>                        </div>                        <div class="field" ng-show="model.datasourceColumns">                            <label>{{\'value column\'| translate}}</label>                            <sm-dropdown class="selection search fluid" settings="{fullTextSearch: true}" model="model.remoteColumnKey" items="model.datasourceColumns" label="item.Name" value="item.Name" ></sm-dropdown>                        </div>                        <div class="field" ng-show="model.datasourceColumns && model.remoteColumnKey == \'سفارشی...\'">                            <label>فرمول مربوط به کلید</label>                            <auto  names="model.datasourceColumns" class="ltr" ng-model="model.remoteColumnKeyFormula" ></auto>                        </div>                        <div class="field" ng-show="model.datasourceColumns">                            <label>{{\'label column\'| translate}}</label>                            <sm-dropdown class="selection search fluid" settings="{fullTextSearch: true}" model="model.remoteColumnLabel" items="model.datasourceColumns" label="item.Name" value="item.Name" ></sm-dropdown>                        </div>                        <div class="field" ng-show="model.datasourceColumns && model.remoteColumnLabel == \'سفارشی...\'">                            <label>فرمول مربوط به برچسب</label>                            <auto  names="model.datasourceColumns" class="ltr" ng-model="model.remoteColumnLabelFormula" ></auto>                        </div>                    </div>',link:function(a,b,c){}}}),ngApp.directive("selectDatasource",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel"},controller:["$scope","$http","datasources",function(a,b,c){a.model=a.model||{},a.select=function(){c.select(null,{type:["datasources"]}).then(function(b){b.selected&&b.selected.length&&(a.model={value:b.selected[0].id,label:b.selected[0].name})})}}],template:' <div class="">                            <div class="field inline-form">                                <label>{{\'انتخاب منبع داده\'| translate}}</label>                                <span style="color:#424242" class="pointer" ng-show="model.value" ng-click="select()">{{model.label}}</span>                                <i ng-show="model.value" class="ui icon edit link" ng-click="select()"/>                                <button ng-show="!model.value" class="ui tiny button" ng-click="select()">                                    <span >{{\'select\'| translate}}</span>                                </button>                            </div>                        </div>'}}),ngApp.directive("selectColumn",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{id:"=",model:"=ngModel"},controller:["$scope","$http","datasources",function(a,b,c){a.model=a.model||{},a.$watch("id",function(){a.id&&getDatasourceColumns(a.id,c).then(function(b){a.datasourceColumns=b})})}],template:' <div class="">                            <div class="field inline-form">                                <label>{{\'ستون شناسه\'| translate}}</label>                                <sm-dropdown style="width: 70%" class="selection search" settings="{fullTextSearch: true}" model="model" items="datasourceColumns" label="item.Name" value="item.Name" ></sm-dropdown>                            </div>                        </div>'}}),ngApp.controller("fromsCtrl",["$scope","$http","$sce","$timeout","$mdToast","$routeParams","formsService","$mdDialog","utils","$translate",function(a,b,c,d,e,f,g,h,i,j){var k=this;k.progress=!0,k.app=app,k.utils=i,g.get().then(function(a){k.progress=!1,k.data=a,k.formsModule=g.getFormsModule(),k.securityCertPatch=g.securityCertPatch()}),k["delete"]=function(a,b,c){j(["remove","remove_form_desc","cancel"]).then(function(d){var f=h.confirm().title(d.remove).textContent(d.remove_form_desc+" "+b.name).ariaLabel(d.remove).targetEvent(a).ok(d.remove).cancel(d.cancel);h.show(f).then(function(){g.remove(b.id).then(function(a){var b=k.data.splice(c,1),d=e.simple().textContent("فرم "+b[0].name+" با موفقیت حذف شد");e.show(d)})})})},k.copy=function(a,b,c){g.copy(b.id).then(function(){})["catch"](function(){alert("اشکال در روند اجرای برنامه")})}}]),ngApp.directive("sadafUserVariables",["$compile","$timeout","$http",function(a,b,c){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel"},template:'<div><sm-dropdown class="selection fluid search" items="items" model="model" label="item" value="item"></sm-dropdown></div>',controller:["$scope","$http",function(a,b){b.get(app.urlPrefix+"api/users/getPropertyAutoCompleteEntries").then(function(b){a.items=b.data.keys})["catch"](function(){})}]}}]),ngApp.directive("controlSize",["$compile","$timeout",function(a,b){return{restrict:"E",transclude:!0,scope:{model:"=ngModel"},template:"<sm-dropdown items=\"[{label:('خیلی کوچک' | translate), value:'mini'}, {label:('کوچک' | translate), value:'tiny'}, {label:('normal' | translate), value:''}]\" model=\"model\" label=\"item.label\" value=\"item.value\"></sm-dropdown> "}}]),ngApp.filter("formatNumber",function(){return function(a,b){var c=b.format;return isNaN(a)||!c||null==a?a:("custom"===c&&(c=b.customFormat),
d3.format(c)(a))}}),ngApp.filter("d3format",function(){return function(a,b){return"#,#"==b&&(b=",.0f"),"undefined"==typeof a||null==a?a:d3.format(b)(a)}}),ngApp.filter("persian",function(){return function(a){return app.lang&&0==+app.lang.langType?persian(a,!0):a}}),ngApp.directive("sadafCheckbox",["$compile","$timeout",function(a,b){return{restrict:"E",transclude:!0,replace:!0,scope:{model:"=ngModel",change:"&?ngChange"},template:'<div class="ui checkbox"><input type="checkbox" ng-model="model" ng-change="change"/><label ng-transclude></label></div>',link:function(a,c,d){a.model===!0||a.model&&a.model.match(/(true)/gi)?a.model=!0:a.model=null,a.$watch("model",function(a,b){if(a&&_.isString(a)){var d=a.match(/(true)/gi);$(c).checkbox(d?"set checked":"set unchecked")}}),$(c).checkbox({onChange:function(d,e){b(function(){a.model=$(c).find("input").is(":checked"),a.change&&a.change()})}})}}}]),ngApp.directive("filterProperty",["$compile","$timeout","datasources","formsService",function(a,b,c,d){return{restrict:"E",transclude:!0,replace:!0,scope:{model:"=ngModel",controls:"=",sourceFields:"=?",name:"=?",active:"=?",justValue:"@?"},controller:["$scope",function(a){a.justValue=JSON.parse(a.justValue||"false");var b={type:2};a.add=function(){a.model.push(_.extend({},b))},a.$watch("model",function(c){c||(a.model=a.model||[b])}),a.$watch("sourceFields",function(b){b&&a.justValue&&_.each(b,function(a){a.label=a.Name,a.name=a.UniqueName}),!b&&a.active&&12==a.active.type&&getFormLookupFields(a.active.formLookup,d,function(){})}),a.$watch("controls",function(b){b&&(a.cnts=[],a.cnts=a.cnts.concat(b.row),a.cnts=a.cnts.concat(b.rootControls),a.cnts=_.filter(a.cnts,function(a){return a}),a.cnts=_.filter(a.cnts,function(b){return b.name!==a.name}),a.cnts=_.uniqBy(a.cnts,"name"))})}],template:'<div class="inner-section">                         <div class="field" ng-repeat="f in model track by $index">                            <div class="inline fields" >                                <label class="three wide field">{{\'type\' | translate}}</label>                                <div class="six wide field" >                                    <sm-dropdown model="f.type" class="" settings="{fullTextSearch: true, forceSelection: false}" items="[{type: 1, name:(\'fix value\' | translate)},{type: 2, name:(\'control value\' | translate)},{type: 3, name:(\'متغیر کاربری\' | translate)}]" label="item.name" value="item.type"></sm-dropdown>                                </div>                                <div class="three wide field">                                    <i class="gray pointer icon plus" ng-click="add()"></i>                                    <i class="gray pointer icon delete" ng-click="model.splice($index, 1)" ng-hide="model.length==1"></i>                                </div>                            </div>                            <div class="inline fields" ng-if="f.type == 1">                                <label class="three wide field">{{\'value\' | translate}}</label>                                <input ng-model="f.staticValue" />                            </div>                            <div class="inline fields" ng-if="f.type == 3">                                <label class="three wide field">{{\'value\' | translate}}</label>                                <sadaf-user-variables ng-model="f.staticValue" style="width:100%" ></sadaf-user-variables>                            </div>                                                        <small ng-show="f.type == 2">{{\'control base filter desc\' | translate}}</small>                            <div class="field" >                                <div class="inline fields" ng-show="f.type == 2">                                    <label class="three wide field">{{\'control\' | translate}}</label>                                    <sm-dropdown model="f.control" class="selection fluid" settings="{fullTextSearch: true, forceSelection: false}" items="cnts" label="item.label" value="item.name"></sm-dropdown>                                </div>                            </div>                                                        <small ng-show="f.type == 2">{{\'control base filter desc 2\' | translate}}</small>                            <div class="inline fields" ng-show="sourceFields" ng-show="f.type == 2">                                <label class="three wide field">{{\'column\' | translate}}</label>                                <sm-dropdown model="f.sourceField" class="selection fluid" settings="{fullTextSearch: true, forceSelection: false}" items="sourceFields" label="item.label" value="item.name"></sm-dropdown>                            </div>                            <div class="field">                                <div class="inline fields" ng-show="f.type == 2 && f.sourceField == \'سفارشی...\'">                                    <label class="three wide field">{{\'control\' | translate}}</label>                                    <auto class="nine wide field ltr" names="sourceFields" ng-model="f.sourceFieldFormula" ></auto>                                </div>                            </div>                        </div>                   </div>'}}]),ngApp.directive("tableLookup",["$compile","$timeout","formsService",function(a,b,c){return{restrict:"E",transclude:!0,replace:!0,scope:{model:"=ngModel",controls:"="},controller:["$scope","formsService","datasources",function(a,b,c){function d(){function d(){a.fields=_.map(e.dropdown.datasourceColumns,function(a){return{Name:a.Name,UniqueName:a.UniqueName}}),a.fields.push({Name:"سفارشی...",UniqueName:"سفارشی..."})}if(a.model.tableLookup){var e=_.find(a.cnts,{name:a.model.tableLookup.controlName});12==e.type&&(a.model.tableLookup.lookupField=e.formLookup.keyControls[0],a.model.tableLookup.id=e.formLookup.form,a.model.tableLookup.type="form",getFormLookupFields(e.formLookup,b,function(){a.fields=_.map(e.formLookup.formLookupSourceFields,function(a){return{Name:a.label,UniqueName:a.columnName}}),a.fields.push({Name:"سفارشی...",UniqueName:"سفارشی..."})})),4==e.type&&(a.model.tableLookup.type="datasource",a.model.tableLookup.id=+e.dropdown.remoteDatasource.value,a.model.tableLookup.lookupField="سفارشی..."==e.dropdown.remoteColumnKey?e.dropdown.remoteColumnKeyFormula:e.dropdown.remoteColumnKey,e.dropdown.datasourceColumns?d():getDatasourceColumns(e.dropdown.remoteDatasource.value,c).then(function(a){e.dropdown.datasourceColumns=a,d()}))}}a.$watch("model",function(b){b||null==a.model||(a.model.tableLookup=a.model.tableLookup||{})}),a.$watch("controls",function(b){b&&(a.cnts=[],a.cnts=a.cnts.concat(b.row),a.cnts=a.cnts.concat(b.rootControls),a.cnts=_.filter(a.cnts,function(a){return 12==a.type||4==a.type&&a.dropdown.useRemoteData}),a.cnts=_.filter(a.cnts,function(b){return b.name!=a.name}),a.cnts=_.uniqBy(a.cnts,"name"))}),a.$watch("model.tableLookup.controlName",function(a,b){a&&d()}),d()}],template:'<div class="">                              <div class="field">                                <small>{{\'extra info desc\' | translate}}</small>                                <div class="inline fields">                                    <label class="three wide field">{{\'control\' | translate}}</label>                                    <sm-dropdown model="model.tableLookup.controlName" class="selection fluid" settings="{fullTextSearch: true, forceSelection: false}" items="cnts" label="item.label" value="item.name"></sm-dropdown>                                </div>                                <div class="inline fields">                                    <label class="three wide field">{{\'column\' | translate}}</label>                                    <sm-dropdown model="model.tableLookup.resultField" class="selection search fluid" settings="{fullTextSearch: true, forceSelection: false}"                                                  items="fields" label="item.Name" value="item.UniqueName"></sm-dropdown>                                </div>                                <div class="field" ng-show="fields && model.tableLookup.resultField == \'سفارشی...\'">                                    <label>فرمول مربوط به کلید</label>                                    <auto  names="fields" class="ltr" ng-model="model.tableLookup.resultFieldFormula" ></auto>                                </div>                            </div>                       </div>',link:function(a,b,c){}}}]),ngApp.directive("sadafDraggable",["$timeout",function(a){return function(a,b,c){function d(){$("[sadaf-draggable]").draggable({connectToSortable:"[sadaf-sortable]",helper:"clone",revert:"invalid",start:function(a,b){$(b.helper).css("width",$(b.helper).width()+"px")},stop:function(a,b){$(b.helper).css("width","100%")}}),$("[sadaf-draggable]").disableSelection()}a.$last&&d()}}]),ngApp.directive("sadafSortable",["$timeout",function(a){return function(a,b,c){function d(){$("[sadaf-sortable]").sortable({revert:!0}),$("[sadaf-sortable]").disableSelection()}d()}}]),ngApp.directive("sadafCalendar",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",control:"=?",ngChange:"&?",sdKeyup:"&"},template:'<div style="display:inline-block;width:100%;"><input type="text" id=""  class="form-control from" placeholder="{{\'date\' | translate}}" /><input id="from-value" type="hidden"/></div>',link:function(a,b,c){function d(){function c(b){a.$apply(function(){a.model=unixToString(b,g,"miladi"===a.control.dataType)}),a.ngChange&&a.$apply(function(){a.ngChange()})}var d=!1;try{d=a.$parent.$parent.$parent.component.justMonth}catch(f){}var g=d?"YYYY/MM":"YYYY/MM/DD",h=b.find(" .from");e=h.pDatepicker({autoClose:!0,calendarType:"miladi"===a.control.dataType?"gregorian":"persian",format:g,toolbox:{calendarSwitch:{enabled:!1}},initialValue:!1,onSelect:function(a){d&&c(a)},dayPicker:{enabled:!d,onSelect:function(a){c(a)}}}),h.change(function(b){var c=$(b.target).val();return _.isEmpty(c)?void(a.model=null):(c=depersian(c),e.setDate(stringToUnix(c,"miladi"===a.control.dataType)),a.$apply(function(){a.model=unixToString(stringToUnix(c,"miladi"===a.control.dataType),g,"miladi"===a.control.dataType)}),void(a.ngChange&&a.$apply(function(){a.ngChange()})))}),h.keyup(function(b){a.sdKeyup({$event:b})}),a.model&&e.setDate(stringToUnix(a.model,"miladi"===a.control.dataType))}a.control=a.control||{};var e=null;b.find("input").val(persian(a.model,!0)),b.find("input").focus(function(){$(this).data("handle")||($(this).data("handle",!0),d())}),a.$watch("model",function(c){c||b.find(" .pwt-datepicker-input-element").val(""),a.model&&(e?e.setDate(stringToUnix(a.model,"miladi"===a.control.dataType)):b.find("input").val(persian(a.model,!0)))})}}}),ngApp.directive("sadafCalendarRange",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",sdKeyup:"&"},template:'<div class="" style="display:flex; flex-direction:row;">                        <div class="" style="flex-grow:1;">                            <input id="" type="text" class="datepicker from" placeholder="تاریخ شروع" />                            <input id="from-value" type="hidden"/>                        </div>                        <div class="" style="padding: 8px;">تا</div>                        <div class="" style="flex-grow:1;">                            <input id="" type="text" class="datepicker to" placeholder="تاریخ پایان"/>                            <input id="to-value" type="hidden"/>                        </div>                      </div>',link:function(a,b,c){b.find(" .from").datepicker({changeMonth:!0,changeYear:!0,dateFormat:"yy/mm/dd",yearRange:"-100:+100",altFormat:"yy/mm/dd",altField:b.find("#from-value"),onClose:function(c){return a.model=a.model||{},c?(b.find(".to").datepicker("option","minDate",c),a.model.from=c,void a.$apply()):void(a.model.from=null)}}),b.find(".to").datepicker({defaultDate:"+1w",changeYear:!0,changeMonth:!0,dateFormat:"yy/mm/dd",altFormat:"yy/mm/dd",yearRange:"-100:+100",altField:b.find("#to-value"),onClose:function(c){return a.model=a.model||{},c?(b.find(".from").datepicker("option","maxDate",c),a.model.to=c,void a.$apply()):void(a.model.to=null)}}),a.$watch("model",function(c){a.model&&(b.find(".from").datepicker("setDate",a.model.from),b.find(".to").datepicker("setDate",a.model.to))})}}}),ngApp.directive("sadafTime",["$compile","$timeout",function(a,b){return{restrict:"E",replace:!0,scope:{model:"=ngModel",change:"&?ngChange"},template:'<div class="" >                        <input list="timeList" type="time" ng-model="timeValue" ng-change="xchange()"/>                        <datalist id="timeList">                            <option value="01:00">                            <option value="02:00">                            <option value="03:00">                            <option value="04:00">                            <option value="05:00">                            <option value="06:00">                            <option value="07:00">                            <option value="08:00">                            <option value="09:00">                            <option value="10:00">                            <option value="11:00">                            <option value="12:00">                            <option value="13:00">                            <option value="14:00">                            <option value="15:00">                            <option value="16:00">                            <option value="17:00">                            <option value="18:00">                            <option value="19:00">                            <option value="20:00">                            <option value="21:00">                            <option value="22:00">                            <option value="23:00">                            <option value="24:00">                        </datalist>                   </div>',link:function(a,c,d){a.silent=!1,a.timeValue,a.xchange=function(){a.silent=!0,a.model=a.timeValue.toTimeString().split(" ")[0].substring(0,5),b(function(){a.silent=!1}),console.log("### timeValue",a.timeValue,a.model),b(function(){a.change()})},a.$watch("model",function(b,c){if(!a.silent)return b?void(a.timeValue=new Date("1969-12-31 "+a.model)):void(a.timeValue=null)})}}}]),ngApp.directive("sadafTimeRange",["$compile","$timeout",function(a,b){return{restrict:"E",replace:!0,scope:{model:"=ngModel",change:"&?ngChange"},template:'<div class="" style="display:flex; flex-direction:row;">                        <div class="" style="flex-grow:1;">                        <input list="timeListFrom" type="time" ng-model="timeFrom" ng-change="change()"/>                        <datalist id="timeListFrom">                            <option value="01:00">                            <option value="02:00">                            <option value="03:00">                            <option value="04:00">                            <option value="05:00">                            <option value="06:00">                            <option value="07:00">                            <option value="08:00">                            <option value="09:00">                            <option value="10:00">                            <option value="11:00">                            <option value="12:00">                            <option value="13:00">                            <option value="14:00">                            <option value="15:00">                            <option value="16:00">                            <option value="17:00">                            <option value="18:00">                            <option value="19:00">                            <option value="20:00">                            <option value="21:00">                            <option value="22:00">                            <option value="23:00">                            <option value="24:00">                        </datalist>                        </div>                        <div class="" style="padding: 8px ;">تا</div>                        <div class="" style="flex-grow:1;">                        <input list="timeListTo" type="time" ng-model="timeTo" ng-change="change()" />                        <datalist id="timeListTo">                            <option value="01:00">                            <option value="02:00">                            <option value="03:00">                            <option value="04:00">                            <option value="05:00">                            <option value="06:00">                            <option value="07:00">                            <option value="08:00">                            <option value="09:00">                            <option value="10:00">                            <option value="11:00">                            <option value="12:00">                            <option value="13:00">                            <option value="14:00">                            <option value="15:00">                            <option value="16:00">                            <option value="17:00">                            <option value="18:00">                            <option value="19:00">                            <option value="20:00">                            <option value="21:00">                            <option value="22:00">                            <option value="23:00">                            <option value="24:00">                        </datalist>                        </div>                      </div>',link:function(a,c,d){a.silent=!1,a.timeFrom,a.timeTo,a.model=a.model||{},a.$watch("timeFrom",function(c,d){c&&(a.silent=!0,a.model=a.model||{},a.model.from=a.timeFrom.toTimeString().split(" ")[0].substring(0,5),"Inval"==a.model.from&&(a.model.from=null),b(function(){a.silent=!1}))}),a.$watch("timeTo",function(c,d){c&&(a.silent=!0,a.model=a.model||{},a.model.to=a.timeTo.toTimeString().split(" ")[0].substring(0,5),"Inval"==a.model.to&&(a.model.to=null),b(function(){a.silent=!1}))}),a.$watch("model",function(c,d){if(!a.silent)return c?void b(function(){a.timeFrom=new Date("1969-12-31 "+a.model.from),a.timeTo=new Date("1969-12-31 "+a.model.to)}):(a.timeFrom={},void(a.timeTo={}))}),a.model||(a.timeFrom=new Date("1969-12-31 "+a.model.from),a.timeTo=new Date("1969-12-31 "+a.model.to))}}}]),ngApp.directive("sadafDateTime",["$compile","$timeout",function(a,b){return{restrict:"E",replace:!0,scope:{model:"=ngModel",change:"&?ngChange"},template:'<div class="two column fields" style="padding: 0 !important;">                           <sadaf-calendar class="wide column" ng-change="change()" ng-model="innerModel.date" style="padding: 0 !important;"></sadaf-calendar>                           <sadaf-time ng-change="change()" class="wide column" ng-model="innerModel.time"  style="padding: 0 1rem !important;"></sadaf-time>                       </div>',link:function(a,c,d){function e(){b(function(){a.silent=!1},0)}function f(a){return a<10?"0"+a:a}a.innerModel={},a.silent=!1,a.$watch("innerModel",function(b,c){if(b&&(b.time||b.date)&&!a.silent){var d=b.time||"00:00",f=b.date||"1397/01/01";a.silent=!0,a.model=f+" "+d+":00",e()}},!0),a.$watch("model",function(b,c){if(!b)return a.innerModel.date=null,void(a.innerModel.time=null);if(!a.silent){var d=b.split(/[\/: ]/).map(function(a){return+a});a.silent=!0,a.innerModel.date=d[0]+"/"+f(d[1])+"/"+f(d[2]),a.innerModel.time=f(d[3])+":"+f(d[4]),e()}},!0)}}}]),ngApp.directive("sadafFile",["$compile","$timeout",function(a,b){return{restrict:"E",transclude:!0,replace:!0,scope:{model:"=ngModel"},controller:["$scope","Upload",function(a,b){function c(){_.each(a.model.attachment.uploadList,function(a){a.added||(a.added=!0,e(a))})}function d(a){var b={docx:"word",doc:"word",pptx:"powerpoint",ppt:"powerpoint",pdf:"pdf",xlsx:"excel",xls:"excel",mp4:"video",mp3:"audio",wma:"audio"},c=a.name.split(".").pop().toLowerCase();a.icon=b[c]}function e(a){d(a),b.upload({url:app.urlPrefix+"api/Upload/PostFile",data:{file:a}}).then(function(b){a.serverPath=b.data[0].path,a.fileName=b.data[0].name,a.success=!0},function(a){},function(b){var c=parseInt(100*b.loaded/b.total);a.progress=c,b.loaded==b.total&&(a.uploadFinish=!0)})}a.files,a.progress=null,a.model.attachment=a.model.attachment||{},a.model.attachment.uploadList=a.model.attachment.uploadList||[],_.each(a.model.attachment.uploadList,function(a){a.added=!0,a.name=a.fileName,a.uploadFinish=!0,a.success=!0,d(a)}),a.upload=function(b,d,e){b&&b.length&&(_.each(b,function(b){a.model.attachment.uploadList.push(b)}),c())},a.getLink=function(a){return a.serverDbId?app.urlPrefix+"api/upload/get/"+a.serverDbId:app.urlPrefix+"api/upload/get?path="+a.serverPath+"&name="+encodeURI(a.name)},a.getSrc=function(a){return app.urlPrefix+"images/file_word.png"}}],template:'<div class="file-uplaod ">                            <div class="ui secondary pointing tiny menu">                                <div class="active item">{{model.label}} <span ng-show="model.validations.isRequire" style="color:#db2828">&nbsp;*&nbsp;</span></div>                                <div class="ui right item" ng-hide="model.readonly">                                    <div class="pointer" ngf-select ngf-change="upload($files, $event, $rejectedFiles)" ngf-multiple="true"  ngf-allow-dir="false" ngf-accept="\'*\'">{{\'add file\' | translate}}<i class="icon plus square outline large"></i></div>                                </div>                            </div>                                                              <div ng-hide="model.attachment.uploadList.length" class="gray center aligned twelve wide column"><small>{{\'no file selected\' | translate}}</small></div>                            <div class="">                                <div ng-repeat="file in model.attachment.uploadList" class="file-item" >                                    <div class="">                                        <div class="">                                            <span class="ui img"><i class="icon file outline large" ng-class="file.icon"></i></span>                                            <span ng-hide="file.serverDbId || file.serverPath">{{file.name}} </span>                                            <a ng-show="file.serverDbId || file.serverPath"class="file-link" target="_blank" href="{{getLink(file)}}">{{file.name}} </a>                                            <span ng-show="file.uploadFinish && file.success && !model.readonly" class="pointer" ng-click="model.attachment.uploadList.splice($index,1)"><i class="icon remove small grey"></i></span>                                            <span ng-show="file.uploadFinish && !file.success" class="ui tiny"><span class="ui text tiny active inline center loader" ></span></span>                                            <sm-progress class="blue tiny" model="file.progress" ng-show="file.progress != null && !file.uploadFinish" style="margin-top:4px;"></sm-progress>                                        </div>                                    <div>                                </div>                             </div>                        </div>'}}]),ngApp.service("controlPropertyService",["formsService",function(a){function b(){return c.control}var c={};return c.control={active:null,setActive:function(a){a&&(c.control.active&&(c.control.active.isActive=!1),c.control.active=a,c.control.active.isActive=!0)},remove:function(a,b){var d=confirm(app.lang.translate("delete control message"));d&&(dangerChangeOccured=!0,c.pages.activePage.controls.splice(a,1))},createItems:function(a){if(a.dropdown.itemsTemp){var b=a.dropdown.itemsTemp.split(/[\r\n]/);a.dropdown.items=[],_.each(b,function(b){var c=b.trim();a&&""!=c&&a.dropdown.items.push({label:c,value:c})})}},resetListValue:function(){c.control.active.dropdown&&(c.control.active.dropdown.listValue=[])}},{setActive:c.control.setActive,remove:c.control.remove,getActive:c.control.active,createItems:c.control.createItems,get:b}}]),ngApp.service("updateModel",["$http",function(a){function b(a){}function c(a){}return{updateValuesForSave:c,updateValuesForGet:b}}]),ngApp.service("formsService",["$http","updateModel",function(a,b){var c=0,d=!1,e={},f=function(a){a&&(e[a]=null)},g=function(f,g){f||(f="");var h="";return g&&(h="?fromEditor=true"),e[f||"all"]||(e[f||"all"]=a.get(app.urlPrefix+"api/forms/get/"+f+h).then(function(a){return f?(b.updateValuesForGet(a.data.model.pages),a.data.model.modalSize||(a.data.model.modalSize="large"),a.data):(c=a.data.formsModule,d=a.data.securityCertPatch,a.data.list)})),e[f||"all"]},h=function(b,c){return e={},a.post(app.urlPrefix+"api/forms/save/"+b,c).then(function(a){return a.data})},i=function(b){return e={},a.post(app.urlPrefix+"api/forms/delete/"+b).then(function(a){return a.data})},j=function(b){return e={},a.post(app.urlPrefix+"api/forms/copy/"+b).then(function(a){return a.data})},k=function(b,c){return e={},a.post(app.urlPrefix+"api/forms/addFormToDashboard/"+b,c).then(function(a){return a.data})},l=function(b,c){return a.post(app.urlPrefix+"api/forms/deleteFormFromDashboard/"+b,c).then(function(a){return a.data})},m=function(b,c){var d={values:c,tableLookup:b};return a.post(app.urlPrefix+"api/forms/getTableLookup",d).then(function(a){return a.data})},n=function(b,c,d){return a.post(app.urlPrefix+"api/forms/publish",{name:c,id:b,publish:d}).then(function(a){return a.data})};return{save:h,copy:j,get:g,remove:i,addFormToDashboard:k,deleteFormFromDashboard:l,getFormsModule:function(){return c},securityCertPatch:function(){return d},clearCache:f,tableLookup:m,publish:n}}]),ngApp.directive("sadafTasks",["$compile","$timeout",function(a,b){return{restrict:"E",transclude:!0,scope:{model:"=ngModel"},controller:["$scope",function(a){function b(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,function(a){return(a^crypto.getRandomValues(new Uint8Array(1))[0]&15>>a/4).toString(16)})}a.add=function(){a.model=a.model||[],a.model.push({type:0,openLinkType:0,uuid:b()})},a.addWebParam=function(a){a.webserviceParameters=a.webserviceParameters||[],a.webserviceParameters.push({})}}],template:'<div class="" style="margin: 30px 0;"><div class="ui mini icon button" ng-click="add()">{{\'add task\' | translate}} <i class="ui icon add"></i></div><div class="ui secondary black segment" style="margin-left: -12px;margin-right: -12px;border-radius: 0;" ng-repeat="task in model" ng-init="model = model || []">        <button ng-click="model.splice($index, 1)" class="ui mini  basic icon button" style="box-shadow: none; position: absolute; top :0; left:0;" ><i class="ui icon close"></i></button>        <div class="inline fields">            <label class="four wide field">{{\'type\' | translate}}</label>            <div class="eight wide field"><sm-dropdown items="[{label:(\'goto dashboard\' | translate), value:0}                         , {label:(\'sms\' | translate), value:4}                         , {label:(\'email\' | translate), value:5}                         , {label:(\'web service\' | translate), value:2}                         , {label:(\'javascript\' | translate), value:3}]"                         style="width: 100%;"                         model="task.type" label="item.label" value="item.value"></sm-dropdown></div>        </div>        <div class="field" ng-show="task.type == 0">                 <label class="">{{\'dashboard\'|translate}}</label>                 <select-menu class="" ng-model="task.dashboardId"></select-menu>        </div>        <div class="inline fields" ng-show="task.type == 0">            <label class="four wide field">{{\'open type\'|translate}}</label>            <div class="eight wide field"><sm-dropdown items="[{label:(\'new page\' | translate), value:0}, {label:(\'current page\' | translate), value:1}]"                         style="width: 100%;"                         model="task.openLinkType" label="item.label" value="item.value"></sm-dropdown></div>        </div>        <div class="field" ng-show="task.type == 1">            <form-lookup-property ng-model="task.formInfo" settings="{selectableColumns:false}"></form-lookup-property>        </div>        <div class="field" ng-show="task.type == 2">            <label>{{\'آدرس\' | translate}}</label>            <input style="direction: ltr;" ng-model="task.webserviceUrl" placeholder="{{\'آدرس\' | translate}}">        </div>        <div class="field" ng-show="task.type == 5">            <label>{{\'موضوع\' | translate}}</label>            <input ng-model="task.subject"/>            <small>برای استفاده از متغیرها از نام متغیر با پیشوند @ استفاده کنید</small>        </div>        <div class="field" ng-show="task.type == 4 ||task.type == 5">            <label>{{\'متن پیام\' | translate}}</label>            <textarea ng-model="task.smsBody"></textarea>            <small>برای استفاده از متغیرها در متن پیام از نام متغیر با پیشوند @ استفاده کنید</small>        </div>        <div class="field" ng-show="task.type == 4 || task.type == 5">            <label>{{\'roles\' | translate}}</label>            <select-roles ng-model="task.smsRoles"></select-roles>        </div>        <div class="field" ng-show="task.type == 4 || task.type == 5">            <sadaf-checkbox ng-model="task.sendOwner" label="">ارسال به ایجاد کننده</sadaf-checkbox>            <sadaf-checkbox ng-model="task.sendEditor" label="">ارسال به ویرایش کننده</sadaf-checkbox>        </div>        <div class="inline fields" ng-show="task.type == 2">            <label class="four wide field">{{\'method\' | translate}}</label>            <div class="eight wide field"><sm-dropdown items="[                         {label:\'GET\' , value:0}                         , {label:\'POST\', value:1}]"                         style="width: 100%;"                         model="task.webserviceMethod" label="item.label" value="item.value"></sm-dropdown></div>            <div><small>در صورت نیاز به ارسال مقدار از کنترل‌های فرم در داده‌ها یا لینک از اسم فیلد مورد نظر به شکل زیر استفاده کنید.                    <span class="ltr ui code">@(field-1)</span></small></div>        </div>        <xdiv class="field" ng-show="task.type == 2">            <label>{{\'parameters\' | translate}}</label>            <div ng-repeat="p in task.webserviceParameters">                <div style="padding-left: 20px;position: relative;">                    <input ng-model="p.key" class="form-flat-input" type="text" placeholder="key">                    <input ng-model="p.value" class="form-flat-input" type="text" placeholder="value">                    <i style="position:absolute; left:0; top:0;" class="ui icon close pointer" ng-click="task.webserviceParameters.splice($index, 1)"></i>                </div>            </div>            <span class="link-button" ng-click="addWebParam(task)">{{\'new row\' | translate}} <i class="ui icon add"></i></span>            <div><small>مقدار خروجی وب سرویس در مدل مربوط به همین فیلد در مسیر زیر ذخیره می‌شود.                    <span class="ltr ui code">model.task.webserviceResult</span></small></div>        </xdiv>        <div class="field" ng-show="task.type == 2">            <label>{{\'parameters\' | translate}}</label>                    <textarea  ng-model="task.webservicePostData" class="ltr" type="text" placeholder="data"/>        </div>        <div class="field" ng-show="task.type == 2">            <label>قرارداد مقدار وب سرویس در فیلد</label>            <sm-dropdown class="selection search" model="task.webserviceResultInField" items="$parent.$parent.c.pages.activePage.controls" label="item.label" value="item.name"/>        </div>        <div class="field" ng-show="task.type == 3">            <label>{{\'javascript\' | translate}}</label>            <textarea ng-model="task.script" style="direction:ltr; font-family:monospace;"placeholder="{{\'javascript\' | translate}}"></textarea>        </div>    </div></div>'}}]),ngApp.service("taskExecutor",["$http","$rootScope",function($http,$rootScope){function exec(task,formModel,scope){
function replaceValue(a){return a.replace(/@\((field-\d+)\)/gim,function(a,b){var c=findControl(b,formModel.pages);if(null===c)return"";if(19===c.type){var d=c.attachment.uploadList[0].serverPath;c.attachment.uploadList[0].serverDbId;return d}if(12===c.type){var e=c.formLookup.keyControlsBindedValue[0];return c.formLookup.keyControlsBindedText&&(e=c.formLookup.keyControlsBindedText[0]),e}return c.value})}if(0===task.type){if(!+task.dashboardId)return;var name=0===+task.openLinkType?"_blank":"_self";window.open(app.urlPrefix+"#/dashboard/"+task.dashboardId,name)}if(2===task.type){if(_.isEmpty(task.webserviceUrl))return;var url=replaceValue(task.webserviceUrl);scope.model.progress=!0;var fail=function(){scope.model.progress=!1,alert(app.lang.translate("unsuccessfull run"))},successfull=function(a){scope.model.progress=!1;var b=a.data;_.isString(b)||(b=JSON.stringify(b)),task.webserviceResult=b,formModel.webservicesData=formModel.webservicesData||{},formModel.webservicesData[scope.model.name]=b;var c=findControl(task.webserviceResultInField,formModel.pages);c&&(c.value=b)};if(1===task.webserviceMethod){var data={};task.webserviceParameters&&_.each(task.webserviceParameters,function(a){data[a.key]=a.value});var data=task.webservicePostData;data=replaceValue(data),$http({url:url,method:"POST",data:JSON.parse(data)}).then(successfull)["catch"](fail)}0===task.webserviceMethod&&$http.get(url).then(successfull)["catch"](fail)}if(3==task.type){if(_.isEmpty(replaceValue(task.script)))return;eval(task.script)}}return{exec:exec}}]),ngApp.directive("inlineStyle",["$compile",function(a){return{restrict:"E",link:function(b,c){if(c.html()){var d=a('<style ng-bind-template="'+c.html()+'"></style>');c.replaceWith(d(b))}}}}])}(),function(){var a=angular.module("sadafForms");a.directive("accessProperty",["$compile","$timeout",function(a,b){return{restrict:"E",transclude:!0,replace:!0,scope:{model:"=ngModel",controls:"=",name:"=?"},controller:["$scope","$http",function(a,b){var c={type:1,baseon:1};a.add=function(){a.model=a.model||[],a.model.push(_.extend({},c))},b.get(app.urlPrefix+"api/users/getPropertyAutoCompleteEntries").then(function(a){$scope.variables=a.data.keys})["catch"](function(){})}],templateUrl:app.urlPrefix+"dist/partial/forms/editor/components/access-property.html?v="+app.version}}])}(),function(){var a=angular.module("sadafForms");a.directive("formAlert",["$compile","$timeout",function(a,b){return{restrict:"E",transclude:!0,replace:!0,scope:{model:"=ngModel",edit:"@?"},controller:["$scope","$http",function(a,b){}],templateUrl:app.urlPrefix+"dist/partial/forms/editor/components/alert.html?v="+app.version}}])}(),function(){var a=angular.module("sadafForms");a.directive("commnetEditor",["$compile","$timeout",function(a,b){return{restrict:"E",transclude:!0,replace:!0,scope:{model:"=ngModel",onsave:"="},controller:["$scope","$http",function(a,b){var c,d;a.change=function(a,b,d,e,f,g,h){c=f},a.onCreate=function(a){d=a,d.keyboard.addBinding({key:13,ctrlKey:!0},function(){console.log("### Cnrt + Enter")});var b='{"ops":[{"insert":"الا یا ایها الساقی ادر کاسا و ناولها"}]}';d.setContents(JSON.parse(b))},a.save=function(){a.onsave&&a.onsave(a.value,c)}}],templateUrl:app.urlPrefix+"dist/partial/forms/editor/components/comment-editor.html?v="+app.version}}])}(),function(){var a=angular.module("sadafForms");a.directive("formComment",["$compile","$timeout",function(a,b){return{restrict:"E",transclude:!0,replace:!0,scope:{model:"=ngModel"},controller:["$scope","$http",function(a,b){var c,d;a.comments=[{id:"asdfsadklfhsdfkl",userId:10,addUser:"ali",addTime:1e4,editUser:"reza",editTime:1e4,content:"<b>سلام</b> من مدیر این بخش هستم"},{id:"asdfsadklfhsdfkl",userId:10,addUser:"ali",addTime:1e4,editUser:"reza",editTime:1e4,content:"<b>سلام</b> من مدیر این بخش هستم"},{id:"asdfsadklfhsdfkl",userId:10,addUser:"ali",addTime:1e4,editUser:"reza",editTime:1e4,content:"<b>سلام</b> من مدیر این بخش هستم"},{id:"asdfsadklfhsdfkl",userId:10,addUser:"ali",addTime:1e4,editUser:"reza",editTime:1e4,content:"<b>سلام</b> من مدیر این بخش هستم"},{id:"asdfsadklfhsdfkl",userId:10,addUser:"ali",addTime:1e4,editUser:"reza",editTime:1e4,content:"<b>سلام</b> من مدیر این بخش هستم"},{id:"asdfsadklfhsdfkl2",userId:10,addUser:"ali",addTime:1e4,editUser:"reza",editTime:1e4,content:"<b>سلام</b> من مدیر این بخش هستم"}],a.change=function(a,b,d,e,f,g,h){c=f},a.onCreate=function(a){d=a;var b='{"ops":[{"insert":"الا یا ایها الساقی ادر کاسا و ناولها"}]}';d.setContents(JSON.parse(b))},a.setContent=function(){}}],templateUrl:app.urlPrefix+"dist/partial/forms/editor/components/comment.html?v="+app.version}}])}(),function(){function a(b,c,d,e,f){function g(){var g=JSON.stringify(h);b.rows=[];var j="#";if(i)for(var m=0;m<k.length;m++){for(var n=[],o=0;o<l.length;o++)for(var p=2;p<b.model.multiRowForm.rows[m*l.length+o].length;p++){var q=b.model.multiRowForm.rows[m*l.length+o][p];q.columnClass="twelve",n.push(q)}b.rows.push(n)}else{b.model.multiRowForm.rows=[];for(var m=0;m<k.length;m++){for(var n=[],o=0;o<l.length;o++){var r=JSON.parse(g);j=r[0].label,r[0].value=k[m].value,r[1].value=l[o].value,b.model.multiRowForm.rows.push(r);for(var p=2;p<r.length;p++)r[p].columnClass="twelve",n.push(r[p])}b.rows.push(n)}}b.refresh=function(){b.model.multiRowForm.deletedIds=b.model.multiRowForm.deletedIds||[],_.each(b.model.multiRowForm.rows,function(a){b.model.multiRowForm.deletedIds.push(a[0].rowId)}),b.model.multiRowForm.rows=[],a(b,c,d,e,f)};var s=b.rows[0].length,t='<th xng-click="refresh()">'+j+'</th><th colspan="'+s+'">'+_.join(_.map(l,"label"),"</th><th>")+"</th>",u='<table class="ui celled compact table" style="padding:0"><thead><tr>'+t+'</tr><thead><tr ng-repeat="row in rows track by $index">                    <td>{{rowCaptions[$index].label}}</td>                    <td ng-repeat="col in row track by $index">                        <form-control change="changeValue(model)"settings="{showLabel:false}" ng-model="col" id="{{id}}"></form-control>                    </td>                 </tr></table>',v=angular.element(u);d(v)(b),angular.element(c[0].querySelector(".content-form")).html(v),c[0].querySelector(".ui.menu")&&c[0].querySelector(".ui.menu").remove()}var h=b.model.multiRowForm.emptyRow,i=!1;try{i=b.model.multiRowForm.rows[0][0].rowId>0}catch(j){}var k=h[0].dropdown.useRemoteData?h[0].dropdown.remoteItems||[]:h[0].dropdown.items;b.rowCaptions=k;var l=h[1].dropdown.items;b.root&&b.root.registerChangeNotify&&b.root.registerChangeNotify(function(a){var c=[h[0],h[1]],d=!1;_.each(c,function(b){if(b.useFilter&&(d=_.find(b.filters,{control:a.name})))return!1}),d&&(console.log("### [renderMatrixMode] change",a),b.refresh())},"change-"+b.name);var m=function(a,c){_.each(a.filters,function(a){2==a.type&&(a.controlValue=b.root.allControlMap[a.control].value)});var d={id:b.id,query:"",name:a.name,filters:a.useFilter?a.filters:[]},f=app.urlPrefix+"api/forms/getdropdowndata?"+$.param(d);return e.get(f).then(function(a){return a.data._type=c,a.data})};if(h[0].dropdown.useRemoteData||h[1].dropdown.useRemoteData){var n=[];h[0].dropdown.useRemoteData&&n.push(m(h[0],"row")),h[1].dropdown.useRemoteData&&n.push(m(h[1])),f.all(n).then(function(a){var c=_.find(a,{_type:"row"});c&&(k=c.fields,b.rowCaptions=k),g()})}else g()}var b=angular.module("sadafForms");b.directive("multiRowForm",["$compile","$timeout","$http","$q",function(b,c,d,e){return{restrict:"E",replace:!0,transclude:!0,scope:{root:"=?",model:"=ngModel",settings:"=?",id:"@",edit:"@",ngChange:"&?",editContext:"=?"},controller:["$scope","$http","formsService","controlPropertyService","$timeout",function(a,b,c,d,e){function f(){_.each(a.model.multiRowForm.rows,function(a,b){_.each(a,function(a){a.index=b})})}a.model=a.model||{},a.firstRow=a.model.multiRowForm.rows[0],a.matrixMode=!0,a.sortableOptions={placeholder:"form-control-highlight",handle:".drag-handle"},a.control=d.get(),a.setProp=function(b){a.control.setActive(b)},a.remove=function(b,c){var d=confirm(app.lang.translate("delete control message"));d&&a.model.multiRowForm.rows[0].splice(c,1)},a.copy=function(b,c){var d=_.extend({},b);d.name=a.editContext.pages.naming.getName(),d.columnName=d.columnName+"-copy",a.model.multiRowForm.rows[0].splice(c+1,0,d)};var g={};a.addRow=function(){if(!a.edit){var b=[];_.each(a.model.multiRowForm.emptyRow,function(c){var d=JSON.parse(JSON.stringify(c));return d.uiConfig=JSON.parse(d.uiConfigSerialized||"{}"),d.rowId=0,d&&2==d.type&&d.validations&&d.validations.autoIncrement?(g[d.name]=(g[d.name]||+d.value)+1,void(d.value=g[d.name])):(d.value=null,d.dropdown&&(d.dropdown.listValue=null),d.rowIndex=a.model.multiRowForm.rows.length,void b.push(d))}),_.each(b,function(b){a.model.setDefaultFunction&&a.model.setDefaultFunction(b)}),a.model.multiRowForm.rows.push(b),f(),a.ngChange&&a.ngChange()}},a.removeRow=function(b,c){var d=b.splice(c,1);a.model.multiRowForm.deletedIds=a.model.multiRowForm.deletedIds||[],a.model.multiRowForm.deletedIds.push(d[0][0].rowId),f()},a.copyRow=function(a,b){var c=a[b],d=_.cloneDeep(c);_.each(d,function(a){a.rowId=0,22==a.type&&_.each(a.controlGroup.controls,function(a){a.rowId=0})}),a.splice(b,0,d),f()},a.model.multiRowForm.rows.length||a.addRow(),a.changeValue=function(b){a.ngChange&&a.ngChange({model:b})},a.textToDigit=function(a){var b="ten"==a?10:"nine"==a?9:"eight"==a?8:"seven"==a?7:"six"==a?6:"five"==a?5:"four"==a?4:"three"==a?3:"two"==a?2:1;return b},a.persian=persian,a.needGrid="group"!=a.model.uiConfig.theme||a.edit,f()}],template:'<div class="ui form field" ng-class="model.multiRowForm.controlSize">                            <div class="ui secondary pointing tiny menu">                                <div class="active item">{{model.label}} </div>                                <div class="ui right item" ng-hide="model.readonly">                                    <div class="pointer" ng-click="addRow()">{{model.multiRowForm.addKeyText}}<i class="icon plus square outline large"></i></div>                                </div>                            </div>                                <div ng-hide="model.multiRowForm.rows[0].length || !edit" class="gray center aligned twelve wide column"><small>{{\'drag control here\' | translate}}</small></div>                                <div class="ui {{(needGrid?\'grid\':\'\')}} content-form multi-row-container" >                            </div>                       </div>',link:function(c,f,g){function h(){c.model.multiRowForm.columns=c.model.multiRowForm.columns||3;var a=1==c.model.multiRowForm.columns?"one":2==c.model.multiRowForm.columns?"two":3==c.model.multiRowForm.columns?"three":4==c.model.multiRowForm.columns?"four":5==c.model.multiRowForm.columns?"five":6==c.model.multiRowForm.columns?"six":"eight";return a}function i(){var g,i="simple"===c.model.uiConfig.theme?"theme-simple":"normal-theme";if(c.edit)g=angular.element('<div class="drop-target '+i+' doubling column row {{model.multiRowForm.separator? \'separator\':\'\'}}" xui-sortable="sortableOptions"  xng-model="model.multiRowForm.rows[0]"                                                         ng-sortable="{group: {name: \'form\', pull:true}, animation:150}" style="min-height:100px;">                                                                <form-control ng-repeat="component in model.multiRowForm.rows[0] track by $index"                                                             ng-click="setProp(component);$event.stopPropagation();" ng-class="{active: component.isActive}" class="column" remove="remove(component, $index)" copy="copy(component, $index)" edit="true" ng-model="component" id="{{id}}" settings="{fromMultiRow:false}"></form-control>                                                </div>');else{if(c.model.uiConfig.matrixMode)return void a(c,f,b,d,e);var j='    <div class="simple-theme" style="" >                                                <div class="row-number-caption" style="" >#</div>                                                <div ng-class="{hide: component.hidden || component.systemType==1}"  style="flex-grow:{{textToDigit(component.columnClass)}};flex-basis:10%;" ng-repeat="component in model.multiRowForm.rows[0]">                                                    <div class="row-caption"style="">                                                        <div style="min-width:50px">{{component.label}}</div>                                                        <div style="width:48px" ng-hide="model.readonly" xng-if="model.multiRowForm.rows.length > 1 && $last" >&nbsp;</div>                                                        </div>                                                    </div>                                                </div>                                                <div class="simple-theme-container" style="">                                                    <div style="" ng-repeat="row in model.multiRowForm.rows" class="row '+h()+' {{model.multiRowForm.separator? \'separator\':\'\'}}">                                                    <div class="row-number" style="" >{{persian($index+1)}}</div>                                                        <div class="cell" style="flex-grow:{{textToDigit(component.columnClass)}};" ng-class="{hide: component.hidden || component.systemType==1}" ng-repeat="component in row track by $index">                                                                <div style="display:flex;align-items:center;" class="" xng-if="!edit && model.multiRowForm.rows.length > 1 && $last" style="margin:0;">                                                                    <form-control  change="changeValue(model)" style="flex-grow:1;" class="column" remove="remove(component, $index)" ng-model="component" id="{{id}}"  settings="{showLabel:component.index==0 && false, fromMultiRow:true}"></form-control>                                                                </div>                                                        </div>                                                    <div class="ui form" ng-hide="model.readonly" style="width:48px" xng-if="$last" >                                                        <span class="ui icon mini pointer gray" title="کپی کردن ردیف" ng-click="copyRow(model.multiRowForm.rows, $index)">  <i class="link icon copy alternate outline"></i></span>                                                        <span class="ui icon mini pointer gray" title="حذف کردن ردیف" ng-click="removeRow(model.multiRowForm.rows, $index)"><i class="link icon trash alternate outline"></i></span>                                                    </div>                                                </div></div>';"group"==c.model.uiConfig.theme&&(j='<div class="drop-target theme-group doubling column row {{model.multiRowForm.separator? \'separator\':\'\'}}">                                            <div ng-repeat="row in model.multiRowForm.rows" class="" style="background:#fefefe;">                                                        <div class="ui segments" style="margin-bottom:10px">                                                            <div class="ui segment pointer" style="font-size: 1em" ng-click="row.show = !row.show">                                                                <i style="width:30px;" class="ui icon angle left icon-animate" ng-class ="{\'rotate-90\' : row.show}" ></i>                                                                <span class="ui tiny label" >ردیف {{persian($index+1, true)}}</span>                                                                <span ng-repeat="c in row|limitTo:3">&nbsp;&nbsp;&nbsp;{{c.label}}: <b>{{c.value}}</b> <span ng-hide="$last"></span>  </span>                                                            </div>                                                            <div ng-if="row.show" class="ui segment" style="background:#fefefe;">                                                                <i title="حذف کردن ردیف" class="gray pointer icon trash alternate outline" style="position:absolute;left:1rem;z-index:2;" ng-click="removeRow(model.multiRowForm.rows, $index)" xng-click="model.multiRowForm.rows.splice($index, 1)" ></i>                                                                <i title="کپی کردن ردیف" class="gray pointer icon copy alternate outline" style="position:absolute;left:2.5rem;z-index:2;" ng-click="copyRow(model.multiRowForm.rows, $index)" xng-click="model.multiRowForm.rows.splice($index, 1)" ></i>                                                                <span style="position:absolute;left:5rem;z-index:2;" class="ui tiny label" >ردیف {{persian($index+1, true)}}</span>                                                                <div class="ui grid" style="padding:1rem">                                                                    <form-control disabled="{{model.canEdit ? \'false\' :\'true\'}}" change="changeValue(model)" ng-repeat="component in row track by $index"  ng-model="component" id="{{id}}"></form-control>                                                                </div>                                                            </div>                                                </div>                                            </div>                                        </div>'),g=angular.element(j)}b(g)(c),angular.element(f[0].querySelector(".content-form")).html(g)}c.model.accessControlJustNewRecord&&_.each(c.model.multiRowForm.rows,function(a){}),c.$watch("model.multiRowForm.columns",function(a,b){i()}),_.each(c.model.multiRowForm.rows,function(a,b){_.each(a,function(a){a.rowIndex=b})})}}}])}(),function(){var a=angular.module("sadafForms");a.directive("sadafDropdownStatic",["$compile","$timeout","$http",function(a,b,c){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",formId:"@",edit:"@?",ngChange:"&",items:"="},template:"<div></div>",link:function(a,c,d){function e(){function d(){clearTimeout(j),j=setTimeout(function(){var c=$(".form-"+a.model.randomId+" .ui.dropdown").dropdown("get value"),d=_.map($(".form-"+a.model.randomId+" .ui.dropdown").dropdown("get item"),function(a){var b=$(a).text();return"undefined"===b&&(b=$(a).data("text")),b});_.isArray(c)||(c=[c]),c=_.filter(c,null),b(function(){a.model.dropdown.listValue=c,a.model.dropdown.selected=d,a.ngChange&&!l&&a.ngChange()},0)},200)}function e(c){if(a.model.dropdown.listValue||a.model.value){var d=a.model.dropdown.multiSelectDropdown?a.model.dropdown.listValue:a.model.value;d&&d.length||(d=c),null!==d&&($(g).dropdown("set selected",d),b(function(){a.model.dropdown.selected=c||d},0))}}for(var f=a.model.dropdown.multiSelectDropdown,g='<select class="temporal ui fluid '+(f?"multiple":"")+' search selection dropdown" '+(f?"multiple":"")+" >",h=a.model.dropdown.items||[],i=0;i<h.length;i++)g+='  <option value="'+h[i].value+'">'+h[i].label+"</option>";g+="</select>",g=$(g);var j,k={clearable:!0,onChange:function(c,d,e){f||b(function(){a.model.dropdown.selected=[d],a.model.value=c,a.ngChange&&!l&&a.ngChange()},0)},onRemove:function(a,b,c){d()},onAdd:function(a,b,c){d()},message:{noResults:app.lang.translate("No results found.")},fields:{remoteValues:"fields",name:"label",value:"value"},fullTextSearch:!0,forceSelection:!1},l=!0;$(c).html(g),$(g).dropdown(k),$(g).dropdown("clear"),e(),setTimeout(function(){l=!1},500)}e();var f=JSON.stringify(a.model.dropdown.items);a.$watch("model.dropdown.items",function(){var b=JSON.stringify(a.model.dropdown.items);"field-524"==a.model.name,b!=f&&(f=b,e())},!0)}}}])}(),function(){function a(a){var b=a.format;return"custom"===a.format&&(b=a.customFormat||""),b}var b=angular.module("sadafForms");b.directive("auto",["$compile",function(a){return{scope:{names:"=",ngModel:"="},template:'<div style="width:100%;">                            <input sm-popup-inline="{on:\'click\'}" class="ltr" ng-model="ngModel" />                            <sm-popup-detached class="flowing top left transition hidden"><div style="padding:5px;overflow:auto; max-height:120px;"><xul >                                <div class="pointer" ng-repeat="name in names" ng-click="selectedItem($event, name)" ng-hide="$last">{{name.Name}}</div>                            </xul></div></sm-popup-detached>                       </div>',link:function(a,b,c){a.selectedItem=function(b,c){a.ngModel||(a.ngModel=""),a.ngModel+=" "+c.UniqueName,a.showlist=!1},b.bind("keypress",function(b){a.showlist=!0})}}}]),b.directive("sadafDropdwon",["$compile","$timeout","$http",function(b,c,d){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",formId:"@",edit:"@?",ngChange:"&",callback:"=?"},template:"<div></div>",link:function(b,e,f){function g(){clearTimeout(p),p=setTimeout(function(){if($(".form-"+b.model.randomId+" .ui.dropdown").length){var a=$(".form-"+b.model.randomId+" .ui.dropdown").dropdown("get value"),d=_.map($(".form-"+b.model.randomId+" .ui.dropdown").dropdown("get item"),function(a){var b=$(a).text();return"undefined"===b&&(b=$(a).data("text")),b});_.isArray(a)||(a=[a]),a=_.filter(a,null),c(function(){b.model.dropdown.listValue=a,b.model.dropdown.selected=d,b.ngChange&&!s&&b.ngChange()},0)}},200)}function h(a){if(b.model.dropdown.listValue||b.model.value){var d=b.model.dropdown.multiSelectDropdown?b.model.dropdown.listValue:b.model.value;d&&d.length||(d=a),null!==d&&($(n).dropdown("set selected",d),c(function(){b.model.dropdown.selected=a||d},0))}}var i=app.urlPrefix+"api/forms/getdropdowndata",j=b.model.dropdown.isUser;j&&(i=app.urlPrefix+"api/forms/getUsers");var k=b.model.dropdown.isRole;k&&(i=app.urlPrefix+"api/forms/getRoles");for(var l=$(e).hasClass("multiple"),m=l?b.model.dropdown.listValue||[]:[b.model.value||""],n='<select class="temporal ui fluid '+(l?"multiple":"")+' search selection dropdown" '+(l?"multiple":"")+" >",o=0;o<m.length;o++)n+='  <option value="'+m[o]+'">'+m[o]+"</option>";n+="</select>",n=$(n);var p,q={onChange:function(a,d,e){console.log("### [dropdown] onChange",a,d),l||c(function(){b.model.dropdown.selected=[d],b.model.value=a,b.ngChange&&!s&&b.ngChange()},0)},onRemove:function(a,b,c){g()},onAdd:function(a,b,c){g()},apiSettings:{url:i,cache:!1,method:"get",dataType:"json",beforeSend:function(a){if(a.data={id:b.formId,name:b.model.name,query:a.urlData.query,filters:b.model.useFilter?b.model.filters:[]},b.edit&&!b.model.dropdown.isUser&&!b.model.dropdown.isRole){var c=b.model.dropdown.remoteColumnLabel,d=b.model.dropdown.remoteColumnKey;"سفارشی..."==b.model.dropdown.remoteColumnLabel&&(c=b.model.dropdown.remoteColumnLabelFormula),"سفارشی..."==b.model.dropdown.remoteColumnKey&&(d=b.model.dropdown.remoteColumnKeyFormula),a.data={datasourceId:b.model.dropdown.remoteDatasource.value,remoteColumnKey:d,remoteColumnLabel:c,query:a.urlData.query}}return a},onResponse:function(c){return c.fields=c.fields.map(function(a){return{value:a.value.entitize(),label:a.label.entitize()}}),b.model.format&&_.each(c.fields,function(c){_.isNaN(+c.label)||_.isEmpty(c.label)||(c.label=d3.format(a(b.model))(+c.label))}),b.model.dropdown.remoteItems=c,c}},message:{noResults:app.lang.translate("No results found.")},fields:{remoteValues:"fields",name:"label",value:"value"},saveRemoteData:!1,fullTextSearch:!0,forceSelection:!1};$(e).append(n),$(n).dropdown(q);var r=function(){if(b.model.dropdown.listValue&&b.model.dropdown.listValue.length>0||b.model.value){var a=b.model.dropdown.listValue&&b.model.dropdown.listValue.length?b.model.dropdown.listValue:b.model.value?[b.model.value]:null,c=null;j&&(c=d.post(app.urlPrefix+"api/forms/getUsers",a)),k&&(c=d.post(app.urlPrefix+"api/forms/getRoles",a)),j||k||(c=d.get(app.urlPrefix+"api/forms/GetDropDownDataDefault",{params:{id:b.formId,name:b.model.name,values:a}})),null!=t&&clearTimeout(t),s=!0,c.then(function(a){var b=_.map(a.data.fields,function(a){return{value:a.value,name:a.label,text:a.label}}),c=_.map(a.data.fields,function(a){return a.label});$(n).dropdown("setup menu",{values:b}),h(c),t=setTimeout(function(){s=!1},500)})}},s=!0,t=setTimeout(function(){s=!1},500);r(),b.$on("dropdown-getonline-default",function(a,c){c.name===b.model.name&&r()})}}}])}(),function(){var a=angular.module("sadafForms");a.directive("sadafgroup",["$compile",function(a){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",settings:"=?",id:"@",edit:"@",change:"&?",editContext:"=?"},controller:["$scope","$http","formsService","controlPropertyService","$timeout","$mdToast",function(a,b,c,d,e,f){a.model=a.model||{},a.control=d.get(),a.setProp=function(b){a.control.setActive(b)},a.remove=function(b,c){var d=confirm(app.lang.translate("delete control message"));d&&a.model.controlGroup.controls.splice(c,1)},a.copy=function(b,c){var d=_.extend({},b);d.name=a.editContext.pages.naming.getName(),d.columnName=d.columnName+"-copy",a.model.controlGroup.controls.splice(c+1,0,d)},a.op={group:{name:"form",pull:!0},onAdd:function(a){22==a.model.type&&(a.models.splice(a.newIndex,1),showErrorToast("امکان نمایش گروه در گروه وجود ندارد",f))},animation:150},a.changeValue=function(b){a.change&&a.change({model:b})}}],template:'<div class="ui content-form" ></div>',link:function(b,c,d){function e(){var d=angular.element('    <div class="ui segment"  ng-init="model.controlGroup.controls = model.controlGroup.controls || []" ng-style="{\'background-color\':model.controlGroup.color }">        <div class="ui small header">{{model.label}}</div>            <div class="ui grid" '+(b.edit?'ng-sortable="op"':"")+' style="min-height:50px;padding:14px;">                <form-control                 ng-repeat="component in model.controlGroup.controls track by $index"                change="changeValue(model)"                ng-click="setProp(component);$event.stopPropagation();"                ng-class="{active: component.isActive}" class="column" remove="remove(component, $index)" copy="copy(component, $index)" edit="{{edit}}" ng-model="component" id="{{id}}" settings="{fromMultiRow:false}"></form-control>        </div>    </div>');a(d)(b),angular.element(c[0]).html(d)}e()}}}])}();