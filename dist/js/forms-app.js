// داشبورد مدیریتی صدف info@sadafdashboard.ir

var cal=angular.module("calendar",[]);cal.directive("sadafCalendar",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel"},template:'<div><input type="text" id=""  class="form-control from" placeholder="تاریخ" /><input id="from-value" type="hidden"/></div>',link:function(a,b,c){b.find(" .from").datepicker({changeMonth:!0,changeYear:!0,dateFormat:"yy/mm/dd",altFormat:"yy/mm/dd",altField:b.find("#from-value"),onClose:function(b){a.model=b,a.$apply()}}),a.$watch("model",function(c){null==c&&b.find(".from").datepicker("setDate",a.model)}),b.find(".from").datepicker("setDate",a.model)}}});var ngApp=angular.module("sadafForms",["ng-sortable","services","calendar","semantic-ui","ngRoute","ui.sortable","pascalprecht.translate","ngSanitize","uibCollapseCat"]);ngApp.config(["$translateProvider",function(a){a.useStaticFilesLoader({prefix:app.urlPrefix+"dist/locales/locale-",suffix:".js"}),a.preferredLanguage("fa"),a.useSanitizeValueStrategy("sanitizeParameters")}]),ngApp.config(["$routeProvider","$locationProvider",function(a,b){a.when("/forms/list",{templateUrl:app.urlPrefix+"dist/partial/forms/editor/form-generator-list.html?v="+app.version,controller:"fromsCtrl",controllerAs:"c"}).when("/forms/:id?",{templateUrl:app.urlPrefix+"dist/partial/forms/editor/form-generator-editor.html?v="+app.version,controller:"fromGeneratorCtrl",controllerAs:"c"}).otherwise({redirectTo:"datasources"})}]);var ngApp=angular.module("sadafForms");ngApp.directive("sadafForm",function(){return{scope:{id:"@",rowId:"@?",onCancel:"&?",onFinish:"&?"},controller:["$scope","$http","$sce","$routeParams","$timeout","$q","formsService","formsSubmitService","$attrs",function($scope,$http,$sce,$routeParams,$timeout,$q,formsService,formsSubmitService,$attrs){function getFormData(){c.clearForm(),c.rowId&&0!=+c.id&&(c.formLoading=!0,formsSubmitService.get(c.id,c.rowId).then(function(a){function b(a,c){_.each(a,function(a){c(a),13==a.type&&_.each(a.multiRowForm.rows,function(a){b(a,c)})})}c.formLoading=!1,_.each(a.model.pages,function(a){b(a.controls,function(a){12==a.type,2==a.type&&(a.value=+a.value)})}),c.data=a.model,c.editPermission=a.editPermission,c.deletePermission=a.deletePermission,c.allControl=[],runOnAllControll(c.data,function(a){c.allControl.push(a)})},function(){c.formLoading=!1}))}function getFormEmptyData(){c.clearForm(),c.formLoading=!0,formsService.get(c.id).then(function(a){c.formLoading=!1,c.data=a.model,c.editPermission=a.editPermission,c.deletePermission=a.deletePermission,c.allControl=[],runOnAllControll(c.data,function(a){c.allControl.push(a)})},function(){c.formLoading=!1})}function clearIfFilterHasControl(a,b){if(b.useFilter&&b.filters&&b.filters.length){var c=_.some(b.filters,{control:a,type:2});c&&(b.value=null)}}function findControl(a,b){var c=null;return runOnAllControll(b,function(b){return b.name===a?(c=b,!1):void 0}),c}function runOnAllControll(a,b,c){if(a){var d=[];_.each(a.pages,function(a){c&&c(a),a&&_.isArray(a.controls)&&(d=d.concat(a.controls))}),_.each(d,function(a){13==a.type&&_.each(a.multiRowForm.rows,function(a){_.each(a,function(c){var d=b(c,a);return d===!1?!1:void 0})});var c=b(a,d);return c===!1?!1:void 0})}}function GetMultiRowControlBaseOnChildName(a){var b;return runOnAllControll(c.data,function(c){if(13==c.type){var d=_.findIndex(c.multiRowForm.rows[0],{name:a});-1!=d&&(b={control:c,index:d})}}),b}function calcFlatFormula(f,rowControls){var isTimeType=!1,r=f.replace(/\[(field-\d+)\]/gi,function(a,b,c){var d=_.find(rowControls,{name:b});return 8==d.type?(isTimeType=!0," "+new Date("Thu Jan 01 1970 "+d.value.substring(0,5)).getTime()+" "):" "+(+d.value||0)+" "}),o;if(isTimeType){var d=new Date(eval(r)).toUTCString().split(" ")[4].substring(0,5);o={type:"time",value:d,formula:r}}else o={type:"digit",value:+eval(r).toFixed(5),formula:r};return o}function updateCalculated(newVal,oldVal){var filteredBaseOnField=[];runOnAllControll(c.data,function(a){a.useFilter&&_.each(a.filters,function(b){2==b.type&&b.control&&filteredBaseOnField.push({name:a.name,source:a,filter:b.control})})}),runOnAllControll(c.data,function(control,rowControls){if(5==control.type){var o=calcFlatFormula(control.calculate.expression,rowControls);control.value=o.value,control.formula=o.formula}if(16==control.type){var regex=/\s*(sum|avg|var)\s*\(([^\)]+)\)\s*/gi,r=control.calculate.expression.replace(regex,function(a,b,c){var d=[],e=c.replace(/.*\[(field-\d+)\].*/gi,"$1"),f=GetMultiRowControlBaseOnChildName(e);if(!f)return"از فیلدهای مربوط به فرم چند ردیفه باید استفاده شود";_.each(f.control.multiRowForm.rows,function(a){var b=calcFlatFormula(c,a);d.push(b.value||0)});var g=0;return"sum"===b&&(g=d3.sum(d)),"avg"===b&&(g=d3.mean(d)),"var"===b&&(g=d3.variance(d))," "+g+" "});try{control.value=+eval(r).toFixed(5)}catch(e){control.value=r}control.formula=r}if(control.useFilter&&control.filters&&control.filters.length){var controlValue=null;_.map(control.filters,function(a){if(2==a.type){var b=_.find(rowControls,{name:a.control});a.controlValue=b.value}})}})}var c=this,id=c.id;c.submittedStatus=0,c.isValid=function(){var a=!1;if(c.data&&c.data.pages)a:for(var b=0;b<c.data.pages.length;b++)for(var d=0;d<c.data.pages[b].controls.length;d++){var e=c.data.pages[b].controls[d];if(12==e.type&&!e.isValid){a=!0;break a}}return a},c.submit=function(){c.loading=!0,c.clearAllErrors(),formsSubmitService.submit(c.id,c.data).then(function(a){c.loading=!1,c.submittedStatus=1,!a.result&&a.messages&&(c.pagesContainError=c.pagesContainError||[],c.submittedStatus=0,_.each(c.data.pages,function(b){_.each(a.messages,function(a){var d=_.find(b.controls,{name:a.name});d&&(d.error=a.error,-1==_.findIndex(c.pagesContainError,b)&&c.pagesContainError.push(b))})})),!a.result&&a.pageMessages&&(c.submittedStatus=0,_.each(a.pageMessages,function(a){var b=_.find(c.data.pages,{name:a.name});b&&(b.error=a.error)})),a.result&&(c.onFinish&&c.onFinish(),c.clearForm())},function(a){a.data.title&&a.data.desc?c.error={title:a.data.title,desc:a.data.desc}:c.error=null,c.loading=!1,c.submittedStatus=2})},c.clearAllErrors=function(){c.pagesContainError=[],runOnAllControll(c.data,function(a){a.error=null},function(a){a.error=null})},c.clearForm=function(){c.submittedStatus=0,c.activePage=0,runOnAllControll(c.data,function(a){a.value=null,a.dropdown&&(a.dropdown.listValue=null),13==a.type&&a.multiRowForm.rows.splice(0,a.multiRowForm.rows.length-1)})};var timer,observe=function(a){$timeout.cancel(timer),timer=$timeout(function(){0!=+c.id&&(c.allControl=null,c.rowId?getFormData():getFormEmptyData())},100)};$attrs.$observe("rowId",observe),$attrs.$observe("id",observe),c.cancel=function(){c.onCancel()},c.remove=function(){var a=confirm("آیا برای حذف اطلاعات جاری فرم اطمینان دارید؟");a&&formsSubmitService.remove(c.id,c.rowId).then(function(){c.onCancel()},function(a){a.data.title&&a.data.desc&&alert(a.data.desc)})},$scope.$watch(angular.bind(this,function(){return this.allControl}),function(a,b){a&&b&&_.each(a,function(a){var d=_.find(b,{name:a.name});a.value!=d.value&&12==a.type&&_.each(c.allControl,function(b){a.name!=b.name&&clearIfFilterHasControl(a.name,b)})})},!0),$scope.$watch(angular.bind(this,function(){return this.data}),function(a,b){updateCalculated(a,b)},!0)}],restrict:"AE",controllerAs:"c",bindToController:!0,templateUrl:app.urlPrefix+"dist/partial/forms/form-render.html?v="+app.version}}),ngApp.service("formsSubmitService",["$http","updateModel",function(a,b){var c=function(c,d){return a.get(app.urlPrefix+"api/formsSubmit/getData/"+c+"?rowId="+d).then(function(a){var c=a.data;return b.updateValuesForGet(c.model.pages),c})},d=function(c,d){return b.updateValuesForSave(d.pages),a.post(app.urlPrefix+"api/formssubmit/submit/"+c,d).then(function(a){return app.moderation.dashboadpage.refreshRelatedDatasources(a.data.RefreshDatasource),a.data})},e=function(b,c){return a.post(app.urlPrefix+"api/formssubmit/delete/"+b,c).then(function(a){return app.moderation.dashboadpage.refreshRelatedDatasources(a.data.RefreshDatasource),a.data})};return{submit:d,remove:e,get:c}}]),ngApp.directive("selectForm",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{onSelect:"&",settings:"=?"},controller:["$scope","$http","formsService",function(a,b,c){a.model=a.model||[],a.settings=a.settings||{},c.get().then(function(b){a.forms=b}),a.opt={closable:!1,onApprove:function(){return a.model&&a.model.length?(a.onSelect({forms:a.model,settings:a.settings}),!1):(alert("حداقل یک مورد باید انتخاب شود"),!1)}}}],template:'<div>                   <sm-modal visible="settings.visible" settings="opt">                        <div class="header">انتخاب فرم</div>                        <div class="content">                            <p>لطفا فرم‌های مورد نظر خود را انتخاب کنید</p>                            <div class="ui form">                                <div class="field">                                    <label>انتخاب فرم</label>                                    <sm-dropdown class="selection search multiple"  settings="{fullTextSearch: true}" model="model" items="forms" label="item.name" value="item" ></sm-dropdown>                                </div>                            </div>                        </div>                        <div class="actions">                            <div class="ui black deny button">لغو</div>                            <div class="ui positive button" ng-class="{loading: settings.loaging}" >اضافه کردن</div>                        </div>                    </sm-modal>                    </div>',link:function(a,b,c){}}}),function(){function a(a,b){b.show({template:'<md-toast class="md-toast error"> <span class="md-toast-text" flex>'+a+"</span></md-toast>",hideDelay:3e3,position:"bottom left"})}function b(a,b,c){var d=[];_.each(a,function(a){c&&c(a),a&&_.isArray(a.controls)&&(d=d.concat(a.controls))}),_.each(d,function(a){13==a.type&&a.multiRowForm&&_.each(a.multiRowForm.rows,function(a){_.each(a,function(c){b(c,a)})}),b(a,d)})}var c=angular.module("sadafForms");c.controller("fromGeneratorCtrl",["$scope","$http","$sce","$timeout","$mdToast","$routeParams","formsService","controlPropertyService",function(c,d,e,f,g,h,i,j){c.saveProgress=!1;var k=this;k.id=h.id||0;var l=k.id>0;k.app=app,k.items=[{columnClass:"three",key:"متن کوتاه",label:"نام",icon:"text cursor",type:0,unique:!1,"default":!0,require:!0,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{columnClass:"three",key:"متن بلند",label:"متن بلند",icon:"text cursor",type:1,unique:!1,"default":!0,require:!0,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{columnClass:"three",key:"عدد",label:"عدد",icon:"hashtag",type:2,unique:!1,"default":!0,require:!0,format:"#,#",accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{columnClass:"three",key:"برچسب",label:"برچسب",icon:"font",type:3,unique:!1,"default":!1,require:!1,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{columnClass:"three",key:"چند گزینه",icon:"caret down",label:"چند گزینه",type:4,unique:!1,"default":!0,require:!0,dropdown:{useRemoteData:!1},accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{columnClass:"three",key:"چند گزینه ریموت",icon:"caret down",label:"چند گزینه ریموت",type:4,unique:!1,"default":!0,require:!0,accessControlEdit:!1,accessControlView:!1,dropdown:{useRemoteData:!0},accessControlEditRoles:[],accessControlViewRoles:[]},{columnClass:"three",key:"تایید",icon:"checkmark box",type:6,label:"انتخاب مقدار",unique:!1,"default":!0,require:!0,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{columnClass:"three",key:"زمان",icon:"wait",label:"زمان",type:8,unique:!1,"default":!0,require:!0,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{columnClass:"three",key:"تاریخ",label:"تاریخ",icon:"calendar",type:9,unique:!1,"default":!0,require:!0,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{columnClass:"three",key:"ارجاع به فرم",label:"ارجاع به فرم",icon:"pointing right",type:12,formLookup:{form:-1,keyControls:[]},unique:!1,"default":!0,require:!0,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{columnClass:"twelve",key:"گروه تکرار شونده",label:"لیست",icon:"table",type:13,unique:!1,"default":!1,require:!1,accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[],multiRowForm:{addKeyText:"ردیف جدید",rows:[[]],controlSize:"mini"}},{columnClass:"three",key:"کلید",label:"کلید",icon:"square",type:15,unique:!1,"default":!1,require:!1,button:{type:1,openLinkType:0,colorClass:"black",size:"tiny"},accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{columnClass:"three",key:"محاسباتی",icon:"calculator",label:"فیلد محاسباتی",type:5,unique:!1,"default":!1,require:!1,format:"#,#",calculate:{expression:""},accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]},{columnClass:"three",key:"محاسباتی - جمع",label:"محاسباتی - جمع",icon:"calculator",type:16,unique:!1,"default":!1,require:!1,format:"#,#",calculate:{expression:"",func:"sum"},accessControlEdit:!1,accessControlView:!1,accessControlEditRoles:[],accessControlViewRoles:[]}],k.controlProperty=function(a){return a?_.find(k.items,{type:a.type}):{unique:!1,"default":!1,require:!1}},k.sortableOptions={"ui-floating":!0},k.compConf={sort:!1,group:{name:"form",pull:"clone",put:!1},animation:150,onEnd:function(a){a.model.name=k.pages.naming.getName(),a.model.canView=!0,a.model.canEdit=!0}},k.drags=k.items.map(function(a){return[a]});var m=!1;k.draggableOptions={connectWith:".drop-target",placeholder:"form-control-highlight",helper:"clone",stop:function(a,b){if(b.item.sortable.source.hasClass("draggable-element")&&b.item.sortable.droptarget&&b.item.sortable.droptarget!=b.item.sortable.source&&b.item.sortable.droptarget.hasClass("drop-target")){var c=b.item.sortable.droptargetModel[b.item.sortable.dropindex];c.name=k.pages.naming.getName(),c.columnClass=c.columnClass||"twelve",c.formLookup=_.extend({},b.item.sortable.model.formLookup),c.dropdown=_.extend({},b.item.sortable.model.dropdown),c.canView=!0,c.canEdit=!0;var d=JSON.parse(JSON.stringify(b.item.sortable.model));b.item.sortable.sourceModel.push(d)}}},k.control=j.get(),k.formLookupSourceFields=[],console.log("niit c.formLookupSourceFields",k.formLookupSourceFields),c.$watch("c.control.active.formLookup",function(a){a&&a.form&&i.get(a.form).then(function(a){for(;k.formLookupSourceFields.length;)k.formLookupSourceFields.splice(0,k.formLookupSourceFields.length);_.each(a.model.pages,function(a){_.each(a.controls,function(a){k.formLookupSourceFields.push(a)})}),console.log("change c.formLookupSourceFields",k.formLookupSourceFields)})}),k.pages={data:[],add:function(a){var b={name:"صفحه "+(k.pages.data.length+1),type:0,controls:[],rowValidation:{uniqueMultiField:!1,uniques:[]},size:"tiny"};k.pages.data.push(b),k.pages.setActive(b)},removeControl:function(a,b){var c=confirm("در صورت پاک کردن این کنترل تمامی داده‌هایی که قبلا در فرم برای این کنترل ذخیره شده است نیز پاک خواهد شد. آیا برای حذف این کنترل اطمینان دارید؟");c&&(m=!0,k.pages.activePage.controls.splice(a,1))},remove:function(a){if(k.pages){var b=!0;if(k.pages.data[a].controls.length&&(b=confirm(" در صورت پاک کردن صفحه تمام کنترل‌های موجود در آن به همراه داده‌هایی که قبلا در فرم ذخیره شده است پاک خواهد شد. آیا برای حذف این صفحه اطمینان دارید؟")),b){k.pages.data[a].controls.length&&(m=!0);var c=k.pages.data.splice(a,1);c[0]===k.pages.activePage&&k.pages.setActive()}}},setActive:function(a){_.each(k.pages.data,function(a){a.active=!1}),!a&&k.pages.data.length&&(a=k.pages.data[0]),k.pages.activePage=a,k.pages.activePage.active=!0,k.control.active&&(k.control.active.isActive=!1,k.control.active=null)},getControlForRowValidation:function(){var a=k.pages.activePage.controls;return a},naming:{getName:function(){return"field-"+k.pages.naming.getMaxId()},exist:function(a){if("_id"==a)return!0;var b=!1;return _.each(k.pages.data,function(c){_.each(c.controls,function(c){var d=c.name||"";return d==a?(b=!0,!1):void 0})}),b},getMaxId:function(){return k.maxFieldNumber=+k.maxFieldNumber||0,k.maxFieldNumber++,k.maxFieldNumber}}},k.controlList=[],c.$watch("c.pages",function(){k.controlList=[],b(k.pages.data,function(a){13!=a.type&&k.controlList.push(a)})},!0),k.saveProgress=!1,k.save=function(){var b=!1;b=m?confirm("در صورت ذخیره به دلیل اینکه تغییراتی در فرم ایجاد شده است در صورت حذف یک کنترل داده‌های مربوط به آن نیز حذف می‌شود. آیا برای ذخیره اطمینان دارید؟‌"):!0,b&&(m=!1,k.saveProgress=!0,i.save(k.id,{pages:k.pages.data,name:k.name,maxFieldNumber:k.maxFieldNumber}).then(function(a){k.saveProgress=!1,k.id=a,location.replace(app.hashUrlPrefix+"#/forms/"+a);var b=g.simple().textContent("فرم شما با موفقیت ذخیره شد");g.show(b)},function(b){k.saveProgress=!1;var c="مشکلی در روند ذخیره‌سازی به وجود آمده است";b.data.desc&&(c=b.data.desc),a(c,g)}))},l||(k.name="فرم جدید",k.pages.add()),l&&i.get(k.id,!0).then(function(a){k.pages.data=a.model.pages,k.name=a.model.name,k.maxFieldNumber=a.model.maxFieldNumber,k.pages.setActive(),_.each(k.pages.data,function(a){_.each(a.controls,function(a){a.dropdown&&a.dropdown.items&&(a.dropdown.itemsTemp=a.dropdown.items.map(function(a){return a.label}).join("\n"))})})}),k.getSiblingControl=function(a){var c={};b(k.pages.data,function(b,d){a===b.name&&(c.row=d,c.index=_.findIndex(d,{name:a}))});debugger;return c},c.$watch("c.control.active",function(a){a&&a.name&&(k.activeSibling=k.getSiblingControl(a.name))})}]),c.directive("formControl",["$compile",function(a){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",settingsClick:"&",remove:"&",id:"@",edit:"@",settings:"=?"},controller:["$scope","$translate","$timeout",function(a,b,c){if(a.dropdownSettings={apiSettings:{url:app.urlPrefix+"api/forms/getdropdowndata",cache:!1,method:"get",dataType:"json",beforeSend:function(b){return b.data={id:a.id,name:a.model.name,query:b.urlData.query},a.edit&&(b.data={datasourceId:a.model.dropdown.remoteDatasource.value,remoteColumnKey:a.model.dropdown.remoteColumnKey,remoteColumnLabel:a.model.dropdown.remoteColumnLabel,query:b.urlData.query}),b},onResponse:function(a){return a.fields=a.fields.map(function(a){return{value:a.value.entitize(),label:a.label.entitize()}}),a}},message:{noResults:app.lang.translate("No results found.")},fields:{remoteValues:"fields",name:"label",value:"value"},saveRemoteData:!1,fullTextSearch:!0},a.onAdd=function(b){c(function(){a.model.dropdown.listValue=a.model.dropdown.listValue||[],-1==a.model.dropdown.listValue.indexOf(b)&&a.model.dropdown.listValue.push(b)},0)},a.onRemove=function(b){c(function(){a.model.dropdown.listValue=a.model.dropdown.listValue||[];var c=a.model.dropdown.listValue.indexOf(b);-1!=c&&a.model.dropdown.listValue.splice(c,1)},0)},a.change=function(b){c(function(){a.model.dropdown.multiSelectDropdown||(a.model.value=b)},0)},a.randomId=Math.floor(1e5*Math.random())+1,a.model.randomId=a.randomId,a.$watch("model.value",function(b){null==b&&$(".form-"+a.randomId+" .dropdown").dropdown("clear")}),a.simpleDropdownsettings={message:{noResults:app.lang.translate("No results found.")},fullTextSearch:!0,forceSelection:!1},a.$watch("model.dropdown.listValue",function(b){null==b&&$(".form-"+a.randomId+" .dropdown").dropdown("clear")}),a.model.dropdown&&a.model.dropdown.multiSelectDropdown&&a.model.dropdown.useRemoteData){try{a.model.dropdown.listValue=_.uniq(JSON.parse(a.model.value||"[]"))}catch(d){a.model.dropdown.listValue=[a.model.value]}a.model.value=null,a.model.items=a.model.dropdown.listValue}a.initDropdown=function(b){a.model.dropdown&&a.model.dropdown.multiSelectDropdown&&a.model.dropdown.useRemoteData&&c(function(){$(b).dropdown("set selected",a.model.dropdown.listValue)},100)},a.buttonClick=function(){if(!a.edit&&(1==a.model.button.type&&(a.model.button.showModal=!0),0==a.model.button.type)){if(!+a.model.button.dashboardId)return;var b=0==+a.model.button.openLinkType?"_blank":"_self";window.open(app.urlPrefix+"#/dashboard/"+a.model.button.dashboardId,b)}},a.getFilteredDropdonItems=function(b,c,d){if(!a.model.useFilter||!a.model.filters)return!1;var e=!1;return _.each(a.model.filters,function(a){if(!(a&&a.staticValue&&b&&b.value))return!1;debugger;return 1==a.type?(e=-1!=a.staticValue.trim().indexOf(b.value.trim())||-1!=b.value.trim().indexOf(a.staticValue.trim()),!1):void 0}),e}}],templateUrl:app.urlPrefix+"dist/partial/forms/editor/form-generator-control.directive.html?v="+app.version}}]),c.directive("multiRowForm",["$compile",function(a){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",settings:"=?",id:"@",edit:"@"},controller:["$scope","$http","formsService","controlPropertyService","$timeout",function(a,b,c,d,e){a.model=a.model||{},a.firstRow=a.model.multiRowForm.rows[0],a.$watch("firstRow",function(){_.each(a.firstRow,function(a){a.childOfMultiRow=!0})},!0),a.sortableOptions={placeholder:"form-control-highlight",handle:".drag-handle"},a.control=d.get(),a.setProp=function(b){a.control.setActive(b)},a.remove=function(b,c){var d=confirm("در صورت پاک کردن این کنترل تمامی داده‌هایی که قبلا در فرم برای این کنترل ذخیره شده است نیز پاک خواهد شد. آیا برای حذف این کنترل اطمینان دارید؟");d&&a.model.multiRowForm.rows[0].splice(c,1)},a.addRow=function(){if(!a.edit){var b=[];_.each(a.model.multiRowForm.rows[0],function(a){var c=JSON.parse(JSON.stringify(a));b.push(c)}),a.model.multiRowForm.rows.push(b),_.each(b,function(a){a.rowId=0,a.value=null,a.dropdown.listValue=null}),setTimeout(function(){$(".edit-form-modal").modal("refresh")},100)}},a.removeRow=function(b,c){var d=b.splice(c,1);a.model.multiRowForm.deletedIds=a.model.multiRowForm.deletedIds||[],a.model.multiRowForm.deletedIds.push(d[0][0].rowId)}}],template:' <div class="ui form field" ng-class="model.multiRowForm.controlSize">                        <div class="ui secondary pointing tiny menu">                            <div class="active item">{{model.label}}</div>                            <div class="ui right item" طng-show="!edit">                                <div class="pointer" ng-click="addRow()">{{model.multiRowForm.addKeyText}}<i class="icon plus square outline large"></i></div>                            </div>                        </div>                            <div ng-hide="model.multiRowForm.rows[0].length" class="gray center aligned twelve wide column"><small>یک کنترل را به اینجا بکشید</small></div>                        <div class="ui grid content-form " >                        </div>                    </div>',link:function(b,c,d){function e(){b.model.multiRowForm.columns=b.model.multiRowForm.columns||3;var a=1==b.model.multiRowForm.columns?"one":2==b.model.multiRowForm.columns?"two":3==b.model.multiRowForm.columns?"three":4==b.model.multiRowForm.columns?"four":5==b.model.multiRowForm.columns?"five":6==b.model.multiRowForm.columns?"six":"eight";return a}function f(){var d;d=b.edit?angular.element('<div class="drop-target doubling '+e()+' column row {{model.multiRowForm.separator? \'separator\':\'\'}}" xui-sortable="sortableOptions"  xng-model="model.multiRowForm.rows[0]" ng-sortable="{group: {name: \'form\', pull:false, put:true}, animation:150}" style="min-height:100px;">                                                                                                        <div class="column"                                                              ng-repeat="component in model.multiRowForm.rows[0] track by $index"                                                             ng-click="setProp(component);$event.stopPropagation();">                                                                <form-control ng-class="{active: component.isActive}" class="column" remove="remove(component, $index)" edit="true" ng-model="component" id="{{id}}" settings="{fromMultiRow:true}"></form-control>                                                    </div>                                                </div>'):angular.element('<div ng-repeat="row in model.multiRowForm.rows" class="doubling '+e()+' column row no-padding {{model.multiRowForm.separator? \'separator\':\'\'}}">                                                    <div class="column no-padding"                                                          ng-repeat="component in row track by $index">                                                            <div class="ui grid" ng-if="!edit && model.multiRowForm.rows.length > 1 && $last" style="margin:0;">                                                                <form-control class="ten wide column field" remove="remove(component, $index)" ng-model="component" id="{{id}}"  settings="{showLabel:$parent.$parent.$index == 0, fromMultiRow:true}"></form-control>                                                                <div class="two wide column field" >                                                                    <label ng-show="$parent.$parent.$index == 0">&nbsp;</label>                                                                    <div class="ui icon mini xbutton pointer gray" ng-click="removeRow(model.multiRowForm.rows, $parent.$parent.$index)"><i class="icon remove"></i></div>                                                                </div>                                                            </div>                                                            <form-control ng-if="edit || model.multiRowForm.rows.length == 1 || !$last" class="column" remove="remove(component, $index)" ng-model="component" id="{{id}}" settings="{showLabel:$parent.$parent.$index == 0, fromMultiRow:true}"></form-control>                                                    </div>                                                </div>'),a(d)(b),angular.element(c[0].querySelector(".content-form")).html(d)}b.$watch("model.multiRowForm.columns",function(a,b){f()})}}}]),c.directive("newFormModal",["$compile",function(a){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",show:"=?"},template:' <div >                          <div class="xcontent" >                        </div>                    </div>',link:function(b,c,d){function e(){var d=angular.element('<sm-modal visible="model.showModal" settings="{closable: true}" xng-if="model.type==1">                                                <div class="content">                                                    <div sadaf-form id="{{model.formInfo.form}}" on-finish="hideModal()"></div>                                                </div>                                            </sm-modal>');a(d)(b),angular.element(c[0].querySelector(".xcontent")).html(d)}b.hideModal=function(){b.model.showModal=!1},e()}}}]),c.directive("formLookupProperty",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",settings:"=?"},controller:["$scope","$http","formsService",function(a,b,c){a.model=a.model||{},a.settings=angular.merge({selectableColumns:!0},a.settings||{}),c.get().then(function(b){a.forms=b}),a.$watch("model.form",function(b){-1==b&&(a.model.form=a.forms[0].id),b&&c.get(b).then(function(b){a.formControls=[],_.each(b.model.pages,function(b){_.each(b.controls,function(b){a.formControls.push(b)})})})})}],template:' <div class="field">                        <div class="field">                            <label>انتخاب فرم</label>                            <sm-dropdown class="selection search fluid"  settings="{fullTextSearch: true, forceSelection: false}" model="model.form" items="forms" label="item.name" value="item.id" ></sm-dropdown>                        </div>                        <div class="field" ng-show=settings.selectableColumns>                            <label>انتخاب ستون‌های کلیدی</label>                            <sm-dropdown class="selection search multiple fluid" settings="{fullTextSearch: true, forceSelection: false}" model="model.keyControls" items="formControls" label="item.label" value="item.name" ></sm-dropdown>                        </div>                    </div>',link:function(a,b,c){}}}),c.directive("formLookupGetId",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",id:"@"},controller:["$scope","$http","formsService","$timeout",function(a,b,c,d){function e(){a.model.formLookup.keyControls=a.model.formLookup.keyControls||[],a.keys=a.model.formLookup.keyControls.map(function(b){var c={name:b,dropdownSettings:j(b),change:function(a){c.value!==a&&(c.value=a,i())},defaultText:a.model.label};return c})}function f(){if(a.model.formLookup.keyControlsBindedValue&&a.keys)for(var b=0;b<a.model.formLookup.keyControlsBindedValue.length;b++){var c=a.model.formLookup.keyControlsBindedValue[b];null!=a.model.value&&(a.keys[b].defaultText=c,a.keys[b].boldText=!0)}}function g(){a.model.useFilter&&a.model.filters.length&&_.map(a.model.filters,function(a){})}function h(){$(".form-"+a.model.randomId+" .dropdown").dropdown("clear")}function i(){var c=a.keys.map(function(a){return{label:a.name,value:a.value}}),d=_.some(c,function(a){return _.isUndefined(a.value)||null==a.value});d||(a.model.isValid=!1,b.post(app.urlPrefix+"api/forms/getFormLookupIds/"+a.model.formLookup.form,c).then(function(b){a.model.isValid=!0,_.isArray(b.data)&&b.data.length&&(a.model.value=b.data[0])}))}a.model.formLookup=a.model.formLookup||{};var j=function(b){return{apiSettings:{url:app.urlPrefix+"api/forms/getFormColumnData",cache:!1,method:"get",dataType:"json",beforeSend:function(c){return c.data={id:a.model.formLookup.form,name:b,query:c.urlData.query,others:a.keys.map(function(a){return{label:a.name,value:a.value}}),filters:a.model.useFilter?a.model.filters:[]},c},onResponse:function(a){return a.fields=a.fields.map(function(a){return{value:a.value.entitize(),label:a.label.entitize()}}),a}},message:{noResults:app.lang.translate("No results found.")},fields:{remoteValues:"fields",name:"label",value:"value"},saveRemoteData:!1,fullTextSearch:!0,forceSelection:!1}};a.$watch("model.formLookup.keyControlsBindedValue",function(a){f()},!0),a.$watch("model.filters",function(a){g()},!0),a.$watch("model.formLookup.keyControls",function(a){e(),f()},!0);var k=!1,l=!1;a.$watch("model.value",function(b){a.model;null==b&&(l=!0,h())}),a.init=function(a){k=!0,l&&h()},a.model.isValid=!0}],template:' <div class="">                        <div class="field" ng-repeat="f in keys">                            <sm-dropdown settings="f.dropdownSettings" on-init="init"ng-class="{\'bold-text\':f.boldText}" class="selection search {{f.name}} fluid" label="item.label" on-change="f.change" value="item.value" default-text="f.defaultText" ></sm-dropdown>                        </div>                    </div>'}}),c.directive("selectMenu",function(){return{restrict:"E",replace:!0,transclude:!1,scope:{model:"=ngModel",multiple:"@?"},controller:["$scope","$http","$timeout",function(a,b,c){b.get(app.urlPrefix+"api/menus/get").then(function(b){a.menus=b.data})}],template:'<div><sm-dropdown items="menus" model="model" class="selection search fluid {{multiple}}" settings="{forceSelection: false}" label="item.name" value="item.id" ></sm-dropdown></div>'}}),c.directive("selectDatasourceColumns",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel"},controller:["$scope","$http","datasources",function(a,b,c){function d(){c.getColumns(a.model.remoteDatasource.value).then(function(b){a.datasourceColumns=b.CubeInfo.Dimensions[0].Hierarchies,a.userProperties=b.UsersProperty})}a.select=function(){c.select(null,{type:["datasources"]}).then(function(b){b.selected&&b.selected.length&&(a.model.remoteDatasource={value:b.selected[0].id,label:b.selected[0].name},d(),a.model.remoteColumnKey=null,a.model.remoteColumnLabel=null);
})},a.model=a.model||{},a.model.remoteDatasource&&d()}],template:' <div class="ui form">                        <div class="field">                            <label>انتخاب منبع داده</label>                            <button class="ui tiny button" ng-click="select()">                                <span ng-show="!model.remoteDatasource">انتخاب</span>                                <span ng-show="model.remoteDatasource">{{model.remoteDatasource.label}}</span>                            </button>                        </div>                        <div class="field" ng-show="datasourceColumns">                            <label>ستون مقدار</label>                            <sm-dropdown class="selection search fluid" settings="{fullTextSearch: true}" model="model.remoteColumnKey" items="datasourceColumns" label="item.Name" value="item.Name" ></sm-dropdown>                        </div>                        <div class="field" ng-show="datasourceColumns">                            <label>ستون برچسب</label>                            <sm-dropdown class="selection search fluid" settings="{fullTextSearch: true}" model="model.remoteColumnLabel" items="datasourceColumns" label="item.Name" value="item.Name" ></sm-dropdown>                        </div>                    </div>',link:function(a,b,c){}}}),c.service("updateModel",["$http",function(a){function b(a){}function c(a){}return{updateValuesForSave:c,updateValuesForGet:b}}]),c.service("formsService",["$http","updateModel",function(a,b){var c=0,d={},e=function(e,f){e||(e="");var g="";return f&&(g="?fromEditor=true"),d[e||"all"]||(d[e||"all"]=a.get(app.urlPrefix+"api/forms/get/"+e+g).then(function(a){return e?(b.updateValuesForGet(a.data.model.pages),a.data):(c=a.data.formsModule,a.data.list)})),d[e||"all"]},f=function(c,e){return d={},b.updateValuesForSave(e),a.post(app.urlPrefix+"api/forms/save/"+c,e).then(function(a){return a.data})},g=function(b){return d={},a.get(app.urlPrefix+"api/forms/delete/"+b).then(function(a){return a.data})},h=function(b,c){return d={},a.post(app.urlPrefix+"api/forms/addFormToDashboard/"+b,c).then(function(a){return a.data})},i=function(b,c){return a.post(app.urlPrefix+"api/forms/deleteFormFromDashboard/"+b,c).then(function(a){return a.data})};return{save:f,get:e,remove:g,addFormToDashboard:h,deleteFormFromDashboard:i,getFormsModule:function(){return c}}}]),c.controller("fromsCtrl",["$scope","$http","$sce","$timeout","$mdToast","$routeParams","formsService","$mdDialog","utils",function(a,b,c,d,e,f,g,h,i){var j=this;j.progress=!0,j.app=app,j.utils=i,g.get().then(function(a){j.progress=!1,j.data=a,j.formsModule=g.getFormsModule()}),j["delete"]=function(a,b,c){var d=h.confirm().title("حذف برای همیشه؟").textContent("آیا فرم "+b.name+" حذف شود؟").ariaLabel("حذف").targetEvent(a).ok("حذف!").cancel("لغو");h.show(d).then(function(){g.remove(b.id).then(function(a){var b=j.data.splice(c,1),d=e.simple().textContent("فرم "+b[0].name+" با موفقیت حذف شد");e.show(d)})})}}]),c.service("controlPropertyService",function(){function a(){return b.control}var b={};return b.control={active:null,setActive:function(a){a&&(b.control.active&&(b.control.active.isActive=!1),b.control.active=a,b.control.active.isActive=!0)},remove:function(a,c){var d=confirm("در صورت پاک کردن این کنترل تمامی داده‌هایی که قبلا در فرم برای این کنترل ذخیره شده است نیز پاک خواهد شد. آیا برای حذف این کنترل اطمینان دارید؟");d&&(dangerChangeOccured=!0,b.pages.activePage.controls.splice(a,1))},createItems:function(a){if(a.dropdown.itemsTemp){var b=a.dropdown.itemsTemp.split(/[\r\n]/);a.dropdown.items=[],_.each(b,function(b){var c=b.trim();a&&""!=c&&a.dropdown.items.push({label:c,value:c})})}},resetListValue:function(){b.control.active.dropdown.listValue=[]}},{setActive:b.control.setActive,remove:b.control.remove,getActive:b.control.active,createItems:b.control.createItems,get:a}}),c.directive("sadafDropdwon",["$compile","$timeout",function(a,b){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",formId:"@",edit:"@?"},controller:["$scope","$http","formsService","controlPropertyService",function(a,b,c,d){}],template:"<div></div>",link:function(a,c,d){function e(){clearTimeout(j),j=setTimeout(function(){var c=$(".form-"+a.model.randomId+" .ui.dropdown").dropdown("get value");_.isArray(c)||(c=[c]),c=_.filter(c,null),b(function(){a.model.dropdown.listValue=c},0)},200)}for(var f=$(c).hasClass("multiple"),g=f?a.model.dropdown.listValue:[a.model.value||""],h='<select class="temporal ui fluid '+(f?"multiple":"")+' search selection dropdown" '+(f?"multiple":"")+" >",i=0;i<g.length;i++)h+='  <option value="'+g[i]+'">'+g[i]+"</option>";h+="</select>",h=$(h);var j,k={onChange:function(c,d,e){f||b(function(){a.model.value=c},0)},onRemove:function(a,b,c){e()},onAdd:function(a,b,c){e()},apiSettings:{url:app.urlPrefix+"api/forms/getdropdowndata",cache:!1,method:"get",dataType:"json",beforeSend:function(b){return b.data={id:a.formId,name:a.model.name,query:b.urlData.query},a.edit&&(b.data={datasourceId:a.model.dropdown.remoteDatasource.value,remoteColumnKey:a.model.dropdown.remoteColumnKey,remoteColumnLabel:a.model.dropdown.remoteColumnLabel,query:b.urlData.query}),b},onResponse:function(a){return a.fields=a.fields.map(function(a){return{value:a.value.entitize(),label:a.label.entitize()}}),a}},message:{noResults:app.lang.translate("No results found.")},fields:{remoteValues:"fields",name:"label",value:"value"},saveRemoteData:!1,fullTextSearch:!0,forceSelection:!1};if($(c).append(h),$(h).dropdown(k),a.model.dropdown.listValue){var l=a.model.dropdown.multiSelectDropdown?a.model.dropdown.listValue:a.model.value;null!=l&&$(h).dropdown("set selected",l)}}}}]),c.directive("controlSize",["$compile","$timeout",function(a,b){return{restrict:"E",transclude:!0,scope:{model:"=ngModel"},template:"<sm-dropdown items=\"[{label:'خیلی کوچک', value:'mini'}, {label:'کوچک', value:'tiny'}, {label:'معمولی', value:''}]\" model=\"model\" label=\"item.label\" value=\"item.value\"></sm-dropdown> "}}]),c.filter("formatNumber",function(){return function(a,b){var c="#,#"===b?",.0f":"#,#:00"===b?",.2f":"";return c?d3.format(c)(a):a}}),c.filter("persian",function(){return function(a){return app.lang&&0==+app.lang.langType?persian(a,!0):a}}),c.directive("sadafCheckbox",["$compile","$timeout",function(a,b){return{restrict:"E",transclude:!0,replace:!0,scope:{model:"=ngModel",change:"&?ngChange"},template:'<div class="ui checkbox"><input type="checkbox" ng-model="model" /><label ng-transclude></label></div>',link:function(a,c,d){$(c).checkbox({onChange:function(d,e){b(function(){a.model=$(c).find("input").is(":checked"),a.change&&a.change()})}})}}}]),c.directive("filterProperty",["$compile","$timeout",function(a,b){return{restrict:"E",transclude:!0,replace:!0,scope:{model:"=ngModel",controls:"=",sourceFields:"=?"},controller:["$scope",function(a){var b={type:2};a.add=function(){a.model.push(_.extend({},b))},a.$watch("model",function(c){c||(a.model=a.model||[b])})}],template:'<div class="inner-section">                          <div class="field" ng-repeat="f in model track by $index">                            <div class="inline fields" >                                <label class="three wide field">نوع</label>                                <div class="six wide field">                                    <sm-dropdown model="f.type" class="" settings="{fullTextSearch: true, forceSelection: false}" items="[{type: 1, name:\'مقدار ثابت\'},{type: 2, name:\'مقدار کنترل\'}]" label="item.name" value="item.type"></sm-dropdown>                                </div>                                <div class="three wide field">                                    <i class="gray pointer icon plus" ng-click="add()"></i>                                    <i class="gray pointer icon delete" ng-click="model.splice($index, 1)" ng-hide="model.length==1"></i>                                </div>                            </div>                            <div class="inline fields" ng-show="f.type == 1">                                <label class="three wide field">مقدار</label>                                <input ng-model="f.staticValue" />                            </div>                            <div class="field" ng-show="f.type == 2">                                <div class="inline fields">                                    <label class="three wide field">کنترل</label>                                    <sm-dropdown model="f.control" class="selection fluid" settings="{fullTextSearch: true, forceSelection: false}" items="controls.row" label="item.label" value="item.name"></sm-dropdown>                                </div>                            </div>                            <div class="inline fields" ng-show="sourceFields">                                <label class="three wide field">ستون</label>                                <sm-dropdown model="f.sourceField" class="selection fluid" settings="{fullTextSearch: true, forceSelection: false}" items="sourceFields" label="item.label" value="item.name"></sm-dropdown>                            </div>                        </div>                   </div>',link:function(a,b,c){}}}]),c.directive("sadafDraggable",["$timeout",function(a){return function(a,b,c){function d(){$("[sadaf-draggable]").draggable({connectToSortable:"[sadaf-sortable]",helper:"clone",revert:"invalid",start:function(a,b){$(b.helper).css("width",$(b.helper).width()+"px")},stop:function(a,b){$(b.helper).css("width","100%")}}),$("[sadaf-draggable]").disableSelection()}a.$last&&d()}}]),c.directive("sadafSortable",["$timeout",function(a){return function(a,b,c){function d(){$("[sadaf-sortable]").sortable({revert:!0}),$("[sadaf-sortable]").disableSelection()}d()}}]),c.directive("sadafTime",["$compile","$timeout",function(a,b){return{restrict:"E",replace:!0,scope:{model:"=ngModel",change:"&?ngChange"},template:'<div class="">                        <input list="timeList" type="time" ng-model="model.timeValue" ng-change="change()"/>                        <datalist id="timeList">                            <option value="01:00">                            <option value="02:00">                            <option value="03:00">                            <option value="04:00">                            <option value="05:00">                            <option value="06:00">                            <option value="07:00">                            <option value="08:00">                            <option value="09:00">                            <option value="10:00">                            <option value="11:00">                            <option value="12:00">                            <option value="13:00">                            <option value="14:00">                            <option value="15:00">                            <option value="16:00">                            <option value="17:00">                            <option value="18:00">                            <option value="19:00">                            <option value="20:00">                            <option value="21:00">                            <option value="22:00">                            <option value="23:00">                            <option value="24:00">                        </datalist>                   </div>',link:function(a,b,c){a.$watch("model.timeValue",function(b,c){b&&(a.model.value=a.model.timeValue.toTimeString().split(" ")[0].substring(0,5))}),a.$watch("model.value",function(b,c){return b?void(a.model.timeValue=new Date("Thu Jan 01 1970 "+a.model.value.substring(0,5)+" GMT+0330 (Iran Standard Time)")):void(a.model.timeValue=null)})}}}])}();
//# sourceMappingURL=forms-app.js.map