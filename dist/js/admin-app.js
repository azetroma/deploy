// داشبورد مدیریتی صدف info@sadafdashboard.ir

var app=app||{};app.contentSegment=$("#content_segment"),app.contentSegmentModal=$("#content_segmentModal"),console||(console={},console.log=function(){}),app.chartLoadDelay=120,app.absoluteUrl="/",app.setAboluteUrl=function(a){app.absoluteUrl=a},app.loadContent=function(a){app.showLoadingProgress(),$("#content_segment").load(app.urlPrefix+a,function(){app.hideLoadingProgress(),app.lang.setLang()})},app.setContent=function(a){$("#content_segment").html(a),app.hideLoadingProgress(),app.lang.setLang()},app.setLocation=function(a){app.router.navigate(a,{trigger:!0})},app.urlPrefix="/",app.setUrlPrefix=function(a){app.urlPrefix=a.replace(/Moderation.*/g,"")},app.showInfo=function(a){$("#app-info-text").html(a),$("#app-info-text").fadeIn(),$("#app-loading-text").hide(),app.showInfoHolder.show(),setTimeout(function(){app.showInfoHolder.hide(),$("#app-info-text").fadeOut(400,function(){$("#app-loading-text").show()})},4e3)},app.showLoadingProgress=function(){app.showInfoHolder.show()},app.hideLoadingProgress=function(){app.showInfoHolder.hide()},app.showInfoHolder={holderCount:0,timeout:{},hide:function(){if(app.showInfoHolder.holderCount>0&&--app.showInfoHolder.holderCount,0==app.showInfoHolder.holderCount){var a=(new Date).getTime()-app.showInfoHolder.ticks;clearTimeout(app.showInfoHolder.timeout),setTimeout(function(){$("#app-loading").parent("div").animate({top:"0",opacity:0},400)},1e3>a?1e3:0)}},show:function(){var a=$("#app-loading").parent("div");a.css("left",$(window).width()/2-a.outerWidth()/2),++app.showInfoHolder.holderCount,app.showInfoHolder.ticks=(new Date).getTime(),app.showInfoHolder.timeout=setTimeout(function(){$("#app-loading").parent("div").animate({top:"50",opacity:1},400)},1e3)}},app.encodeHTML=function(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},app.convertOldPropObject=function(a,b){if(a){if(a.chartProp&&a.chartProp.info)return a;var c={};if(c.chartProp={},+b==chartTypes.TABLE){c.chartProp.info={chartSize:a.chartProp.chartSize,pivotTable:a.chartProp.pivotTable},c.chartProp.series={};for(var d in a.seriesProp)a.seriesProp.hasOwnProperty(d)&&(c.chartProp.series[""+d]={name:a.seriesProp[""+d].table.headerName,numberFactor:"1",textAlign:a.seriesProp[""+d].table.textAlign,formatString:a.seriesProp[""+d].table.formatString,fontSize:a.seriesProp[""+d].table.fontSize,textBold:!1,textItalic:!1,color:a.seriesProp[""+d].table.fontColor}),c.chartProp.series["default"]={name:"",numberFactor:"1",textAlign:"right",formatString:"A",fontSize:"1m",textBold:!1,textItalic:!1,color:"#000000"}}if(+b==chartTypes.BAR){c.chartProp.info={chartSize:a.chartProp.chartSize,horizontalLines:a.chartProp.horizontalLine,formatString:a.chartProp.formatString},c.chartProp.series={};for(var d in a.seriesProp)a.seriesProp.hasOwnProperty(d)&&(c.chartProp.series[""+d]={name:"",numberFactor:a.seriesProp[""+d].barlineChartProp.numberFactor,seriesType:a.seriesProp[""+d].barlineChartProp.barlineChartType,seriesColor:a.seriesProp[""+d].barlineChartProp.barlineChartColor,lineType:a.seriesProp[""+d].barlineChartProp.barlineChartTypeLineProp.lineChartStyle,lineStyle:a.seriesProp[""+d].barlineChartProp.barlineChartTypeLineProp.lineChartLineStyle,lineWeight:a.seriesProp[""+d].barlineChartProp.barlineChartTypeLineProp.lineChartLineWeight,lineFace:a.seriesProp[""+d].barlineChartProp.barlineChartTypeLineProp.lineChartLineDashes});c.chartProp.series["default"]={name:"",numberFactor:"1",seriesType:"bar",seriesColor:"#1f77b4",lineType:"line-dot-area",lineStyle:"linear",lineWeight:"2",lineFace:"5,0"}}return+b==chartTypes.PIE&&(c.chartProp.info={horizontalLines:a.chartProp.horizontalLine,chartSize:a.chartProp.chartSize,formatString:a.chartProp.formatString,pieStyle:a.chartProp.pieStyle,hole:"65"},c.chartProp.series={},c.chartProp.series["default"]={numberFactor:"1"}),+b==chartTypes.GAUGE&&(c.chartProp.info={chartSize:a.chartProp.chartSize,style:a.chartProp.gaugeStyle,height:"medium",color:"#333333",fontSize:"3em",formatString:",.2f",status:"",target:"",textBold:!0,textItalic:!1,trend:"",value:"",segmentType:"singleSegment",min:"",yellow:"",green:"",max:""},c.chartProp.series={},c.chartProp.series["default"]={numberFactor:"1",type:"value",typeMs:"value"}),c.dataUrl=a.chartProp.DataUrl,c.editMode=a.chartProp.editMode,c}},app.autoPlayTimer=app.autoPlayTimer||{counter:0},app.autoPlay=function(a,b){if(a&&"start"==a){var c=$("#side-navigation2 .simple-link");b=b||10,$(".sadaf-circular-preogress").progressbar(10,1e3*+b),app.autoPlayTimer.timer=setTimeout(function(){var a=$(c[app.autoPlayTimer.counter++%c.length]);document.location.href=a.attr("href"),a.parents(".panel-collapse").collapse("show"),$(".sadaf-circular-preogress").progressbar("stop"),app.autoPlay("start",b)},1e3*+b)}a&&"stop"==a&&($(".sadaf-circular-preogress").progressbar("stop"),clearTimeout(app.autoPlayTimer.timer))};var resizeTimer;app.lestenWindowResize=function(a){function b(){clearTimeout(resizeTimer),resizeTimer=setTimeout(function(){a()},400)}var c=$(window).width();$(window).resize(function(){$(window).width();$(window).width()!=c&&(c=$(this).width(),b())})};var designMenuTimer,printMenuTimer;app.onMenusClick=function(a,b){return"showPrintMenu"==a||"hidePrintMenu"==a?(clearTimeout(printMenuTimer),void(printMenuTimer=setTimeout(function(){"showPrintMenu"==a?$(".navbar .print-toggle").fadeIn():"hidePrintMenu"==a&&$(".navbar .print-toggle").fadeOut()},800))):(clearTimeout(designMenuTimer),designMenuTimer=setTimeout(function(){"showDesignMenu"==a?$(".navbar .design-toggle").fadeIn():"hideDesignMenu"==a&&$(".navbar .design-toggle").fadeOut(),b&&"showfullScreenMenu"==b?$(".navbar .fullscreen-toggle").parents(".pull-right").fadeIn():$(".navbar .fullscreen-toggle").parents(".pull-right").fadeOut()},800),void $("html,body").animate({scrollTop:0},"slow",function(){$(".side-menu").hasClass("open")&&$("#side-menu-toggle").click()}))},app.print={printSingle:function(a,b){var c=this.getWidgetHtml(a);app.print.print(c,b)},getWidgetHtml:function(a){var b=$(a).height(),c=$(a).width(),d=$(a).clone();d.width(c),d.height(b);var e=d.find(".title.over-show .desc").html();d.find(".title.over-show *:not(.title-move)").remove();var f=$("<div>").append(d).html(),g=$('<div style="margin-top:10px;">'+e+"</div>").width(c),h=$("<div>").html(f).append(g);h.css({"page-break-inside":"avoid",margin:"0 50px 50px 50px"}),h.addClass("pull-left");var i=$("<div>").append(h).html();return i},printPage:function(){var a="";$(".chart-widget").each(function(){var b=$(this).find(".chart-layout").attr("id");a+=app.print.getWidgetHtml("#"+b)});var b=$(".dashboard-page.active > a").text();app.print.print(a,b)},print:function(a,b){var c='<link href="'+app.absoluteUrl+'Content/custom-rtl.css" rel="stylesheet"  type="text/css"/>               <link href="'+app.absoluteUrl+'Areas/Charts/Content/barChart-rtl.css" rel="stylesheet"  type="text/css"/>               <link href="'+app.absoluteUrl+'Content/bootstrap-select.css" rel="stylesheet"  type="text/css"/>               <link href="'+app.absoluteUrl+'Content/bootstrap-rtl.css" rel="stylesheet"  type="text/css"/>               <link href="'+app.absoluteUrl+'Areas/Charts/Content/dashboardPage-rtl.css" rel="stylesheet"  type="text/css"/>               <style  type="text/css">@page {                            margin: 1.5cm;                            @top-center {                                    content: "sapam";                                }                            }                </style>',d=window.open();d.document.write('<html><head><meta charset="utf-8"><title>'+b+"</title>"+c),d.document.write("</head><body>"),d.document.write(a),d.document.write("</body></html>"),d.document.close(),d.focus(),setTimeout(function(){d.print()},400)}},app.post=function(a,b,c){$.ajax({url:a,type:"POST",data:JSON.stringify(b),dataType:"json",contentType:"application/json; charset=utf-8",traditional:!0,success:c})},app.lang={langType:0,setLangTyle:function(a){this.langType=+(a||0)},isRtl:function(){return 0==app.lang.langType},translate:function(a){return app.lang.lang?app.lang.lang[a]||a:a},q:[],translateAsync:function(a,b){app.lang.lang?b&&b(app.lang.lang[a]||a):this.q.push({key:a,callback:b})},setLang:function(a){if(a&&a.data&&(this.lang=a.data),this.lang||!this.inProgress)if(this.lang||this.inProgress){var b;b=a&&a.selector?$(a.selector).find("*[data-trans-key]"):$("*[data-trans-key]"),b.each(function(){var a=$(this),b=a.data("translated");if(!b){var c=app.lang.lang[a.data("trans-key")],d=a.data("trans-attr");d?a.attr(d,c):a.text(c),a.data("translated",!0)}})}else{var c=0==app.lang.langType?"fa":"en";for(this.inProgress=!0,$.getJSON(app.urlPrefix+"dist/locales/locale-"+c+".js?v="+app.version,null,function(a){app.lang.setLang({data:a})});this.q.length>0;){var d=this.q.pop();d.callback&&callback(app.lang.lang[d.key]||d.key)}}}},angular.module("uibCollapseCat",[]).directive("uibCollapse",["$animate","$q","$parse","$injector",function(a,b,c,d){var e=d.has("$animateCss")?d.get("$animateCss"):null;return{link:function(d,f,g){function h(){f.hasClass("collapse")&&f.hasClass("in")||b.resolve(l(d)).then(function(){f.removeClass("collapse").addClass("collapsing").attr("aria-expanded",!0).attr("aria-hidden",!1),e?e(f,{addClass:"in",easing:"ease",to:{height:f[0].scrollHeight+"px"}}).start()["finally"](i):a.addClass(f,"in",{to:{height:f[0].scrollHeight+"px"}}).then(i)})}function i(){f.removeClass("collapsing").addClass("collapse").css({height:"auto"}),m(d)}function j(){return f.hasClass("collapse")||f.hasClass("in")?void b.resolve(n(d)).then(function(){f.css({height:f[0].scrollHeight+"px"}).removeClass("collapse").addClass("collapsing").attr("aria-expanded",!1).attr("aria-hidden",!0),e?e(f,{removeClass:"in",to:{height:"0"}}).start()["finally"](k):a.removeClass(f,"in",{to:{height:"0"}}).then(k)}):k()}function k(){f.css({height:"0"}),f.removeClass("collapsing").addClass("collapse"),o(d)}var l=c(g.expanding),m=c(g.expanded),n=c(g.collapsing),o=c(g.collapsed);d.$eval(g.uibCollapse)||f.addClass("in").addClass("collapse").attr("aria-expanded",!0).attr("aria-hidden",!1).css({height:"auto"}),d.$watch(g.uibCollapse,function(a){a?j():h()})}}}]);var manageApp=angular.module("management",["sadafForms","ngRoute","ngMaterial","ngAnimate","ngMessages","datasourceScheduleCat","datasourcePartitionExpressionCat","pascalprecht.translate","ngSanitize","mdColorPicker","ui.ace","ui.sortable","uibCollapseCat","textAngular"]);manageApp.config(["$provide",function(a){}]),manageApp.config(["$mdThemingProvider",function(a){a.theme("default").primaryPalette("blue").accentPalette("indigo").warnPalette("red").backgroundPalette("grey"),a.theme("t1").primaryPalette("grey").accentPalette("red").warnPalette("red").backgroundPalette("grey")}]),manageApp.config(["$translateProvider",function(a){a.useStaticFilesLoader({prefix:app.urlPrefix+"dist/locales/locale-",suffix:".js?v="+app.version}),a.preferredLanguage("fa"),a.useSanitizeValueStrategy("sanitizeParameters")}]),manageApp.config(["$httpProvider",function(a){}]),manageApp.config(["$provide",function(a){a.decorator("taOptions",["$delegate",function(a){return a.forceTextAngularSanitize=!0,a.toolbar=[["h1","h2","h3","h4","h5","h6","p","pre","quote"],["bold","italics","underline","ul","ol","redo","undo","clear"],["justifyLeft","justifyCenter","justifyRight","justifyFull"]],a.classes={focussed:"focussed",toolbar:"btn-toolbar",toolbarGroup:"btn-group",toolbarButton:"btn btn-default",toolbarButtonActive:"active",disabled:"disabled",textEditor:"form-control",htmlEditor:"form-control"},a}])}]);var service=["$http","$interval",function(a,b){var c;return{start:function(){var d=function(){a.get(app.urlPrefix+"api/onlineusers/heartbeat").then(null,function(a){a&&a.data&&a.data.forceSignout&&(alert("شما از برنامه خارج شده‌اید. ممکن است کاربر دیگری با نام کاربری شما وارد سیستم شده باشد."),window.location.href=app.urlPrefix)})};d(),c=b(d,3e4)},stop:function(){b.cancel(c)}}}];try{var sadaf=angular.module("sadaf");sadaf.factory("heartBeat",service),sadaf.run(["heartBeat",function(a){a.start()}])}catch(e){}try{var management=angular.module("management");management.factory("heartBeat",service),management.run(["heartBeat",function(a){a.start()}])}catch(e){}angular.module("ui.mask",[]).value("uiMaskConfig",{maskDefinitions:{2:/[0,1,2]/,6:/[0,1,2,3,4,5,6]/,9:/\d/,A:/[a-zA-Z]/,"*":/[a-zA-Z0-9]/},clearOnBlur:!0}).directive("uiMask",["uiMaskConfig","$parse",function(a,b){"use strict";return{priority:100,require:"ngModel",restrict:"A",compile:function(){var c=a;return function(a,d,e,f){function g(a){return angular.isDefined(a)?(t(a),O?(l(),m(),!0):k()):k()}function h(a){angular.isDefined(a)&&(E=a,O&&x())}function i(a){return O?(H=p(a||""),J=o(H),f.$setValidity("mask",J),J&&H.length?q(H):void 0):a}function j(a){return O?(H=p(a||""),J=o(H),f.$viewValue=H.length?q(H):"",f.$setValidity("mask",J),""===H&&e.required&&f.$setValidity("required",!f.$error.required),J?H:void 0):a}function k(){return O=!1,n(),angular.isDefined(Q)?d.attr("placeholder",Q):d.removeAttr("placeholder"),angular.isDefined(R)?d.attr("maxlength",R):d.removeAttr("maxlength"),d.val(f.$modelValue),f.$viewValue=f.$modelValue,!1}function l(){H=L=p(f.$viewValue||""),I=K=q(H),J=o(H);var a=J&&H.length?I:"";e.maxlength&&d.attr("maxlength",2*C[C.length-1]),d.attr("placeholder",E),d.val(a),f.$viewValue=a}function m(){P||(d.bind("blur",u),d.bind("mousedown mouseup",v),d.bind("input keyup click focus",x),P=!0)}function n(){P&&(d.unbind("blur",u),d.unbind("mousedown",v),d.unbind("mouseup",v),d.unbind("input",x),d.unbind("keyup",x),d.unbind("click",x),d.unbind("focus",x),P=!1)}function o(a){return a.length?a.length>=G:!0}function p(a){var b="",c=D.slice();return a=a.toString(),angular.forEach(F,function(b){a=a.replace(b,"")}),angular.forEach(a.split(""),function(a){c.length&&c[0].test(a)&&(b+=a,c.shift())}),b}function q(a){var b="",c=C.slice();return angular.forEach(E.split(""),function(d,e){a.length&&e===c[0]?(b+=a.charAt(0)||"_",a=a.substr(1),c.shift()):b+=d}),b}function r(a){var b=e.placeholder;return"undefined"!=typeof b&&b[a]?b[a]:"_"}function s(){return E.replace(/[_]+/g,"_").replace(/([^_]+)([a-zA-Z0-9])([^_])/g,"$1$2_$3").split("_")}function t(a){var b=0;if(C=[],D=[],E="","string"==typeof a){G=0;var c=!1,d=0,e=a.split("");angular.forEach(e,function(a,e){S.maskDefinitions[a]?(C.push(b),E+=r(e-d),D.push(S.maskDefinitions[a]),b++,c||G++):"?"===a?(c=!0,d++):(E+=a,b++)})}C.push(C.slice().pop()+1),F=s(),O=C.length>1}function u(){S.clearOnBlur&&(M=0,N=0,J&&0!==H.length||(I="",d.val(""),a.$apply(function(){f.$setViewValue("")})))}function v(a){"mousedown"===a.type?d.bind("mouseout",w):d.unbind("mouseout",w)}function w(){N=B(this),d.unbind("mouseout",w)}function x(b){b=b||{};var c=b.which,e=b.type;if(16!==c&&91!==c){var g,h=d.val(),i=K,j=p(h),k=L,l=!1,m=z(this)||0,n=M||0,o=m-n,r=C[0],s=C[j.length]||C.slice().shift(),t=N||0,u=B(this)>0,v=t>0,w=h.length>i.length||t&&h.length>i.length-t,x=h.length<i.length||t&&h.length===i.length-t,D=c>=37&&40>=c&&b.shiftKey,E=37===c,F=8===c||"keyup"!==e&&x&&-1===o,G=46===c||"keyup"!==e&&x&&0===o&&!v,H=(E||F||"click"===e)&&m>r;if(N=B(this),!D&&(!u||"click"!==e&&"keyup"!==e)){if("input"===e&&x&&!v&&j===k){for(;F&&m>r&&!y(m);)m--;for(;G&&s>m&&-1===C.indexOf(m);)m++;var I=C.indexOf(m);j=j.substring(0,I)+j.substring(I+1),l=!0}for(g=q(j),K=g,L=j,d.val(g),l&&a.$apply(function(){f.$setViewValue(j)}),w&&r>=m&&(m=r+1),H&&m--,m=m>s?s:r>m?r:m;!y(m)&&m>r&&s>m;)m+=H?-1:1;(H&&s>m||w&&!y(n))&&m++,M=m,A(this,m)}}}function y(a){return C.indexOf(a)>-1}function z(a){if(!a)return 0;if(void 0!==a.selectionStart)return a.selectionStart;if(document.selection){a.focus();var b=document.selection.createRange();return b.moveStart("character",a.value?-a.value.length:0),b.text.length}return 0}function A(a,b){if(!a)return 0;if(0!==a.offsetWidth&&0!==a.offsetHeight)if(a.setSelectionRange)a.focus(),a.setSelectionRange(b,b);else if(a.createTextRange){var c=a.createTextRange();c.collapse(!0),c.moveEnd("character",b),c.moveStart("character",b),c.select()}}function B(a){return a?void 0!==a.selectionStart?a.selectionEnd-a.selectionStart:document.selection?document.selection.createRange().text.length:0:0}var C,D,E,F,G,H,I,J,K,L,M,N,O=!1,P=!1,Q=e.placeholder,R=e.maxlength,S={};e.uiOptions?(S=a.$eval("["+e.uiOptions+"]"),angular.isObject(S[0])&&(S=function(a,b){for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&(void 0===b[c]?b[c]=angular.copy(a[c]):angular.extend(b[c],a[c]));return b}(c,S[0]))):S=c,e.$observe("uiMask",g),e.$observe("placeholder",h);var T=!1;e.$observe("modelViewValue",function(a){"true"===a&&(T=!0)}),a.$watch(e.ngModel,function(c){if(T&&c){var d=b(e.ngModel);d.assign(a,f.$viewValue)}}),f.$formatters.push(i),f.$parsers.push(j),d.bind("mousedown mouseup",v),Array.prototype.indexOf||(Array.prototype.indexOf=function(a){if(null===this)throw new TypeError;var b=Object(this),c=b.length>>>0;if(0===c)return-1;var d=0;if(arguments.length>1&&(d=Number(arguments[1]),d!==d?d=0:0!==d&&d!==1/0&&d!==-(1/0)&&(d=(d>0||-1)*Math.floor(Math.abs(d)))),d>=c)return-1;for(var e=d>=0?d:Math.max(c-Math.abs(d),0);c>e;e++)if(e in b&&b[e]===a)return e;return-1})}}}}]);var ngApp=angular.module("management");ngApp.directive("menuContainer",function(){return{restrict:"E",transclude:!0,scope:{openMenuName:"="},controller:["$scope",function(a){var b=a.menus=[];a.openMenuName&&(a.openMenuName.set=function(a){_.forEach(b,function(b){console.log(b.name,a),b.name==a&&b.header.click(!0)})}),a.select=function(a){angular.forEach(b,function(a){a.selected=!1}),a.selected=!0},this.addMenu=function(a){a.header.click=function(c){var d=a.header.isOpen;c&&(d=!1),_.forEach(b,function(a){a.header.isOpen=!1,a.body.isOpen=!1}),a.header.isOpen=!d,a.body.isOpen=!d},b.push(a)}}],template:"<div ng-transclude ></div>"}}).directive("menuItem",function(){return{require:"^^menuContainer",restrict:"E",transclude:!0,scope:{name:"@"},link:function(a,b,c,d){d.addMenu(a)},controller:["$scope",function(a){a.select=function(){},this.addHeader=function(b){a.header=b},this.addBody=function(b){a.body=b}}],template:"<div ng-transclude></div><md-divider></md-divider>"}}).directive("menuHeader",function(){return{require:"^^menuItem",restrict:"E",transclude:!0,scope:{},link:function(a,b,c,d){d.addHeader(a)},controller:["$scope",function(a){}],template:'<md-list-item class="md-no-sticky pointer header" ng-click="click()" ng-class="{active: isOpen}">               <div layout="row" flex layout-align="start center">                                                                  <div ng-transclude style="display:inline-block"> </div>                                                          <span flex></span>                                                                                               <span class="material-icons icon-animate " ng-click="click()" ng-class="{rotate : isOpen}">keyboard_arrow_down</span>             </div>                                                                                                       </md-list-item>'}}).directive("menuBody",function(){return{restrict:"E",require:"^^menuItem",transclude:!0,scope:{},link:function(a,b,c,d){d.addBody(a)},template:'<div uib-collapse="!isOpen"><div class="menu-body-container" ng-transclude></div></div>'}}).directive("switchButton",function(){return{restrict:"E",transclude:!0,scope:{ngModel:"="},template:'<div style="display:inline-block" class="switch-button" ng-click="ngModel = !ngModel" ng-class="{ active : ngModel}"><div ng-transclude style="display:inline-block"></div></div>'}}).directive("sadafIndicator",function(){return{restrict:"E",transclude:!0,scope:{model:"=ngModel",series:"=",onChange:"&ngChange",hideThen:"@"},controller:["$scope","$translate",function(a,b){var c=a.model;a.hideThen;c.ifRow=c.ifRow||[{}],c.thenRow=c.thenRow||[{}],a.ops=[{value:"1",name:"equal"},{value:"2",name:"not_equal"},{value:"3",name:"greater_than"},{value:"4",name:"greater_equal_than"},{value:"5",name:"less_than"},{value:"6",name:"less_equla_than"},{value:"7",name:"contain"},{value:"8",name:"not_contain"}],a.thenOps=[{value:"1",name:"change_color"},{value:"2",name:"add_icon"},{value:"3",name:"change_back_color"},{value:"4",name:"change_style"},{value:"5",name:"replace"}]}],template:'<div>                                                                                                                                                 <div ng-repeat="i in model.ifRow" class="form-row" >                                                                                                                      <span ng-show="model.ifRow.length > 1 && !$first">{{ \'and\' | translate }}</span>                                                                                   <span>{{ \'if\' | translate }}</span>                                                                                                                                <select ng-model="i.firstField" ng-options="s as s for s in series" ng-change="onChange()"></select>                                                                 <select ng-model="i.operand" ng-options="s.value as (s.name | translate) for s in ops" ng-change="onChange()"></select>                                                <md-switch ng-model="i.secondFieldIsText" style="margin: 0 0px -13px 8px;display:inline-block;line-height: 1.5;"><span style="padding: 0 8px">{{ \'istext\' | translate }}</span></md-switch>                                                                                                 <select ng-model="i.secondFieldSelect" ng-options="s as s for s in series" ng-show="!i.secondFieldIsText" ng-change="onChange()"></select>                           <input ng-model="i.secondFieldInput" type="text" ng-show="i.secondFieldIsText"  ng-change="onChange()"/>                                                             <span ng-click="model.ifRow.splice( $index+1, 0, {})">+</span>                                                                                                       <span ng-click="model.ifRow.splice($index, 1); onChange()" ng-show="model.ifRow.length > 1">{{ \'remove\' | translate }}</span>                                  </div>                                                                                                                                                               <div ng-repeat="i in model.thenRow" ng-hide="hideThen" class="form-row" layout="row" layout-align="start center">                                                                           <span ng-show="model.thenRow.length > 1 && !$first">{{ \'and\' | translate }}</span>                                                                                 <span>{{ \'then\' | translate }}</span>                                                                                                                              <select ng-model="i.firstField" ng-options="s as s for s in series" ng-change="onChange()"></select>                                                                 <select ng-model="i.operand" ng-options="s.value as (s.name | translate) for s in thenOps" ng-change="onChange()"></select>                                                                                                                                                                                                                 <span md-color-picker ng-model="i.secondFieldColor" ng-show="i.operand == 1" md-color-default-tab="\'genericPalette\'"  on-change="onChange()"></span>               <span md-color-picker ng-model="i.secondFieldBackColor" ng-show="i.operand == 3" md-color-default-tab="\'genericPalette\'" on-change="onChange()"></span>            <select ng-show="i.operand == 4" ng-model="i.secondFieldStyle" ng-change="onChange()">                                                                                   <option value="1">{{ \'normal\' | translate }}</option>                                                                                                              <option value="2">{{ \'bold\' | translate }}</option>                                                                                                                <option value="3">{{ \'italic\' | translate }}</option>                                                                                                              <option value="4">{{ \'bold_italic\' | translate }}</option>                                                                                                         <option value="5">{{ \'underline\' | translate }}</option>                                                                                                       </select>                                                                                                                                                            <input ng-model="i.secondFieldReplace" type="text" ng-show="i.operand == 5" />                                                                                                                                                                                                                                                            <span ng-click="model.thenRow.splice( $index+1, 0, {})">+</span>                                                                                                     <span ng-click="model.thenRow.splice($index, 1); onChange()" ng-show="model.thenRow.length > 1">{{ \'remove\' | translate }}</span>                              </div>                                                                                                                                                           </div>'}}).directive("sadafContactList",function(){return{restrict:"E",transclude:!0,scope:{model:"=ngModel"},controller:["$scope",function(a){a.model=a.model||[{}]}],template:'<div>                                                                                                     <div ng-repeat="i in model" class="form-row">                                                              <span>{{$index}}</span>                                                                                <input ng-model="i.phone" type="text"  placeholder="{{\'phone\' | translate}}"/>                       <input ng-model="i.email" type="text"  placeholder="{{\'email\' | translate}}"/>                       <span ng-click="model.splice( $index+1, 0, {})">+</span>                                               <span ng-click="model.splice($index, 1)" ng-show="model.length > 1">حذف</span>                    </div>                                                                                             </div>'}}).directive("sadafRemovable",function(){return{restrict:"E",transclude:!0,scope:{onDelete:"&onDelete"},controller:["$scope",function(a){a.model=a.model||[{}]}],template:'<div layout="row" layout-align="start center">                <span class ="material-icons small" ng-click="onDelete()">close</span>                <div ng-transclude></div>            </div>'}}).directive("fileread",[function(){return{scope:{fileread:"="},link:function(a,b,c){b.bind("change",function(b){a.$apply(function(){a.fileread=a.fileread||{},a.fileread=b.target.files[0]})})}}}]).directive("collapse",function(){return{restrict:"E",transclude:!0,scope:{title:"@",hideIcon:"@",onTitleClick:"&",model:"=?ngModel",selectableDir:"=?"},controller:["$scope",function(a){var b,c;a.model=a.model||{},this.addHeader=function(d){b=d,b.show=a.model.open,b.click=function(){c&&(a.model.open=!c.show,c.show=!c.show),a.onTitleClick()}},this.addBody=function(b){c=b,c.show=a.model.open},"true"==a.hideIcon&&b&&(b.hideIcon=!0),a.$watch("hideIcon",function(c){"true"==a.hideIcon&&b&&(b.hideIcon=!0)})}],template:"<div ng-transclude><div>"}}).directive("collapseHeader",function(){return{restrict:"E",transclude:!0,require:"^^collapse",scope:{},link:function(a,b,c,d){d.addHeader(a)},template:'<div ng-click="show = !show; click()" layout="row" layout-align="start center" class="pointer title">                        <span class ="material-icons icon-animate right-arrow" ng-class ="{\'rotate-90\' : show}" ng-hide="hideIcon">keyboard_arrow_right</span>                        <div ng-transclude><div>                 </div>'}}).directive("collapseBody",function(){return{restrict:"E",transclude:!0,require:"^^collapse",scope:{},link:function(a,b,c,d){d.addBody(a)},template:'<div class="body" uib-collapse="!show" ng-transclude></div>'}}).directive("tree",function(){return{restrict:"E",transclude:!0,scope:{root:"=ngModel",option:"=",url:"&"},controller:["$scope","$http","$translate",function(a,b,c){function d(a,b){b(a),a.nodes&&(_.forEach(a.nodes,function(a){d(a,b)}),_.forEach(a.contents,function(a){d(a,b)}))}a.root=a.root||{name:"root",open:!0},a.active=function(b){var c=b.active;a.option.multiple||d(a.root,function(a){a.active=!1}),b.active=c},a.selectAll=function(a,b){_.each(a.contents,function(a){a.active=b})}}],template:'<div class ="sadaf-tree">                                                                                                                                    <div style="list-style:none" class ="tree-element ul">                                                                                                       <div ng-repeat="data in [root]" class ="tree-element li" ng-include="\'tree_item_renderer.html\'"></div>                                             </div>                                                                                                                                               </div>                                                                                                                                                                                                                                                                                                            <script type="text/ng-template" id="tree_item_renderer.html">                                                                                                <collapse class ="block" selectable-dir="option.selectableDir" ng-model="data"                                                                               hide-icon="{{(!data.nodes || !data.nodes.length ) && ( option.justDir || ( !data.contents || !data.contents.length) ) && data.loaded }}">                                                                                                                                                                         <collapse-header class ="block" ng-click="$event.stopPropagation(); option.url(data)">                                                                       <md-checkbox ng-show="option.selectableDir" ng-model="data.active"ng-change="active(data)" ng-click="$event.stopPropagation()"                                       style="margin:0">{{data.name}}</md-checkbox>                                                                                                 <span ng-show="!option.selectableDir">{{data.name}}</span>                                                                                           </collapse-header>                                                                                                                                                                                                                                                                                                <collapse-body class ="block">                                                                                                                               <div class ="tree-element ul" style="list-style:none" >                                                                                                      <div layout="row" layout-align="start center" ng-hide="data.loaded" style="padding:0 18px; font-size:0.8em">                                                     <md-progress-circular  md-mode=\'indeterminate\' md-diameter="20" ></md-progress-circular>                                                               {{\'form_loading\' | translate}}                                                                                                                 </div>                                                                                                                                                   <div class ="tree-element li"><md-checkbox ng-show="option.multiple" ng-click="$event.stopPropagation()" ng-model="data.selectAll" ng-change="selectAll(data, data.selectAll)"><small> {{"select_all" | translate}} </small></md-checkbox></div>                                                                                                                                               <div ng-repeat="data in data.nodes" class ="tree-element li" ng-include="\'tree_item_renderer.html\'"></div>                                             <div ng-repeat="u in data.contents" class ="tree-element li" ng-class ="{active : u.active}" ng-hide="option.justDir">                                       <md-checkbox ng-model="u.active" ng-change="active(u)" style="margin-bottom:0">{{u.name}}</md-checkbox>                                              </div>                                                                                                                                               </div>                                                                                                                                               </collapse-body>                                                                                                                                                                                                                                                                                              </collapse>                                                                                                                                                                                                                                                                                                   </script>'
}}).directive("menuPermission",function(){return{restrict:"E",transclude:!0,scope:{menus:"=",roles:"="},controller:["$scope","$http","$translate",function(a,b,c){}],template:'            <menu-item class="panel ">                <menu-header>{{ \'menus\' | translate }}</menu-header>                <menu-body>                    <div style="margin:0 20px">                                                              {{menus}}<collapse ng-repeat="(k,v) in menus">                                                                   <div layout="row">                                                                                             <collapse-header>                                                                                              {{k}}                                                                                                  </collapse-header>                                                                                         <span flex></span>                                                                                     </div>                                                                                                     <collapse-body>                                                                                                <div style="margin:0 20px">                                                                                <div ng-repeat="r in v" layout="row" layout-align="start center">                                              <md-checkbox ng-model="r.check">{{r.name}}</md-checkbox>                                                   <span flex></span>                                                                                                                                                                                                 </div>                                                                                                 </div>                                                                                                 </collapse-body>                                                                                       </collapse>                                                                                            </div>                                                                                         </menu-body>            </menu-item>            <menu-item class="panel ">                <menu-header>{{ \'datasources\' | translate }}</menu-header>                <menu-body>                    <datasource-permission ng-model="roles" class="block" type="chart" id="{{parent.id}}"></datasource-permission>                </menu-body>            </menu-item>'}});var ngApp=angular.module("management");ngApp.controller("menusCtrl",["$scope","$http","$sce","$routeParams","$location","$mdSidenav","toolbar","$timeout","$translate","$mdMedia",function(a,b,c,d,e,f,g,h,i,j){a.lock=j("gt-md"),a.toolbar=g,a.app=app,a.mainMenuType=1,a.toggle=function(){console.log("### locl",a.lock,j("gt-md")),j("gt-md")?a.lock=!a.lock:(f("r").toggle(),console.log("### call toggle"))},b.get(app.urlPrefix+"menu/MenuCategories/3").then(function(b){function c(){a.closeAll();var b=e.path();_.each(a.menuCategories.data,function(a){_.each(a.menus,function(c){c.active=!1,b.replace(/^\/(.*)/i,"$1")==c.menu.Link.replace(/^\/(.*)/i,"$1")&&(c.active=!0,a.isOpen=!0)})})}a.menuCategories=b.data;try{a.menuCategories.data[4].menus.splice(0,1)}catch(d){}var f={"Account/UsersList":"/users","Account/RolesList":"/roles","Moderation/DataSource/index/":"/datasources","Moderation/Charts/index/":"/charts","Moderation/GlobalVariable/index/":"/variables","Moderation/DatasourceInterRelation/index/":"/datasourceJoin","Moderation/AutoUpdate/index/":"/settings/update","Moderation/Settings/Mail/":"/settings/mail","Moderation/Settings/GeneralSettings/":"/settings",onlineUsers:"/onlineUsers",licence:"/licence"},g={"Account/UsersList":"person","Account/RolesList":"group","Moderation/DataSource/index/":"storage","Moderation/Charts/index/":"timeline","Moderation/GlobalVariable/index/":"space_bar","Moderation/DatasourceInterRelation/index/":"linear_scale","Moderation/AutoUpdate/index/":"update","Moderation/Settings/Mail/":"mail","Moderation/Settings/GeneralSettings/":"settings",onlineUsers:"rowing",licence:"card_membership",syncUserVariablesList:"sync","forms/list":"assignment"};_.each(a.menuCategories.data,function(a){_.each(a.menus,function(a){a.menu.icon=g[a.menu.Link]||"code",a.menu.Link=f[a.menu.Link]||a.menu.Link})}),c(),a.$on("$locationChangeStart",function(a,b,d){c()})}),a.setLink=function(a){f("r").toggle(),h(function(){e.path(a.menu.Link)},400)},a.closeNav=function(){f("r").toggle()},a.closeAll=function(b){_.each(a.menuCategories.data,function(a){b?a.category.Id!==b.category.Id&&(a.isOpen=!1):a.isOpen=!1})},a.gotoDashboard=function(){e.path()},0==+$("#lang").val()?i.use("fa"):i.use("en")}]),ngApp.service("toolbar",[function(){function a(a){f=a}function b(){return f}function c(a){e=a}function d(){e&&e.toggle()}var e,f=[{name:"",click:function(){}}];return{setTitles:a,getTitles:b,setSideNave:c,toggleSideNave:d}}]);var ngApp=angular.module("management");ngApp.config(["$routeProvider","$locationProvider",function(a,b){a.when("/datasources/add/mssql/:type/:packageId?/:id?",{templateUrl:app.urlPrefix+"dist/partial/management/datasource/mssql.html?v="+app.version,controller:"datasourceMssqlCtrl"}).when("/datasources/add/file/:packageId?/:id?",{templateUrl:app.urlPrefix+"dist/partial/management/datasource/file.html?v="+app.version,controller:"datasourcefileCtrl"}).when("/datasources/add/web/:packageId?/:id?",{templateUrl:app.urlPrefix+"dist/partial/management/datasource/web.html?v="+app.version,controller:"datasourceWebCtrl"}).when("/datasources/add/join/:packageId?/:id?",{templateUrl:app.urlPrefix+"dist/partial/management/datasource/join.html?v="+app.version,controller:"datasourceJoinCtrl"}).when("/datasources/new/:id?",{templateUrl:app.urlPrefix+"dist/partial/management/datasource/new.html?v="+app.version,controller:"datasourceNewCtrl"}).when("/datasources/:id?",{templateUrl:app.urlPrefix+"dist/partial/management/datasource/list.html?v="+app.version,controller:"datasourceListCtrl"}).when("/datasourceJoin",{templateUrl:app.urlPrefix+"dist/partial/management/datasource/interRelation.html?v="+app.version,controller:"interRelationCtrl"}).when("/charts/:id?",{templateUrl:app.urlPrefix+"dist/partial/management/charts/list.html?v="+app.version,controller:"chartsListCtrl"}).when("/charts/edit/:packageId?/:id?",{templateUrl:app.urlPrefix+"dist/partial/management/charts/editor.html?v="+app.version,controller:"chartsEditorCtrl"}).when("/charts/new/:type/:packageId/:datasourceId?",{templateUrl:app.urlPrefix+"dist/partial/management/charts/editor.html?v="+app.version,controller:"chartsEditorCtrl"}).when("/variables",{templateUrl:app.urlPrefix+"dist/partial/management/datasource/list.html?v="+app.version,controller:"datasourceCtrl"}).when("/users",{templateUrl:app.urlPrefix+"dist/partial/management/account/userList.html?v="+app.version,controller:"usersListCtrl"}).when("/users/edit/:id?",{templateUrl:app.urlPrefix+"dist/partial/management/account/userEdit.html?v="+app.version,controller:"userEditCtrl"}).when("/roles",{templateUrl:app.urlPrefix+"dist/partial/management/account/roleList.html?v="+app.version,controller:"rolesListCtrl"}).when("/roles/edit/:id?",{templateUrl:app.urlPrefix+"dist/partial/management/account/roleEdit.html?v="+app.version,controller:"roleEditCtrl"}).when("/variables",{templateUrl:app.urlPrefix+"dist/partial/management/account/variables.html?v="+app.version,controller:"variablesCtrl"}).when("/settings/update",{templateUrl:app.urlPrefix+"dist/partial/management/account/update.html?v="+app.version,controller:"updateCtrl"}).when("/settings/mail",{templateUrl:app.urlPrefix+"dist/partial/management/account/mail.html?v="+app.version,controller:"mailCtrl"}).when("/settings",{templateUrl:app.urlPrefix+"dist/partial/management/account/settings.html?v="+app.version,controller:"settingsCtrl"}).when("/onlineUsers",{templateUrl:app.urlPrefix+"dist/partial/management/account/onlineUsers.html?v="+app.version,controller:"onlineUsersCtrl"}).when("/licence",{templateUrl:app.urlPrefix+"dist/partial/management/account/licence.html?v="+app.version,controller:"licenceCtrl"}).when("/activeDirectory",{templateUrl:app.urlPrefix+"dist/partial/management/account/activeDirectory.html?v="+app.version,controller:"activeDirectoryCtrl",controllerAs:"ad"}).when("/syncUserVariablesList",{templateUrl:app.urlPrefix+"dist/partial/management/account/syncUserVariablesList.html?v="+app.version,controller:"syncUserVariablesListCtrl",controllerAs:"cnl"}).when("/syncUserVariablesDetail/:id?",{templateUrl:app.urlPrefix+"dist/partial/management/account/syncUserVariablesDetail.html?v="+app.version,controller:"syncUserVariablesDetailCtrl",controllerAs:"cnl"}).otherwise({redirectTo:"datasources"})}]);var ngApp=angular.module("management");ngApp.service("templates",[function(){var a={package_dialog:app.urlPrefix+"dist/partial/management/packages/select-package.html"};return{tmpl:a}}]);var ngApp=angular.module("management");ngApp.controller("activeDirectoryCtrl",["$scope","$http","$sce","$timeout","$mdToast","toolbar","$translate","utils","roles",function(a,b,c,d,e,f,g,h,i){var j=this;a.utils=h,a.app=app,g("Active Directory Integration").then(function(b){a.listTranslate=b,f.setTitles([{name:b,onclick:function(){}}])}),j.bindOption=2,i.get().then(function(a){j.roles=a.data.list}),this.getList=function(){j.progress=!0,b.post(app.urlPrefix+"api/activedirectory/GetUserList",JSON.stringify({server:j.server,user:j.user,pass:j.pass,container:j.container,bindOption:j.bindOption})).then(function(a){j.progress=!1,j.data=a.data},function(a){h.showErrorToast(a.data.desc),j.progress=!1})},this.selectAll=function(a){_.forEach(j.data,function(b){b.select=a})},this.saveSelectedUsers=function(){j.saveProgress=!0;var a=_.filter(j.data,{select:!0}).map(function(a){return{server:a.server,user:a.SamAccountName,pass:a.DisplayName,container:j.container,bindOption:j.bindOption}}),d=_.filter(j.roles,{check:!0});b.post(app.urlPrefix+"api/activedirectory/SaveUsers",JSON.stringify({users:a,roles:d})).then(function(a){if(j.saveProgress=!1,a.data&&a.data.length)j.error=c.trustAsHtml("<ul><li>"+a.data.map(function(a){return a.user+", "}).join("</li><li>")+"</li></ul>");else{var b=e.simple().textContent("کاربرهای انتخاب شده با موفقیت به سیستم اضافه شدند");e.show(b)}j.data=null},function(a){h.showErrorToast(a.data.desc),j.saveProgress=!1})}}]);var ngApp=angular.module("management");ngApp.controller("syncUserVariablesListCtrl",["$scope","$http","$sce","$timeout","$mdToast","toolbar","$translate","utils","roles","$mdDialog",function(a,b,c,d,e,f,g,h,i,j){function k(a){e.show({template:'<md-toast class="md-toast error"> <span class="md-toast-text" flex>'+a+"</span></md-toast>",hideDelay:3e3,position:"bottom left"})}var l=this;l.utils=h,l.app=app;g("User Variable Sync").then(function(b){a.listTranslate=b,f.setTitles([{name:b,onclick:function(){}}])}),l.progress=!0,b.get(app.urlPrefix+"api/syncUserVariables/get").then(function(a){l.progress=!1,l.data=a.data},function(){l.progress=!1,k("خطایی در دریافت اطلاعات رخ داده است")}),l.sync=function(a,c){c.progress=!0,b.get(app.urlPrefix+"api/syncUserVariables/sync?id="+c.Id).then(function(a){c.progress=!1,c.LastRefresh=a.data.LastRefresh,e.show(e.simple().textContent(" منبع داده "+c.DatasourceName+"  و متغیر "+c.VariableName+" با موفقیت همگام شدند"))},function(){c.progress=!1,k("خطایی در همگام‌سازی رخ داده است")})},l["delete"]=function(a,c){var d=j.confirm().title("حذف برای همیشه؟").textContent("آیا ارتباط بین منبع داده "+c.DatasourceName+"  و متغیر "+c.VariableName+" حذف شود؟").ariaLabel("حذف").targetEvent(a).ok("حذف!").cancel("لغو");j.show(d).then(function(){b.get(app.urlPrefix+"api/syncUserVariables/delete?id="+c.Id).then(function(a){e.show(e.simple().textContent("عملیات با موفقیت به اتمام رسید")),_.remove(l.data,{Id:c.Id})},function(){k("خطایی در حذف رخ داده است")})})}}]),ngApp.controller("syncUserVariablesDetailCtrl",["$scope","$http","$sce","$timeout","$mdToast","toolbar","$translate","utils","datasources","$routeParams",function(a,b,c,d,e,f,g,h,i,j){function k(a){n.getInfoProgress=!1,n.error=a.data.desc}function l(){n.error=null}function m(a){e.show({template:'<md-toast class="md-toast error"> <span class="md-toast-text" flex>'+a+"</span></md-toast>",hideDelay:3e3,position:"bottom left"})}var n=this;a.utils=h,a.app=app;var o="undefined"!=typeof j.id?j.id:0;if(g("User Variable Sync").then(function(b){a.listTranslate=b,f.setTitles([{name:b,onclick:function(){}}])}),o>0){n.getInfoProgress=!0;var p=app.urlPrefix+"api/syncUserVariables/get?id="+o;b.get(p).then(function(a){n.userProperties=[],n.selectedDatasource={id:a.data.DatasourceId,name:a.data.DatasourceName},n.usernameColumn=a.data.UsernameColumn,n.variableValueColumn=a.data.VariableValueColumn,n.variableName=a.data.VariableName,n.getColumns()},function(a){k(a)})}n.selectDatasource=function(a){i.select(a,{type:["datasources"]}).then(function(a){l(),n.selectedDatasource=a.selected[0],n.getColumns()})},n.getColumns=function(){i.getColumns(n.selectedDatasource.id).then(function(a){n.getInfoProgress=!1,n.datasourceColumns=a.CubeInfo.Dimensions[0].Hierarchies,n.userProperties=a.UsersProperty},function a(b){a(b)})},n.saveAndSync=function(c){return a.syncForm.$valid?(n.syncProgress=!0,n.syncError=null,n.effectedUsers=null,void b.post(app.urlPrefix+"api/syncUserVariables/saveAndSync",{id:o,datasourceId:n.selectedDatasource.id,usernameColumn:n.usernameColumn,variableValueColumn:n.variableValueColumn,variableName:n.variableName}).then(function(a){n.syncProgress=!1,n.effectedUsers=a.data.effected,o=a.data.id,e.show(e.simple().textContent("عملیات با موفقیت به اتمام رسید"))},function(a){n.syncProgress=!1,n.syncError=a.data.desc,m("خطایی در روند همگام سازی به وجود آمده است")})):void m("فیلدهای ضروری باید پر شوند")}}]);var ngApp=angular.module("management");ngApp.controller("licenceCtrl",["$scope","$http","$sce","$timeout","$mdToast","toolbar","$translate","utils",function(a,b,c,d,e,f,g,h){a.utils=h,g("licence_manager").then(function(b){a.listTranslate=b,f.setTitles([{name:b,onclick:function(){}}])}),a.progress=!0,b.get(app.urlPrefix+"api/licence/get").then(function(b){a.progress=!1,a.data=b.data}),a.clear=function(){b.get(app.urlPrefix+"api/licence/clear").then(function(a){window.location=app.urlPrefix+"Account/LogOff"})}}]);var ngApp=angular.module("management");ngApp.controller("mailCtrl",["$scope","$http","$sce","$timeout","$mdToast",function(a,b,c,d,e){a.save=function(d){a.progress=!0,a.message=null,a.error=null,b.post(app.urlPrefix+"Moderation/Settings/Mail",JSON.stringify({port:a.port,host:a.host,ssl:a.ssl,timeout:a.timeout,username:a.username,password:a.password}),{headers:{"Content-Type":"application/json; charset=utf-8"}}).then(function(b){if(a.progress=!1,b.data.result){window.history.back();var d=e.simple().textContent("تغییرات ثبت شد");e.show(d)}else a.message=null,a.error=c.trustAsHtml(b.data.error)},function(b){a.progress=!1,a.message=null,a.error=c.trustAsHtml(b.data.desc)})},a.test=function(d){a.error=null,a.message=null,a.progress=!0,b.post(app.urlPrefix+"Moderation/Settings/Test",JSON.stringify({port:a.port,host:a.host,ssl:a.ssl,timeout:a.timeout,username:a.username,password:a.password}),{headers:{"Content-Type":"application/json; charset=utf-8"}}).then(function(b){if(a.progress=!1,b.data.result){a.message=c.trustAsHtml("ارسال پست الکترونیک با اطلاعات وارد درست است");var d=e.simple().textContent("ارسال پست الکترونیک با اطلاعات وارد درست است");e.show(d)}else a.message=null,a.error=c.trustAsHtml(b.data.error)},function(b){a.progress=!1,a.message=null,a.error=c.trustAsHtml(b.data.desc)})},a.infoProgress=!0,b.get(app.urlPrefix+"api/settings/getMailInfo").then(function(b){a.infoProgress=!1;var c=b.data;a.port=c.port,a.host=c.host,a.ssl=c.ssl,a.timeout=c.timeout,a.username=c.username,a.password=c.password},function(b){a.infoProgress=!1,a.error=c.trustAsHtml(b.data.desc)})}]);var ngApp=angular.module("management");ngApp.controller("onlineUsersCtrl",["$scope","$http","$sce","$timeout","$mdToast","toolbar","$translate","utils",function(a,b,c,d,e,f,g,h){a.utils=h,g("online_users").then(function(b){a.listTranslate=b,f.setTitles([{name:b,onclick:function(){}}])}),a.kick=function(a){b.get(app.urlPrefix+"api/onlineusers/kick/"+a.id).then(function(a){})},a.progress=!0,b.get(app.urlPrefix+"api/onlineusers/get").then(function(b){a.progress=!1,a.data=b.data})}]);var ngApp=angular.module("management");ngApp.controller("roleEditCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$translate","$sce","roles","menus","utils","datasources",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){function o(b){a.error=j.trustAsHtml("<b>"+b.data.title+"</b> <br/>"+b.data.desc)}function p(){a.model&&a.users&&a.menus&&(a.model.FirstMenuId=a.model.FirstMenuId+"",a.model.FunctionalActions&&_.forEach(a.actions,function(b){_.forEach(b.childes,function(b){b.check=-1!=a.model.FunctionalActions.indexOf(b.id)})}),_.forEach(a.users,function(b){b.check=-1!=a.model.Users.indexOf(b.id)}),_.forEach(a.model.MenuActions,function(b){var c=b.split("-").map(function(a){return+a}),d=c[0],e=c[1];_.forEach(a.menus,function(a,b){var c=_.find(a,{id:e});return c?(c.action=d,c.check=!0,!1):void 0})}),a.datasources=a.model.DatasourceActions.map(function(a){return JSON.parse(a)}),a.charts=a.model.ChartActions.map(function(a){return JSON.parse(a)}),_.forEach(a.model.MenuCategoryActions,function(b){var c=b.split("-").map(function(a){return+a}),d=c[0],e=c[1];a.menuCategoriesAction[e]=d}),a.forms=a.model.forms)}function q(a){c.show({template:'<md-toast class="md-toast error"> <span class="md-toast-text" flex>'+a+"</span></md-toast>",hideDelay:3e3,position:"bottom left"})}var r={ChartAdd:1,ChartView:2,ChartEdit:3,ChartDelete:4,MenuAdd:5,MenuView:6,MenuEdit:7,MenuDelete:8,DataSourceAdd:9,DataSourceView:10,DataSourceEdit:11,DataSourceDelete:12,FormAdd:22,FormView:23,FormEdit:24,FormDelete:25,AdminAccessOnCharts:13,AdminAccessOnMenus:14,AdminAccessOnDataSources:15,AdminAccessOnForms:21,DashboardAddDeleteArragneCharts:16,ManageAllUsersAndRoles:17,ViewManageMainMenu:18,ArrangeMenus:19};a.actions=[{title:"مدیریت نمودارها",childes:[{id:r.ChartAdd,name:"ساخت نمودار جدید"},{id:r.ChartView,name:"مشاهده نمودار"},{id:r.ChartEdit,name:"ویرایش نمودار"},{id:r.ChartDelete,name:"حذف نمودار"}]},{title:"مدیریت منوها",childes:[{id:r.MenuAdd,name:"ساخت منوی جدید"},{id:r.MenuView,name:"مشاهده منو"},{id:r.MenuEdit,name:"ویرایش منو"},{id:r.MenuDelete,name:"حذف منو"}]},{title:"مدیریت فرم‌ها",childes:[{id:r.FormAdd,name:"ساخت فرم جدید"},{id:r.FormView,name:"مشاهده فرم"},{id:r.FormEdit,name:"ویرایش فرم"},{id:r.FormDelete,name:"حذف فرم"}]},{title:"مدیریت منابع داده",childes:[{id:r.DataSourceAdd,name:"ساخت منبع داده‌ی جدید"},{id:r.DataSourceView,name:"مشاهده منبع داده"},{id:r.DataSourceEdit,name:"ویرایش منبع داده"},{id:r.DataSourceDelete,name:"حذف منبع داده"}]},{title:"مدیریت صفحات داشبوردی و کاربران و نقش‌ها",childes:[{type:"input",id:r.ArrangeMenus,name:"تغییر ترتیب منوها"},{type:"input",id:r.ManageAllUsersAndRoles,name:"مدیریت کاربران و نقش‌ها"}]},{title:"دسترسی کامل",childes:[{type:"input",id:r.AdminAccessOnCharts,name:"دسترسی کامل به تمام نمودارها"},{type:"input",id:r.AdminAccessOnMenus,name:"دسترسی کامل به تمام منوها"},{type:"input",id:r.AdminAccessOnDataSources,name:"دسترسی کامل به تمام منابع داده"},{type:"input",id:r.AdminAccessOnForms,name:"دسترسی کامل به تمام فرم‌ها"}]}];var s="undefined"!=typeof e.id?e.id:0,t=s>0;a.id=s,a.isEdit=t,l.get().then(function(b){_.forEach(b.data,function(a){a.check=!1}),a.menus=_.groupBy(b.data,function(a){return JSON.stringify({name:a.parent,id:a.parentId})}),_.forEach(a.menus,function(a){_.forEach(a,function(a){a.action=1})}),a.menuCategoriesAction={},p()}),a.jsonParse=function(a){return JSON.parse(a)},a.setViewPermission=function(b,c){var d=JSON.parse(b).id;_.some(c,{check:!0})?a.menuCategoriesAction[d]=a.menuCategoriesAction[d]||1:delete a.menuCategoriesAction[d]},b.get(app.urlPrefix+"api/users/get").then(function(b){a.progress=!1,a.users=b.data,p()},m.error),a.datasources=[],a.addDatasource=function(b){n.select(b,{type:["datasources"],multipleDatasource:!0}).then(function(b){var c=_.filter(b.selected,function(b){return!_.some(a.datasources,{id:b.id})});a.datasources=a.datasources.concat(c.map(function(a){return{id:a.id,name:a.name,action:1}}))})},a.clearDatasources=function(){a.datasources=[]},a.charts=[],a.addChart=function(b){n.select(b,{type:["charts"]}).then(function(b){var c=_.filter(b.selected,function(b){return!_.some(a.charts,{id:b.id})});a.charts=a.charts.concat(c.map(function(a){return{id:a.id,name:a.name,action:1}}))})},a.clearCharts=function(){a.charts=[]},a.datasourceActionAll=1,a.chartActionAll=1,a.actionAll=function(b,c){var d="datasource"==b?a.datasources:a.charts;"datasource"==b?a.datasourceActionAll:a.chartActionAll;_.forEach(d,function(a){a.action=+c})},t&&b.get(app.urlPrefix+"api/roles/get?id="+s).then(function(b){a.model=b.data,p()},o),a.saveProgress=!1,a.save=function(){return a.error=null,a.testResult=null,a.roleForm.$valid?(a.model.DatasourceActions=a.datasources.map(function(a){return a.action+"-"+a.id}),a.model.ChartActions=a.charts.map(function(a){return a.action+"-"+a.id}),a.model.Users=_.filter(a.users,{check:!0}).map(function(a){return a.id}),a.model.forms=a.forms?a.forms.map(function(a){return{id:a.id,action:a.action,recordPermission:a.recordPermission}}):[],a.model.MenuActions=[],_.forEach(a.menus,function(b){var c=_.filter(b,{check:!0});_.forEach(c,function(b){a.model.MenuActions.push(b.action+"-"+b.id)})}),a.model.MenuCategoryActions=[],_.forEach(a.menuCategoriesAction,function(b,c){+b&&a.model.MenuCategoryActions.push(b+"-"+c)}),a.model.FunctionalActions=[],_.forEach(a.actions,function(b){var c=_.filter(b.childes,{check:!0});_.forEach(c,function(b){a.model.FunctionalActions.push(b.id)})}),a.saveProgress=!0,void b.post(app.urlPrefix+"api/roles/edit",a.model).then(function(b){a.saveProgress=!1,k.reset(),i(["new_role_created","edit_complete"]).then(function(a){var b=c.simple().textContent(t?a.edit_complete:a.new_role_created);c.show(b)}),f.path("/roles")},function(b){a.saveProgress=!1,a.error=j.trustAsHtml("<b>"+b.data.title+"</b> <br/>"+b.data.desc)})):(a.roleForm.$setSubmitted(),void i("form_invalid").then(function(a){q(a)}))},a.checkAll=function(a){_.forEach(a.childes,function(b){b.check=a.checkAll})},a.addFormSettings={},a.onFormSelect=function(b,c){a.forms=a.forms||[],_.each(b,function(b){_.some(a.forms,{id:b.id})||a.forms.push({id:b.id,name:b.name,action:1})}),h(function(){c.visible=!1},0)}}]),ngApp.directive("formPremission",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel"},controller:["$scope","$http","formsService",function(a,b,c){}],template:'<div class="ui mini input">                        <sm-dropdown model="model" class="multiple selection" items="[                                                            {k:\'رکورد جدید \', v:5},                                                            {k:\'ویرایش رکورد\', v:6},                                                            {k:\'حذف رکورد\', v:7},                                                          ]" label="item.k" value="item.v" default-text="asdasd"></sm-dropdwon>                    </div>',link:function(a,b,c){}}});var ngApp=angular.module("management");ngApp.controller("rolesListCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$translate","utils","roles","toolbar",function(a,b,c,d,e,f,g,h,i,j,k,l){a.utils=j,i("لیست نقش‌ها").then(function(a){l.setTitles([{name:a,click:function(){f.path("/roles")}}])}),a.progress=!0,k.get().then(function(b){a.progress=!1,a.data=b.data.list}),a.isSelected=function(){return _.some(a.data,{select:!0})},a["new"]=function(a){f.path("roles/edit")},a["delete"]=function(e){var f=app.urlPrefix+"api/roles/delete",g=_.filter(a.data,{select:!0}).map(function(a){return a.id}),h=d.confirm().title("حذف برای همیشه؟").textContent(g.length+" مورد برای حذف انتخاب شده است").ariaLabel("حذف").targetEvent(e).ok("حذف!").cancel("لغو");d.show(h).then(function(){b.post(f,g).then(function(b){a.data=_.filter(a.data,function(a){return-1==b.data.indexOf(a.id)});var d=c.simple().textContent("حذف انجام شد");c.show(d)},function(a){j.showErrorToast(a.data.desc)})})},a["goto"]=function(a,b){f.path("roles/edit/"+a.id)};var m;a.$watch("search",function(){h.cancel(m),m=h(function(){"undefined"!=typeof a.search&&(a.progress=!0,b.get(app.urlPrefix+"api/roles/get?query="+a.search).then(function(b){a.progress=!1,a.data=b.data.list}))},400)}),a.selectAll=function(){a.data&&_.forEach(a.data,function(b){b.select=a.selectAllCheckbox})}}]);var ngApp=angular.module("management");ngApp.controller("settingsCtrl",["$scope","$http","$sce","$timeout","$mdToast",function(a,b,c,d,e){a.saveProgress=!1,a.langs=[{key:0,value:"فارسی"},{key:1,value:"English"}],a.save=function(d){a.saveProgress=!0,b.post(app.urlPrefix+"Moderation/Settings/GeneralSettings",JSON.stringify({Brand:a.brand,Language:a.language}),{headers:{"Content-Type":"application/json; charset=utf-8"}}).success(function(b){if(a.saveProgress=!1,b.result){var d=e.simple().textContent("تغییرات ثبت شد");e.show(d)}else a.error=c.trustAsHtml(b.error)})},b.get(app.urlPrefix+"api/settings/getGeneralInfo").then(function(b){var c=b.data.model;c&&(a.brand=c.Brand,a.language=c.Language)})}]);var ngApp=angular.module("management");ngApp.controller("updateCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$translate","utils","datasources",function(a,b,c,d,e,f,g,h,i,j,k){a.progress=!0,b.get(app.urlPrefix+"api/users/get").then(function(b){a.progress=!1,a.data=b.data},j.error),j.onError(function(b){a.error=b,a.progress=!1}),a.isSelected=function(){return _.some(a.data,{select:!0})},a["new"]=function(a){f.path("users/edit")},a["delete"]=function(e){var f=app.urlPrefix+"api/users/delete",g=_.filter(a.data,{select:!0}).map(function(a){return a.id}),h=d.confirm().title("حذف برای همیشه؟").textContent(g.length+" مورد برای حذف انتخاب شده است").ariaLabel("حذف").targetEvent(e).ok("حذف!").cancel("لغو");d.show(h).then(function(){b.post(f,g).then(function(b){a.data=_.filter(a.data,function(a){return-1==b.data.indexOf(a.id)});var d=c.simple().textContent("حذف انجام شد");c.show(d)},function(a){j.showErrorToast(a.data.desc)})})},a["goto"]=function(a,b){f.path("users/edit/"+a.id)};var l;a.$watch("search",function(){h.cancel(l),l=h(function(){"undefined"!=typeof a.search&&(a.progress=!0,b.get(app.urlPrefix+"api/users/get?query="+a.search).then(function(b){a.progress=!1,a.data=b.data}))},400)}),a.selectAll=function(){a.data&&_.forEach(a.data,function(b){b.select=a.selectAllCheckbox})}}]);var ngApp=angular.module("management");ngApp.controller("userEditCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$translate","$sce","roles",function(a,b,c,d,e,f,g,h,i,j,k){function l(b){a.error=j.trustAsHtml("<b>"+b.data.title+"</b> <br/>"+b.data.desc)}function m(){a.model&&a.roles&&_.forEach(a.roles,function(b){-1!=a.model.Roles.indexOf(b.id)&&(b.check=!0)})}function n(a){c.show({template:'<md-toast class="md-toast error"> <span class="md-toast-text" flex>'+a+"</span></md-toast>",hideDelay:3e3,position:"bottom left"})}var o="undefined"!=typeof e.id?e.id:0,p=o>0;a.id=o,a.isEdit=p,a.app=app,k.get().then(function(b){a.roles=angular.merge({},b.data.list),_.forEach(a.roles,function(a){a.action=1,a.check=!1}),m()}),a.props=[],p&&b.get(app.urlPrefix+"api/users/get?id="+o).then(function(b){a.model=b.data,a.model.Properties&&(a.props=JSON.parse(a.model.Properties)),m()},l),b.get(app.urlPrefix+"api/users/getPropertyAutoCompleteEntries").then(function(b){a.auto=b.data,a.auto.flatValues=[],_.each(a.auto.values,function(b){_.each(b.values,function(b){-1==a.auto.flatValues.indexOf(b)&&a.auto.flatValues.push(b)})})},l),a.saveProgress=!1,a.save=function(){return a.error=null,a.testResult=null,a.userForm.$valid?(a.model.Roles=_.filter(a.roles,{check:!0}).map(function(a){return a.id}),a.model.Properties=JSON.stringify(_.map(a.props,function(a){return{Key:a.Key,Value:a.Value}})),a.saveProgress=!0,void b.post(app.urlPrefix+"api/users/edit",a.model).then(function(b){a.saveProgress=!1;var d=c.simple().textContent(p?"تغییرات ثبت شد":"منبع داده جدید ایجاد شد");c.show(d),f.path("/users")},function(b){a.saveProgress=!1,a.error=j.trustAsHtml("<b>"+b.data.title+"</b> <br/>"+b.data.desc)})):void i("form_invalid").then(function(a){n(a)})},$("#user-expire-time").datepicker({changeMonth:!0,changeYear:!0,dateFormat:"yy/mm/dd",onClose:function(a,b){}})}]);var ngApp=angular.module("management");ngApp.controller("usersListCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$translate","utils","datasources","toolbar",function(a,b,c,d,e,f,g,h,i,j,k,l){a.utils=j,i("لیست کاربران").then(function(a){l.setTitles([{name:a,click:null}])}),a.progress=!0,b.get(app.urlPrefix+"api/users/get").then(function(b){a.progress=!1,a.data=b.data},j.error),j.onError(function(b){a.error=b,a.progress=!1}),a.isSelected=function(){return _.some(a.data,{select:!0})},a["new"]=function(a){f.path("users/edit")},a["delete"]=function(e){var f=app.urlPrefix+"api/users/delete",g=_.filter(a.data,{select:!0}).map(function(a){return a.id}),h=d.confirm().title("حذف برای همیشه؟").textContent(g.length+" مورد برای حذف انتخاب شده است").ariaLabel("حذف").targetEvent(e).ok("حذف!").cancel("لغو");d.show(h).then(function(){b.post(f,g).then(function(b){a.data=_.filter(a.data,function(a){return-1==b.data.indexOf(a.id)});var d=c.simple().textContent("حذف انجام شد");c.show(d)},function(a){j.showErrorToast(a.data.desc)})})},a["goto"]=function(a,b){f.path("users/edit/"+a.id)};var m;a.$watch("search",function(){h.cancel(m),m=h(function(){"undefined"!=typeof a.search&&(a.progress=!0,b.get(app.urlPrefix+"api/users/get?query="+a.search).then(function(b){a.progress=!1,a.data=b.data}))},400)}),a.selectAll=function(){a.data&&_.forEach(a.data,function(b){b.select=a.selectAllCheckbox})}}]);var ngApp=angular.module("management");ngApp.controller("variablesCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$translate","utils","datasources","$mdMedia","toolbar",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(a){return a.DefaultValue=JSON.parse(a.DefaultValue),a.DefaultValue&&(a.DefaultValue=a.DefaultValue.map(function(a){return a.replace(/\[(index|calc)-\d+\]/gim,"")})),a}function o(a,b){return d.show({controller:["$scope","$mdDialog","$timeout",function(a,c,d){a.cancel=function(){c.cancel()},a.select=function(){return a.gbForm.$valid?void c.hide(a.model):void a.gbForm.$setSubmitted()},a.model={Name:"",Scope:0,DefaultValue:[]},b&&(a.model=angular.merge({},b))}],parent:angular.element(document.body),targetEvent:a,clickOutsideToClose:!0,fullscreen:l("sm")||l("xs"),template:'<md-dialog aria-label="{{\'choose\' | translate}}" ng-cloak >                                                                               <md-toolbar md-theme="default">                                                                                                                            <div class ="md-toolbar-tools">                                                                                                         <h2>{{\'choose\' | translate}}</h2>                                                                                                 <span flex></span>                                                                                                                  <span class ="material-icons" ng-click="cancel()">close</span>                                                                  </div>                                                                                                                          </md-toolbar>                                                                                                                       <md-dialog-content>                                                                                                                     <div class ="md-dialog-content" flex>                                                                                               <form name="gbForm">                                                                                                                   <div layout="row" layout-align="start center">                                                                                           <md-input-container flex="50" >                                                                                                         <label>{{\'name\' | translate}}</label>                                                                                             <input required name="name" ng-model="model.Name" md-autofocus>                                                                     <div ng-messages="gbForm.name.$error" ng-if=\'gbForm.$submitted || gbForm.name.$touched\'>                                            <div ng-message="required">{{\'form_username_required\' | translate}}</div>                                                       </div>                                                                                                                          </md-input-container>                                                                                                               <md-input-container flex="50">                                                                                                          <label>{{\'scope\' | translate}}</label>                                                                                            <md-select  ng-model="model.Scope">                                                                                                     <md-option value="0">{{\'scope_all_page\' | translate}}</md-option>                                                                 <md-option value="1">{{\'scope_current_page\' | translate}}</md-option>                                                         </md-select>                                                                                                                    </md-input-container>                                                                                                       </form>                                                                                                                             </div>                                                                                                                                                                                                                                                                     <md-chips flex ng-model="model.DefaultValue"                                                                                             ng-click=" $event.stopPropagation()"                                                                                                ng-change="row"                                                                                                                     placeholder="{{\'insert_user_prop_value\' | translate}}"                                                                            delete-button-label="{{\'delete_user_prop_value\' | translate}}"                                                                    delete-hint="{{\'press_delete_user_prop_value\' | translate}}"                                                                      secondary-placeholder="{{\'add_user_prop_value\' | translate}}"></md-chips>                                                                                                                                                                                     </div>                                                                                                                          </md-dialog-content>                                                                                                                <md-dialog-actions layout="row">                                                                                                        <md-button ng-click="select()" >                                                                                                        {{\'choose\' | translate}}                                                                                                      </md-button>                                                                                                                        <md-button ng-click="cancel()">                                                                                                         {{\'cancel\' | translate}}                                                                                                      </md-button>                                                                                                                    </md-dialog-actions>                                                                                                        </md-dialog>'
})}a.utils=j,i("متغیرهای سراسری").then(function(a){m.setTitles([{name:a,click:null}])}),a.progress=!0,b.get(app.urlPrefix+"moderation/globalvariable/getlist").then(function(b){a.progress=!1,a.data=b.data,a.data=a.data.map(function(a){return n(a)})},j.error),j.onError(function(b){a.error=b,a.progress=!1}),a.isSelected=function(){return _.some(a.data,{select:!0})},a["new"]=function(d){o(d).then(function(d){b.post(app.urlPrefix+"moderation/globalvariable/add",d).then(function(b){a.data=a.data||[],a.data.push(n(b.data)),i("new_variable_created").then(function(a){var b=c.simple().textContent(a);c.show(b)})})})},a["delete"]=function(e){var f=app.urlPrefix+"moderation/globalvariable/deleteAll",g=_.filter(a.data,{select:!0}).map(function(a){return a.Id}),h=d.confirm().title("حذف برای همیشه؟").textContent(g.length+" مورد برای حذف انتخاب شده است").ariaLabel("حذف").targetEvent(e).ok("حذف!").cancel("لغو");d.show(h).then(function(){b.post(f,g).then(function(b){a.data=_.filter(a.data,function(a){return-1==b.data.indexOf(a.Id)}),i("delete_complete").then(function(a){var b=c.simple().textContent(a);c.show(b)})},function(a){j.showErrorToast(a.data.desc)})})},a["goto"]=function(a,d){o(d,a).then(function(d){b.post(app.urlPrefix+"moderation/globalvariable/add",d).then(function(b){a.DefaultValue=n(b.data).DefaultValue,i("edit_complete").then(function(a){var b=c.simple().textContent(a);c.show(b)})})})};var p;a.$watch("search",function(){h.cancel(p),p=h(function(){"undefined"!=typeof a.search&&(a.progress=!0,b.get(app.urlPrefix+"api/users/get?query="+a.search).then(function(b){a.progress=!1,a.data=b.data}))},400)}),a.selectAll=function(){a.data&&_.forEach(a.data,function(b){b.select=a.selectAllCheckbox})}}]),function(){function a(a,b){var c=1,d=b.map(function(a){return a.toLowerCase()});if(-1==d.indexOf(a.toLowerCase()))return a;for(;-1!=d.indexOf(a.toLowerCase()+c);)c++;return a+c}function b(a,b){return a.filter(function(a){return!a.type||"kpi"!=a.type&&"measure"!=a.type}).map(function(a){return{Name:a.Name,UniqueName:a.UniqueName,Top:a.Top,sortOrder:a.sortOrder,sortKey:a.sortKey,sortFormula:a.sortFormula,formula:a.formula,aggregation:a.aggregation,Members:a.members&&a.members.list?a.members.list.filter(function(a){return a.Checked}).map(function(a){return b?a.UniqueName:a.Name}):[],UserProperties:a.userProperty?a.userProperty.filter(function(a){return a.Checked}).map(function(a){return a.Name}):[],GlobalViariable:a.globalVariable?a.globalVariable.filter(function(a){return a.Checked}).map(function(a){return a.Id}):[],NumericFilter:a.members?JSON.stringify(a.members.numericFilter):"",IsNumeric:a.members?a.members.isNumeric:!1}})}function c(a,b){for(var c in a)try{var d=a[c].series;if("undefined"==typeof d||!d||!a.hasOwnProperty(c))continue;if(c!=j[b]){delete a[c];continue}for(var e in d)d.hasOwnProperty(e)&&-1==a.series.indexOf(e)&&delete d[e]}catch(f){}}function d(a,b,c,d,e){_.isUndefined(a.tree)||_.remove(a.tree.dimensions,function(a){return _.isUndefined(_.find(c,{Name:a.name}))});var f=j[+b];return a[f]||(a[f]=i[f]),a[f]}function e(b,c,d,e){var f="SUM("+b.UniqueName+")",g="SUM";if(!b.IsNumeric&&(f=""+b.UniqueName,g="NONE",!e.measures.length))var f="COUNT("+b.UniqueName+")",g="COUNT";b.Top={IsTop:!1,Top:10,IsPercent:!1,TopOrder:"DESC"};var h=$.extend({},b,{formula:f,aggregation:g});return-1==d.info.aggregation&&(h.formula=b.UniqueName,h.aggregation="NONE"),h.Name=a(b.Name,c.map(function(a){return a.Name})),h}function f(b,c){var d=$.extend({},b,{sortOrder:"ASC",sortKey:"NONE",sortFormula:b.UniqueName,formula:b.UniqueName});return d.Name=a(b.Name,c.map(function(a){return a.Name})),d}function g(b,c){var d=$.extend({},b,{sortOrder:"ASC",sortKey:"NONE",formula:b.UniqueName});return d.Name=a(b.Name,c.map(function(a){return a.Name})),d}function h(a){var b=a.chartType,c=a.chartProp[j[+b]];switch(+b){case chartTypes.UserControl:return"datepicker"==c.info.type||"datepicker-range"==c.info.type||"text"==c.info.type?{needDim:!0,needMeasure:!1,needServerData:!1}:{needDim:!0,needMeasure:!1,needServerData:!0};case chartTypes.Tree:return{needDim:!0,needMeasure:!1,needServerData:!0};case chartTypes.TABLE:return-1==+c.info.aggregation?{needDim:!0,needMeasure:!1,needServerData:!0}:{needDim:!0,needMeasure:!0,needServerData:!0};default:return{needDim:!0,needMeasure:!0,needServerData:!0}}}var i={bar:{info:{aggregation:"1",canExportXlsx:!0,refreshPeriod:"0",horizontalLines:!0,sortMeasures:!1,showSortBox:!0,formatString:",.0f",stackedBar:"1",stackedLine:"1",tooltip:"2",tooltipHeader:"{{set.key}}",tooltipFormat:'{{point.label}}: <span class="ltr inline" style="padding:0; margin:0;"><b>{{point.data}}</b></span>',xAxisLen:20,font:{bold:!1,color:"#333333",italic:!1,fontSize:"12px",fontName:"IRANSans",formatString:",.0f",formatStringCustom:",.0f"}}},map:{info:{aggregation:"1",canExportXlsx:!0,refreshPeriod:"0",borderColor:"#666666",tooltip:"3",tooltipFormat:'{{point.label}}: <span class="ltr inline" style="padding:0; margin:0;"><b>{{point.data}}</b></span>',tooltipHeader:"{{set.key}}",map:{selectedMap:"1"},showLegend:!0}},pie:{info:{aggregation:"1",canExportXlsx:!0,tooltip:"3",hole:"50",refreshPeriod:"0",formatString:",.0f",colorType:1,tooltipHeader:"{{set.key}}",tooltipFormat:"{{point.label}}: {{point.data}} :: {{point.percentage}}%"}},tree:{info:{selectable:"one",aggregation:"1",canExportXlsx:!0,tooltip:"3",refreshPeriod:"0",formatString:",.0f",tooltipHeader:"{{set.key}}",tooltipFormat:"{{point.label}}: {{point.data}} :: {{point.percentage}}%"}},gauge:{info:{font:{bold:!0,color:"#333333",italic:!1,fontSize:"34px",fontName:"IRANSans",formatString:",.0f",formatStringCustom:",.0f"},aggregation:"1",canExportXlsx:!0,textBold:!0,textItalic:!1,refreshPeriod:"0",segmentType:"singleSegment",style:"arc",height:"medium",formatString:",.2f",fontSize:"3em",color:"#333333",colorAriaThree:"#e14d57",colorAriaTwo:"#FBEE58",colorAriaOne:"#71b37c"}},radar:{info:{aggregation:"1",canExportXlsx:!0,refreshPeriod:"0",formatString:",.0f"}},table:{info:{aggregation:"1",canExportXlsx:!0,refreshPeriod:"0",sortMeasures:!1,condensed:!1,bordered:!1,stripped:!0,hover:!0,showHeader:!0,showRowNumber:!1,rowAsKey:!1,selectable:"multi"}},userControl:{info:{aggregation:"1",canExportXlsx:!1,showFilterIcon:"0",type:"combo",comboStyle:"bootstrap",label:"",sliderRange:"min-max",dateFormatShow:"yy/mm/dd",dateOp:"eq",sliderFormat:",.0f",variableId:"-1",variableDefaultFunction:"NONE",functionDateFormat:"yy/mm/dd",functionUnitAgo:1,functionUnitAgoTwo:0,functionUnitAgoOffset:1,functionUnitAgoTwoOffset:1,dateFormatValue:"yy/mm/dd",textOperand:"or"}},text:{info:{aggregation:"1",canExportXlsx:!1,formatString:",.0f",refreshPeriod:"0",showFilterIcon:"0",html:""}}},j={1:"bar",2:"pie",4:"gauge",8:"radar",5:"table",6:"map",7:"userControl",9:"tree",10:"text"},k=angular.module("management");k.directive("draggableItems",["$timeout",function(a){return function(a,b,c){function h(){$("#columnList .datasource-field").draggable({appendTo:".chart-editor",helper:"clone",start:function(a,b){$(b.helper).addClass("ui-helper"),$(b.helper).width($(a.currentTarget).width())}}),$("#divX, #divY, #divProv").droppable({activeClass:"ui-state-default",hoverClass:"ui-state-hover",accept:":not(.ui-sortable-helper)",drop:function(b,c){var h=$(this).attr("id");if(a.$parent.isOlap){var i=c.draggable.attr("type"),j=null;if("measure"==i||"kpi"==i){if("divY"!=h)return;j="measure"==i?a.$parent.olapCubes[+a.$parent.selectedOlapCube||0].Measures[+c.draggable.attr("index")]:a.$parent.olapCubes[+a.$parent.selectedOlapCube||0].Kpis[+c.draggable.attr("index")],j.type=i,a.$apply(function(){var b="divX"==h?a.dimensions:"divY"==h?a.measures:a.where;b.push($.extend({},j))})}if("dimension"==i){var k=c.draggable.attr("group-name");j=a.$parent.olapCubes[+a.$parent.selectedOlapCube||0].Dimensions[+c.draggable.attr("DimIndex")].group[k][+c.draggable.attr("index")],j.type="dimension";var l="divX"==h?a.dimensions:"divY"==h?a.measures:a.where;a.$apply(function(){l.push($.extend({},j))})}a.$parent.$parent.$parent.$parent.$parent.$parent.$parent.refreshChart()}else a.$apply(function(){var b=d(a.$parent.chartProp,a.$parent.chartType),i=a.dimensions.concat(a.measures).concat(a.where),j="divX"==h?a.dimensions:"divY"==h?a.measures:a.where,k="divX"==h?f:"divY"==h?e:g;j.push($.extend({},k(a.datasource.CubeInfo.Dimensions[+c.draggable.attr("DimIndex")].Hierarchies[+c.draggable.attr("index")],i,b,a)))}),a.$parent.$parent.refreshChart()}})}a.$last&&h()}}]),k.controller("chartsEditorCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$translate","utils","$compile","$mdSidenav","$mdMedia","menus","datasources","roles",function(a,e,f,g,k,l,m,n,o,p,q,r,s,t,u,v){function w(){return"combo-kpi"==a.type}function x(){a.rolePermissions&&a.roles&&(a.rolePermissionLoaded=!0,_.forEach(a.roles,function(b){var c=_.find(a.rolePermissions,{roleId:b.id});c&&(b.action=1==c.actionSum?1:3==c.actionSum?2:4,b.check=!0)}))}function y(){a.menusSelected&&a.menus&&_.forEach(a.menus,function(b){_.forEach(b,function(b){-1!=a.menusSelected.indexOf(b.id)&&(b.check=!0)})})}function z(){if("undefined"!=typeof Storage){var a=localStorage.getItem("returnUrl");if(localStorage.removeItem("returnUrl"),!_.isUndefined(a)&&!_.isEmpty(a))return void(window.location.href=a)}window.history.length<=2?l.path("charts"):window.history.back()}function A(){var b=345;$("#tdChart").css("height",$(window).height()-b+"px").css("overfolw","auto"),$("#menu").css("height",$(".panel-body.chart-design").height()+"px").css("overfolw","auto"),$("#chrt-prop").css("height",$(".panel-body.chart-design").height()+"px").css("overfolw","auto"),"combo-kpi"==a.type&&$("#tdChart").css("height",$(window).height()-b+140+"px").css("overfolw","auto")}a.app=app;var B="undefined"!=typeof k.packageId?k.packageId:0,C="undefined"!=typeof k.id?k.id:0,D=(k.type,C>0);a.isEdit=D,a.id=C;var E,F,G=C,H=app.urlPrefix+"moderation/olapchartdesign/SaveChart",I=D;a.olapData={measures:[],kpis:[]},a.dimensions=[],a.measures=[],a.where=[],a.chartDimensions=[],a.chartMeasures=[],a.chartType=1,a.chartProp=$.extend({},i),a.relatedDatasource=[],a.filterException={},a.calculatedFields={},a.selectedTab=0,a.showRelatedDatasource=function(b){g.show({controller:["$scope","$mdDialog",function(b,c){b.$scope=a,a.relatedDatasourceList||e.get(app.urlPrefix+"Moderation/OlapChartDesign/GetRelatedDatasource?DataSourceId="+E).success(function(b){a.relatedDatasourceList=b.filter(function(b){return-1==a.datasource.CubeInfo.Dimensions.map(function(a){return+a.UniqueName}).indexOf(+b.Id)})}),b.cancel=function(){c.cancel()}}],templateUrl:"chart-editor/related-datasource.html",parent:angular.element(document.body),targetEvent:b,clickOutsideToClose:!0,fullscreen:s("sm")||s("xs")})},a.removeRelatedDatasource=function(b,c){a.relatedDatasource.splice(a.relatedDatasource.indexOf(+c.UniqueName),1);var d=a.datasource.CubeInfo.Dimensions.splice(b,1);d[0].Hierarchies.forEach(function(b){function c(a){var c=a.map(function(a){return a.UniqueName}).indexOf(b.UniqueName);-1!=c&&a.splice(c,1)}c(a.dimensions),c(a.measures),c(a.where)}),a.refreshChart()},a.addRelatedDatasource=function(b){e.get(app.urlPrefix+"Moderation/OlapChartDesign/GetDatasourceDimension?DataSourceId="+b).then(function(c){a.finishedJob++,a.finishedJob==a.maxJob&&a.$broadcast("finishJobs"),a.datasource.CubeInfo.Dimensions.push(c.data),-1==a.relatedDatasource.indexOf(b)&&a.relatedDatasource.push(b)},function(){-1!=a.relatedDatasource.indexOf(b)&&a.relatedDatasource.splice(a.relatedDatasource.indexOf(b),1),a.finishedJob++,a.finishedJob==a.maxJob&&a.$broadcast("finishJobs"),a.refreshChart()})},a.filterRelatedDatasource=function(b){return-1==a.relatedDatasource.indexOf(+b.Id)},a.menu={name:"salam"},a.$watch("chartType",function(b,c){function d(){return angular.element("#divProp div")?(angular.element("#divProp div").remove(),angular.element("#divProp").append(e),q(angular.element("#divProp"))(a),void console.log("whatch chart type =======")):void n(d,100)}var e={};switch(a.cntrName="chartsEditorCtrl",+b){case 1:e='<div ng-chart-properties open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="bar" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>';break;case 2:e='<div ng-chart-properties open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="pie" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>';break;case 4:e='<div ng-chart-properties open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="gauge" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>';break;case 5:e='<div ng-chart-properties open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="table" dimensions="dimensions" measures="measures" where="where" datasource="datasource"  filter-exception="filterException" calculated-fields="calculatedFields"></div>';break;case 6:e='<div ng-chart-properties open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="map" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>';break;case 7:e='<div ng-chart-properties open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="userControl" dimensions="dimensions" measures="measures" where="where" datasource="datasource"  filter-exception="filterException" calculated-fields="calculatedFields"></div>';break;case 8:e='<div ng-chart-properties open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="radar" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>';break;case 9:e='<div ng-chart-properties open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="tree" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>';break;case 10:e='<div ng-chart-properties open-menu-name="menu" ng-model="chartProp" is-olap="isOlap" data-type="text" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>';break;default:e='<div ng-chart-properties ng-model="chartProp" is-olap="isOlap" data-type="bar" dimensions="dimensions" measures="measures" where="where" datasource="datasource" filter-exception="filterException" calculated-fields="calculatedFields"></div>'}n(d,0)}),a.$watch("measures",function(b){a.tableInfo=null},!0),a.$watch("where",function(b){a.tableInfo=null},!0),a.gettingData=!0,a.collapseAll=function(b){_.each(a.olapCubes[+a.selectedOlapCube].Dimensions,function(a){a.expand=b}),a.measureExp=b,a.kpiExp=b},a.changeCube=function(){var b=a.olapCubes[a.selectedOlapCube];b.Dimensions||e.get(app.urlPrefix+"Moderation/OlapChartDesign/GetCubeInnerData?CubeName="+b.Name+"&DataSourceId="+E).success(function(b){a.olapCubes[a.selectedOlapCube]=b.CubeInfo,_.forEach(a.olapCubes[a.selectedOlapCube].Dimensions,function(a){a.group=_.groupBy(a.Hierarchies,"DisplayFolder")})})},a.gr=function(a,b,c){return _.groupBy(a,b)},a.getColumnList=function(){a.datasource||e.get(app.urlPrefix+"Moderation/OlapChartDesign/CubeInformation?DataSourceId="+E).success(function(b){a.gettingData=!1,a.isOlap=b.isOlap,a.datasource=b,b.isOlap&&(a.olapCubes=b.olapCubes,a.selectedOlapCube="0",_.forEach(a.olapCubes[0].Dimensions,function(a){a.group=_.groupBy(a.Hierarchies,"DisplayFolder")})),a.$broadcast("datasourceReady")})},a.gotoDatasource=function(a){var b={MsOlap:1,MSSQL:2,MySQL:3,File:4,WebResource:5,JoinDatasource:6},c=0;switch(a.DatasourceType){case b.MySQL:l.path("datasources/add/mssql/"+b.MySQL+"/"+c+"/"+a.UniqueName);break;case b.MsOlap:l.path("datasources/add/mssql/"+b.MsOlap+"/"+c+"/"+a.UniqueName);break;case b.MSSQL:l.path("datasources/add/mssql/"+b.MSSQL+"/"+c+"/"+a.UniqueName);break;case b.File:l.path("datasources/add/file/"+c+"/"+a.UniqueName);break;case b.WebResource:l.path("datasources/add/web/"+c+"/"+a.UniqueName);break;case b.JoinDatasource:l.path("datasources/add/join/"+c+"/"+a.UniqueName)}},a.gotoChart=function(a){l.path("charts/edit/0/"+a.Id)};var J=function(b){g.show({controller:["$scope","$mdDialog",function(b,c){b.parent=a,b.cancel=function(){c.cancel()},b.save=function(){b.parent.refreshChart(),c.cancel()}}],templateUrl:"editor/filterMember.html",parent:angular.element(document.body),targetEvent:b,clickOutsideToClose:!0,fullscreen:s("sm")||s("xs")})};a.filterMember=function(b,c,d){a.members=null,c||J();var f=b.members&&!b.members.list;!b.members||f?e.post(app.urlPrefix+"Moderation/OlapChartDesign/GetMember",JSON.stringify({CubeName:a.isOlap?a.olapCubes[+a.selectedOlapCube||0].Name:"",Uniquename:a.isOlap?b.UniqueName:b.formula,DataSourceId:E,calculatedFields:[]}),{headers:{"Content-Type":"application/json; charset=utf-8"}}).success(function(c){c.result&&(b.members={name:b.Name,isNumeric:c.isNumeric,list:c.data,numericFilter:{type:"condition",conditions:[{condition:"none",parameter:"0"},{condition:"none",parameter:""}],conditionType:"and",func:"aboveAvg"},aggregation:b.aggregation}),a.members=b.members,d&&d()}):a.members=b.members,b.userProperty=a.datasource.UsersProperty.map(function(a){var c={Name:a};return b.userProperty&&(c.Checked=_.some(b.userProperty,{Name:a,Checked:!0})),c}).slice(0),b.globalVariable=a.datasource.GlobalVariable.map(function(a){var c={Name:a.Name,Id:a.Id};return b.globalVariable&&(c.Checked=_.some(b.globalVariable,{Id:a.Id,Checked:!0})),c}).slice(0),a.globalVariable=b.globalVariable,a.userProperty=b.userProperty},a.checkAll=function(a,b){a&&a.forEach(function(a){a.Checked=b})},a.sortableOptions={stop:function(){n(function(){a.refreshChart()},0)},receive:function(a,b){$(a.target).attr("id"),$(b.sender).attr("id")}},a.refreshChart=function(c){app.chartCommons.drillDown.clearAll(),console.log("### $scope.refreshChart");var e=$.extend({needDim:!0,needMeasure:!0,needServerData:!0},h(a));if(a.chartRenderError=null,!w()&&e.needDim&&0==a.dimensions.length)return $("#divChart").empty(),void o("chart_editor_need_dimention").then(function(b){a.chartRenderError=b});if(!w()&&e.needMeasure&&0==a.measures.length)return $("#divChart").empty(),void o("chart_editor_need_measure").then(function(b){a.chartRenderError=b});if(w()&&!a.combo.selectedChart.length)return $("#divChart").empty(),void o("chart_editor_need_chart").then(function(b){a.chartRenderError=b});if(c&&!$("#divChart").data("isChart")&&(c=null),c&&$("#divChart").data("isChart")){var f=$("#divChart").data("settings");if("undefined"==typeof f.input)return;f.input.result||(c=null),w()||!e.needServerData||f.input.fields||(c="refreshWithData")}var g={Title:"",CubeName:a.isOlap?a.olapCubes[+a.selectedOlapCube||0].Name:"xxx",Description:"",Hierarchies:b(a.dimensions,a.isOlap),Where:b(a.where,a.isOlap),SeriesLevel:b(a.measures,a.isOlap),DataSourceId:E,Detail:JSON.stringify({chartProp:d(a.chartProp,a.chartType,a.dimensions,a.measures,a.where),needServerData:e.needServerData,tableInfo:a.tableInfo,relatedDatasource:a.relatedDatasource,filterException:a.filterException,calculatedFields:a.calculatedFields,dataType:a.type,combo:a.combo})};a.isOlap&&(g.Measurs=_.map(_.filter(a.measures,["type","measure"]),"UniqueName"),g.Kpis=_.map(_.filter(a.measures,["type","kpi"]),"UniqueName"));var i={ChartInfo:g,notEditMode:!1},j={chartProp:d(a.chartProp,a.chartType,a.dimensions,a.measures,a.where),parameters:i,editMode:!0,needServerData:e.needServerData,tableInfo:a.tableInfo,relatedDatasource:a.relatedDatasource,calculatedFields:a.calculatedFields,dataType:a.type,combo:a.combo};$("#divChart").data("chartInfo",g),app.chartCommons.drillDown.clear(-1),clearTimeout(a.lastRefreshTimeout),a.lastRefreshTimeout=setTimeout(function(){c?$("#divChart").charts(a.chartType,c,j):o("در حال بارگذاری...").then(function(b){$("#divChart").empty(),$("#divChart").append('<div><img style="width:18px; height:18px; display: inline-block;" src="'+app.urlPrefix+'Images/progress.gif"/>'+b+"</div>"),$("#divChart").height($("#chart-content").height()+"px"),$("#divChart").charts(a.chartType,j)})},400),$("#divChart").off("legendClick"),$("#divChart").on("legendClick",function(b,c,d,e){n(function(){a.menu.set("series"),a.chartProp.selectedSeries=e.key},20)})},a.gotoDimentionSettings=function(b,c){a.menu.set("dimension"),a.menu.selectedDimension=c+""},a.gotoMeasureSettings=function(b,c){a.menu.set("measure"),a.menu.selectedMeasure=c+""},a.gotoWhereSettings=function(b,c){a.menu.set("where"),a.menu.selectedwhere=c+""},$("#divChart").bind("tableInfo",null,function(b,c){n(function(){var b=a.tableInfo?a.tableInfo.Limit||10:10;a.tableInfo=c.TableInfo,a.tableInfo.Limit=b},0)}),$("#divChart").bind("chartproperty",null,function(b,c){d3.scale.category10();n(function(){a.chartProp.series=c},0)}),t.get().then(function(b){_.forEach(b.data,function(a){a.check=!1}),a.menus=_.groupBy(angular.merge([],b.data),"parent"),y()}),D&&(e.get(app.urlPrefix+"api/charts/GetChartMenus?id="+C).then(function(b){a.menusSelected=b.data,y()}),v.get().then(function(b){a.roles=angular.merge({},b.data.list),_.forEach(a.roles,function(a){a.action=1,a.check=!1}),x()}),e.get(app.urlPrefix+"api/permissions/getChartPermissions?id="+a.id).then(function(b){a.rolePermissions=b.data.list,x()})),a.showDialog=function(b){g.show({controller:["$scope","$mdDialog",function(b,c){b.parent=a,b.cancel=function(){c.cancel()},b.save=function(){D||b.parent.saveNewChart(),c.cancel()}}],templateUrl:"editor/save-chart.html",parent:angular.element(document.body),targetEvent:b,clickOutsideToClose:!0,fullscreen:s("sm")||s("xs")})},a.save=function(b){return I?void a.saveNewChart():void a.showDialog(b)},a.cancel=function(){z()},a["delete"]=function(b){var c=app.urlPrefix+"Moderation/Charts/DeleteCharts",d=g.confirm().title("حذف برای همیشه؟").textContent("آیا برای حذف نمودار "+a.chartName+" اطمینان دارید؟").ariaLabel("حذف").targetEvent(b).ok("حذف!").cancel("لغو");g.show(d).then(function(){e.post(c,["ChartId-"+a.id]).then(function(a){if(a.data.result){var b=f.simple().textContent("حذف انجام شد");f.show(b),2==window.history.length?l.path("charts"):window.history.back()}},function(){var a=f.simple().textContent("اشکال در حذف!");f.show(a)})})},a.saveNewChart=function(){if(!a.chartName)return o("form_name_required").then(function(a){p.showErrorToast(a)}),!1;var g=_.filter(a.roles,{check:!0}).map(function(a){return a.action+"-"+a.id}),i=[];_.forEach(a.menus,function(a){_.forEach(a,function(a){a.check&&i.push(a.id)})}),c(a.chartProp,a.chartType);var j=$.extend({needDim:!0,needMeasure:!0,needServerData:!0},h(a));a.combo&&!I&&(a.combo.title=$("#chartTitleFarsi").val());var k=d(a.chartProp,a.chartType,a.dimensions,a.measures,a.where),l={datasourceId:E,relatedDatasource:a.relatedDatasource,dimensions:a.dimensions,measures:a.measures,where:a.where,chartType:a.chartType,expandedChartType:a.expandedChartType,chartProp:k,needServerData:j.needServerData,tableInfo:a.tableInfo,filterException:a.filterException,calculatedFields:a.calculatedFields,dataType:a.type,combo:a.combo,isOlap:a.isOlap,selectedOlapCube:a.selectedOlapCube},m={id:G,editMode:I,xChartType:a.chartType,xTitleFarsi:a.chartName,chartUniquename:"",cubeName:a.isOlap?a.olapCubes[+a.selectedOlapCube||0].Name:"xxx",hierarchy:b(a.dimensions,a.isOlap),where:b(a.where,a.isOlap),seriesLevel:b(a.measures,a.isOlap),ChartActions:g,Menus:i,detail:JSON.stringify(l),DataSourceId:E,Desc:a.chartDesc,PackageId:B};return a.isOlap&&(m.measures=_.map(_.filter(a.measures,["type","measure"]),"UniqueName"),m.kpis=_.map(_.filter(a.measures,["type","kpi"]),"UniqueName")),e.post(H,JSON.stringify(m),{headers:{"Content-Type":"application/json; charset=utf-8"}}).success(function(a){o("chart_editor_save_success").then(function(a){f.show(f.simple().textContent(a))}),u.reset(),z()}),!0},a.restore=function(b){var c={datasourceId:-1,dimensions:[],relatedDatasource:[],measures:[],where:[],chartType:1,chartProp:{},tableInfo:null,filterException:{},calculatedFields:{},isOlap:!1},b=$.extend({},c,b);E=b.datasourceId,a.relatedDatasource=b.relatedDatasource,a.where=b.where;var d={};if(d[j[+b.chartType]]=b.chartProp,a.dimensions=b.dimensions,a.measures=b.measures,a.chartProp=_.extend({},i,d),a.chartType=b.chartType,a.expandedChartType=b.expandedChartType,a.tableInfo=b.tableInfo,a.filterException=b.filterException,a.calculatedFields=b.calculatedFields||{},a.maxJob=0,a.finishedJob=-1,a.isOlap=b.isOlap,a.selectedOlapCube=b.selectedOlapCube,a.isOlap&&0!=+b.selectedOlapCube&&a.changeCube(),a.type=b.dataType,a.combo=b.combo||{},a.combo.synonyms=a.combo.synonyms||[],a.combo.aggregation=a.combo.aggregation||0,a.maxJob=a.relatedDatasource?a.relatedDatasource.length:0,a.relatedDatasource.forEach(function(b){a.addRelatedDatasource(b)}),_.each(a.combo.selectedChart,function(b){e.get(app.urlPrefix+"api/charts/get?id="+b.Id).then(function(c){return c.data?void(_.first(a.combo.selectedChart,{Id:b.Id}).Name=c.data.Name):(_.remove(a.combo.selectedChart,{Id:b.Id}),void a.refreshChart())})}),_.isUndefined(a.expandedChartType)){var f=_.findKey(a.chartNameMap,_.find(a.chartNameMap,{type:+a.chartType}));a.expandedChartType=+f}a.refreshChart()},a.chagePivotFormula=function(b){a.measures&&(1==b?a.measures.forEach(function(a){var b="SUM("+a.UniqueName+")",c="SUM";a.IsNumeric||(b="COUNT("+a.UniqueName+")",c="COUNT"),a.formula=b,a.aggregation=c}):a.measures.forEach(function(a){a.formula=a.UniqueName,a.aggregation="NONE"}))},a.setType=function(b){a.type=b,"combo-kpi"!=b?a.getColumnList():a.$broadcast("datasourceReady"),A()},a.charts=[],a.getCharts=function(){e.get(app.urlPrefix+"api/charts/get").then(function(b){b.data.result?a.charts=b.data.list:a.charts=[]},function(){a.charts=[]})},a.showChartsDialog=function(){$("#charts-modal").modal("show"),a.charts&&a.charts.length||a.getCharts()},a.combo={combineType:0,aggregation:0,selectedChart:[],synonyms:[]},a.addChart=function(b){a.combo.selectedChart.push(b),a.refreshChart()},a.selectChart=function(b){u.select(b,["charts"]).then(function(b){"charts"==b.type&&(_.forEach(u.lastSelected.charts,function(b){a.combo.selectedChart.push({Id:b.id,Name:b.name})}),a.refreshChart())})},D?(a.selectedTab=1,e.get(app.urlPrefix+"api/charts/getEditor?id="+C).then(function(b){E=b.data.dataSourceId,F=b.data.type,a.chart=b.data.chart;var c=JSON.parse(b.data.chart.Detail);a.$on("datasourceReady",function(){a.restore(c)}),a.setType(F),a.chartName=a.chart.Name,a.chartDesc=a.chart.Description},function(a){a.data.desc&&alert(a.data.desc),2==window.history.length?l.path("charts"):window.history.back()})):(E=k.datasourceId,F=k.type,"combo-kpi"==F&&_.forEach(u.lastSelected.charts,function(b){a.combo.selectedChart.push({Id:b.id,Name:b.name})}),a.setType(F)),a.existIn=function(a,b){return _.some(b,{UniqueName:a.UniqueName})},a.expandedChartType=1;var K=1;a.changeChartType=function(b){K=a.expandedChartType,a.expandedChartType=b,a.chartType=a.chartNameMap[b].type,14==K&&14!=a.expandedChartType&&a.chagePivotFormula(1),14!=K&&14==a.expandedChartType&&a.chagePivotFormula(-1),app.chartCommons.expandedType=a.expandedChartType,app.chartCommons.changeSeriesPropertyBaseOnExpandedType(a.chartProp[j[+a.chartType]]),a.refreshChart()},a.chartNameMap={1:{name:"میله‌ای",type:1},2:{name:"میله‌ای - پشته",type:1},3:{name:"خطی",type:1},4:{name:"خطی - پشته",type:1},5:{name:"سطح",type:1},6:{name:"سطح - پشته",type:1},7:{name:"دایره‌ای",type:2},8:{name:"دونات",type:2},9:{name:"عقربه‌ای هلالی",type:4},10:{name:"رادار",type:8},11:{name:"نقشه",type:6},12:{name:"درختی",type:9},13:{name:"جدول - تجمیعی",type:5},14:{name:"جدول عادی",type:5},15:{name:"انتخاب تک مقداری",type:7},16:{name:"انتخاب چند مقداری",type:7},17:{name:"انتخاب تاریخ",type:7},18:{name:"انتخاب محدوده تاریخ",type:7},19:{name:"انتخاب محدوده عدد",type:7},20:{name:"جستجو",type:7},21:{name:"میله‌ای - پشته درصدی",type:1},22:{name:"خطی - پشته درصدی",type:1},23:{name:"سطح - پشته درصدی",type:1},24:{name:"عقربه‌ای هلالی - چند بخشی",type:4},25:{name:"عقربه‌ای خطی",type:4},26:{name:"عقربه‌ای خطی - چند بخشی",type:4}}}]),k.directive("ngChartProperties",function(){return{restrict:"AE",require:"^ngModel",scope:{ngModel:"=",dimensions:"=",measures:"=",where:"=",datasource:"=",type:"@",isOlap:"=",relatedDatasourceList:"=",calculatedFields:"=",filterException:"=",openMenuName:"="},templateUrl:function(a,b){switch(b.type){case"bar":return app.urlPrefix+"dist/partial/management/charts/directives/types/barLine.html?v="+app.version;case"map":return app.urlPrefix+"dist/partial/management/charts/directives/types/map.html?v="+app.version;case"pie":return app.urlPrefix+"dist/partial/management/charts/directives/types/pie.html?v="+app.version;case"gauge":return app.urlPrefix+"dist/partial/management/charts/directives/types/gauge.html?v="+app.version;case"radar":return app.urlPrefix+"dist/partial/management/charts/directives/types/radar.html?v="+app.version;case"table":return app.urlPrefix+"dist/partial/management/charts/directives/types/table.html?v="+app.version;case"userControl":return app.urlPrefix+"dist/partial/management/charts/directives/types/userControl.html?v="+app.version;case"tree":return app.urlPrefix+"dist/partial/management/charts/directives/types/tree.html?v="+app.version;case"text":return app.urlPrefix+"dist/partial/management/charts/directives/types/text.html?v="+app.version;default:return app.urlPrefix+"dist/partial/management/charts/directives/types/barLine.html?v="+app.version}},controller:["$scope","$timeout",function(a,b){a.cntrName="ngChartProperties",a.changeColor=function(b,c,d){$(b.target).colorSelector(c&&c[d]?c[d]:"#1f77b4",function(e){$(b.target).css("background-color",e),a.$apply(function(){c&&(c[d]=e),a.refreshChart("refresh"),a.changeAllSeries(d,e)})})},a.refreshChart=function(b){a.$parent.refreshChart(b)},a.chagePivotFormula=function(b){a.$parent.chagePivotFormula(b)},a.setTableInfoLimit=function(b,c){a.$parent.tableInfo=a.$parent.tableInfo||{},"undefined"!=typeof b&&null!=b&&(a.$parent.tableInfo.Limit=b),"undefined"!=typeof c&&(a.$parent.tableInfo.useDistinct=c)},a.$parent.dereg&&a.$parent.dereg(),a.$parent.dereg=a.$watch("dimensions",function(b,c){if("undefined"!=typeof b){a.ngModel.tree=a.ngModel.tree||{},a.ngModel.tree.dimensions=a.ngModel.tree.dimensions||[];for(var d=0;d<b.length;d++){var e=b[d],f=_.filter(a.ngModel.tree.dimensions,{name:e.Name}).length;f||a.ngModel.tree.dimensions.push({type:0==d?"id":1==d?"parent":2==d?"name":"type",name:e.Name})}a.tableInfo=null}},!0),a.changeAllSeries=function(b,c){if("{All}"==a.ngModel.selectedSeries){var d=a.ngModel[a.type].series;for(var e in d)d[e][b]=d["{All}"]?d["{All}"][b]:c}}}],link:function(){app.lang.setLang()}}}),k.directive("topMeasure",function(){return{restrict:"E",scope:{model:"=?ngModel",change:"&ngChange",dims:"=?dims"},link:function(a,b,c,d){},controller:["$scope",function(a){a.dims=a.dims||[],a.model&&(a.model.selectedDims=a.model.selectedDims||{})}],template:'                                                                                                                 <div class="form-row" layout="row" layout-align="start center" layout-wrap>                                                                 <md-switch ng-model="model.IsTop" ng-change="change()">                                                                         {{ \'isTop\' | translate }}                                                                                             </md-switch>                                                                                                            </div>                                                                                                                      <div ng-if="model.IsTop">                                                                                                       <div class="form-row" layout="row" layout-align="start center">                                                                 <label>{{ \'top\' | translate }}</label>                                                                                    <span class="form-divider" flex></span>                                                                                     <div>                                                                                                                           <md-switch ng-model="model.IsPercent" ng-change="change()" style="display:inline">                                              {{ \'IsPercent\' | translate }}                                                                                         </md-switch>                                                                                                                                                                                                                                            <input type="number" class="form-control" placeholder="{{ \'top\' | translate }}"                                                  ng-model-options="{ updateOn: \'blur\' }"                                                                                   ng-change="change()"                                                                                                        ng-model="model.Top" />                                                                                                                                                                                                                          <select class="selectpicker form-control"                                                                                           ng-model="model.TopOrder"                                                                                                   ng-change="change()">                                                                                                   <option value="DESC">{{\'نزولی\' | translate}}</option>                                                                     <option value="ASC">{{\'صعودی\' | translate}}</option>                                                                  </select>                                                                                                               </div>                                                                                                                  </div>                                                                                                                      <div class="form-row" layout="row" layout-align="start center">                                                                 <label>{{ \'Applied_to\' | translate }}</label>                                                                             <span class="form-divider" flex></span>                    <div>                                                                                                                           <md-checkbox ng-repeat="d in dims track by $index" ng-model="model.selectedDims[d.Name]" ng-change="change()">{{d.Name}}</md-checkbox>                       </div>                                                                                                                  </div>                                                                                                                  </div>                                                                                                                      '
}})}();var ngApp=angular.module("management");ngApp.controller("chartsListCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$translate","utils","datasources","toolbar",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(){return _.map(_.filter(a.data,{select:!0}),function(a){return 2==a.type?"ChartId-"+a.id:"PackageId-"+a.id})}function n(b){var c=_.lastIndexOf(a.data.map(function(a){return a.type}),1);-1==c?a.data=b.concat(a.data):Array.prototype.splice.apply(a.data,[c+1,0].concat(b))}function o(a){j.showErrorToast(a.data.desc)}function p(b){a.data=_.filter(a.data,function(a){var c=2==a.type?"ChartId-"+a.id:"PackageId-"+a.id;return-1==b.indexOf(c)})}a.utils=j;var q="undefined"!=typeof e.id?e.id:0;a.app=app;var r=q?"?packageId="+q:"";a.progress=!0,b.get(app.urlPrefix+"api/charts/getList"+r).then(function(b){a.progress=!1,a.data=b.data.list,i("لیست نمودارها").then(function(c){a.listTranslate=c,b.data.path.unshift({name:c,id:null}),a.path=b.data.path.map(function(b){return b.click=function(){a["goto"]({type:1,id:b.id})},b}),l.setTitles(a.path)})},o),j.onError(function(b){a.error=b,a.progress=!1}),i("لیست نمودارها").then(function(b){a.listTranslate=b});var s=function(){return _.some(a.data,{select:!0})};a.menuInvalidate=function(){var b=s(),c=_.filter(a.data,{select:!0,type:1}).length,d=_.filter(a.data,{select:!0,type:2}).length;a.canCopy=b,a.canDelete=b,a.canForward=b,a.canDirEdit=1==c&&0==d},a.copy=function(){var d=app.urlPrefix+"Moderation/Charts/CloneCharts",e=m();b.post(d,e).then(function(b){if(b.data.result){b.data.inserted&&(a.data=a.data.concat(b.data.inserted)),b.data.packages&&n(b.data.packages);var d=c.simple().textContent("کپی انجام شد");c.show(d)}},o)},a["delete"]=function(e){var f=app.urlPrefix+"Moderation/Charts/DeleteCharts",g=m(),h=d.confirm().title("حذف برای همیشه؟").textContent(g.length+" مورد برای حذف انتخاب شده است").ariaLabel("حذف").targetEvent(e).ok("حذف!").cancel("لغو");d.show(h).then(function(){b.post(f,g).then(function(b){if(b.data.result){b.data.deletedIds&&p(b.data.deletedIds);var d=c.simple().textContent("حذف انجام شد");c.show(d),a.menuInvalidate()}},o)})},a.forward=function(a){k.select(a,{type:["charts"],justDir:!0,selectableDir:!0,multipleChart:!1}).then(function(a){var d=a.selected[0];if(e.id==d.id){var f=c.simple().textContent("موارد انتخاب شده در همین پوشه هستند");return void c.show(f)}var g=m();b.post(app.urlPrefix+"Moderation/Charts/MoveToPackage",{Ids:g,packageId:d.id}).then(function(a){p(a.data.ids);var b=c.simple().textContent("انتقال انجام شد");c.show(b)},o)},o)},a.dirEdit=function(b){var d=m(),e=d[0].replace("PackageId-","");g.edit(b,2,e,function(b){_.find(a.data,{select:!0}).name=b.data.info.Name;var d=c.simple().textContent("نام پوشه تغییر کرد");c.show(d)},o)},a.newPackage=function(a){g.create(a,1,e.id,function(a){n([{id:a.data.info.Id,name:a.data.info.Name,type:1}]);var b=c.simple().textContent("پوشه جدید ایجاد شد");c.show(b),k.reset()})},a["goto"]=function(a,b){1==a.type?f.path("charts"+(a.id?"/"+a.id:"")):2==a.type&&f.path("charts/edit/"+q+"/"+a.id)},a.getTypeName=function(a){var b=1,c=2,d=3,e=5,f=6,g=7,h=8,i=9,j="";switch(+a){case b:j="Bar";break;case c:j="Pie";break;case d:j="Line";break;case e:j="Table";break;case f:j="Map";break;case g:j="User Control";break;case h:j="Radar";break;case i:j="Tree"}return j},a.getChartTypeImage=function(a){var b="",c={};switch(c.BAR=1,c.PIE=2,c.LINE=3,c.GAUGE=4,c.TABLE=5,c.MAP=6,c.USER_CONTROL=7,c.RADAR=8,c.TREE=9,+a){case c.BAR:b=app.urlPrefix+"Images/bar.png";break;case c.GAUGE:b=app.urlPrefix+"Images/guage.png";break;case c.PIE:b=app.urlPrefix+"Images/pie.png";break;case c.LINE:b=app.urlPrefix+"Images/line.png";break;case c.TABLE:b=app.urlPrefix+"Images/table.png";break;case c.MAP:b=app.urlPrefix+"Images/map.png";break;case c.USER_CONTROL:b=app.urlPrefix+"Images/combo_box.png";break;case c.RADAR:b=app.urlPrefix+"Images/radar_plot.png";break;case c.TREE:b=app.urlPrefix+"Images/tree.png"}return b};var t;a.$watch("search",function(){h.cancel(t),t=h(function(){"undefined"!=typeof a.search&&(a.progress=!0,b.get(app.urlPrefix+"api/charts/getList?q="+a.search).then(function(b){a.progress=!1,a.data=b.data.list,a.path=b.data.path,a.path.unshift({name:"لیست منابع داده",id:null})},o))},400)}),a.selectAll=function(){a.data&&_.forEach(a.data,function(b){b.select=a.selectAllCheckbox}),a.menuInvalidate()},a.newChart=function(a){k.select(a,{type:["charts","datasources"]}).then(function(a){"charts"==a.type?f.path("charts/new/combo-kpi/"+(e.id?e.id:"0")):f.path("charts/new/normal/"+(e.id?e.id:"0")+"/"+a.selected[0].id)})},a.sortDetail={},a.sort=function(b){a.sortDetail[b]=a.sortDetail[b]||{},a.sortDetail[b].isDesc=!a.sortDetail[b].isDesc;var c=_.filter(a.data,{type:1}),d=_.filter(a.data,{type:2});d=_.sortBy(d,[b]),c=_.sortBy(c,[b]),a.sortDetail[b].isDesc||(d=_.reverse(d),c=_.reverse(c)),a.data=c.concat(d)}}]),function(a){var b=angular.module("management");b.directive("alert",["$timeout","$http",function(b,c){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/alert.html?v="+app.version,scope:{model:"=prop",config:"="},controller:["$scope",function(d){d.name="ALERT_CONTROLLER",d.contactList=[{phone:"",email:""}],d.roleList=null,d.userList=null,d.schedule={occure:"daily",dailyRecurs:1,weeklyRecurs:1,weeklySat:!1,weeklySun:!1,weeklyMon:!1,weeklyTus:!1,weeklyWen:!1,weeklyThu:!1,weeklyFri:!1,monthlyDayOf:1,monthlyRecurs:1,dailyFrequency:"once",dailyFrequencyAtHour:"1200",dailyFrequencyRecur:1,dailyFrequencyRecurType:"hour",dailyFrequencyStart:"1200",dailyFrequencyStop:"2359"},d.newAlert=function(){d.model[d.config.name].alerts.push({type:"sms",rules:[],schedule:d.schedule,format:"[@{k} :: ][,][@{m}:@{n}]",selectedSeries:[]}),b(function(){app.lang.setLang()},0)},d.formatClock=function(a){var b=a+"";return b.substr(0,2)+":"+b.substr(2)},d.model[d.config.name]&&(d.model[d.config.name].alerts=a.extend([],d.model[d.config.name].alerts)),d.addContact=function(a){a.contactList||(a.contactList=[{email:"",phone:""}]),0==a.contactList.length&&(a.contactList=[{email:"",phone:""}]),d.contactList=a.contactList},d.addSchedule=function(a){a.schedule||(a.schedule={occure:"daily",dailyRecurs:1,weeklyRecurs:1,weeklySat:!1,weeklySun:!1,weeklyMon:!1,weeklyTus:!1,weeklyWen:!1,weeklyThu:!1,weeklyFri:!1,monthlyDayOf:1,monthlyRecurs:1,dailyFrequency:"once",dailyFrequencyAtHour:"1200",dailyFrequencyRecur:1,dailyFrequencyRecurType:"hour",dailyFrequencyStart:"1200",dailyFrequencyStop:"2359"}),d.schedule=a.schedule},d.addUser=function(a){function b(){a.userList&&0!=a.userList.length||(a.userList=d.serverUserList.map(function(a){return{name:a.name,id:a.id,username:a.username}})),d.userList=a.userList}d.serverUserList?b():c.get(app.urlPrefix+"Account/GetUsers").success(function(a){d.serverUserList=a.list,b()})},d.addRole=function(a){function b(){a.roleList&&0!=a.roleList.length||(a.roleList=d.serverRoleList.map(function(a){return{name:a.name,id:a.id}})),d.roleList=a.roleList}d.serverRoleList?b():c.get(app.urlPrefix+"Account/GetRoles").success(function(a){d.serverRoleList=a.list,b()})},d.changeItem=function(c,e){var f=a.extend({},c.rules[e]);app.indicator(d.model.series,f,function(a,d){b(function(){c.rules[e]=a},0)},[])},d.toggleSelectedSeries=function(a,b){a.selectedSeries||(a.selectedSeries=[]);var c=a.selectedSeries.indexOf(b);-1==c?a.selectedSeries.push(b):a.selectedSeries.splice(c,1)},d.persian=function(a){return persian(a)},d.mapOp={1:"برابر باشد با",2:"برابر نباشد با",3:"بزرگتر باشد از",4:"بزرگتر يا مساوي باشد از",5:"کوچکتر باشد از",6:"کوچکتر يا مساوي باشد از",7:"شامل",8:"نباشد شامل"}}],link:function(){app.lang.setLang()}}}])}(jQuery),function(a){var b=angular.module("management");b.filter("filterCalculateFields",function(){return function(a,b){for(var c=[],d=0;d<a.length;d++)b>d&&c.push(a[d]);return c}}),b.directive("calculateFields",function(){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/calculateField.html?v="+Math.random(),scope:{calculatedFields:"="},controller:["$scope","$mdDialog","$mdMedia",function(b,c,d){b.refreshChart=function(a){b.$parent.refreshChart(a)};var e=-1;b.add=function(a){e=-1,b.currentFormula={},b.showDialog(a)},b.edit=function(a,c){e=a,b.currentFormula={name:b.calculatedFields.fields[a].name,formula:b.calculatedFields.fields[a].formula},b.showDialog(c)},b.calculatedFields=b.calculatedFields||{},b.calculatedFields.fields=b.calculatedFields.fields||[],b.save=function(){if(!b.currentFormula.name)return alert("فیلد نام نمی تواند خالی باشد"),!1;var a=_.some(b.calculatedFields.fields,function(a){return a.name.trim()==b.currentFormula.name.trim()})||_.some(b.$parent.ngModel.series,function(a){return a.trim()==b.currentFormula.name.trim()});return!a||-1!=e&&b.calculatedFields.fields[e].name==b.currentFormula.name?(-1==e?b.calculatedFields.fields.push({name:b.currentFormula.name,formula:b.currentFormula.formula}):(b.calculatedFields.fields[e].name=b.currentFormula.name,b.calculatedFields.fields[e].formula=b.currentFormula.formula),!0):(alert("نام انتخابی تکراری است"),!1)},b.showDialog=function(e){c.show({controller:["$scope","$mdDialog",function(c,d){c.parent=b,c.cancel=function(){d.cancel()},c.save=function(){c.parent.save()&&(c.parent.refreshChart(),d.cancel())},c.addColumn=function(b,d){c.parent.currentFormula.formula||(c.parent.currentFormula.formula=""),c.parent.currentFormula.formula+=" {R+0, ["+b+"]} ",a(".formula-input").focus()}}],templateUrl:"editor/calc/calc-fields-modal.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0,fullscreen:d("sm")||d("xs")})}}],link:function(){app.lang.setLang()}}})}(jQuery),function(a){var b=angular.module("management");b.directive("dimMeasWhere",function(){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/dimMeasWhere.html?v="+app.version,scope:{dimensions:"=",measures:"=",where:"=",datasource:"=",model:"=?model"},controller:["$scope","$mdDialog","$mdMedia",function(a,b,c){a.model=a.model||{},a.model.selectedDimension=0,a.model.selectedMeasure=0,a.model.selectedwhere=0,a.changeFormula=function(a){a.members=null},a.refreshChart=function(b){a.$parent.refreshChart(b)},a.changeDimensionName=function(b,c){var d=c.Name,e=a.dimensions.concat(a.measures).concat(a.where).map(function(a){return a.Name})||[],f=e.filter(function(a){return a==d}).length>1;f?(c.Name=b,setTimeout(function(){alert("نام انتخاب شده تکراری است")},0)):a.refreshChart()},a.changeMeasureAggregation=function(b){var c=a.measures[+b].aggregation;"NONE"==c?a.measures[+b].formula=a.measures[+b].UniqueName:a.measures[+b].formula=c+"("+a.measures[+b].UniqueName+")",a.changeFormula(a.measures[+b])},a.showDialog=function(c,d){var e=c;b.show({controller:["$scope","$mdDialog",function(b,d){function f(a,c){a.renderer.setPadding(18),b.insertFormula=function(b){a.insert(b),a.focus()}}switch(b.parent=a,c){case"dimention":b.formula=a.dimensions[a.model.selectedDimension].formula;break;case"measure":b.formula=a.measures[a.model.selectedMeasure].formula;break;case"where":b.formula=a.where[a.model.selectedwhere].formula}b.aceOption={useWrapMode:!0,showGutter:!1,theme:"sqlserver",mode:"sqlserver",maxLines:14,onLoad:f,require:["ace/ext/beautify"]},b.cancel=function(){d.cancel()},b.save=function(){switch(e){case"dimention":a.dimensions[a.model.selectedDimension].formula=b.formula;break;case"measure":a.measures[a.model.selectedMeasure].formula=b.formula;break;case"where":a.where[a.model.selectedwhere].formula=b.formula}d.cancel()}}],templateUrl:"editor/formula/edit.html",parent:angular.element(document.body),targetEvent:d,clickOutsideToClose:!1,fullscreen:!0})}}],link:function(){app.lang.setLang()}}})}(jQuery),function(a){var b=angular.module("management");b.directive("filterExcept",function(){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/filterExcept.html?v="+app.version,scope:{datasource:"=",filterException:"="},controller:["$scope","$mdDialog","$mdMedia",function(a,b,c){a.refreshChart=function(b){a.$parent.refreshChart(b)},a.toggleAllToList=function(b){a.filterException.allFields=a.filterException.allFields||[];var c=a.filterException.allFields.indexOf(b.UniqueName);-1!=c?a.filterException.allFields.splice(c,1):(a.filterException.allFields.push(b.UniqueName),a.filterException.fields=_.reject(a.filterException.fields,function(a){var c="\\[id"+b.UniqueName+"\\]";return new RegExp(c).test(a.UniqueName)}))},a.toggleToList=function(b){a.filterException.fields=a.filterException.fields||[];var c=_.filter(a.filterException.fields,{Name:b.Name,UniqueName:b.UniqueName});c.length?c.forEach(function(b){a.filterException.fields.splice(_.indexOf(a.filterException.fields,b),1)}):a.filterException.fields.push({Name:b.Name,UniqueName:b.UniqueName})},a.isInList=function(b){return _.filter(a.filterException.fields,{UniqueName:b.Name,UniqueName:b.UniqueName}).length},a.getDatasourceName=function(b){var c=_.find(a.datasource.CubeInfo.Dimensions,function(a){return a.UniqueName==b});return c?c.Name.replace(/as id\d+/gi,""):""},a.showDialog=function(d){b.show({controller:["$scope","$mdDialog",function(b,c){b.parent=a,b.cancel=function(){c.cancel()}}],templateUrl:"editor/filter-except/select-except-modal.html",parent:angular.element(document.body),targetEvent:d,clickOutsideToClose:!1,fullscreen:c("sm")||c("xs")})}}],link:function(){app.lang.setLang()}}})}(jQuery),function(a){var b=angular.module("management");b.service("myService",["$http",function(a){var b=null;this.getMenus=function(){return null==b&&(b=a.get(app.urlPrefix+"api/menus/get")),b}}]),b.factory("myFactory",function(){return{sayHello:function(a){return"Hi "+a+"!"}}}),b.directive("generalSettings",["myService","myFactory",function(a,b){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/generalSettings.html?v="+app.version,scope:{model:"=ngModel"},controller:["$scope",function(b){b.menus=[],a.getMenus().then(function(a){var a=a.data;0==a.filter(function(a){return-1==+a.id}).length&&a.push({id:-1,name:"لینک...",parent:"لینک دلخواه"}),b.menus=a},function(){b.error="خطا در دریافت اطلاعات"})}],link:function(){app.lang.setLang()}}}])}(jQuery),function(a){var b=angular.module("management");b.directive("globalVariable",function(){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/globalVariable.html?v="+app.version,scope:{dimensions:"=",measures:"=",prop:"="},controller:["$scope",function(a){}],link:function(){app.lang.setLang()}}})}(jQuery),function(a){var b=angular.module("management");b.directive("numberFormat",function(){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/numberFormat.html?v="+app.version,scope:{model:"=ngModel"},controller:["$scope",function(b){b.model=a.extend({formatString:",.2f",formatStringCustom:",.2f"},b.model),b.refreshChart=function(a){b.$parent.refreshChart(a)}}],link:function(){app.lang.setLang()}}})}(jQuery),function(a){var b=angular.module("management");b.directive("textEditor",function(){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/textEditor.html?v="+app.version+new Date,scope:{model:"=prop"},controller:["$scope",function(b){b.model=a.extend({bold:!1,color:"#333333",italic:!1,fontSize:"10px",fontName:"Droid",formatString:",.2f",formatStringCustom:",.2f"},b.model)}],link:function(){app.lang.setLang()}}})}(jQuery),function(a){var b=angular.module("management");b.directive("mapSelector",["$timeout",function(b){return{restrict:"E",scope:{model:"=prop"},controller:["$scope","$http","$mdDialog","$mdMedia",function(b,c,d,e){b.model=a.extend({selectedMap:"1"},b.model),b.refreshList=function(){b.list=null,b.getList()},b.getList=function(){b.list||c.get(app.urlPrefix+"Moderation/Map/GetList").success(function(a){a.result&&(b.list=a.list)})},b.getList(),b.showUploadDialog=function(c){d.show({controller:["$scope","$mdDialog","$timeout","$mdToast",function(c,d,e,f){c.parent=b,c.cancel=function(){d.cancel()},c.selectFile=function(){a("#file-upload[type=file]").click()},c.upload=function(){function a(){e(function(){var a=f.simple().textContent("آپلود ناموفق بود");f.show(a)},0)}if(!c.name||!c.file){var b=f.simple().textContent("نام و فایل نقشه را وارد کنید");return void f.show(b)}var g=new FormData;g.append("file",c.file),g.append("name",c.name);var h=new XMLHttpRequest;h.upload.addEventListener("load",function(){e(function(){d.cancel();var a=f.simple().textContent("آپلود با موفقیت انجام شد");f.show(a)},0)}),h.upload.addEventListener("error",a),h.upload.addEventListener("abort",a),h.open("POST",app.urlPrefix+"Moderation/Map/Upload"),h.send(g)},c.d3=d3}],templateUrl:"editor/map/upload-map.html",parent:angular.element(document.body),targetEvent:c,clickOutsideToClose:!0,fullscreen:e("sm")||e("xs")})}}],templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/types/mapSelector.html?v="+app.version}}])}(jQuery),function(a){var b=angular.module("management");b.directive("tableIndicator",["$timeout",function(a){return{restrict:"E",scope:{prop:"=",dimensions:"=",measures:"=",config:"="},controller:["$scope","$http",function(a,b){a.prop[a.config.name]&&(a.prop[a.config.name].indicator=a.prop[a.config.name].indicator||[],a.model=a.prop[a.config.name].indicator,a.change=function(){a.$parent.refreshChart("refresh")},a.changeItem=function(a){})}],link:function(){app.lang.setLang()},templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/types/tableIndicator.html?v="+app.version}}])}(jQuery),function(a){var b=angular.module("management");b.directive("userControlVariableRelation",["$timeout",function(b){return{restrict:"E",scope:{prop:"=",dimensions:"="},controller:["$scope","$http",function(a,c){a.$watch("dimensions",function(b,c){a.prop.userControl.info.dimensions=a.dimensions,console.log("### chaneg dimension")},!0),a.list||c.get(app.urlPrefix+"Moderation/GlobalVariable/GetList").success(function(b){b.unshift({Id:"-1",Name:"NONE"}),a.list=b}),a.AddGlobalVariables=function(){app.globalVariableHelper.AddGlobalVariables(function(c){b(function(){a.list.push({Id:c.Id,Name:c.Name}),a.prop.userControl.info.variableId=c.Id+""},0)})}}],templateUrl:app.urlPrefix+"dist/partial/management/charts/directives/types/variableRelation.html?v="+app.version,link:function(c,d,e){var f=e.selector;angular.element(a(f)).bind("default-value",function(a,d,e,f){b(function(){c.prop.userControl.info.variableDefault={values:e,type:f}},0)}),app.lang.setLang()}}}])}(jQuery),function(a){var b=angular.module("management");b.directive("datasourcePermission",["$timeout","$http","roles",function(a,b,c){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/datasource/datasourcePermission.html?v="+app.version,scope:{roles:"=ngModel",id:"@",type:"@"},controller:["$scope","$http",function(a,b){function d(){a.permissions&&a.roles&&_.forEach(a.roles,function(b){var c=_.find(a.permissions,{roleId:b.id});c&&(b.action=1==c.actionSum?1:3==c.actionSum?2:4,b.check=!0)})}var e=a.type&&"datasource"!=a.type?"chart"==a.type?"chart":"menu":"datasource";if(a.roles&&a.roles.length||c.get().then(function(b){a.roles=angular.merge({},b.data.list),_.forEach(a.roles,function(a){a.action=1,a.check=!1}),d()}),+a.id)switch(e){case"datasource":b.get(app.urlPrefix+"api/permissions/getDatasourcePermissions?id="+a.id).then(function(b){a.permissions=b.data.list,d()});break;case"chart":b.get(app.urlPrefix+"api/permissions/getChartPermissions?id="+a.id).then(function(b){a.permissions=b.data.list,d()});break;case"menu":b.get(app.urlPrefix+"api/permissions/getMenuPermissions?id="+a.id).then(function(b){a.permissions=b.data.list,d()})}}]}}])}(jQuery);var ngApp=angular.module("management");ngApp.controller("datasourcefileCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$window","$sce","datasources",function(a,b,c,d,e,f,g,h,i,j,k){function l(b){a.error=j.trustAsHtml("<b>"+b.data.title+"</b> <br/>"+b.data.desc)}function m(a){c.show({template:'<md-toast class="md-toast error"> <span class="md-toast-text" flex>'+a+"</span></md-toast>",hideDelay:3e3,position:"bottom left"})}function n(b){a.sheets=b.result,a.sheetName=a.sheets[0],a.changeSheet()}function o(b){var c="",d=_.map(b,function(a,b){return"<tr>"+_.map(a,function(a){return 0==b?"<th>"+a+"</th>":"<td>"+a+"</td>"}).join("")+"</tr>"}).join("");c='<table class="table">'+d+"</table>",a.testResult=j.trustAsHtml(c)}function p(){var a=$("#main-form").width();$("#testResult").css("max-width",a+"px"),$("#testResult").css("overflow","auto")}var q={MsOlap:1,MSSQL:2,MySQL:3,File:4,WebResource:5,JoinDatasource:6},r="undefined"!=typeof e.packageId?e.packageId:0,s="undefined"!=typeof e.id?e.id:0,t=(e.type,s>0);a.isEdit=t,a.id=s;var u=!1;t&&(b.get(app.urlPrefix+"api/datasources/get?type="+q.File+"&id="+s).then(function(b){a.name=b.data.name,a.keepHistory=b.data.keepHistory,u=b.data.keepHistory},l),b.get(app.urlPrefix+"Moderation/Excel/Sample?id="+s).then(function(a){a.data?o(a.data):($("#queryResult").html(""),$("#test-result").removeClass().addClass("alert alert-danger").show().find("span").html("اشکال در دریافت اطلاعات").append('<p style="text-align: left;margin-top:7px;">'+a.error+"</p>"))},l)),a.save=function(){if(a.error=null,!a.fileForm.$valid)return void m("فیلدهای ضروری باید پر شوند");a.testResult=null;var d=_.filter(a.roles,{check:!0}).map(function(a){return a.action+"-"+a.id});if(!a.keepHistory&&u){var e=confirm("در صورت ذخیره منبع داده، با توجه به عدم انتخاب گزینه نگهداری تاریخچه، رکوردهای قبلی پاک می‌شوند. آیا برای ادامه اطمینان دارید؟");if(!e)return}b.post(app.urlPrefix+"Moderation/Excel/save",{SheetName:a.sheetName,DataSourceName:a.name,KeepHistory:a.keepHistory,Id:s,PackageId:r,RolesActions:d,AceProvider:a.aceProvider}).then(function(a){function b(){window.history.length<=2?f.path("/datasources/"+r):window.history.back()}var d=c.simple().textContent(t?"تغییرات ثبت شد":"منبع داده جدید ایجاد شد");c.show(d),b(),k.reset()},l)},a.extention="XLS",a.aceProvider="12",a.progress=-1,a.changeSheet=function(){b.get(app.urlPrefix+"Moderation/Excel/data?sheetName="+encodeURIComponent(a.sheetName)+"&AceProvider="+a.aceProvider).then(function(b){b.data?o(b.data):a.error=j.trustAsHtml("اشکال در دریافت اطلاعات")})},$("#input-file-id").fileupload({dataType:"json",url:app.urlPrefix+"Moderation/Excel/UploadFiles",autoUpload:!1,done:function(a,b){h(function(){switch(b.formData.type){case"XLS":n(b);break;case"CSV":o(b.result);break;case"XML":}},0)},add:function(b,c){h(function(){a.uploadData=c,a.fileName=j.trustAsHtml(c.files[0].name+"<br><sub><b>حجم:</b> "+(c.files[0].size/1024).toFixed(2)+" KB</sub>");var b=c.files[0].name.match(/\.[^.]+$/);if(null!=b){var d=b[0];".xlsx"!=d&&"xls"!=d||(a.extention="XLS"),".csv"==d&&(a.extention="CSV"),".xml"==d&&(a.extention="XML")}},0)},error:function(b,c){h(function(){a.error=j.trustAsHtml('<div class="ltr"><b>'+b.responseJSON.title+"</b> <br/>"+b.responseJSON.desc+"</div>")},0)}}).on("fileuploadprogressall",function(b,c){var d=parseInt(c.loaded/c.total*100,10);h(function(){a.progress=d},0)}),a.uploadData,a.upload=function(){a.error=null,a.testResult=null,a.uploadData.formData={type:a.extention,aceProvider:a.aceProvider},a.uploadData.submit(),a.progress=0,p()}}]);var ngApp=angular.module("management");ngApp.service("interRelation",["$http",function(a){var b,c=function(){return b=a.get(app.urlPrefix+"moderation/datasourceInterRelation/get")};return{get:c,reset:function(){b=null}}}]),ngApp.controller("interRelationCtrl",["$scope","$http","$mdToast","$mdDialog","$translate","interRelation","$mdMedia","utils","toolbar",function(a,b,c,d,e,f,g,h,i){function j(b){d.show({controller:["$scope","$mdDialog","$timeout",function(b,c,d){b.parent=a,b.cancel=function(){c.cancel()}}],parent:angular.element(document.body),targetEvent:b,clickOutsideToClose:!0,fullscreen:g("sm")||g("xs"),templateUrl:"datasourceRelation/add-relation.html"})}a.utils=h,e("interRelation").then(function(a){i.setTitles([{name:a,click:null}])}),a.progress=!0,f.get().then(function(b){a.progress=!1,a.data=b.data.list.map(function(a){var b=JSON.parse(a.data);return b.conditions.forEach(function(a){if("string"==typeof a.left){var b=a.left;a.left={column:b,isText:!1,formula:null},a.op="="}if("string"==typeof a.right){var b=a.right;a.right={column:b,isText:!1,formula:null}}}),b.id=a.id,b}),a.getList(function(){a.modalRelationObject={conditions:[{}],left:-1,right:-1}})}),a.modalRelationObject={conditions:[{}],left:0,right:0};var k=!0;a.getList=function(c){k?(k=!1,b.get(app.urlPrefix+"Moderation/JoinDataSource/GetDatasourceList").success(function(b){a.datasourceList=b,c&&c()})):c&&c()},a.add=function(c){return 0==a.modalRelationObject.conditions.length?(alert("حداقل یک رابطه تعریف کنید"),!1):(a.modalRelationObject.name=a.datasourceList.filter(function(b){return+a.modalRelationObject.left==b.Id})[0].Name+" - "+a.datasourceList.filter(function(b){return+a.modalRelationObject.right==b.Id})[0].Name,void b.post(app.urlPrefix+"Moderation/DatasourceInterRelation/Save",JSON.stringify(a.modalRelationObject),{headers:{"Content-Type":"application/json; charset=utf-8"}}).success(function(b){if(b.result)if(a.modalRelationObject.id){var c=a.data.filter(function(b){return b.id==a.modalRelationObject.id})[0];c=angular.extend({},a.modalRelationObject)}else a.modalRelationObject.id=b.id,a.data.splice(a.data.length,0,a.modalRelationObject);else a.error=$sce.trustAsHtml(b.message)}))},a.cancel=function(){},a["new"]=function(b){a.modalRelationObject={conditions:[{op:"="}],left:0,right:0},j(b)},a.edit=function(b,c){a.modalRelationObject=c,j(b)},a["delete"]=function(e){var f=app.urlPrefix+"Moderation/DatasourceInterRelation/Delete",g=_.filter(a.data,{select:!0}).map(function(a){return a.id}),h=d.confirm().title("حذف برای همیشه؟").textContent(g.length+" مورد برای حذف انتخاب شده است").ariaLabel("حذف").targetEvent(e).ok("حذف!").cancel("لغو");d.show(h).then(function(){b.post(f,g).then(function(b){b.data.deleted&&(a.data=_.filter(a.data,function(a){return-1==b.data.deleted.indexOf(a.id)}));var d=c.simple().textContent("حذف انجام شد");c.show(d)})})},a.selectedCount=function(){return _.filter(a.data,{select:!0}).length},a.selectAll=function(){_.forEach(a.data,function(b){b.select=a.selectAllCheckbox})},a.restore=function(b){a.modalRelationObject=b},a.getLastFocus=function(b){a.lastFocus=b.target;var c=b.target;if(c)if("selectionStart"in c)a.selectionStart=c.selectionStart,a.selectionEnd=c.selectionEnd;else if(document.selection){c.focus();var d=document.selection.createRange(),e=document.selection.createRange().text.length;d.moveStart("character",-c.value.length),a.selectionStart=d.text.length-e}},a.addFormula=function(b,c){$(a.lastFocus).focus();var d=$(a.lastFocus).val(),e="[id"+c+"].["+b+"]",f=0;d=d.substring(0,a.selectionStart)+d.substring(a.selectionEnd,d.length);var g=d.substring(0,a.selectionStart)+e+d.substring(a.selectionStart,d.length);$(a.lastFocus).val(g);var h=$(a.lastFocus).get(0);h.setSelectionRange(a.selectionStart+f,a.selectionStart+f),a.selectionStart=a.selectionStart+f,a.selectionEnd=a.selectionStart}}]),ngApp.filter("filterColumns",function(){return function(a,b,c,d){if(a){var e=b.map(function(a){return c?a.left:a.right}).filter(function(a,b){return-1!=a&&b!=+d});return a.filter(function(a){return-1==e.indexOf(a)})}}});var ngApp=angular.module("management");ngApp.controller("datasourceJoinCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$window","$sce","$mdMedia","utils","datasources",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(b){a.saveProgress=!1,a.testProgress=!1,a.error=j.trustAsHtml("<b>"+b.data.title+"</b> <br/>"+b.data.desc)}function o(){2==window.history.length?f.path("/datasources/"+s):window.history.back()}function p(){return{id:t,isEdit:u,name:a.name,disable:a.disable,disableMessage:a.disableMessage,selectedDs:a.selectedDatasource.map(function(a){return a.Id}),selectedFields:a.selectedFields,relationsList:a.relationsList.map(function(a){return{left:a.left,right:a.right,includeRight:a.includeRight,includeLeft:a.includeLeft,repeatRows:a.repeatRows,conditions:a.conditions.map(function(a){return{left:a.left,right:a.right,op:a.op}})}}),script:a.script,relationType:a.relationType,aliasArray:JSON.stringify(a.aliasArray),isSchedule:a.isSchedule,schedule:a.schedule,partitions:a.partitions}}function n(b){a.saveProgress=!1,a.testProgress=!1,a.scriptProgress=!1,a.error=j.trustAsHtml("<b>"+b.data.title+"</b> <br/>")}function q(a,b){return d.show({controller:["$scope","$mdDialog","$timeout",function(a,c,d){function e(b,c){b.renderer.setPadding(18),a.insertFormula=function(a){b.insert(a),b.focus()}}a.cancel=function(){c.cancel()},a.save=function(){c.hide(a.formula)},b&&(a.formula=b),a.aceOption={useWrapMode:!0,showGutter:!1,theme:"sqlserver",mode:"sqlserver",maxLines:14,onLoad:e,require:["ace/ext/beautify"]}}],parent:angular.element(document.body),targetEvent:a,clickOutsideToClose:!0,fullscreen:!0,template:'<md-dialog aria-label="{{\'editor\' | translate}}" ng-cloak class="fullscreen-dialog">                                 <md-toolbar>                                                                                                                            <div class="md-toolbar-tools">                                                                                                          <h2>{{\'editor\' | translate}}</h2>                                                                                                   <span flex></span>                                                                                                                  <md-button class="md-icon-button" ng-click="cancel()">                                                                                  <span class="material-icons">close</span>                                                                                       </md-button>                                                                                                                    </div>                                                                                                                          </md-toolbar>                                                                                                                       <md-dialog-content layout-margin flex layout="row" class="md-dialog-contentx">                                                          <style>                                                                                                                                 .ace_editor {                                                                                                                           border: 1px solid #efefef;                                                                                                      }                                                                                                                                                                                                                                                                           .ace_editor, .ace_editor div {                                                                                                          font: 16px/normal \'Courier New\', \'Menlo\', \'Ubuntu Mono\', \'Consolas\', \'source-code-pro\', monospace;                              }                                                                                                                                                                                                                                                                   md-dialog.fullscreen-dialog {                                                                                                           max-width: 100%;                                                                                                                    max-height: 100%;                                                                                                                   width: 100%;                                                                                                                        height: 100%;                                                                                                                       border-radius: 0;                                                                                                               }                                                                                                                               </style>                                                                                                                                                                                                                                                                <div class="ltr" flex="100" ui-ace="aceOption" ng-model="formula">                                                                      select * from tbl_meuns                                                                                                         </div>                                                                                                                                                                                                                                                              </md-dialog-content>                                                                                                                <md-dialog-actions layout="row">                                                                                                        <md-button ng-click="save()">                                                                                                           {{ \'ذخیره\' | translate }}                                                                                                        </md-button>                                                                                                                        <md-button ng-click="cancel()">                                                                                                         {{ \'cancel\' | translate }}                                                                                                      </md-button>                                                                                                                    </md-dialog-actions>                                                                                                            </md-dialog>'
})}var r={MsOlap:1,MSSQL:2,MySQL:3,File:4,WebResource:5,JoinDatasource:6};a.utils=l;var s="undefined"!=typeof e.packageId?e.packageId:0,t="undefined"!=typeof e.id?e.id:0,u=(e.type,t>0);a.isEdit=u,a.id=t,a.model={},u&&b.get(app.urlPrefix+"api/datasources/get?type="+r.JoinDatasource+"&id="+t).then(function(b){a.restore(b.data.model,b.data.list)},n);var v=!1;a.isSchedule=!1,a.selectedDatasource=[],a.selectedFields=[],a.relationsList=[],a.relationType="JOIN";var w=function(c){return a.datasourceListPromise||(a.datasourceListPromise=b.get(app.urlPrefix+"Moderation/JoinDataSource/GetDatasourceList")),a.datasourceListPromise};a.select=function(b){d.show({controller:["$scope","$mdDialog",function(b,c){w().then(function(c){a.datasourceList=c.data,b.datasourceList=c.data,_.forEach(b.datasourceList,function(a){a.check=!1})}),b.select=function(){_.filter(b.datasourceList,{check:!0}).forEach(function(b){a.addItemToDatasource(b.Id)}),c.hide()},b.cancel=function(){c.cancel()}}],templateUrl:"join/datasource_select.html",parent:angular.element(document.body),targetEvent:b,clickOutsideToClose:!0,fullscreen:k("sm")||k("xs")})},a.exploreDatasource=function(c,e){d.show({controller:["$scope","$mdDialog",function(d,e){d.exploreError=null,d.explor=null,b.post(app.urlPrefix+"Moderation/JoinDataSource/ExploreDatasource",JSON.stringify({Id:a.selectedDatasource[c].Id}),{headers:{"Content-Type":"application/json; charset=utf-8"}}).then(function(a){d.exploreError=null;var b=_.map(a.data.datasourceExplore,function(a,b){return"<tr>"+_.map(a,function(a){return 0==b?"<th>"+a+"</th>":"<td>"+a+"</td>"}).join("")+"</tr>"}).join("");d.explor=j.trustAsHtml('<table class="table">'+b+"</table>")},function(b){a.exploreError=j.trustAsHtml(b.data.title+"<br/>"+b.data.desc)}),d.cancel=function(){e.cancel()}}],templateUrl:"join/datasource_explor.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0,fullscreen:k("sm")||k("xs")})},a.showRelationDialog=function(b){d.show({controller:["$scope","$mdDialog",function(b,c){b.$scope=a,b.cancel=function(){a.cancelItemtoRelationsList(),c.cancel()},b.ok=function(){a.addItemtoRelationsList(),c.hide()}}],templateUrl:"join/datasource_add_relation.html",parent:angular.element(document.body),targetEvent:b,clickOutsideToClose:!0,fullscreen:k("sm")||k("xs")})},a.addItemToDatasource=function(b){var c=a.selectedDatasource.filter(function(a){return a.Id.replace(/(\d+)-\d+/,"$1")==b}).length,d=a.datasourceList.filter(function(a){return a.Id==b});if(d&&d.length>0){for(var e=[],f=0;f<d[0].PartitionCount;f++)e.push({index:f,check:!0});a.selectedDatasource.push({Id:d[0].Id+"-"+c,Name:d[0].Name+(c>0?" شماره"+c:""),Fields:d[0].Fields,Partitions:e})}},a.removeSelectedDatasource=function(b){var c=a.selectedDatasource[b];a.selectedDatasource.splice(b,1),a.relationsList=a.relationsList.filter(function(a){return a.left!=c.Id&&a.right!=c.Id}),a.selectedFields=a.selectedFields.filter(function(a){var b=a.split(",");return b[0]!=c.Id})},a.persian=function(a){return persian(a)},a.aliasArray={},a.toggleSelectedFields=function(b){var c=a.selectedFields.indexOf(b);c>-1?a.selectedFields.splice(c,1):a.selectedFields.push(b)},a.toggleSelectedFieldsCheckAll=function(b,c){for(var d=$(c.target).prop("checked"),e=0;e<b.Fields.length;e++){var f=b.Id+","+e,g=a.selectedFields.indexOf(f);g>-1&&!d&&a.selectedFields.splice(g,1),-1==g&&d&&a.selectedFields.push(f)}},a.addRelationLimit=function(){a.modalRelationObject.conditions.push({left:0,op:"=",right:0})},a.removeRelationLimit=function(b){a.modalRelationObject.conditions.splice(b,1)},a.addItemtoRelationsList=function(){v||a.relationsList.push(a.modalRelationObject),a.cancelItemtoRelationsList()},a.cancelItemtoRelationsList=function(){v=!1,a.modalRelationObject={conditions:[{left:0,op:"=",right:0}],left:"0",right:"0",includeRight:!0,includeLeft:!0,repeatRows:!1}},a.editRelation=function(b){v=!0,$("#add-relation-modal").modal("show"),a.modalRelationObject=a.relationsList[b]},a.cancel=function(){o()},a.deleteDatasource=function(a){$(a.target).button("loading");var c=$("#datasource-id").val();b.post(app.urlPrefix+"Moderation/JoinDataSource/Delete",JSON.stringify({id:c}),{headers:{"Content-Type":"application/json; charset=utf-8"}}).success(function(b){$(a.target).button("reset"),b.result&&app.router.navigate("Moderation/DataSource/index/",{trigger:!0})})},a.restore=function(b,c){a.isEdit=!0,a.datasourceList=c,b.selectedDs=b.selectedDs||[],c.forEach(function(c){for(var d=b.selectedDs.filter(function(a){return+a.replace(/(\d+)-\d+/,"$1")==+c.Id}),e=0;e<d.length;e++){for(var f=d[e],g=+f.replace(/(\d+)-(\d+)/,"$2"),h=[],e=0;e<c.PartitionCount;e++)h.push({index:e,check:!0});var i={Id:f,Name:c.Name+(g>0?" شماره"+g:""),Fields:c.Fields,Partitions:h};a.selectedDatasource.push(i)}}),a.selectedFields=b.selectedFields||[],a.relationsList=b.relationsList||[],a.name=b.name,a.disable=b.disable,a.disableMessage=b.disableMessage,a.script=b.script,a.relationType=b.relationType,a.aliasArray=JSON.parse(b.aliasArray),a.isSchedule=b.isSchedule,a.schedule=b.schedule,a.partitions=b.partitions||[]},a.saveJoin=function(c){var d=p();d.packageId=s,d.RolesActions=_.filter(a.roles,{check:!0}).map(function(a){return a.action+"-"+a.id}),a.saveProgress=!0,b.post(app.urlPrefix+"Moderation/JoinDataSource/SaveRelation",JSON.stringify(d),{headers:{"Content-Type":"application/json; charset=utf-8"}}).then(function(b){a.saveProgress=!1,a.error=null,o(),m.reset()},n)},a.getScript=function(c){var d=p();a.scriptProgress=!0,b.post(app.urlPrefix+"Moderation/JoinDataSource/GetScript",JSON.stringify(d),{headers:{"Content-Type":"application/json; charset=utf-8"}}).success(function(b){a.scriptProgress=!1,b.result?(a.script=b.script,a.error=null):a.error=j.trustAsHtml(b.message)})},a.test=function(c){var d=p();a.testProgress=!0,b.post(app.urlPrefix+"Moderation/JoinDataSource/Test",JSON.stringify(d),{headers:{"Content-Type":"application/json; charset=utf-8"}}).success(function(b){a.testProgress=!1,b.result?(a.testResult=b.queryResult,a.error=null):a.error=j.trustAsHtml(b.message)})},a.modalRelationObject={conditions:[{left:0,op:"=",right:0}],left:"0",right:"0",includeRight:!0,includeLeft:!0,repeatRows:!1},a.showDialog=function(b){q(b,a.script).then(function(b){a.script=b})}}]);var ngApp=angular.module("management");ngApp.controller("datasourceListCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$translate","datasources","utils","toolbar",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(){return _.map(_.filter(a.data,{select:!0}),function(a){return[a.id,a.type]})}function n(b){var c=_.lastIndexOf(a.data.map(function(a){return a.type}),1);-1==c?a.data=b.concat(a.data):Array.prototype.splice.apply(a.data,[c+1,0].concat(b))}function o(b){a.data=_.filter(a.data,function(a){return!_.some(b,{id:a.id,type:a.type})})}function p(a){k.showErrorToast(a.data.desc)}a.utils=k;var q="undefined"!=typeof e.id?e.id:0;a.app=app;var r=q?"?packageId="+q:"";a.progress=!0,b.get(app.urlPrefix+"api/datasources/get"+r).then(function(b){a.progress=!1,a.data=b.data.list,i("لیست منابع داده").then(function(c){a.listTranslate=c,b.data.path.unshift({name:c,id:null}),a.path=b.data.path.map(function(b){return b.click=function(){a["goto"]({type:1,id:b.id})},b}),l.setTitles(a.path)})},p);var s=function(){return _.some(a.data,{select:!0})};a.menuInvalidate=function(){console.log("#### menuInvalidate");var b=s(),c=_.filter(a.data,{select:!0,type:1}).length,d=_.filter(a.data,{select:!0,type:2}).length;a.canCopy=b,a.canDelete=b,a.canForward=b,a.canDirEdit=1==c&&0==d},a.copy=function(){var d=app.urlPrefix+"Moderation/Datasource/Clone",e=m();b.post(d,e).then(function(b){if(b.data.result){b.data.datasources&&(a.data=a.data.concat(b.data.datasources)),b.data.packages&&n(b.data.packages);var d=c.simple().textContent("کپی انجام شد");c.show(d)}},p)},a["delete"]=function(e){var f=app.urlPrefix+"Moderation/Datasource/Delete",g=m(),h=d.confirm().title("حذف برای همیشه؟").textContent(g.length+" مورد برای حذف انتخاب شده است").ariaLabel("حذف").targetEvent(e).ok("حذف!").cancel("لغو");d.show(h).then(function(){b.post(f,g).then(function(b){if(b.data.result){b.data.deletedIds&&o(b.data.deletedIds);var d=c.simple().textContent("حذف انجام شد");c.show(d),a.menuInvalidate()}},p)},function(){a.status="You decided to keep your debt."})},a.forward=function(a){j.select(a,{type:["datasources"],justDir:!0,selectableDir:!0,multipleChart:!1}).then(function(a){var d=a.selected[0];if(e.id==d.id){var f=c.simple().textContent("موارد انتخاب شده در همین پوشه هستند");return void c.show(f)}var g=m();b.post(app.urlPrefix+"Moderation/Datasource/MoveToPackage",{Ids:g,packageId:d.id}).then(function(a){o(a.data.ids);var b=c.simple().textContent("انتقال انجام شد");c.show(b)},p)})},a.dirEdit=function(b){var d=m();g.edit(b,2,d[0][0],function(b){_.find(a.data,{select:!0}).name=b.data.info.Name;var d=c.simple().textContent("نام پوشه تغییر کرد");c.show(d)},p)},a.newPackage=function(a){g.create(a,2,e.id,function(a){n([{id:a.data.info.Id,name:a.data.info.Name,type:1}]);var b=c.simple().textContent("پوشه جدید ایجاد شد");c.show(b),j.reset()},p)},a.insertChart=function(a,b){f.path("charts/new/normal/0/"+a.id)},a.gotoChart=function(a){f.path("charts/edit/0/"+a.id)},a["goto"]=function(a,b){var c={MsOlap:1,MSSQL:2,MySQL:3,File:4,WebResource:5,JoinDatasource:6};if(1==a.type)f.path("datasources"+(a.id?"/"+a.id:""));else if(2==a.type)switch(a.dsType){case c.MySQL:f.path("datasources/add/mssql/"+c.MySQL+"/"+q+"/"+a.id);break;case c.MsOlap:f.path("datasources/add/mssql/"+c.MsOlap+"/"+q+"/"+a.id);break;case c.MSSQL:f.path("datasources/add/mssql/"+c.MSSQL+"/"+q+"/"+a.id);break;case c.File:f.path("datasources/add/file/"+q+"/"+a.id);break;case c.WebResource:f.path("datasources/add/web/"+q+"/"+a.id);break;case c.JoinDatasource:f.path("datasources/add/join/"+q+"/"+a.id)}},a.getTypeName=function(a){var b=1,c=2,d=3,e=4,f=5,g=6,h="";switch(+a){case b:h="MsOlap";break;case c:h="MSSQL";break;case d:h="MySQL";break;case e:h="File";break;case f:h="WebResource";break;case g:h="JoinDatasource"}return h};var t;a.$watch("search",function(){h.cancel(t),t=h(function(){"undefined"!=typeof a.search&&(a.progress=!0,b.get(app.urlPrefix+"api/datasources/get?q="+a.search).then(function(b){a.progress=!1,a.data=b.data.list,a.path=b.data.path,a.path.unshift({name:"لیست منابع داده",id:null})},p))},400)}),a.selectAll=function(){a.data&&_.forEach(a.data,function(b){b.select=a.selectAllCheckbox}),a.menuInvalidate()},a.newDatasource=function(a){f.path("datasources/new/"+(e.id?e.id:""))},a.addTimeDatasoure=function(c){i(["Create Time Datasource","Enter the datasource name.","name","ok","cancel"]).then(function(e){var f=d.prompt().title(e["Create Time Datasource"]).textContent(e["Enter the datasource name."]).placeholder(e.name).ariaLabel(e.name).targetEvent(c).ok(e.ok).cancel(e.cancel);d.show(f).then(function(c){b.get(app.urlPrefix+"api/datasources/createDatetimeDatasource?name="+c).then(function(b){a.data.push(b.data)},function(){alert("خطایی در ساخت منبع داده رخ داده است")})})})},a.sortDetail={},a.sort=function(b){a.sortDetail[b]=a.sortDetail[b]||{},a.sortDetail[b].isDesc=!a.sortDetail[b].isDesc;var c=_.filter(a.data,{type:1}),d=_.filter(a.data,{type:2});d=_.sortBy(d,[b]),c=_.sortBy(c,[b]),a.sortDetail[b].isDesc||(d=_.reverse(d),c=_.reverse(c)),a.data=c.concat(d)}}]);var ngApp=angular.module("management");ngApp.controller("datasourceMssqlCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$window","$sce","roles","datasources",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(b){a.error=j.trustAsHtml("<b>"+b.data.title+"</b> <br/>")}function n(a){c.show({template:'<md-toast class="md-toast error"> <span class="md-toast-text" flex>'+a+"</span></md-toast>",hideDelay:3e3,position:"bottom left"})}function o(){2==window.history.length?f.path("/datasources/"+s):window.history.back()}function p(){$("md-content").animate({scrollTop:4e3},500)}function q(a,b){return d.show({controller:["$scope","$mdDialog","$timeout",function(a,c,d){function e(b,c){b.renderer.setPadding(18),a.insertFormula=function(a){b.insert(a),b.focus()}}a.cancel=function(){c.cancel()},a.save=function(){c.hide(a.formula)},b&&(a.formula=b),a.aceOption={useWrapMode:!0,showGutter:!1,theme:"sqlserver",mode:"sqlserver",maxLines:14,onLoad:e,require:["ace/ext/beautify"]}}],parent:angular.element(document.body),targetEvent:a,clickOutsideToClose:!0,fullscreen:!0,template:'<md-dialog aria-label="{{\'editor\' | translate}}" ng-cloak class="fullscreen-dialog">                                 <md-toolbar>                                                                                                                            <div class="md-toolbar-tools">                                                                                                          <h2>{{\'editor\' | translate}}</h2>                                                                                                   <span flex></span>                                                                                                                  <md-button class="md-icon-button" ng-click="cancel()">                                                                                  <span class="material-icons">close</span>                                                                                       </md-button>                                                                                                                    </div>                                                                                                                          </md-toolbar>                                                                                                                       <md-dialog-content layout-margin flex layout="row" class="md-dialog-contentx">                                                          <style>                                                                                                                                 .ace_editor {                                                                                                                           border: 1px solid #efefef;                                                                                                      }                                                                                                                                                                                                                                                                           .ace_editor, .ace_editor div {                                                                                                          font: 16px/normal \'Courier New\', \'Menlo\', \'Ubuntu Mono\', \'Consolas\', \'source-code-pro\', monospace;                              }                                                                                                                                                                                                                                                                   md-dialog.fullscreen-dialog {                                                                                                           max-width: 100%;                                                                                                                    max-height: 100%;                                                                                                                   width: 100%;                                                                                                                        height: 100%;                                                                                                                       border-radius: 0;                                                                                                               }                                                                                                                               </style>                                                                                                                                                                                                                                                                <div class="ltr" flex="100" ui-ace="aceOption" ng-model="formula">                                                                      select * from tbl_meuns                                                                                                         </div>                                                                                                                                                                                                                                                              </md-dialog-content>                                                                                                                <md-dialog-actions layout="row">                                                                                                        <md-button ng-click="save()">                                                                                                           {{ \'ذخیره\' | translate }}                                                                                                        </md-button>                                                                                                                        <md-button ng-click="cancel()">                                                                                                         {{ \'cancel\' | translate }}                                                                                                      </md-button>                                                                                                                    </md-dialog-actions>                                                                                                            </md-dialog>'})}var r={MsOlap:1,MSSQL:2,MySQL:3,File:4,WebResource:5,JoinDatasource:6},s="undefined"!=typeof e.packageId?e.packageId:0,t="undefined"!=typeof e.id?e.id:0,u=e.type,v=t>0;a.id=t,a.isEdit=v,a.type=u,a.schedule={},a.schedulePartition=[],v?b.get(app.urlPrefix+"api/datasources/get?type="+u+"&id="+t).then(function(b){a.model=b.data.model,a.model.Schedule&&(a.schedule=JSON.parse(a.model.Schedule)),a.model.schedulePartition&&(a.schedulePartition=JSON.parse(a.model.schedulePartition)),a.model.Type=u},m):a.model={Authentication:0,CollationDefault:1,AutoRefresh:15,Type:u},a.saveProgress=!1,a.cancel=function(){o()},a.save=function(){return a.error=null,a.testResult=null,a.mssql.$valid?(a.model.Schedule=JSON.stringify(a.schedule),a.model.schedulePartition=JSON.stringify(a.schedulePartition),a.model.RolesActions=_.filter(a.roles,{check:!0}).map(function(a){return a.action+"-"+a.id}),a.saveProgress=!0,void b.post(app.urlPrefix+"Moderation/Datasource/AddMsOlap",{model:a.model,Type:u,IsEdit:v,PackageId:s}).then(function(b){a.saveProgress=!1;var d=c.simple().textContent(v?"تغییرات ثبت شد":"منبع داده جدید ایجاد شد");c.show(d),o(),l.reset()},function(b){a.saveProgress=!1,a.error=j.trustAsHtml("<b>"+b.data.title+"</b> <br/>"),p()})):void n("فیلدهای ضروری باید پر شوند")},a.testProgress=!1,a.test=function(){return a.error=null,a.testResult=null,a.mssql.$valid?(a.model.Schedule=JSON.stringify(a.schedule),a.model.schedulePartition=JSON.stringify(a.schedulePartition),a.testProgress=!0,void b.post(app.urlPrefix+"Moderation/Datasource/TestMsOlap",{model:a.model}).then(function(b){a.testProgress=!1;var c="";if(u!=r.MsOlap||a.model.Query){var d=_.map(b.data.queryResult,function(a,b){return"<tr>"+_.map(a,function(a){return 0==b?"<th>"+a+"</th>":"<td>"+a+"</td>"}).join("")+"</tr>"}).join("");c='<table class="table">'+d+"</table>"}u!=r.MsOlap||a.model.Query||(c='<div style="background-color:#dff0d8" flex>اتصال با موفقیت برقرار شد</div>'),a.testResult=j.trustAsHtml(c)},function(b){a.testProgress=!1,a.error=j.trustAsHtml("<b>"+b.data.title+"</b> <br/>"),p()})):void n("فیلدهای ضروری باید پر شوند")},a.showDialog=function(b){q(b,a.model.Query).then(function(b){a.model.Query=b})}}]);var ngApp=angular.module("management");ngApp.controller("datasourceNewCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout",function(a,b,c,d,e,f,g,h){var i={MsOlap:1,MSSQL:2,MySQL:3,File:4,WebResource:5,JoinDatasource:6},j="undefined"==typeof e.id?0:e.id;a.list=[{href:"datasources/add/mssql/"+i.MSSQL+"/"+j,icon:app.urlPrefix+"Images/ds-type-db.png",title:"پایگاه داده Microsoft SQL Server",desc:"در این قسمت می‌توانید به پایگاه داده‌ MSSQL متصل شوید"},{href:"datasources/add/mssql/"+i.MsOlap+"/"+j,icon:app.urlPrefix+"Images/ds-type-xmla.png",title:"Microsoft Analysis Service ",desc:"در این قسمت می‌توانید به سرویس آنالیز مایکروسافت متصل شوید"},{href:"datasources/add/file/"+j,icon:app.urlPrefix+"Images/ds-type-upload.png",title:"آپلود کردن فایل",desc:"آپلود کردن فایل‌های Excel یا CSV "},{href:"datasources/add/web/"+j,icon:app.urlPrefix+"Images/ds-type-point.png",title:"منابع روی وب",desc:"دسترسی به منابع داده‌ای مثل XML, CSV, JSON از طریق وب. برای دسترسی به این منابع داده باید آدرس URL مربوط به منبع داده را در اختیار داشته باشید"},{href:"datasources/add/join/"+j,icon:app.urlPrefix+"Images/join-datasource.png",title:"یکی کردن منابع داده",desc:"یکپارچه کردن منابع داده موجود. ارتباط منابع داده خود را در این قسمت تعریف کنید."}],a["goto"]=function(a){console.log(a),f.path(a.href)}}]),function(a){var b=angular.module("datasourcePartitionExpressionCat",["ngAnimate","ui.mask","datasourceScheduleCat"]);b.directive("partitionExpression",["$timeout","$http",function(b,c){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/datasource/PartitionExprission.html",scope:{type:"=?",datasources:"=?",partition:"=ngModel"},controller:["$scope","$http",function(c,d){c.type||(c.type=1),c.partition||(c.partition=[]),c.newPartition=function(){c.partition.push({formulas:[{}],datasources:[],autoRefresh:60,schedule:{}}),b(function(){app.lang.setLang()},0)},c.getPartitionName=function(a){var b={0:"اول",1:"دوم",2:"سوم",3:"چهارم",4:"‍‍‍پنجم",5:"ششم",6:"هفتم",7:"هشتم",8:"نهم",9:"دهم"};return 10>+a?b[+a]:"اضافه"},c.addDatasourceToPartition=function(d){var e=c.datasources.filter(function(a){return a.Id==d.id});e.length>0?d.partitions=a.extend(!0,[],e[0].Partitions):d.partitions=[],b(function(){app.lang.setLang()},0)},app.lang.setLang()}],link:function(){app.lang.setLang()}}}])}(jQuery),function(a){var b=angular.module("datasourceScheduleCat",["ngAnimate","ui.mask","ngMaterial"]);b.directive("datasourceSchedule",["$timeout","$http",function(a,b){return{restrict:"E",templateUrl:app.urlPrefix+"dist/partial/management/datasource/Schedule.html?v="+app.version,scope:{model:"=?ngModel"},controller:["$scope","$http","$element","$mdMedia","$mdDialog",function(a,b,c,d,e){function f(b,c){b.model=a.model,b.cancel=function(){c.cancel()},b.checkValue=function(){"second"==b.model.dailyFrequencyRecurType&&+b.model.dailyFrequencyRecur<10&&(b.model.dailyFrequencyRecur=10)},b.save=function(){c.hide(b.model)}}a.model&&a.model.occure||(a.model={occure:"daily",dailyRecurs:1,weeklyRecurs:1,weeklySat:!0,weeklySun:!1,weeklyMon:!1,weeklyTus:!1,weeklyWen:!1,weeklyThu:!1,weeklyFri:!1,monthlyDayOf:1,monthlyRecurs:1,dailyFrequency:"once",dailyFrequencyAtHour:"0600",dailyFrequencyRecur:1,dailyFrequencyRecurType:"hour",dailyFrequencyStart:"0001",dailyFrequencyStop:"2359"}),a.formatClock=function(a){var b=a+"";return b.substr(0,2)+":"+b.substr(2)},a.edit=function(a){function b(a){}var c=d("sm")||d("xs");e.show({controller:["$scope","$mdDialog",f],templateUrl:app.urlPrefix+"dist/partial/management/datasource/scheduleDialog.html?v="+Math.random(),parent:angular.element(document.body),targetEvent:a,clickOutsideToClose:!0,fullscreen:c}).then(b)}}]}}])}(jQuery);var ngApp=angular.module("management");ngApp.controller("datasourceWebCtrl",["$scope","$http","$mdToast","$mdDialog","$routeParams","$location","packages","$timeout","$window","$sce","datasources",function(a,b,c,d,e,f,g,h,i,j,k){function l(b){a.saveProgress=!1,a.testProgress=!1,a.error=j.trustAsHtml("<b>"+b.data.title+"</b> <br/>"+b.data.desc)}function m(b){a.model.isEdit=s,a.model.isTest=b,a.model.id=r,a.model.parameters=a.parameters.filter(function(a){return a.name}).map(function(a){return[a.name,a.value,a.type]}),a.model.Schedule=JSON.stringify(a.schedule),a.model.RolesActions=_.filter(a.roles,{check:!0}).map(function(a){return a.action+"-"+a.id})}function n(){2==window.history.length?f.path("/datasources/"+q):window.history.back()}function o(a){c.show({template:'<md-toast class="md-toast error"> <span class="md-toast-text" flex>'+a+"</span></md-toast>",hideDelay:3e3,position:"bottom left"})}var p={MsOlap:1,MSSQL:2,MySQL:3,File:4,WebResource:5,JoinDatasource:6},q="undefined"!=typeof e.packageId?e.packageId:0,r="undefined"!=typeof e.id?e.id:0,s=(e.type,r>0);a.isEdit=s,a.id=r,a.model={contentType:"1"},s&&b.get(app.urlPrefix+"api/datasources/get?type="+p.WebResource+"&id="+r).then(function(b){a.model=b.data.model,a.model.Schedule&&(a.schedule=JSON.parse(a.model.Schedule)),a.model.parameters&&(a.parameters=a.model.parameters.map(function(a){return{name:a[0],value:a[1],select:a[2]||"Query"}}))},l),a.schedule={},a.parameters=[{select:"Query"}],a.saveProgress=!1,a.save=function(){return a.error=null,a.testResult=null,a.webForm.$valid?(m(!1),link=app.urlPrefix+"Moderation/WebResource/Add",a.saveProgress=!0,void b.post(link,a.model).then(function(b){a.saveProgress=!1;var d=c.simple().textContent(s?"تغییرات ثبت شد":"منبع داده جدید ایجاد شد");c.show(d),n(),k.reset()},l)):void o("فیلدهای ضروری باید پر شوند")},a.testProgress=!1,a.test=function(){return a.error=null,a.testResult=null,a.webForm.$valid?(m(!0),link=app.urlPrefix+"Moderation/WebResource/Add",a.testProgress=!0,void b.post(link,a.model).then(function(b){a.testProgress=!1;var c="",d=_.map(b.data.list,function(a,b){return"<tr>"+_.map(a,function(a){return 0==b?"<th>"+a+"</th>":"<td>"+a+"</td>"}).join("")+"</tr>"}).join("");c='<table class="table">'+d+"</table>",a.testResult=j.trustAsHtml(c)},l)):void o("فیلدهای ضروری باید پر شوند")}}]);var ngApp=angular.module("management");ngApp.service("indicator",["$mdDialog","$mdMedia","$rootScope","templates","$http",function(a,b,c,d,e){var f=function(c,e){function f(a,b){a.cancel=function(){b.cancel()}}var g=b("sm")||b("xs");return a.show({controller:["$scope","$mdDialog",f],parent:angular.element(document.body),targetEvent:c,clickOutsideToClose:!0,fullscreen:g,templateUrl:d.tmpl.package_dialog})};return{get:f}}]);var ngApp=angular.module("management");ngApp.service("packages",["$mdDialog","$mdMedia","$rootScope","$http",function(a,b,c,d){function e(a,b){return f||(f=d.post(app.urlPrefix+"Moderation/Package/GetPackagesObject",{scope:a,withContent:b})),f}var f,g=function(c,d,f,g,h){function i(a,b){function c(a,b){b(a),a.subPackages&&_.forEach(a.subPackages,function(a){c(a,b)})}e(d,f).then(function(b){a.root=b.data.root,console.log("set root in package service ",a.root)}),a.clearSelect=function(){c(a.root,function(a){a.select=!1})},a.cancel=function(){b.cancel()},a.select=function(){var d=null;c(a.root,function(a){a.select&&(d=a)}),b.hide(d)}}var j=b("sm")||b("xs");a.show({controller:i,templateUrl:app.urlPrefix+"dist/partial/management/packages/select-package.html",parent:angular.element(document.body),targetEvent:c,clickOutsideToClose:!0,fullscreen:j}).then(g,h)},h=function(b,c,e,g,h,i){var j=a.prompt().title("ایجاد پوشه جدید").textContent("نام پوشه جدید را وارد کنید").placeholder("نام پوشه").ariaLabel("نام پوشه").targetEvent(b).ok("ایجاد").cancel("لغو");a.show(j).then(function(a){f=null,d.post(app.urlPrefix+"Moderation/Package/Create",{name:a,scope:c,parentId:e}).then(g,h)},i)},i=function(b,c,e,g,h,i){var j=a.prompt().title("تغییر نام پوشه").textContent("نام جدید را وارد کنید").placeholder("نام پوشه").ariaLabel("نام پوشه").targetEvent(b).ok("تغییر").cancel("لغو");a.show(j).then(function(a){f=null,d.post(app.urlPrefix+"Moderation/Package/Edit",{id:e,name:a}).then(g,h)},i)};return{name:"packages",select:g,create:h,edit:i}}]);var ngApp=angular.module("management");ngApp.service("menus",["$http",function(a){function b(b){return c||(c=a.get(app.urlPrefix+"api/menus/get"+(b?"?JusetEdit=true":""))),c}var c;return{get:b,getEditable:function(){return b(!0)}}}]);var ngApp=angular.module("services");ngApp.service("roles",["$http",function(a){function b(){return console.log("role service"),d||(d=a.get(app.urlPrefix+"api/roles/get")),d}function c(){d=null}var d;return{get:b,reset:c}}]),ngApp.directive("selectRoles",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=ngModel",settings:"=?"},controller:["$scope","$http","roles",function(a,b,c){a.model=a.model||[],a.settings=a.settings||{},c.get().then(function(b){a.roles=_.extend([],b.data.list)})}],template:'<div>                     <sm-dropdown class="selection search multiple fluid"  settings="{fullTextSearch: true}" model="model" items="roles" label="item.name" value="item.id" ></sm-dropdown>                   </div>',link:function(a,b,c){}}});var ngApp=angular.module("management");ngApp.service("utils",["$http","$translate","$sce","$mdToast",function(a,b,c,d){function e(a,b){var c={0:"۰",1:"۱",2:"۲",3:"۳",4:"۴",5:"۵",6:"۶",7:"۷",8:"۸",9:"۹"};return a+="",a.replace(/(\d)/g,function(a,b){return c[b]||a})}function f(a){var b={"۰":0,"۱":1,"۲":2,"۳":3,"۴":4,"۵":5,"۶":6,"۷":7,"۸":8,"۹":9};return a+="",a.replace(/([۰۱۲۳۴۵۶۷۸۹])/g,function(a,c){return"undefined"!=typeof b[c]?b[c]:a})}function g(a){var b={"ي":"ی","إ":"ا","ؤ":"و","أ":"ا","ک":"ك"};return a+="",a.replace(/(.)/g,function(a,c){return b[c]||a})}function h(a){var b=c.trustAsHtml("<b>"+a.data.title+"</b> <br/>"+a.data.desc);j&&j(b)}function i(a){d.show({template:'<md-toast class="md-toast error"> <span class="md-toast-text" flex>'+a+"</span></md-toast>",hideDelay:3e3,position:"bottom left"})}var j,k=function(a){j=a};return{persian:e,depersian:f,normilize:g,error:h,onError:k,showErrorToast:i}}]);var cat=angular.module("settingsCat",["ngAnimate"]);cat.controller("myController",["$scope","$http","$sce","$timeout",function(a,b,c,d){a.langs=[{key:0,value:"فارسی"},{key:1,value:"English"}],a.save=function(d){$(d.target).button("loading"),b.post(app.urlPrefix+"Moderation/Settings/GeneralSettings",JSON.stringify({Brand:a.brand,Language:a.language}),{headers:{"Content-Type":"application/json; charset=utf-8"}}).success(function(b){$(d.target).button("reset"),b.result?($("a.navbar-brand").text(b.brand),window.history.back()):a.error=c.trustAsHtml(b.error)})},a.restore=function(b){b&&d(function(){var c=JSON.parse(b);console.log(c),a.brand=c.Brand,a.language=c.Language},0)}}]);var cat=angular.module("settingsCat",["ngAnimate"]);cat.controller("myController",["$scope","$http","$sce","$timeout",function(a,b,c,d){a.save=function(d){debugger;b.post(app.urlPrefix+"Moderation/Settings/Mail",JSON.stringify({port:a.port,host:a.host,ssl:a.ssl,timeout:a.timeout,username:a.username,password:a.password}),{headers:{"Content-Type":"application/json; charset=utf-8"}}).success(function(b){b.result?window.history.back():a.error=c.trustAsHtml(b.error)})},a.restore=function(b){b&&d(function(){var c=JSON.parse(b);console.log("[settingsCat] "),console.log(c),a.port=c.port,a.host=c.host,a.ssl=c.ssl,a.timeout=c.timeout,a.username=c.username,a.password=c.password},0)}}]);
//# sourceMappingURL=admin-app.js.map