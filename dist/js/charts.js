// داشبورد مدیریتی صدف info@sadafdashboard.ir 

function _instanceof(a,b){return null!=b&&"undefined"!=typeof Symbol&&b[Symbol.hasInstance]?!!b[Symbol.hasInstance](a):a instanceof b}function _slicedToArray(a,b){return _arrayWithHoles(a)||_iterableToArrayLimit(a,b)||_unsupportedIterableToArray(a,b)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(a,b){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(a)){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!b||c.length!==b);d=!0);}catch(i){e=!0,f=i}finally{try{d||null==h["return"]||h["return"]()}finally{if(e)throw f}}return c}}function _arrayWithHoles(a){if(Array.isArray(a))return a}function _classCallCheck(a,b){if(!_instanceof(a,b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}function _toConsumableArray(a){return _arrayWithoutHoles(a)||_iterableToArray(a)||_unsupportedIterableToArray(a)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(a,b){if(a){if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);return"Object"===c&&a.constructor&&(c=a.constructor.name),"Map"===c||"Set"===c?Array.from(a):"Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c)?_arrayLikeToArray(a,b):void 0}}function _iterableToArray(a){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(a))return Array.from(a)}function _arrayWithoutHoles(a){if(Array.isArray(a))return _arrayLikeToArray(a)}function _arrayLikeToArray(a,b){(null==b||b>a.length)&&(b=a.length);for(var c=0,d=new Array(b);c<b;c++)d[c]=a[c];return d}function _typeof(a){"@babel/helpers - typeof";return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a})(a)}!function(a){function b(a,b){return"function"==typeof a?a.call(b):a}function c(b,c){this.$element=a(b),this.options=c,this.enabled=!0,this.fixTitle()}c.prototype={show:function(){var c=this.getTitle();if(c&&this.enabled){var d=this.tip();d.find(".tipsy-inner")[this.options.html?"html":"text"](c),d[0].className="tipsy",d.remove().css({top:0,left:0,visibility:"hidden",display:"block"}).appendTo(document.body);var e=a.extend({},this.$element.offset(),{width:this.$element[0].offsetWidth||0,height:this.$element[0].offsetHeight||0});if("object"==typeof this.$element[0].nearestViewportElement){var f=this.$element[0],g=f.getBoundingClientRect();e.width=g.width,e.height=g.height}var h,i=d[0].offsetWidth,j=d[0].offsetHeight,k=b(this.options.gravity,this.$element[0]);switch(k.charAt(0)){case"n":h={top:e.top+e.height+this.options.offset,left:e.left+e.width/2-i/2};break;case"s":h={top:e.top-j-this.options.offset,left:e.left+e.width/2-i/2};break;case"e":h={top:e.top+e.height/2-j/2,left:e.left-i-this.options.offset};break;case"w":h={top:e.top+e.height/2-j/2,left:e.left+e.width+this.options.offset};break;case"c":h={top:e.top+e.height/2-j/2,left:e.left+e.width/2-i/2}}2==k.length&&("w"==k.charAt(1)?h.left=e.left+e.width/2-15:h.left=e.left+e.width/2-i+15),d.css(h).addClass("tipsy-"+k),d.find(".tipsy-arrow")[0].className="tipsy-arrow tipsy-arrow-"+k.charAt(0),this.options.className&&d.addClass(b(this.options.className,this.$element[0])),this.options.fade?d.stop().css({opacity:0,display:"block",visibility:"visible"}).animate({opacity:this.options.opacity}):d.css({visibility:"visible",opacity:this.options.opacity});var l=this,m=function(a){return function(){l.$tip.stop(),l.tipHovered=a,a||(0===l.options.delayOut?l.hide():setTimeout(function(){"out"==l.hoverState&&l.hide()},l.options.delayOut))}};d.hover(m(!0),m(!1))}},hide:function(){this.options.fade?this.tip().stop().fadeOut(function(){a(this).remove()}):this.tip().remove()},fixTitle:function(){var a=this.$element;(a.attr("title")||"string"!=typeof a.attr("original-title"))&&a.attr("original-title",a.attr("title")||"").removeAttr("title"),"object"==typeof a.get(0).nearestViewportElement&&a.children("title").length&&a.append("<original-title>"+(a.children("title").text()||"")+"</original-title>").children("title").remove()},getTitle:function(){var a,b=this.$element,c=this.options;if(this.fixTitle(),"string"==typeof c.title){var d="title"==c.title?"original-title":c.title;a=b.children(d).length?b.children(d).html():b.attr(d)}else"function"==typeof c.title&&(a=c.title.call(b[0]));return a=(""+a).replace(/(^\s*|\s*$)/,""),a||c.fallback},tip:function(){return this.$tip||(this.$tip=a('<div class="tipsy"></div>').html('<div class="tipsy-arrow"></div><div class="tipsy-inner"></div>')),this.$tip},validate:function(){this.$element[0].parentNode||(this.hide(),this.$element=null,this.options=null)},enable:function(){this.enabled=!0},disable:function(){this.enabled=!1},toggleEnabled:function(){this.enabled=!this.enabled}},a.fn.tipsy=function(b){function d(d){var e=a.data(d,"tipsy");return e||(e=new c(d,a.fn.tipsy.elementOptions(d,b)),a.data(d,"tipsy",e)),e}function e(){var a=d(this);a.hoverState="in",0===b.delayIn?a.show():(a.fixTitle(),setTimeout(function(){"in"==a.hoverState&&a.show()},b.delayIn))}function f(){var a=d(this);if(a.hoverState="out",0===b.delayOut)a.hide();else{var c=function(){a.tipHovered&&b.hoverlock||"out"==a.hoverState&&a.hide()};setTimeout(c,b.delayOut)}}if(b===!0)return this.data("tipsy");if("string"==typeof b){var g=this.data("tipsy");return g&&g[b](),this}if(b=a.extend({},a.fn.tipsy.defaults,b),b.hoverlock&&0===b.delayOut&&(b.delayOut=100),"manual"!=b.trigger){var h=b.live?"live":"bind",i="hover"==b.trigger?"mouseenter":"focus",j="hover"==b.trigger?"click":"blur",k="hover"==b.trigger?"mouseleave":"blur";this[h](i,e)[h](k,f)[h](j,f)}return this},a.fn.tipsy.defaults={className:null,delayIn:0,delayOut:0,fade:!1,fallback:"",gravity:"n",html:!1,live:!1,offset:0,opacity:.8,title:"title",trigger:"hover",hoverlock:!1},a.fn.tipsy.elementOptions=function(b,c){return a.metadata?a.extend({},c,a(b).metadata()):c},a.fn.tipsy.autoNS=function(){return a(this).offset().top>a(document).scrollTop()+a(window).height()/2?"s":"n"},a.fn.tipsy.autoWE=function(){return a(this).offset().left>a(document).scrollLeft()+a(window).width()/2?"e":"w"},a.fn.tipsy.autoBounds=function(b,c){return function(){var d={ns:c[0],ew:c.length>1&&c[1]},e=a(document).scrollTop()+b,f=a(document).scrollLeft()+b,g=a(this);return g.offset().top<e&&(d.ns="n"),g.offset().left<f&&(d.ew="w"),a(window).width()+a(document).scrollLeft()-g.offset().left<b&&(d.ew="e"),a(window).height()+a(document).scrollTop()-g.offset().top<b&&(d.ns="s"),d.ns+(d.ew?d.ew:"")}}}(jQuery);var chartTypes={BAR:1,PIE:2,LINE:3,GAUGE:4,TABLE:5,MAP:6,UserControl:7,Radar:8,Tree:9,Text:10,CE_MAP:{1:"barLine",2:"pie",4:"gauge",5:"table",6:"map",7:"userControl",8:"radar",9:"tree",10:"text"},NAMES:{1:"نمودار خطی-میله‌ای",2:"نمودار دایره‌ای",4:"نمودار عقربه‌ای",5:"جدول",7:"کنترل کاربری",8:"نمودار رادار",9:"نمودار درختی",10:"متن"}};!function(a){function b(b,c,d){var e=a(this).data("settings");if("undefined"!=typeof e)return e.isRefresh=!0,e=a.extend(e,c),e.chartProp.info.disable&&!e.editMode?void f(e):(setTimeout(function(){i(b,e.input,e,!0,d),e.parameters.selectedItem=null,e.parameters.isUp=!1},0),this)}function c(b){if(b.editMode){var c=b.chartProp.info||{};b.type.isCustom&&(c=b.chartProp.general.info||{});var d=a("#"+b.id).parents(".chart-widget");c.backgroundColor&&d.find(".ui.card ").css("background",c.backgroundColor),c.dontShowTitle===!0?d.find(".ui.card .title-content").hide():d.find(".ui.card .title-content").show(),c.titleFont&&(d.find(".ui.card .title-content").css({"font-size":c.titleFont.fontSize,color:c.titleFont.color,"font-family":c.titleFont.fontName,"font-weight":c.titleFont.bold?"bold":"normal","font-style":c.titleFont.italic?"italic":"normal"}),d.find(".ui.card .title").css({"text-align":c.titleFont.align}))}}function d(a){try{var b=a.data("ajaxRequest");null!=b&&b.abort&&b.abort()}catch(c){}return this}function e(b,c,e){d(a(this)),e=a.extend({refreshRelatedDatasources:!0},e);var g=(a(this),a(this).data("settings"));if(g=a.extend(g,c),g.isRefresh=!1,"undefined"!=typeof g.chartProp){if("undefined"==typeof b.isCustom&&(b={id:+b,isCustom:!1}),g.chartProp.info.disable&&!g.editMode)return void f(g);app.chartCommons.setFilterParameter(g),g.parameters.filterHierarchy=app.chartCommons.getFilterHierarchy(g.ChartInPageId),g.editMode&&(g.parameters.ChartInfo=a("#divChart").data("chartInfo"));var j=[];if(b.id===chartTypes.TABLE)for(var l in g.chartProp.series)g.chartProp.series.hasOwnProperty(l)&&j.push({Name:l,Type:g.chartProp.series[l].rowResult});g.dataUrl=h(b);var m=a.extend(g.parameters,{resultRows:j,type:g.dataType}),n=app.mobileMode&&2===app.mobileScriptVersion?m:JSON.stringify(m);e.refreshRelatedDatasources&&g.ChartInPageId&&(app.moderation.dashboadpage.refreshRelatedDatasources(g.input.RefreshDatasource,[+g.ChartInPageId],g.chartProp.info.groups),app.filterBox&&app.filterBox.refresh&&app.filterBox.refresh());var o=app.mobileMode?proxy.ajax:a.ajax,p=k[g.ChartInPageId];return p&&p.abort&&p.abort(),p=o({url:g.dataUrl,type:"POST",dataType:"json",contentType:"application/json",data:n,async:g.async,requestId:g.requestId,success:function(a){i(b,a,g,!0),g.parameters.selectedItem=null,g.parameters.isUp=!1}}),k[g.ChartInPageId]=p,this}}function f(b){var c="#"+b.id;a(c).empty(),a(c).html('<div class="temporal" style="display: flex;justify-content: center;flex-direction: column;text-align: center; align-items: center;flex: 1">                <img style="margin:12px;"width="32" src="'+app.urlPrefix+'images/barricade-256.png"/>                <p>نمودار در حال تغییر است</p>            </div > ')}function g(b,c){var d=a.extend({},j,c),e=a(this);if(d.id=e.attr("id"),d.type=b,e.data("isChart",!0),e.data("settings",d),"undefined"==typeof b.isCustom&&(b={id:+b,isCustom:!1}),d.chartProp.info.disable&&!d.editMode)return void f(d);app.chartCommons.setFilterParameter(d),app.chartCommons.levelTypeUtils.getParam(d),b=d.type;var g=[];if(b.id===chartTypes.TABLE)for(var l in d.chartProp.series)d.chartProp.series.hasOwnProperty(l)&&g.push({Name:l,Type:d.chartProp.series[l].rowResult});d.dataUrl=h(b);var m=app.mobileMode?proxy.ajax:a.ajax,n=a.extend(d.parameters,{resultRows:g,type:d.dataType}),o=app.mobileMode&&2===app.mobileScriptVersion?n:JSON.stringify(n),p=app.customChart.getConfig(b,d.chartProp.info);if(p.needServerData===!1)i(b,{result:!0},d,!1);else{var q=k[d.ChartInPageId];q&&q.abort&&q.abort(),q=m({url:d.dataUrl,type:"POST",dataType:"json",data:o,cache:!1,contentType:"application/json",success:function(c,e,f){d.mobileModeData={isOnline:e,date:f},"undefined"==typeof d.chartProp&&c.detail&&(d=a.extend(d,JSON.parse(c.detail))),d.beforeDraw&&d.beforeDraw(d),i(b,c,d,!1),d.parameters.selectedItem=null,d.parameters.isUp=!1},error:function(b){d.error&&d.error(d),!app.mobileMode&&b&&b.responseJSON&&b.responseJSON.forceSignout&&(console.log("شما از برنامه خارج شده‌اید. ممکن است کاربر دیگری با نام کاربری شما وارد سیستم شده باشد."),alert("شما از برنامه خارج شده‌اید. ممکن است کاربر دیگری با نام کاربری شما وارد سیستم شده باشد."),window.location.href=app.urlPrefix);var c="#"+d.id;a(c).addClass("bar-chart").empty(),b&&b.responseJSON&&b.responseJSON.desc?a(c).addClass("bar-chart").html(filterXSS('<div class="temporal"><b>'+b.responseJSON.title+' </b>  <span class="glyphicon glyphicon-info-sign"> </span> <br/ > <p style="direction:ltr;">'+b.responseJSON.desc+"</p></div>")):a(c).addClass("bar-chart").html('<div class="temporal">خطا در دریافت اطلاعات <span class="glyphicon glyphicon-info-sign"> </span></div>'),a(c).css({display:"flex",overflow:"auto",padding:"20px 14px","flex-flow":"column"})},requestId:d.requestId}),k[d.ChartInPageId]=q}return e}function h(a){if(a.isCustom)return app.urlPrefix+"api/chartdata/getdata";switch(parseInt(a.id)){case chartTypes.UserControl:return app.urlPrefix+"api/chartdata/GetColumnMembers";case chartTypes.Tree:return app.urlPrefix+"api/BarChart/getTreeData";default:return app.urlPrefix+"api/chartdata/getdata"}}function i(b,d,e,f,g){var h="#"+e.id;if(e.selector=h,d.series&&d.series.labels){e.chartProp.series=e.chartProp.series||{};var i=_.difference(Object.keys(e.chartProp.series),d.series.labels),j=_.difference(d.series.labels,Object.keys(e.chartProp.series));_.each(d.series.labels,function(a,b){if(b=j.indexOf(a),e.chartProp.series&&!e.chartProp.series[a]){var c=Math.min(i.length,b),d=i[c];e.chartProp.series[a]=_.merge({},e.chartProp.series[d])}})}var k=_.merge({enable:!1},e.chartProp.info.sort);if(k.enable&&k.serie){var l=_.indexOf(d.series.labels,k.serie);if(l!==-1){var m=_.map(d.series.data,function(a,b){return{data:+a[l],index:b}}),n=_.orderBy(m,"data",k.type||"asc");d.matrix=_.map(n,function(a){return d.matrix[a.index]}),d.series.data=_.map(n,function(a){return d.series.data[a.index]})}}if(e.editMode||dashboard.setLastRefresh(e.ChartInPageId,d.LastRefresh),e.editMode){if(b.isCustom||b.id>=12){var o="undefined"!=typeof d.series?d.series.labels:[],p="undefined"!=typeof d.kpis?d.kpis.labels:[];a(h).trigger("chartproperty",[p.concat(o)])}a(h).trigger("dimColor",[_.map(d.matrix,function(a){return a.values.join("-")})])}if(c(e),e.input=d,arguments.length<4)return void a.error("تعداد پارامترها باید حداقل چهار تا باشد");if("undefined"!=typeof e.chartProp){e.chartProp=_.extend({info:{}},e.chartProp);var q=0;if(e.chartProp.info.refreshPeriod&&(q=+e.chartProp.info.refreshPeriod),e.type.isCustom&&e.chartProp.general.info&&(q=+e.chartProp.general.info.refreshPeriod),q>0){var r=a("#"+e.id).data("timeout");r&&clearTimeout(r);var s=setTimeout(function(){a("#"+e.id).charts(b,"refreshWithData",null,{refreshRelatedDatasources:!1})},1e3*q);a("#"+e.id).data("timeout",s)}a("#dashboard-chart-panel").trigger("chartComplete",[e,d]),f&&!g?a(h).parents(".chart-widget").find(".temporal").remove():a(h).addClass("bar-chart").empty(),e.fromCommentDialog&&a(h).addClass("fromCommentDialog"),d=a.extend({EditPermission:!1,Description:"",LastRefresh:0,isFresh:!0,title:""},d);var t={title:null,showProgress:function(){},isProgress:function(){}};if(t=d3.select(h).titlebar({EditPermission:d.EditPermission,editLink:e.editLink,RemoveFromPage:e.RemoveFromPage,deleteLink:e.removeLink,desc:d.Description,LastRefresh:d.LastRefresh,isFresh:d.isFresh,title:d.title,chartId:e.chartId,ChartInPageId:e.ChartInPageId,type:b,editMode:e.editMode,refreshWithData:f,redrowAll:g,settings:e,showFilterIcon:"undefined"==typeof e.chartProp.info.showFilterIcon?1:+e.chartProp.info.showFilterIcon}),e.titlebar=t,t.showProgress(!1),!d.result)return a("#"+e.id).append(app.chartCommons.getError(d)),void a("#"+e.id).css({display:"flex",overflow:"auto","margin-top":"20px",padding:"20px 14px","flex-flow":"column"});if("undefined"==typeof b.isCustom&&(b={id:+b,isCustom:!1}),b.isCustom){e.selector="#"+e.id;var o="undefined"!=typeof d.series?d.series.labels:[],p="undefined"!=typeof d.kpis?d.kpis.labels:[];return e.editMode&&a(e.selector).trigger("chartproperty",[p.concat(o)]),void app.customChart.charts[b.id](d,e,f,t)}switch(parseInt(b.id)){case chartTypes.BAR:app.charts.bar.draw(d,e,f,t);break;case chartTypes.GAUGE:app.charts.gauge.draw(d,e,f,t);break;case chartTypes.PIE:app.charts.pie.draw(d,e,f,t);break;case chartTypes.TABLE:app.charts.table.draw(d,e,f,t);break;case chartTypes.MAP:app.charts.map.draw(d,e,f,t);break;case chartTypes.UserControl:app.charts.userControl.draw(d,e,f,t);break;case chartTypes.Radar:app.charts.radar.draw(d,e,f,t);break;case chartTypes.Tree:app.charts.tree.draw(d,e,f,t);break;case chartTypes.Text:app.charts.text.draw(d,e,f,t)}if(b.id>10){var u=_.find(app.charts.list,{type:b.id});u&&u.draw(d,e,f,t)}app.lang.setLang({selector:h}),e.finishDraw&&e.finishDraw(e),app.chartCommons.renderComments(e,d)}}var j={isSort:!1,fadeSpeed:200,fadeinEasing:"easeInOutCubic",chartId:-1,animationDuration:1e3,animationEase:"cubic-out"},k={};jQuery.fn.charts=function(c,f){var h={init:g,refresh:b,refreshWithData:e,abort:d};if(h[f]){var i=Array.prototype.slice.call(arguments,0);return f=i.splice(1,1),h[f].apply(this,i)}return"object"!=typeof method&&"undefined"!=typeof method&&f?void a.Error("Method "+f+" does not exist on jQuery.sitBarChart: you must specify type"):h.init.apply(this,arguments)},app.chartCommons.draw=i,app.customChart={cacheJs:{},charts:{},getJs:function(b,c,d){return"undefined"!=typeof app.customChart.cacheJs[b]?void c(app.customChart.cacheJs[b]):void a.ajax({url:app.urlPrefix+"api/customcharts/getjs/"+b,cache:!0}).done(function(d){app.customChart.cacheJs[b]=d;var e=a("head script#id-"+b);e.length||(a("head").append("<script id=id-"+b+"> app.customChart.charts["+b+"] = function(input, settings, refreshWithData, titlebar){\n"+d.code+"\n}</script>"),a("head").append('<style type="text/css">\n'+d.css+"\n</style>")),c(d)}).fail(function(a,b,c){d&&d()})},getConfig:function(a,b){var c={};return app.customChart.config&&app.customChart.config[a.id]&&a.isCustom&&(c=app.customChart.config[a.id]||{}),a.isCustom?c:app.chartCommons.getChartConfig(a.id,b||{})}}}(jQuery);var app=app||{};app.charts=app.charts||{},app.charts.map=app.charts.map||{},app.charts.map.draw=function(a,b,c,d){function e(c){function d(){function a(a,b){b.on({mousemove:function(a){var b=a.target.feature;q(a,b,null,null,a.containerPoint)},mouseout:r,click:function(a){var b=a.target.feature;p(a,b)}})}function c(){b.editMode&&(b.chartProp.info.realMap.initialZoom=g.getZoom(),b.chartProp.info.realMap.initialCenter=g.getCenter())}var d=b.chartProp.info.realMap||{},e="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";"open-street-online"===d.type&&(e="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"),"open-street-offline"===d.type&&(e="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"),"google-offline"===d.type&&(e=app.urlPrefix+"map_data//Tiles/{z}/gm_{x}_{y}_{z}.png"),"google-online"===d.type&&(e="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png");var f="map-"+b.chartId;$("#"+b.id).append('<div class="temporal" id = "'+f+'" style = "width: 100%; height:100%;" ></div > '),"undefined"==typeof b.chartProp.info.realMap.scrollWheelZoom&&(b.chartProp.info.realMap.scrollWheelZoom=!0);var g=null;g=b.chartProp.info.realMap.initialCenter?L.map(f,{center:[b.chartProp.info.realMap.initialCenter.lat,b.chartProp.info.realMap.initialCenter.lng],zoom:b.chartProp.info.realMap.initialZoom||5,scrollWheelZoom:b.chartProp.info.realMap.scrollWheelZoom}):L.map(f,{center:[32.8,53.6894],zoom:b.chartProp.info.realMap.initialZoom||5,scrollWheelZoom:b.chartProp.info.realMap.scrollWheelZoom}),L.tileLayer(e,{attributionControl:!1,attribution:"داشبورد مدیریتی صدف"}).addTo(g),g.getContainer().focus=function(){};var h=L.geoJson(O,{style:function(a,c){var e=l(a,null);return{color:b.chartProp.info.borderColor||"#666",strokeWidth:(b.chartProp.info.borderWidth||"0.5")+"px",fillColor:e,fillOpacity:d.fillOpacity||.5,weight:.8}},onEachFeature:a}).addTo(g);if(b.geo=h,svg1=d3.select(g.getPanes().overlayPane).select("svg"),Y=d3.select(g.getPanes().overlayPane).append("svg"),_.each(O.features,function(a){l(a,svg1)}),I){var j=L.control({position:b.chartProp.info.legendPosition.replace(" ","")});j.onAdd=function(a){var b=$("<div />").css({background:"#fff",padding:"10px","border-radius":"4px","font-family":"iransans"}).html(H.html()).get(0);return H.style("display","none"),b},j.addTo(g)}var k=function(a){var b=[0,0];h.eachLayer(function(c){c.feature.properties.Code===a.properties.Code&&(b=c.getBounds().getCenter())});var c=g.latLngToLayerPoint(b);return c},n=function(){b.chartProp.info.showChart&&"bar"===b.chartProp.info.chartType&&s(Y,k,null),b.chartProp.info.showChart&&"pie"===b.chartProp.info.chartType&&t(Y,k,null),b.chartProp.info.showName&&u(Y,k),b.chartProp.info.showValue&&v(Y,k),i(g,Y)};g.on("zoomstart",function(a){$(Y.node()).fadeOut()});var o=null;g.on("zoomend",function(a){c(),o&&clearTimeout(o),o=setTimeout(function(){Y.selectAll("*").remove(),n(),$(Y.node()).fadeIn()},400)}),g.on("moveend",function(a){i(g,Y),c()}),n();var w=g.getPanes(),x=1;_.each(w,function(a){a.style.zIndex=x++}),$(m+" .leaflet-control-container").children().css("z-index",1)}function e(){var a=d3.geoMercator().scale(1).translate([0,0]);T=d3.geoPath().projection(a);var d=T.bounds(O),e=.95/Math.max((d[1][0]-d[0][0])/N,(d[1][1]-d[0][1])/M),f=[(N-e*(d[1][0]+d[0][0]))/2,(M-e*(d[1][1]+d[0][1]))/2];a.scale(e).translate(f),T=T.projection(a),Y=d3.select(m).append("div").style("overflow","hidden").style("position","relative").attr("class","map-container temporal").append("svg").attr("class","temporal").attr("width",N).attr("height",M).append("g"),Y.selectAll("path").data(O.features).enter().append("path").attr("d",T).classed("pointer",!0).style("fill",function(a){return l(a,Y)}).on("click",p).on("mousemove",q).on("mouseout",r),Y.append("path").datum(topojson.mesh(c,c.objects.map,function(a,b){return!0})).attr("id","state-borders").attr("stroke",b.chartProp.info.borderColor||"#666").style("stroke-width",(b.chartProp.info.borderWidth||"0.5")+"px").attr("d",T),b.chartProp.info.showChart&&"bar"===b.chartProp.info.chartType&&s(Y,function(a){var b=T.centroid(a);return{x:b[0],y:b[1]}},p),b.chartProp.info.showChart&&"pie"===b.chartProp.info.chartType&&t(Y,function(a){var b=T.centroid(a);return{x:b[0],y:b[1]}},p),b.chartProp.info.showName&&u(Y,function(a){var b=T.centroid(a);return{x:b[0],y:b[1]}},p),b.chartProp.info.showValue&&v(Y,function(a){var b=T.centroid(a);return{x:b[0],y:b[1]}},p)}function l(c,d){var e=x[c.properties.Code+""];if("undefined"==typeof e)return b.chartProp.info.defaultColor||"#eee";var f=F(1);D-E!=0&&(f=F((e-E)/(D-E)));var g=a.series.labels,h=P.indexOf(c.properties.Code+"");if(h!==-1){var i=a.series.data[h],j=app.chartCommons.indicator.getIndicator(i,g,b.chartProp.indicator),k=_.flatten(j);if(k.length>0){var l=_.filter(k,{operand:"1"}),m=_.first(l),n=!!m&&m.isStriped;return m?n?app.chartCommons.indicator.getStripedColor(d,m.secondFieldColor,m.index):m.secondFieldColor:null}}return f}function p(c,d){if(o&&!b.editMode){var e=d.properties.Code+"";return void app.chartCommons.openLink(b.chartProp.info.openDashboard,{ChartInPageId:b.ChartInPageId,DataSourceId:b.input.DataSourceId,dimensionName:b.input.dimensionName,value:[e],caption:[d.properties.Name+""],refreshDatasource:b.input.RefreshDatasource})}var f=[d.properties.Code+""],g=[d.properties.Name+""];if("undefined"!=typeof T){var h,i,j;if(d&&aa!==d){var k=T.centroid(d);h=k[0],i=k[1],j=4,aa=d}else h=N/2,i=M/2,j=1,aa=null,f=null,g=null;Y.selectAll("path").classed("active",aa&&function(a){return a===aa}),Y.transition().duration(750).attr("transform","translate("+N/2+","+M/2+")scale("+j+")translate("+-h+","+-i+")").style("stroke-width",1.5/j+"px")}var l=b.chartProp.info.selectableArea;"undefined"==typeof l&&(l=!0),!b.editMode&&l&&(app.chartCommons.userFilter.setFilter({id:b.ChartInPageId,values:f,valuesCaption:g,variableType:0,dimensionName:a.dimensionName,chartInPageId:b.ChartInPageId,datasourceId:a.DataSourceId,disableClear:!1}),app.moderation.dashboadpage.refreshRelatedDatasources(a.RefreshDatasource,[+b.ChartInPageId],b.chartProp.info.groups),app.filterBox.refresh())}function q(a,b,c,d,e){var f=P.indexOf(b.properties.Code+""),g={};if(e)g=e;else{var i=d3.pointer(a);g.x=i[0]+7,g.y=i[1]+7}d3.select(m+" #map-tooltip ").transition().duration(200).style("opacity",.9),d3.select(m+" #map-tooltip ").html(h(f,n,b.properties.Name)).style("left",g.x+"px").style("top",g.y+"px")}function r(){d3.select(m+" #map-tooltip ").transition().duration(500).style("opacity",0)}function s(b,c,d){b.selectAll("g.bar").data(O.features).enter().append("g").classed("bar",!0).attr("transform",function(b){var d=P.indexOf(b.properties.Code+""),e=a.series.data[d];b.childes=_.map(e,function(a,b){return{index:b,data:a}}),b.childes=_.filter(b.childes,function(a){return!g(a.index).hidden});var f=c(b);return"translate("+(f.x-b.childes.length*W/2)+", "+f.y+")"}).on("click",d).on("mousemove",q).on("mouseout",r).selectAll("rect").data(function(a){return a.childes}).enter().append("rect").attr("width",W+"px").attr("fill",function(a,b){return g(a.index).color||U(b)}).attr("height",function(a){var b=a.data/D;return b*V+"px"}).attr("transform",function(a,b){var c=a.data/D;return"translate("+b*W+", -"+c*V+")"})}function t(b,c,d){var e=_.map(a.series.labels,function(a,b){return{name:a,prop:g(b)}}),f=a.series.data.map(function(a){return a.filter(function(a,b){return!e[b].prop.hidden})}),h=d3.pie().value(function(a){return a.data}),i=d3.max(f,function(a){return d3.max(a,function(a){return+a})});b.selectAll("g.pie").data(O.features).enter().append("g").classed("pie",!0).style("pointer-events","auto").attr("transform",function(b){var d=P.indexOf(b.properties.Code+""),e=a.series.data[d];b.childes=_.map(e,function(a,b){return{index:b,data:a}}),b.childes=_.filter(b.childes,function(a){return!g(a.index).hidden});var f=d3.max(b.childes,function(a){return a.data}),h=f/i*V*.65,j=.65*V/2.5;j>h&&(h=j);var k=d3.arc().innerRadius(0).outerRadius(h);_.each(b.childes,function(a){a.arc=k});var l=c(b);return"translate("+(l.x-b.childes.length*W/2)+", "+l.y+")"}).on("click",d).on("mousemove",q).on("mouseout",r).selectAll("path").data(function(a){return h(a.childes)}).enter().append("path").attr("d",function(a){return a.data.arc(a)}).style("pointer-events","auto").attr("fill",function(a,b){return g(a.data.index).color||U(b)})}function u(a,c,d){a.selectAll(".city-name").data(O.features).enter().append("svg:text").classed("city-name",!0).text(function(a){return a.properties.Name}).attr("x",function(a){return c(a).x}).attr("y",function(a){return c(a).y+X}).attr("text-anchor","middle").attr("fill",b.chartProp.info.nameEditor.color||"#333").style("font-size",b.chartProp.info.nameEditor.fontSize||"9px").style("font-family",b.chartProp.info.nameEditor.fontName||"IRANSans").style("font-weight",b.chartProp.info.nameEditor.bold?"bold":"200").style("font-style",b.chartProp.info.nameEditor.italic?"italic":"inherit").on("click",d).on("mousemove",q).on("mouseout",r)}function v(a,c,d){a.selectAll(".data-value").data(O.features).enter().append("svg:text").classed("data-value",!0).text(function(a){var c=x[a.properties.Code+""];return"undefined"==typeof c?"":persian(d3.format(b.chartProp.info.valueEditor.formatString)(c),j)}).attr("x",function(a){return c(a).x}).attr("y",function(a){return c(a).y+X+(b.chartProp.info.showName?-1*+b.chartProp.info.nameEditor.fontSize.replace("px","")-1:0)}).attr("text-anchor","middle").attr("fill",b.chartProp.info.valueEditor.color||"#333").style("font-size",b.chartProp.info.valueEditor.fontSize||"9px").style("font-family",b.chartProp.info.valueEditor.fontName||"IRANSans").style("font-weight",b.chartProp.info.valueEditor.bold?"bold":"200").style("font-style",b.chartProp.info.valueEditor.italic?"italic":"inherit").on("click",d).on("mousemove",q).on("mouseout",r)}var c=JSON.parse(c),w=k.indexOf(b.chartProp.info.mainSeries);w==-1&&(w=0),$(m+" .temporal").remove();for(var x={},y={},z=0,A=0;A<a.matrix.length;A++){var B=+a.series.data[A][w];x[a.matrix[A].captions[0]]=B,y[a.matrix[A].values[0]]=a.matrix[A].values[0],z+=B}b.chartProp.info.colorStart=b.chartProp.info.colorStart||"#31a354",b.chartProp.info.colorEnd=b.chartProp.info.colorEnd||"#c7e9c0";var C=$.extend({formatString:",.0f",colorStart:"#31a354",colorEnd:"#c7e9c0"},b.chartProp.series[a.series.labels[w]]),D=d3.max(a.series.data,function(a){return+a[w]}),E=d3.min(a.series.data,function(a){return+a[w]}),F=d3.interpolate(b.chartProp.info.colorEnd,b.chartProp.info.colorStart),G="pointer";b.editMode||(G="");var H=d3.select(m).append("div").attr("class","legend temporal "+G).styles({"text-align":"left",position:"absolute","background-color":"#fff","z-index":"1","border-radius":"4px",padding:"10px"}),I=!1;b.chartProp.info.legendPosition=b.chartProp.info.legendPosition||"top left";var J={"top right":{top:0,right:0},"top left":{top:0,left:0},"top center":{top:0,right:"50%",transform:"translate(50%)"},"bottom right":{bottom:0,right:0},"bottom left":{bottom:0,left:0},"bottom center":{bottom:0,right:"50%",transform:"translate(50%)"},"center right":{top:"50%",right:0},"center left":{top:"50%",left:0}};if(H.styles(J[b.chartProp.info.legendPosition]),b.chartProp.info.showLegend&&(f(m,b.chartProp.info.colorStart,b.chartProp.info.colorEnd,E,D,C,H,w),I=!0),b.chartProp.indicatorLegendShow){I=!0;H.legend({order:"vertical",colorPos:"right",width:N,font:b.chartProp.indicatorLegendFont,position:b.chartProp.info.legendPosition,selector:m,data:_.map(b.chartProp.indicator,function(c,d){var e=_.find(c.thenRow,{operand:"1"}),f=e?e.secondFieldColor:"#eeeeee",g=c.title||app.chartCommons.indicator.ifToString(c.ifRow,a.series.labels,a.seriesLablesCaptions,b);if(c.labelIsColumn){var h=a.series.labels.indexOf(c.labelColumn),i=a.series.labels.indexOf(c.ifRow[0].firstField),j="";_.each(a.series.data,function(b){var d=b[i],e=0;if(c.ifRow[0].secondFieldIsText)e=c.ifRow[0].secondFieldInput;else{var f=a.series.labels.indexOf(c.ifRow[0].secondFieldSelect);e=b[f]}var g=!1;switch(+c.ifRow[0].operand){case 1:g=d===e;break;case 2:g=d!==e;break;case 3:g=d>e;break;case 4:g=d>=e;break;case 5:g=d<e;break;case 6:g=d<=e;break;case 7:g=d.indexOf(e)>-1;break;case 8:g=d.indexOf(e)<=-1}if(g)return j=b[h],!1}),j&&(g=j)}return{label:g,color:f}})},j)}if(b.chartProp.info.showChart&&b.chartProp.info.showChartLegend){var K=_.map(a.series.labels,function(a,b){return{name:a,prop:g(b)}});I=!0,H.legend({order:"vertical",colorPos:"right",font:b.chartProp.info.legendFont,width:$(m).width(),selector:m,data:K.filter(function(a,b){return!a.prop.hidden}).map(function(a){return{label:(a.prop.name||a.name).replace(/^\[measure\]/,""),color:a.prop.color,key:a.name}})},j)}var M=$(m).height(),N=$(m).width();M<150&&(M=150);var O=topojson.feature(c,c.objects.map),P=a.matrix.map(function(a){return a.captions[0]}),Q=_.map(c.objects.map.geometries,"properties.Code"),R=_.differenceWith(P,Q,_.isEqual),S=b.chartProp.info.extraCode||{};S.enable&&(I=!0,H.insert("div",":first-child").selectAll(".diff").data(R).enter().append("div").style("margin-bottom","10px").html(function(c){var d=P.indexOf(c+""),e=(a.series.data[d],_.find(S.items,{code:c})),f=e&&e.caption?e.caption:c,g=h(d,n,f),i=$("<div />").html(g);return i.find("> div").css("font-size",b.chartProp.info.extraCode.font.fontSize||"9px").css("font-family",b.chartProp.info.extraCode.font.fontName||"IRANSans").css("font-weight",b.chartProp.info.extraCode.font.bold?"bold":"200").css("font-style",b.chartProp.info.extraCode.font.italic?"italic":"inherit"),g=i.html()}));var T,U=d3.scaleOrdinal(d3.schemeCategory10),V=.25*M*(b.chartProp.info.chartSize||50)/100,W=5,X=8,Y=null;I||H.remove();var Z=b.chartProp.info.mapType||"path";"path"===Z?e():d();var aa;d3.select(m).append("div").attr("id","map-tooltip").attr("class","temporal"),_.each(a.series.labels,function(a,b){var c=g(b);c.color=c.color||U(b)})}function f(c,d,e,f,g,h,i,k){if(!b.chartProp.info.showLegend)return d3.select(c).append("div");var l=h.name||a.seriesLablesCaptions[k],m=.05*$(c).width(),n=i.append("div").style("text-align","right").style("margin-bottom","10px");n.append("div").text(l).style("margin","0 0px");var o=n.append("div").classed("ltr",!0).style("display","inline-block");return o.append("span").text(persian(d3.format(h.formatString)(f||0),j)),o.append("div").style("background","-webkit-linear-gradient(to right, "+e+", "+d+")").style("background","-o-linear-gradient(to right, "+e+", "+d+")").style("background","-moz-linear-gradient(to right, "+e+", "+d+")").style("background","linear-gradient(to right, "+e+", "+d+")").style("display","inline-block").style("height","7px").style("width",m+"px").style("margin","0 7px"),
o.append("span").text(persian(d3.format(h.formatString)(g||100),j)),b.chartProp.info.showChart&&b.chartProp.info.showChartLegend||i.on("click",function(){c&&$(c).trigger("legendClick",[l,0,{key:a.series.labels[0]}])}),i}function g(c){return b.chartProp.series[a.series.labels[c]]}function h(c,d,e){if(c==-1)return app.chartCommons.tooltip.tooltipFormatter({points:[{data:"NaN",label:"-",format:","}],key:e,sum:"NaN",avg:"NaN",format:",.2f"},b.chartProp.info.tooltipHeader,b.chartProp.info.tooltipFormat,j);var f=a.series.data[c];if(1===d){var h=k.indexOf(b.chartProp.info.mainSeries);f=[{data:f[h],index:h}]}else f=2===d?f.filter(function(a,b){return!g(b).hidden}).map(function(a,b){return{data:a,index:b}}):f.map(function(a,b){return{data:a,index:b}});return f=f.map(function(b,c){return{data:b.data,label:g(b.index).name||a.seriesLablesCaptions[b.index],format:g(b.index).formatString}}),app.chartCommons.tooltip.tooltipFormatter({points:f,key:e,sum:d3.sum(f,function(a){return a.data}),avg:d3.sum(f,function(a){return a.data})/f.length,format:f.length>0?f[0].format:",.2f"},b.chartProp.info.tooltipHeader,b.chartProp.info.tooltipFormat)}function i(a,c){app.chartCommons.setFilterParameter(b),b.parameters.filterHierarchy=app.chartCommons.getFilterHierarchy(b.ChartInPageId),b.editMode&&(b.parameters.ChartInfo=$("#divChart").data("chartInfo")),b.chartProp.info.showLatLng=b.chartProp.info.showLatLng||{},b.chartProp.info.showLatLng.bounds=a.getBounds(),b.chartProp.info.showLatLng.zoomLevel=a.getZoom();var d=+b.chartProp.info.showLatLng.startZoom<=b.chartProp.info.showLatLng.zoomLevel,e=!b.chartProp.info.showLatLng.enable||!d||!b.chartProp.info.showLatLng.disableMap;if(e?(a.addLayer(b.geo),_.each(r,function(b){a.removeLayer(b)})):(a.removeLayer(b.geo),c.selectAll("*").remove()),b.chartProp.info.showLatLng.enable&&!(+b.chartProp.info.showLatLng.startZoom>b.chartProp.info.showLatLng.zoomLevel)){var f=(Math.sin(Math.PI*b.chartProp.info.showLatLng.bounds._southWest.lat/180),Math.sin(Math.PI*b.chartProp.info.showLatLng.bounds._northEast.lat/180),$.extend(b.parameters,{chartId:b.chartId,type:b.dataType,mapModel:b.chartProp.info.showLatLng})),g=JSON.stringify(f),h=app.mobileMode?proxy.ajax:$.ajax;clearTimeout(q),q=setTimeout(function(){app.charts.map.symbolRequest=app.charts.map.symbolRequest||{};var c=app.charts.map.symbolRequest[b.ChartInPageId];c&&c.abort();var d=h({url:app.urlPrefix+"api/map/getSymbols",type:"POST",dataType:"json",contentType:"application/json",data:g,async:b.async,requestId:b.requestId,success:function(c){_.each(r,function(b){a.removeLayer(b)}),a.on("popupopen",function(a){}),a.on("popupclose",function(a){}),_.each(c.series.data,function(d){var e=c.series.labels,f=app.chartCommons.indicator.getIndicator(d,e,b.chartProp.indicator),g=_.flatten(f),h=b.chartProp.info.showLatLng.color||"#ffc107";if(g.length>0){var i=_.filter(g,{operand:"7"}),j=_.first(i);if(!j)return null;h=j.symbolColor}var k=c.series.labels.indexOf(b.chartProp.info.showLatLng.inCircleKpi),l=c.series.labels.indexOf(b.chartProp.info.showLatLng.popupKpi);k===-1&&(k=2),l===-1&&(l=2);var m=0;d[k]&&(m=d[k].toString().length),width=19+6*m;var n=function(a,b){var c=$("<div/>"),d=$("<div/>");return d.attr("class","ltr").html(b).css("font-family",a.fontName).css("font-size",a.fontSize).css("text-align",a.align).css("color",a.color).css("font-weight",a.bold?"bold":"normal").css("font-style",a.italic?"italic":"normal"),c.append(d),c.html()},o=function(a,b){if(!a)return",.2f";var c=a;if(!a.formatString){if(!b)return",.2f";c=b}return"custom"!==c.formatString?c.formatString:c.formatStringCustom},p=n(b.chartProp.info.showLatLng.inCircleFont,'<div style="background: '+h+";width: "+width+"px;height: "+width+"px;border-radius: "+width/2+'px;display: flex;align-items: center;justify-content: center;">'+persian(d3.format(o(b.chartProp.info.showLatLng.inCircleFont))(d[k]))+"</div>"),q=L.divIcon({className:"my-div-icon",html:p}),s=L.marker([+d[1],+d[0]],{icon:q}).addTo(a);if(r.push(s),+d[2]){var t="";b.chartProp.info.showLatLng.popupPrefix&&(t=b.chartProp.info.showLatLng.popupPrefix+"<br/>");var u=c.series.labels[l];u&&(t=t+u+"<br/>");var v=persian(d3.format(o(b.chartProp.info.showLatLng.popupFont))(d[l])),w=n(b.chartProp.info.showLatLng.popupFont,t+v),x={maxWidth:"400",width:"200",className:"popupCustom"};s.bindPopup(w,x),s.on("mouseover",function(a){s.openPopup()}),s.on("mouseout",function(a){s.closePopup()})}})}});app.charts.map.symbolRequest[b.ChartInPageId]=d},400)}}b.input=a,app.chartCommons.calculateFields(a.series,b.calculatedFields);var j=(a.title,a.chartInfo,"undefined"==typeof a.lang||0==+a.lang),k="undefined"!=typeof a.series?a.series.labels:[],l="undefined"!=typeof a.kpis?a.kpis.labels:[],m="#"+b.id,n=+b.chartProp.info.tooltip||1,o=(d3.scaleOrdinal(d3.schemeCategory10),d.isProgress,d.showProgress,d.title,b.chartProp.info.openDashboard&&b.chartProp.info.openDashboard.checked);if(app.chartCommons.setDefault(b.chartProp,l.concat(k),"map"),b.editMode&&$(m).trigger("chartproperty",[l.concat(k)]),!a.result)return void $("#"+b.id).append(app.chartCommons.getError(a));if(!a.matrix||0==a.matrix.length)return void d3.select(m).append("div").attr("class","temporal").style("font-size","0.8em").style("margin","15px").append("span").attr("class","translate").attr("data-trans-key","داده‌ای برای نمایش وجود ندارد").text("داده‌ای برای نمایش وجود ندارد");var p=b.chartProp.info.map.selectedMap;"undefined"!=typeof b.map&&p===b.map.id?e(b.map.data):(d3.select(m+"").append("div").style("padding","15px").attr("class","temporal info").text("در حال بارگذاری نقشه ..."),$.ajax({url:app.urlPrefix+"api/Map/Get?Id="+p+"&v="+m,cache:!0,type:"GET",success:function(a){a.result?(b.map=a.map,b.map.id=p,e(a.map.data)):d3.select(m+" .info").text("نقشه انتخاب شده معتبر نیست. در منوی تنظیمات یک نقشه را انتخاب کنید یا نقشه‌ی مورد نظر خود را بارگذاری نمایید.")}}));var q,r=[]};var app=app||{};app.charts=app.charts||{},app.charts.pie={},app.charts.pie.draw=function(a,b,c,d){function e(a,c){var d=b.chartProp.info.dimColor=b.chartProp.info.dimColor||{};if(d.enable){var e=d.data[a.value.join("-")];return e=e||{},e.color||x(c)}return x(c)}function f(){function c(){var a=Math.min(n,k)/2,c=+b.chartProp.info.hole/100*a,d=d3.arc().innerRadius(c).outerRadius(a),e=d3.arc().innerRadius(1.1*a).outerRadius(1.1*a);return{radius:a,arc:d,arcText:e}}function d(a){return a.startAngle+(a.endAngle-a.startAngle)/2}function f(c,d,e){return O?void app.chartCommons.commentUtils.clickOnCommentIcon(d,b.ChartInPageId):(b.chartProp.globalvariable&&b.chartProp.globalvariable.length>0&&!b.editMode&&(app.globalVariableHelper.updateGlobalVariables([a.CurrentDimName],[d.data.value],b.chartProp.globalvariable),$(m+" path.selected-item").attr("class",$(this).attr("class").replace("selected-item","")),$(this).attr("class",$(this).attr("class")+" selected-item")),""==d.data.onClickVal?void(s&&!b.editMode&&app.chartCommons.openLink(b.chartProp.info.openDashboard,{ChartInPageId:b.ChartInPageId,DataSourceId:b.input.DataSourceId,dimensionName:b.input.dimensionName,value:d.value,refreshDatasource:b.input.RefreshDatasource})):void(q()||(r(!0),app.chartCommons.drillDown.add(b.ChartInPageId,b.input.DataSourceId,b.input.CurrentDimName,d.category,b.input),b.parameters={selectedItem:d.data.onClickVal,chartId:b.chartId,ChartInPageId:b.ChartInPageId,notEditMode:!b.editMode},app.chartCommons.levelTypeUtils.getParam(b),$(m).charts(b.type,"refreshWithData",b))))}function j(a){return{left:a.pos[0]-("start"===a.anchor?a.box.width:0),right:a.pos[0]+("start"===a.anchor?0:a.box.width),top:a.pos[1],bottom:a.pos[1]+a.box.height}}console.log("#### renderPie");var k=0;if(app.dashboardLayoutVersion=app.dashboardLayoutVersion||2,2===app.dashboardLayoutVersion){var u=$(m+" .title").outerHeight()||0,v=$(m+" .legend-bar"),x="undefined"==typeof v?0:v.outerHeight(!0);k=$(m).height()-u-x}else 1==app.dashboardLayoutVersion&&(n=o,n>300&&(n=300));var z=A.append("svg").attr("class","temporal").attr("width",n).attr("height",k),C=c(),D=C.radius;B=C.arc;var E=C.arcText;z.append("svg:rect").attr("class","background").style("fill","white").style("opacity","0").attr("width",n).attr("height",k).on("click",function(c,d,e){""!=a.levels&&(q()||(r(!0),b.parameters={isUp:!0,chartId:b.chartId,ChartInPageId:b.ChartInPageId,notEditMode:!b.editMode},app.chartCommons.drillDown.up(b.ChartInPageId),app.chartCommons.levelTypeUtils.getParam(b),$(m).charts(b.type,"refreshWithData",b)))}).on("mouseout",i);var F=z.append("g").attr("transform","translate("+n/2+","+k/2+")"),G=d3.pie().value(y);b.chartProp.info.sort||(G=G.sort(null));var H=F.datum(t).selectAll("path").data(G).enter();_.each(H._groups[0],function(a){a.__data__.category=a.__data__.data.series[0].category,a.__data__.seriesLable=a.__data__.data.series[0].seriesLable,a.__data__.seriesKey=a.__data__.data.series[0].seriesKey,a.__data__.commentCount=a.__data__.data.series[0].commentCount});var I=null;if(l){var J,K=0,L=0;F.append("g").attr("class","labels"),I=F.select(".labels").selectAll("text").data(G).enter().append("text"),I.attr("class",function(a,b){return""!=a.data.onClickVal||M||s?"label pointer":" label"}).attr("id",function(a,b){return"l-"+b}).attr("dy",".35em").text(function(a,c){var d=[];return b.chartProp.info.showLabels&&d.push(persian(a.data.label,p)),b.chartProp.info.showValues&&d.push(persian(d3.format(b.chartProp.info.legendFont.formatString)(a.value),p)),b.chartProp.info.showValuesPercent&&d.push(persian(d3.format(",.2f")(100*a.value/w),p)+"%"),d.join(" - ")}).styles({direction:"rtl","font-size":b.chartProp.info.legendFont.fontSize}).on("click",f).on("mouseover",h).on("mousemove",h).each(function(a){var b=d(a)>=Math.PI?"left":"right",c=this.getBBox();J=c.height,"left"==b?K<c.width&&(K=c.width):L<c.width&&(L=c.width)}),n=n-L-K-40,n<70&&(n=70),k-=2*J,C=c(),D=C.radius,B=C.arc,E=C.arcText}var M=b.chartProp.globalvariable&&b.chartProp.globalvariable.length>0&&!b.editMode&&b.chartProp.globalvariable.filter(function(b){return b.field==a.CurrentDimName}).length>0,N=H.append("g").classed("part",!0);N.append("path").attr("class",function(a,b){return""!=a.data.onClickVal||M||s?"arc pointer":" arc"}).attr("title","").attr("fill",function(a,b){return e(a.data,b)}).attr("d",B).each(function(a){this._current=a.data.series[0].data}).on("click",f).on("mouseover",h).on("mousemove",h);var O=$(m).hasClass("fromCommentDialog");if(app.chartCommons.commentUtils.addCommentIcon(b.ChartInPageId,N,function(a){return B.centroid(a)[0]},function(a){return B.centroid(a)[1]}),O&&app.chartCommons.commentUtils.setOnHighlightListener(N,b.ChartInPageId),l){var P=[];I.attr("transform",function(a,b){var c=E.centroid(a);return c[0]=1.1*D*(d(a)<Math.PI?1:-1),P[b]={pos:c,box:this.getBBox(),data:a.data.label[0]},"translate("+c+")"}).style("text-anchor",function(a,b){return P[b].anchor=d(a)>=Math.PI?"start":"end",d(a)>=Math.PI?"start":"end"}).style("display",function(a){var b=d3.select(this),c=(g(b.attr("transform")),"start"===b.style("text-anchor")?1:-1,this.getBBox(),"auto");return c});var Q=_.extend({enable:!1},b.chartProp.info.showLabelMatrix);if(console.log("### showMatrix ",_.merge({},Q)),Q.enable)_.each(P,function(a){var b=Q.data[a.data]||{check:!1};a.hide=!b.check});else for(var R=0;R<P.length-1;R++)for(var S=P[R],T=R+1;T<P.length;T++){var U=P[T];if(U.hide!==!0){var V=j(S),W=j(U),X=Math.max(V.left,W.left),Y=Math.min(V.right,W.right),Z=Math.min(V.bottom,W.bottom),aa=Math.max(V.top,W.top);X<Y&&Z>aa&&(U.hide=!0)}}I.style("display",function(a,b){return P[b].hide===!0?"none":"auto"}),F.append("g").attr("class","lines");var ba=F.select(".lines").selectAll("polyline").data(G).enter().append("polyline");ba.attr("points",function(a,b){this._current=this._current||a;var c=d3.interpolate(this._current,a);this._current=c(0);var e=E.centroid(a);return e[0]=1*D*(d(a)<Math.PI?1:-1),[B.centroid(a),E.centroid(a),e]}).style("display",function(a,b){return $(m+" #l-"+b).css("display")})}}function g(a){var b=document.createElementNS("http://www.w3.org/2000/svg","g");b.setAttributeNS(null,"transform",a);var c,d,e,f=b.transform.baseVal.consolidate().matrix,g=f.a,h=f.b,i=f.c,j=f.d,k=f.e,l=f.f;return(c=Math.sqrt(g*g+h*h))&&(g/=c,h/=c),(e=g*i+h*j)&&(i-=g*e,j-=h*e),(d=Math.sqrt(i*i+j*j))&&(i/=d,j/=d,e/=d),g*j<h*i&&(g=-g,h=-h,e=-e,c=-c),{translateX:k,translateY:l,rotate:Math.atan2(h,g)*Math.PI/180,skewX:Math.atan(e)*Math.PI/180,scaleX:c,scaleY:d}}function h(a,c){var d=[0,0];d=d3.pointer(a);var e=d[0]+7,f=d[1]+7;e=a.offsetX+7,f=a.offsetY+7;var g=(B.centroid(c),c.data.series),h=+b.chartProp.info.tooltip||1;1==h&&(g=[g[0]]),2==h&&(g=g.filter(function(a){return!a.prop.hidden})),g=g.map(function(a,c){return{data:a.data,label:a.prop.name||a.label,format:b.chartProp.info.formatString,color:a.prop.seriesColor,percentage:100*a.data/w[c]}});var i=app.chartCommons.tooltip.tooltipFormatter({points:g,key:c.data.label,sum:d3.sum(c.data.series,function(a){return a.data}),avg:d3.sum(c.data.series,function(a){return a.data})/c.length,format:c.length>0?c[0].format:",.2f"},b.chartProp.info.tooltipHeader,b.chartProp.info.tooltipFormat,p);D.html(i),D.style("opacity",1).style("left",e+"px").style("top",f+"px")}function i(a){D.transition().duration(500).style("opacity",1e-6).end().then(function(){D.style("left","0px").style("top","0px")})}b.input=a,app.chartCommons.calculateFields(a.series,b.calculatedFields);var j=(a.title,a.chartInfo,"undefined"!=typeof a.series?a.series.labels:[]),k="undefined"!=typeof a.kpis?a.kpis.labels:[],l=b.chartProp.info.showLabels||b.chartProp.info.showValues||b.chartProp.info.showValuesPercent,m=(b.LabelY,"#"+b.id),n=$(m).width(),o=($(m).height(),"small"==b.chartProp.info.chartSize?150:"medium"==b.chartProp.info.chartSize?200:"large"==b.chartProp.info.chartSize?250:"veryLarge"==b.chartProp.info.chartSize?400:130);b.width=n;var p="undefined"==typeof a.lang||0==+a.lang,q=d.isProgress,r=d.showProgress,s=(d.title,b.chartProp.info.openDashboard&&b.chartProp.info.openDashboard.checked);if(app.chartCommons.setDefault(b.chartProp,k.concat(j),"pie"),b.editMode&&($(m).trigger("chartproperty",[k.concat(j)]),$(m).trigger("dimColor",[_.map(a.matrix,function(a){return a.values.join("-")})])),!a.result)return void $("#"+b.id).append(app.chartCommons.getError(a));$(m).addClass("pie-chart");var t=prepareData(a),u=a.seriesLablesCaptions,v=a.kpisLablesCaptions;d3Utils.prepareDataForBarChart(t,b,j,k,u,v);var w=0==t.length?[1]:t[0].series.map(function(a,b){return d3.sum(t.map(function(a){return a.series[b].data}))}),x=d3.scaleOrdinal(d3.schemeCategory10);switch(+b.chartProp.info.colorType){case 2:x=d3.scaleOrdinal(d3.schemeBrBG[11]);break;case 3:x=d3.scaleOrdinal(d3.schemePuOr[11]);break;case 4:x=d3.scaleOrdinal(d3.schemeRdGy[11])}var y=function(a){var b=a.series.filter(function(a){return"series"===a.type&&a.prop.main});return b.length>0?b[0].data:a.series.filter(function(a){return"series"===a.type})[0].data},z=d3.select(m).append("div").attr("class","legend-bar temporal");z.breadcrumb(a.levels,b,d,p),b.chartProp.info.showLabels?z.append("div").attr("class","legendBar"):(z.legend({width:n,font:b.chartProp.info.legendFont,position:b.chartProp.info.legendPosition,selector:m,data:t.map(function(a,b){var c=a.series.filter(function(a){return"series"===a.type&&a.prop.main}),d=null;d=c.length>0?c[0]:a.series.filter(function(a){return"series"===a.type})[0];var f={label:a.label.join(", "),color:e(a,b)};return f})},p),z.style("margin-bottom","12px"));var A=null;A=_.indexOf(["bottom left","bottom right","bottom center"],b.chartProp.info.legendPosition)!=-1?d3.select(m).insert("div",":first-child").attr("class","temporal").style("position","relative"):d3.select(m).append("div").attr("class","temporal").style("position","relative");var B,C=!1;app.mobileMode?f():"loading"===document.fonts.status?(app.charts.pie.fontCallback=app.charts.pie.fontCallback||[],app.charts.pie.fontCallback.push(function(){C||(C=!0,f())}),document.fonts.onloadingdone=function(a){_.each(app.charts.pie.fontCallback,function(a){a&&a()})}):f();var D=A.append("div").style("position","absolute").style("color","#fff").style("-moz-border-radius","5px").style("-webkit-border-radius","5px").style("border-radius","5px").style("padding","7px 15px").style("text-align","right").style("z-index","10").style("opacity","0").style("background-color","#000");$(m).trigger("heightChange")};var app=app||{};app.charts=app.charts||{},app.charts.radar={},app.charts.radar.draw=function(a,b,c,d){b.input=a,app.chartCommons.calculateFields(a.series,b.calculatedFields);var e=(a.title,a.chartInfo,"undefined"==typeof a.lang||0==+a.lang),f="undefined"!=typeof a.series?a.series.labels:[],g="undefined"!=typeof a.kpis?a.kpis.labels:[],h="#"+b.id,i={top:10,right:20,bottom:0,left:20},j=("small"==b.chartProp.info.chartSize?180:"medium"==b.chartProp.info.chartSize?250:"large"==b.chartProp.info.chartSize?400:"veryLarge"==b.chartProp.info.chartSize?600:130,b.chartProp.info.openDashboard&&b.chartProp.info.openDashboard.checked),k=$(h).width(),l=$(h).height()-i.top-i.bottom;d3.scaleOrdinal(d3.schemeCategory10);b.width=k;var m=d.isProgress,n=d.showProgress;d.title;if($(h).addClass("radar-chart"),app.chartCommons.setDefault(b.chartProp,g.concat(f),"radar"),b.editMode&&$(h).trigger("chartproperty",[g.concat(f)]),!a.result)return void $("#"+b.id).append(app.chartCommons.getError(a));for(var o=prepareData(a),p=0;p<o.length;p++)for(var q=0;q<o[p].series.length;q++)b.chartProp.series[f[q]].cumulative&&(o[p].series[q]+=o[p-1]?o[p-1].series[q]:0);var r=d3.select(h).append("div").attr("class","legend-bar temporal");if(r.breadcrumb(a.levels,b,d,e),!a.matrix||0==a.matrix.length)return void d3.select(h).append("div").attr("class","temporal").style("font-size","0.8em").style("margin","15px").append("span").attr("class","translate").attr("data-trans-key","داده‌ای برای نمایش وجود ندارد").text("داده‌ای برای نمایش وجود ندارد");var s=a.seriesLablesCaptions,t=a.kpisLablesCaptions;d3Utils.prepareDataForBarChart(o,b,f,g,s,t),r.legend({width:k,selector:h,data:o[0].series.filter(function(a){return!a.prop.hidden}).map(function(a){return{label:(a.prop.name||a.label).replace(/^\[measure\]/,""),color:a.prop.seriesColor,key:a.key}})},e);var u=$(h+" .title").outerHeight()||0,v=$(h+" .legend-bar"),w="undefined"==typeof v?0:v.height()+ +v.css("margin-top").replace("px","");l=$(h).height()-u-w,l<150&&(l=150);var x=_.extend({bold:!1,color:"#737373",italic:!1,fontSize:"10px",fontName:"IRANSans",formatString:b.chartProp.info.formatString||",.2f",formatStringCustom:",.2f"},b.chartProp.info.font),y=function(){var c=b.chartProp.info.labelWidth||100,d={radius:4,w:600,h:600,factor:1,factorLegend:.85,levels:6,maxValue:0,radians:2*Math.PI,opacityArea:.5,ToRight:5,TranslateX:0,TranslateY:0,ExtraWidthX:0,ExtraWidthY:0,color:d3.scaleOrdinal(d3.schemeCategory10)},f=d3.select(h).append("div").attr("class","temporal").style("position","relative").style("margin","0 auto").style("text-align","left"),g=o.map(function(a,b){return a.label}),i=g.length,p=0,q=f.selectAll(".axis-label").data(g).enter().append("div").text(function(a){return persian(a,e)}).attr("class","axis-label").style("width",c+"px").style("font-size","11px").style("padding","5px").style("text-overflow","ellipsis").style("white-space","nowrap").style("text-align",function(a,b){return p=$(this).outerHeight()||0,"right"});q.remove(),d.h=Math.min(l-2*p,k-2*c),d.w=d.h,d.maxValue=Math.max(d.maxValue,d3.max(o,function(a){return d3.max(a.series.filter(function(a,b){return!a.prop.hidden}).map(function(a){return a.data}))}));var r=d.factor*Math.min(d.w/2,d.h/2);d3.format("%");f.style("height",d.h+2*p+"px"),f.style("width",d.w+2*c+"px");var s=f.append("div"),t=s.append("svg"),u=f.append("div").classed("labels",!0).selectAll(".axis-label").data(g).enter().append("div").text(function(a){return persian(a,e)}).attr("title",function(a){return a}).attr("class","axis-label").style("width",c+"px").style("position","absolute").style("font-size","11px").style("padding","5px").style("text-overflow","ellipsis").style("white-space","nowrap").style("overflow","hidden").style("text-align",function(a,b){var c=d.w/2*(1-d.factor*Math.sin(b*d.radians/i)),e="right";return c>=d.w/2&&(e="left"),e}),p=0;u.style("left",function(a,b){var e=d.w/2*(1-d.factor*Math.sin(b*d.radians/i));return e>=d.w/2&&(e+=c),e+"px"}).style("top",function(a,b){var c=$(d3.select(this).node()).outerHeight()||0;p=c;var e=d.h/2*(1-d.factor*Math.cos(b*d.radians/i));return e+=c/2,0==b&&(e=0),e+"px"});var v=p;s.style("left",c+"px").style("position","absolute").style("top",v+"px");var w,y=t.attr("width",d.w).attr("height",d.h).append("g").attr("transform","translate("+d.TranslateX+","+d.TranslateY+")"),z=function(){var a=y.append("g").attr("class","axies").selectAll(".axis").data(g).enter().append("g").attr("class","axis");a.append("line").attr("x1",d.w/2).attr("y1",d.h/2).attr("x2",function(a,b){return d.w/2*(1-d.factor*Math.sin(b*d.radians/i))}).attr("y2",function(a,b){return d.h/2*(1-d.factor*Math.cos(b*d.radians/i))}).attr("class","line").style("stroke","grey").style("stroke-width","1px");for(var b=y.append("g").classed("values",!0),c=0;c<d.levels-1;c++){var f=d.factor*r*((c+1)/d.levels);b.selectAll(".levels").data(g).enter().append("svg:line").attr("x1",function(a,b){return f*(1-d.factor*Math.sin(b*d.radians/i))}).attr("y1",function(a,b){return f*(1-d.factor*Math.cos(b*d.radians/i))}).attr("x2",function(a,b){return f*(1-d.factor*Math.sin((b+1)*d.radians/i))}).attr("y2",function(a,b){return f*(1-d.factor*Math.cos((b+1)*d.radians/i))}).attr("class","line").style("stroke","grey").style("stroke-opacity","0.75").style("stroke-width","0.3px").attr("transform","translate("+(d.w/2-f)+", "+(d.h/2-f)+")")}for(var c=0;c<d.levels;c++){var f=d.factor*r*((c+1)/d.levels);b.selectAll(".levels").data([1]).enter().append("svg:text").attr("x",function(a){return f*(1-d.factor*Math.sin(0))}).attr("y",function(a){return f*(1-d.factor*Math.cos(0))}).attr("class","legend").style("font-size",x.fontSize).style("font-family",x.fontName).attr("dy","1em").attr("transform","translate("+(d.w/2-f+d.ToRight)+", "+(d.h/2-f)+")").attr("fill",x.color).text(persian(d3.format(x.formatString)((c+1)*d.maxValue/d.levels),e))}};series=0;var A=o[0].series.filter(function(a,b){return!a.prop.hidden});A.forEach(function(a,b){function c(a){var c="undefined"==typeof A[b].prop.areaOpacity?d.opacityArea:A[b].prop.areaOpacity;return e.match(/area/gi)||(c=0),c}if(!a.prop.hidden){dataValues=[],y.selectAll(".nodes").data(o,function(a,c){dataValues.push([d.w/2*(1-parseFloat(Math.max(a.series.filter(function(a,b){return!a.prop.hidden})[b].data,0))/d.maxValue*d.factor*Math.sin(c*d.radians/i)),d.h/2*(1-parseFloat(Math.max(a.series.filter(function(a,b){return!a.prop.hidden})[b].data,0))/d.maxValue*d.factor*Math.cos(c*d.radians/i))])}),dataValues.push(dataValues[0]);var e=A[b].prop.lineType;e||(e="line-dot-area"),y.selectAll(".area").data([dataValues]).enter().append("polygon").attr("class","radar-chart-serie"+series).style("stroke-width",function(a){var c=A[b].prop.lineWeight||2;return e.match(/line/gi)||(c=0),c+"px"}).style("stroke",A[b].prop.seriesColor).attr("points",function(a){for(var b="",c=0;c<a.length;c++)b=b+d.w/2+","+d.h/2+" ";return b}).style("fill",function(a,c){return A[b].prop.seriesColor}).style("fill-opacity",c).on("mouseover",function(a){}).on("mouseout",function(){}).transition(500).attr("points",function(a){for(var b="",c=0;c<a.length;c++)b=b+a[c][0]+","+a[c][1]+" ";return b}),series++}}),z(),series=0;var B=b.chartProp.globalvariable&&b.chartProp.globalvariable.length>0&&!b.editMode&&b.chartProp.globalvariable.filter(function(b){return b.field==a.CurrentDimName}).length>0;_.each(o,function(a){});var C=A.map(function(a,b){return o.map(function(a){var c=a.series.filter(function(a,b){return!a.prop.hidden})[b];return c.onClickVal=a.onClickVal,c})}),D=y.selectAll(".entry-group").data(C).enter().append("g").classed("entry-group",!0),E=D.selectAll(".entry-group").data(function(a){return a}).enter().append("g").classed("entry",!0),F=$(h).hasClass("fromCommentDialog");E.append("svg:circle").attr("class",function(a,b){return"radar-chart-serie"+b+" "+(""!=a.onClickVal||B||j?" pointer":"")}).classed("circle",!0).attr("r",d.radius).attr("alt",function(a){return d3.format(x.formatString)(a.data)}).attr("cx",function(a,b){return d.w/2}).attr("cy",function(a,b){return d.h/2}).attr("data-id",function(a){return a.axis}).style("fill","#fff").style("stroke",function(a){return a.prop.seriesColor}).style("stroke-width","2px").style("opacity",function(a){var b=a.prop.lineType;return b||(b="line-dot-area"),"line-area"===b||"line"===b?0:1}).on("click",function(c,d,e){return F?void app.chartCommons.commentUtils.clickOnCommentIcon(d,b.ChartInPageId):(b.chartProp.globalvariable&&b.chartProp.globalvariable.length>0&&!b.editMode&&(app.globalVariableHelper.updateGlobalVariables([a.CurrentDimName],[d.value],b.chartProp.globalvariable),$(h+" circle.selected-item").attr("class",$(this).attr("class").replace("selected-item","")),$(this).attr("class",$(this).attr("class")+" selected-item")),""==d.onClickVal?void(j&&!b.editMode&&app.chartCommons.openLink(b.chartProp.info.openDashboard,{ChartInPageId:b.ChartInPageId,DataSourceId:b.input.DataSourceId,dimensionName:b.input.dimensionName,value:d.category,refreshDatasource:b.input.RefreshDatasource})):void(m()||(n(!0),b.parameters={selectedItem:d.onClickVal,chartId:b.chartId,ChartInPageId:b.ChartInPageId,notEditMode:!b.editMode},app.chartCommons.drillDown.add(b.ChartInPageId,b.input.DataSourceId,b.input.CurrentDimName,d.onClickVal,b.input),app.chartCommons.levelTypeUtils.getParam(b),$(h).charts(b.type,"refreshWithData",b))))}).on("mouseover",function(a){newX=parseFloat(d3.select(this).attr("cx")),newY=parseFloat(d3.select(this).attr("cy")),console.log(a.category,newX,newY),w.transition(),w.style("left",newX+c+5+"px").style("top",newY-5+"px").html(filterXSS(a.category.join(", ")+"<br/> <b>"+a.label+": </b>"+persian(d3.format(x.formatString)(a.data),e))).transition(200).style("opacity",1);var b=($(w._groups[0]).width(),$(w._groups[0]).height());w.style("top",newY+b/2+"px")}).on("mouseout",function(a){console.log(a.category,"## out"),w.transition().duration(200).style("opacity",1e-6).end().then(function(){w.style("left",0).style("top",0)})["catch"](function(a){console.log(a)})}).transition(500).attr("cx",function(a,b){return d.w/2*(1-Math.max(a.data,0)/d.maxValue*d.factor*Math.sin(b*d.radians/i))}).attr("cy",function(a,b){return d.h/2*(1-Math.max(a.data,0)/d.maxValue*d.factor*Math.cos(b*d.radians/i))}),app.chartCommons.commentUtils.addCommentIcon(b.ChartInPageId,E,function(a,b){return d.w/2*(1-Math.max(a.data,0)/d.maxValue*d.factor*Math.sin(b*d.radians/i))-5},function(a,b){return d.h/2*(1-Math.max(a.data,0)/d.maxValue*d.factor*Math.cos(b*d.radians/i))-24}),F&&app.chartCommons.commentUtils.setOnHighlightListener(E,b.ChartInPageId),w=f.append("div").attr("class","tooltip").style("position","absolute").style("color","#fff").style("-moz-border-radius","5px").style("-webkit-border-radius","5px").style("border-radius","5px").style("padding","7px 15px").style("text-align","right").style("z-index","1000").style("opacity","0").style("background-color","#000").style("max-width","200px").style("opacity",0).style("font-size","13px")};y(),$(h).trigger("heightChange")};var app=app||{};app.charts=app.charts||{},app.charts.text={},app.charts.text.draw=function(a,b,c,d){b.input=a,app.chartCommons.calculateFields(a.series,b.calculatedFields);var e=(a.title,a.chartInfo,"undefined"!=typeof a.series?a.series.labels:[]),f="undefined"!=typeof a.kpis?a.kpis.labels:[],g=(b.LabelY,"#"+b.id),h=$(g).width();$(g).height(),"small"==b.chartProp.info.chartSize?150:"medium"==b.chartProp.info.chartSize?200:"large"==b.chartProp.info.chartSize?250:"veryLarge"==b.chartProp.info.chartSize?400:130;b.width=h;"undefined"==typeof a.lang||0==+a.lang,d.isProgress,d.showProgress,d.title;if(b.editMode&&$(g).trigger("chartproperty",[f.concat(e)]),!a.result)return void $("#"+b.id).append(app.chartCommons.getError(a));$(g).addClass("tree-chart").css("text-align","right");var i=$(g+" .title").outerHeight(),j=$(g).outerHeight()-i-2,k=d3.select(g).append("ul").attr("class","root-node temporal tree").text("");k.style("height",j+"px"),$(g).append(b.chartProp.info.html)};var chartUtils=chartUtils||{};chartUtils.enableNewCharts=!0,chartUtils.chartsId={funnel:{type:20,extendTypes:[{type:42,name:"Funnel",iconLink:app.urlPrefix+"images/chart-icons/funnel.png"}]},fitLine:{type:21,extendTypes:[{type:43,name:"عدد همراه با سابقه",iconLink:app.urlPrefix+"images/chart-icons/trend-line.png"}]},image:{type:22,extendTypes:[{type:44,name:"تصویر",iconLink:app.urlPrefix+"images/chart-icons/image.png"}]}},chartUtils.getFormatString=function(a,b){return b||(b=",.2f"),a?(a.formatString||(a.formatString=b),"custom"!==a.formatString?a.formatString:a.formatStringCustom):b},chartUtils.renderLegendForBar=function(a,b,c,d,e,f,g){var h=d3.select(a.selector+" .lgb");h.empty()&&(h=d3.select(a.selector).append("div").attr("class","lgb"));var i=h.append("div").attr("class","legend-bar temporal");return i.breadcrumb(c.levels,a,d,!0),!!chartUtils.checkEmtryResult(c,i)||(g||(a.chartProp.general.showLegends||"undefined"==typeof a.chartProp.general.showLegends)&&i.legend({display:!1,width:e,font:a.chartProp.general.legendFont,position:a.chartProp.general.legendPosition,selector:a.selector,data:b.filter(function(a,b){return!a.sadafInfo.prop.hidden}).map(function(a){return{label:a.sadafInfo.prop.name||a.label,color:a.sadafInfo.prop.color,key:a.sadafInfo.seriesLabel,sIndex:a.sadafInfo.index}}),click:function(b){if(!a.editMode){var c=$(a.selector+" canvas").data("chart");Chart.defaults.global.legend.onClick.call(c.legend,d3.event,{datasetIndex:b.sIndex,text:b.key})}}},f),void(g||a.chartProp.indicatorLegendShow&&i.legend({order:"horizental",width:e,font:a.chartProp.indicatorLegendFont,position:a.chartProp.general.legendPosition,selector:selector,data:_.map(a.chartProp.indicator,function(b,d){var e=_.find(b.thenRow,{operand:"1"}),f=e?e.secondFieldColor:"#eeeeee",g=b.title||app.chartCommons.indicator.ifToString(b.ifRow,c.series.labels,c.seriesLablesCaptions,a);return{label:g,color:f}})},f)))},chartUtils.onClickCalback=function(a,b,c,d){d=d||{};var e=d.isProgress||function(){},f=d.showProgress||function(){};if(a.chartProp.globalvariable&&a.chartProp.globalvariable.length>0&&!a.editMode&&(app.globalVariableHelper.updateGlobalVariables([b.CurrentDimName],[c.value],a.chartProp.globalvariable),$(selector+" .gd.selected-item").attr("class",$(this).attr("class").replace("selected-item","")),$(selector+" .circle.selected-item").attr("class",$(this).attr("class").replace("selected-item","")),$(this).attr("class",$(this).attr("class")+" selected-item")),!c.canDrill){var g=a.chartProp.info.openDashboard&&a.chartProp.info.openDashboard.checked;return void(g&&!a.editMode&&app.chartCommons.openLink(a.chartProp.info.openDashboard,{ChartInPageId:a.ChartInPageId,DataSourceId:a.input.DataSourceId,dimensionName:a.input.dimensionName,value:c.values,refreshDatasource:a.input.RefreshDatasource}))}e()||(f(!0),app.chartCommons.drillDown.add(a.ChartInPageId,a.input.DataSourceId,a.input.CurrentDimName,c.values,a.input),a.parameters={selectedItem:c.values,chartId:a.chartId,ChartInPageId:a.ChartInPageId,notEditMode:!a.editMode},app.chartCommons.levelTypeUtils.getParam(a),$(a.selector).charts(a.type,"refreshWithData",a))},chartUtils.drillUp=function(a,b,c){var d=c.isProgress,e=c.showProgress;""!=b.levels&&(d()||(e(!0),app.chartCommons.drillDown.up(a.ChartInPageId),a.parameters={isUp:!0,chartId:a.chartId,ChartInPageId:a.ChartInPageId,notEditMode:!a.editMode},app.chartCommons.levelTypeUtils.getParam(a),$(a.selector).charts(a.type,"refreshWithData",a)))},chartUtils.checkEmtryResult=function(a,b){return(!a.matrix||0==a.matrix.length)&&(b.append("div").attr("class","temporal").style("font-size","0.8em").style("margin","15px").append("span").attr("class","translate").attr("data-trans-key","داده‌ای برای نمایش وجود ندارد").text("داده‌ای برای نمایش وجود ندارد"),
!0)},chartUtils.getPattern=function(){return["#01B8AA","#374649","#FD625E","#F2C80F","#5F6B6D","#8AD4EB","#FE9666","#A66999","#3599B8","#DFBFBF"]},chartUtils.getColorArray=function(a,b){var c=chartUtils.getPattern();if(c.length<a.matrix.length)for(var d=c.length,e=0;e<a.matrix.length-d;e++)c.push(c[(e+d)%d]);var f=b.chartProp.general.dimColor=b.chartProp.general.dimColor||{};return f.enable?a.matrix.map(function(a){var b=f.data[a.captions.join("-")];return b=b||{color:"#efefef"},b.color}):_.take(c,a.matrix.length)},chartUtils.getData=function(a,b,c){function d(c,d){var e=void 0;if(b.chartProp.indicator&&b.chartProp.indicator.length){var f=a.series.data[c],g=a.series.labels,h=app.chartCommons.indicator.getIndicator(f,g,b.chartProp.indicator);_.isArray(h)&&h.length&&_.each(_.flatten(h),function(a){if("1"===a.operand&&a.firstField===d)return void(e=a.secondFieldColor)})}return e}var e=!1,f=!1;return _.map(a.series.labels,function(g,h){function i(a){_.isUndefined(a.color)&&(a.color=chartUtils.getPattern()[h%10]),_.isUndefined(a.borderColor)&&(a.borderColor=a.color);var b=a.fillOpacity||1;return Color(a.color).alpha(b).rgbaString()}"stack"===b.chartProp.general.stack&&(e=!0,f=!1),"stack100"===b.chartProp.general.stack&&(e=!1,f=!0),b.chartProp.series[g]=_.merge({},b.chartProp.series._default,b.chartProp.series[g]);var j=b.chartProp.series[g],k=_.extend({},j.showLabelFont),l=chartUtils.getColorArray(a,b);return{sadafInfo:{index:h,prop:j,seriesLabel:g},hidden:j.hidden,lineTension:"none"===j.lineMode?0:"default"===j.lineMode?.3:.44,backgroundColor:"line"===j.type?i(j):a.matrix.map(function(a,c){_.isUndefined(j.color)&&(j.color=chartUtils.getPattern()[h%10]),_.isUndefined(j.borderColor)&&(j.borderColor=j.color);var e=j.color,f=d(c,g),i=b.chartProp.general.dimColor=b.chartProp.general.dimColor||{};return i.enable&&(e=l[c]),f&&(e=f),e}),type:j.type,fill:j.fill,pointRadius:j.pointRadius,pointBackgroundColor:"white",borderColor:j.borderColor,borderWidth:j.borderWidth,spanGaps:j.spanGaps,steppedLine:"none"!==j.steppedLine&&j.steppedLine,borderDash:"simple"===j.borderDash?null:"dash"===j.borderDash?[5,5]:[5,10],label:j.label||g,data:_.map(a.series.data,function(a){return _.isNull(a[h])?null:+a[h]}),datalabels:{display:!!j.showLabel&&(!j.showLabelAuto||"auto"),offset:0,align:k.position||"end",textAlign:k.align||"center",anchor:k.anchor||"end",rotation:k.rotate||0,formatter:function(a,b){var c=chartUtils.getFormatString(k);f&&(a=b.chart.tooltip._data.calculatedData[b.datasetIndex][b.dataIndex]);var d=persian(d3.format(c)(a),!0);return d},color:k.color||"#000",font:{family:k.fontName,size:(k.fontSize||"").replace("px",""),weight:k.bold?"bold":"normal",style:k.italic?"italic":"normal"},listeners:{click:function(d){console.log("label click ",d),labelClick=!0,chartUtils.onClickCalback(b,a,a.matrix[d.dataIndex],c)}}}}})},chartUtils.format=function(a,b){return null===b?"-":_.isNumber(b)?d3.format(a)(b):b},chartUtils.getFontFromProp=function(a){return a=_.merge({bold:!1,color:"#333333",align:"right",italic:!1,fontSize:"12px",fontName:"IRANSans",formatString:",.2f",formatStringCustom:",.2f",rotate:0,anchor:"end",position:"end"},a),a.fontSize=a.fontSize.replace("px",""),a.bold=a.bold?"bold":"normal",a.italic=a.italic?"italic":"normal",{fontColor:a.color,fontFamily:a.fontName,fontSize:+a.fontSize,fontStyle:a.italic+" "+a.bold}},chartUtils.handleStackLabel=function(a,b){if(a.chartProp.general.stackSumLabel){var c=_.map(b.data.datasets[0].data,function(a,c){return d3.sum(b.data.datasets,function(a){return a.data[c]})}),d=_.extend({},a.chartProp.general.stackSumLabelFont);b.data.datasets.push({sadafInfo:{prop:{}},label:"مجموع",data:_.map(c,function(){return 0}),backgroundColor:"rgba(24,91,62,0)",datalabels:{display:!0,offset:0,align:d.position||"end",textAlign:d.align||"center",anchor:d.anchor||"end",rotation:d.rotate||0,formatter:function(a,b){var e=chartUtils.getFormatString(d);a=c[b.dataIndex];var f=persian(d3.format(e)(a),!0);return f},color:d.color||"#000",font:{family:d.fontName,size:(d.fontSize||"").replace("px",""),weight:d.bold?"bold":"normal",style:d.italic?"italic":"normal"}}});var e=b.options.tooltips.callbacks.label;b.options.tooltips.callbacks.label=function(a,f){if(a.datasetIndex===b.data.datasets.length-1){var g=c[a.index],h=chartUtils.getFormatString(d);return persian("مجموع\t\t\t\t\t"+chartUtils.format(h,g),!0)}return e.call(this,a,f)}}},chartUtils.getChartOption=function(a,b,c,d){function e(c){chartUtils.onClickCalback(b,a,a.matrix[c],d)}var f=!1,g=!1;"stack"===b.chartProp.general.stack&&(f=!0,g=!1),"stack100"===b.chartProp.general.stack&&(f=!1,g=!0);var h=!1,i=_.map(a.matrix,function(a){return a.captions.join(", ")}),j=d3.max(c,function(a){return a.sadafInfo.prop.hidden?-(1/0):d3.max(a.data)}),k=d3.min(c,function(a){return a.sadafInfo.prop.hidden?1/0:d3.min(a.data)});k>0&&(k=0);var l=b.chartProp.general.xfontLabel;b.chartProp.general.xfontLabelDynamic&&(l=a.CurrentDimName.join(""));var m=_.merge({fontSize:"12",fontName:"IRANSans"},b.chartProp.general.tooltipFont);m.fontSize=+m.fontSize.replace("px","");var n=chartUtils.getFontFromProp(b.chartProp.general.legendFont);return{animation:{duration:2e3},type:"line",data:{labels:i,datasets:c},options:{scales:{xAxes:[{offset:!0,stacked:f,scaleLabel:_.merge({display:!!l,labelString:l},chartUtils.getFontFromProp(b.chartProp.general.xfontLabelFont)),ticks:_.merge({callback:function(a,c,d){var e=a,f=b.chartProp.general.xMaxLen||40,g=a;if(b.chartProp.general.xMultiline){for(var h=f;h<g.length;h+=f){var c=g.indexOf(" ",h);c!=-1&&(g=g.substr(0,c)+"\n"+g.substr(c+1))}g=g.split(/\n/)}else e=a?(a+"").substring(0,f):a,g=persian(e,!0);return g}},chartUtils.getFontFromProp(b.chartProp.general.xfont)),gridLines:{display:!!b.chartProp.general.linesVert}}],yAxes:[{stacked:f,gridLines:{display:!!b.chartProp.general.linesHoriz,borderDash:[8,4]},scaleLabel:_.merge({display:!!b.chartProp.general.yfontLabel,labelString:b.chartProp.general.yfontLabel},chartUtils.getFontFromProp(b.chartProp.general.yfontLabelFont)),ticks:_.merge({beginAtZero:!0,suggestedMax:1.11*j,suggestedMin:1.11*k,callback:function(a,c,d){var e=chartUtils.getFormatString(b.chartProp.general.yfont);return persian(d3.format(e)(a),!0)}},chartUtils.getFontFromProp(b.chartProp.general.yfont))}]},elements:{rectangle:{borderWidth:0}},layout:{padding:{top:15}},responsive:!1,plugins:{stacked100:{enable:g,replaceTooltipLabel:!0}},tooltips:{mode:"index",position:"nearest",intersect:!1,bodyFontSize:m.fontSize,titleFontSize:1.1*m.fontSize,bodyFontFamily:m.fontName,bodyFontStyle:m.bold?"bold":"normal",bodyAlign:m.align,titleAlign:"center",bodySpacing:Math.max(2,m.fontSize-10),callbacks:{title:function(a,b){return b.labels[a[0].index]},label:function(a,c){var d=c.datasets.filter(function(a,b){return!a.sadafInfo.prop.hidden}),e=this._options.getValueCallback||function(a){return a},f=this._options.getLabelCallback||function(a){return a},g=this._options.showPercentage,h=a.datasetIndex!==d.length-1;"all"!==b.chartProp.general.tooltipMode&&(h=!0);var i=chartUtils.getFormatString(c.datasets[a.datasetIndex].sadafInfo.prop.tooltipFont);if(h){var j=c.datasets[a.datasetIndex].data[a.index],k=c.datasets[a.datasetIndex].label;j=e(j),k=f(k);var l="";if(g){var m=1*j/d3.sum(c.datasets[a.datasetIndex].data);l="\t\t\t\t\t"+d3.format(".0%")(m)}return _.isArray(j)?j:persian(""+k+"\t\t\t\t\t"+chartUtils.format(i,j)+l,!0)}return c.datasets.filter(function(b,c){return b.sadafInfo.prop.hidden||c===a.datasetIndex}).map(function(b){var c=chartUtils.getFormatString(b.sadafInfo.prop.tooltipFont),d=b.data[a.index];d=e(d);var h="";if(g){var i=1*d/d3.sum(b.data);h="\t\t\t\t\t"+d3.format(".0%")(i)}var j=f(b.label);return persian(j+" "+chartUtils.format(c,d)+h)})},labelColor:function(a,b){var c=b.data.datasets[a.datasetIndex];return{borderColor:c.sadafInfo.prop.borderColor,backgroundColor:c.sadafInfo.prop.color}}}},legend:{display:!1,position:"right",align:"start",labels:_.merge({boxWidth:10},n),usePointStyle:!0,onClick:function(a,c){var d=c.datasetIndex,e=this.chart;b.editMode?$(b.selector).trigger("legendClick",[e.data.datasets[d].label,d,{key:e.data.datasets[d].label}]):Chart.defaults.global.legend.onClick.call(this,a,c)}},title:{display:!1,text:""},onClick:function(c){var f=this.getElementAtEvent(c);if(!_.isArray(f)||!f.length)return h||chartUtils.drillUp(b,a,d),void(h=!1);var g=f[0];e(g._index)},onHover:function(c){var d=this.getElementAtEvent(c);if(!_.isArray(d)||!d.length)return void $(b.selector).css("cursor","default");var e=d[0];a.matrix[e._index].canDrill&&$(b.selector).css("cursor","pointer")}}}},chartUtils.getChartSettings=function(){return{hasGeneralSettings:!0,general:[{key:"stack",title:"پشته",type:"select","default":"none",entries:[{name:"بدون پشته",value:"none"},{name:"پشته",value:"stack"},{name:"پشته درصدی",value:"stack100"}]},{key:"stackSumLabel",title:"نمایش عدد مجموع روی نمودار",type:"checkbox","default":!1,"if":{key:"stack",value:"stack"}},{key:"stackSumLabelFont",title:"فونت برچسب‌ها","if":{key:"stack",value:"stack"},type:"font","default":{fontSize:"13px",formatString:"A",align:"center"},config:{rotate:!0,anchor:!0,position:!0}},{key:"linesHoriz",title:"نمایش خطوط افقی",type:"checkbox","default":!0},{key:"linesVert",title:"نمایش خطوط عمودی",type:"checkbox","default":!1},{key:"customFont",title:"فونت و برچسب‌های محورها",type:"checkbox","default":!1},{title:"فونت و برچسب‌های محورها",type:"section",key:"axes-section","if":{key:"customFont",value:!0},items:[{key:"xfont",title:"فونت محور افقی",type:"font","default":{fontSize:"12px",formatString:"A"}},{key:"xfontLabel",title:"برچسب محور افقی",type:"text","default":""},{key:"xfontLabelDynamic",title:"استفاده از نام بُعد جاری",type:"checkbox","default":!1},{key:"xfontLabelFont",title:"فونت برچسب محور افقی",type:"font","default":{fontSize:"14px",formatString:"A"}},{key:"xMaxLen",title:"حداکثر تعداد کاراکتر برچسب‌ها",type:"number","default":40},{key:"xMultiline",title:"چند خطی شدن برچسب‌های محور افقی",type:"checkbox","default":!1},{key:"yfont",title:"فونت محور عمودی",type:"font","default":{fontSize:"12px",formatString:"A"}},{key:"yfontLabel",title:"برچسب محور عمودی",type:"text","default":""},{key:"yfontLabelFont",title:"فونت برچسب محور عمودی",type:"font","default":{fontSize:"14px",formatString:"A"}}]},{key:"showLegends",title:"نمایش راهنمای رنگ",type:"checkbox","default":!0},{key:"legendFont",title:"فونت راهنمای رنگ",type:"font","if":{key:"showLegends",value:!0},"default":{fontSize:"13px"},config:{color:!0,format:!1,align:!1}},{key:"legendPosition",title:"مکان راهنمای رنگ","if":{key:"showLegends",value:!0},type:"position","default":"top left"},{key:"tooltipMode",title:"نوع tooltip",type:"select","default":"visible",entries:[{name:"شاخص‌های پیدا",value:"visible"},{name:"تمام شاخص‌ها",value:"all"}]},{key:"tooltipFont",title:"فونت tooltip",type:"font","default":{fontSize:"14px",formatString:",.1f"},config:{format:!1,color:!1}},{key:"dimColor",title:"رنگ دلخواه",type:"dim-color","default":{}}],series:[{key:"label",title:"برچسب",type:"text"},{key:"color",title:"رنگ",type:"color"},{key:"type",title:"نوع",type:"select","default":"bar",entries:[{name:"میله‌ای",value:"bar"},{name:"خطی",value:"line"}]},{title:"تنظیمات خط",type:"section",key:"line-config","if":{key:"type",value:"line"},items:[{key:"fill",title:"پر کردن زیر خط",type:"checkbox","default":!0},{key:"fillOpacity",title:"شفافیت محدوده زیر نمودار",type:"number","default":.1,desc:"مقدار باید بین ۰ و ۱ باشد"},{key:"borderDash",title:"نوع خط",type:"select","default":"simple",entries:[{name:"ساده",value:"simple"},{name:"راه راه",value:"dash"},{name:"راه راه بلند",value:"long-dash"}]},{key:"spanGaps",title:"عدم نمایش مقادیر خالی",type:"checkbox","default":!1},{key:"steppedLine",title:"خط پله‌ای",type:"select","default":"none",entries:[{name:"غیرفعال",value:"none"},{name:"قبل",value:"before"},{name:"وسط",value:"middle"},{name:"بعد",value:"after"}]},{key:"lineMode",title:"نوع رسم خط",type:"select","default":"default",entries:[{name:"ساده",value:"none"},{name:"منحنی ۱",value:"default"},{name:"منحنی ۲",value:"monotone"}]},{key:"pointRadius",title:"شعاع دایره‌های روی خط",type:"number","default":3}]},{key:"borderWidth",title:"قطر خط",type:"number","default":3},{key:"borderColor",title:"رنگ خط",type:"color"},{key:"hidden",title:"مخفی کردن",type:"checkbox"},{key:"tooltipFont",title:"فرمت مقدار",type:"font","default":{formatString:",.0f"},config:{size:!1,font:!1,color:!1,align:!1,bold:!1}},{key:"showLabel",title:"نمایش مقادیر روی نمودار",type:"checkbox"},{key:"showLabel-section",title:"نمایش مقادیر روی نمودار",type:"section","if":{key:"showLabel",value:!0},items:[{key:"showLabelAuto",title:"عدم نمایش در صورت روی هم افتادن برچسب",type:"checkbox","default":!0},{key:"showLabelFont",title:"فونت برچسب‌ها",type:"font","default":{fontSize:"13px",formatString:",.0f",align:"center"},config:{rotate:!0,anchor:!0,position:!0}}]}]}},chartUtils.handlePieSettings=function(a){_.remove(a.series,{key:"type"}),_.remove(a.series,{key:"color"}),_.remove(a.general,{key:"stack"}),_.remove(a.general,{key:"axes-section"}),_.remove(a.general,{key:"customFont"}),_.remove(a.general,{key:"linesVert"}),_.find(a.general,{key:"legendPosition"})["default"]="center right",_.find(a.general,{key:"legendPosition"})["if"]={key:"showLegends",value:"legend"},_.find(a.series,{key:"borderColor"})["default"]="white",a.general.push({key:"cutoutPercentage",title:"شعاع محدوده خالی",type:"number","default":50}),a.general.push({key:"showPercentage",title:"نمایش درصد در tooltip",type:"checkbox","default":!0}),_.find(a.series,{key:"showLabel-section"}).items=_.find(a.series,{key:"showLabel-section"}).items.concat([{key:"showLegends",type:"select",title:"نوع نمایش راهنما","default":"legend",entries:[{name:"راهنمای کنار",value:"legend"},{name:"برچسب روی نمودار",value:"out-label"}]},{title:"نمایش درصد روی برچسب",key:"showPercentageInLegend",type:"checkbox","default":!0,"if":{key:"showLegends",value:"out-label"}},{title:"نمایش مقدار روی برچسب",key:"showValueInLegend",type:"checkbox","default":!1,"if":{key:"showLegends",value:"out-label"}},{key:"padding","if":{key:"showLegends",value:"out-label"},title:"فضای خالی اطراف نمودار",type:"number","default":60}])},function(){var a={type:12,expandedChartType:[{name:"میله‌ای",type:33,iconLink:app.urlPrefix+"images/chart-icons/bar.png"},{name:"خطی",type:40,iconLink:app.urlPrefix+"images/chart-icons/line.png"}],category:"ChartJs",config:{needDim:!1,needMeasure:!0,needServerData:!0},changeSeriesPropertyBaseOnExpandedType:function(a,c){_.find(b.series,{key:"type"})["default"]=33===c?"bar":"line",_.find(b.series,{key:"borderWidth"})["default"]=33===c?0:2,_.forOwn(a.series,function(b,d){a.series[d].type=33===c?"bar":"line",a.series[d].borderWidth=33===c?0:2})},draw:function(a,b,c,d){var e=b.selector;$(b.selector).addClass("canvas-chart");var f=!0,g=$(b.selector).width(),h=chartUtils.getData(a,b);if(!chartUtils.renderLegendForBar(b,h,a,d,g,f)){var i=0,j=$(b.selector+" .legend-bar").height(),k=$(b.selector).height()+i-j,l=chartUtils.getChartOption(a,b,h,d),m=b.chartProp.general.useScroll,n=+b.chartProp.general.xfont.fontSize.replace("px",""),o=4*g;if(o=a.matrix.length*n*+b.chartProp.general.scrollLableRate,o<g&&(m=!1),m){0!=b.chartProp.general.xRotate&&(l.options.scales.xAxes[0].ticks.maxRotation=b.chartProp.general.xRotate,l.options.scales.xAxes[0].ticks.minRotation=b.chartProp.general.xRotate),l.options.scales.xAxes[0].afterFit=function(a){a.height<b.chartProp.general.minXheight&&(a.height=b.chartProp.general.minXheight)};var p=$('<div class="temporal" style="position:relative;"></div>');$(b.selector).append(p),p.append('<div class="scl-container" style="width:'+g+'px; overflow-x:auto"><canvas class="temporal canvas"  width="'+o+'" height="'+k+'" style="margin-top:-'+i+'px"></canvas></div>'),p.find(".scl-container").scrollLeft(-1*o);var q=_.debounce(function(){var a=p.find(".scl-container").scrollLeft();console.log("### scroll",a,o),a>-1*o+g+20?$(e+" #axis-Test").fadeIn():$(e+" #axis-Test").fadeOut()},200);p.find(".scl-container").on("scroll",function(){q()}),p.append('<canvas style="position:absolute; left:0; top:0;" id="axis-Test" height="'+k+'" width="10"></canvas>');var r=!1;l.options.animation={onComplete:function(){if(!r){var a=window.devicePixelRatio,b=this.chart,c=b.chart.canvas,d=b.scales["y-axis-0"].width-10,f=b.scales["y-axis-0"].height+b.scales["y-axis-0"].top+10,g=$(e+" #axis-Test").get(0).getContext("2d");g.scale(a,a),g.canvas.width=d*a,g.canvas.height=f*a,g.canvas.style.width=d+"px",g.canvas.style.height=f+"px",g.drawImage(c,0,0,d*a,f*a,0,0,d*a,f*a);c.getContext("2d");r=!0}},onProgress:function(){if(r===!0){var a=this.chart;a.scales["y-axis-0"].width,a.scales["y-axis-0"].height+a.scales["y-axis-0"].top+10,a.chart.canvas.getContext("2d")}}}}else $(b.selector).append('<canvas class="temporal canvas"  width="'+g+'" height="'+k+'" style="margin-top:-'+i+'px"></canvas>');var s=$(b.selector+" canvas").get(0).getContext("2d");Chart.defaults.global.defaultFontFamily="IRANSans";_.each(h,function(a,b){if(a.sadafInfo.prop.extraAxe){a.yAxisID="id_"+b;var c=_.merge({id:"id_"+b},l.options.scales.yAxes[0]),d=d3.max(a.data),e=d3.min(a.data);c.position="right",c.gridLines.drawOnChartArea=!1,c.scaleLabel=_.merge({display:!!a.sadafInfo.prop.yfontLabel,labelString:a.sadafInfo.prop.yfontLabel},chartUtils.getFontFromProp(a.sadafInfo.prop.yfontLabelFont)),c.ticks=_.merge({beginAtZero:!0,suggestedMax:1.11*d,suggestedMin:1.11*e,callback:function(b,c,d){var e=chartUtils.getFormatString(a.sadafInfo.prop.yfont);return persian(d3.format(e)(b),!0)}},chartUtils.getFontFromProp(a.sadafInfo.prop.yfont)),l.options.scales.yAxes.push(c)}}),l.type="bar",chartUtils.handleStackLabel(b,l);var t=new Chart(s,l);$(b.selector+" canvas").data("chart",t)}}},b=chartUtils.getChartSettings();_.find(b.series,{key:"borderWidth"})["default"]=0,_.find(b.series,{key:"color"}).onchange=function(a,b,c){b.borderColor=a},b.series.push({title:"ایجاد محور Y مجزا",type:"checkbox",key:"extraAxe","default":!1}),b.series.push({key:"axeSection",title:"فونت محور عمودی",type:"section","if":{key:"extraAxe",value:!0},items:[{key:"yfont",title:"فونت محور عمودی",type:"font","default":{fontSize:"12px",formatString:"A"},config:{align:!1}},{key:"yfontLabel",title:"برچسب محور عمودی",type:"text","default":""},{key:"yfontLabelFont",title:"فونت برچسب محور عمودی",type:"font","default":{fontSize:"14px",formatString:"A"},config:{format:!1,align:!1}}]}),b.general.push({title:"استفاده از اسکرول",type:"checkbox",key:"useScroll","default":!1}),b.general.push({title:"ضریب اندازه برچسب محور افقی",type:"number",key:"scrollLableRate","default":2.5,"if":{key:"useScroll",value:!0}}),b.general.push({title:"حداقل ارتفاع محور افقی",type:"number",key:"minXheight","default":120,"if":{key:"useScroll",value:!0}}),b.general.push({title:"زاویه برچسب‌ها",type:"number",desc:"برای حالت خودکار از مقدار ۰ استفاده کنید",key:"xRotate","default":90,"if":{key:"useScroll",value:!0}}),a.settings=b,a.getSettings=function(){return b},app=app||{},app.charts=app.charts||{},app.charts.list=app.charts.list||[],app.charts.list.push(a)}(),function(){var a={type:17,expandedChartType:[{name:"حبابی",type:38,iconLink:app.urlPrefix+"images/chart-icons/bubble.png"}],category:"ChartJs",config:{needDim:!1,needMeasure:!0,needServerData:!0},changeSeriesPropertyBaseOnExpandedType:function(a,b){},draw:function(a,b,c,d){b.selector;$(b.selector).addClass("canvas-chart");var e=!0,f=$(b.selector).width(),g=chartUtils.getData(a,b);if(!chartUtils.renderLegendForBar(b,g,a,d,f,e,!0)){if(a.series.labels.length<3)return void $(b.selector).append('<div class="temporal "style="margin:40px">حداقل باید سه شاخص  برای ساخت نمودار وجود داشته باشد. x - y - volume </div>');var h=0,i=$(b.selector+" .legend-bar").height(),j=$(b.selector).height()+h-i;$(b.selector).append('<canvas class="temporal canvas"  width="'+f+'" height="'+j+'" style="margin-top:-'+h+'px"></canvas>');var k=$(b.selector+" canvas").get(0).getContext("2d");Chart.defaults.global.defaultFontFamily="IRANSans";var l=chartUtils.getChartOption(a,b,g,d);g[0].data=g[0].data.map(function(a,b){return{x:g[0].data[b],y:g[1].data[b],r:g[2].data[b],xLabel:g[0].label,yLabel:g[1].label,rLabel:g[2].label}}),delete g[0].type,l.data={datasets:[g[0]],labels:l.data.labels},_.each(g,function(a){a.pointRadius=a.sadafInfo.prop.pointRadius}),l.type="bubble";var m=d3.max(g[0].data,function(a){return a.y});l.options.tooltips.getValueCallback=function(a){return[a.xLabel+": "+a.x,a.yLabel+": "+a.y,a.rLabel+": "+a.r]},l.options.tooltips.mode="nearest",l.options.tooltips.getLabelCallback=function(a){return""},l.options.scales.yAxes[0].ticks.suggestedMax=1.11*m,l.options.scales.xAxes[0].ticks.callback=function(a,c,d){var e=chartUtils.getFormatString(b.chartProp.general.xfont);return persian(d3.format(e)(a),!0)};chart=new Chart(k,l),$(b.selector+" canvas").data("chart",chart)}}},b=chartUtils.getChartSettings();_.find(b.series,{key:"borderWidth"})["default"]=0,a.settings=b,app=app||{},app.charts=app.charts||{},app.charts.list=app.charts.list||[],app.charts.list.push(a)}(),function(){var a={type:11,expandedChartType:[{name:"قطره آب",type:32,iconLink:app.urlPrefix+"images/chart-icons/drop.png"}],category:"",config:{needDim:!0,needMeasure:!0,needServerData:!0},changeSeriesPropertyBaseOnExpandedType:function(a,b){},draw:function(a,b,c,d){function e(){return{minValue:0,maxValue:100,circleThickness:.05,circleFillGap:.05,circleColor:"#178BCA",waveHeight:.05,waveCount:1,waveRiseTime:1e3,waveAnimateTime:18e3,waveRise:!0,waveHeightScaling:!0,waveAnimate:!0,waveColor:"#178BCA",waveOffset:0,textVertPosition:.5,textSize:1,valueCountUp:!0,displayPercent:!0,textColor:"#045681",waveTextColor:"#A4DBf8"}}function f(a,c,d){function f(a){return persian(d3.format(L.formatString)(a))}function g(){O.attr("transform","translate("+H(O.attr("T"))+",0)"),O.transition().duration(d.waveAnimateTime*(1-O.attr("T"))).ease(d3.easeLinear).attr("transform","translate("+H(1)+",0)").attr("T",1).on("end",function(){O.attr("T",0),g(d.waveAnimateTime)})}function h(){this.update=function(a){var b=parseFloat(a).toFixed(2),c=function(a){return Math.round(a)};parseFloat(b)!=parseFloat(c(b))&&(c=function(a){return parseFloat(a).toFixed(1)}),parseFloat(b)!=parseFloat(c(b))&&(c=function(a){return parseFloat(a).toFixed(2)});var e=function(){var b=d3.interpolate(this.textContent,parseFloat(a).toFixed(2));return function(a){this.textContent=c(b(a))+q}};Q.transition().duration(d.waveRiseTime).tween("text",e),text2.transition().duration(d.waveRiseTime).tween("text",e);var f,h=Math.max(d.minValue,Math.min(d.maxValue,a))/d.maxValue,j=u*i(100*h),k=d3.scaleLinear().range([t+2*u+j,t-j]).domain([0,1]),l=k(h),m=d3.scaleLinear().range([0,y]).domain([0,1]),n=d3.scaleLinear().range([0,j]).domain([0,1]);f=d.waveHeightScaling?d3.svg.area().x(function(a){return m(a.x)}).y0(function(a){return n(Math.sin(2*Math.PI*d.waveOffset*-1+2*Math.PI*(1-d.waveCount)+2*a.y*Math.PI))}).y1(function(a){return 2*u+j}):M;var o=d.waveAnimate?H(1):0;O.transition().duration(0).transition().duration(d.waveAnimate?d.waveAnimateTime*(1-O.attr("T")):d.waveRiseTime).ease(d3.easeLinear).attr("d",f).attr("transform","translate("+o+",0)").attr("T","1").each("end",function(){d.waveAnimate&&(O.attr("transform","translate("+H(0)+",0)"),g(d.waveAnimateTime))}),N.transition().duration(d.waveRiseTime).attr("transform","translate("+S+","+l+")")}}null==d&&(d=e());var i,j=d3.select("#"+a),k=Math.min(parseInt(j.style("width")),parseInt(j.style("height")))/2,l=parseInt(j.style("width"))/2-k,m=parseInt(j.style("height"))/2-k,n=Math.max(d.minValue,Math.min(d.maxValue,c))/d.maxValue;i=d.waveHeightScaling?d3.scaleLinear().range([0,d.waveHeight,0]).domain([0,50,100]):d3.scaleLinear().range([d.waveHeight,d.waveHeight]).domain([0,100]);var o=d.textSize*k/2,p=parseFloat(c).toFixed(2),q=(d.valueCountUp?d.minValue:p,d.displayPercent?"%":""),r=d.circleThickness*k,s=d.circleFillGap*k,t=r+s,u=k-t,v=u*i(100*n),w=2*u/d.waveCount,x=1+d.waveCount,y=w*x,z=function(a){return Math.round(a)};parseFloat(p)!=parseFloat(z(p))&&(z=function(a){return parseFloat(a).toFixed(1)}),parseFloat(p)!=parseFloat(z(p))&&(z=function(a){return parseFloat(a).toFixed(2)});for(var A=[],B=0;B<=40*x;B++)A.push({x:B/(40*x),y:B/40});var C=d3.scaleLinear().range([0,2*Math.PI]).domain([0,1]),D=d3.scaleLinear().range([0,k]).domain([0,k]),E=d3.scaleLinear().range([0,y]).domain([0,1]),F=d3.scaleLinear().range([0,v]).domain([0,1]),G=d3.scaleLinear().range([t+2*u+v,t-v]).domain([0,1]),H=d3.scaleLinear().range([0,y-2*u]).domain([0,1]),I=d3.scaleLinear().range([t+2*u,t+.7*o]).domain([0,1]),J=j.append("g").attr("transform","translate("+l+","+m+")"),K=d3.arc().startAngle(C(0)).endAngle(C(1)).outerRadius(D(k)).innerRadius(D(k-r));J.append("path").attr("d",K).style("fill",d.circleColor).attr("transform","translate("+k+","+k+")");var L=_.merge({bold:!1,color:"#333333",italic:!1,fontSize:o+"px",fontName:"IRANSans",formatString:",.2f"},b.chartProp.general.format),M=d3.area().x(function(a){return E(a.x)}).y0(function(a){return F(Math.sin(2*Math.PI*d.waveOffset*-1+2*Math.PI*(1-d.waveCount)+2*a.y*Math.PI))}).y1(function(a){return 2*u+v}),N=J.append("defs").append("clipPath").attr("id","clipWave"+a),O=N.append("path").datum(A).attr("d",M).attr("T",0),P=J.append("g").attr("clip-path","url(#clipWave"+a+")");P.append("circle").attr("cx",k).attr("cy",k).attr("r",u).style("fill",d.waveColor);var Q=J.append("text").text(f(0)).attr("class","liquidFillGaugeText").attr("text-anchor","middle").attr("font-size",o+"px").style("fill",d.textColor).style("fill",L.color).style("font-family",L.fontName).style("font-weight",L.bold?"bold":"normal").style("font-style",L.italic?"italic":"normal").attr("transform","translate("+k+","+I(d.textVertPosition)+")");if(d.valueCountUp){var R=function(){var a=d3.interpolate(depersian(this.textContent),p);return function(b){this.textContent=f(a(b))}};Q.transition().duration(d.waveRiseTime).tween("text",R)}var S=t+2*u-y;return d.waveRise?N.attr("transform","translate("+S+","+G(0)+")").transition().duration(d.waveRiseTime).attr("transform","translate("+S+","+G(n)+")").on("start",function(){O.attr("transform","translate(1,0)")}):N.attr("transform","translate("+S+","+G(n)+")"),d.waveAnimate&&g(),new h}var g=e();g.circleColor=b.chartProp.general.circleColor,g.textColor=b.chartProp.general.textColor,g.waveTextColor=b.chartProp.general.waveColor,g.waveColor=b.chartProp.general.waveColor,g.circleThickness=b.chartProp.general.circleThickness,g.circleFillGap=+b.chartProp.general.circleFillGap,g.textVertPosition=1-+b.chartProp.general.circleFillGap,g.waveAnimateTime=2e3,g.waveHeight=.3,g.waveCount=1,g.minValue=b.chartProp.general.min,g.maxValue=b.chartProp.general.max;var h=b.id+"-svg";d3.select(b.selector).append("svg").attr("class","temporal").attr("id",h).attr("height",$(b.selector).height()).attr("width",$(b.selector).width());f(h,+a.series.data[0][0],g)}};a.settings={general:[{key:"waveColor",title:"رنگ دایره داخلی",type:"color","default":"rgba(33, 150, 243, 0.7)"},{key:"textColor",title:"رنگ نوشته",type:"color","default":"#424242"},{key:"circleColor",title:"رنگ دایره خارجی",type:"color","default":"#2196f3"},{key:"circleThickness",title:"قطر دایره",type:"number","default":.1},{key:"circleFillGap",title:"اندازه شکاف",type:"number","default":.2},{key:"format",title:"قالب نمایش",type:"font","default":{}},{key:"min",title:"کمترین مقدار",type:"number","default":0},{key:"max",title:"بیشترین مقدار",type:"number","default":100}]},app=app||{},app.charts=app.charts||{},app.charts.list=app.charts.list||[],app.charts.list.push(a)}(),function(){var a={type:chartUtils.chartsId.fitLine.type,expandedChartType:chartUtils.chartsId.fitLine.extendTypes,category:"ChartJs",config:{needDim:!1,needMeasure:!0,needServerData:!0},changeSeriesPropertyBaseOnExpandedType:function(a,b){},draw:function(a,b,c,d){b.selector;$(b.selector).addClass("canvas-chart");var e=!0,f=$(b.selector).width(),g=chartUtils.getData(a,b),h=!1;_.each(g,function(a){h=h||"bar"===a.type,a.fill=!!a.sadafInfo.prop.fill&&"start"});var i=0;if("sum"===b.chartProp.general.agg&&(i=d3.sum(g[0].data)),"avg"===b.chartProp.general.agg&&(i=d3.sum(g[0].data)/g[0].data.length),"var"===b.chartProp.general.agg&&(i=d3.variance(g[0].data)),"last"===b.chartProp.general.agg&&(i=_.last(g[0].data)),"first"===b.chartProp.general.agg&&(i=_.first(g[0].data)),!chartUtils.renderLegendForBar(b,g,a,d,f,e)){var j=null,k=null;"last"===b.chartProp.general.agg&&(j=g[0].data.length-2<0?0:g[0].data[g[0].data.length-2],k=i/j-1,0===j&&(k=0));var l=0,m=$(b.selector+" .legend-bar").height(),n=$(b.selector).height()+l-m,o=function(a,b){var c=a.chartProp.general.titleFont,d=persian(d3.format(c.formatString)(b),e),f="",g="";if(null!==k){var h=a.chartProp.general.percentColor,i=k>0&&"1"===h||k<0&&"2"===h,l=i?"up":"down",m=i?"green":"red";f='<span class="ltr" style="display:inline-block; color: '+m+'"><i style="" class="chevron '+l+" "+m+' icon"/> '+persian(d3.format(".0%")(k))+"</span>",g='<span class="ltr" style="display:inline-block;">'+persian(d3.format(c.formatString)(j))+"</span>"}var n=a.chartProp.general.text.replace("@value",'<span class="ltr inline" title="'+d+'">'+d+"</span>").replace("@percent",'<span class="ltr inline" title="">'+f+"</span>").replace("@last",'<span class="ltr inline" title="">'+g+"</span>");return n};$(b.selector).append('<div class="float-digit temporal" style="display:none;z-index:0;position: absolute;left: 0;right: 0;margin: auto;margin-top:14px;">'+o(b,i)+"</div >");var p="position:absolute;background-color:rgba(0,0,0,0);margin:-14px; top:29px; border-radius:4px;",q=f+28;b.editMode&&(p="position:absolute;background-color:rgba(0,0,0,0);margin:0px; top:0px; border-radius:4px;",q=f),$(b.selector).append('<canvas class="temporal canvas"  width="'+q+'" height="'+n+'" style="'+p+'"></canvas>'),$(b.selector+" .float-digit").transition("scale","1000ms");var r=$(b.selector+" canvas").get(0).getContext("2d");Chart.defaults.global.defaultFontFamily="IRANSans";var s=chartUtils.getChartOption(a,b,g,d);_.each(g,function(a){a.pointRadius=a.sadafInfo.prop.pointRadius}),s.type="bar",s.options.scales.xAxes[0].display=!1,s.options.scales.yAxes[0].display=!1,0!==s.options.scales.yAxes[0].ticks.suggestedMin||h||(s.options.scales.yAxes[0].ticks.suggestedMin=-10),s.options.scales.xAxes[0].offset=!1,s.options.layout.padding.top=Math.min(.35*n,100),s.options.tooltips.position="nearest",chart=new Chart(r,s),$(b.selector+" canvas").data("chart",chart),r.canvas.style.backgroundColor="rgba(0,0,0,0)"}}},b=chartUtils.getChartSettings();b.general.push({title:"متن برچسب",type:"editor",key:"text","default":'<strong style="font-size: 38px;">@value</strong><p>@percent</p><p>@last</p>',desc:"@value: مقدار - @percent: درصد تغییرات - @last: آخرین مقدار"}),b.general.push({title:"فرمت",type:"font",key:"titleFont","default":{formatString:",.0f"},config:{size:!1,font:!1,color:!1,align:!1,bold:!1}}),b.general.push({title:"تابع محاسبه عدد ",type:"select",key:"agg","default":"last",entries:[{name:"last",value:"last"},{name:"first",value:"first"},{name:"sum",value:"sum"},{name:"avg",value:"avg"},{name:"var",value:"var"}]}),b.general.push({"if":{key:"agg",value:"last"},title:"رنگ درصد تغییرات",type:"select",key:"percentColor","default":"1",entries:[{name:"مقدار مثبت با رنگ سبز",value:"1"},{name:"مقدار منفی با رنگ سبز",value:"2"}]}),_.find(b.series,{key:"borderWidth"})["default"]=2,_.find(_.find(b.series,{key:"line-config"}).items,{key:"fill"})["default"]="start",_.find(_.find(b.series,{key:"line-config"}).items,{key:"fillOpacity"})["default"]=.2,_.find(_.find(b.series,{key:"line-config"}).items,{key:"pointRadius"})["default"]=0,_.find(b.series,{key:"type"})["default"]="line",_.find(b.series,{key:"color"}).onchange=function(a,b,c){b.borderColor=a},_.find(b.general,{key:"showLegends"})["default"]=!1,a.settings=b,app=app||{},app.charts=app.charts||{},app.charts.list=app.charts.list||[],app.charts.list.push(a)}(),function(){var a={type:chartUtils.chartsId.funnel.type,
expandedChartType:chartUtils.chartsId.funnel.extendTypes,category:"ChartJs",config:{needDim:!1,needMeasure:!0,needServerData:!0},changeSeriesPropertyBaseOnExpandedType:function(a,b){},draw:function(a,b,c,d){$(b.selector).addClass("canvas-chart");var e=!0,f=$(b.selector).width(),g=chartUtils.getData(a,b);if(!chartUtils.renderLegendForBar(b,g,a,d,f,e,!0)){_.each(g,function(c){c.backgroundColor=chartUtils.getColorArray(a,b),c.hoverBackgroundColor=chartUtils.getColorArray(a,b),c.datalabels={display:!0},delete c.datalabels,delete c.type});var h=0,i=$(b.selector+" .legend-bar").height(),j=$(b.selector).height()+h-i;$(b.selector).append('<canvas class="temporal canvas"  width="'+f+'" height="'+j+'" style="margin-top:-'+h+'px"></canvas>');var k=$(b.selector+" canvas").get(0).getContext("2d");Chart.defaults.global.defaultFontFamily="IRANSans";var l=chartUtils.getChartOption(a,b,g,d);l.type="funnel",l.options.tooltips.mode="nearest",l.options.tooltips.position="nearest",l.options.tooltips.intersect=!0,delete l.options.scales,delete l.options.tooltips,l.options.plugins.datalabels=!1,chart=new Chart(k,l),$(b.selector+" canvas").data("chart",chart)}}},b=chartUtils.getChartSettings();_.find(b.series,{key:"borderWidth"})["default"]=0,_.remove(b,{key:"type"}),a.settings=b,app=app||{},app.charts=app.charts||{},app.charts.list=app.charts.list||[],app.charts.list.push(a)}(),function(){var a={type:14,expandedChartType:[{name:"میله‌ای افقی",type:35,iconLink:app.urlPrefix+"images/chart-icons/horizontal-bar.png"}],category:"ChartJs",config:{needDim:!1,needMeasure:!0,needServerData:!0},changeSeriesPropertyBaseOnExpandedType:function(a,b){},draw:function(a,b,c,d){$(b.selector).addClass("canvas-chart");var e=!0,f=$(b.selector).width(),g=chartUtils.getData(a,b);if(!chartUtils.renderLegendForBar(b,g,a,d,f,e)){var h=0,i=$(b.selector+" .legend-bar").height(),j=$(b.selector).height()+h-i;$(b.selector).append('<canvas class="temporal canvas"  width="'+f+'" height="'+j+'" style="margin-top:-'+h+'px"></canvas>');var k=$(b.selector+" canvas").get(0).getContext("2d");Chart.defaults.global.defaultFontFamily="IRANSans";var l=chartUtils.getChartOption(a,b,g,d);l.type="horizontalBar",_.each(g,function(a){delete a.type});var m=l.options.scales.xAxes;l.options.scales.xAxes=l.options.scales.yAxes,l.options.scales.yAxes=m,b.chartProp.general.paddingLeft&&(l.options.layout.padding.left=b.chartProp.general.paddingLeft),l.options.rtl=!0,chartUtils.handleStackLabel(b,l),chart=new Chart(k,l),$(b.selector+" canvas").data("chart",chart)}}},b=chartUtils.getChartSettings();_.find(b.series,{key:"borderWidth"})["default"]=0,b.general.push({key:"paddingLeft",title:"اندازه اضافه برای برچسب محور عمودی",desc:"در صورتی که برچسب‌های محور عمودی کامل نمایش داده نمی‌شود از این آپشن برای افزایش فضا استفاده کنید",type:"number","default":0}),a.settings=b,app=app||{},app.charts=app.charts||{},app.charts.list=app.charts.list||[],app.charts.list.push(a)}(),function(){var a={type:chartUtils.chartsId.image.type,expandedChartType:chartUtils.chartsId.image.extendTypes,category:"ChartJs",config:{needDim:!1,needMeasure:!1,needServerData:!1},changeSeriesPropertyBaseOnExpandedType:function(a,b){},draw:function(a,b,c,d){if("cover"===b.chartProp.general.picSize){var e=$(b.selector).parent();$(b.selector).parent().find(".title").css("z-index",1),e.css("position","relative"),$(b.selector).css({position:"absolute",left:0,top:0,width:"100%",height:"100%","margin-top":0})}var f=b.chartProp.general.text,g="";b.chartProp.general.pic&&"image"===b.chartProp.general.pic.type&&(g='<div class="image" style="flex: 5 1 0;background-size:'+b.chartProp.general.picSize+" !important; background-position: center !important;background-repeat: no-repeat !important; background-repeat-x: no-repeat !important;background-repeat-y: no-repeat !important;background:url('"+app.urlPrefix+"api/upload/getPic/"+b.chartProp.general.pic.name+'\')"><ximg  src="'+app.urlPrefix+"api/upload/getPic/"+b.chartProp.general.pic.name+'"/></div>'),b.chartProp.general.pic&&"icon"===b.chartProp.general.pic.type&&(g='<i class="'+b.chartProp.general.pic.name+'"/>',f=f.replace("@icon",g),g="");var h="",i=f.replace(/(<.*?>|\s+)/gi,"");""!=i&&(h='<div class="" style="flex: 1 0 0; padding: '+b.chartProp.general.textPadding+'px; line-height:1.8">'+f+"</div>");var j='<div class="temporal image-chart"  style="display: flex;flex-direction: column;height: 100%;">'+g+h+"</div>";$(b.selector+" ").append(j)}},b={hasGeneralSettings:!0,general:[{key:"pic",title:"انتخاب عکس",type:"icon","default":{}},{key:"text",title:"متن",type:"editor","default":""},{key:"textPadding",title:"حاشیه متن",type:"number","default":14},{key:"picSize",title:"نوع نمایش عکس",type:"select","default":"contain",entries:[{name:"contain",value:"contain"},{name:"cover",value:"cover"}]}],series:[]};a.settings=b,a.getSettings=function(){return b},app=app||{},app.charts=app.charts||{},app.charts.list=app.charts.list||[],app.charts.list.push(a)}(),function(){var a={type:18,expandedChartType:[{name:"Matrix",type:39,iconLink:app.urlPrefix+"images/chart-icons/matrix.png"}],category:"ChartJs",config:{needDim:!1,needMeasure:!0,needServerData:!0},changeSeriesPropertyBaseOnExpandedType:function(a,b){},draw:function(a,b,c,d){b.selector;$(b.selector).addClass("canvas-chart");var e=!0,f=$(b.selector).width(),g=chartUtils.getData(a,b);if(!chartUtils.renderLegendForBar(b,g,a,d,f,e,!0)){if(a.matrix[0].captions.length<2)return void $(b.selector).append('<div class="temporal "style="margin:40px">برای ساخت نمودار ماتریس باید دو قسمت ابعاد دو ستون در یک سطح قرار گرفته باشند</div>');var h=0,i=$(b.selector+" .legend-bar").height(),j=$(b.selector).height()+h-i;$(b.selector).append('<canvas class="temporal canvas"  width="'+f+'" height="'+j+'" style="margin-top:-'+h+'px"></canvas>');var k=$(b.selector+" canvas").get(0).getContext("2d");Chart.defaults.global.defaultFontFamily="IRANSans";var l=chartUtils.getChartOption(a,b,g,d);delete g[0].type,l.data={datasets:[g[0]],labels:l.data.labels},_.each(g,function(a){a.pointRadius=a.sadafInfo.prop.pointRadius}),l.type="matrix";d3.max(g[0].data,function(a){return a.y});l.options.tooltips.getValueCallback=function(a){return a.v},l.options.tooltips.mode="nearest",l.options.tooltips.position="nearest",l.options.tooltips.intersect=!0,l.options.tooltips.getLabelCallback=function(a){return""};var m=_.uniq(a.matrix.map(function(a,b){return a.captions[0]})),n=_.uniq(a.matrix.map(function(a,b){return a.captions[1]}));b.chartProp.general.xSort&&(m=m.sort()),b.chartProp.general.ySort&&(n=n.sort());var o=a.matrix.map(function(b,c){return{x:b.captions[0],y:b.captions[1],v:a.series.data[c][0]}});g=[g[0]];var p={data:o,datalabels:{formatter:function(a,b){var c=chartUtils.getFormatString(b.dataset.sadafInfo.prop.showLabelFont),d=persian(d3.format(c)(a.v),!0);return d}},backgroundColor:function(a){var b=a.dataset.data[a.dataIndex].v,c=d3.max(a.dataset.data,function(a){return+a.v}),d=d3.min(a.dataset.data,function(a){return+a.v}),e=(b-d)/(c-d)+.1;c===d&&(e=1),e>1&&(e=1);var f=e;return console.log("a",e),Color(a.dataset.sadafInfo.prop.color).alpha(f).rgbString()},width:function(a){var b=a.chart.chartArea;return(b.right-b.left)/(1*m.length)},height:function(a){var b=a.chart.chartArea;return(b.bottom-b.top)/(1*n.length)}};g[0]=_.merge(g[0],p),console.log(m,n,o),l.options.layout.padding.top=0,l.options.scales.xAxes[0].type="category",l.options.scales.xAxes[0].lables=m,l.options.scales.xAxes[0].offset=!0,l.options.scales.xAxes[0].ticks={display:!0},l.options.scales.xAxes[0]={type:"category",labels:m,ticks:{display:!0},offset:!0,gridLines:{display:!1}},l.options.scales.yAxes[0].type="category",l.options.scales.yAxes[0].lables=n,l.options.scales.yAxes[0].offset=!0,l.options.scales.yAxes[0].gridLines.display=!1,l.options.scales.yAxes[0].ticks={display:!0},l.options.scales.yAxes[0]={type:"category",weight:100,labels:n,offset:!0,ticks:{display:!0},gridLines:{display:!1}},l.data.datasets=g,b.chartProp.general.paddingLeft&&(l.options.layout.padding.left=b.chartProp.general.paddingLeft),chart=new Chart(k,l),$(b.selector+" canvas").data("chart",chart)}}},b=chartUtils.getChartSettings();_.find(b.series,{key:"borderWidth"})["default"]=1,_.find(_.find(b.series,{key:"showLabel-section"}).items,{key:"showLabelFont"})["default"]={fontSize:"13px",formatString:"A",align:"center",anchor:"center",position:"center"},_.remove(b.general,{key:"legendFont"}),_.remove(b.general,{key:"legendPosition"}),_.remove(b.general,{key:"stack"}),_.remove(b.general,{key:"linesHoriz"}),_.remove(b.general,{key:"linesVert"}),_.remove(b.general,{key:"customFont"}),_.remove(b.general,{key:"showLegends"}),_.remove(b.general,{key:"dimColor"}),_.remove(b.series,{key:"type"}),b.general.push({key:"paddingLeft",title:"اندازه اضافه برای برچسب محور عمودی",desc:"در صورتی که برچسب‌های محور عمودی کامل نمایش داده نمی‌شود از این آپشن برای افزایش فضا استفاده کنید",type:"number","default":0}),b.general.push({key:"xSort",title:"مرتب کردن محور افقی براساس حروف الفبا",type:"checkbox","default":!1}),b.general.push({key:"ySort",title:"مرتب کردن محور عمودی براساس حروف الفبا",type:"checkbox","default":!1}),a.settings=b,app=app||{},app.charts=app.charts||{},app.charts.list=app.charts.list||[],app.charts.list.push(a)}(),function(){var a={type:13,expandedChartType:[{name:"دایره‌ای",type:34,iconLink:app.urlPrefix+"images/chart-icons/pie.png"}],category:"ChartJs",config:{needDim:!1,needMeasure:!0,needServerData:!0},changeSeriesPropertyBaseOnExpandedType:function(a,b){},draw:function(a,b,c,d){b.selector;$(b.selector).addClass("canvas-chart");var e=d3.select(b.selector+" .lgb");e.empty()&&(e=d3.select(b.selector).append("div").attr("class","lgb"));var f=e.append("div").attr("class","legend-bar temporal");if(f.breadcrumb(a.levels,b,d,!0),!chartUtils.checkEmtryResult(a,f)){var g=chartUtils.getData(a,b),h=0,i=$(b.selector).width(),j=$(b.selector+" .legend-bar").height(),k=$(b.selector).height()+h-j;$(b.selector).append('<canvas class="temporal canvas"  width="'+i+'" height="'+k+'" style="margin-top:-'+h+'px"></canvas>');var l=$(b.selector+" canvas").get(0).getContext("2d");Chart.defaults.global.defaultFontFamily="IRANSans";var m=chartUtils.getChartOption(a,b,g,d);_.each(g,function(c){delete c.type,c.backgroundColor=chartUtils.getColorArray(a,b),c.borderColor=a.matrix.map(function(a){return c.sadafInfo.prop.borderColor}),c.borderWidth=c.sadafInfo.prop.borderWidth;var d=(c.sadafInfo.prop.showLabelFont.fontSize||"12px").replace("px","");"out-label"===c.sadafInfo.prop.showLegends?(c.datalabels={display:!1},c.outlabels={text:function(a){var b="",d="";if(c.sadafInfo.prop.showPercentageInLegend&&(b=d3.format(".0%")(a.percent)+""),c.sadafInfo.prop.showValueInLegend){var e=chartUtils.getFormatString(c.sadafInfo.prop.showLabelFont,",.0f");d=d3.format(e)(a.dataset.data[a.dataIndex])+" "}return persian(a.labels[a.dataIndex]+" "+d+b,!0)},backgroundColor:"#00000000",color:c.sadafInfo.prop.showLabelFont.color||"#333",stretch:15,font:{resizable:!1,minSize:8,maxSize:+d,size:+d,family:c.sadafInfo.prop.showLabelFont.fontName}}):c.outlabels={display:!1}}),delete m.options.scales;var n=(b.chartProp.general.legendPosition||"center left").replace("center left","left start").replace("center right","right start").split(" "),o=n[0],p=(n[1]||"start").replace("right","end").replace("left","start");m.options.legend.position=o,m.options.legend.align=p,m.options.legend.display="legend"===b.chartProp.general.showLegends||b.chartProp.general.showLegends===!0,delete m.options.legend.onClick,delete m.options.tooltips.intersect,delete m.options.tooltips.index,m.options.tooltips.showPercentage=b.chartProp.general.showPercentage,m.options.tooltips.callbacks.title=function(a,b){return b.labels[a[0].index]},m.options.tooltips.callbacks.labelColor=function(a,b){var c=b.data.datasets[a.datasetIndex];return{borderColor:c.borderColor[a.index],backgroundColor:c.backgroundColor[a.index]}},m.type="pie";var q=!1,r=0;if(_.forOwn(b.chartProp.series,function(a,b){if("{All}"!==b&&"_default"!==b&&"out-label"===a.showLegends)return q=!0,r=a.padding,!1}),q){m.options.legend.display=!1;var s=r;m.options.layout.padding.bottom=s,m.options.layout.padding.top=s,m.options.layout.padding.left=s,m.options.layout.padding.right=s}else m.options.layout.padding.bottom=15,m.options.plugins.outlabels={display:!1};m.options.cutoutPercentage=b.chartProp.general.cutoutPercentage||50,chart=new Chart(l,m),$(b.selector+" canvas").data("chart",chart)}}},b=chartUtils.getChartSettings();chartUtils.handlePieSettings(b),_.remove(b.general,{key:"linesHoriz"}),a.settings=b,app=app||{},app.charts=app.charts||{},app.charts.list=app.charts.list||[],app.charts.list.push(a)}(),function(){var a={type:16,expandedChartType:[{name:"Polar Area",type:37,iconLink:app.urlPrefix+"images/chart-icons/polar.png"}],category:"ChartJs",config:{needDim:!1,needMeasure:!0,needServerData:!0},changeSeriesPropertyBaseOnExpandedType:function(a,b){},draw:function(a,b,c,d){b.selector;$(b.selector).addClass("canvas-chart");var e=d3.select(b.selector+" .lgb");e.empty()&&(e=d3.select(b.selector).append("div").attr("class","lgb"));var f=e.append("div").attr("class","legend-bar temporal");if(f.breadcrumb(a.levels,b,d,!0),!chartUtils.checkEmtryResult(a,f)){var g=chartUtils.getData(a,b),h=0,i=$(b.selector).width(),j=$(b.selector+" .legend-bar").height(),k=$(b.selector).height()+h-j;$(b.selector).append('<canvas class="temporal canvas"  width="'+i+'" height="'+k+'" style="margin-top:-'+h+'px"></canvas>');var l=$(b.selector+" canvas").get(0).getContext("2d");Chart.defaults.global.defaultFontFamily="IRANSans";var m=chartUtils.getChartOption(a,b,g,d);_.each(g,function(c){delete c.type,c.backgroundColor=chartUtils.getColorArray(a,b),c.borderColor=a.matrix.map(function(a){return c.sadafInfo.prop.borderColor}),c.borderWidth=c.sadafInfo.prop.borderWidth,"out-label"==b.chartProp.general.showLegends?c.outlabels={text:function(a){var c="";if(b.chartProp.general.showPercentageInLegend){var d=a.dataset.data[a.dataIndex]/d3.sum(a.dataset.data);c=d3.format(".0%")(d)+""}return persian(a.labels[a.dataIndex]+" "+c,!0)},color:"white",stretch:15,font:{resizable:!0,minSize:12,maxSize:18}}:c.outlabels={display:!1}});var n=(b.chartProp.general.legendPosition||"center left").replace("center left","left start").replace("center right","right start").split(" "),o=n[0],p=(n[1]||"start").replace("right","end").replace("left","start");if(m.options.legend.position=o,m.options.legend.align=p,m.options.legend.display="legend"===b.chartProp.general.showLegends||b.chartProp.general.showLegends===!0,delete m.options.legend.onClick,delete m.options.tooltips.intersect,delete m.options.tooltips.index,m.options.tooltips.showPercentage=b.chartProp.general.showPercentage,m.options.tooltips.callbacks.title=function(a,b){return b.labels[a[0].index]},m.type="polarArea","out-label"==b.chartProp.general.showLegends){var q=60;m.options.layout.padding.bottom=q,m.options.layout.padding.top=q,m.options.layout.padding.left=q,m.options.layout.padding.right=q}else m.options.layout.padding.bottom=15,m.options.plugins.outlabels={display:!1};var r=m.options.scales;delete m.options.scales,m.options.scale={pointLabels:r.xAxes[0].ticks,ticks:r.yAxes[0].ticks,gridLines:r.yAxes[0].gridLines},chart=new Chart(l,m),$(b.selector+" canvas").data("chart",chart)}}},b=chartUtils.getChartSettings();chartUtils.handlePieSettings(b),a.settings=b,app=app||{},app.charts=app.charts||{},app.charts.list=app.charts.list||[],app.charts.list.push(a)}(),function(){var a={type:15,expandedChartType:[{name:"رادار",type:36,iconLink:app.urlPrefix+"images/chart-icons/radar.png"}],category:"ChartJs",config:{needDim:!1,needMeasure:!0,needServerData:!0},changeSeriesPropertyBaseOnExpandedType:function(a,b){},draw:function(a,b,c,d){$(b.selector).addClass("canvas-chart");var e=!0,f=$(b.selector).width(),g=chartUtils.getData(a,b);if(!chartUtils.renderLegendForBar(b,g,a,d,f,e)){var h=0,i=$(b.selector+" .legend-bar").height(),j=$(b.selector).height()+h-i;$(b.selector).append('<canvas class="temporal canvas"  width="'+f+'" height="'+j+'" style="margin-top:-'+h+'px"></canvas>');var k=$(b.selector+" canvas").get(0).getContext("2d");Chart.defaults.global.defaultFontFamily="IRANSans";var l=chartUtils.getChartOption(a,b,g,d);l.type="radar",_.each(g,function(a){delete a.type;var b=a.sadafInfo.prop.fillOpacity||1,c=Color(a.sadafInfo.prop.color).alpha(b).rgbaString();a.backgroundColor=c,a.borderColor||(a.borderColor=a.sadafInfo.prop.color)});var m=l.options.scales;delete l.options.scales,l.options.scale={pointLabels:m.xAxes[0].ticks,ticks:m.yAxes[0].ticks,gridLines:m.yAxes[0].gridLines},l.options.tooltips.mode="nearest",chart=new Chart(k,l),$(b.selector+" canvas").data("chart",chart)}}},b=chartUtils.getChartSettings();_.remove(b.general,{key:"linesVert"}),_.remove(b.series,{key:"type"}),_.find(b.general,{key:"linesHoriz"}).title="نمایش خطوط دایره‌ای",_.find(b.series,{key:"line-config"})["if"]=void 0,_.find(b.series,{key:"borderWidth"})["default"]=2,_.find(_.find(b.series,{key:"line-config"}).items,{key:"fill"})["default"]=!0,_.find(_.find(b.series,{key:"line-config"}).items,{key:"fillOpacity"})["default"]=.1,_.find(b.series,{key:"color"}).onchange=function(a,b,c){b.borderColor=a},a.settings=b,app=app||{},app.charts=app.charts||{},app.charts.list=app.charts.list||[],app.charts.list.push(a)}(),function(a,b){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?b(require("chart.js")):"function"==typeof define&&define.amd?define(["chart.js"],b):(a=a||self,b(a.Chart))}(void 0,function(a){"use strict";function b(a){for(var b=_toConsumableArray(a),c=[];b.length;){var d=b.pop();Array.isArray(d)?b.push.apply(b,_toConsumableArray(d)):c.push(d)}return c.reverse()}function c(a,b,c,d,e){var f,g,h,i,j=Object.create(null),k=Object.create(null),l=[];for(g=0,h=a.length;g<h;++g)i=a[g],d&&i[d]!==e||(f=i[b]||"",f in j||(j[f]=0,k[f]=[]),j[f]+=+i[c],k[f].push(i));return Object.keys(j).forEach(function(a){i={children:k[a]},i[c]=+j[a],i[b]=a,d&&(i[d]=e),l.push(i)}),l}function d(a){var b=_typeof(a);return"function"===b||"object"===b&&!!a}function e(a,b){var c,e,f=a.length;if(!f)return b;for(e=d(a[0]),b=e?b:"v",c=0,f=a.length;c<f;++c)e?a[c]._idx=c:a[c]={v:a[c],_idx:c};return b}function f(a,b){b?a.sort(function(a,c){return+c[b]-+a[b]}):a.sort(function(a,b){return+b-+a})}function g(a,b){var c,d,e;for(c=0,d=0,e=a.length;d<e;++d)c+=b?+a[d][b]:+a[d];return c}function h(a,b){return+(Math.round(a+"e+"+b)+"e-"+b)}function i(a,b,c,d){var e=a._normalized,f=b*e/c,g=Math.sqrt(e*f),h=e/g,i="_ix"===d?g:h,j="_ix"===d?h:g;return{d1:g,d2:h,w:i,h:j}}function j(a,b,c,d){var e={x:h(a.x+a._ix,4),y:h(a.y+a._iy,4),w:h(c.w,4),h:h(c.h,4),a:b._normalized,v:b.value,s:d,_data:b._data};return b.group&&(e.g=b.group,e.l=b.level,e.gs=b.groupSum),e}function k(a){return{min:a.min,max:a.max,sum:a.sum,nmin:a.nmin,nmax:a.nmax,nsum:a.nsum}}function l(a,b){var c=+b[a.key],d=c*a.ratio;return b._normalized=d,{min:x(a.min,c),max:y(a.max,c),sum:a.sum+c,nmin:x(a.nmin,d),nmax:y(a.nmax,d),nsum:a.nsum+d}}function m(a,b){Object.assign(a,b)}function n(a,b,c){a._arr.push(b),m(a,c)}function o(a,b,c){if(0===a.sum)return!0;var d=_slicedToArray(c,1),e=d[0],f=a.nsum*a.nsum,g=b.nsum*b.nsum,h=e*e,i=Math.max(h*a.nmax/f,f/(h*a.nmin)),j=Math.max(h*b.nmax/g,g/(h*b.nmin));return j<=i}function p(a,b,c,d,e,f){function g(a){return c?+k[a][c]:+k[a]}function h(a){return d&&k[a][d]}var i,j,k,l=v.sum(a,c),m=[],n=new w(b),p=new z("value",n.area/l),q=n.side,r=a.length;if(!r)return m;for(k=a.slice(),c=v.index(k,c),v.sort(k,c),i=0;i<r;++i)j={value:g(i),groupSum:f,_data:a[k[i]._idx]},d&&(j.level=e,j.group=h(i)),j=p.pushIf(j,o,q),j&&(m.push(n.map(p)),q=n.side,p.reset(),p.push(j));return p.length&&m.push(n.map(p)),v.flatten(m)}function q(a,b){return!a||!b||a.x!==b.x||a.y!==b.y||a.w!==b.w||a.h!==b.h}function r(a,b){var c,d;if(a.lenght!==b.length)return!0;for(c=0,d=a.length;c<d;++c)if(a[c]!==b[c])return!0;return!1}function s(a,b){var c=a.width||a.w,d=a.height||a.h,e=2*b.lineHeight;return c>e&&d>e}function t(a,b,c){function d(a,b,j,k){var l,m=g[a],n=a>0&&g[a-1],o=v.group(f,m,e,n,j),q=p(o,b,e,m,a,k),r=q.slice();return a<h-1&&q.forEach(function(b){l={x:b.x+i,y:b.y+i,w:b.w-2*i,h:b.h-2*i},s(b,c)&&(l.y+=c.lineHeight,l.h-=c.lineHeight),r.push.apply(r,d(a+1,l,b.g,b.s))}),r}var e=a.key||"",f=a.tree||[],g=a.groups||[],h=g.length,i=(a.spacing||0)+(a.borderWidth||0);return!f.length&&a.data.length&&(f=a.tree=a.data),h?d(0,b):p(f,b,e)}function u(a){return B.extend(D({fontFamily:F(a.fontFamily,A.fontFamily),fontSize:F(a.fontSize,A.fontSize),fontStyle:F(a.fontStyle,A.fontStyle),lineHeight:F(a.lineHeight,A.lineHeight)}),{color:E([a.fontColor,A.fontColor,A.global.defaultFontColor])})}a=a&&a.hasOwnProperty("default")?a["default"]:a;var v={flatten:b,group:c,index:e,isObject:d,sort:f,sum:g},w=function(){function a(b){_classCallCheck(this,a);var c=this;c.x=b.x||b.left||0,c.y=b.y||b.top||0,c._ix=0,c._iy=0,c.w=b.w||b.width||b.right-b.left,c.h=b.h||b.height||b.bottom-b.top}return _createClass(a,[{key:"map",value:function(a){var b,c,d,e=this,f=[],g=a.nsum,h=a.get(),k=h.length,l=e.dir,m=e.side,n=m*m,o="x"===l?"_ix":"_iy",p=g*g,q=0,r=0;for(b=0;b<k;++b)c=h[b],d=i(c,n,p,o),r+=d.d1,d.d2>q&&(q=d.d2),f.push(j(e,c,d,a.sum)),e[o]+=d.d1;return e["y"===l?"_ix":"_iy"]+=q,e[o]-=r,f}},{key:"area",get:function(){return this.w*this.h}},{key:"iw",get:function(){return this.w-this._ix}},{key:"ih",get:function(){return this.h-this._iy}},{key:"dir",get:function(){var a=this.ih;return a<=this.iw&&a>0?"y":"x"}},{key:"side",get:function(){return"x"===this.dir?this.iw:this.ih}}]),a}(),x=Math.min,y=Math.max,z=function(){function a(b,c){_classCallCheck(this,a);var d=this;d.key=b,d.ratio=c,d.reset()}return _createClass(a,[{key:"reset",value:function(){var a=this;a._arr=[],a._hist=[],a.sum=0,a.nsum=0,a.min=1/0,a.max=-(1/0),a.nmin=1/0,a.nmax=-(1/0)}},{key:"push",value:function(a){n(this,a,l(this,a))}},{key:"pushIf",value:function(a,b){for(var c=l(this,a),d=arguments.length,e=new Array(d>2?d-2:0),f=2;f<d;f++)e[f-2]=arguments[f];return b(k(this),c,e)?void n(this,a,c):a}},{key:"get",value:function(){return this._arr}},{key:"length",get:function(){return this._arr.length}}]),a}(),A=a.defaults,B=a.helpers,C=B.options,D=C._parseFont,E=C.resolve,F=B.valueOrDefault,G=a.DatasetController.extend({dataElementType:a.elements.Rectangle,update:function(a){var b,c,d,e=this,f=e.getMeta(),g=e.getDataset(),h=g.groups||(g.groups=[]),i=u(g),j=f.data||[],k=e.chart.chartArea,l=g.key||"";for(d={x:k.left,y:k.top,w:k.right-k.left,h:k.bottom-k.top},(a||q(e._rect,d)||e._key!==l||r(e._groups,h))&&(e._rect=d,e._groups=h.slice(),e._key=l,g.data=t(g,d,i),e.resyncElements()),b=0,c=j.length;b<c;++b)e.updateElement(j[b],b,a)},updateElement:function(a,b,c){var d=this,e=d.index,f=d.getDataset(),g=f.data[b],h=d._resolveElementOptions(a,b),i=c?0:g.h-2*h.spacing,j=c?0:g.w-2*h.spacing,k=g.x+j/2+h.spacing,l=g.y+i/2+h.spacing,m=i/2;a._options=h,a._datasetIndex=e,a._index=b,a.hidden=i<=h.spacing||j<=h.spacing,a._model={x:k,base:l-m,y:l+m,top:g.y,left:g.x,width:j,height:i,backgroundColor:h.backgroundColor,borderColor:h.borderColor,borderSkipped:h.borderSkipped,borderWidth:h.borderWidth,font:D(h),fontColor:h.fontColor},a.pivot()},draw:function(){var a,b,c,d,e,f=this,g=f.getMeta().data||[],h=f.getDataset(),i=(h.groups||[]).length-1,j=h.data||[],k=f.chart.ctx;for(a=0,b=g.length;a<b;++a)if(c=g[a],e=c._view,d=j[a],!c.hidden&&(c.draw(),s(e,e.font)&&d.g)){if(k.save(),k.fillStyle=e.fontColor,k.font=e.font.string,k.beginPath(),k.rect(e.left,e.top,e.width,e.height),k.clip(),"l"in d&&d.l!==i)k.textAlign="start",k.textBaseline="top",k.fillText(d.g,e.left+e.borderWidth+3,e.top+e.borderWidth+3);else if(k.textAlign="center",k.textBaseline="middle",k.fillText(d.g,e.left+e.width/2,e.top+e.height/2),f._config.sadafInfo.prop.showLabel){var l=_.merge({bold:!1,color:"#333333",align:"right",italic:!1,fontSize:"12px",fontName:"IRANSans",formatString:",.0f",formatStringCustom:",.0f",rotate:0,anchor:"end",position:"end"},f._config.sadafInfo.prop.showLabelFont),m=_.last(d._data.children).value,n=chartUtils.getFormatString(l);m=persian(d3.format(n)(m),!0),k.font=(l.italic?"italic ":"")+(l.bold?"bold ":"")+l.fontSize+" "+l.fontName,k.fillStyle=l.color;var o=+l.fontSize.replace("px","")/2+13;k.fillText(m,e.left+e.width/2,e.top+e.height/2+o)}k.restore()}},_resolveElementOptions:function(a,b){var c,d,e,f=this,g=f.chart,h=f.getDataset(),i=g.options.elements.rectangle,j={},k={chart:g,dataIndex:b,dataset:h,datasetIndex:f.index},l=["backgroundColor","borderColor","borderSkipped","borderWidth","fontColor","fontFamily","fontSize","fontStyle","spacing"];for(c=0,d=l.length;c<d;++c)e=l[c],j[e]=E([h[e],i[e]],k,b);return j}}),H={hover:{mode:"point",intersect:!0},tooltips:{mode:"point",position:"treemap",intersect:!0,callbacks:{title:function(a,b){return b.datasets[a[0].datasetIndex].key},label:function(a,b){var c=b.datasets[a.datasetIndex],d=c.data[a.index];return c.label+": "+d.v}}},scales:{xAxes:[{type:"linear",display:!1}],yAxes:[{type:"linear",display:!1}]},elements:{rectangle:{borderSkipped:!1,borderWidth:0,spacing:.5}}};a.controllers.treemap=G,a.defaults.treemap=H,a.Tooltip.positioners.treemap=function(a){if(!a.length)return!1;var b=a[a.length-1]._view;return{x:b.x,y:b.y-b.height/2}}}),function(){var a={type:19,expandedChartType:[{name:"TreeMap",type:41,iconLink:app.urlPrefix+"images/chart-icons/tree.png"}],category:"ChartJs",config:{needDim:!1,needMeasure:!0,needServerData:!0},changeSeriesPropertyBaseOnExpandedType:function(a,b){},draw:function(a,b,c,d){b.selector;$(b.selector).addClass("canvas-chart");var e=!0,f=$(b.selector).width(),g=chartUtils.getData(a,b);if(!chartUtils.renderLegendForBar(b,g,a,d,f,e,!0)){_.each(g,function(c){c.data=c.data.map(function(b,c){var d={};return d.value=b,d.sadaf_index=c,_.each(_.reverse(a.matrix[c].captions),function(a,b){d["x"+b]=a}),d});var d=chartUtils.getFontFromProp(b.chartProp.general.labelsFonts);c.key="value",c.groups=_.reverse(_.map(a.matrix[0].captions,function(a,b){return"x"+b})),c.fontColor=b.chartProp.general.showLabels?d.fontColor:"#00000000",c.fontFamily=d.fontFamily,c.fontSize=d.fontSize,c.spacing=.5,c.borderWidth=c.sadafInfo.prop.borderWidth,c.borderColor=c.sadafInfo.prop.borderColor,c.labelGroup=!1,delete c.type,delete c.datalabels;chartUtils.getColorArray(a,b);c.backgroundColor=function(c){var d=c.dataset.data[c.dataIndex];if(d.l!==a.matrix[0].captions.length-1)return"#909090";var e=d3.min(c.dataset.data,function(a){return a.v}),f=d3.max(c.dataset.data,function(a){return a.v}),g=(d.v-e)/(f-e)*.4+.6;f-e==0&&(g=1);var h=_.last(d._data.children).sadaf_index,i=c.dataset.sadafInfo.prop.color,j=b.chartProp.general.dimColor=b.chartProp.general.dimColor||{};if(j.enable){var k=j.data[a.matrix[h].captions.join("-")];k=k||{color:"#efefef"},i=k.color}return Color(i).alpha(g).rgbaString()}});var h=0,i=$(b.selector+" .legend-bar").height(),j=$(b.selector).height()+h-i;$(b.selector).append('<canvas class="temporal canvas"  width="'+f+'" height="'+j+'" style="margin-top:-'+h+'px"></canvas>');var k=$(b.selector+" canvas").get(0).getContext("2d");Chart.defaults.global.defaultFontFamily="IRANSans";var l=chartUtils.getChartOption(a,b,g,d);_.each(g,function(a){a.pointRadius=a.sadafInfo.prop.pointRadius}),l.type="treemap";d3.max(g[0].data,function(a){return a.y});l.options.tooltips.getValueCallback=function(a){return a.v},l.options.tooltips.callbacks.title=function(a,b){var c=_.map(a,function(a){return b.datasets[a.datasetIndex].data[a.index].g});return c.join(", ")},l.options.tooltips.callbacks.label=function(a,b){var c=b.datasets[a.datasetIndex],d=c.data[a.index],e=d.g,f=chartUtils.getFormatString(b.datasets[a.datasetIndex].sadafInfo.prop.tooltipFont);return persian(e+" - "+c.label+": "+chartUtils.format(f,d.v),!0)},l.options.tooltips.mode="point",l.options.tooltips.position="treemap",l.options.tooltips.intersect=!0,l.options.maintainAspectRatio=!1,l.options.plugins.datalabels=!1,l.options.onClick=function(c){var e=this.getElementAtEvent(c);if(!_.isArray(e)||!e.length)return labelClick||chartUtils.drillUp(b,a,d),void(labelClick=!1);var f=_.last(e[0]._chart.active)._index,g=e[0]._chart.data.datasets[0].data[f],h=_.last(g._data.children).sadaf_index;chartUtils.onClickCalback(b,a,a.matrix[h],d)},l.options.plugins={datalabels:!1},chart=new Chart(k,l),$(b.selector+" canvas").data("chart",chart)}}},b=chartUtils.getChartSettings();_.remove(b.series,{key:"type"}),_.find(_.find(b.series,{key:"showLabel-section"}).items,{key:"showLabelFont"})["default"].color="#ffffff",_.find(b.series,{key:"color"}).onchange=function(a,b,c){b.borderColor=a},_.find(b.series,{key:"borderWidth"})["default"]=1,_.remove(b.general,{key:"legendFont"}),_.remove(b.general,{key:"legendPosition"}),_.remove(b.general,{key:"stack"}),_.remove(b.general,{key:"linesHoriz"}),_.remove(b.general,{key:"linesVert"}),_.remove(b.general,{key:"customFont"}),_.remove(b.general,{key:"showLegends"}),_.find(b.series,{key:"borderColor"})["default"]="white",b.general.push({title:"نمایش برچسب‌ها روی نمودار",key:"showLabels",type:"checkbox","default":!0}),b.general.push({title:"فونت برچسب‌های روی نمودار",key:"labelsFonts",type:"font","if":{key:"showLabels",value:!0},config:{format:!1,align:!1,bold:!1},"default":{fontSize:"12px",color:"white"}}),a.settings=b,app=app||{},app.charts=app.charts||{},app.charts.list=app.charts.list||[],app.charts.list.push(a)}();